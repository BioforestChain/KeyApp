import{_ as a,c as d,o as s,ag as e}from"./chunks/framework.B0we9iV-.js";const b=JSON.parse('{"title":"网络故障矩阵","description":"","frontmatter":{},"headers":[],"relativePath":"white-book/99-Appendix/06-Network-Faults.md","filePath":"white-book/99-Appendix/06-Network-Faults.md"}'),n={name:"white-book/99-Appendix/06-Network-Faults.md"};function i(r,t,h,l,p,o){return s(),d("div",null,[...t[0]||(t[0]=[e(`<h1 id="网络故障矩阵" tabindex="-1">网络故障矩阵 <a class="header-anchor" href="#网络故障矩阵" aria-label="Permalink to &quot;网络故障矩阵&quot;">​</a></h1><blockquote><p>各种网络故障场景的检测和处理策略</p></blockquote><hr><h2 id="故障类型分类" tabindex="-1">故障类型分类 <a class="header-anchor" href="#故障类型分类" aria-label="Permalink to &quot;故障类型分类&quot;">​</a></h2><table tabindex="0"><thead><tr><th>类型</th><th>说明</th><th>用户影响</th></tr></thead><tbody><tr><td>完全离线</td><td>无任何网络连接</td><td>高</td></tr><tr><td>部分可达</td><td>部分服务可用</td><td>中</td></tr><tr><td>高延迟</td><td>响应缓慢</td><td>中</td></tr><tr><td>不稳定</td><td>间歇性断连</td><td>低-中</td></tr><tr><td>服务端故障</td><td>服务器不可用</td><td>高</td></tr></tbody></table><hr><h2 id="故障检测" tabindex="-1">故障检测 <a class="header-anchor" href="#故障检测" aria-label="Permalink to &quot;故障检测&quot;">​</a></h2><h3 id="检测方法" tabindex="-1">检测方法 <a class="header-anchor" href="#检测方法" aria-label="Permalink to &quot;检测方法&quot;">​</a></h3><table tabindex="0"><thead><tr><th>方法</th><th>用途</th><th>频率</th></tr></thead><tbody><tr><td>navigator.onLine</td><td>基础离线检测</td><td>实时事件</td></tr><tr><td>心跳请求</td><td>服务可用性</td><td>30s</td></tr><tr><td>请求超时监控</td><td>延迟检测</td><td>每次请求</td></tr><tr><td>错误率统计</td><td>稳定性评估</td><td>滑动窗口</td></tr></tbody></table><h3 id="检测指标" tabindex="-1">检测指标 <a class="header-anchor" href="#检测指标" aria-label="Permalink to &quot;检测指标&quot;">​</a></h3><div class="language-typescript vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">interface</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> NetworkHealth</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  isOnline</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> boolean</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // 基础连接状态</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  latency</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> number</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">          // 平均延迟 (ms)</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  errorRate</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> number</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // 错误率 (%)</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  lastSuccessTime</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> number</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // 上次成功时间</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  connectionType</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> string</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">   // 连接类型 (wifi/4g/3g)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><h3 id="健康度评级" tabindex="-1">健康度评级 <a class="header-anchor" href="#健康度评级" aria-label="Permalink to &quot;健康度评级&quot;">​</a></h3><table tabindex="0"><thead><tr><th>评级</th><th>条件</th><th>状态</th></tr></thead><tbody><tr><td>healthy</td><td>errorRate &lt; 5% &amp;&amp; latency &lt; 1s</td><td>正常</td></tr><tr><td>degraded</td><td>errorRate &lt; 20% &amp;&amp; latency &lt; 3s</td><td>降级</td></tr><tr><td>poor</td><td>errorRate &lt; 50% &amp;&amp; latency &lt; 10s</td><td>较差</td></tr><tr><td>offline</td><td>errorRate &gt;= 50% || !isOnline</td><td>离线</td></tr></tbody></table><hr><h2 id="故障场景矩阵" tabindex="-1">故障场景矩阵 <a class="header-anchor" href="#故障场景矩阵" aria-label="Permalink to &quot;故障场景矩阵&quot;">​</a></h2><h3 id="场景-1-完全离线" tabindex="-1">场景 1: 完全离线 <a class="header-anchor" href="#场景-1-完全离线" aria-label="Permalink to &quot;场景 1: 完全离线&quot;">​</a></h3><p><strong>检测</strong>: <code>navigator.onLine === false</code></p><table tabindex="0"><thead><tr><th>功能</th><th>处理方式</th><th>UI 反馈</th></tr></thead><tbody><tr><td>查看钱包</td><td>使用缓存</td><td>显示缓存时间</td></tr><tr><td>查看余额</td><td>使用缓存</td><td>&quot;离线模式&quot; 标签</td></tr><tr><td>发起转账</td><td>离线签名</td><td>&quot;待发送&quot; 状态</td></tr><tr><td>扫码</td><td>正常可用</td><td>无</td></tr><tr><td>设置</td><td>正常可用</td><td>无</td></tr></tbody></table><p><strong>恢复动作</strong>:</p><ol><li>检测到网络恢复</li><li>刷新关键数据</li><li>处理待发送队列</li><li>移除离线提示</li></ol><h3 id="场景-2-服务端不可用-5xx" tabindex="-1">场景 2: 服务端不可用 (5xx) <a class="header-anchor" href="#场景-2-服务端不可用-5xx" aria-label="Permalink to &quot;场景 2: 服务端不可用 (5xx)&quot;">​</a></h3><p><strong>检测</strong>: API 返回 500/502/503</p><table tabindex="0"><thead><tr><th>功能</th><th>处理方式</th><th>UI 反馈</th></tr></thead><tbody><tr><td>余额查询</td><td>重试 → 缓存</td><td>显示缓存 + 警告</td></tr><tr><td>交易历史</td><td>重试 → 缓存</td><td>显示缓存</td></tr><tr><td>广播交易</td><td>重试 3 次</td><td>显示进度</td></tr><tr><td>链配置</td><td>使用本地</td><td>无</td></tr></tbody></table><p><strong>重试策略</strong>:</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>第 1 次重试: 1s 后</span></span>
<span class="line"><span>第 2 次重试: 2s 后  </span></span>
<span class="line"><span>第 3 次重试: 4s 后</span></span>
<span class="line"><span>放弃并使用缓存/提示错误</span></span></code></pre></div><h3 id="场景-3-节点不可用" tabindex="-1">场景 3: 节点不可用 <a class="header-anchor" href="#场景-3-节点不可用" aria-label="Permalink to &quot;场景 3: 节点不可用&quot;">​</a></h3><p><strong>检测</strong>: RPC 请求超时或返回错误</p><table tabindex="0"><thead><tr><th>功能</th><th>处理方式</th><th>UI 反馈</th></tr></thead><tbody><tr><td>余额查询</td><td>切换节点</td><td>短暂加载</td></tr><tr><td>广播交易</td><td>切换节点</td><td>短暂延迟</td></tr><tr><td>Gas 估算</td><td>切换节点</td><td>短暂延迟</td></tr></tbody></table><p><strong>节点切换逻辑</strong>:</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>主节点请求</span></span>
<span class="line"><span>    │</span></span>
<span class="line"><span>    ├── 成功 ──► 返回结果</span></span>
<span class="line"><span>    │</span></span>
<span class="line"><span>    └── 失败</span></span>
<span class="line"><span>         │</span></span>
<span class="line"><span>         ▼</span></span>
<span class="line"><span>    尝试备用节点 1</span></span>
<span class="line"><span>         │</span></span>
<span class="line"><span>         ├── 成功 ──► 返回结果 + 标记主节点不健康</span></span>
<span class="line"><span>         │</span></span>
<span class="line"><span>         └── 失败 ──► 尝试备用节点 2 ──► ... ──► 全部失败</span></span>
<span class="line"><span>                                                    │</span></span>
<span class="line"><span>                                                    ▼</span></span>
<span class="line"><span>                                              返回错误</span></span></code></pre></div><h3 id="场景-4-高延迟-3s" tabindex="-1">场景 4: 高延迟 (&gt;3s) <a class="header-anchor" href="#场景-4-高延迟-3s" aria-label="Permalink to &quot;场景 4: 高延迟 (&gt;3s)&quot;">​</a></h3><p><strong>检测</strong>: 请求响应时间 &gt; 3s</p><table tabindex="0"><thead><tr><th>功能</th><th>处理方式</th><th>UI 反馈</th></tr></thead><tbody><tr><td>页面加载</td><td>显示骨架屏</td><td>加载指示器</td></tr><tr><td>余额刷新</td><td>显示旧数据</td><td>&quot;加载中&quot; 覆盖</td></tr><tr><td>交易广播</td><td>等待</td><td>进度指示</td></tr></tbody></table><p><strong>优化措施</strong>:</p><ul><li>并行请求改为串行</li><li>降低轮询频率</li><li>优先使用缓存</li></ul><h3 id="场景-5-网络不稳定" tabindex="-1">场景 5: 网络不稳定 <a class="header-anchor" href="#场景-5-网络不稳定" aria-label="Permalink to &quot;场景 5: 网络不稳定&quot;">​</a></h3><p><strong>检测</strong>: 5 分钟内断连 &gt; 3 次</p><table tabindex="0"><thead><tr><th>功能</th><th>处理方式</th><th>UI 反馈</th></tr></thead><tbody><tr><td>数据同步</td><td>增加重试</td><td>&quot;网络不稳定&quot;</td></tr><tr><td>实时更新</td><td>降级轮询</td><td>更新频率降低</td></tr><tr><td>交易广播</td><td>持久化重试</td><td>队列状态显示</td></tr></tbody></table><hr><h2 id="恢复策略" tabindex="-1">恢复策略 <a class="header-anchor" href="#恢复策略" aria-label="Permalink to &quot;恢复策略&quot;">​</a></h2><h3 id="自动恢复" tabindex="-1">自动恢复 <a class="header-anchor" href="#自动恢复" aria-label="Permalink to &quot;自动恢复&quot;">​</a></h3><table tabindex="0"><thead><tr><th>场景</th><th>检测间隔</th><th>恢复动作</th></tr></thead><tbody><tr><td>网络恢复</td><td>实时</td><td>刷新数据 + 处理队列</td></tr><tr><td>服务恢复</td><td>30s</td><td>重试失败请求</td></tr><tr><td>节点恢复</td><td>5min</td><td>切回主节点</td></tr></tbody></table><h3 id="恢复后动作优先级" tabindex="-1">恢复后动作优先级 <a class="header-anchor" href="#恢复后动作优先级" aria-label="Permalink to &quot;恢复后动作优先级&quot;">​</a></h3><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>1. [高] 广播待发送交易</span></span>
<span class="line"><span>2. [高] 刷新当前钱包余额</span></span>
<span class="line"><span>3. [中] 同步交易历史</span></span>
<span class="line"><span>4. [中] 更新其他钱包余额</span></span>
<span class="line"><span>5. [低] 更新链配置</span></span>
<span class="line"><span>6. [低] 预加载数据</span></span></code></pre></div><hr><h2 id="用户通知" tabindex="-1">用户通知 <a class="header-anchor" href="#用户通知" aria-label="Permalink to &quot;用户通知&quot;">​</a></h2><h3 id="通知级别" tabindex="-1">通知级别 <a class="header-anchor" href="#通知级别" aria-label="Permalink to &quot;通知级别&quot;">​</a></h3><table tabindex="0"><thead><tr><th>级别</th><th>场景</th><th>展示方式</th></tr></thead><tbody><tr><td>全局横幅</td><td>完全离线</td><td>固定顶部</td></tr><tr><td>Toast</td><td>临时故障</td><td>自动消失</td></tr><tr><td>内联提示</td><td>特定功能不可用</td><td>功能旁边</td></tr><tr><td>无提示</td><td>自动恢复的短暂故障</td><td>静默处理</td></tr></tbody></table><h3 id="通知内容" tabindex="-1">通知内容 <a class="header-anchor" href="#通知内容" aria-label="Permalink to &quot;通知内容&quot;">​</a></h3><table tabindex="0"><thead><tr><th>场景</th><th>消息</th></tr></thead><tbody><tr><td>离线</td><td>&quot;当前离线，显示的是缓存数据&quot;</td></tr><tr><td>服务故障</td><td>&quot;服务暂时不可用，正在重试&quot;</td></tr><tr><td>高延迟</td><td>&quot;网络较慢，请耐心等待&quot;</td></tr><tr><td>恢复</td><td>&quot;网络已恢复&quot;</td></tr></tbody></table><hr><h2 id="监控指标" tabindex="-1">监控指标 <a class="header-anchor" href="#监控指标" aria-label="Permalink to &quot;监控指标&quot;">​</a></h2><h3 id="需要监控的指标" tabindex="-1">需要监控的指标 <a class="header-anchor" href="#需要监控的指标" aria-label="Permalink to &quot;需要监控的指标&quot;">​</a></h3><table tabindex="0"><thead><tr><th>指标</th><th>说明</th><th>告警阈值</th></tr></thead><tbody><tr><td>离线用户占比</td><td>当前离线用户数/总用户</td><td>&gt; 10%</td></tr><tr><td>API 错误率</td><td>失败请求/总请求</td><td>&gt; 5%</td></tr><tr><td>P95 延迟</td><td>95% 请求的延迟</td><td>&gt; 3s</td></tr><tr><td>节点切换率</td><td>切换次数/请求数</td><td>&gt; 20%</td></tr></tbody></table><hr><h2 id="测试场景" tabindex="-1">测试场景 <a class="header-anchor" href="#测试场景" aria-label="Permalink to &quot;测试场景&quot;">​</a></h2><h3 id="必须测试的场景" tabindex="-1">必须测试的场景 <a class="header-anchor" href="#必须测试的场景" aria-label="Permalink to &quot;必须测试的场景&quot;">​</a></h3><table tabindex="0"><thead><tr><th>场景</th><th>测试方法</th><th>验证点</th></tr></thead><tbody><tr><td>启动时离线</td><td>断网后启动</td><td>显示缓存</td></tr><tr><td>使用中断网</td><td>拔网线/开飞行</td><td>及时提示</td></tr><tr><td>慢速网络</td><td>节流 3G</td><td>不卡死</td></tr><tr><td>节点故障</td><td>Mock 返回错误</td><td>自动切换</td></tr><tr><td>恢复后同步</td><td>断网→操作→恢复</td><td>数据同步</td></tr></tbody></table><hr><h2 id="相关文档" tabindex="-1">相关文档 <a class="header-anchor" href="#相关文档" aria-label="Permalink to &quot;相关文档&quot;">​</a></h2><ul><li><a href="./04-Edge-Cases.html">Edge Cases</a> - 边界条件</li><li><a href="./03-State-Machines.html">State Machines</a> - 网络状态机</li></ul>`,61)])])}const k=a(n,[["render",i]]);export{b as __pageData,k as default};
