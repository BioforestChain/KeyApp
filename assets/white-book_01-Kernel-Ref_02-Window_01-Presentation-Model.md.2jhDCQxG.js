import{_ as i,c as a,o as n,ag as t}from"./chunks/framework.B0we9iV-.js";const g=JSON.parse('{"title":"01. 窗口模型 (Presentation Model)","description":"","frontmatter":{},"headers":[],"relativePath":"white-book/01-Kernel-Ref/02-Window/01-Presentation-Model.md","filePath":"white-book/01-Kernel-Ref/02-Window/01-Presentation-Model.md"}'),e={name:"white-book/01-Kernel-Ref/02-Window/01-Presentation-Model.md"};function l(p,s,h,k,r,d){return n(),a("div",null,[...s[0]||(s[0]=[t(`<h1 id="_01-窗口模型-presentation-model" tabindex="-1">01. 窗口模型 (Presentation Model) <a class="header-anchor" href="#_01-窗口模型-presentation-model" aria-label="Permalink to &quot;01. 窗口模型 (Presentation Model)&quot;">​</a></h1><p>KeyApp 的窗口管理器负责管理所有微应用在屏幕上的几何位置、层级 (Z-Order) 和动画上下文。它采用了 <strong>Presentation-Desktop</strong> 模型。</p><h2 id="核心数据结构" tabindex="-1">核心数据结构 <a class="header-anchor" href="#核心数据结构" aria-label="Permalink to &quot;核心数据结构&quot;">​</a></h2><h3 id="_1-presentation-miniapppresentation" tabindex="-1">1. Presentation (<code>MiniappPresentation</code>) <a class="header-anchor" href="#_1-presentation-miniapppresentation" aria-label="Permalink to &quot;1. Presentation (\`MiniappPresentation\`)&quot;">​</a></h3><p><code>Presentation</code> 是应用在视觉层的投影。一个应用可能有实例 (<code>MiniappInstance</code>) 但没有呈现（例如纯后台服务，虽然目前 KeyApp 尚未支持无头应用）。</p><div class="language-typescript vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> interface</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> MiniappPresentation</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  appId</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  /** 目标桌面 (stack | grid) */</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  desktop</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> MiniappTargetDesktop</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  /** 视觉状态 (hidden | presenting | presented | dismissing) */</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  state</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> MiniappPresentationState</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  /** Z 轴层级 */</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  zOrder</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> number</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  /** 当前关联的过渡动画 ID */</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  transitionId</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> string</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> null</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  /** 过渡类型 (present | dismiss) */</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  transitionKind</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> MiniappTransitionKind</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> null</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><h3 id="_2-runtime-refs" tabindex="-1">2. Runtime Refs <a class="header-anchor" href="#_2-runtime-refs" aria-label="Permalink to &quot;2. Runtime Refs&quot;">​</a></h3><p>为了实现高性能的 <strong>FLIP 动画</strong>，内核必须直接持有 DOM 元素的引用。这是通过 <code>runtime-refs.ts</code> 中的注册表实现的。</p><table tabindex="0"><thead><tr><th style="text-align:left;">引用类型</th><th style="text-align:left;">获取函数</th><th style="text-align:left;">描述</th></tr></thead><tbody><tr><td style="text-align:left;"><strong>IconRef</strong></td><td style="text-align:left;"><code>getIconRef(appId)</code></td><td style="text-align:left;">桌面图标元素。动画的起点/终点。</td></tr><tr><td style="text-align:left;"><strong>SlotRef</strong></td><td style="text-align:left;"><code>getDesktopAppSlotRef(desktop, appId)</code></td><td style="text-align:left;">窗口在桌面布局中的占位容器。</td></tr><tr><td style="text-align:left;"><strong>IframeRef</strong></td><td style="text-align:left;"><code>app.iframeRef</code></td><td style="text-align:left;">实际的内容载体。</td></tr></tbody></table><h2 id="窗口层级管理-z-order-strategy" tabindex="-1">窗口层级管理 (Z-Order Strategy) <a class="header-anchor" href="#窗口层级管理-z-order-strategy" aria-label="Permalink to &quot;窗口层级管理 (Z-Order Strategy)&quot;">​</a></h2><p>KeyApp 使用简单的 <strong>自增种子 (Incremental Seed)</strong> 策略来管理窗口层级，模仿原生 OS 的行为。</p><ol><li><strong>全局种子</strong>: Store 中维护一个 <code>zOrderSeed</code>，初始为 1。</li><li><strong>聚焦 (Focus)</strong>: 当应用被点击、激活或启动时，内核调用 <code>requestFocus(appId)</code>。</li><li><strong>提升</strong>: <ul><li><code>zOrderSeed</code> 自增 1。</li><li>目标应用的 <code>presentation.zOrder</code> 被更新为新的种子值。</li><li>这保证了该应用永远处于所有其他窗口之上。</li></ul></li></ol><div class="language-typescript vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// src/services/miniapp-runtime/index.ts</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> requestFocus</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">appId</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> void</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  miniappRuntimeStore.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">setState</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">((</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">s</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // ...</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> nextZ</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> s.zOrderSeed </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // ...</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      ...</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">s,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      activeAppId: appId,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      zOrderSeed: nextZ, </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 全局种子递增</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  })</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><h2 id="桌面模式-desktops" tabindex="-1">桌面模式 (Desktops) <a class="header-anchor" href="#桌面模式-desktops" aria-label="Permalink to &quot;桌面模式 (Desktops)&quot;">​</a></h2><p>目前支持两种桌面模式：</p><ol><li><p><strong>Stack Desktop (默认)</strong>:</p><ul><li>类似 iOS 的多任务堆叠视图。</li><li>窗口全屏显示，支持手势滑动切换。</li><li>适用于大多数 DApp。</li></ul></li><li><p><strong>Grid Desktop</strong>:</p><ul><li>传统桌面网格布局。</li><li>(预留) 支持小组件或悬浮窗模式。</li></ul></li></ol><h2 id="视觉配置-visual-config" tabindex="-1">视觉配置 (Visual Config) <a class="header-anchor" href="#视觉配置-visual-config" aria-label="Permalink to &quot;视觉配置 (Visual Config)&quot;">​</a></h2><p>窗口的外观可以通过 <code>MiniappVisualConfig</code> 进行系统级配置：</p><ul><li><strong>胶囊 (Capsule)</strong>: 这里的&quot;胶囊&quot;是指右上角的控制按钮（关闭、更多）。应用可以请求 <code>dark</code> 或 <code>light</code> 主题的胶囊以适配自身背景。</li><li><strong>圆角 (Radius)</strong>: 窗口圆角半径。</li><li><strong>遮罩 (Mask)</strong>: 背景遮罩的透明度。</li></ul><p>这些配置不仅影响静态布局，也会参与 FLIP 动画的补间计算。</p>`,20)])])}const c=i(e,[["render",l]]);export{g as __pageData,c as default};
