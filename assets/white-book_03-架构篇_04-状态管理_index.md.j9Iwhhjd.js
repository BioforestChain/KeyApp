import{_ as a,c as s,o as n,ag as e}from"./chunks/framework.B0we9iV-.js";const b=JSON.parse('{"title":"状态管理","description":"","frontmatter":{},"headers":[],"relativePath":"white-book/03-架构篇/04-状态管理/index.md","filePath":"white-book/03-架构篇/04-状态管理/index.md"}'),d={name:"white-book/03-架构篇/04-状态管理/index.md"};function l(r,t,i,p,o,h){return n(),s("div",null,[...t[0]||(t[0]=[e(`<h1 id="状态管理" tabindex="-1">状态管理 <a class="header-anchor" href="#状态管理" aria-label="Permalink to &quot;状态管理&quot;">​</a></h1><blockquote><p>定义应用状态管理架构规范</p></blockquote><hr><h2 id="状态分类" tabindex="-1">状态分类 <a class="header-anchor" href="#状态分类" aria-label="Permalink to &quot;状态分类&quot;">​</a></h2><h3 id="三类状态" tabindex="-1">三类状态 <a class="header-anchor" href="#三类状态" aria-label="Permalink to &quot;三类状态&quot;">​</a></h3><table tabindex="0"><thead><tr><th>类型</th><th>特点</th><th>来源</th><th>持久化</th><th>示例</th></tr></thead><tbody><tr><td>客户端状态</td><td>本地产生</td><td>用户操作</td><td>是</td><td>钱包列表、偏好设置</td></tr><tr><td>服务端状态</td><td>远程获取</td><td>API/链</td><td>缓存</td><td>余额、交易历史</td></tr><tr><td>临时状态</td><td>短期存在</td><td>交互</td><td>否</td><td>表单数据、UI 状态</td></tr></tbody></table><h3 id="状态层次" tabindex="-1">状态层次 <a class="header-anchor" href="#状态层次" aria-label="Permalink to &quot;状态层次&quot;">​</a></h3><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>┌──────────────────────────────────────────┐</span></span>
<span class="line"><span>│            Temporary State               │</span></span>
<span class="line"><span>│         (表单级，组件生命周期内)            │</span></span>
<span class="line"><span>├──────────────────────────────────────────┤</span></span>
<span class="line"><span>│            Server State                  │</span></span>
<span class="line"><span>│          (应用级，自动缓存同步)             │</span></span>
<span class="line"><span>├──────────────────────────────────────────┤</span></span>
<span class="line"><span>│            Client State                  │</span></span>
<span class="line"><span>│          (应用级，持久化到本地)             │</span></span>
<span class="line"><span>└──────────────────────────────────────────┘</span></span></code></pre></div><hr><h2 id="客户端状态规范" tabindex="-1">客户端状态规范 <a class="header-anchor" href="#客户端状态规范" aria-label="Permalink to &quot;客户端状态规范&quot;">​</a></h2><h3 id="store-定义" tabindex="-1">Store 定义 <a class="header-anchor" href="#store-定义" aria-label="Permalink to &quot;Store 定义&quot;">​</a></h3><p>每个 Store MUST 包含：</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>Store&lt;T&gt; {</span></span>
<span class="line"><span>  // 状态</span></span>
<span class="line"><span>  state: T</span></span>
<span class="line"><span>  </span></span>
<span class="line"><span>  // 读取</span></span>
<span class="line"><span>  getState(): T</span></span>
<span class="line"><span>  subscribe(listener: (state: T) =&gt; void): Unsubscribe</span></span>
<span class="line"><span>  </span></span>
<span class="line"><span>  // 更新</span></span>
<span class="line"><span>  setState(updater: (prev: T) =&gt; T): void</span></span>
<span class="line"><span>}</span></span></code></pre></div><h3 id="钱包状态-walletstore" tabindex="-1">钱包状态 (WalletStore) <a class="header-anchor" href="#钱包状态-walletstore" aria-label="Permalink to &quot;钱包状态 (WalletStore)&quot;">​</a></h3><table tabindex="0"><thead><tr><th>字段</th><th>类型</th><th>持久化</th><th>说明</th></tr></thead><tbody><tr><td>wallets</td><td>Wallet[]</td><td>是</td><td>钱包列表</td></tr><tr><td>currentWalletId</td><td>string</td><td>是</td><td>当前钱包 ID</td></tr><tr><td>selectedChain</td><td>ChainId</td><td>是</td><td>当前选中链</td></tr></tbody></table><h3 id="偏好状态-preferencesstore" tabindex="-1">偏好状态 (PreferencesStore) <a class="header-anchor" href="#偏好状态-preferencesstore" aria-label="Permalink to &quot;偏好状态 (PreferencesStore)&quot;">​</a></h3><table tabindex="0"><thead><tr><th>字段</th><th>类型</th><th>持久化</th><th>说明</th></tr></thead><tbody><tr><td>language</td><td>LanguageCode</td><td>是</td><td>界面语言</td></tr><tr><td>currency</td><td>CurrencyCode</td><td>是</td><td>显示货币</td></tr><tr><td>theme</td><td>&#39;light&#39; | &#39;dark&#39; | &#39;system&#39;</td><td>是</td><td>主题模式</td></tr><tr><td>biometricEnabled</td><td>boolean</td><td>是</td><td>生物识别开关</td></tr></tbody></table><h3 id="ui-状态-uistore" tabindex="-1">UI 状态 (UIStore) <a class="header-anchor" href="#ui-状态-uistore" aria-label="Permalink to &quot;UI 状态 (UIStore)&quot;">​</a></h3><table tabindex="0"><thead><tr><th>字段</th><th>类型</th><th>持久化</th><th>说明</th></tr></thead><tbody><tr><td>activeSheet</td><td>SheetType</td><td>否</td><td>当前弹窗</td></tr><tr><td>toastQueue</td><td>Toast[]</td><td>否</td><td>Toast 队列</td></tr><tr><td>isLoading</td><td>boolean</td><td>否</td><td>全局加载状态</td></tr></tbody></table><h3 id="地址簿状态-addressbookstore" tabindex="-1">地址簿状态 (AddressBookStore) <a class="header-anchor" href="#地址簿状态-addressbookstore" aria-label="Permalink to &quot;地址簿状态 (AddressBookStore)&quot;">​</a></h3><table tabindex="0"><thead><tr><th>字段</th><th>类型</th><th>持久化</th><th>说明</th></tr></thead><tbody><tr><td>contacts</td><td>Contact[]</td><td>是</td><td>联系人列表</td></tr><tr><td>isInitialized</td><td>boolean</td><td>否</td><td>是否已初始化</td></tr></tbody></table><p><strong>Contact 结构：</strong></p><table tabindex="0"><thead><tr><th>字段</th><th>类型</th><th>说明</th></tr></thead><tbody><tr><td>id</td><td>string</td><td>唯一 ID</td></tr><tr><td>name</td><td>string</td><td>联系人名称</td></tr><tr><td>avatar</td><td>string?</td><td>头像（avatar: 协议）</td></tr><tr><td>addresses</td><td>ContactAddress[]</td><td>地址列表（最多 3 个）</td></tr><tr><td>memo</td><td>string?</td><td>私有备注</td></tr><tr><td>createdAt</td><td>number</td><td>创建时间</td></tr><tr><td>updatedAt</td><td>number</td><td>更新时间</td></tr></tbody></table><p><strong>ContactAddress 结构：</strong></p><table tabindex="0"><thead><tr><th>字段</th><th>类型</th><th>说明</th></tr></thead><tbody><tr><td>id</td><td>string</td><td>唯一 ID</td></tr><tr><td>address</td><td>string</td><td>区块链地址</td></tr><tr><td>label</td><td>string?</td><td>自定义标签（最多 10 字符）</td></tr><tr><td>isDefault</td><td>boolean?</td><td>是否默认地址</td></tr></tbody></table><hr><h2 id="服务端状态规范" tabindex="-1">服务端状态规范 <a class="header-anchor" href="#服务端状态规范" aria-label="Permalink to &quot;服务端状态规范&quot;">​</a></h2><h3 id="缓存策略" tabindex="-1">缓存策略 <a class="header-anchor" href="#缓存策略" aria-label="Permalink to &quot;缓存策略&quot;">​</a></h3><table tabindex="0"><thead><tr><th>数据类型</th><th>缓存时长</th><th>刷新策略</th></tr></thead><tbody><tr><td>余额</td><td>30 秒</td><td>自动轮询 60s</td></tr><tr><td>交易历史</td><td>1 分钟</td><td>新交易时刷新</td></tr><tr><td>Token 元数据</td><td>1 小时</td><td>按需刷新</td></tr><tr><td>汇率</td><td>5 分钟</td><td>自动轮询</td></tr><tr><td>链配置</td><td>24 小时</td><td>手动刷新</td></tr></tbody></table><h3 id="查询键规范" tabindex="-1">查询键规范 <a class="header-anchor" href="#查询键规范" aria-label="Permalink to &quot;查询键规范&quot;">​</a></h3><p>查询键 MUST 遵循以下命名规则：</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>[domain, action, ...params]</span></span>
<span class="line"><span></span></span>
<span class="line"><span>示例：</span></span>
<span class="line"><span>[&#39;wallet&#39;, &#39;balances&#39;, address, chainId]</span></span>
<span class="line"><span>[&#39;transaction&#39;, &#39;history&#39;, address]</span></span>
<span class="line"><span>[&#39;token&#39;, &#39;metadata&#39;, tokenId]</span></span>
<span class="line"><span>[&#39;exchange&#39;, &#39;rates&#39;, baseCurrency]</span></span></code></pre></div><h3 id="查询状态" tabindex="-1">查询状态 <a class="header-anchor" href="#查询状态" aria-label="Permalink to &quot;查询状态&quot;">​</a></h3><table tabindex="0"><thead><tr><th>状态</th><th>说明</th></tr></thead><tbody><tr><td>idle</td><td>未开始</td></tr><tr><td>loading</td><td>加载中（首次）</td></tr><tr><td>success</td><td>成功</td></tr><tr><td>error</td><td>失败</td></tr><tr><td>fetching</td><td>后台刷新中</td></tr></tbody></table><hr><h2 id="状态操作规范" tabindex="-1">状态操作规范 <a class="header-anchor" href="#状态操作规范" aria-label="Permalink to &quot;状态操作规范&quot;">​</a></h2><h3 id="action-定义" tabindex="-1">Action 定义 <a class="header-anchor" href="#action-定义" aria-label="Permalink to &quot;Action 定义&quot;">​</a></h3><p>每个状态域 SHOULD 定义对应的 Actions：</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>WalletActions {</span></span>
<span class="line"><span>  addWallet(wallet: Wallet): void</span></span>
<span class="line"><span>  removeWallet(walletId: string): void</span></span>
<span class="line"><span>  updateWallet(walletId: string, updates: Partial&lt;Wallet&gt;): void</span></span>
<span class="line"><span>  setCurrentWallet(walletId: string): void</span></span>
<span class="line"><span>  setSelectedChain(chain: ChainId): void</span></span>
<span class="line"><span>}</span></span></code></pre></div><h3 id="mutation-规范" tabindex="-1">Mutation 规范 <a class="header-anchor" href="#mutation-规范" aria-label="Permalink to &quot;Mutation 规范&quot;">​</a></h3><p>服务端状态变更 MUST 通过 Mutation：</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>Mutation&lt;TParams, TResult&gt; {</span></span>
<span class="line"><span>  // 执行变更</span></span>
<span class="line"><span>  mutate(params: TParams): Promise&lt;TResult&gt;</span></span>
<span class="line"><span>  </span></span>
<span class="line"><span>  // 状态</span></span>
<span class="line"><span>  isPending: boolean</span></span>
<span class="line"><span>  isSuccess: boolean</span></span>
<span class="line"><span>  isError: boolean</span></span>
<span class="line"><span>  error: Error | null</span></span>
<span class="line"><span>  </span></span>
<span class="line"><span>  // 回调</span></span>
<span class="line"><span>  onSuccess?: (result: TResult) =&gt; void</span></span>
<span class="line"><span>  onError?: (error: Error) =&gt; void</span></span>
<span class="line"><span>  onSettled?: () =&gt; void</span></span>
<span class="line"><span>}</span></span></code></pre></div><h3 id="缓存失效" tabindex="-1">缓存失效 <a class="header-anchor" href="#缓存失效" aria-label="Permalink to &quot;缓存失效&quot;">​</a></h3><p>变更成功后 MUST 使相关缓存失效：</p><table tabindex="0"><thead><tr><th>操作</th><th>失效的缓存</th></tr></thead><tbody><tr><td>转账</td><td>发送方余额、接收方余额、交易历史</td></tr><tr><td>创建钱包</td><td>钱包列表</td></tr><tr><td>质押/解质押</td><td>余额、质押状态</td></tr></tbody></table><hr><h2 id="状态持久化规范" tabindex="-1">状态持久化规范 <a class="header-anchor" href="#状态持久化规范" aria-label="Permalink to &quot;状态持久化规范&quot;">​</a></h2><h3 id="存储键命名" tabindex="-1">存储键命名 <a class="header-anchor" href="#存储键命名" aria-label="Permalink to &quot;存储键命名&quot;">​</a></h3><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>bfm_{domain}_{version}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>示例：</span></span>
<span class="line"><span>bfm_wallets_v1</span></span>
<span class="line"><span>bfm_preferences_v1</span></span>
<span class="line"><span>bfm_cache_v1</span></span></code></pre></div><h3 id="持久化策略" tabindex="-1">持久化策略 <a class="header-anchor" href="#持久化策略" aria-label="Permalink to &quot;持久化策略&quot;">​</a></h3><table tabindex="0"><thead><tr><th>状态</th><th>存储位置</th><th>加密</th></tr></thead><tbody><tr><td>钱包列表</td><td>安全存储</td><td>是</td></tr><tr><td>用户偏好</td><td>本地存储</td><td>否</td></tr><tr><td>查询缓存</td><td>本地存储</td><td>否</td></tr></tbody></table><h3 id="版本迁移" tabindex="-1">版本迁移 <a class="header-anchor" href="#版本迁移" aria-label="Permalink to &quot;版本迁移&quot;">​</a></h3><ul><li><strong>MUST</strong> 在存储数据中包含版本号</li><li><strong>MUST</strong> 支持旧版本数据迁移</li><li><strong>SHOULD</strong> 在迁移失败时保留原数据</li></ul><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>迁移流程：</span></span>
<span class="line"><span>读取存储数据</span></span>
<span class="line"><span>    │</span></span>
<span class="line"><span>    ▼</span></span>
<span class="line"><span>检查版本号</span></span>
<span class="line"><span>    │</span></span>
<span class="line"><span>    ├── 当前版本 ──► 直接使用</span></span>
<span class="line"><span>    │</span></span>
<span class="line"><span>    └── 旧版本 ──► 执行迁移</span></span>
<span class="line"><span>                    │</span></span>
<span class="line"><span>                    ├── 成功 ──► 保存新版本</span></span>
<span class="line"><span>                    │</span></span>
<span class="line"><span>                    └── 失败 ──► 使用默认值 + 报告错误</span></span></code></pre></div><hr><h2 id="状态订阅规范" tabindex="-1">状态订阅规范 <a class="header-anchor" href="#状态订阅规范" aria-label="Permalink to &quot;状态订阅规范&quot;">​</a></h2><h3 id="细粒度订阅" tabindex="-1">细粒度订阅 <a class="header-anchor" href="#细粒度订阅" aria-label="Permalink to &quot;细粒度订阅&quot;">​</a></h3><ul><li><strong>MUST</strong> 只订阅组件需要的状态片段</li><li><strong>MUST NOT</strong> 订阅整个 Store 状态</li><li><strong>SHOULD</strong> 使用选择器（Selector）提取状态</li></ul><h3 id="选择器规范" tabindex="-1">选择器规范 <a class="header-anchor" href="#选择器规范" aria-label="Permalink to &quot;选择器规范&quot;">​</a></h3><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>Selector&lt;TState, TResult&gt; = (state: TState) =&gt; TResult</span></span>
<span class="line"><span></span></span>
<span class="line"><span>示例：</span></span>
<span class="line"><span>// ✓ 好：细粒度选择</span></span>
<span class="line"><span>const currentWallet = useSelector(state =&gt; state.wallets.find(</span></span>
<span class="line"><span>  w =&gt; w.id === state.currentWalletId</span></span>
<span class="line"><span>))</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// ✗ 差：订阅全部状态</span></span>
<span class="line"><span>const allState = useSelector(state =&gt; state)</span></span></code></pre></div><h3 id="派生状态" tabindex="-1">派生状态 <a class="header-anchor" href="#派生状态" aria-label="Permalink to &quot;派生状态&quot;">​</a></h3><p>派生状态 SHOULD 通过选择器计算：</p><table tabindex="0"><thead><tr><th>派生状态</th><th>依赖</th><th>计算</th></tr></thead><tbody><tr><td>当前钱包</td><td>wallets, currentWalletId</td><td>wallets.find(w =&gt; w.id === currentWalletId)</td></tr><tr><td>当前地址</td><td>currentWallet, selectedChain</td><td>currentWallet.addresses[selectedChain]</td></tr><tr><td>总资产</td><td>balances, exchangeRates</td><td>sum(balances * rates)</td></tr></tbody></table><hr><h2 id="乐观更新规范" tabindex="-1">乐观更新规范 <a class="header-anchor" href="#乐观更新规范" aria-label="Permalink to &quot;乐观更新规范&quot;">​</a></h2><h3 id="适用场景" tabindex="-1">适用场景 <a class="header-anchor" href="#适用场景" aria-label="Permalink to &quot;适用场景&quot;">​</a></h3><table tabindex="0"><thead><tr><th>操作</th><th>乐观更新</th><th>原因</th></tr></thead><tbody><tr><td>切换钱包</td><td>是</td><td>本地操作，必定成功</td></tr><tr><td>修改昵称</td><td>是</td><td>失败概率低</td></tr><tr><td>转账</td><td>否</td><td>需等待链上确认</td></tr><tr><td>删除钱包</td><td>否</td><td>不可逆操作</td></tr></tbody></table><h3 id="乐观更新流程" tabindex="-1">乐观更新流程 <a class="header-anchor" href="#乐观更新流程" aria-label="Permalink to &quot;乐观更新流程&quot;">​</a></h3><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>用户操作</span></span>
<span class="line"><span>    │</span></span>
<span class="line"><span>    ▼</span></span>
<span class="line"><span>立即更新 UI（乐观）</span></span>
<span class="line"><span>    │</span></span>
<span class="line"><span>    ▼</span></span>
<span class="line"><span>发送请求</span></span>
<span class="line"><span>    │</span></span>
<span class="line"><span>    ├── 成功 ──► 保持状态</span></span>
<span class="line"><span>    │</span></span>
<span class="line"><span>    └── 失败 ──► 回滚状态 + 显示错误</span></span></code></pre></div><hr><h2 id="错误处理规范" tabindex="-1">错误处理规范 <a class="header-anchor" href="#错误处理规范" aria-label="Permalink to &quot;错误处理规范&quot;">​</a></h2><h3 id="查询错误" tabindex="-1">查询错误 <a class="header-anchor" href="#查询错误" aria-label="Permalink to &quot;查询错误&quot;">​</a></h3><ul><li><strong>MUST</strong> 显示错误状态</li><li><strong>MUST</strong> 提供重试机制</li><li><strong>SHOULD</strong> 显示缓存数据（如有）</li><li><strong>SHOULD</strong> 自动重试网络错误</li></ul><h3 id="变更错误" tabindex="-1">变更错误 <a class="header-anchor" href="#变更错误" aria-label="Permalink to &quot;变更错误&quot;">​</a></h3><ul><li><strong>MUST</strong> 显示错误消息</li><li><strong>MUST</strong> 回滚乐观更新</li><li><strong>SHOULD</strong> 保留用户输入</li><li><strong>MAY</strong> 提供错误详情查看</li></ul><hr><h2 id="本章小结" tabindex="-1">本章小结 <a class="header-anchor" href="#本章小结" aria-label="Permalink to &quot;本章小结&quot;">​</a></h2><ul><li>状态分为客户端、服务端、临时三类</li><li>客户端状态需持久化到本地</li><li>服务端状态需合理配置缓存</li><li>细粒度订阅避免过度渲染</li><li>支持乐观更新提升体验</li><li>版本迁移确保数据兼容</li></ul>`,78)])])}const u=a(d,[["render",l]]);export{b as __pageData,u as default};
