import{_ as t,c as a,o as i,ag as n}from"./chunks/framework.B0we9iV-.js";const c=JSON.parse('{"title":"第二十三章：测试策略","description":"","frontmatter":{},"headers":[],"relativePath":"white-book/08-测试篇/01-测试策略/index.md","filePath":"white-book/08-测试篇/01-测试策略/index.md"}'),e={name:"white-book/08-测试篇/01-测试策略/index.md"};function h(l,s,p,d,r,k){return i(),a("div",null,[...s[0]||(s[0]=[n(`<h1 id="第二十三章-测试策略" tabindex="-1">第二十三章：测试策略 <a class="header-anchor" href="#第二十三章-测试策略" aria-label="Permalink to &quot;第二十三章：测试策略&quot;">​</a></h1><blockquote><p>分层测试、覆盖率目标、Storybook + Vitest 集成</p></blockquote><hr><h2 id="_23-1-测试环境的本质区别" tabindex="-1">23.1 测试环境的本质区别 <a class="header-anchor" href="#_23-1-测试环境的本质区别" aria-label="Permalink to &quot;23.1 测试环境的本质区别&quot;">​</a></h2><p><strong>Storybook v10 的核心价值：与 Vitest 深度融合，为组件测试提供真实浏览器环境。</strong></p><table tabindex="0"><thead><tr><th>环境</th><th>技术栈</th><th>特点</th><th>适用场景</th></tr></thead><tbody><tr><td><strong>jsdom/happy-dom</strong></td><td>Vitest 单元测试</td><td>虚拟 DOM，快速但非真实浏览器</td><td>纯逻辑、算法、工具函数</td></tr><tr><td><strong>真实浏览器 (Storybook)</strong></td><td>Storybook + Vitest</td><td>真实渲染、真实 CSS、真实事件</td><td>组件渲染、复杂交互、样式验证</td></tr><tr><td><strong>真实浏览器 (E2E)</strong></td><td>Playwright</td><td>完整应用实例</td><td>端到端用户流程</td></tr></tbody></table><h3 id="为什么需要三层测试" tabindex="-1">为什么需要三层测试？ <a class="header-anchor" href="#为什么需要三层测试" aria-label="Permalink to &quot;为什么需要三层测试？&quot;">​</a></h3><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>jsdom/happy-dom 的局限性：</span></span>
<span class="line"><span>- 不支持真实 CSS 计算（layout、动画）</span></span>
<span class="line"><span>- 不支持某些 Web API（ResizeObserver、IntersectionObserver 需 polyfill）</span></span>
<span class="line"><span>- 事件模型与真实浏览器有差异</span></span>
<span class="line"><span></span></span>
<span class="line"><span>Storybook 组件测试的价值：</span></span>
<span class="line"><span>- 在真实 Chromium 中渲染组件</span></span>
<span class="line"><span>- 验证 CSS 样式、动画、响应式布局</span></span>
<span class="line"><span>- 测试真实的用户交互（点击、输入、手势）</span></span>
<span class="line"><span>- 每个 Story 自动成为冒烟测试</span></span>
<span class="line"><span></span></span>
<span class="line"><span>E2E 与组件测试的区别：</span></span>
<span class="line"><span>- E2E 测试完整应用流程（页面导航、状态持久化）</span></span>
<span class="line"><span>- 组件测试聚焦单个组件的隔离行为</span></span>
<span class="line"><span>- 组件测试更快、更稳定、更容易定位问题</span></span></code></pre></div><hr><h2 id="_23-2-测试分层" tabindex="-1">23.2 测试分层 <a class="header-anchor" href="#_23-2-测试分层" aria-label="Permalink to &quot;23.2 测试分层&quot;">​</a></h2><table tabindex="0"><thead><tr><th>层级</th><th>工具</th><th>测试内容</th><th>运行频率</th></tr></thead><tbody><tr><td>单元测试</td><td>Vitest (jsdom)</td><td>业务逻辑、工具函数、Hooks</td><td>每次提交</td></tr><tr><td>组件测试</td><td>Storybook + Vitest (浏览器)</td><td>组件渲染、交互</td><td>每次提交</td></tr><tr><td>E2E 测试</td><td>Playwright</td><td>完整用户流程</td><td>PR / 发布前</td></tr></tbody></table><hr><h2 id="_23-3-测试命令" tabindex="-1">23.3 测试命令 <a class="header-anchor" href="#_23-3-测试命令" aria-label="Permalink to &quot;23.3 测试命令&quot;">​</a></h2><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">pnpm</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> test</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">              # 单元测试 (*.test.ts)</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">pnpm</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> test:storybook</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    # Storybook 组件测试 (*.stories.tsx)</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">pnpm</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> test:all</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">          # 运行所有测试</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">pnpm</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> test:coverage</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">     # 单元测试 + 覆盖率报告</span></span></code></pre></div><hr><h2 id="_23-4-storybook-vitest-集成" tabindex="-1">23.4 Storybook + Vitest 集成 <a class="header-anchor" href="#_23-4-storybook-vitest-集成" aria-label="Permalink to &quot;23.4 Storybook + Vitest 集成&quot;">​</a></h2><p>项目使用 <code>@storybook/addon-vitest</code> 将 Stories 作为测试用例运行。</p><h3 id="测试类型对比" tabindex="-1">测试类型对比 <a class="header-anchor" href="#测试类型对比" aria-label="Permalink to &quot;测试类型对比&quot;">​</a></h3><table tabindex="0"><thead><tr><th>文件类型</th><th>测试内容</th><th>运行环境</th><th>价值</th></tr></thead><tbody><tr><td><code>*.test.ts</code></td><td>纯逻辑/函数</td><td>jsdom (快)</td><td>验证业务逻辑正确性</td></tr><tr><td><code>*.stories.tsx</code> (无 play)</td><td>组件能否渲染</td><td>真实浏览器</td><td>冒烟测试，防止渲染崩溃</td></tr><tr><td><code>*.stories.tsx</code> (有 play)</td><td>用户交互流程</td><td>真实浏览器</td><td>集成测试</td></tr></tbody></table><h3 id="配置文件" tabindex="-1">配置文件 <a class="header-anchor" href="#配置文件" aria-label="Permalink to &quot;配置文件&quot;">​</a></h3><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>vitest.config.ts          # 定义 unit 和 storybook 两个项目</span></span>
<span class="line"><span>.storybook/vitest.setup.ts # Storybook 测试初始化</span></span>
<span class="line"><span>.storybook/preview.tsx     # 全局 decorators (i18n, QueryClient, theme)</span></span></code></pre></div><h3 id="story-编写规范" tabindex="-1">Story 编写规范 <a class="header-anchor" href="#story-编写规范" aria-label="Permalink to &quot;Story 编写规范&quot;">​</a></h3><p><strong>基础 Story（自动冒烟测试）：</strong></p><div class="language-tsx vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">tsx</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Default</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Story</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  args: { value: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;test&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> },</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p><strong>带交互测试的 Story：</strong></p><div class="language-tsx vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">tsx</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { within, userEvent, expect } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;storybook/test&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Interactive</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Story</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  play</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">async</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ({ </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">canvasElement</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> }) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> canvas</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> within</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(canvasElement)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> input</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> canvas.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getByRole</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;textbox&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> userEvent.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">type</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(input, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;hello&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    expect</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(canvas.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getByText</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;hello&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)).</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">toBeInTheDocument</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  },</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><h3 id="全局-decorators" tabindex="-1">全局 Decorators <a class="header-anchor" href="#全局-decorators" aria-label="Permalink to &quot;全局 Decorators&quot;">​</a></h3><p>在 <code>.storybook/preview.tsx</code> 中配置全局 Provider：</p><div class="language-tsx vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">tsx</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 必须包装的 Provider</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> I18nextProvider      # 国际化</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> QueryClientProvider  # TanStack Query</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ThemeProvider        # 主题切换</span></span></code></pre></div><h3 id="何时使用-play-函数" tabindex="-1">何时使用 play 函数 <a class="header-anchor" href="#何时使用-play-函数" aria-label="Permalink to &quot;何时使用 play 函数&quot;">​</a></h3><table tabindex="0"><thead><tr><th>场景</th><th>是否需要 play</th></tr></thead><tbody><tr><td>纯展示组件</td><td>否 - 自动冒烟测试足够</td></tr><tr><td>复杂交互（手势、拖拽）</td><td>是</td></tr><tr><td>表单验证流程</td><td>是</td></tr><tr><td>状态机组件</td><td>是</td></tr><tr><td>已有 *.test.ts 覆盖的逻辑</td><td>否 - 避免重复</td></tr></tbody></table><hr><h2 id="_23-5-覆盖率目标" tabindex="-1">23.5 覆盖率目标 <a class="header-anchor" href="#_23-5-覆盖率目标" aria-label="Permalink to &quot;23.5 覆盖率目标&quot;">​</a></h2><table tabindex="0"><thead><tr><th>类型</th><th>目标</th></tr></thead><tbody><tr><td>语句覆盖</td><td>≥ 70%</td></tr><tr><td>分支覆盖</td><td>≥ 70%</td></tr><tr><td>函数覆盖</td><td>≥ 70%</td></tr><tr><td>行覆盖</td><td>≥ 70%</td></tr></tbody></table><hr><h2 id="_23-6-测试优先级" tabindex="-1">23.6 测试优先级 <a class="header-anchor" href="#_23-6-测试优先级" aria-label="Permalink to &quot;23.6 测试优先级&quot;">​</a></h2><table tabindex="0"><thead><tr><th>优先级</th><th>测试内容</th></tr></thead><tbody><tr><td>P0</td><td>密钥生成/派生、加密/解密、签名验证</td></tr><tr><td>P1</td><td>钱包创建/导入、转账流程</td></tr><tr><td>P2</td><td>余额查询、交易历史</td></tr><tr><td>P3</td><td>设置、语言切换</td></tr></tbody></table><hr><h2 id="_23-7-测试命名规范" tabindex="-1">23.7 测试命名规范 <a class="header-anchor" href="#_23-7-测试命名规范" aria-label="Permalink to &quot;23.7 测试命名规范&quot;">​</a></h2><div class="language-typescript vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">describe</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;WalletStore&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, () </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  describe</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;addWallet&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, () </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    it</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;should add wallet to list&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, () </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {})</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    it</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;should set as current wallet&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, () </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {})</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    it</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;should persist to localStorage&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, () </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {})</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  })</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">})</span></span></code></pre></div><hr><h2 id="_23-8-ci-集成" tabindex="-1">23.8 CI 集成 <a class="header-anchor" href="#_23-8-ci-集成" aria-label="Permalink to &quot;23.8 CI 集成&quot;">​</a></h2><p>CI 流水线运行以下测试：</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># .github/workflows/ci.yml</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">pnpm turbo run test:run test:storybook e2e:ci</span></span></code></pre></div><table tabindex="0"><thead><tr><th>步骤</th><th>说明</th></tr></thead><tbody><tr><td>test:run</td><td>单元测试 (jsdom)</td></tr><tr><td>test:storybook</td><td>Storybook 组件测试 (chromium)</td></tr><tr><td>e2e:ci</td><td>E2E 集成测试</td></tr></tbody></table><hr><h2 id="本章小结" tabindex="-1">本章小结 <a class="header-anchor" href="#本章小结" aria-label="Permalink to &quot;本章小结&quot;">​</a></h2><ul><li>三层测试：单元 → 组件 → E2E</li><li>Storybook Stories 自动作为冒烟测试运行</li><li>复杂交互使用 <code>play</code> 函数</li><li>避免 <code>*.test.ts</code> 和 <code>play</code> 函数测试重复</li><li>覆盖率目标 70%</li><li>安全相关代码优先测试</li></ul>`,48)])])}const E=t(e,[["render",h]]);export{c as __pageData,E as default};
