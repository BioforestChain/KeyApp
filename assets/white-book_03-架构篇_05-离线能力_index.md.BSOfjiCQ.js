import{_ as t,c as n,o as s,ag as e}from"./chunks/framework.B0we9iV-.js";const b=JSON.parse('{"title":"离线能力篇","description":"","frontmatter":{},"headers":[],"relativePath":"white-book/03-架构篇/05-离线能力/index.md","filePath":"white-book/03-架构篇/05-离线能力/index.md"}'),d={name:"white-book/03-架构篇/05-离线能力/index.md"};function l(i,a,r,p,o,h){return s(),n("div",null,[...a[0]||(a[0]=[e(`<h1 id="离线能力篇" tabindex="-1">离线能力篇 <a class="header-anchor" href="#离线能力篇" aria-label="Permalink to &quot;离线能力篇&quot;">​</a></h1><blockquote><p>定义应用在无网络环境下的行为规范</p></blockquote><hr><h2 id="概述" tabindex="-1">概述 <a class="header-anchor" href="#概述" aria-label="Permalink to &quot;概述&quot;">​</a></h2><p>钱包应用 <strong>MUST</strong> 具备离线能力，确保用户在网络不可用时仍能：</p><ul><li>查看缓存的资产信息</li><li>准备交易（离线签名）</li><li>访问关键设置</li></ul><hr><h2 id="离线状态检测" tabindex="-1">离线状态检测 <a class="header-anchor" href="#离线状态检测" aria-label="Permalink to &quot;离线状态检测&quot;">​</a></h2><h3 id="网络状态定义" tabindex="-1">网络状态定义 <a class="header-anchor" href="#网络状态定义" aria-label="Permalink to &quot;网络状态定义&quot;">​</a></h3><table tabindex="0"><thead><tr><th>状态</th><th>说明</th><th>检测方式</th></tr></thead><tbody><tr><td>online</td><td>网络正常可用</td><td>navigator.onLine + 心跳检测</td></tr><tr><td>offline</td><td>完全无网络</td><td>navigator.onLine = false</td></tr><tr><td>degraded</td><td>网络不稳定</td><td>请求超时率 &gt; 50%</td></tr><tr><td>limited</td><td>部分服务可用</td><td>特定 API 可达</td></tr></tbody></table><h3 id="检测规范" tabindex="-1">检测规范 <a class="header-anchor" href="#检测规范" aria-label="Permalink to &quot;检测规范&quot;">​</a></h3><ul><li><strong>MUST</strong> 监听 <code>online</code>/<code>offline</code> 事件</li><li><strong>MUST</strong> 实现心跳检测（每 30s 检测一次）</li><li><strong>SHOULD</strong> 区分&quot;无网络&quot;和&quot;服务不可用&quot;</li><li><strong>SHOULD</strong> 检测网络质量（延迟、丢包）</li></ul><h3 id="状态机" tabindex="-1">状态机 <a class="header-anchor" href="#状态机" aria-label="Permalink to &quot;状态机&quot;">​</a></h3><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>         online</span></span>
<span class="line"><span>           │</span></span>
<span class="line"><span>    ┌──────┴──────┐</span></span>
<span class="line"><span>    │             │</span></span>
<span class="line"><span>    ▼             ▼</span></span>
<span class="line"><span> degraded ───► offline</span></span>
<span class="line"><span>    │             │</span></span>
<span class="line"><span>    └──────┬──────┘</span></span>
<span class="line"><span>           │</span></span>
<span class="line"><span>           ▼</span></span>
<span class="line"><span>        online</span></span></code></pre></div><hr><h2 id="离线数据缓存" tabindex="-1">离线数据缓存 <a class="header-anchor" href="#离线数据缓存" aria-label="Permalink to &quot;离线数据缓存&quot;">​</a></h2><h3 id="缓存层级" tabindex="-1">缓存层级 <a class="header-anchor" href="#缓存层级" aria-label="Permalink to &quot;缓存层级&quot;">​</a></h3><table tabindex="0"><thead><tr><th>层级</th><th>数据类型</th><th>存储位置</th><th>有效期</th></tr></thead><tbody><tr><td>L1</td><td>钱包数据、密钥</td><td>加密存储</td><td>永久</td></tr><tr><td>L2</td><td>用户设置、偏好</td><td>本地存储</td><td>永久</td></tr><tr><td>L3</td><td>资产余额</td><td>本地存储</td><td>缓存+时间戳</td></tr><tr><td>L4</td><td>交易历史</td><td>本地存储</td><td>最近 100 条</td></tr><tr><td>L5</td><td>链配置、代币元数据</td><td>本地存储</td><td>24 小时</td></tr></tbody></table><h3 id="缓存规范" tabindex="-1">缓存规范 <a class="header-anchor" href="#缓存规范" aria-label="Permalink to &quot;缓存规范&quot;">​</a></h3><h4 id="l1-关键数据-永久存储" tabindex="-1">L1 关键数据（永久存储） <a class="header-anchor" href="#l1-关键数据-永久存储" aria-label="Permalink to &quot;L1 关键数据（永久存储）&quot;">​</a></h4><table tabindex="0"><thead><tr><th>数据</th><th>离线可用</th><th>说明</th></tr></thead><tbody><tr><td>加密助记词</td><td>✓</td><td>可离线签名</td></tr><tr><td>钱包列表</td><td>✓</td><td>可查看所有钱包</td></tr><tr><td>地址列表</td><td>✓</td><td>可查看/复制地址</td></tr></tbody></table><h4 id="l3-资产数据-带时间戳缓存" tabindex="-1">L3 资产数据（带时间戳缓存） <a class="header-anchor" href="#l3-资产数据-带时间戳缓存" aria-label="Permalink to &quot;L3 资产数据（带时间戳缓存）&quot;">​</a></h4><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>CachedBalance {</span></span>
<span class="line"><span>  address: string</span></span>
<span class="line"><span>  chainId: string</span></span>
<span class="line"><span>  balance: string</span></span>
<span class="line"><span>  timestamp: number      // 缓存时间</span></span>
<span class="line"><span>  expiresAt: number      // 过期时间</span></span>
<span class="line"><span>  isStale: boolean       // 是否过期</span></span>
<span class="line"><span>}</span></span></code></pre></div><p><strong>显示规范：</strong></p><ul><li><strong>MUST</strong> 显示缓存时间（&quot;5 分钟前&quot;）</li><li><strong>MUST</strong> 过期数据标记为&quot;可能已过期&quot;</li><li><strong>SHOULD</strong> 使用不同视觉样式区分新旧数据</li></ul><hr><h2 id="离线功能矩阵" tabindex="-1">离线功能矩阵 <a class="header-anchor" href="#离线功能矩阵" aria-label="Permalink to &quot;离线功能矩阵&quot;">​</a></h2><h3 id="功能可用性" tabindex="-1">功能可用性 <a class="header-anchor" href="#功能可用性" aria-label="Permalink to &quot;功能可用性&quot;">​</a></h3><table tabindex="0"><thead><tr><th>功能</th><th>在线</th><th>离线</th><th>降级模式</th></tr></thead><tbody><tr><td>查看钱包列表</td><td>✓</td><td>✓</td><td>-</td></tr><tr><td>查看地址</td><td>✓</td><td>✓</td><td>-</td></tr><tr><td>复制地址</td><td>✓</td><td>✓</td><td>-</td></tr><tr><td>查看余额</td><td>✓</td><td>缓存</td><td>显示缓存时间</td></tr><tr><td>查看交易历史</td><td>✓</td><td>缓存</td><td>显示缓存条数</td></tr><tr><td>发起转账</td><td>✓</td><td>准备</td><td>离线签名，待上线广播</td></tr><tr><td>扫描二维码</td><td>✓</td><td>✓</td><td>解析但不验证</td></tr><tr><td>修改设置</td><td>✓</td><td>✓</td><td>本地保存</td></tr><tr><td>查看助记词</td><td>✓</td><td>✓</td><td>本地解密</td></tr><tr><td>创建钱包</td><td>✓</td><td>✓</td><td>本地生成</td></tr></tbody></table><h3 id="完全不可用功能" tabindex="-1">完全不可用功能 <a class="header-anchor" href="#完全不可用功能" aria-label="Permalink to &quot;完全不可用功能&quot;">​</a></h3><table tabindex="0"><thead><tr><th>功能</th><th>原因</th><th>离线提示</th></tr></thead><tbody><tr><td>实时余额</td><td>需要链上查询</td><td>&quot;显示缓存数据&quot;</td></tr><tr><td>广播交易</td><td>需要节点连接</td><td>&quot;交易已签名，恢复网络后发送&quot;</td></tr><tr><td>交易确认状态</td><td>需要链上查询</td><td>&quot;无法获取最新状态&quot;</td></tr><tr><td>质押操作</td><td>需要链上交互</td><td>&quot;需要网络连接&quot;</td></tr></tbody></table><hr><h2 id="离线签名" tabindex="-1">离线签名 <a class="header-anchor" href="#离线签名" aria-label="Permalink to &quot;离线签名&quot;">​</a></h2><h3 id="流程规范" tabindex="-1">流程规范 <a class="header-anchor" href="#流程规范" aria-label="Permalink to &quot;流程规范&quot;">​</a></h3><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>用户发起转账（离线）</span></span>
<span class="line"><span>        │</span></span>
<span class="line"><span>        ▼</span></span>
<span class="line"><span>验证本地缓存的 nonce</span></span>
<span class="line"><span>        │</span></span>
<span class="line"><span>        ├── 有缓存 ──► 使用缓存 nonce + 1</span></span>
<span class="line"><span>        │</span></span>
<span class="line"><span>        └── 无缓存 ──► 提示&quot;需要网络获取 nonce&quot;</span></span>
<span class="line"><span>                      或允许用户手动输入</span></span>
<span class="line"><span>        │</span></span>
<span class="line"><span>        ▼</span></span>
<span class="line"><span>构建交易对象（本地）</span></span>
<span class="line"><span>        │</span></span>
<span class="line"><span>        ▼</span></span>
<span class="line"><span>解密私钥，签名交易</span></span>
<span class="line"><span>        │</span></span>
<span class="line"><span>        ▼</span></span>
<span class="line"><span>存储签名交易到待发送队列</span></span>
<span class="line"><span>        │</span></span>
<span class="line"><span>        ▼</span></span>
<span class="line"><span>显示&quot;交易已准备，恢复网络后自动发送&quot;</span></span></code></pre></div><h3 id="待发送队列" tabindex="-1">待发送队列 <a class="header-anchor" href="#待发送队列" aria-label="Permalink to &quot;待发送队列&quot;">​</a></h3><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>PendingTransaction {</span></span>
<span class="line"><span>  id: string</span></span>
<span class="line"><span>  signedTx: string       // 签名后的交易</span></span>
<span class="line"><span>  chainId: string</span></span>
<span class="line"><span>  createdAt: number</span></span>
<span class="line"><span>  expiresAt: number      // 过期时间（建议 24h）</span></span>
<span class="line"><span>  status: &#39;pending&#39; | &#39;broadcasting&#39; | &#39;sent&#39; | &#39;failed&#39; | &#39;expired&#39;</span></span>
<span class="line"><span>  retryCount: number</span></span>
<span class="line"><span>  error?: string</span></span>
<span class="line"><span>}</span></span></code></pre></div><h3 id="队列管理规范" tabindex="-1">队列管理规范 <a class="header-anchor" href="#队列管理规范" aria-label="Permalink to &quot;队列管理规范&quot;">​</a></h3><ul><li><strong>MUST</strong> 网络恢复后自动尝试广播</li><li><strong>MUST</strong> 显示队列中的待发送交易</li><li><strong>MUST</strong> 交易过期后提示用户（nonce 可能已失效）</li><li><strong>SHOULD</strong> 支持取消待发送交易</li><li><strong>SHOULD</strong> 广播失败后自动重试（最多 3 次）</li></ul><hr><h2 id="离线-ui-规范" tabindex="-1">离线 UI 规范 <a class="header-anchor" href="#离线-ui-规范" aria-label="Permalink to &quot;离线 UI 规范&quot;">​</a></h2><h3 id="全局提示" tabindex="-1">全局提示 <a class="header-anchor" href="#全局提示" aria-label="Permalink to &quot;全局提示&quot;">​</a></h3><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>┌─────────────────────────────────────┐</span></span>
<span class="line"><span>│ ⚠️ 当前离线 - 部分功能受限           │</span></span>
<span class="line"><span>│ [点击查看详情]                       │</span></span>
<span class="line"><span>└─────────────────────────────────────┘</span></span></code></pre></div><p><strong>规范要求：</strong></p><ul><li><strong>MUST</strong> 离线时显示全局提示条</li><li><strong>MUST</strong> 提示条不遮挡核心内容</li><li><strong>SHOULD</strong> 提供&quot;查看离线功能&quot;入口</li><li><strong>SHOULD</strong> 网络恢复后自动消失</li></ul><h3 id="数据新鲜度指示" tabindex="-1">数据新鲜度指示 <a class="header-anchor" href="#数据新鲜度指示" aria-label="Permalink to &quot;数据新鲜度指示&quot;">​</a></h3><table tabindex="0"><thead><tr><th>状态</th><th>视觉表现</th><th>说明</th></tr></thead><tbody><tr><td>实时</td><td>正常显示</td><td>&lt; 1 分钟</td></tr><tr><td>较新</td><td>灰色时间戳</td><td>1-10 分钟</td></tr><tr><td>过期</td><td>黄色警告 + 时间戳</td><td>&gt; 10 分钟</td></tr><tr><td>很旧</td><td>红色警告</td><td>&gt; 1 小时</td></tr></tbody></table><h3 id="功能禁用状态" tabindex="-1">功能禁用状态 <a class="header-anchor" href="#功能禁用状态" aria-label="Permalink to &quot;功能禁用状态&quot;">​</a></h3><p>不可用功能 <strong>MUST</strong> 明确标识：</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>┌─────────────────────────────────────┐</span></span>
<span class="line"><span>│  [发送] (需要网络)                   │</span></span>
<span class="line"><span>│  └─ 灰色禁用 + 提示文字              │</span></span>
<span class="line"><span>└─────────────────────────────────────┘</span></span></code></pre></div><hr><h2 id="数据同步" tabindex="-1">数据同步 <a class="header-anchor" href="#数据同步" aria-label="Permalink to &quot;数据同步&quot;">​</a></h2><h3 id="恢复在线后的同步" tabindex="-1">恢复在线后的同步 <a class="header-anchor" href="#恢复在线后的同步" aria-label="Permalink to &quot;恢复在线后的同步&quot;">​</a></h3><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>网络恢复</span></span>
<span class="line"><span>    │</span></span>
<span class="line"><span>    ├─► 刷新余额（优先级: 高）</span></span>
<span class="line"><span>    │</span></span>
<span class="line"><span>    ├─► 广播待发送交易（优先级: 高）</span></span>
<span class="line"><span>    │</span></span>
<span class="line"><span>    ├─► 同步交易历史（优先级: 中）</span></span>
<span class="line"><span>    │</span></span>
<span class="line"><span>    └─► 更新链配置（优先级: 低）</span></span></code></pre></div><h3 id="冲突处理" tabindex="-1">冲突处理 <a class="header-anchor" href="#冲突处理" aria-label="Permalink to &quot;冲突处理&quot;">​</a></h3><table tabindex="0"><thead><tr><th>冲突类型</th><th>处理策略</th></tr></thead><tbody><tr><td>设置冲突</td><td>本地优先（用户最近修改）</td></tr><tr><td>交易 nonce 冲突</td><td>提示用户重新发起</td></tr><tr><td>余额不一致</td><td>服务端优先（以链上为准）</td></tr></tbody></table><h3 id="同步状态" tabindex="-1">同步状态 <a class="header-anchor" href="#同步状态" aria-label="Permalink to &quot;同步状态&quot;">​</a></h3><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>SyncStatus {</span></span>
<span class="line"><span>  lastSyncTime: number</span></span>
<span class="line"><span>  isSyncing: boolean</span></span>
<span class="line"><span>  pendingChanges: number</span></span>
<span class="line"><span>  syncErrors: SyncError[]</span></span>
<span class="line"><span>}</span></span></code></pre></div><hr><h2 id="存储管理" tabindex="-1">存储管理 <a class="header-anchor" href="#存储管理" aria-label="Permalink to &quot;存储管理&quot;">​</a></h2><h3 id="存储配额" tabindex="-1">存储配额 <a class="header-anchor" href="#存储配额" aria-label="Permalink to &quot;存储配额&quot;">​</a></h3><table tabindex="0"><thead><tr><th>数据类型</th><th>建议配额</th></tr></thead><tbody><tr><td>钱包数据</td><td>无限制</td></tr><tr><td>交易历史</td><td>最近 100 条/地址</td></tr><tr><td>缓存数据</td><td>最大 50MB</td></tr></tbody></table><h3 id="清理策略" tabindex="-1">清理策略 <a class="header-anchor" href="#清理策略" aria-label="Permalink to &quot;清理策略&quot;">​</a></h3><ul><li><strong>SHOULD</strong> 超过配额时清理最旧的缓存</li><li><strong>MUST NOT</strong> 自动清理钱包数据</li><li><strong>SHOULD</strong> 提供手动清理缓存入口</li></ul><hr><h2 id="测试要求" tabindex="-1">测试要求 <a class="header-anchor" href="#测试要求" aria-label="Permalink to &quot;测试要求&quot;">​</a></h2><h3 id="离线测试场景" tabindex="-1">离线测试场景 <a class="header-anchor" href="#离线测试场景" aria-label="Permalink to &quot;离线测试场景&quot;">​</a></h3><table tabindex="0"><thead><tr><th>场景</th><th>验证点</th></tr></thead><tbody><tr><td>启动时离线</td><td>能正常进入应用，显示缓存</td></tr><tr><td>使用中断网</td><td>立即显示离线提示</td></tr><tr><td>离线发起转账</td><td>能完成签名，进入待发送</td></tr><tr><td>恢复网络</td><td>自动同步，广播待发送</td></tr><tr><td>长时间离线</td><td>缓存过期正确标识</td></tr></tbody></table><hr><h2 id="本章小结" tabindex="-1">本章小结 <a class="header-anchor" href="#本章小结" aria-label="Permalink to &quot;本章小结&quot;">​</a></h2><ul><li>钱包必须具备离线核心功能</li><li>缓存数据需要时间戳和过期标识</li><li>离线签名 + 待发送队列支持延迟广播</li><li>网络恢复后自动同步和广播</li><li>UI 需要清晰的离线状态指示</li></ul>`,71)])])}const u=t(d,[["render",l]]);export{b as __pageData,u as default};
