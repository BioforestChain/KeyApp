const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./web-B0qc0cto.js","./chain-config-CVvvJPxJ.js","./preload-helper-PPVm8Dsz.js","./index-D0E7N0oa.js","./bioforest-ChHUthdw.js","./schemas-34eCiBJ6.js","./iframe-Cdc63axx.js","./iframe-D2OUpJUL.css","./address-format-BmR8oJgW.js","./breakpoint-LJlNYN6X.js"])))=>i.map(i=>d[i]);
import{S as ae,r as ce}from"./iframe-Cdc63axx.js";import{t as xe}from"./web-B0qc0cto.js";import{_ as ue}from"./preload-helper-PPVm8Dsz.js";import{A as We}from"./amount-BQsqQYGO.js";import{d as Ve,f as D,g as Fe,h as ze,w as Ke}from"./chain-config-CVvvJPxJ.js";import{g as le}from"./index-DBrPxRsx.js";import{h as $e,c as Ge,p as Je}from"./bioforest-ChHUthdw.js";import"./index-D0E7N0oa.js";const pe={motion:{timeScale:1,layoutDuration:.45,uiFastDuration:.15,layoutEase:[.4,0,.1,1],spring:{stiffness:220,damping:28,mass:.85}},css:{}};function B(e){return!Number.isFinite(e)||e<=0?1:e}function R(e,t){const n=B(t);return e/n}function se(e,t,n){const s=B(t);return e*Math.pow(s,n)}function Ze(e,t){return t?{motion:{...e.motion,...t.motion??{},spring:{...e.motion.spring,...t.motion?.spring??{}}},css:{...e.css,...t.css??{}}}:e}const ie=new WeakMap,re=new WeakMap;function xn(e){const t=ie.get(e);if(t)return t;const{motion:n}=e,s={type:"spring",stiffness:se(n.spring.stiffness,n.timeScale,2),damping:se(n.spring.damping,n.timeScale,1),mass:n.spring.mass},r={layout:{duration:R(n.layoutDuration,n.timeScale),ease:n.layoutEase}},a={duration:R(n.uiFastDuration,n.timeScale),ease:"easeOut"},c={motionConfig:s,sharedLayout:r,uiFast:a};return ie.set(e,c),c}function Wn(e){const t=re.get(e);if(t)return t;const{motion:n}=e,s={"--miniapp-motion-time-scale":String(B(n.timeScale)),"--miniapp-motion-layout-duration":`${R(n.layoutDuration,n.timeScale)}s`,"--miniapp-motion-ui-fast-duration":`${R(n.uiFastDuration,n.timeScale)}s`,"--miniapp-motion-layout-ease":`cubic-bezier(${n.layoutEase.join(",")})`};return re.set(e,s),s}const Ye=4,H="miniapp-iframe-container",de="miniapp-hidden-container";function q(e,t){let n=document.getElementById(e);return n||(n=document.createElement("div"),n.id=e,t&&(n.style.cssText=`
        position: fixed;
        top: -9999px;
        left: -9999px;
        width: 1px;
        height: 1px;
        overflow: hidden;
        visibility: hidden;
        pointer-events: none;
      `),document.body.appendChild(n)),n}function Qe(e,t,n){const s=document.createElement("iframe");s.id=`miniapp-iframe-${e}`,s.dataset.appId=e;const i=new URL(t,window.location.origin);return n&&Object.entries(n).forEach(([r,a])=>{i.searchParams.set(r,a)}),s.src=i.toString(),s.sandbox.add("allow-scripts","allow-forms","allow-same-origin"),s.style.cssText=`
    width: 100%;
    height: 100%;
    border: none;
    background: transparent;
  `,s}function Xe(e){q(H,!1).appendChild(e)}function et(e){q(de,!0).appendChild(e)}function tt(e){q(H,!1).appendChild(e)}function x(e){e.src="about:blank",e.remove()}function nt(e,t,n=Ye){const s=[],i=Array.from(e.values()).filter(r=>r.appId!==t&&r.state==="background").sort((r,a)=>r.lastActiveAt-a.lastActiveAt);for(;i.length>n;){const r=i.shift();r?.iframeRef&&(x(r.iframeRef),r.iframeRef=null,s.push(r.appId))}return s}function st(){const e=document.getElementById(H),t=document.getElementById(de);e&&(e.innerHTML="",e.remove()),t&&(t.innerHTML="",t.remove())}const Vn={bio_requestAccounts:{id:"bio_requestAccounts",name:"请求账户",description:"获取您的钱包地址列表",risk:"low"},bio_selectAccount:{id:"bio_selectAccount",name:"选择账户",description:"让您选择一个账户",risk:"low"},bio_pickWallet:{id:"bio_pickWallet",name:"选择钱包",description:"让您选择一个钱包",risk:"low"},bio_createTransaction:{id:"bio_createTransaction",name:"创建交易",description:"构造未签名交易（不做签名/不做广播）",risk:"low"},bio_signMessage:{id:"bio_signMessage",name:"签名消息",description:"使用您的私钥签名消息（需要您确认）",risk:"medium"},bio_signTypedData:{id:"bio_signTypedData",name:"签名数据",description:"签名结构化数据（需要您确认）",risk:"medium"},bio_signTransaction:{id:"bio_signTransaction",name:"签名交易",description:"对未签名交易进行签名（需要您确认）",risk:"high"},bio_sendTransaction:{id:"bio_sendTransaction",name:"发送交易",description:"请求发送转账（需要您确认）",risk:"high"}},u={USER_REJECTED:4001,UNAUTHORIZED:4100,UNSUPPORTED_METHOD:4200,INTERNAL_ERROR:-32603,INVALID_PARAMS:-32602,METHOD_NOT_FOUND:-32601};function b(e,t,n,s){return{type:"bio_response",id:e,success:!1,error:{code:t,message:n,data:s}}}function it(e,t){return{type:"bio_response",id:e,success:!0,result:t}}const O=["discover","mine"],fe="ecosystem_store";function rt(){try{const e=localStorage.getItem(fe);if(e){const t=JSON.parse(e),n=Array.isArray(t.availableSubPages)&&t.availableSubPages.length>0?t.availableSubPages:O,s=t.activeSubPage??"discover",i=n.includes(s)?n:[...n,s];return{permissions:t.permissions??[],sources:t.sources??[{url:"./miniapps/ecosystem.json",name:"Bio 官方生态",lastUpdated:new Date().toISOString(),enabled:!0}],availableSubPages:i,activeSubPage:s,swiperProgress:0,syncSource:null}}}catch{}return{permissions:[],sources:[{url:"./miniapps/ecosystem.json",name:"Bio 官方生态",lastUpdated:new Date().toISOString(),enabled:!0}],availableSubPages:O,activeSubPage:"discover",swiperProgress:0,syncSource:null}}function ot(e){try{localStorage.setItem(fe,JSON.stringify(e))}catch{}}const d=new ae(rt());d.subscribe(()=>{ot(d.state)});const ge={getGrantedPermissions:(e,t)=>e.permissions.find(n=>n.appId===t)?.granted??[],hasPermission:(e,t,n)=>ge.getGrantedPermissions(e,t).includes(n),getEnabledSources:e=>e.sources.filter(t=>t.enabled)},at={grantPermissions:(e,t)=>{d.setState(n=>{const s=n.permissions.find(i=>i.appId===e);if(s){const i=[...new Set([...s.granted,...t])];return{...n,permissions:n.permissions.map(r=>r.appId===e?{...r,granted:i,grantedAt:Date.now()}:r)}}else return{...n,permissions:[...n.permissions,{appId:e,granted:t,grantedAt:Date.now()}]}})},revokePermissions:(e,t)=>{d.setState(n=>t?{...n,permissions:n.permissions.map(s=>s.appId===e?{...s,granted:s.granted.filter(i=>!t.includes(i))}:s)}:{...n,permissions:n.permissions.filter(s=>s.appId!==e)})},addSource:(e,t)=>{d.setState(n=>n.sources.some(s=>s.url===e)?n:{...n,sources:[...n.sources,{url:e,name:t,lastUpdated:new Date().toISOString(),enabled:!0}]})},removeSource:e=>{d.setState(t=>({...t,sources:t.sources.filter(n=>n.url!==e)}))},toggleSource:e=>{d.setState(t=>({...t,sources:t.sources.map(n=>n.url===e?{...n,enabled:!n.enabled}:n)}))},updateSourceTimestamp:e=>{d.setState(t=>({...t,sources:t.sources.map(n=>n.url===e?{...n,lastUpdated:new Date().toISOString()}:n)}))},setActiveSubPage:e=>{d.setState(t=>({...t,activeSubPage:e}))},setAvailableSubPages:e=>{d.setState(t=>{const n=e.length>0?e:O,s=n.includes(t.activeSubPage)?t.activeSubPage:n[0]??"mine";return{...t,availableSubPages:n,activeSubPage:s}})},setSwiperProgress:e=>{d.setState(t=>({...t,swiperProgress:e}))},setSyncSource:e=>{d.setState(t=>({...t,syncSource:e}))}},ct=["bio_requestAccounts","bio_signMessage","bio_signTypedData","bio_signTransaction","bio_sendTransaction"];function me(e){return ct.includes(e)}function ut(e,t){return me(t)?ge.hasPermission(d.state,e,t):!0}function lt(e,t){at.grantPermissions(e,t)}class pt{handlers=new Map;iframe=null;appId="";appName="";origin="*";manifestPermissions=[];messageHandler=null;permissionRequestCallback=null;registerHandler(t,n){this.handlers.set(t,n)}setPermissionRequestCallback(t){this.permissionRequestCallback=t}attach(t,n,s,i=[]){this.detach(),this.iframe=t,this.appId=n,this.appName=s,this.manifestPermissions=i;try{const r=new URL(t.src,window.location.origin);this.origin=r.origin}catch{this.origin="*"}this.messageHandler=this.handleMessage.bind(this),window.addEventListener("message",this.messageHandler),console.log("[BioProvider] Attached to iframe:",n)}detach(){this.messageHandler&&(window.removeEventListener("message",this.messageHandler),this.messageHandler=null),this.iframe=null,this.appId="",this.appName="",this.manifestPermissions=[]}emit(t,...n){if(!this.iframe?.contentWindow)return;const s={type:"bio_event",event:t,args:n};this.iframe.contentWindow.postMessage(s,this.origin)}handleMessage(t){if(this.origin!=="*"&&t.origin!==this.origin||t.source!==this.iframe?.contentWindow)return;const n=t.data;!n||n.type!=="bio_request"||this.processRequest(n)}async processRequest(t){const{id:n,method:s,params:i}=t;console.log("[BioProvider] Request:",s,i);const r=this.handlers.get(s);if(!r){this.sendResponse(b(n,u.METHOD_NOT_FOUND,`Method not found: ${s}`));return}if(!["bio_connect","bio_closeSplashScreen"].includes(s)){const f=["bio_accounts","bio_selectAccount","bio_pickWallet"].includes(s)&&this.manifestPermissions.includes("bio_requestAccounts"),l=f?"bio_requestAccounts":s;if(!(this.manifestPermissions.includes(s)||s==="bio_requestAccounts"||f)){this.sendResponse(b(n,u.UNAUTHORIZED,`Permission not declared in manifest: ${s}`));return}if(me(l)&&!ut(this.appId,l)&&!await this.requestPermission([l])){this.sendResponse(b(n,u.USER_REJECTED,"Permission denied by user"));return}}try{const c={appId:this.appId,appName:this.appName,origin:this.origin,permissions:this.manifestPermissions},f=await r(i?.[0],c);this.sendResponse(it(n,f))}catch(c){const f=c instanceof Error?c.message:"Unknown error",l=c.code??u.INTERNAL_ERROR;this.sendResponse(b(n,l,f))}}async requestPermission(t){if(!this.permissionRequestCallback)return console.warn("[BioProvider] No permission request callback set"),!1;try{const n=await this.permissionRequestCallback(this.appId,this.appName,t);return n&&lt(this.appId,t),n}catch(n){return console.error("[BioProvider] Permission request failed:",n),!1}}sendResponse(t){this.iframe?.contentWindow&&(console.log("[BioProvider] Response:",t),this.iframe.contentWindow.postMessage(t,this.origin))}}const p=new pt,m=new Map,S={register(e,t){m.set(e,t),console.log("[HandlerContext] Registered callbacks for:",e)},unregister(e){m.delete(e),console.log("[HandlerContext] Unregistered callbacks for:",e)},get(e){return m.get(e)},has(e){return m.has(e)},getRegisteredApps(){return Array.from(m.keys())},clear(){m.clear()}},dt=async(e,t)=>{Be(t.appId)};let he=null,we=null;function Fn(e){he=e}function zn(e){we=e}function W(e){return S.get(e)?.showWalletPicker??he}function ft(e){return S.get(e)?.getConnectedAccounts??we}const gt=async(e,t)=>({connected:!0}),mt=async(e,t)=>{const n=W(t.appId);if(!n)throw Object.assign(new Error("Wallet picker not available"),{code:u.INTERNAL_ERROR});const s=await n();if(!s)throw Object.assign(new Error("User rejected"),{code:u.USER_REJECTED});return[s]},ht=async(e,t)=>{const n=ft(t.appId);return n?n():[]},wt=async(e,t)=>{const n=W(t.appId);if(!n)throw Object.assign(new Error("Wallet picker not available"),{code:u.INTERNAL_ERROR});const i=await n(e);if(!i)throw Object.assign(new Error("User rejected"),{code:u.USER_REJECTED});return i},At=async(e,t)=>{const n=W(t.appId);if(!n)throw Object.assign(new Error("Wallet picker not available"),{code:u.INTERNAL_ERROR});const i=await n(e);if(!i)throw Object.assign(new Error("User rejected"),{code:u.USER_REJECTED});return i},St=async(e,t)=>"bfmeta",bt=async(e,t)=>{const n=e;if(!n?.address||!n?.chain)throw Object.assign(new Error("Missing address or chain"),{code:u.INVALID_PARAMS});return"0"};let Ae=null;function Kn(e){Ae=e}function Se(e){return S.get(e)?.showSigningDialog??Ae}const Rt=async(e,t)=>{const n=e;if(!n?.message||!n?.address)throw Object.assign(new Error("Missing message or address"),{code:u.INVALID_PARAMS});const s=Se(t.appId);if(!s)throw Object.assign(new Error("Signing dialog not available"),{code:u.INTERNAL_ERROR});const i=await s({message:n.message,address:n.address,app:{name:t.appName}});if(!i)throw Object.assign(new Error("User rejected"),{code:u.USER_REJECTED});return i},_t=async(e,t)=>{const n=e;if(!n?.data||!n?.address)throw Object.assign(new Error("Missing data or address"),{code:u.INVALID_PARAMS});const s=Se(t.appId);if(!s)throw Object.assign(new Error("Signing dialog not available"),{code:u.INTERNAL_ERROR});const i=JSON.stringify(n.data,null,2),r=await s({message:i,address:n.address,app:{name:t.appName}});if(!r)throw Object.assign(new Error("User rejected"),{code:u.USER_REJECTED});return r};let be=null;function $n(e){be=e}function Et(e){return S.get(e)?.showTransferDialog??be}const vt=async(e,t)=>{const n=e;if(!n?.from||!n?.to||!n?.amount||!n?.chain)throw Object.assign(new Error("Missing required parameters: from, to, amount, chain"),{code:u.INVALID_PARAMS});const s=Et(t.appId);if(!s)throw Object.assign(new Error("Transfer dialog not available"),{code:u.INTERNAL_ERROR});const i={from:n.from,to:n.to,amount:n.amount,chain:n.chain,app:{name:t.appName}};n.asset&&(i.asset=n.asset);const r=await s(i);if(!r)throw Object.assign(new Error("User rejected"),{code:u.USER_REJECTED});return r};function Tt(e,t){const n=Ke.state.wallets,s=t.startsWith("0x"),i=s?t.toLowerCase():t;for(const r of n)if(r.chainAddresses.find(c=>c.chain!==e?!1:s||c.address.startsWith("0x")?c.address.toLowerCase()===i:c.address===i))return r.id;return null}async function Re(e){if(D.state.snapshot||await Fe.initialize(),!D.state.snapshot)throw Object.assign(new Error("Chain configs not initialized"),{code:u.INTERNAL_ERROR});const n=ze.getChainById(D.state,e);if(!n)throw Object.assign(new Error(`Unsupported chain: ${e}`),{code:u.INVALID_PARAMS});return n}const yt=async(e,t)=>{const n=e;if(!n?.from||!n?.to||!n?.amount||!n?.chain)throw Object.assign(new Error("Missing required parameters: from, to, amount, chain"),{code:u.INVALID_PARAMS});if(!Tt(n.chain,n.from))throw Object.assign(new Error("From address is not owned by current user"),{code:u.UNAUTHORIZED});const i=await Re(n.chain),r=We.parse(n.amount,i.decimals,i.symbol),a=le(i.id);if(!a.supportsBuildTransaction)throw Object.assign(new Error(`Chain ${i.id} does not support transaction building`),{code:u.UNSUPPORTED_METHOD});const c=await a.buildTransaction({from:n.from,to:n.to,amount:r});return{chainId:c.chainId,data:c.data}};let _e=null;function Gn(e){_e=e}function kt(e){return S.get(e)?.showSignTransactionDialog??_e}const Pt=async(e,t)=>{const n=e;if(!n?.from||!n?.chain||!n?.unsignedTx)throw Object.assign(new Error("Missing required parameters: from, chain, unsignedTx"),{code:u.INVALID_PARAMS});const s=kt(t.appId);if(!s)throw Object.assign(new Error("SignTransaction dialog not available"),{code:u.INTERNAL_ERROR});const i=await s({from:n.from,chain:n.chain,unsignedTx:n.unsignedTx,app:{name:t.appName}});if(!i)throw Object.assign(new Error("User rejected"),{code:u.USER_REJECTED});return i};async function Jn(e){const t=await Re(e.chainId),n=le(t.id);if(!n.supportsSignTransaction)throw Object.assign(new Error(`Chain ${t.id} does not support transaction signing`),{code:u.UNSUPPORTED_METHOD});const s=await(await ue(async()=>{const{walletStorageService:a}=await import("./web-B0qc0cto.js").then(c=>c.i);return{walletStorageService:a}},__vite__mapDeps([0,1,2,3,4,5,6,7,8,9]),import.meta.url)).walletStorageService.getMnemonic(e.walletId,e.password);let i;if(t.chainKind==="evm"){const a=Ve(s,"ethereum",0,0);if(a.address.toLowerCase()!==e.from.toLowerCase())throw Object.assign(new Error("Signing address mismatch"),{code:u.INVALID_PARAMS});i=$e(a.privateKey)}else if(t.chainKind==="bioforest"){const a=Ge(s);if(Je(a.publicKey,t.prefix??"b")!==e.from)throw Object.assign(new Error("Signing address mismatch"),{code:u.INVALID_PARAMS});i=a.secretKey}else throw Object.assign(new Error(`Unsupported chain kind: ${t.chainKind}`),{code:u.UNSUPPORTED_METHOD});const r=await n.signTransaction({chainId:e.unsignedTx.chainId,data:e.unsignedTx.data},i);return{chainId:r.chainId,data:r.data,signature:r.signature}}function Zn(){p.registerHandler("bio_connect",gt),p.registerHandler("bio_closeSplashScreen",dt),p.registerHandler("bio_requestAccounts",mt),p.registerHandler("bio_accounts",ht),p.registerHandler("bio_selectAccount",wt),p.registerHandler("bio_pickWallet",At),p.registerHandler("bio_chainId",St),p.registerHandler("bio_getBalance",bt),p.registerHandler("bio_signMessage",Rt),p.registerHandler("bio_signTypedData",_t),p.registerHandler("bio_createTransaction",yt),p.registerHandler("bio_signTransaction",Pt),p.registerHandler("bio_sendTransaction",vt),console.log("[BioProvider] Initialized with handlers:",["bio_connect","bio_closeSplashScreen","bio_requestAccounts","bio_accounts","bio_selectAccount","bio_pickWallet","bio_chainId","bio_getBalance","bio_signMessage","bio_signTypedData","bio_createTransaction","bio_signTransaction","bio_sendTransaction"])}function V(){return p}const F=new Map,C=new Set;function I(e,t){const n=`${e}:${t}`;return F.get(n)??null}function Ee(e){return C.add(e),()=>C.delete(e)}function ve(){C.forEach(e=>e())}const z=new Map,K=new Map,$=new Map,G=new Map;let Te=null,ye=null;const J=new Map,Z=new Map,w=new Map;function Dt(e,t){z.set(e,t)}function Mt(e,t){K.set(e,t)}function Ot(e){z.delete(e),K.delete(e)}function Y(e){return z.get(e)??null}function Ct(e){return K.get(e)??null}function It(e,t){$.set(e,t)}function Nt(e){$.delete(e)}function Ut(e){return $.get(e)??null}function Lt(e,t){G.set(e,t)}function jt(e){G.delete(e)}function Bt(e){return G.get(e)??null}function Ht(e){Te=e}function qt(){return Te}function xt(e){ye=e}function Wt(){return ye}function ke(e,t){J.set(e,t)}function Pe(e){J.delete(e)}function Q(e){return J.get(e)??null}function De(e){const t=Q(e);if(!t)return null;const n=t.closest(".swiper-slide");if(n&&!n.classList.contains("swiper-slide-active"))return null;const s=t.getBoundingClientRect();return s.width<=0||s.height<=0?null:s}function Vt(e,t){Z.set(e,t)}function Ft(e){Z.delete(e)}function zt(e){return Z.get(e)??null}function Kt(e,t,n){const s=w.get(e)??new Map;s.set(t,n),w.set(e,s);const i=`${e}:${t}`;F.set(i,"ready"),ve()}function $t(e,t){const n=w.get(e);if(!n)return;n.delete(t),n.size===0&&w.delete(e);const s=`${e}:${t}`;F.set(s,"lost"),ve()}function Me(e,t){return w.get(e)?.get(t)??null}function Oe(e,t){const n=Me(e,t);if(!n)return null;const s=n.closest(".swiper-slide");if(s&&!s.classList.contains("swiper-slide-active"))return null;const i=n.getBoundingClientRect();return i.width<=0||i.height<=0?null:i}function Gt(e){ke("stack",e)}function Jt(){Pe("stack")}function Zt(){return Q("stack")}function Yt(){return De("stack")}async function Qt(){return ue(()=>Promise.resolve().then(()=>Cn),void 0,import.meta.url)}function Xt(){ce.useEffect(()=>{Qt().then(({miniappRuntimeStore:e,activateApp:t})=>{const{activeAppId:n}=e.state;n&&t(n)})})}function en(e,t){return ce.useSyncExternalStore(Ee,()=>I(e,t),()=>I(e,t))}const tn={apps:new Map,visualConfig:pe,activeAppId:null,focusedAppId:null,presentations:new Map,zOrderSeed:1,isStackViewOpen:!1,maxBackgroundApps:4};function Ce(e){const t=o.state.apps.get(e),n=t?.iframeRef;!t||!n||V().attach(n,e,t.manifest.name,t.manifest.permissions??[])}function nn(e,t,n){V().attach(t,e,n.name,n.permissions??[])}const o=new ae(tn);function Ie(e){o.setState(t=>({...t,visualConfig:Ze(t.visualConfig,e)}))}function sn(e){Ie({motion:{timeScale:e}})}function rn(){o.setState(e=>({...e,visualConfig:pe}))}const N=new Set;function g(e){N.forEach(t=>t(e))}let oe=0;function Ne(e,t){return oe+=1,{id:`${e}:${t}:${Date.now()}:${oe}`,kind:e,status:"requested",startedAt:Date.now()}}function on(e){const t=e.splashScreen;return t?typeof t=="object"&&typeof t.timeout=="number"?t.timeout:5e3:null}function an(e,t){if(!e||e==="preparing"){if(t==="launching")return"opening";if(t==="splash")return"splash";if(t==="active")return"opened"}return e==="launching"&&t==="splash"?"splash":(e==="launching"||e==="splash")&&t==="active"?"opened":e==="active"&&t==="background"?"backgrounding":e==="background"&&t==="active"?"foregrounding":t==="closing"?"closing":t==="preparing"?"closed":t==="launching"?"opening":t==="splash"?"splash":t==="active"?"opened":t==="background"?"backgrounded":"closed"}function A(e,t){o.setState(n=>{const s=n.apps.get(e);if(!s)return n;const i=an(s.state,t),r=new Map(n.apps);return r.set(e,{...s,state:t,flow:i}),{...n,apps:r}}),g({type:"app:state-change",appId:e,state:t})}function cn(e,t){o.setState(n=>{const s=n.apps.get(e);if(!s||s.processStatus===t)return n;const i=new Map(n.apps);return i.set(e,{...s,processStatus:t}),{...n,apps:i}})}function un(e,t){o.setState(n=>{const s=n.apps.get(e);if(!s||s.readiness===t)return n;const i=new Map(n.apps);return i.set(e,{...s,readiness:t}),{...n,apps:i}})}function Ue(e){un(e,"ready");const t=o.state.apps.get(e);t&&!t.manifest.splashScreen&&(t.state==="launching"||t.state==="splash")&&T(e)}function ln(e){switch(e){case"opening":return"opened";case"backgrounding":return"backgrounded";case"foregrounding":return"opened";default:return e}}function pn(e){o.setState(t=>{const n=t.apps.get(e);if(!n)return t;const s=ln(n.flow);if(s===n.flow)return t;const i=new Map(t.apps);return i.set(e,{...n,flow:s}),{...t,apps:i}})}const dn={launchToSplash:100},_=new Map,U=new Map,L=new Map,fn=3e4,gn=2500,j=new Map;function h(e){const t=j.get(e);t&&(t.cancelled=!0,t.rafId!==null&&cancelAnimationFrame(t.rafId),j.delete(e))}function mn(e){if(!e)return!1;const t=e.getBoundingClientRect();return t.width>0&&t.height>0}function hn(e){return!!e&&e.isConnected}function E(e){const t=U.get(e);t&&(clearTimeout(t),U.delete(e))}function X(e,t,n){o.setState(s=>{const r=s.presentations.get(e)??{appId:e,desktop:t,state:"hidden",zOrder:s.zOrderSeed,transitionId:null,transitionKind:null},a={...r,...n,appId:e,desktop:n.desktop??r.desktop},c=new Map(s.presentations);return c.set(e,a),{...s,presentations:c}})}function Le(e){o.setState(t=>{const n=t.presentations.get(e),s=t.zOrderSeed+1,i=new Map(t.presentations);return n&&i.set(e,{...n,zOrder:s}),{...t,activeAppId:e,focusedAppId:e,presentations:i,zOrderSeed:s}})}function wn(e,t){const n=o.state.presentations.get(e);n&&(n.transitionKind!=="present"||n.transitionId!==t||X(e,n.desktop,{state:"presented",transitionId:null,transitionKind:null}))}function An(e,t){const n=o.state.presentations.get(e);n&&(n.transitionKind!=="dismiss"||n.transitionId!==t||v(e))}function ee(e){E(e),Ue(e),T(e)}function M(e,t){h(e);const n=o.state.apps.get(e);n?.iframeRef&&x(n.iframeRef),o.setState(s=>{const i=new Map(s.apps);i.delete(e);const r=new Map(s.presentations);return r.delete(e),{...s,apps:i,presentations:r,activeAppId:s.activeAppId===e?null:s.activeAppId,focusedAppId:s.focusedAppId===e?null:s.focusedAppId}}),xe.show({message:t,duration:2e3})}function Sn(e,t){if(A(e,"launching"),te(e),t){const n=setTimeout(()=>{const s=o.state.apps.get(e);if(!s||s.state!=="launching")return;A(e,"splash"),E(e);const i=on(s.manifest);i!==null&&U.set(e,setTimeout(()=>{const r=o.state.apps.get(e);r&&r.state==="splash"&&ee(e)},i))},dn.launchToSplash);_.set(e,[n]);return}_.set(e,[])}function bn(e,t,n){h(e);const s={cancelled:!1,rafId:null};j.set(e,s);const i=performance.now(),r=()=>{if(s.cancelled)return;const a=o.state.apps.get(e);if(!a||a.state!=="preparing"){h(e);return}const c=mn(Y(e)),f=!!Oe(t,e),l=hn(a.iframeRef);if(c&&f&&l){h(e),Sn(e,n);return}if(performance.now()-i>gn){f?c?M(e,"启动失败：加载容器未就绪，请重试"):M(e,"启动失败：图标未就绪，请返回桌面重试"):M(e,"启动失败：请停留在目标桌面页后重试");return}s.rafId=requestAnimationFrame(r)};s.rafId=requestAnimationFrame(r)}function te(e){const t=_.get(e);t&&(t.forEach(n=>clearTimeout(n)),_.delete(e))}function je(e){const t=L.get(e);t&&(clearTimeout(t),L.delete(e))}function v(e){te(e),je(e),E(e),h(e),o.setState(t=>{const n=t.apps.get(e);if(!n)return t;n.iframeRef&&x(n.iframeRef);const s=new Map(t.apps);s.delete(e);const i=new Map(t.presentations);return i.delete(e),{...t,apps:s,presentations:i,activeAppId:t.activeAppId===e?null:t.activeAppId,focusedAppId:t.focusedAppId===e?null:t.focusedAppId}}),o.state.apps.size===0&&V().detach()}function Be(e){ee(e)}function He(e,t,n){const i=o.state.apps.get(e);if(i){Ce(e);const l=i.manifest.targetDesktop??"stack";return X(e,l,{state:"presented",transitionId:null,transitionKind:null}),Le(e),T(e),i}const r=!!t.splashScreen,a={appId:e,manifest:t,state:"preparing",flow:"closed",ctx:{capsuleTheme:t.capsuleTheme??"auto"},processStatus:"loading",readiness:"notReady",launchedAt:Date.now(),lastActiveAt:Date.now(),iframeRef:null,iconRef:Y(e)};a.iframeRef=Qe(e,t.url,n),nn(e,a.iframeRef,t),a.iframeRef.addEventListener("load",()=>{cn(e,"loaded"),t.splashScreen||Ue(e)}),Xe(a.iframeRef);const c=t.targetDesktop??"stack",f=Ne("present",e);return o.setState(l=>{const y=l.zOrderSeed+1,k=new Map(l.apps);k.set(e,a);const P=new Map(l.presentations);return P.set(e,{appId:e,desktop:c,state:"presenting",zOrder:y,transitionId:f.id,transitionKind:"present"}),{...l,apps:k,presentations:P,activeAppId:e,focusedAppId:e,zOrderSeed:y}}),g({type:"app:launch",appId:e,manifest:t}),bn(e,c,r),a}function Rn(e,t,n){return He(e,t,n)}function T(e){const t=o.state,n=t.apps.get(e);n&&n.state!=="preparing"&&(t.activeAppId&&t.activeAppId!==e&&qe(t.activeAppId),n.iframeRef&&n.state==="background"&&tt(n.iframeRef),A(e,"active"),Ce(e),o.setState(s=>{const i=new Map(s.apps),r=i.get(e);return r&&i.set(e,{...r,lastActiveAt:Date.now()}),{...s,apps:i,activeAppId:e,focusedAppId:e}}),g({type:"app:activate",appId:e}))}function qe(e){const t=o.state,n=t.apps.get(e);n&&n.state!=="preparing"&&(n.iframeRef&&et(n.iframeRef),A(e,"background"),nt(o.state.apps,o.state.activeAppId,t.maxBackgroundApps),g({type:"app:deactivate",appId:e}))}function ne(e){const n=o.state.apps.get(e);if(!n)return;te(e),je(e),h(e),A(e,"closing"),E(e);const s=n.manifest.targetDesktop??"stack",i=Ne("dismiss",e);X(e,s,{state:"dismissing",transitionId:i.id,transitionKind:"dismiss"}),L.set(e,setTimeout(()=>{const r=o.state.presentations.get(e);r&&(r.transitionKind!=="dismiss"||r.transitionId!==i.id||v(e))},fn)),g({type:"app:close",appId:e})}function _n(e){ne(e)}function En(e,t){const s=o.state.apps.get(e);if(!s)return;const i={...s.ctx,...t};o.setState(r=>{const a=new Map(r.apps),c=a.get(e);return c&&a.set(e,{...c,ctx:i}),{...r,apps:a}}),g({type:"app:ctx-change",appId:e,ctx:i})}function vn(){o.state.apps.forEach((t,n)=>{ne(n),v(n)}),st()}function Tn(){o.setState(e=>({...e,isStackViewOpen:!0})),g({type:"stack-view:open"})}function yn(){o.setState(e=>({...e,isStackViewOpen:!1})),g({type:"stack-view:close"})}function kn(e){return N.add(e),()=>N.delete(e)}function Pn(){return Array.from(o.state.apps.values())}function Dn(){const e=o.state;return e.activeAppId?e.apps.get(e.activeAppId)??null:null}function Mn(){return o.state.apps.size>0}const On={getApps:e=>Array.from(e.apps.values()),getVisualConfig:e=>e.visualConfig,getActiveApp:e=>e.activeAppId?e.apps.get(e.activeAppId)??null:null,getFocusedAppId:e=>e.focusedAppId??e.activeAppId,getFocusedApp:e=>{const t=e.focusedAppId??e.activeAppId;return t?e.apps.get(t)??null:null},getPresentations:e=>Array.from(e.presentations.values()).sort((t,n)=>t.zOrder-n.zOrder),getPresentation:(e,t)=>e.presentations.get(t)??null,hasPresentations:e=>e.presentations.size>0,hasRunningApps:e=>e.apps.size>0,hasRunningStackApps:e=>Array.from(e.apps.values()).some(t=>(t.manifest.targetDesktop??"stack")==="stack"),isStackViewOpen:e=>e.isStackViewOpen,getBackgroundApps:e=>Array.from(e.apps.values()).filter(t=>t.state==="background"),isLaunchOverlayVisible:e=>{const t=e.focusedAppId??e.activeAppId?e.apps.get(e.focusedAppId??e.activeAppId):null;return t?.state==="launching"||t?.state==="splash"},isShowingSplash:e=>(e.focusedAppId??e.activeAppId?e.apps.get(e.focusedAppId??e.activeAppId):null)?.state==="splash",isAnimating:e=>{const t=e.focusedAppId??e.activeAppId?e.apps.get(e.focusedAppId??e.activeAppId):null;return t?.state==="launching"||t?.state==="splash"||t?.state==="closing"}},Cn=Object.freeze(Object.defineProperty({__proto__:null,activateApp:T,closeAllApps:vn,closeApp:ne,closeStackView:yn,deactivateApp:qe,didDismiss:An,didPresent:wn,dismissSplash:Be,finalizeCloseApp:v,getActiveApp:Dn,getDesktopAppSlotRect:Oe,getDesktopAppSlotRef:Me,getDesktopContainerRef:Q,getDesktopGridHostRef:zt,getDesktopRect:De,getIconInnerRef:Ct,getIconRef:Y,getRunningApps:Pn,getSlotStatus:I,getSplashBgRef:Ut,getSplashIconRef:Bt,getStackContainerRef:Zt,getStackRect:Yt,getWindowInnerRef:Wt,getWindowRef:qt,hasRunningApps:Mn,launchApp:He,miniappRuntimeSelectors:On,miniappRuntimeStore:o,openStackView:Tn,registerDesktopAppSlotRef:Kt,registerDesktopContainerRef:ke,registerDesktopGridHostRef:Vt,registerIconInnerRef:Mt,registerIconRef:Dt,registerSplashBgRef:It,registerSplashIconRef:Lt,registerStackContainerRef:Gt,registerWindowInnerRef:xt,registerWindowRef:Ht,requestDismiss:_n,requestDismissSplash:ee,requestFocus:Le,requestPresent:Rn,resetMiniappVisualConfig:rn,setMiniappMotionTimeScale:sn,setMiniappVisualConfig:Ie,settleFlow:pn,subscribe:kn,subscribeSlotStatus:Ee,unregisterDesktopAppSlotRef:$t,unregisterDesktopContainerRef:Pe,unregisterDesktopGridHostRef:Ft,unregisterIconRef:Ot,unregisterSplashBgRef:Nt,unregisterSplashIconRef:jt,unregisterStackContainerRef:Jt,updateAppContext:En,useMiniappVisibilityRestore:Xt,useSlotStatus:en},Symbol.toStringTag,{value:"Module"}));export{ee as A,An as B,Vt as C,pe as D,Ft as E,Kt as F,$t as G,at as H,ge as I,Jn as J,Zn as K,V as L,Fn as M,zn as N,Kn as O,$n as P,Gn as Q,Vn as R,Wn as a,On as b,vn as c,o as d,d as e,ke as f,xn as g,Pe as h,Dt as i,Mt as j,Ot as k,He as l,Ze as m,Gt as n,Tn as o,Jt as p,en as q,rn as r,sn as s,Me as t,Xt as u,wn as v,pn as w,Ht as x,xt as y,_n as z};
