import{r as M,j as F}from"./iframe-CtUqWLzc.js";class j{pool=[];maxSize;constructor(e=4){this.maxSize=e}acquire(e){const a=this.pool.pop();return a?((a.width!==e||a.height!==e)&&(a.width=e,a.height=e),a):new OffscreenCanvas(e,e)}release(e){this.pool.length<this.maxSize&&this.pool.push(e)}clear(){this.pool=[]}get size(){return this.pool.length}}const q=new j,I=new Map,K=50,H=new Map,D=new Set,J=6e4;function G(t){let e=5381;for(let a=0;a<t.length;a++)e=(e<<5)+e^t.charCodeAt(a);return(e>>>0).toString(36)}function U(t){if(!t||t.length===0)return"";const e=JSON.stringify(t.map(a=>({code:a.code,args:a.args})));return G(e)}function Z(t,e,a,n,l,o,d){const r=U(l),i=o?":clip":"",c=d!==void 0?`:tb${d}`:"";return`${t}:${e}:${a}:${n}${r?`:${r}`:""}${i}${c}`}function Q(){if(I.size<K)return;let t=null,e=1/0;for(const[a,n]of I)n.timestamp<e&&(e=n.timestamp,t=a);t&&I.delete(t)}function z(t){return new Promise((e,a)=>{const n=new Image;n.crossOrigin="anonymous",n.onload=()=>e(n),n.onerror=()=>a(new Error(`Failed to load image: ${t}`)),n.src=t})}function ee(t){return new Function("ctx","imageData","size","args",t)}const X=new Map;function te(t){let e=X.get(t);return e||(e=ee(t),X.set(t,e)),e}function ae(t,e,a,n=10){let l=e,o=a,d=0,r=0,i=!1;for(let c=0;c<a;c++)for(let u=0;u<e;u++){const p=(c*e+u)*4;t[p+3]>=n&&(i=!0,l=Math.min(l,u),o=Math.min(o,c),d=Math.max(d,u),r=Math.max(r,c))}return i?{minX:l,minY:o,maxX:d,maxY:r}:null}function $(t,e,a){let n=1,l=0;for(let r=0;r<t.length;r+=4){if(t[r+3]<10)continue;const c=t[r],u=t[r+1],p=t[r+2],h=(.299*c+.587*u+.114*p)/255;n=Math.min(n,h),l=Math.max(l,h)}const o=l-n,d=o>.01;for(let r=0;r<t.length;r+=4){const i=t[r],c=t[r+1],u=t[r+2],p=t[r+3];let h=(.299*i+.587*c+.114*u)/255;d&&(h=(h-n)/o),h=(h-.5)*e+.5,h=Math.max(0,Math.min(1,h)),a&&(h=1-h),t[r]=255,t[r+1]=255,t[r+2]=255,t[r+3]=h*(p/255)*255}}function ne(t,e,a,n,l,o,d){const r=q.acquire(e),i=r.getContext("2d",{willReadFrequently:!0});if(!i)throw q.release(r),new Error("Failed to get 2d context");i.clearRect(0,0,e,e);const c=Math.min(e/t.width,e/t.height)*.85,u=t.width*c,p=t.height*c,h=(e-u)/2,f=(e-p)/2;i.drawImage(t,h,f,u,p);let v=i.getImageData(0,0,e,e),w=v.data;if($(w,n,a),o){const g=ae(w,e,e,20);if(g){const y=Math.max(0,g.minX-1),s=Math.max(0,g.minY-1),m=Math.min(e-y,g.maxX-g.minX+1+2),b=Math.min(e-s,g.maxY-g.minY+1+2),T=(y-h)/c,C=(s-f)/c,P=m/c,A=b/c,Y=Math.max(m,b),B=e/Y*.95,W=m*B,O=b*B,_=(e-W)/2,V=(e-O)/2;i.clearRect(0,0,e,e),i.drawImage(t,T,C,P,A,_,V,W,O),v=i.getImageData(0,0,e,e),w=v.data,$(w,n,a)}}if(d!==void 0){let g=0,k=0;for(let y=0;y<w.length;y+=4){const s=w[y+3];s>=10&&(g+=s/255,k++)}if(k>0){const y=g/k;if(y>.01){const s=d/y;for(let m=0;m<w.length;m+=4){const b=w[m+3];b>=1&&(w[m+3]=Math.min(255,Math.max(0,b*s)))}}}}if(i.putImageData(v,0,0),l&&l.length>0)for(const g of l)try{const k=te(g.code);v=i.getImageData(0,0,e,e),k(i,v,e,g.args)}catch{}const x=document.createElement("canvas");x.width=e,x.height=e;const R=x.getContext("2d");R&&R.drawImage(r,0,0);const S=x.toDataURL("image/png");return q.release(r),S}async function re(t,e={}){const{size:a=64,invert:n=!1,contrast:l=1.5,pipeline:o,clip:d=!0,targetBrightness:r}=e,i=Z(t,a,n,l,o,d,r),c=I.get(i);if(c)return c.timestamp=Date.now(),c.url;const u=H.get(i);if(u)return u;if(D.has(t))return null;const p=(async()=>{try{const h=await z(t),f=ne(h,a,n,l,o,d,r);return Q(),I.set(i,{url:f,timestamp:Date.now()}),f}catch{return D.add(t),setTimeout(()=>D.delete(t),J),null}finally{H.delete(i)}})();return H.set(i,p),p}const se={code:`
    var data = imageData.data;
    var cx = size / 2;
    var cy = size / 2;
    var opacity = (args && args.opacity) || 1;
    
    for (var i = 0; i < data.length; i += 4) {
      var a = data[i + 3];
      if (a < 10) continue;
      
      var px = (i / 4) % size;
      var py = Math.floor((i / 4) / size);
      
      // 计算角度 (0-360)，从顶部开始顺时针
      var angle = Math.atan2(px - cx, cy - py) * 180 / Math.PI + 180;
      
      // HSV to RGB (H = angle, S = 1, V = 1) - 纯正彩虹色
      var h = (angle % 360) / 60;
      var hi = Math.floor(h) % 6;
      var f = h - Math.floor(h);
      var r, g, b;
      
      // 纯彩虹色：S=1, V=1
      switch (hi) {
        case 0: r = 255; g = Math.round(f * 255); b = 0; break;
        case 1: r = Math.round((1 - f) * 255); g = 255; b = 0; break;
        case 2: r = 0; g = 255; b = Math.round(f * 255); break;
        case 3: r = 0; g = Math.round((1 - f) * 255); b = 255; break;
        case 4: r = Math.round(f * 255); g = 0; b = 255; break;
        default: r = 255; g = 0; b = Math.round((1 - f) * 255); break;
      }
      
      data[i] = r;
      data[i + 1] = g;
      data[i + 2] = b;
      data[i + 3] = Math.round(a * opacity);
    }
    
    ctx.putImageData(imageData, 0, 0);
  `,args:{opacity:1}};function ue(t=1){return{...se,args:{opacity:t}}}function de(t,e={}){const{size:a=64,invert:n=!1,contrast:l=1.5,pipeline:o,clip:d,targetBrightness:r}=e,[i,c]=M.useState(null),u=M.useMemo(()=>o?JSON.stringify(o):"",[o]);return M.useEffect(()=>{if(!t){c(null);return}let p=!1;const h=u?JSON.parse(u):void 0,f={size:a,invert:n,contrast:l};return h&&(f.pipeline=h),d&&(f.clip=d),r!==void 0&&(f.targetBrightness=r),re(t,f).then(v=>{p||c(v)}),()=>{p=!0}},[t,a,n,l,u,d,r]),i}class ie{worker=null;ready=!1;pendingRegistrations=[];states=new Map;loadedWatermarks=new Set;rafId=null;triangleMaskBitmap=null;triangleMaskSent=!1;paused=!1;constructor(){typeof window<"u"&&(this.initWorker(),this.loadTriangleMask(),this.initVisibilityListener())}initVisibilityListener(){document.addEventListener("visibilitychange",()=>{document.hidden?this.pause():this.resume()})}pause(){this.paused=!0,this.rafId!==null&&(cancelAnimationFrame(this.rafId),this.rafId=null)}resume(){this.paused=!1,this.states.size>0&&this.scheduleFlush()}async loadTriangleMask(){try{const e=Math.min(3,window.devicePixelRatio||1),n=Math.round(24*e),l=document.createElement("canvas");l.width=n,l.height=n;const o=l.getContext("2d");if(!o)return;o.fillStyle="black",o.beginPath(),o.moveTo(0,n),o.lineTo(n,n),o.lineTo(n,0),o.closePath(),o.fill(),this.triangleMaskBitmap=await createImageBitmap(l),this.sendTriangleMaskIfReady()}catch{}}sendTriangleMaskIfReady(){this.ready&&this.worker&&this.triangleMaskBitmap&&!this.triangleMaskSent&&(this.triangleMaskSent=!0,this.worker.postMessage({type:"setTriangleMask",bitmap:this.triangleMaskBitmap},[this.triangleMaskBitmap]))}initWorker(){try{this.worker=new Worker(new URL(""+new URL("worker-B5CT9vNg.js",import.meta.url).href,import.meta.url),{type:"module"}),this.worker.onmessage=this.handleMessage,this.worker.onerror=e=>{}}catch{}}handleMessage=e=>{if(e.data.type==="ready"){this.ready=!0;for(const a of this.pendingRegistrations)this.worker.postMessage({type:"register",...a},[a.canvas]);this.pendingRegistrations=[],this.sendTriangleMaskIfReady(),this.scheduleFlush()}};register(e,a){if(!this.worker)return()=>{};const n=a.transferControlToOffscreen();return this.ready?this.worker.postMessage({type:"register",cardId:e,canvas:n},[n]):this.pendingRegistrations.push({cardId:e,canvas:n}),()=>this.unregister(e)}unregister(e){this.states.delete(e),this.worker?.postMessage({type:"unregister",cardId:e})}update(e){this.states.set(e.cardId,e),this.scheduleFlush()}loadWatermark(e,a){this.loadedWatermarks.has(e)||(this.loadedWatermarks.add(e),this.worker?.postMessage({type:"loadWatermark",key:e,url:a}))}scheduleFlush(){this.rafId!==null||this.paused||(this.rafId=requestAnimationFrame(()=>{this.rafId=null,this.flush()}))}flush(){!this.ready||this.states.size===0||!this.worker||this.worker.postMessage({type:"update",states:[...this.states.values()]})}}const E=new ie,L=new Map;function oe(t){let e=L.get(t);if(!e){const a=document.createElement("canvas");e={key:t,cardId:t,canvas:a,registered:!1},L.set(t,e)}return e}const N=(t,e,a)=>Math.max(e,Math.min(a,t));function ce({priority:t="high",enabledPattern:e,enabledWatermark:a,mode:n="dynamic",pointerX:l,pointerY:o,active:d,themeHue:r,watermarkMaskUrl:i,watermarkCellSize:c,watermarkIconSize:u,poolKey:p}){const h=M.useId(),f=M.useMemo(()=>!p||typeof document>"u"?null:oe(p),[p]),v=f?.cardId??h,w=M.useRef(null),x=M.useRef(null),R=M.useRef({width:0,height:0,dpr:1}),S=M.useRef(!1),g=M.useRef(!1),k=M.useRef({priority:t,mode:n,pointerX:l,pointerY:o,active:d,themeHue:r,enabledPattern:e,enabledWatermark:a,watermarkMaskUrl:i,watermarkCellSize:c,watermarkIconSize:u});k.current={priority:t,mode:n,pointerX:l,pointerY:o,active:d,themeHue:r,enabledPattern:e,enabledWatermark:a,watermarkMaskUrl:i,watermarkCellSize:c,watermarkIconSize:u};const y=M.useCallback(()=>{queueMicrotask(()=>{if(!g.current)return;const s=k.current,m=s.mode==="static"?{x:0,y:0}:{x:N(s.pointerX,-1,1),y:N(s.pointerY,-1,1)};E.update({cardId:v,priority:s.priority,mode:s.mode,...R.current,pointer:m,active:s.mode==="static"?!1:s.active,themeHue:s.themeHue,enabledPattern:s.enabledPattern,enabledWatermark:s.enabledWatermark,watermarkMaskUrl:s.watermarkMaskUrl,watermarkCellSize:s.watermarkCellSize,watermarkIconSize:s.watermarkIconSize})})},[v]);return M.useEffect(()=>{const s=f?.canvas??w.current;if(s){if(f){if(f.registered){g.current=!0;return}f.registered=!0,g.current=!0,E.register(v,s);return}S.current||(S.current=!0,g.current=!0,E.register(v,s))}},[v,f]),M.useEffect(()=>{if(!f)return;const s=x.current;if(!s)return;const m=f.canvas;return m.className="pointer-events-none absolute inset-0 size-full",m.parentElement!==s&&s.appendChild(m),()=>{m.parentElement===s&&s.removeChild(m)}},[f]),M.useEffect(()=>{const s=f?.canvas.parentElement??w.current?.parentElement;if(!s)return;const m=()=>{const T=s.getBoundingClientRect(),C=Math.min(3,window.devicePixelRatio||1);R.current={width:Math.max(1,Math.round(T.width)),height:Math.max(1,Math.round(T.height)),dpr:C}},b=new ResizeObserver(()=>{m(),y()});return b.observe(s),m(),y(),()=>b.disconnect()},[y]),M.useEffect(()=>{i&&E.loadWatermark(i,i)},[i]),M.useEffect(()=>{y()},[y,t,n,l,o,d,r,e,a,i,c,u]),f?F.jsx("div",{ref:x,className:"pointer-events-none absolute inset-0 size-full","data-testid":"wallet-card-hologram-canvas","data-pattern-enabled":e?"true":"false","data-watermark-enabled":a?"true":"false","data-mode":n,"data-priority":t}):F.jsx("canvas",{ref:w,className:"pointer-events-none absolute inset-0 size-full","data-testid":"wallet-card-hologram-canvas","data-pattern-enabled":e?"true":"false","data-watermark-enabled":a?"true":"false","data-mode":n,"data-priority":t})}ce.__docgenInfo={description:"",methods:[],displayName:"HologramCanvas",props:{priority:{required:!1,tsType:{name:"union",raw:"'high' | 'medium' | 'low'",elements:[{name:"literal",value:"'high'"},{name:"literal",value:"'medium'"},{name:"literal",value:"'low'"}]},description:"",defaultValue:{value:"'high'",computed:!1}},enabledPattern:{required:!0,tsType:{name:"boolean"},description:""},enabledWatermark:{required:!0,tsType:{name:"boolean"},description:""},mode:{required:!1,tsType:{name:"union",raw:"'dynamic' | 'static'",elements:[{name:"literal",value:"'dynamic'"},{name:"literal",value:"'static'"}]},description:"",defaultValue:{value:"'dynamic'",computed:!1}},pointerX:{required:!0,tsType:{name:"number"},description:""},pointerY:{required:!0,tsType:{name:"number"},description:""},active:{required:!0,tsType:{name:"boolean"},description:""},themeHue:{required:!0,tsType:{name:"number"},description:""},watermarkMaskUrl:{required:!1,tsType:{name:"union",raw:"string | null",elements:[{name:"string"},{name:"null"}]},description:""},watermarkCellSize:{required:!1,tsType:{name:"number"},description:""},watermarkIconSize:{required:!1,tsType:{name:"number"},description:""},poolKey:{required:!1,tsType:{name:"string"},description:`Optional pool key to reuse a canvas between mounts.
Use a stable key (e.g. walletId or walletId:slot).`}}};export{ce as H,ue as c,de as u};
