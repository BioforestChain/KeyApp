import{r as p,j as N}from"./iframe-DP2WwkEK.js";class V{pool=[];maxSize;constructor(e=4){this.maxSize=e}acquire(e){const a=this.pool.pop();return a?((a.width!==e||a.height!==e)&&(a.width=e,a.height=e),a):new OffscreenCanvas(e,e)}release(e){this.pool.length<this.maxSize&&this.pool.push(e)}clear(){this.pool=[]}get size(){return this.pool.length}}const T=new V,S=new Map,K=50,C=new Map,E=new Set,j=6e4;function J(t){let e=5381;for(let a=0;a<t.length;a++)e=(e<<5)+e^t.charCodeAt(a);return(e>>>0).toString(36)}function G(t){if(!t||t.length===0)return"";const e=JSON.stringify(t.map(a=>({code:a.code,args:a.args})));return J(e)}function U(t,e,a,n,c,i,h){const s=G(c),r=i?":clip":"",o=h!==void 0?`:tb${h}`:"";return`${t}:${e}:${a}:${n}${s?`:${s}`:""}${r}${o}`}function Z(){if(S.size<K)return;let t=null,e=1/0;for(const[a,n]of S)n.timestamp<e&&(e=n.timestamp,t=a);t&&S.delete(t)}function Q(t){return new Promise((e,a)=>{const n=new Image;n.crossOrigin="anonymous",n.onload=()=>e(n),n.onerror=()=>a(new Error(`Failed to load image: ${t}`)),n.src=t})}function z(t){return new Function("ctx","imageData","size","args",t)}const B=new Map;function ee(t){let e=B.get(t);return e||(e=z(t),B.set(t,e)),e}function te(t,e,a,n=10){let c=e,i=a,h=0,s=0,r=!1;for(let o=0;o<a;o++)for(let u=0;u<e;u++){const f=(o*e+u)*4;t[f+3]>=n&&(r=!0,c=Math.min(c,u),i=Math.min(i,o),h=Math.max(h,u),s=Math.max(s,o))}return r?{minX:c,minY:i,maxX:h,maxY:s}:null}function F(t,e,a){let n=1,c=0;for(let s=0;s<t.length;s+=4){if(t[s+3]<10)continue;const o=t[s],u=t[s+1],f=t[s+2],l=(.299*o+.587*u+.114*f)/255;n=Math.min(n,l),c=Math.max(c,l)}const i=c-n,h=i>.01;for(let s=0;s<t.length;s+=4){const r=t[s],o=t[s+1],u=t[s+2],f=t[s+3];let l=(.299*r+.587*o+.114*u)/255;h&&(l=(l-n)/i),l=(l-.5)*e+.5,l=Math.max(0,Math.min(1,l)),a&&(l=1-l),t[s]=255,t[s+1]=255,t[s+2]=255,t[s+3]=l*(f/255)*255}}function ae(t,e,a,n,c,i,h){const s=T.acquire(e),r=s.getContext("2d",{willReadFrequently:!0});if(!r)throw T.release(s),new Error("Failed to get 2d context");r.clearRect(0,0,e,e);const o=Math.min(e/t.width,e/t.height)*.85,u=t.width*o,f=t.height*o,l=(e-u)/2,g=(e-f)/2;r.drawImage(t,l,g,u,f);let w=r.getImageData(0,0,e,e),M=w.data;if(F(M,n,a),i){const m=te(M,e,e,20);if(m){const y=Math.max(0,m.minX-1),k=Math.max(0,m.minY-1),b=Math.min(e-y,m.maxX-m.minX+1+2),I=Math.min(e-k,m.maxY-m.minY+1+2),X=(y-l)/o,L=(k-g)/o,P=b/o,$=I/o,A=Math.max(b,I),H=e/A*.95,D=b*H,W=I*H,Y=(e-D)/2,_=(e-W)/2;r.clearRect(0,0,e,e),r.drawImage(t,X,L,P,$,Y,_,D,W),w=r.getImageData(0,0,e,e),M=w.data,F(M,n,a)}}if(h!==void 0){let m=0,v=0;for(let y=0;y<M.length;y+=4){const k=M[y+3];k>=10&&(m+=k/255,v++)}if(v>0){const y=m/v;if(y>.01){const k=h/y;for(let b=0;b<M.length;b+=4){const I=M[b+3];I>=1&&(M[b+3]=Math.min(255,Math.max(0,I*k)))}}}}if(r.putImageData(w,0,0),c&&c.length>0)for(const m of c)try{const v=ee(m.code);w=r.getImageData(0,0,e,e),v(r,w,e,m.args)}catch{}const R=document.createElement("canvas");R.width=e,R.height=e;const x=R.getContext("2d");x&&x.drawImage(s,0,0);const d=R.toDataURL("image/png");return T.release(s),d}async function ne(t,e={}){const{size:a=64,invert:n=!1,contrast:c=1.5,pipeline:i,clip:h=!0,targetBrightness:s}=e,r=U(t,a,n,c,i,h,s),o=S.get(r);if(o)return o.timestamp=Date.now(),o.url;const u=C.get(r);if(u)return u;if(E.has(t))return null;const f=(async()=>{try{const l=await Q(t),g=ae(l,a,n,c,i,h,s);return Z(),S.set(r,{url:g,timestamp:Date.now()}),g}catch{return E.add(t),setTimeout(()=>E.delete(t),j),null}finally{C.delete(r)}})();return C.set(r,f),f}const se={code:`
    var data = imageData.data;
    var cx = size / 2;
    var cy = size / 2;
    var opacity = (args && args.opacity) || 1;
    
    for (var i = 0; i < data.length; i += 4) {
      var a = data[i + 3];
      if (a < 10) continue;
      
      var px = (i / 4) % size;
      var py = Math.floor((i / 4) / size);
      
      // 计算角度 (0-360)，从顶部开始顺时针
      var angle = Math.atan2(px - cx, cy - py) * 180 / Math.PI + 180;
      
      // HSV to RGB (H = angle, S = 1, V = 1) - 纯正彩虹色
      var h = (angle % 360) / 60;
      var hi = Math.floor(h) % 6;
      var f = h - Math.floor(h);
      var r, g, b;
      
      // 纯彩虹色：S=1, V=1
      switch (hi) {
        case 0: r = 255; g = Math.round(f * 255); b = 0; break;
        case 1: r = Math.round((1 - f) * 255); g = 255; b = 0; break;
        case 2: r = 0; g = 255; b = Math.round(f * 255); break;
        case 3: r = 0; g = Math.round((1 - f) * 255); b = 255; break;
        case 4: r = Math.round(f * 255); g = 0; b = 255; break;
        default: r = 255; g = 0; b = Math.round((1 - f) * 255); break;
      }
      
      data[i] = r;
      data[i + 1] = g;
      data[i + 2] = b;
      data[i + 3] = Math.round(a * opacity);
    }
    
    ctx.putImageData(imageData, 0, 0);
  `,args:{opacity:1}};function ce(t=1){return{...se,args:{opacity:t}}}function le(t,e={}){const{size:a=64,invert:n=!1,contrast:c=1.5,pipeline:i,clip:h,targetBrightness:s}=e,[r,o]=p.useState(null),u=p.useMemo(()=>i?JSON.stringify(i):"",[i]);return p.useEffect(()=>{if(!t){o(null);return}let f=!1;const l=u?JSON.parse(u):void 0,g={size:a,invert:n,contrast:c};return l&&(g.pipeline=l),h&&(g.clip=h),s!==void 0&&(g.targetBrightness=s),ne(t,g).then(w=>{f||o(w)}),()=>{f=!0}},[t,a,n,c,u,h,s]),r}class re{worker=null;ready=!1;pendingRegistrations=[];states=new Map;loadedWatermarks=new Set;rafId=null;triangleMaskBitmap=null;triangleMaskSent=!1;paused=!1;constructor(){typeof window<"u"&&(this.initWorker(),this.loadTriangleMask(),this.initVisibilityListener())}initVisibilityListener(){document.addEventListener("visibilitychange",()=>{document.hidden?this.pause():this.resume()})}pause(){this.paused=!0,this.rafId!==null&&(cancelAnimationFrame(this.rafId),this.rafId=null)}resume(){this.paused=!1,this.states.size>0&&this.scheduleFlush()}async loadTriangleMask(){try{const e=Math.min(3,window.devicePixelRatio||1),n=Math.round(24*e),c=document.createElement("canvas");c.width=n,c.height=n;const i=c.getContext("2d");if(!i)return;i.fillStyle="black",i.beginPath(),i.moveTo(0,n),i.lineTo(n,n),i.lineTo(n,0),i.closePath(),i.fill(),this.triangleMaskBitmap=await createImageBitmap(c),this.sendTriangleMaskIfReady()}catch{}}sendTriangleMaskIfReady(){this.ready&&this.worker&&this.triangleMaskBitmap&&!this.triangleMaskSent&&(this.triangleMaskSent=!0,this.worker.postMessage({type:"setTriangleMask",bitmap:this.triangleMaskBitmap},[this.triangleMaskBitmap]))}initWorker(){try{this.worker=new Worker(new URL(""+new URL("worker-B5CT9vNg.js",import.meta.url).href,import.meta.url),{type:"module"}),this.worker.onmessage=this.handleMessage,this.worker.onerror=e=>{}}catch{}}handleMessage=e=>{if(e.data.type==="ready"){this.ready=!0;for(const a of this.pendingRegistrations)this.worker.postMessage({type:"register",...a},[a.canvas]);this.pendingRegistrations=[],this.sendTriangleMaskIfReady(),this.scheduleFlush()}};register(e,a){if(!this.worker)return()=>{};const n=a.transferControlToOffscreen();return this.ready?this.worker.postMessage({type:"register",cardId:e,canvas:n},[n]):this.pendingRegistrations.push({cardId:e,canvas:n}),()=>this.unregister(e)}unregister(e){this.states.delete(e),this.worker?.postMessage({type:"unregister",cardId:e})}update(e){this.states.set(e.cardId,e),this.scheduleFlush()}loadWatermark(e,a){this.loadedWatermarks.has(e)||(this.loadedWatermarks.add(e),this.worker?.postMessage({type:"loadWatermark",key:e,url:a}))}scheduleFlush(){this.rafId!==null||this.paused||(this.rafId=requestAnimationFrame(()=>{this.rafId=null,this.flush()}))}flush(){!this.ready||this.states.size===0||!this.worker||this.worker.postMessage({type:"update",states:[...this.states.values()]})}}const q=new re,O=(t,e,a)=>Math.max(e,Math.min(a,t));function ie({priority:t="high",enabledPattern:e,enabledWatermark:a,mode:n="dynamic",pointerX:c,pointerY:i,active:h,themeHue:s,watermarkMaskUrl:r,watermarkCellSize:o,watermarkIconSize:u}){const f=p.useId(),l=p.useRef(null),g=p.useRef({width:0,height:0,dpr:1}),w=p.useRef(!1),M=p.useRef(!1),R=p.useRef({priority:t,mode:n,pointerX:c,pointerY:i,active:h,themeHue:s,enabledPattern:e,enabledWatermark:a,watermarkMaskUrl:r,watermarkCellSize:o,watermarkIconSize:u});R.current={priority:t,mode:n,pointerX:c,pointerY:i,active:h,themeHue:s,enabledPattern:e,enabledWatermark:a,watermarkMaskUrl:r,watermarkCellSize:o,watermarkIconSize:u};const x=p.useCallback(()=>{queueMicrotask(()=>{if(!M.current)return;const d=R.current,m=d.mode==="static"?{x:0,y:0}:{x:O(d.pointerX,-1,1),y:O(d.pointerY,-1,1)};q.update({cardId:f,priority:d.priority,mode:d.mode,...g.current,pointer:m,active:d.mode==="static"?!1:d.active,themeHue:d.themeHue,enabledPattern:d.enabledPattern,enabledWatermark:d.enabledWatermark,watermarkMaskUrl:d.watermarkMaskUrl,watermarkCellSize:d.watermarkCellSize,watermarkIconSize:d.watermarkIconSize})})},[f]);return p.useEffect(()=>{const d=l.current;!d||w.current||(w.current=!0,M.current=!0,q.register(f,d))},[f]),p.useEffect(()=>{const d=l.current?.parentElement;if(!d)return;const m=()=>{const y=d.getBoundingClientRect(),k=Math.min(3,window.devicePixelRatio||1);g.current={width:Math.max(1,Math.round(y.width)),height:Math.max(1,Math.round(y.height)),dpr:k}},v=new ResizeObserver(()=>{m(),x()});return v.observe(d),m(),x(),()=>v.disconnect()},[x]),p.useEffect(()=>{r&&q.loadWatermark(r,r)},[r]),p.useEffect(()=>{x()},[x,t,n,c,i,h,s,e,a,r,o,u]),N.jsx("canvas",{ref:l,className:"pointer-events-none absolute inset-0 size-full","data-testid":"wallet-card-hologram-canvas","data-pattern-enabled":e?"true":"false","data-watermark-enabled":a?"true":"false","data-mode":n,"data-priority":t})}ie.__docgenInfo={description:"",methods:[],displayName:"HologramCanvas",props:{priority:{required:!1,tsType:{name:"union",raw:"'high' | 'medium' | 'low'",elements:[{name:"literal",value:"'high'"},{name:"literal",value:"'medium'"},{name:"literal",value:"'low'"}]},description:"",defaultValue:{value:"'high'",computed:!1}},enabledPattern:{required:!0,tsType:{name:"boolean"},description:""},enabledWatermark:{required:!0,tsType:{name:"boolean"},description:""},mode:{required:!1,tsType:{name:"union",raw:"'dynamic' | 'static'",elements:[{name:"literal",value:"'dynamic'"},{name:"literal",value:"'static'"}]},description:"",defaultValue:{value:"'dynamic'",computed:!1}},pointerX:{required:!0,tsType:{name:"number"},description:""},pointerY:{required:!0,tsType:{name:"number"},description:""},active:{required:!0,tsType:{name:"boolean"},description:""},themeHue:{required:!0,tsType:{name:"number"},description:""},watermarkMaskUrl:{required:!1,tsType:{name:"union",raw:"string | null",elements:[{name:"string"},{name:"null"}]},description:""},watermarkCellSize:{required:!1,tsType:{name:"number"},description:""},watermarkIconSize:{required:!1,tsType:{name:"number"},description:""}}};export{ie as H,ce as c,le as u};
