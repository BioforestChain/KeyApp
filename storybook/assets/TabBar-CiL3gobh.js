import{u as b,q as T,r as l,j as p}from"./iframe-Cr_UN5ps.js";import{c as E}from"./utils-4perknFd.js";import{S as U,a as q}from"./swiper-DUMS8xXX.js";import{u as G,C as V}from"./swiper-sync-context-BOMM0CvE.js";import{e as P,b as M,d as _,o as X}from"./index-CqAM5tj-.js";import{p as h,n as $,g as J}from"./notification-ClBTXteW.js";import{g as K,b as j}from"./index-C0kkUY8Z.js";import{e as k,w as C}from"./user-profile-BBxMf48y.js";import{b as O,u as Q}from"./index-COveLHHP.js";import{u as Z}from"./useTranslation-CFi8Ka59.js";import{c as ee}from"./createReactComponent-T6tanagy.js";import{I as W}from"./ecosystem-desktop-D0E0W658.js";import{I as Y}from"./IconApps-9d_8kao3.js";import{I as te}from"./IconWallet-Di-VCkJP.js";import{I as se}from"./IconSettings-FYjecSAc.js";const ae=[["path",{d:"M19 4a3 3 0 0 1 3 3v10a3 3 0 0 1 -3 3h-14a3 3 0 0 1 -3 -3v-10a3 3 0 0 1 3 -3zm-12.99 3l-.127 .007a1 1 0 0 0 .117 1.993l.127 -.007a1 1 0 0 0 -.117 -1.993zm3 0l-.127 .007a1 1 0 0 0 .117 1.993l.127 -.007a1 1 0 0 0 -.117 -1.993z",key:"svg-0"}]],z=ee("filled","app-window-filled","AppWindowFilled",ae);function ve(){return b(C,a=>a.wallets)}function ne(){return b(C,a=>k.getCurrentWallet(a))}function Ae(){return b(C,a=>a.selectedChain)}function Ne(){return b(C,a=>a.chainPreferences)}function Re(){return b(C,a=>k.getCurrentChainAddress(a))}function Pe(){return b(C,a=>k.hasWallet(a))}function ke(){return b(C,a=>a.isInitialized)}const A={MAX_AUTO_RETRY:3,RETRY_INTERVAL:5e3,SYNC_INTERVAL:15e3,CONFIRM_TIMEOUT:300*1e3,CLEANUP_MAX_AGE:1440*60*1e3};class ie{state={isRunning:!1,syncTimer:null,subscribers:new Set};start(){this.state.isRunning||(this.state.isRunning=!0,this.state.syncTimer=setInterval(()=>{this.syncAllPendingTransactions()},A.SYNC_INTERVAL),this.syncAllPendingTransactions())}stop(){this.state.isRunning&&(this.state.isRunning=!1,this.state.syncTimer&&(clearInterval(this.state.syncTimer),this.state.syncTimer=null))}subscribe(e){return this.state.subscribers.add(e),()=>{this.state.subscribers.delete(e)}}notifySubscribers(e){this.state.subscribers.forEach(r=>{try{r(e)}catch{}})}async syncAllPendingTransactions(){}async syncWalletPendingTransactions(e,r){try{await h.deleteExpired({walletId:e,maxAge:A.CLEANUP_MAX_AGE})>0;const d=await h.getPending({walletId:e});for(const o of d)await this.processPendingTransaction(o,r)}catch{}}async processPendingTransaction(e,r){switch(e.status){case"created":await this.tryBroadcast(e,r);break;case"failed":e.retryCount<A.MAX_AUTO_RETRY&&await this.tryBroadcast(e,r);break;case"broadcasted":await this.checkConfirmation(e,r);break;case"broadcasting":if(Date.now()-e.updatedAt>3e4){const d=await h.updateStatus({id:e.id,status:"failed",errorMessage:T.t("transaction:broadcast.timeout")});this.notifySubscribers(d)}break}}async tryBroadcast(e,r){if(!O.getChainById(r,e.chainId))return;const o=K(e.chainId)?.broadcastTransaction;if(o)try{await h.updateStatus({id:e.id,status:"broadcasting"}),await h.incrementRetry({id:e.id});const s=await o(e.rawTx),c=await h.updateStatus({id:e.id,status:"broadcasted",txHash:s});this.notifySubscribers(c),this.sendNotification(c,"broadcasted")}catch(s){const c=s instanceof j||s instanceof Error?s.message:T.t("transaction:broadcast.failed"),u=s instanceof j?s.code:void 0,g=await h.updateStatus({id:e.id,status:"failed",errorCode:u,errorMessage:c});this.notifySubscribers(g),this.sendNotification(g,"failed")}}async checkConfirmation(e,r){if(!e.txHash)return;const t=O.getChainById(r,e.chainId);if(!t)return;const o=t.apis?.find(s=>s.type==="biowallet-v1")?.endpoint;if(o)try{const s=`${o}/transactions/query`,c={signature:e.txHash,page:1,pageSize:1,maxHeight:Number.MAX_SAFE_INTEGER},u=await fetch(s,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(c)});if(!u.ok)throw new Error(`HTTP ${u.status}`);const g=await u.json();if(g.success&&g.result&&g.result.count>0){const f=await h.updateStatus({id:e.id,status:"confirmed"});this.notifySubscribers(f),this.sendNotification(f,"confirmed"),this.sendNotification(f,"confirmed")}else Date.now()-e.updatedAt>A.CONFIRM_TIMEOUT}catch{}}async retryBroadcast(e,r){const t=await h.getById({id:e});return t?(await this.tryBroadcast(t,r),h.getById({id:e})):null}sendNotification(e,r){const t=e.meta?.displayAmount??"",d=e.meta?.displaySymbol??"",o=e.meta?.type??"transfer";let s,c,u;switch(r){case"broadcasted":s=T.t("notification:pendingTx.broadcasted.title"),c=t?T.t("notification:pendingTx.broadcasted.message",{type:o,amount:t,symbol:d}):T.t("notification:pendingTx.broadcasted.messageSimple"),u="pending";break;case"confirmed":s=T.t("notification:pendingTx.confirmed.title"),c=t?T.t("notification:pendingTx.confirmed.message",{type:o,amount:t,symbol:d}):T.t("notification:pendingTx.confirmed.messageSimple"),u="success";break;case"failed":s=T.t("notification:pendingTx.failed.title"),c=e.errorMessage??T.t("notification:pendingTx.failed.message"),u="failed";break}$.add({type:"transaction",title:s,message:c,data:{txHash:e.txHash,walletId:e.walletId,status:u,pendingTxId:e.id}})}}const re=new ie;function oe(a,e){const r=Q(),t=l.useMemo(()=>!a||!e?null:J(e,a),[a,e]),[d,o]=l.useState([]),[s,c]=l.useState(!1);l.useEffect(()=>{if(!t){o([]),c(!1);return}return c(!0),t.fetch({}).then(n=>{o(n),c(!1)}).catch(()=>{c(!1)}),t.subscribe({},n=>{o(n)})},[t]);const u=l.useCallback(async y=>{await h.delete({id:y.id}),o(n=>n.filter(m=>m.id!==y.id))},[]),g=l.useCallback(async y=>await re.retryBroadcast(y.id,r),[r]),f=l.useCallback(async()=>{const y=d.filter(n=>n.status==="failed");for(const n of y)await h.delete({id:n.id})},[d]);return{transactions:d,isLoading:s,deleteTransaction:u,retryTransaction:g,clearAllFailed:f}}const B=["discover","mine","stack"],ce={discover:Y,mine:W,stack:z};function de(a,e){const t=a.length-1,d=l.useRef(null),o=l.useMemo(()=>{const n=P.state.activeSubPage,m=a.indexOf(n);return m>=0?m:0},[a]),{onSwiper:s,onSlideChange:c}=G("ecosystem-indicator","ecosystem-main",{initialIndex:o});l.useEffect(()=>{d.current&&(d.current.allowTouchMove=e)},[e]);const[u,g]=l.useState(0),f=t>0?u*t:0,y=n=>{const m=Math.abs(f-n);return Math.max(0,1-m)};return{icon:p.jsx(U,{className:"-my-2.5 !h-10 !w-15",modules:[V],onSwiper:n=>{d.current=n,s(n)},onSlideChange:c,onProgress:(n,m)=>g(m),slidesPerView:"auto",centeredSlides:!0,spaceBetween:8,allowTouchMove:e,resistance:!0,resistanceRatio:.5,children:a.map((n,m)=>{const I=ce[n],N=y(m);return p.jsx(q,{className:"!flex !w-5 cursor-pointer !items-center !justify-center",children:p.jsx(I,{className:E("size-5 transition-opacity duration-100",e?"text-primary":"text-muted-foreground"),style:{opacity:N},stroke:1.5})},n)})}),label:p.jsx("div",{className:"flex h-4 items-center justify-center gap-1",children:a.map((n,m)=>{const I=Math.round(f)===m;return p.jsx("span",{className:E("size-1 rounded-full transition-all duration-200",I?"bg-primary scale-125":"bg-muted-foreground/40")},n)})})}}function le({activeTab:a,onTabChange:e,className:r}){const{t}=Z("common"),d=b(P,i=>i.activeSubPage),o=b(P,i=>i.availableSubPages),s=b(_,i=>M.getApps(i).length>0),c=b(_,M.hasRunningStackApps),u=ne(),{transactions:g}=oe(u?.id),f=g.filter(i=>i.status!=="confirmed").length,y=a==="ecosystem",n=l.useMemo(()=>o?.length?o:c?B:B.filter(i=>i!=="stack"),[o,c]),m=de(n,y),I=l.useMemo(()=>d==="stack"||s?z:d==="mine"?W:Y,[d,s]),N=l.useMemo(()=>[{id:"wallet",label:t("a11y.tabWallet"),icon:te},{id:"ecosystem",label:t("a11y.tabEcosystem"),icon:I},{id:"settings",label:t("a11y.tabSettings"),icon:se}],[t,I]),R=l.useRef({startY:0,startTime:0}),H=30,L=.3,D=l.useCallback(i=>{const S=i.touches[0];S&&(R.current={startY:S.clientY,startTime:Date.now()})},[]),F=l.useCallback(i=>{const S=i.changedTouches[0];if(!S)return;const w=R.current.startY-S.clientY,v=Date.now()-R.current.startTime,x=w/v;s&&(w>H||x>L)&&(i.preventDefault(),X())},[s]);return p.jsx("div",{"data-testid":"tab-bar",className:E("fixed right-0 bottom-0 left-0 z-50","bg-background/80 supports-[backdrop-filter]:bg-background/60 border-t backdrop-blur-xl","pb-[env(safe-area-inset-bottom)]",r),style:{height:"var(--tab-bar-height)"},children:p.jsx("div",{className:"mx-auto flex h-[52px] max-w-md",children:N.map(i=>{const S=i.icon,w=a===i.id,v=i.label,x=i.id==="ecosystem";return p.jsxs("button",{onClick:()=>e(i.id),onTouchStart:x?D:void 0,onTouchEnd:x?F:void 0,"data-testid":`tab-${i.id}`,className:E("flex flex-1 flex-col items-center justify-center gap-1 transition-colors",w?"text-primary":"text-muted-foreground"),"aria-label":v,"aria-current":w?"page":void 0,children:[p.jsxs("div",{className:"relative",children:[x?m.icon:p.jsx(S,{className:E("size-5",w&&"text-primary"),stroke:1.5}),x&&s&&!w&&p.jsx("span",{className:"bg-primary absolute -top-0.5 -right-0.5 size-2 rounded-full"}),i.id==="wallet"&&f>0&&p.jsx("span",{className:"bg-destructive text-destructive-foreground absolute -top-1 -right-2 flex min-w-4 items-center justify-center rounded-full px-1 text-[10px] font-medium",children:f>9?"9+":f})]}),x&&w?m.label:p.jsx("span",{className:"text-xs font-medium",children:v})]},i.id)})})})}le.__docgenInfo={description:"",methods:[],displayName:"TabBar",props:{activeTab:{required:!0,tsType:{name:"union",raw:"'wallet' | 'ecosystem' | 'settings'",elements:[{name:"literal",value:"'wallet'"},{name:"literal",value:"'ecosystem'"},{name:"literal",value:"'settings'"}]},description:""},onTabChange:{required:!0,tsType:{name:"signature",type:"function",raw:"(tab: TabId) => void",signature:{arguments:[{type:{name:"union",raw:"'wallet' | 'ecosystem' | 'settings'",elements:[{name:"literal",value:"'wallet'"},{name:"literal",value:"'ecosystem'"},{name:"literal",value:"'settings'"}]},name:"tab"}],return:{name:"void"}}},description:""},className:{required:!1,tsType:{name:"string"},description:""}}};export{le as T,Pe as a,ve as b,ne as c,Ae as d,Ne as e,oe as f,Re as g,re as p,ke as u};
