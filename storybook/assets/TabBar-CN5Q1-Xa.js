import{u as x,v,r as f,j as g}from"./iframe-BR45iAMW.js";import{c as R}from"./utils-4perknFd.js";import{S as Q,a as Z}from"./swiper-svLbWJk-.js";import{u as ee,C as te}from"./swiper-sync-context-Dx4tcYOR.js";import{e as F,b as U,d as j,o as se,f as ne,h as ae}from"./index-Dnu79LT_.js";import{p,n as ie,g as re,b as oe}from"./notification-BdHiFbVv.js";import{g as ce,C as $,r as V,l as le,f as _,h as de,p as ue,j as fe}from"./index-DAr2LevI.js";import{e as H,w as N}from"./user-profile-m_4h1kNV.js";import{b as me,u as pe}from"./service-BG9WHSO3.js";import{I as G,H as ge}from"./ecosystem-desktop-BnRS36K5.js";import"./window-stack-BPi_p-h9.js";import{u as ye}from"./useTranslation-UW7x6zxI.js";import{c as K}from"./createReactComponent-Cr_JlDar.js";import{I as X}from"./IconApps-CMA5qy0e.js";import{I as he}from"./IconWallet-D34Kdag-.js";import{I as be}from"./IconSettings-Cop-RZ7G.js";const we=[["path",{d:"M12 12m-1 0a1 1 0 1 0 2 0a1 1 0 1 0 -2 0",key:"svg-0"}],["path",{d:"M12 12m-9 0a9 9 0 1 0 18 0a9 9 0 1 0 -18 0",key:"svg-1"}]],q=K("outline","circle-dot","CircleDot",we);const Te=[["path",{d:"M19 4a3 3 0 0 1 3 3v10a3 3 0 0 1 -3 3h-14a3 3 0 0 1 -3 -3v-10a3 3 0 0 1 3 -3zm-12.99 3l-.127 .007a1 1 0 0 0 .117 1.993l.127 -.007a1 1 0 0 0 -.117 -1.993zm3 0l-.127 .007a1 1 0 0 0 .117 1.993l.127 -.007a1 1 0 0 0 -.117 -1.993z",key:"svg-0"}]],J=K("filled","app-window-filled","AppWindowFilled",Te);function Ye(){return x(N,n=>n.wallets)}function xe(){return x(N,n=>H.getCurrentWallet(n))}function Se(){return x(N,n=>n.selectedChain)}function Ge(){return x(N,n=>n.chainPreferences)}function Ae(){return x(N,n=>H.getCurrentChainAddress(n))}function Ke(){return x(N,n=>H.hasWallet(n))}function Xe(){return x(N,n=>n.isInitialized)}const W={MAX_AUTO_RETRY:3,RETRY_INTERVAL:5e3,SYNC_INTERVAL:15e3,CONFIRM_TIMEOUT:300*1e3,CLEANUP_MAX_AGE:1440*60*1e3};class Ce{state={isRunning:!1,syncTimer:null,subscribers:new Set};start(){this.state.isRunning||(this.state.isRunning=!0,this.state.syncTimer=setInterval(()=>{this.syncAllPendingTransactions()},W.SYNC_INTERVAL),this.syncAllPendingTransactions())}stop(){this.state.isRunning&&(this.state.isRunning=!1,this.state.syncTimer&&(clearInterval(this.state.syncTimer),this.state.syncTimer=null))}subscribe(e){return this.state.subscribers.add(e),()=>{this.state.subscribers.delete(e)}}notifySubscribers(e){this.state.subscribers.forEach(o=>{try{o(e)}catch{}})}async syncAllPendingTransactions(){}async syncWalletPendingTransactions(e,o){try{await p.deleteExpired({walletId:e,maxAge:W.CLEANUP_MAX_AGE})>0;const c=await p.getPending({walletId:e});for(const a of c)await this.processPendingTransaction(a,o)}catch{}}async processPendingTransaction(e,o){switch(e.status){case"created":await this.tryBroadcast(e,o);break;case"failed":e.retryCount<W.MAX_AUTO_RETRY&&await this.tryBroadcast(e,o);break;case"broadcasted":break;case"broadcasting":if(Date.now()-e.updatedAt>3e4){const c=await p.updateStatus({id:e.id,status:"failed",errorMessage:v.t("transaction:broadcast.timeout")});this.notifySubscribers(c)}break}}async tryBroadcast(e,o){if(!me.getChainById(o,e.chainId))return;const a=ce(e.chainId)?.broadcastTransaction;if(a)try{await p.updateStatus({id:e.id,status:"broadcasting"}),await p.incrementRetry({id:e.id});const s=await a(e.rawTx),l=await p.updateStatus({id:e.id,status:"broadcasted",txHash:s});this.notifySubscribers(l),this.sendNotification(l,"broadcasted")}catch(s){const l=s instanceof $||s instanceof Error?s.message:v.t("transaction:broadcast.failed"),h=s instanceof $?s.code:void 0,C=await p.updateStatus({id:e.id,status:"failed",errorCode:h,errorMessage:l});this.notifySubscribers(C),this.sendNotification(C,"failed")}}async retryBroadcast(e,o){const r=await p.getById({id:e});return r?(await this.tryBroadcast(r,o),p.getById({id:e})):null}sendNotification(e,o){const r=e.meta?.displayAmount??"",c=e.meta?.displaySymbol??"",a=e.meta?.type??"transfer";let s,l,h;switch(o){case"broadcasted":s=v.t("notification:pendingTx.broadcasted.title"),l=r?v.t("notification:pendingTx.broadcasted.message",{type:a,amount:r,symbol:c}):v.t("notification:pendingTx.broadcasted.messageSimple"),h="pending";break;case"confirmed":s=v.t("notification:pendingTx.confirmed.title"),l=r?v.t("notification:pendingTx.confirmed.message",{type:a,amount:r,symbol:c}):v.t("notification:pendingTx.confirmed.messageSimple"),h="success";break;case"failed":s=v.t("notification:pendingTx.failed.title"),l=e.errorMessage??v.t("notification:pendingTx.failed.message"),h="failed";break}ie.add({type:"transaction",title:s,message:l,data:{txHash:e.txHash,walletId:e.walletId,status:h,pendingTxId:e.id}})}}const B=new Ce;function z(...n){const e=`[chain-effect] pending-tx ${n.join(" ")}`;le(e,{args:n})}function ve(n,e,o,r){const c=pe(),a=e&&o?re(e,o):n,s=n&&n!==a?n:void 0,l=f.useMemo(()=>{if(!r?.length)return[];const i=new Set;for(const u of r)u?.hash&&i.add(u.hash.toLowerCase());return Array.from(i).toSorted()},[r]),h=f.useMemo(()=>l.join("|"),[l]),[C,w]=f.useState([]),[k,P]=f.useState(!1),S=f.useCallback(async()=>{if(!a)return[];const i=new Set([a]);s&&i.add(s);const u=await Promise.all(Array.from(i).map(t=>p.getPending({walletId:t}))),A=new Map;for(const t of u)for(const d of t)A.set(d.id,d);const b=Array.from(A.values()).toSorted((t,d)=>d.createdAt-t.createdAt);return z("snapshot",a??"none",`len=${b.length}`),b},[a,s]);f.useEffect(()=>{if(!a){w([]),P(!1);return}let i=!0;if(P(!0),(async()=>{try{const t=await S();if(!i)return;w(t)}finally{i&&P(!1)}})(),(async()=>{e&&o&&await p.normalizeWalletKeyByAddress({chainId:e,address:o,walletId:a}),await p.deleteConfirmed({walletId:a}),s&&await p.deleteConfirmed({walletId:s});const t=await S();i&&w(t)})().catch(()=>{}),!e)return()=>{i=!1};const A=oe(e,a,s);if(!A)return()=>{i=!1};let b;return V(A).then(t=>{const d=()=>{const y=_(t.changes.pipe(de(E=>ue(async()=>{if(!i)return;z("changes",a??"none",`len=${E.length}`);const M=await S();i&&w(M)}))));b=()=>{_(fe(y)),_(t.stop)}};V(t.refresh).then(async y=>{if(!i)return;z("refresh",a??"none",`len=${y.length}`);const E=await S();i&&w(E)}).finally(()=>{i&&d()})}).catch(()=>{}),()=>{i=!1,b?.()}},[a,e,o,s,S]),f.useEffect(()=>{a&&(B.syncWalletPendingTransactions(a,c),s&&B.syncWalletPendingTransactions(s,c))},[a,s,c]),f.useEffect(()=>{!a||l.length===0||(async()=>(await p.deleteByTxHash({walletId:a,txHashes:l}),s&&await p.deleteByTxHash({walletId:s,txHashes:l})))()},[a,s,h,l]),f.useEffect(()=>a?p.subscribe((u,A)=>{if(!(u.walletId!==a&&u.walletId!==s))if(A==="created"){if(u.status==="confirmed")return;w(b=>{const t=new Map;for(const d of b)t.set(d.id,d);return t.set(u.id,u),Array.from(t.values()).toSorted((d,y)=>y.createdAt-d.createdAt)})}else A==="updated"?w(b=>{if(u.status==="confirmed")return b.filter(d=>d.id!==u.id);const t=new Map;for(const d of b)t.set(d.id,d);return t.set(u.id,u),Array.from(t.values()).toSorted((d,y)=>y.createdAt-d.createdAt)}):A==="deleted"&&w(b=>b.filter(t=>t.id!==u.id))}):void 0,[a,s]);const m=f.useCallback(async i=>{await p.delete({id:i.id})},[]),T=f.useCallback(async i=>await B.retryBroadcast(i.id,c),[c]),I=f.useCallback(async()=>{const i=C.filter(u=>u.status==="failed");await Promise.all(i.map(u=>p.delete({id:u.id})))},[C]);return{transactions:C,isLoading:k,deleteTransaction:m,retryTransaction:T,clearAllFailed:I}}function O(n){return!Number.isFinite(n)||n<=0?0:n>=1?1:n}function Ie(n){const{progress:e,pageCount:o,index:r}=n;if(o<=1)return 1;const c=o-1,a=O(e)*c,l=1-Math.abs(a-r);return Number.isFinite(l)?Math.max(0,Math.min(1,l)):0}const Y=["discover","mine","stack"],Pe={discover:X,mine:G,stack:J};function Ee(n,e,o){const r=n.length,c=f.useRef(null),a=f.useMemo(()=>{const m=F.state.activeSubPage,T=n.indexOf(m);return T>=0?T:0},[n]),{onSwiper:s,onSlideChange:l}=ee("ecosystem-indicator","ecosystem-main",{initialIndex:a});f.useEffect(()=>{c.current&&(c.current.allowTouchMove=e)},[e]);const[h,C]=f.useState(0),w=O(h),k=r>0?r-1:0,P=k>0?w*k:0,S=m=>Ie({progress:w,pageCount:r,index:m});return{icon:g.jsx(Q,{className:"-my-2.5 !h-10 !w-15",modules:[te],onSwiper:m=>{c.current=m,s(m)},onSlideChange:l,onProgress:(m,T)=>C(O(T)),slidesPerView:"auto",centeredSlides:!0,spaceBetween:8,allowTouchMove:e,resistance:!0,resistanceRatio:.5,children:n.map((m,T)=>{const I=m==="mine"&&o?q:Pe[m],i=S(T);return g.jsx(Z,{className:"!flex !w-5 cursor-pointer !items-center !justify-center",children:g.jsx(I,{className:R("size-5 transition-opacity duration-100",e?"text-primary":"text-muted-foreground"),style:{opacity:i},stroke:1.5})},m)})}),label:g.jsx("div",{className:"flex h-4 items-center justify-center gap-1",children:n.map((m,T)=>{const I=Math.round(P)===T;return g.jsx("span",{className:R("size-1 rounded-full transition-all duration-200",I?"bg-primary scale-125":"bg-muted-foreground/40")},m)})})}}function Ne({activeTab:n,onTabChange:e,className:o}){const{t:r}=ye("common"),c=x(F,t=>t.activeSubPage),a=x(F,t=>t.availableSubPages),s=x(j,t=>U.getApps(t).length>0),l=x(j,U.hasRunningStackApps),h=x(j,t=>{const d=t.focusedAppId??t.activeAppId;return d?t.apps.get(d)?.state==="active":!1}),C=xe(),w=Ae(),k=Se(),{transactions:P}=ve(C?.id,k,w?.address),S=P.filter(t=>t.status!=="confirmed").length,m=n==="ecosystem",T=f.useMemo(()=>a?.length?a:l?Y:Y.filter(t=>t!=="stack"),[a,l]),I=Ee(T,m,h),i=f.useMemo(()=>c==="stack"||s?J:c==="mine"&&h?q:c==="mine"?G:X,[c,s,h]),u=f.useMemo(()=>[{id:"wallet",label:r("a11y.tabWallet"),icon:he},{id:"ecosystem",label:r("a11y.tabEcosystem"),icon:i},{id:"settings",label:r("a11y.tabSettings"),icon:be}],[r,i]),A=f.useCallback(()=>{se()},[]),b=f.useCallback(()=>{if(!m){e("ecosystem");return}s&&(ne(),ae())},[m,e,s]);return g.jsx("div",{"data-testid":"tab-bar",className:R("fixed right-0 bottom-0 left-0 z-50","bg-background/80 supports-[backdrop-filter]:bg-background/60 border-t backdrop-blur-xl","pb-[env(safe-area-inset-bottom)]",o),style:{height:"var(--tab-bar-height)"},children:g.jsx("div",{className:"mx-auto flex h-[52px] max-w-md",children:u.map(t=>{const d=t.icon,y=n===t.id,E=t.label,M=t.id==="ecosystem",L=g.jsxs(g.Fragment,{children:[g.jsxs("div",{className:"relative",children:[M?I.icon:g.jsx(d,{className:R("size-5",y&&"text-primary"),stroke:1.5}),M&&s&&!y&&g.jsx("span",{className:"bg-primary absolute -top-0.5 -right-0.5 size-2 rounded-full"}),t.id==="wallet"&&S>0&&g.jsx("span",{className:"bg-destructive text-destructive-foreground absolute -top-1 -right-2 flex min-w-4 items-center justify-center rounded-full px-1 text-[10px] font-medium",children:S>9?"9+":S})]}),M&&y?I.label:g.jsx("span",{className:"text-xs font-medium",children:E})]}),D=R("flex flex-1 flex-col items-center justify-center gap-1 transition-colors",y?"text-primary":"text-muted-foreground");return M?g.jsx(ge,{hasRunningApps:s,onSwipeUp:A,onTap:b,className:D,children:g.jsx("button",{"data-testid":`tab-${t.id}`,className:"flex flex-1 flex-col items-center justify-center gap-1","aria-label":E,"aria-current":y?"page":void 0,children:L})},t.id):g.jsx("button",{onClick:()=>e(t.id),"data-testid":`tab-${t.id}`,className:D,"aria-label":E,"aria-current":y?"page":void 0,children:L},t.id)})})})}Ne.__docgenInfo={description:"",methods:[],displayName:"TabBar",props:{activeTab:{required:!0,tsType:{name:"union",raw:"'wallet' | 'ecosystem' | 'settings'",elements:[{name:"literal",value:"'wallet'"},{name:"literal",value:"'ecosystem'"},{name:"literal",value:"'settings'"}]},description:""},onTabChange:{required:!0,tsType:{name:"signature",type:"function",raw:"(tab: TabId) => void",signature:{arguments:[{type:{name:"union",raw:"'wallet' | 'ecosystem' | 'settings'",elements:[{name:"literal",value:"'wallet'"},{name:"literal",value:"'ecosystem'"},{name:"literal",value:"'settings'"}]},name:"tab"}],return:{name:"void"}}},description:""},className:{required:!1,tsType:{name:"string"},description:""}}};export{Ne as T,Ke as a,Ye as b,xe as c,Ae as d,Se as e,Ge as f,ve as g,B as p,Xe as u};
