import{u as g,S as ne}from"./iframe-Cr_UN5ps.js";import{o as y,s as c,n as K,b as _,a as z,e as te,r as W,u as re,f as oe}from"./schemas-B18CumQY.js";const se={snapshot:null,isLoading:!1,error:null,migrationRequired:!1},i=new ne(se);function D(e){return e instanceof Error?e.message:"Unknown error"}async function v(e){i.setState(n=>({...n,isLoading:!0,error:null,migrationRequired:!1}));try{const n=await e();i.setState(t=>({...t,snapshot:n,isLoading:!1,error:null}))}catch(n){n instanceof F?i.setState(t=>({...t,isLoading:!1,error:n.message,migrationRequired:!0})):i.setState(t=>({...t,isLoading:!1,error:D(n)}))}}const Ke={initialize:async()=>{const e=i.state;e.isLoading||e.snapshot||await v(async()=>C())},setSubscriptionUrl:async e=>{i.setState(n=>({...n,isLoading:!0,error:null}));try{const n=await Z(e);if((n.subscription?.url??"default")==="default"){i.setState(a=>({...a,snapshot:n,isLoading:!1,error:null}));return}const{result:r,snapshot:o}=await L(),s=r.status==="error"?r.error:null;i.setState(a=>({...a,snapshot:o,isLoading:!1,error:s}))}catch(n){i.setState(t=>({...t,isLoading:!1,error:D(n)}))}},refreshSubscription:async()=>{i.setState(e=>({...e,isLoading:!0,error:null}));try{const{result:e,snapshot:n}=await L(),t=e.status==="error"?e.error:null;i.setState(r=>({...r,snapshot:n,isLoading:!1,error:t}))}catch(e){i.setState(n=>({...n,isLoading:!1,error:D(e)}))}},addManualConfig:async e=>{await v(async()=>X(e))},setChainEnabled:async(e,n)=>{await v(async()=>P(e,n))},enableChain:async e=>{await v(async()=>P(e,!0))},disableChain:async e=>{await v(async()=>P(e,!1))},clearError:()=>{i.setState(e=>({...e,error:null}))}},w={getSnapshot:e=>e.snapshot,getConfigs:e=>e.snapshot?.configs??[],getSubscription:e=>e.snapshot?.subscription??null,getWarnings:e=>e.snapshot?.warnings??[],getEnabledChains:e=>e.snapshot?T(e.snapshot):[],getEnabledBioforestChainConfigs:e=>e.snapshot?T(e.snapshot).filter(n=>n.chainKind==="bioforest"):[],getChainById:(e,n)=>e.snapshot?ee(e.snapshot,n):null};function ze(){return g(i)}function We(){return g(i,e=>w.getConfigs(e))}function Ge(){return g(i,e=>w.getEnabledChains(e))}function Je(){return g(i,e=>w.getEnabledBioforestChainConfigs(e))}function Qe(){return g(i,e=>w.getSubscription(e))}function He(){return g(i,e=>w.getWarnings(e))}function Ye(){return g(i,e=>e.isLoading)}function Xe(){return g(i,e=>e.error)}function Ze(){return g(i,e=>e.migrationRequired)}class ae{getConfig(n){return w.getChainById(i.state,n)}getApi(n){return this.getConfig(n)?.apis??[]}getApiByType(n,t){return this.getApi(n).find(o=>o.type===t)??null}getApiByPattern(n,t){const r=this.getApi(n),o=new RegExp("^"+t.replace("*",".*")+"$");return r.find(s=>o.test(s.type))??null}getRpcUrl(n){return this.getApiByPattern(n,"*-rpc")?.endpoint??""}getBiowalletApi(n){return this.getApiByPattern(n,"biowallet-*")?.endpoint??null}getBiowalletGenesisBlock(n){return this.getApiByPattern(n,"biowallet-*")?.config?.genesisBlock??null}getEtherscanApi(n){return(this.getApiByPattern(n,"etherscan-*")??this.getApiByPattern(n,"*scan-*"))?.endpoint??null}getMempoolApi(n){return this.getApiByPattern(n,"mempool-*")?.endpoint??null}getDecimals(n){return this.getConfig(n)?.decimals??18}getSymbol(n){return this.getConfig(n)?.symbol??""}getExplorerUrl(n){return this.getConfig(n)?.explorer?.url??null}getTxQueryUrl(n,t){const o=this.getConfig(n)?.explorer?.queryTx;return o?o.replace(":hash",t).replace(":signature",t):null}getAddressQueryUrl(n,t){const o=this.getConfig(n)?.explorer?.queryAddress;return o?o.replace(":address",t):null}getName(n){return this.getConfig(n)?.name??n}getIcon(n){return this.getConfig(n)?.icon??null}}const ie=new ae,ce=c().regex(/^\d+\.\d+$/,'version must be "major.minor" (e.g. "1.0")'),ue=z(["bioforest","evm","bitcoin","tron"]),G=z(["default","subscription","manual"]),le=y({type:c().min(1),endpoint:c().url(),config:W(c(),re()).optional()}).strict(),fe=_(le),de=y({url:c().url(),queryTx:c().optional(),queryAddress:c().optional(),queryBlock:c().optional()}),B=y({id:c().regex(/^[a-z0-9-]+$/,"id must match /^[a-z0-9-]+$/"),version:ce,chainKind:ue,name:c().min(1).max(50),symbol:c().min(1).max(10),icon:c().min(1).optional(),tokenIconBase:_(c().min(1)).optional(),prefix:c().min(1).max(10).optional(),decimals:K().int().min(0).max(18),apis:fe.optional(),explorer:de.optional(),enabled:te().default(!0),source:G.default("default")}).strict(),N=_(B).min(1),ge=y({version:c().regex(/^\d+\.\d+\.\d+$/,'version must be semver (e.g. "2.0.0")'),chains:N}),O=y({url:c().min(1),refreshIntervalMinutes:K().int().min(1).default(1440),lastUpdated:c().optional(),etag:c().optional()}).strict(),pe="bfm_chain_config",he=1,b="chain_configs",f="chain_preferences";let M=null,E=null;const me=B.omit({enabled:!0,source:!0}),be=y({key:c(),id:c(),source:G,config:me}),ye=W(c(),oe());function we(){if(typeof indexedDB>"u")throw new Error("indexedDB is not available in this environment")}function j(e){return new Promise((n,t)=>{e.onsuccess=()=>n(e.result),e.onerror=()=>t(e.error??new Error("IndexedDB request failed"))})}function p(e){return new Promise((n,t)=>{e.oncomplete=()=>n(),e.onerror=()=>t(e.error??new Error("IndexedDB transaction failed")),e.onabort=()=>t(e.error??new Error("IndexedDB transaction aborted"))})}async function h(){if(we(),M)return M;if(E)return E;E=new Promise((e,n)=>{const t=indexedDB.open(pe,he);t.onupgradeneeded=()=>{const r=t.result;r.objectStoreNames.contains(b)||r.createObjectStore(b,{keyPath:"key"}).createIndex("source","source",{unique:!1}),r.objectStoreNames.contains(f)||r.createObjectStore(f,{keyPath:"key"})},t.onsuccess=()=>e(t.result),t.onerror=()=>n(t.error??new Error("Failed to open IndexedDB"))});try{return M=await E,M}finally{E=null}}async function Ce(e,n){const t=e.index("source"),r=[];return new Promise((o,s)=>{const a=t.openCursor(IDBKeyRange.only(n));a.onsuccess=()=>{const u=a.result;if(!u){o(r);return}r.push(u.primaryKey),u.continue()},a.onerror=()=>s(a.error??new Error("Failed to read IndexedDB cursor"))})}async function q(e){const t=(await h()).transaction([b],"readwrite"),r=t.objectStore(b),o=await Ce(r,e.source);for(const s of o)r.delete(s);for(const s of e.configs){const a={id:s.id,version:s.version,chainKind:s.chainKind,name:s.name,symbol:s.symbol,decimals:s.decimals,...s.icon!==void 0?{icon:s.icon}:{},...s.prefix!==void 0?{prefix:s.prefix}:{},...s.apis!==void 0?{apis:s.apis}:{},...s.explorer!==void 0?{explorer:s.explorer}:{}},u={key:`${e.source}:${s.id}`,id:s.id,source:e.source,config:a};r.put(u)}await p(t)}async function $(){const n=(await h()).transaction([b],"readonly"),t=n.objectStore(b),r=await j(t.getAll());await p(n);const o=[];for(const s of r){const a=be.safeParse(s);a.success&&a.data.id===a.data.config.id&&o.push({...a.data.config,source:a.data.source,enabled:!0})}return o}async function Se(e){const t=(await h()).transaction([f],"readwrite"),r=t.objectStore(f),o={key:"enabledMap",value:e};r.put(o),await p(t)}async function J(){const n=(await h()).transaction([f],"readonly"),t=n.objectStore(f),r=await j(t.get("enabledMap"));if(await p(n),!r||typeof r!="object")return{};const o=r.value,s=ye.safeParse(o);if(!s.success)return{};const a={};for(const[u,l]of Object.entries(s.data)){if(typeof l=="boolean"){a[u]=l;continue}if(typeof l=="string"){const d=l.trim().toLowerCase();d==="true"||d==="1"?a[u]=!0:(d==="false"||d==="0")&&(a[u]=!1);continue}l===1?a[u]=!0:l===0&&(a[u]=!1)}return a}async function Q(e){const t=(await h()).transaction([f],"readwrite"),r=t.objectStore(f),o={key:"subscriptionMeta",value:e};r.put(o),await p(t)}async function U(){const n=(await h()).transaction([f],"readonly"),t=n.objectStore(f),r=await j(t.get("subscriptionMeta"));if(await p(n),!r||typeof r!="object")return null;const o=r.value,s=O.safeParse(o);return s.success?s.data:null}async function ve(e){const t=(await h()).transaction([f],"readwrite"),r=t.objectStore(f),o={key:"defaultVersion",value:e};r.put(o),await p(t)}async function Ee(){const n=(await h()).transaction([f],"readonly"),t=n.objectStore(f),r=await j(t.get("defaultVersion"));if(await p(n),!r||typeof r!="object")return null;const o=r.value,s=c().safeParse(o);return s.success?s.data:null}const xe=1e4;function Ae(e){const n=Array.isArray(e)?N.safeParse(e):B.safeParse(e);if(!n.success){const r=n.error.issues[0];throw new Error(r?.message??"Invalid subscription chain config")}return(Array.isArray(e)?n.data:[n.data]).map(r=>({...r,source:"subscription",enabled:!0}))}function Ie(e,n){if(e.length===0)return n;const t=new Map;for(const r of e)t.set(r.id,{...r,source:"subscription",enabled:!0});return[...t.values()]}function Me(e){return e.filter(n=>n.source==="subscription")}async function Pe(e,n){if(e==="default")return{status:"skipped",reason:"default",configs:[],meta:null};const t=await $(),r=Me(t),o=await U(),s=void 0,a=new AbortController,u=setTimeout(()=>a.abort(),xe);try{const l=await fetch(e,{method:"GET",signal:a.signal,headers:{Accept:"application/json",...s!==void 0?{"If-None-Match":s}:{}}});if(clearTimeout(u),l.status===304)return{status:"not_modified",configs:r,meta:o};if(!l.ok)return{status:"error",error:`Subscription fetch failed: ${l.status} ${l.statusText}`,configs:r,meta:o};const d=await l.json(),k=Ae(d),A=Ie(k,r),S=l.headers.get("ETag")??void 0,I=O.safeParse({url:e,...S!==void 0?{etag:S}:{},lastUpdated:new Date().toISOString()});if(!I.success)return{status:"error",error:"Invalid subscription meta",configs:r,meta:o??null};const m=I.data;return await q({source:"subscription",configs:A}),await Q(m),{status:"updated",configs:A,meta:m}}catch(l){return clearTimeout(u),{status:"error",error:l instanceof Error&&l.name==="AbortError"?"Subscription request timeout":l instanceof Error?l.message:"Failed to fetch subscription",configs:r,meta:o??null}}}class F extends Error{code="MIGRATION_REQUIRED";storedVersion;requiredVersion;constructor(n,t){super(`Database migration required: stored version ${n??"unknown"} is incompatible with ${t}`),this.name="ChainConfigMigrationError",this.storedVersion=n,this.requiredVersion=t}}const H={bioforest:1,evm:1,bitcoin:1,tron:1},Be="./configs/default-chains.json";let R=null,x=null;function Y(e){const n=e.split(".")[0],t=Number(n);return Number.isInteger(t)?t:null}function je(e){const n=Y(e.version);return n===null?!1:n<=H[e.chainKind]}function Ue(){const e=typeof window>"u"?"http://localhost/":window.location.href;return new URL(Be,e).toString()}async function ke(){if(R)return R;if(x)return x;x=(async()=>{if(typeof fetch>"u")throw new Error("fetch is not available in this environment");const e=Ue(),n=await fetch(e,{method:"GET",headers:{Accept:"application/json"}});if(!n.ok)throw new Error(`Failed to load default chain configs: ${n.status} ${n.statusText}`);const t=await n.json(),r=ge.safeParse(t);if(!r.success){const u=r.error.issues[0];throw new Error(u?.message??"Invalid default chain config file")}const o=r.data,s=o.chains.map(u=>{const l=De(u,e);return{...u,...l,source:"default",enabled:!0}}),a={version:o.version,configs:s};return R=a,a})();try{return await x}finally{x=null}}function Re(e){try{return JSON.parse(e)}catch{throw new Error("Invalid JSON")}}function V(e,n){return e.startsWith("http://")||e.startsWith("https://")?e:new URL(e,n).toString()}function De(e,n){const t={};return e.icon!==void 0&&(t.icon=V(e.icon,n)),e.tokenIconBase!==void 0&&(t.tokenIconBase=e.tokenIconBase.map(r=>V(r,n))),t}function Le(e,n,t){const r=Array.isArray(e)?N.safeParse(e):B.safeParse(e);if(!r.success){const s=r.error.issues[0];throw new Error(s?.message??"Invalid chain config")}return(Array.isArray(e)?r.data:[r.data]).map(s=>({...s,...{},source:n,enabled:!0}))}function Te(e){const n=new Map;for(const t of e.manual)n.set(t.id,{...t,source:"manual"});for(const t of e.subscription)n.has(t.id)||n.set(t.id,{...t,source:"subscription"});for(const t of e.defaults)n.has(t.id)||n.set(t.id,{...t,source:"default"});return[...n.values()]}function _e(e,n){return e.map(t=>{const r=n[t.id];return{...t,enabled:typeof r=="boolean"?r:!0}})}function Ne(e){const n=[];for(const t of e){const r=Y(t.version);if(r===null)continue;const o=H[t.chainKind];r>o&&n.push({id:t.id,kind:"incompatible_major",version:t.version,supportedMajor:o,source:t.source})}return n}function Oe(e){const n=parseInt(e.split(".")[0]??"0",10);return Number.isNaN(n)?0:n}function qe(e,n){const t=e.split(".").map(Number),r=n.split(".").map(Number);for(let o=0;o<3;o++){const s=t[o]??0,a=r[o]??0;if(s>a)return 1;if(s<a)return-1}return 0}async function C(){const{version:e,configs:n}=await ke(),[t,r,o,s]=await Promise.all([$(),J(),U(),Ee()]),a=Oe(e),u=t.length>0||Object.keys(r).length>0||o!==null;if(s===null&&a>=2&&u)throw new F(s,e);qe(e,s??"0.0.0")>0&&await ve(e);const d=t.filter(m=>m.source==="manual"),k=o?.url&&o.url!=="default"?t.filter(m=>m.source==="subscription"):[],A=Te({manual:d,subscription:k,defaults:n}),S=_e(A,r),I=Ne(S);return{configs:S,enabledMap:r,subscription:o,warnings:I}}async function X(e){const n=typeof e=="string"?Re(e):e,t=Le(n,"manual"),o=(await $()).filter(a=>a.source==="manual"),s=new Map;for(const a of o)s.set(a.id,{...a,source:"manual",enabled:!0});for(const a of t)s.set(a.id,{...a,source:"manual",enabled:!0});return await q({source:"manual",configs:[...s.values()]}),C()}async function P(e,n){const r={...await J(),[e]:n};return await Se(r),C()}async function L(){const n=(await U())?.url??"default",t=await Pe(n),r=await C();return{result:t,snapshot:r}}function $e(e){const n=e.trim();if(n==="")return"default";if(n==="default")return n;let t;try{t=new URL(n)}catch{throw new Error("Invalid subscription URL")}if(t.protocol!=="http:"&&t.protocol!=="https:")throw new Error("Subscription URL must use http(s)");return n}async function Z(e){const n=$e(e),t=await U(),r=t?.url;r!==n&&await q({source:"subscription",configs:[]});const o=O.parse({url:n,refreshIntervalMinutes:t?.refreshIntervalMinutes??1440,...r===n?{...t?.etag?{etag:t.etag}:{},...t?.lastUpdated?{lastUpdated:t.lastUpdated}:{}}:{}});return await Q(o),C()}function T(e){return e.configs.filter(n=>n.enabled&&je(n))}function ee(e,n){return e.configs.find(t=>t.id===n)??null}const en=Object.freeze(Object.defineProperty({__proto__:null,ChainConfigMigrationError:F,addManualConfig:X,chainConfigService:ie,getChainById:ee,getEnabledChains:T,initialize:C,refreshSubscription:L,setChainEnabled:P,setSubscriptionUrl:Z},Symbol.toStringTag,{value:"Module"}));export{T as a,w as b,ie as c,We as d,i as e,Ke as f,ee as g,Ze as h,C as i,Qe as j,He as k,Ye as l,Xe as m,Ge as n,Je as o,en as p,ze as u};
