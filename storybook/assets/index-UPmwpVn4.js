const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./derivation-DZMe6kEi.js","./iframe-DtSykY7Y.js","./preload-helper-PPVm8Dsz.js","./iframe-dKmOljRT.css","./service-n17MZ-NQ.js","./schemas-CO8_C8zP.js","./index-D0E7N0oa.js"])))=>i.map(i=>d[i]);
import{r as J}from"./iframe-DtSykY7Y.js";import{c as le,e as VE}from"./service-n17MZ-NQ.js";import{A as se}from"./amount-BQsqQYGO.js";import{o as wd,s as go,u as qE,c as WE}from"./schemas-CO8_C8zP.js";import"./index-D0E7N0oa.js";import{D as Oa,F as JE,u as GE,G as Ai,j as Ir,H as yo,k as $r,q as kr,I as jS,J as qm,K as Wm,L as Jm}from"./derivation-DZMe6kEi.js";import{c as YE,p as QE,i as XE,s as ZE}from"./bioforest-Bi0ph6sX.js";import{_ as rs}from"./preload-helper-PPVm8Dsz.js";class eC extends Error{source;chainId;method;issues;constructor(t){super(`[InvalidData] ${t.source}:${t.chainId}:${t.method}`,{cause:t.cause instanceof Error?t.cause:void 0}),this.name="InvalidDataError",this.source=t.source,this.chainId=t.chainId,this.method=t.method,this.issues=t.issues??[]}}const tC=e=>typeof e=="function",d=function(e,t){if(typeof e=="function")return function(){return e(arguments)?t.apply(this,arguments):n=>t(n,...arguments)};switch(e){case 0:case 1:throw new RangeError(`Invalid arity ${e}`);case 2:return function(n,r){return arguments.length>=2?t(n,r):function(s){return t(s,n)}};case 3:return function(n,r,s){return arguments.length>=3?t(n,r,s):function(o){return t(o,n,r)}};case 4:return function(n,r,s,o){return arguments.length>=4?t(n,r,s,o):function(i){return t(i,n,r,s)}};case 5:return function(n,r,s,o,i){return arguments.length>=5?t(n,r,s,o,i):function(c){return t(c,n,r,s,o)}};default:return function(){if(arguments.length>=e)return t.apply(this,arguments);const n=arguments;return function(r){return t(r,...n)}}}},ee=e=>e,vu=e=>()=>e,Gm=vu(!0),zf=vu(!1),zS=vu(void 0),Pa=zS;function p(e,t,n,r,s,o,i,c,a){switch(arguments.length){case 1:return e;case 2:return t(e);case 3:return n(t(e));case 4:return r(n(t(e)));case 5:return s(r(n(t(e))));case 6:return o(s(r(n(t(e)))));case 7:return i(o(s(r(n(t(e))))));case 8:return c(i(o(s(r(n(t(e)))))));case 9:return a(c(i(o(s(r(n(t(e))))))));default:{let u=arguments[0];for(let l=1;l<arguments.length;l++)u=arguments[l](u);return u}}}const Tu=e=>(t,n)=>t===n||e(t,n),nC=d(2,(e,t)=>Tu((n,r)=>e(t(n),t(r)))),rC=e=>Tu((t,n)=>{if(t.length!==n.length)return!1;for(let r=0;r<t.length;r++)if(!e(t[r],n[r]))return!1;return!0}),Ym="effect/GlobalValue";let ui;const be=(e,t)=>(ui||(globalThis[Ym]??=new Map,ui=globalThis[Ym]),ui.has(e)||ui.set(e,t()),ui.get(e)),gn=e=>typeof e=="string",dr=e=>typeof e=="number",Ki=e=>typeof e=="boolean",ku=e=>typeof e=="bigint",Vf=e=>typeof e=="symbol",dc=tC,sC=e=>e===void 0,oC=e=>e!==void 0,Xl=e=>e!==null,iC=e=>!1,vd=e=>typeof e=="object"&&e!==null,gr=e=>vd(e)||dc(e),te=d(2,(e,t)=>gr(e)&&t in e),VS=d(2,(e,t)=>te(e,"_tag")&&e._tag===t),Ms=e=>e==null,cC=e=>e!=null,aC=e=>e instanceof Date,qS=e=>typeof e=="string"||te(e,Symbol.iterator),uC=e=>vd(e)&&!Array.isArray(e),lC=e=>te(e,"then")&&dc(e.then),Eu=e=>`BUG: ${e} - please report an issue at https://github.com/Effect-TS/effect/issues`;let WS=class JS{self;called=!1;constructor(t){this.self=t}next(t){return this.called?{value:t,done:!0}:(this.called=!0,{value:this.self,done:!1})}return(t){return{value:t,done:!0}}throw(t){throw t}[Symbol.iterator](){return new JS(this.self)}};const fC=335903614,hC=4150755663,dC=1481765933,pC=1284865837,mC=9007199254740992,gC=134217728;class yC{_state;constructor(t,n,r,s){return Ms(n)&&Ms(t)?(n=Math.random()*4294967295>>>0,t=0):Ms(n)&&(n=t,t=0),Ms(s)&&Ms(r)?(s=this._state?this._state[3]:hC,r=this._state?this._state[2]:fC):Ms(s)&&(s=r,r=0),this._state=new Int32Array([0,0,r>>>0,((s||0)|1)>>>0]),this._next(),Qm(this._state,this._state[0],this._state[1],t>>>0,n>>>0),this._next(),this}getState(){return[this._state[0],this._state[1],this._state[2],this._state[3]]}setState(t){this._state[0]=t[0],this._state[1]=t[1],this._state[2]=t[2],this._state[3]=t[3]|1}integer(t){return Math.round(this.number()*Number.MAX_SAFE_INTEGER)%t}number(){const t=(this._next()&67108863)*1,n=(this._next()&134217727)*1;return(t*gC+n)/mC}_next(){const t=this._state[0]>>>0,n=this._state[1]>>>0;SC(this._state,t,n,dC,pC),Qm(this._state,this._state[0],this._state[1],this._state[2],this._state[3]);let r=t>>>18,s=(n>>>18|t<<14)>>>0;r=(r^t)>>>0,s=(s^n)>>>0;const o=(s>>>27|r<<5)>>>0,i=t>>>27,c=(-i>>>0&31)>>>0;return(o>>>i|o<<c)>>>0}}function SC(e,t,n,r,s){let o=(n>>>16)*(s&65535)>>>0,i=(n&65535)*(s>>>16)>>>0,c=(n&65535)*(s&65535)>>>0,a=(n>>>16)*(s>>>16)+((i>>>16)+(o>>>16))>>>0;i=i<<16>>>0,c=c+i>>>0,c>>>0<i>>>0&&(a=a+1>>>0),o=o<<16>>>0,c=c+o>>>0,c>>>0<o>>>0&&(a=a+1>>>0),a=a+Math.imul(n,r)>>>0,a=a+Math.imul(t,s)>>>0,e[0]=a,e[1]=c}function Qm(e,t,n,r,s){let o=t+r>>>0;const i=n+s>>>0;i>>>0<n>>>0&&(o=o+1|0),e[0]=o,e[1]=i}const qf=Symbol.for("effect/Utils/YieldWrap");class pc{#e;constructor(t){this.#e=t}[qf](){return this.#e}}function bC(e){if(typeof e=="object"&&e!==null&&qf in e)return e[qf]();throw new Error(Eu("yieldWrapGet"))}const an=be("effect/Utils/isStructuralRegion",()=>({enabled:!1,tester:void 0})),GS={effect_internal_function:e=>e()},_C={effect_internal_function:e=>e()},wC=GS.effect_internal_function(()=>new Error().stack)?.includes("effect_internal_function")===!0,Ut=wC?GS.effect_internal_function:_C.effect_internal_function,Zl=be(Symbol.for("effect/Hash/randomHashCache"),()=>new WeakMap),he=Symbol.for("effect/Hash"),Y=e=>{if(an.enabled===!0)return 0;switch(typeof e){case"number":return kd(e);case"bigint":return Ze(e.toString(10));case"boolean":return Ze(String(e));case"symbol":return Ze(String(e));case"string":return Ze(e);case"undefined":return Ze("undefined");case"function":case"object":return e===null?Ze("null"):e instanceof Date?Number.isNaN(e.getTime())?Ze("Invalid Date"):Y(e.toISOString()):e instanceof URL?Y(e.href):vC(e)?e[he]():Td(e);default:throw new Error(`BUG: unhandled typeof ${typeof e} - please report an issue at https://github.com/Effect-TS/effect/issues`)}},Td=e=>(Zl.has(e)||Zl.set(e,kd(Math.floor(Math.random()*Number.MAX_SAFE_INTEGER))),Zl.get(e)),ye=e=>t=>t*53^e,Cu=e=>e&3221225471|e>>>1&1073741824,vC=e=>te(e,he),kd=e=>{if(e!==e||e===1/0)return 0;let t=e|0;for(t!==e&&(t^=e*4294967295);e>4294967295;)t^=e/=4294967295;return Cu(t)},Ze=e=>{let t=5381,n=e.length;for(;n;)t=t*33^e.charCodeAt(--n);return Cu(t)},TC=(e,t)=>{let n=12289;for(let r=0;r<t.length;r++)n^=p(Ze(t[r]),ye(Y(e[t[r]])));return Cu(n)},YS=e=>TC(e,Object.keys(e)),mc=e=>{let t=6151;for(let n=0;n<e.length;n++)t=p(t,ye(Y(e[n])));return Cu(t)},Ye=function(){if(arguments.length===1){const n=arguments[0];return function(r){return Object.defineProperty(n,he,{value(){return r},enumerable:!1}),r}}const e=arguments[0],t=arguments[1];return Object.defineProperty(e,he,{value(){return t},enumerable:!1}),t},fe=Symbol.for("effect/Equal");function oe(){return arguments.length===1?e=>xa(e,arguments[0]):xa(arguments[0],arguments[1])}function xa(e,t){if(e===t)return!0;const n=typeof e;if(n!==typeof t)return!1;if(n==="object"||n==="function"){if(e!==null&&t!==null){if(Fa(e)&&Fa(t))return Y(e)===Y(t)&&e[fe](t)?!0:an.enabled&&an.tester?an.tester(e,t):!1;if(e instanceof Date&&t instanceof Date){const r=e.getTime(),s=t.getTime();return r===s||Number.isNaN(r)&&Number.isNaN(s)}else if(e instanceof URL&&t instanceof URL)return e.href===t.href}if(an.enabled){if(Array.isArray(e)&&Array.isArray(t))return e.length===t.length&&e.every((r,s)=>xa(r,t[s]));if(Object.getPrototypeOf(e)===Object.prototype&&Object.getPrototypeOf(t)===Object.prototype){const r=Object.keys(e),s=Object.keys(t);if(r.length===s.length){for(const o of r)if(!(o in t&&xa(e[o],t[o])))return an.tester?an.tester(e,t):!1;return!0}}return an.tester?an.tester(e,t):!1}}return an.enabled&&an.tester?an.tester(e,t):!1}const Fa=e=>te(e,fe),Ed=()=>oe,Me=Symbol.for("nodejs.util.inspect.custom"),Ge=e=>{try{if(te(e,"toJSON")&&dc(e.toJSON)&&e.toJSON.length===0)return e.toJSON();if(Array.isArray(e))return e.map(Ge)}catch{return{}}return IC(e)},ef="[Circular]";function kC(e){try{return e.toISOString()}catch{return"Invalid Date"}}function EC(e){try{const t=e.toString();return typeof t=="string"?t:String(t)}catch{return"[toString threw]"}}function Cd(e){return gn(e)?JSON.stringify(e):String(e)}function Dr(e,t){const n=new WeakSet,r=(i,c)=>{const a=i?.constructor;return a&&a!==Object.prototype.constructor&&a.name?`${a.name}(${c})`:c},s=i=>{try{return Reflect.ownKeys(i)}catch{return["[ownKeys threw]"]}};function o(i,c=0){if(Array.isArray(i))return n.has(i)?ef:(n.add(i),`[${i.map(a=>o(a,c)).join(",")}]`);if(aC(i))return kC(i);if(te(i,"toString")&&dc(i.toString)&&i.toString!==Object.prototype.toString&&i.toString!==Array.prototype.toString){const a=EC(i);return i instanceof Error&&i.cause?`${a} (cause: ${o(i.cause,c)})`:a}if(gn(i))return JSON.stringify(i);if(dr(i)||i==null||Ki(i)||Vf(i))return String(i);if(ku(i))return String(i)+"n";if(i instanceof Set||i instanceof Map)return n.has(i)?ef:(n.add(i),`${i.constructor.name}(${o(Array.from(i),c)})`);if(gr(i)){if(n.has(i))return ef;n.add(i);const a=s(i);{const u=`{${a.map(l=>`${Cd(l)}:${o(i[l],c)}`).join(",")}}`;return r(i,u)}}return String(i)}return o(e,0)}const at=e=>JSON.stringify(e,null,2),So=(e,t=2)=>{if(typeof e=="string")return e;try{return typeof e=="object"?QS(e,t):String(e)}catch{return String(e)}},QS=(e,t)=>{let n=[];const r=JSON.stringify(e,(s,o)=>typeof o=="object"&&o!==null?n.includes(o)?void 0:n.push(o)&&(ss.fiberRefs!==void 0&&XS(o)?o[Id](ss.fiberRefs):o):o,t);return n=void 0,r},Id=Symbol.for("effect/Inspectable/Redactable"),XS=e=>typeof e=="object"&&e!==null&&Id in e,ss=be("effect/Inspectable/redactableState",()=>({fiberRefs:void 0})),CC=(e,t)=>{const n=ss.fiberRefs;ss.fiberRefs=e;try{return t()}finally{ss.fiberRefs=n}},IC=e=>XS(e)&&ss.fiberRefs!==void 0?e[Id](ss.fiberRefs):e,G=(e,t)=>{switch(t.length){case 0:return e;case 1:return t[0](e);case 2:return t[1](t[0](e));case 3:return t[2](t[1](t[0](e)));case 4:return t[3](t[2](t[1](t[0](e))));case 5:return t[4](t[3](t[2](t[1](t[0](e)))));case 6:return t[5](t[4](t[3](t[2](t[1](t[0](e))))));case 7:return t[6](t[5](t[4](t[3](t[2](t[1](t[0](e)))))));case 8:return t[7](t[6](t[5](t[4](t[3](t[2](t[1](t[0](e))))))));case 9:return t[8](t[7](t[6](t[5](t[4](t[3](t[2](t[1](t[0](e)))))))));default:{let n=e;for(let r=0,s=t.length;r<s;r++)n=t[r](n);return n}}},Ri="Async",Iu="Commit",Pt="Failure",fa="OnFailure",Na="OnSuccess",Ba="OnSuccessAndFailure",xt="Success",ZS="Sync",$C="Tag",Wo="UpdateRuntimeFlags",Ma="While",Oi="Iterator",eb="WithRuntime",ha="Yield",$d="RevertFlags";let AC="3.19.15";const Ad=()=>AC,RC=Symbol.for("effect/Effect"),OC=Symbol.for("effect/Stream"),PC=Symbol.for("effect/Sink"),xC=Symbol.for("effect/Channel"),bo={_R:e=>e,_E:e=>e,_A:e=>e,_V:Ad()},FC={_A:e=>e,_In:e=>e,_L:e=>e,_E:e=>e,_R:e=>e},NC={_Env:e=>e,_InErr:e=>e,_InElem:e=>e,_InDone:e=>e,_OutErr:e=>e,_OutElem:e=>e,_OutDone:e=>e},gc={[RC]:bo,[OC]:bo,[PC]:FC,[xC]:NC,[fe](e){return this===e},[he](){return Ye(this,Td(this))},[Symbol.iterator](){return new WS(new pc(this))},pipe(){return G(this,arguments)}},Rd={[he](){return Ye(this,YS(this))},[fe](e){const t=Object.keys(this),n=Object.keys(e);if(t.length!==n.length)return!1;for(const r of t)if(!(r in e&&oe(this[r],e[r])))return!1;return!0}},yc={...gc,_op:Iu},BC={...yc,...Rd},MC=(function(){function e(){}return e.prototype=yc,e})(),tb=Symbol.for("effect/Option"),nb={...gc,[tb]:{_A:e=>e},[Me](){return this.toJSON()},toString(){return at(this.toJSON())}},LC=Object.assign(Object.create(nb),{_tag:"Some",_op:"Some",[fe](e){return Od(e)&&sb(e)&&oe(this.value,e.value)},[he](){return Ye(this,ye(Y(this._tag))(Y(this.value)))},toJSON(){return{_id:"Option",_tag:this._tag,value:Ge(this.value)}}}),HC=Y("None"),DC=Object.assign(Object.create(nb),{_tag:"None",_op:"None",[fe](e){return Od(e)&&rb(e)},[he](){return HC},toJSON(){return{_id:"Option",_tag:this._tag}}}),Od=e=>te(e,tb),rb=e=>e._tag==="None",sb=e=>e._tag==="Some",Pd=Object.create(DC),La=e=>{const t=Object.create(LC);return t.value=e,t},ob=Symbol.for("effect/Either"),ib={...gc,[ob]:{_R:e=>e},[Me](){return this.toJSON()},toString(){return at(this.toJSON())}},UC=Object.assign(Object.create(ib),{_tag:"Right",_op:"Right",[fe](e){return xd(e)&&ab(e)&&oe(this.right,e.right)},[he](){return ye(Y(this._tag))(Y(this.right))},toJSON(){return{_id:"Either",_tag:this._tag,right:Ge(this.right)}}}),KC=Object.assign(Object.create(ib),{_tag:"Left",_op:"Left",[fe](e){return xd(e)&&cb(e)&&oe(this.left,e.left)},[he](){return ye(Y(this._tag))(Y(this.left))},toJSON(){return{_id:"Either",_tag:this._tag,left:Ge(this.left)}}}),xd=e=>te(e,ob),cb=e=>e._tag==="Left",ab=e=>e._tag==="Right",jC=e=>{const t=Object.create(KC);return t.left=e,t},zC=e=>{const t=Object.create(UC);return t.right=e,t},pe=zC,re=jC,VC=xd,Tt=cb,xn=ab,qC=d(2,(e,{onLeft:t,onRight:n})=>Tt(e)?re(t(e.left)):pe(n(e.right))),WC=d(2,(e,t)=>Tt(e)?re(t(e.left)):pe(e.right)),JC=d(2,(e,t)=>xn(e)?pe(t(e.right)):re(e.left)),jt=d(2,(e,{onLeft:t,onRight:n})=>Tt(e)?t(e.left):n(e.right)),GC=jt({onLeft:ee,onRight:ee}),ub=d(2,(e,t)=>{if(xn(e))return e.right;throw t(e.left)}),YC=ub(()=>new Error("getOrThrow called on a Left")),lb=e=>e.length>0,fb=e=>(t,n)=>t===n?0:e(t,n),QC=fb((e,t)=>e<t?-1:1),hb=d(2,(e,t)=>fb((n,r)=>e(t(n),t(r)))),XC=e=>d(2,(t,n)=>e(t,n)===1),K=()=>Pd,U=La,ZC=Od,Ue=rb,$e=sb,Fe=d(2,(e,{onNone:t,onSome:n})=>Ue(e)?t():n(e.value)),qe=d(2,(e,t)=>Ue(e)?t():e.value),ir=d(2,(e,t)=>Ue(e)?t():e),eI=d(2,(e,t)=>Ue(e)?U(t()):e),$u=e=>e==null?K():U(e),Rn=qe(zS),tI=e=>(...t)=>{try{return U(e(...t))}catch{return K()}},ro=d(2,(e,t)=>Ue(e)?K():U(t(e.value))),Jo=d(2,(e,t)=>Ue(e)?K():t(e.value)),nI=d(2,(e,t)=>Ue(e)?K():$u(t(e.value))),rI=Jo,li=d(2,(e,t)=>rI(e,n=>t(n)?La(n):Pd)),sI=e=>Tu((t,n)=>Ue(t)?Ue(n):Ue(n)?!1:e(t.value,n.value)),oI=e=>d(2,(t,n)=>Ue(t)?!1:e(t.value,n)),iI=Ed(),cI=oI(iI),aI=d(2,(e,t)=>Ue(e)?!1:t(e.value)),Xm=e=>(t,n)=>Ue(t)?n:Ue(n)?t:U(e(t.value,n.value)),uI=(...e)=>e,Au=e=>new Array(e),lI=d(2,(e,t)=>{const n=Math.max(1,Math.floor(e)),r=new Array(n);for(let s=0;s<n;s++)r[s]=t(s);return r}),Ne=e=>Array.isArray(e)?e:Array.from(e),fI=e=>Array.isArray(e)?e:[e],hI=d(2,(e,{onEmpty:t,onNonEmpty:n})=>wt(e)?n(zt(e),hs(e)):t()),Ha=d(2,(e,t)=>[t,...e]),dI=d(2,(e,t)=>[...e,t]),db=d(2,(e,t)=>Ne(e).concat(Ne(t))),pI=Array.isArray,mI=e=>e.length===0,gI=mI,da=lb,wt=lb,pb=(e,t)=>e<0||e>=t.length,yI=(e,t)=>Math.floor(Math.min(Math.max(0,e),t.length)),SI=d(2,(e,t)=>{const n=Math.floor(t);return pb(n,e)?K():U(e[n])}),mb=d(2,(e,t)=>{const n=Math.floor(t);if(pb(n,e))throw new Error(`Index ${n} out of bounds`);return e[n]}),Pi=SI(0),zt=mb(0),bI=e=>wt(e)?U(gb(e)):K(),gb=e=>e[e.length-1],hs=e=>e.slice(1),_I=(e,t)=>{let n=0;for(const r of e){if(!t(r,n))break;n++}return n},wI=d(2,(e,t)=>yb(e,_I(e,t))),vI=d(2,(e,t)=>{const n=Ne(e);return n.slice(yI(t,n),n.length)}),Zm=e=>Array.from(e).reverse(),ji=d(2,(e,t)=>{const n=Array.from(e);return n.sort(t),n}),eg=d(2,(e,t)=>TI(e,t,uI)),TI=d(3,(e,t,n)=>{const r=Ne(e),s=Ne(t);if(wt(r)&&wt(s)){const o=[n(zt(r),zt(s))],i=Math.min(r.length,s.length);for(let c=1;c<i;c++)o[c]=n(r[c],s[c]);return o}return[]}),kI=Ed(),yb=d(2,(e,t)=>{const n=Array.from(e),r=Math.floor(t);return wt(n)?r>=1?EI(n,r):[[],n]:[n,[]]}),EI=d(2,(e,t)=>{const n=Math.max(1,Math.floor(t));return n>=e.length?[wi(e),[]]:[Ha(e.slice(1,n),zt(e)),e.slice(n)]}),wi=e=>e.slice(),CI=d(3,(e,t,n)=>{const r=Ne(e),s=Ne(t);return wt(r)?wt(s)?Sb(n)(db(r,s)):r:s}),pa=d(2,(e,t)=>CI(e,t,kI)),ds=()=>[],Sn=e=>[e],os=d(2,(e,t)=>e.map(t)),Da=d(2,(e,t)=>{if(gI(e))return[];const n=[];for(let r=0;r<e.length;r++){const s=t(e[r],r);for(let o=0;o<s.length;o++)n.push(s[o])}return n}),II=Da(ee),$I=d(2,(e,t)=>{const n=Ne(e),r=[];for(let s=0;s<n.length;s++){const o=t(n[s],s);$e(o)&&r.push(o.value)}return r}),AI=d(2,(e,t)=>{const n=Ne(e),r=[];for(let s=0;s<n.length;s++)t(n[s],s)&&r.push(n[s]);return r}),Fd=d(3,(e,t,n)=>Ne(e).reduce((r,s,o)=>n(r,s,o),t)),tg=(e,t)=>{const n=[];let r=e,s;for(;$e(s=t(r));){const[o,i]=s.value;n.push(o),r=i}return n},Nd=rC,Sb=d(2,(e,t)=>{const n=Ne(e);if(wt(n)){const r=[zt(n)],s=hs(n);for(const o of s)r.every(i=>!t(o,i))&&r.push(o);return r}return[]}),RI=e=>Sb(e,Ed()),Go=d(2,(e,t)=>Ne(e).join(t)),bb=(e,t)=>{switch(t._tag){case"StringKeyword":case"TemplateLiteral":return Object.keys(e);case"SymbolKeyword":return Object.getOwnPropertySymbols(e);case"Refinement":return bb(e,t.from)}},_b=e=>{let t=!1,n;return()=>(t||(n=e(),t=!0),n)},wb=e=>Array.isArray(e),ng=e=>`[${Cd(e)}]`,vb=e=>wb(e)?e.map(ng).join(""):ng(e),Ur=(e,t,n,r)=>{let s=e;return n&&wt(n)&&(s+=`
at path: ${vb(n)}`),t!==void 0&&(s+=`
details: ${t}`),r&&(s+=`
schema (${r._tag}): ${r}`),s},Tb=(e,t,n)=>Ur("Unsupported schema or overlapping types",`cannot extend ${e} with ${t}`,n),OI=e=>Ur("Unsupported key schema",void 0,void 0,e),PI=e=>Ur("Unsupported literal",`literal value: ${Dr(e)}`),rg=e=>Ur("Duplicate index signature",`${e} index signature`),xI=Ur("Unsupported index signature parameter","An index signature parameter type must be `string`, `symbol`, a template literal type or a refinement of the previous types"),FI=Ur("Invalid element","A required element cannot follow an optional element. ts(1257)"),sg=e=>Ur("Duplicate property signature transformation",`Duplicate key ${Dr(e)}`),kb=e=>Ur("Duplicate property signature",`Duplicate key ${Dr(e)}`),_o=QC,Ua=e=>e.replace(/[/\\^$*+?.()|[\]{}]/g,"\\$&"),NI=Symbol.for("effect/annotation/TypeConstructor"),BI=Symbol.for("effect/annotation/Brand"),MI=Symbol.for("effect/annotation/SchemaId"),Eb=Symbol.for("effect/annotation/Message"),Bd=Symbol.for("effect/annotation/MissingMessage"),Ru=Symbol.for("effect/annotation/Identifier"),Jn=Symbol.for("effect/annotation/Title"),so=Symbol.for("effect/annotation/AutoTitle"),Yo=Symbol.for("effect/annotation/Description"),Cb=Symbol.for("effect/annotation/Examples"),Ib=Symbol.for("effect/annotation/Default"),$b=Symbol.for("effect/annotation/JSONSchema"),Ab=Symbol.for("effect/annotation/Arbitrary"),Rb=Symbol.for("effect/annotation/Pretty"),Ob=Symbol.for("effect/annotation/Equivalence"),LI=Symbol.for("effect/annotation/Documentation"),Pb=Symbol.for("effect/annotation/Concurrency"),xb=Symbol.for("effect/annotation/Batching"),Fb=Symbol.for("effect/annotation/ParseIssueTitle"),Nb=Symbol.for("effect/annotation/ParseOptions"),Bb=Symbol.for("effect/annotation/DecodingFallback"),Ka=Symbol.for("effect/annotation/Surrogate"),HI=Symbol.for("effect/annotation/StableFilter"),Vt=d(2,(e,t)=>Object.prototype.hasOwnProperty.call(e.annotations,t)?U(e.annotations[t]):K()),DI=Vt(BI),UI=Vt(Eb),KI=Vt(Bd),Mb=Vt(Jn),Lb=Vt(so),Ou=Vt(Ru),Hb=Vt(Yo),jI=Vt(Pb),zI=Vt(xb),VI=Vt(Fb),qI=Vt(Nb),WI=Vt(Bb),Db=Vt(Ka),JI=Vt(HI),GI=e=>aI(JI(e),t=>t===!0),Ub=Symbol.for("effect/annotation/JSONIdentifier"),YI=Vt(Ub),QI=e=>ir(YI(e),()=>Ou(e));class Pu{typeParameters;decodeUnknown;encodeUnknown;annotations;_tag="Declaration";constructor(t,n,r,s={}){this.typeParameters=t,this.decodeUnknown=n,this.encodeUnknown=r,this.annotations=s}toString(){return qe(Un(this),()=>"<declaration schema>")}toJSON(){return{_tag:this._tag,typeParameters:this.typeParameters.map(t=>t.toJSON()),annotations:ht(this.annotations)}}}const yr=e=>t=>t._tag===e;let ja=class{literal;annotations;_tag="Literal";constructor(t,n={}){this.literal=t,this.annotations=n}toString(){return qe(Un(this),()=>Dr(this.literal))}toJSON(){return{_tag:this._tag,literal:ku(this.literal)?String(this.literal):this.literal,annotations:ht(this.annotations)}}};const xi=yr("Literal"),XI=new ja(null);class ZI{symbol;annotations;_tag="UniqueSymbol";constructor(t,n={}){this.symbol=t,this.annotations=n}toString(){return qe(Un(this),()=>Dr(this.symbol))}toJSON(){return{_tag:this._tag,symbol:String(this.symbol),annotations:ht(this.annotations)}}}class e${annotations;_tag="UndefinedKeyword";constructor(t={}){this.annotations=t}toString(){return Kr(this)}toJSON(){return{_tag:this._tag,annotations:ht(this.annotations)}}}const Wf=new e$({[Jn]:"undefined"});class t${annotations;_tag="NeverKeyword";constructor(t={}){this.annotations=t}toString(){return Kr(this)}toJSON(){return{_tag:this._tag,annotations:ht(this.annotations)}}}const Md=new t$({[Jn]:"never"});class n${annotations;_tag="UnknownKeyword";constructor(t={}){this.annotations=t}toString(){return Kr(this)}toJSON(){return{_tag:this._tag,annotations:ht(this.annotations)}}}const Kb=new n$({[Jn]:"unknown"});class r${annotations;_tag="AnyKeyword";constructor(t={}){this.annotations=t}toString(){return Kr(this)}toJSON(){return{_tag:this._tag,annotations:ht(this.annotations)}}}const s$=new r$({[Jn]:"any"});class o${annotations;_tag="StringKeyword";constructor(t={}){this.annotations=t}toString(){return Kr(this)}toJSON(){return{_tag:this._tag,annotations:ht(this.annotations)}}}const Jf=new o$({[Jn]:"string",[Yo]:"a string"}),Gf=yr("StringKeyword");class i${annotations;_tag="NumberKeyword";constructor(t={}){this.annotations=t}toString(){return Kr(this)}toJSON(){return{_tag:this._tag,annotations:ht(this.annotations)}}}const Yf=new i$({[Jn]:"number",[Yo]:"a number"}),og=yr("NumberKeyword");class c${annotations;_tag="BooleanKeyword";constructor(t={}){this.annotations=t}toString(){return Kr(this)}toJSON(){return{_tag:this._tag,annotations:ht(this.annotations)}}}const Qf=new c$({[Jn]:"boolean",[Yo]:"a boolean"}),ig=yr("BooleanKeyword");class a${annotations;_tag="BigIntKeyword";constructor(t={}){this.annotations=t}toString(){return Kr(this)}toJSON(){return{_tag:this._tag,annotations:ht(this.annotations)}}}const u$=new a$({[Jn]:"bigint",[Yo]:"a bigint"}),l$=yr("SymbolKeyword");let xu=class{type;annotations;constructor(t,n={}){this.type=t,this.annotations=n}toJSON(){return{type:this.type.toJSON(),annotations:ht(this.annotations)}}toString(){return String(this.type)}};class ks extends xu{isOptional;constructor(t,n,r={}){super(t,r),this.isOptional=n}toJSON(){return{type:this.type.toJSON(),isOptional:this.isOptional,annotations:ht(this.annotations)}}toString(){return String(this.type)+(this.isOptional?"?":"")}}const jb=e=>e.map(t=>t.type);class Ld{elements;rest;isReadonly;annotations;_tag="TupleType";constructor(t,n,r,s={}){this.elements=t,this.rest=n,this.isReadonly=r,this.annotations=s;let o=!1,i=!1;for(const c of t)if(c.isOptional)o=!0;else if(o){i=!0;break}if(i||o&&n.length>1)throw new Error(FI)}toString(){return qe(Un(this),()=>f$(this))}toJSON(){return{_tag:this._tag,elements:this.elements.map(t=>t.toJSON()),rest:this.rest.map(t=>t.toJSON()),isReadonly:this.isReadonly,annotations:ht(this.annotations)}}}const f$=e=>{const t=e.elements.map(String).join(", ");return hI(e.rest,{onEmpty:()=>`readonly [${t}]`,onNonEmpty:(n,r)=>{const s=String(n),o=s.includes(" | ")?`(${s})`:s;if(r.length>0){const i=r.map(String).join(", ");return e.elements.length>0?`readonly [${t}, ...${o}[], ${i}]`:`readonly [...${o}[], ${i}]`}else return e.elements.length>0?`readonly [${t}, ...${o}[]]`:`ReadonlyArray<${s}>`}})};class $t extends ks{name;isReadonly;constructor(t,n,r,s,o){super(n,r,o),this.name=t,this.isReadonly=s}toString(){return(this.isReadonly?"readonly ":"")+String(this.name)+(this.isOptional?"?":"")+": "+this.type}toJSON(){return{name:String(this.name),type:this.type.toJSON(),isOptional:this.isOptional,isReadonly:this.isReadonly,annotations:ht(this.annotations)}}}const zb=e=>{switch(e._tag){case"StringKeyword":case"SymbolKeyword":case"TemplateLiteral":return!0;case"Refinement":return zb(e.from)}return!1};class Fu{type;isReadonly;parameter;constructor(t,n,r){if(this.type=n,this.isReadonly=r,zb(t))this.parameter=t;else throw new Error(xI)}toString(){return(this.isReadonly?"readonly ":"")+`[x: ${this.parameter}]: ${this.type}`}toJSON(){return{parameter:this.parameter.toJSON(),type:this.type.toJSON(),isReadonly:this.isReadonly}}}class Ar{annotations;_tag="TypeLiteral";propertySignatures;indexSignatures;constructor(t,n,r={}){this.annotations=r;const s={};for(let i=0;i<t.length;i++){const c=t[i].name;if(Object.prototype.hasOwnProperty.call(s,c))throw new Error(kb(c));s[c]=null}const o={string:!1,symbol:!1};for(let i=0;i<n.length;i++){const c=Qb(n[i].parameter);if(Gf(c)){if(o.string)throw new Error(rg("string"));o.string=!0}else if(l$(c)){if(o.symbol)throw new Error(rg("symbol"));o.symbol=!0}}this.propertySignatures=t,this.indexSignatures=n}toString(){return qe(Un(this),()=>h$(this))}toJSON(){return{_tag:this._tag,propertySignatures:this.propertySignatures.map(t=>t.toJSON()),indexSignatures:this.indexSignatures.map(t=>t.toJSON()),annotations:ht(this.annotations)}}}const cg=e=>e.map(String).join("; "),h$=e=>{if(e.propertySignatures.length>0){const t=e.propertySignatures.map(String).join("; ");return e.indexSignatures.length>0?`{ ${t}; ${cg(e.indexSignatures)} }`:`{ ${t} }`}else return e.indexSignatures.length>0?`{ ${cg(e.indexSignatures)} }`:"{}"},ag=yr("TypeLiteral"),d$=ji(hb(_o,e=>{switch(e._tag){case"AnyKeyword":return 0;case"UnknownKeyword":return 1;case"ObjectKeyword":return 2;case"StringKeyword":case"NumberKeyword":case"BooleanKeyword":case"BigIntKeyword":case"SymbolKeyword":return 3}return 4})),p$={string:"StringKeyword",number:"NumberKeyword",boolean:"BooleanKeyword",bigint:"BigIntKeyword"},Vb=e=>Da(e,t=>Dd(t)?Vb(t.types):[t]),m$=e=>{const t=d$(e),n=[],r={},s=[];for(const o of t)switch(o._tag){case"NeverKeyword":break;case"AnyKeyword":return[s$];case"UnknownKeyword":return[Kb];case"ObjectKeyword":case"UndefinedKeyword":case"VoidKeyword":case"StringKeyword":case"NumberKeyword":case"BooleanKeyword":case"BigIntKeyword":case"SymbolKeyword":{r[o._tag]||(r[o._tag]=o,n.push(o));break}case"Literal":{const i=typeof o.literal;switch(i){case"string":case"number":case"bigint":case"boolean":{const c=p$[i];!r[c]&&!s.includes(o.literal)&&(s.push(o.literal),n.push(o));break}case"object":{s.includes(o.literal)||(s.push(o.literal),n.push(o));break}}break}case"UniqueSymbol":{!r.SymbolKeyword&&!s.includes(o.symbol)&&(s.push(o.symbol),n.push(o));break}case"TupleType":{r.ObjectKeyword||n.push(o);break}case"TypeLiteral":{o.propertySignatures.length===0&&o.indexSignatures.length===0?r["{}"]||(r["{}"]=o,n.push(o)):r.ObjectKeyword||n.push(o);break}default:n.push(o)}return n};let bn=class Xf{types;annotations;static make=(t,n)=>Hd(t)?new Xf(t,n):t.length===1?t[0]:Md;static unify=(t,n)=>Xf.make(m$(Vb(t)),n);_tag="Union";constructor(t,n={}){this.types=t,this.annotations=n}toString(){return qe(Un(this),()=>this.types.map(String).join(" | "))}toJSON(){return{_tag:this._tag,types:this.types.map(t=>t.toJSON()),annotations:ht(this.annotations)}}};const g$=(e,t)=>e.map(t),Hd=e=>e.length>1,Dd=yr("Union"),tf=be(Symbol.for("effect/Schema/AST/toJSONMemoMap"),()=>new WeakMap);class za{f;annotations;_tag="Suspend";constructor(t,n={}){this.f=t,this.annotations=n,this.f=_b(t)}toString(){return Un(this).pipe(ir(()=>Jo(tI(this.f)(),t=>Un(t))),qe(()=>"<suspended schema>"))}toJSON(){const t=this.f();let n=tf.get(t);return n||(tf.set(t,{_tag:this._tag}),n={_tag:this._tag,ast:t.toJSON(),annotations:ht(this.annotations)},tf.set(t,n),n)}}let qb=class{from;filter;annotations;_tag="Refinement";constructor(t,n,r={}){this.from=t,this.filter=n,this.annotations=r}toString(){return Ou(this).pipe(qe(()=>Fe(Xb(this),{onNone:()=>`{ ${this.from} | filter }`,onSome:t=>oo(this.from)?String(this.from)+" & "+t:t})))}toJSON(){return{_tag:this._tag,from:this.from.toJSON(),annotations:ht(this.annotations)}}};const oo=yr("Refinement"),nf={};let Qs=class{from;to;transformation;annotations;_tag="Transformation";constructor(t,n,r,s={}){this.from=t,this.to=n,this.transformation=r,this.annotations=s}toString(){return qe(Un(this),()=>`(${String(this.from)} <-> ${String(this.to)})`)}toJSON(){return{_tag:this._tag,from:this.from.toJSON(),to:this.to.toJSON(),annotations:ht(this.annotations)}}};const y$=yr("Transformation");class Wb{decode;encode;_tag="FinalTransformation";constructor(t,n){this.decode=t,this.encode=n}}const S$=e=>t=>t._tag===e;class b${_tag="ComposeTransformation"}const _$=new b$;let w$=class{from;to;decode;encode;constructor(t,n,r,s){this.from=t,this.to=n,this.decode=r,this.encode=s}};class Zf{propertySignatureTransformations;_tag="TypeLiteralTransformation";constructor(t){this.propertySignatureTransformations=t;const n={},r={};for(const s of t){const o=s.from;if(n[o])throw new Error(sg(o));n[o]=!0;const i=s.to;if(r[i])throw new Error(sg(i));r[i]=!0}}}const ug=S$("TypeLiteralTransformation"),Ud=(e,t)=>{const n=Object.getOwnPropertyDescriptors(e),r={...e.annotations};delete r[Ru];const s={...r,...t},o=Db(e);return $e(o)&&(s[Ka]=Ud(o.value,t)),n.annotations.value=s,Object.create(Object.getPrototypeOf(e),n)},v$="[\\s\\S]*?",T$="[+-]?\\d*\\.?\\d+(?:[Ee][+-]?\\d+)?",Jb=(e,t)=>{switch(e._tag){case"Literal":return Ua(String(e.literal));case"StringKeyword":return v$;case"NumberKeyword":return T$;case"TemplateLiteral":return Gb(e);case"Union":return e.types.map(n=>Jb(n)).join("|")}},k$=(e,t,n,r)=>Dd(e)?`(${t})`:t,Gb=(e,t,n)=>{let r="";if(e.head!==""){const s=Ua(e.head);r+=s}for(const s of e.spans){const o=Jb(s.type);if(r+=k$(s.type,o),s.literal!==""){const i=Ua(s.literal);r+=i}}return r},E$=e=>new RegExp(`^${Gb(e)}$`),lg=(e,t)=>{const n=[],r=[],s=o=>{switch(o._tag){case"NeverKeyword":break;case"StringKeyword":case"SymbolKeyword":case"TemplateLiteral":case"Refinement":r.push(new Fu(o,t,!0));break;case"Literal":if(gn(o.literal)||dr(o.literal))n.push(new $t(o.literal,t,!1,!0));else throw new Error(PI(o.literal));break;case"Enums":{for(const[i,c]of o.enums)n.push(new $t(c,t,!1,!0));break}case"UniqueSymbol":n.push(new $t(o.symbol,t,!1,!0));break;case"Union":o.types.forEach(s);break;default:throw new Error(OI(o))}};return s(e),{propertySignatures:n,indexSignatures:r}},Yb=e=>t=>{let n;for(const r of e)Object.prototype.hasOwnProperty.call(t.annotations,r)&&(n===void 0&&(n={}),n[r]=t.annotations[r]);return n},C$=e=>t=>{const n={...t.annotations};for(const r of e)delete n[r];return n},I$=Yb([Cb,Ib,$b,Ab,Rb,Ob]),lt=e=>{switch(e._tag){case"Declaration":{const t=ln(e.typeParameters,lt);return t===e.typeParameters?e:new Pu(t,e.decodeUnknown,e.encodeUnknown,e.annotations)}case"TupleType":{const t=ln(e.elements,s=>{const o=lt(s.type);return o===s.type?s:new ks(o,s.isOptional)}),n=jb(e.rest),r=ln(n,lt);return t===e.elements&&r===n?e:new Ld(t,r.map(s=>new xu(s)),e.isReadonly,e.annotations)}case"TypeLiteral":{const t=ln(e.propertySignatures,r=>{const s=lt(r.type);return s===r.type?r:new $t(r.name,s,r.isOptional,r.isReadonly)}),n=ln(e.indexSignatures,r=>{const s=lt(r.type);return s===r.type?r:new Fu(r.parameter,s,r.isReadonly)});return t===e.propertySignatures&&n===e.indexSignatures?e:new Ar(t,n,e.annotations)}case"Union":{const t=ln(e.types,lt);return t===e.types?e:bn.make(t,e.annotations)}case"Suspend":return new za(()=>lt(e.f()),e.annotations);case"Refinement":{const t=lt(e.from);return t===e.from?e:new qb(t,e.filter,e.annotations)}case"Transformation":{const t=I$(e);return lt(t!==void 0?Ud(e.to,t):e.to)}}return e};function ln(e,t){let n=!1;const r=Au(e.length);for(let s=0;s<e.length;s++){const o=e[s],i=t(o);i!==o&&(n=!0),r[s]=i}return n?r:e}const $n=(e,t)=>{switch(e._tag){case"Declaration":{const n=ln(e.typeParameters,r=>$n(r));return n===e.typeParameters?e:new Pu(n,e.decodeUnknown,e.encodeUnknown)}case"TupleType":{const n=ln(e.elements,o=>{const i=$n(o.type);return i===o.type?o:new ks(i,o.isOptional)}),r=jb(e.rest),s=ln(r,o=>$n(o));return n===e.elements&&s===r?e:new Ld(n,s.map(o=>new xu(o)),e.isReadonly)}case"TypeLiteral":{const n=ln(e.propertySignatures,s=>{const o=$n(s.type);return o===s.type?s:new $t(s.name,o,s.isOptional,s.isReadonly)}),r=ln(e.indexSignatures,s=>{const o=$n(s.type);return o===s.type?s:new Fu(s.parameter,o,s.isReadonly)});return n===e.propertySignatures&&r===e.indexSignatures?e:new Ar(n,r)}case"Union":{const n=ln(e.types,r=>$n(r));return n===e.types?e:bn.make(n)}case"Suspend":{let n;const r=QI(e);return $e(r)&&(n={[Ub]:`${r.value}Encoded`}),new za(()=>$n(e.f()),n)}case"Refinement":return $n(e.from);case"Transformation":return $n(e.from)}return e},eh=e=>$n(e),ht=e=>{const t={};for(const n of Object.getOwnPropertySymbols(e))t[String(n)]=e[n];return t},Qb=e=>{switch(e._tag){case"StringKeyword":case"SymbolKeyword":case"TemplateLiteral":return e;case"Refinement":return Qb(e.from)}},Kr=e=>qe(Un(e),()=>e._tag);function $$(e){return Fe(DI(e),{onNone:()=>"",onSome:t=>t.map(n=>` & Brand<${Dr(n)}>`).join("")})}const Xb=e=>Mb(e).pipe(ir(()=>Hb(e)),ir(()=>Lb(e)),ro(t=>t+$$(e))),Un=e=>ir(Ou(e),()=>Xb(e)),A$=Symbol.for("effect/Context/Tag"),Va=Symbol.for("effect/Context/Reference"),R$="effect/STM",O$=Symbol.for(R$),Zb={...gc,_op:"Tag",[O$]:bo,[A$]:{_Service:e=>e,_Identifier:e=>e},toString(){return at(this.toJSON())},toJSON(){return{_id:"Tag",key:this.key,stack:this.stack}},[Me](){return this.toJSON()},of(e){return e},context(e){return n_(this,e)}},P$={...Zb,[Va]:Va},x$=e=>{const t=Error.stackTraceLimit;Error.stackTraceLimit=2;const n=new Error;Error.stackTraceLimit=t;const r=Object.create(Zb);return Object.defineProperty(r,"stack",{get(){return n.stack}}),r.key=e,r},F$=()=>(e,t)=>{const n=Error.stackTraceLimit;Error.stackTraceLimit=2;const r=new Error;Error.stackTraceLimit=n;function s(){}return Object.setPrototypeOf(s,P$),s.key=e,s.defaultValue=t.defaultValue,Object.defineProperty(s,"stack",{get(){return r.stack}}),s},e_=Symbol.for("effect/Context"),N$={[e_]:{_Services:e=>e},[fe](e){if(t_(e)&&this.unsafeMap.size===e.unsafeMap.size){for(const t of this.unsafeMap.keys())if(!e.unsafeMap.has(t)||!oe(this.unsafeMap.get(t),e.unsafeMap.get(t)))return!1;return!0}return!1},[he](){return Ye(this,kd(this.unsafeMap.size))},pipe(){return G(this,arguments)},toString(){return at(this.toJSON())},toJSON(){return{_id:"Context",services:Array.from(this.unsafeMap).map(Ge)}},[Me](){return this.toJSON()}},ps=e=>{const t=Object.create(N$);return t.unsafeMap=e,t},B$=e=>{const t=new Error(`Service not found${e.key?`: ${String(e.key)}`:""}`);if(e.stack){const n=e.stack.split(`
`);if(n.length>2){const r=n[2].match(/at (.*)/);r&&(t.message=t.message+` (defined at ${r[1]})`)}}if(t.stack){const n=t.stack.split(`
`);n.splice(1,3),t.stack=n.join(`
`)}return t},t_=e=>te(e,e_),M$=e=>te(e,Va),L$=ps(new Map),H$=()=>L$,n_=(e,t)=>ps(new Map([[e.key,t]])),D$=d(3,(e,t,n)=>{const r=new Map(e.unsafeMap);return r.set(t.key,n),ps(r)}),rf=be("effect/Context/defaultValueCache",()=>new Map),Kd=e=>{if(rf.has(e.key))return rf.get(e.key);const t=e.defaultValue();return rf.set(e.key,t),t},U$=(e,t)=>e.unsafeMap.has(t.key)?e.unsafeMap.get(t.key):Kd(t),r_=d(2,(e,t)=>{if(!e.unsafeMap.has(t.key)){if(Va in t)return Kd(t);throw B$(t)}return e.unsafeMap.get(t.key)}),K$=r_,j$=d(2,(e,t)=>e.unsafeMap.has(t.key)?La(e.unsafeMap.get(t.key)):M$(t)?La(Kd(t)):Pd),z$=d(2,(e,t)=>{const n=new Map(e.unsafeMap);for(const[r,s]of t.unsafeMap)n.set(r,s);return ps(n)}),V$=(...e)=>{const t=new Map;for(let n=0;n<e.length;n++)e[n].unsafeMap.forEach((r,s)=>{t.set(s,r)});return ps(t)},Es=x$,q$=t_,jd=H$,W$=n_,Yr=D$,s_=K$,o_=r_,Sc=j$,Nu=z$,J$=V$,Bu=F$,i_=Symbol.for("effect/Chunk");function G$(e,t,n,r,s){for(let o=t;o<Math.min(e.length,t+s);o++)n[r+o-t]=e[o];return n}const c_=[],Y$=e=>Tu((t,n)=>t.length===n.length&&cr(t).every((r,s)=>e(r,ar(n,s)))),Q$=Y$(oe),X$={[i_]:{_A:e=>e},toString(){return at(this.toJSON())},toJSON(){return{_id:"Chunk",values:cr(this).map(Ge)}},[Me](){return this.toJSON()},[fe](e){return zd(e)&&Q$(this,e)},[he](){return Ye(this,mc(cr(this)))},[Symbol.iterator](){switch(this.backing._tag){case"IArray":return this.backing.array[Symbol.iterator]();case"IEmpty":return c_[Symbol.iterator]();default:return cr(this)[Symbol.iterator]()}},pipe(){return G(this,arguments)}},Xe=e=>{const t=Object.create(X$);switch(t.backing=e,e._tag){case"IEmpty":{t.length=0,t.depth=0,t.left=t,t.right=t;break}case"IConcat":{t.length=e.left.length+e.right.length,t.depth=1+Math.max(e.left.depth,e.right.depth),t.left=e.left,t.right=e.right;break}case"IArray":{t.length=e.array.length,t.depth=0,t.left=_n,t.right=_n;break}case"ISingleton":{t.length=1,t.depth=0,t.left=_n,t.right=_n;break}case"ISlice":{t.length=e.length,t.depth=e.chunk.depth+1,t.left=_n,t.right=_n;break}}return t},zd=e=>te(e,i_),_n=Xe({_tag:"IEmpty"}),We=()=>_n,ma=(...e)=>nA(e),Be=e=>Xe({_tag:"ISingleton",a:e}),zi=e=>zd(e)?e:sn(Ne(e)),th=(e,t,n)=>{switch(e.backing._tag){case"IArray":{G$(e.backing.array,0,t,n,e.length);break}case"IConcat":{th(e.left,t,n),th(e.right,t,n+e.left.length);break}case"ISingleton":{t[n]=e.backing.a;break}case"ISlice":{let r=0,s=n;for(;r<e.length;)t[s]=ar(e,r),r+=1,s+=1;break}}},Z$=e=>{switch(e.backing._tag){case"IEmpty":return c_;case"IArray":return e.backing.array;default:{const t=new Array(e.length);return th(e,t,0),e.backing={_tag:"IArray",array:t},e.left=_n,e.right=_n,e.depth=0,t}}},cr=Z$,eA=e=>{switch(e.backing._tag){case"IEmpty":case"ISingleton":return e;case"IArray":return Xe({_tag:"IArray",array:Zm(e.backing.array)});case"IConcat":return Xe({_tag:"IConcat",left:pr(e.backing.right),right:pr(e.backing.left)});case"ISlice":return sn(Zm(cr(e)))}},pr=eA,tA=d(2,(e,t)=>t<0||t>=e.length?K():U(ar(e,t))),sn=e=>e.length===0?We():e.length===1?Be(e[0]):Xe({_tag:"IArray",array:e}),nA=e=>sn(e),ar=d(2,(e,t)=>{switch(e.backing._tag){case"IEmpty":throw new Error("Index out of bounds");case"ISingleton":{if(t!==0)throw new Error("Index out of bounds");return e.backing.a}case"IArray":{if(t>=e.length||t<0)throw new Error("Index out of bounds");return e.backing.array[t]}case"IConcat":return t<e.left.length?ar(e.left,t):ar(e.right,t-e.left.length);case"ISlice":return ar(e.backing.chunk,t+e.backing.offset)}}),wo=d(2,(e,t)=>bt(e,Be(t))),Nt=d(2,(e,t)=>bt(Be(t),e)),nh=d(2,(e,t)=>{if(t<=0)return _n;if(t>=e.length)return e;switch(e.backing._tag){case"ISlice":return Xe({_tag:"ISlice",chunk:e.backing.chunk,length:t,offset:e.backing.offset});case"IConcat":return t>e.left.length?Xe({_tag:"IConcat",left:e.left,right:nh(e.right,t-e.left.length)}):nh(e.left,t);default:return Xe({_tag:"ISlice",chunk:e,offset:0,length:t})}}),Vi=d(2,(e,t)=>{if(t<=0)return e;if(t>=e.length)return _n;switch(e.backing._tag){case"ISlice":return Xe({_tag:"ISlice",chunk:e.backing.chunk,offset:e.backing.offset+t,length:e.backing.length-t});case"IConcat":return t>e.left.length?Vi(e.right,t-e.left.length):Xe({_tag:"IConcat",left:Vi(e.left,t),right:e.right});default:return Xe({_tag:"ISlice",chunk:e,offset:t,length:e.length-t})}}),bt=d(2,(e,t)=>{if(e.backing._tag==="IEmpty")return t;if(t.backing._tag==="IEmpty")return e;const n=t.depth-e.depth;if(Math.abs(n)<=1)return Xe({_tag:"IConcat",left:e,right:t});if(n<-1)if(e.left.depth>=e.right.depth){const r=bt(e.right,t);return Xe({_tag:"IConcat",left:e.left,right:r})}else{const r=bt(e.right.right,t);if(r.depth===e.depth-3){const s=Xe({_tag:"IConcat",left:e.right.left,right:r});return Xe({_tag:"IConcat",left:e.left,right:s})}else{const s=Xe({_tag:"IConcat",left:e.left,right:e.right.left});return Xe({_tag:"IConcat",left:s,right:r})}}else if(t.right.depth>=t.left.depth){const r=bt(e,t.left);return Xe({_tag:"IConcat",left:r,right:t.right})}else{const r=bt(e,t.left.left);if(r.depth===t.depth-3){const s=Xe({_tag:"IConcat",left:r,right:t.left.right});return Xe({_tag:"IConcat",left:s,right:t.right})}else{const s=Xe({_tag:"IConcat",left:t.left.right,right:t.right});return Xe({_tag:"IConcat",left:r,right:s})}}}),a_=d(2,(e,t)=>sn($I(e,t))),Mu=d(2,(e,t)=>sn(AI(e,t))),Lu=e=>e.length===0,Kn=e=>e.length>0,Vd=tA(0),u_=e=>ar(e,0),Fn=u_,l_=d(2,(e,t)=>e.backing._tag==="ISingleton"?Be(t(e.backing.a,0)):sn(p(cr(e),os((n,r)=>t(n,r))))),rA=d(2,(e,t)=>[nh(e,t),Vi(e,t)]),sA=d(2,(e,t)=>{let n=0;for(const r of cr(e)){if(t(r))break;n++}return rA(e,n)}),sr=e=>Vi(e,1),f_=Fd,rh=Symbol.for("effect/Duration"),h_=BigInt(0),fg=BigInt(24),Wc=BigInt(60),sh=BigInt(1e3),hg=BigInt(1e6),dg=BigInt(1e9),oA=/^(-?\d+(?:\.\d+)?)\s+(nanos?|micros?|millis?|seconds?|minutes?|hours?|days?|weeks?)$/,Wt=e=>{if(d_(e))return e;if(dr(e))return ie(e);if(ku(e))return sf(e);if(Array.isArray(e)&&e.length===2&&e.every(dr))return e[0]===-1/0||e[1]===-1/0||Number.isNaN(e[0])||Number.isNaN(e[1])?vo:e[0]===1/0||e[1]===1/0?uA:sf(BigInt(Math.round(e[0]*1e9))+BigInt(Math.round(e[1])));if(gn(e)){const t=oA.exec(e);if(t){const[n,r,s]=t,o=Number(r);switch(s){case"nano":case"nanos":return sf(BigInt(r));case"micro":case"micros":return lA(BigInt(r));case"milli":case"millis":return ie(o);case"second":case"seconds":return qd(o);case"minute":case"minutes":return fA(o);case"hour":case"hours":return hA(o);case"day":case"days":return dA(o);case"week":case"weeks":return pA(o)}}}throw new Error("Invalid DurationInput")},pg={_tag:"Millis",millis:0},iA={_tag:"Infinity"},cA={[rh]:rh,[he](){return Ye(this,YS(this.value))},[fe](e){return d_(e)&&vA(this,e)},toString(){return`Duration(${kA(this)})`},toJSON(){switch(this.value._tag){case"Millis":return{_id:"Duration",_tag:"Millis",millis:this.value.millis};case"Nanos":return{_id:"Duration",_tag:"Nanos",hrtime:gA(this)};case"Infinity":return{_id:"Duration",_tag:"Infinity"}}},[Me](){return this.toJSON()},pipe(){return G(this,arguments)}},Jt=e=>{const t=Object.create(cA);return dr(e)?isNaN(e)||e<=0?t.value=pg:Number.isFinite(e)?Number.isInteger(e)?t.value={_tag:"Millis",millis:e}:t.value={_tag:"Nanos",nanos:BigInt(Math.round(e*1e6))}:t.value=iA:e<=h_?t.value=pg:t.value={_tag:"Nanos",nanos:e},t},d_=e=>te(e,rh),aA=e=>{switch(e.value._tag){case"Millis":return e.value.millis===0;case"Nanos":return e.value.nanos===h_;case"Infinity":return!1}},vo=Jt(0),uA=Jt(1/0),sf=e=>Jt(e),lA=e=>Jt(e*sh),ie=e=>Jt(e),qd=e=>Jt(e*1e3),fA=e=>Jt(e*6e4),hA=e=>Jt(e*36e5),dA=e=>Jt(e*864e5),pA=e=>Jt(e*6048e5),qi=e=>p_(e,{onMillis:t=>t,onNanos:t=>Number(t)/1e6}),mA=e=>{const t=Wt(e);switch(t.value._tag){case"Infinity":throw new Error("Cannot convert infinite duration to nanos");case"Nanos":return t.value.nanos;case"Millis":return BigInt(Math.round(t.value.millis*1e6))}},gA=e=>{const t=Wt(e);switch(t.value._tag){case"Infinity":return[1/0,0];case"Nanos":return[Number(t.value.nanos/dg),Number(t.value.nanos%dg)];case"Millis":return[Math.floor(t.value.millis/1e3),Math.round(t.value.millis%1e3*1e6)]}},p_=d(2,(e,t)=>{const n=Wt(e);switch(n.value._tag){case"Nanos":return t.onNanos(n.value.nanos);case"Infinity":return t.onMillis(1/0);case"Millis":return t.onMillis(n.value.millis)}}),Hu=d(3,(e,t,n)=>{const r=Wt(e),s=Wt(t);if(r.value._tag==="Infinity"||s.value._tag==="Infinity")return n.onMillis(qi(r),qi(s));if(r.value._tag==="Nanos"||s.value._tag==="Nanos"){const o=r.value._tag==="Nanos"?r.value.nanos:BigInt(Math.round(r.value.millis*1e6)),i=s.value._tag==="Nanos"?s.value.nanos:BigInt(Math.round(s.value.millis*1e6));return n.onNanos(o,i)}return n.onMillis(r.value.millis,s.value.millis)}),yA=(e,t)=>Hu(e,t,{onMillis:(n,r)=>n===r,onNanos:(n,r)=>n===r}),SA=d(2,(e,t)=>p_(e,{onMillis:n=>Jt(n*t),onNanos:n=>Jt(n*BigInt(t))})),bA=d(2,(e,t)=>Hu(e,t,{onMillis:(n,r)=>Jt(n+r),onNanos:(n,r)=>Jt(n+r)})),_A=d(2,(e,t)=>Hu(e,t,{onMillis:(n,r)=>n<=r,onNanos:(n,r)=>n<=r})),wA=d(2,(e,t)=>Hu(e,t,{onMillis:(n,r)=>n>=r,onNanos:(n,r)=>n>=r})),vA=d(2,(e,t)=>yA(Wt(e),Wt(t))),TA=e=>{const t=Wt(e);if(t.value._tag==="Infinity")return{days:1/0,hours:1/0,minutes:1/0,seconds:1/0,millis:1/0,nanos:1/0};const n=mA(t),r=n/hg,s=r/sh,o=s/Wc,i=o/Wc,c=i/fg;return{days:Number(c),hours:Number(i%fg),minutes:Number(o%Wc),seconds:Number(s%Wc),millis:Number(r%sh),nanos:Number(n%hg)}},kA=e=>{const t=Wt(e);if(t.value._tag==="Infinity")return"Infinity";if(aA(t))return"0";const n=TA(t),r=[];return n.days!==0&&r.push(`${n.days}d`),n.hours!==0&&r.push(`${n.hours}h`),n.minutes!==0&&r.push(`${n.minutes}m`),n.seconds!==0&&r.push(`${n.seconds}s`),n.millis!==0&&r.push(`${n.millis}ms`),n.nanos!==0&&r.push(`${n.nanos}ns`),r.join(" ")},ms=5,Wd=Math.pow(2,ms),EA=Wd-1,CA=Wd/2,IA=Wd/4;function $A(e){return e-=e>>1&1431655765,e=(e&858993459)+(e>>2&858993459),e=e+(e>>4)&252645135,e+=e>>8,e+=e>>16,e&127}function To(e,t){return t>>>e&EA}function Xs(e){return 1<<e}function m_(e,t){return $A(e&t-1)}const AA=(e,t)=>({value:e,previous:t});function io(e,t,n,r){let s=r;if(!e){const o=r.length;s=new Array(o);for(let i=0;i<o;++i)s[i]=r[i]}return s[t]=n,s}function g_(e,t,n){const r=n.length-1;let s=0,o=0,i=n;if(e)s=o=t;else for(i=new Array(r);s<t;)i[o++]=n[s++];for(++s;s<=r;)i[o++]=n[s++];return e&&(i.length=r),i}function RA(e,t,n,r){const s=r.length;if(e){let a=s;for(;a>=t;)r[a--]=r[a];return r[t]=n,r}let o=0,i=0;const c=new Array(s+1);for(;o<t;)c[i++]=r[o++];for(c[t]=n;o<s;)c[++i]=r[o++];return c}class Pr{_tag="EmptyNode";modify(t,n,r,s,o,i){const c=r(K());return Ue(c)?new Pr:(++i.value,new is(t,s,o,c))}}function wn(e){return VS(e,"EmptyNode")}function OA(e){return wn(e)||e._tag==="LeafNode"||e._tag==="CollisionNode"}function Du(e,t){return wn(e)?!1:t===e.edit}class is{edit;hash;key;value;_tag="LeafNode";constructor(t,n,r,s){this.edit=t,this.hash=n,this.key=r,this.value=s}modify(t,n,r,s,o,i){if(oe(o,this.key)){const a=r(this.value);return a===this.value?this:Ue(a)?(--i.value,new Pr):Du(this,t)?(this.value=a,this):new is(t,s,o,a)}const c=r(K());return Ue(c)?this:(++i.value,y_(t,n,this.hash,this,s,new is(t,s,o,c)))}}class Jd{edit;hash;children;_tag="CollisionNode";constructor(t,n,r){this.edit=t,this.hash=n,this.children=r}modify(t,n,r,s,o,i){if(s===this.hash){const a=Du(this,t),u=this.updateCollisionList(a,t,this.hash,this.children,r,o,i);return u===this.children?this:u.length>1?new Jd(t,this.hash,u):u[0]}const c=r(K());return Ue(c)?this:(++i.value,y_(t,n,this.hash,this,s,new is(t,s,o,c)))}updateCollisionList(t,n,r,s,o,i,c){const a=s.length;for(let l=0;l<a;++l){const f=s[l];if("key"in f&&oe(i,f.key)){const h=f.value,m=o(h);return m===h?s:Ue(m)?(--c.value,g_(t,l,s)):io(t,l,new is(n,r,i,m),s)}}const u=o(K());return Ue(u)?s:(++c.value,io(t,a,new is(n,r,i,u),s))}}class ko{edit;mask;children;_tag="IndexedNode";constructor(t,n,r){this.edit=t,this.mask=n,this.children=r}modify(t,n,r,s,o,i){const c=this.mask,a=this.children,u=To(n,s),l=Xs(u),f=m_(c,l),h=c&l,m=Du(this,t);if(!h){const C=new Pr().modify(t,n+ms,r,s,o,i);return C?a.length>=CA?xA(t,u,C,c,a):new ko(t,c|l,RA(m,f,C,a)):this}const y=a[f],b=y.modify(t,n+ms,r,s,o,i);if(y===b)return this;let _=c,T;if(wn(b)){if(_&=~l,!_)return new Pr;if(a.length<=2&&OA(a[f^1]))return a[f^1];T=g_(m,f,a)}else T=io(m,f,b,a);return m?(this.mask=_,this.children=T,this):new ko(t,_,T)}}class Gd{edit;size;children;_tag="ArrayNode";constructor(t,n,r){this.edit=t,this.size=n,this.children=r}modify(t,n,r,s,o,i){let c=this.size;const a=this.children,u=To(n,s),l=a[u],f=(l||new Pr).modify(t,n+ms,r,s,o,i);if(l===f)return this;const h=Du(this,t);let m;if(wn(l)&&!wn(f))++c,m=io(h,u,f,a);else if(!wn(l)&&wn(f)){if(--c,c<=IA)return PA(t,c,u,a);m=io(h,u,new Pr,a)}else m=io(h,u,f,a);return h?(this.size=c,this.children=m,this):new Gd(t,c,m)}}function PA(e,t,n,r){const s=new Array(t-1);let o=0,i=0;for(let c=0,a=r.length;c<a;++c)if(c!==n){const u=r[c];u&&!wn(u)&&(s[o++]=u,i|=1<<c)}return new ko(e,i,s)}function xA(e,t,n,r,s){const o=[];let i=r,c=0;for(let a=0;i;++a)i&1&&(o[a]=s[c++]),i>>>=1;return o[t]=n,new Gd(e,c+1,o)}function FA(e,t,n,r,s,o){if(n===s)return new Jd(e,n,[o,r]);const i=To(t,n),c=To(t,s);if(i===c)return a=>new ko(e,Xs(i)|Xs(c),[a]);{const a=i<c?[r,o]:[o,r];return new ko(e,Xs(i)|Xs(c),a)}}function y_(e,t,n,r,s,o){let i,c=t;for(;;){const a=FA(e,c,n,r,s,o);if(typeof a=="function")i=AA(a,i),c=c+ms;else{let u=a;for(;i!=null;)u=i.value(u),i=i.previous;return u}}}const S_="effect/HashMap",oh=Symbol.for(S_),NA={[oh]:oh,[Symbol.iterator](){return new Uu(this,(e,t)=>[e,t])},[he](){let e=Y(S_);for(const t of this)e^=p(Y(t[0]),ye(Y(t[1])));return Ye(this,e)},[fe](e){if(LA(e)){if(e._size!==this._size)return!1;for(const t of this){const n=p(e,Qd(t[0],Y(t[0])));if(Ue(n))return!1;if(!oe(t[1],n.value))return!1}return!0}return!1},toString(){return at(this.toJSON())},toJSON(){return{_id:"HashMap",values:Array.from(this).map(Ge)}},[Me](){return this.toJSON()},pipe(){return G(this,arguments)}},Yd=(e,t,n,r)=>{const s=Object.create(NA);return s._editable=e,s._edit=t,s._root=n,s._size=r,s};class Uu{map;f;v;constructor(t,n){this.map=t,this.f=n,this.v=b_(this.map._root,this.f,void 0)}next(){if(Ue(this.v))return{done:!0,value:void 0};const t=this.v.value;return this.v=qa(t.cont),{done:!1,value:t.value}}[Symbol.iterator](){return new Uu(this.map,this.f)}}const qa=e=>e?__(e[0],e[1],e[2],e[3],e[4]):K(),b_=(e,t,n=void 0)=>{switch(e._tag){case"LeafNode":return $e(e.value)?U({value:t(e.key,e.value.value),cont:n}):qa(n);case"CollisionNode":case"ArrayNode":case"IndexedNode":{const r=e.children;return __(r.length,r,0,t,n)}default:return qa(n)}},__=(e,t,n,r,s)=>{for(;n<e;){const o=t[n++];if(o&&!wn(o))return b_(o,r,[e,t,n,r,s])}return qa(s)},BA=Yd(!1,0,new Pr,0),Ku=()=>BA,MA=e=>{const t=v_(Ku());for(const n of e)Wi(t,n[0],n[1]);return jA(t)},LA=e=>te(e,oh),HA=e=>e&&wn(e._root),DA=d(2,(e,t)=>Qd(e,t,Y(t))),Qd=d(3,(e,t,n)=>{let r=e._root,s=0;for(;;)switch(r._tag){case"LeafNode":return oe(t,r.key)?r.value:K();case"CollisionNode":{if(n===r.hash){const o=r.children;for(let i=0,c=o.length;i<c;++i){const a=o[i];if("key"in a&&oe(t,a.key))return a.value}}return K()}case"IndexedNode":{const o=To(s,n),i=Xs(o);if(r.mask&i){r=r.children[m_(r.mask,i)],s+=ms;break}return K()}case"ArrayNode":{if(r=r.children[To(s,n)],r){s+=ms;break}return K()}default:return K()}}),UA=d(2,(e,t)=>$e(Qd(e,t,Y(t)))),Wi=d(3,(e,t,n)=>Xd(e,t,()=>U(n))),KA=d(3,(e,t,n)=>e._editable?(e._root=t,e._size=n,e):t===e._root?e:Yd(e._editable,e._edit,t,n)),w_=e=>new Uu(e,t=>t),ih=e=>e._size,v_=e=>Yd(!0,e._edit+1,e._root,e._size),jA=e=>(e._editable=!1,e),Xd=d(3,(e,t,n)=>zA(e,t,Y(t),n)),zA=d(4,(e,t,n,r)=>{const s={value:e._size},o=e._root.modify(e._editable?e._edit:NaN,0,r,n,t,s);return p(e,KA(o,s.value))}),mg=d(2,(e,t)=>Xd(e,t,K)),VA=d(2,(e,t)=>ju(e,Ku(),(n,r,s)=>Wi(n,s,t(r,s)))),qA=d(2,(e,t)=>ju(e,void 0,(n,r,s)=>t(r,s))),ju=d(3,(e,t,n)=>{const r=e._root;if(r._tag==="LeafNode")return $e(r.value)?n(t,r.value.value,r.key):t;if(r._tag==="EmptyNode")return t;const s=[r.children];let o;for(;o=s.pop();)for(let i=0,c=o.length;i<c;){const a=o[i++];a&&!wn(a)&&(a._tag==="LeafNode"?$e(a.value)&&(t=n(t,a.value.value,a.key)):s.push(a.children))}return t}),T_="effect/HashSet",ch=Symbol.for(T_),WA={[ch]:ch,[Symbol.iterator](){return w_(this._keyMap)},[he](){return Ye(this,ye(Y(this._keyMap))(Y(T_)))},[fe](e){return JA(e)?ih(this._keyMap)===ih(e._keyMap)&&oe(this._keyMap,e._keyMap):!1},toString(){return at(this.toJSON())},toJSON(){return{_id:"HashSet",values:Array.from(this).map(Ge)}},[Me](){return this.toJSON()},pipe(){return G(this,arguments)}},zu=e=>{const t=Object.create(WA);return t._keyMap=e,t},JA=e=>te(e,ch),GA=zu(Ku()),Vu=()=>GA,YA=e=>{const t=Zd(Vu());for(const n of e)Ji(t,n);return ep(t)},QA=(...e)=>{const t=Zd(Vu());for(const n of e)Ji(t,n);return ep(t)},XA=d(2,(e,t)=>UA(e._keyMap,t)),ZA=e=>ih(e._keyMap),Zd=e=>zu(v_(e._keyMap)),ep=e=>(e._keyMap._editable=!1,e),k_=d(2,(e,t)=>{const n=Zd(e);return t(n),ep(n)}),Ji=d(2,(e,t)=>e._keyMap._editable?(Wi(t,!0)(e._keyMap),e):zu(Wi(t,!0)(e._keyMap))),E_=d(2,(e,t)=>e._keyMap._editable?(mg(t)(e._keyMap),e):zu(mg(t)(e._keyMap))),eR=d(2,(e,t)=>k_(e,n=>{for(const r of t)E_(n,r)})),tR=d(2,(e,t)=>k_(Vu(),n=>{nR(e,r=>Ji(n,r));for(const r of t)Ji(n,r)})),nR=d(2,(e,t)=>qA(e._keyMap,(n,r)=>t(r))),rR=d(3,(e,t,n)=>ju(e._keyMap,t,(r,s,o)=>n(r,o))),gs=Vu,sR=YA,tp=QA,oR=XA,np=ZA,Fi=Ji,C_=E_,gg=eR,Gi=tR,Yi=rR,yg=Symbol.for("effect/MutableRef"),iR={[yg]:yg,toString(){return at(this.toJSON())},toJSON(){return{_id:"MutableRef",current:Ge(this.current)}},[Me](){return this.toJSON()},pipe(){return G(this,arguments)}},Cs=e=>{const t=Object.create(iR);return t.current=e,t},cR=d(3,(e,t,n)=>oe(t,e.current)?(e.current=n,!0):!1),_e=e=>e.current,Is=d(2,(e,t)=>(e.current=t,e)),qu="effect/FiberId",ys=Symbol.for(qu),Eo="None",ah="Runtime",uh="Composite",aR=Ze(`${qu}-${Eo}`);let uR=class{[ys]=ys;_tag=Eo;id=-1;startTimeMillis=-1;[he](){return aR}[fe](t){return rp(t)&&t._tag===Eo}toString(){return at(this.toJSON())}toJSON(){return{_id:"FiberId",_tag:this._tag}}[Me](){return this.toJSON()}};class lR{id;startTimeMillis;[ys]=ys;_tag=ah;constructor(t,n){this.id=t,this.startTimeMillis=n}[he](){return Ye(this,Ze(`${qu}-${this._tag}-${this.id}-${this.startTimeMillis}`))}[fe](t){return rp(t)&&t._tag===ah&&this.id===t.id&&this.startTimeMillis===t.startTimeMillis}toString(){return at(this.toJSON())}toJSON(){return{_id:"FiberId",_tag:this._tag,id:this.id,startTimeMillis:this.startTimeMillis}}[Me](){return this.toJSON()}}let fR=class{left;right;[ys]=ys;_tag=uh;constructor(t,n){this.left=t,this.right=n}_hash;[he](){return p(Ze(`${qu}-${this._tag}`),ye(Y(this.left)),ye(Y(this.right)),Ye(this))}[fe](t){return rp(t)&&t._tag===uh&&oe(this.left,t.left)&&oe(this.right,t.right)}toString(){return at(this.toJSON())}toJSON(){return{_id:"FiberId",_tag:this._tag,left:Ge(this.left),right:Ge(this.right)}}[Me](){return this.toJSON()}};const I_=new uR,rp=e=>te(e,ys),$_=d(2,(e,t)=>e._tag===Eo?t:t._tag===Eo?e:new fR(e,t)),hR=e=>p(e,Yi(I_,(t,n)=>$_(n)(t))),lh=e=>{switch(e._tag){case Eo:return gs();case ah:return tp(e.id);case uh:return p(lh(e.left),Gi(lh(e.right)))}},Sg=be(Symbol.for("effect/Fiber/Id/_fiberCounter"),()=>Cs(0)),A_=e=>Array.from(lh(e)).map(n=>`#${n}`).join(","),dR=()=>{const e=_e(Sg);return p(Sg,Is(e+1)),new lR(e,Date.now())},Co=I_,pR=$_,mR=hR,gR=A_,R_=dR,sp=Ku,yR=MA,SR=HA,O_=DA,P_=Wi,x_=w_,bR=Xd,_R=VA,F_=ju,Qi=Symbol.for("effect/List"),fh=e=>Ne(e),wR=e=>nC(Nd(e),fh),vR=wR(oe),TR={[Qi]:Qi,_tag:"Cons",toString(){return at(this.toJSON())},toJSON(){return{_id:"List",_tag:"Cons",values:fh(this).map(Ge)}},[Me](){return this.toJSON()},[fe](e){return B_(e)&&this._tag===e._tag&&vR(this,e)},[he](){return Ye(this,mc(fh(this)))},[Symbol.iterator](){let e=!1,t=this;return{next(){if(e)return this.return();if(t._tag==="Nil")return e=!0,this.return();const n=t.head;return t=t.tail,{done:e,value:n}},return(n){return e||(e=!0),{done:!0,value:n}}}},pipe(){return G(this,arguments)}},Wa=(e,t)=>{const n=Object.create(TR);return n.head=e,n.tail=t,n},kR=Ze("Nil"),ER={[Qi]:Qi,_tag:"Nil",toString(){return at(this.toJSON())},toJSON(){return{_id:"List",_tag:"Nil"}},[Me](){return this.toJSON()},[he](){return kR},[fe](e){return B_(e)&&this._tag===e._tag},[Symbol.iterator](){return{next(){return{done:!0,value:void 0}}}},pipe(){return G(this,arguments)}},N_=Object.create(ER),B_=e=>te(e,Qi),ur=e=>e._tag==="Nil",CR=e=>e._tag==="Cons",IR=()=>N_,Ss=(e,t)=>Wa(e,t),Io=IR,op=e=>Wa(e,N_),$R=d(2,(e,t)=>RR(t,e)),AR=d(2,(e,t)=>Ss(t,e)),RR=d(2,(e,t)=>{if(ur(e))return t;if(ur(t))return e;{const n=Wa(t.head,e);let r=n,s=t.tail;for(;!ur(s);){const o=Wa(s.head,e);r.tail=o,r=o,s=s.tail}return n}}),OR=d(3,(e,t,n)=>{let r=t,s=e;for(;!ur(s);)r=n(r,s.head),s=s.tail;return r}),PR=e=>{let t=Io(),n=e;for(;!ur(n);)t=AR(t,n.head),n=n.tail;return t},Wu=(function(){function e(t){t&&Object.assign(this,t)}return e.prototype=Rd,e})(),xR=Symbol.for("effect/DifferContextPatch");function bg(e){return e}const bc={...Wu.prototype,[xR]:{_Value:bg,_Patch:bg}},FR=Object.assign(Object.create(bc),{_tag:"Empty"}),NR=Object.create(FR),M_=()=>NR,BR=Object.assign(Object.create(bc),{_tag:"AndThen"}),MR=(e,t)=>{const n=Object.create(BR);return n.first=e,n.second=t,n},LR=Object.assign(Object.create(bc),{_tag:"AddService"}),HR=(e,t)=>{const n=Object.create(LR);return n.key=e,n.service=t,n},DR=Object.assign(Object.create(bc),{_tag:"RemoveService"}),UR=e=>{const t=Object.create(DR);return t.key=e,t},KR=Object.assign(Object.create(bc),{_tag:"UpdateService"}),jR=(e,t)=>{const n=Object.create(KR);return n.key=e,n.update=t,n},zR=(e,t)=>{const n=new Map(e.unsafeMap);let r=M_();for(const[s,o]of t.unsafeMap.entries())if(n.has(s)){const i=n.get(s);n.delete(s),oe(i,o)||(r=ga(jR(s,()=>o))(r))}else n.delete(s),r=ga(HR(s,o))(r);for(const[s]of n.entries())r=ga(UR(s))(r);return r},ga=d(2,(e,t)=>MR(e,t)),VR=d(2,(e,t)=>{if(e._tag==="Empty")return t;let n=!1,r=Be(e);const s=new Map(t.unsafeMap);for(;Kn(r);){const i=Fn(r),c=sr(r);switch(i._tag){case"Empty":{r=c;break}case"AddService":{s.set(i.key,i.service),r=c;break}case"AndThen":{r=Nt(Nt(c,i.second),i.first);break}case"RemoveService":{s.delete(i.key),r=c;break}case"UpdateService":{s.set(i.key,i.update(s.get(i.key))),n=!0,r=c;break}}}if(!n)return ps(s);const o=new Map;for(const[i]of t.unsafeMap)s.has(i)&&(o.set(i,s.get(i)),s.delete(i));for(const[i,c]of s)o.set(i,c);return ps(o)}),qR=Symbol.for("effect/DifferHashSetPatch");function of(e){return e}const Ju={...Wu.prototype,[qR]:{_Value:of,_Key:of,_Patch:of}},WR=Object.assign(Object.create(Ju),{_tag:"Empty"}),JR=Object.create(WR),L_=()=>JR,GR=Object.assign(Object.create(Ju),{_tag:"AndThen"}),YR=(e,t)=>{const n=Object.create(GR);return n.first=e,n.second=t,n},QR=Object.assign(Object.create(Ju),{_tag:"Add"}),XR=e=>{const t=Object.create(QR);return t.value=e,t},ZR=Object.assign(Object.create(Ju),{_tag:"Remove"}),e1=e=>{const t=Object.create(ZR);return t.value=e,t},t1=(e,t)=>{const[n,r]=Yi([e,L_()],([s,o],i)=>oR(i)(s)?[C_(i)(s),o]:[s,hh(XR(i))(o)])(t);return Yi(r,(s,o)=>hh(e1(o))(s))(n)},hh=d(2,(e,t)=>YR(e,t)),n1=d(2,(e,t)=>{if(e._tag==="Empty")return t;let n=t,r=Be(e);for(;Kn(r);){const s=Fn(r),o=sr(r);switch(s._tag){case"Empty":{r=o;break}case"AndThen":{r=Nt(s.first)(Nt(s.second)(o));break}case"Add":{n=Fi(s.value)(n),r=o;break}case"Remove":n=C_(s.value)(n),r=o}}return n}),r1=Symbol.for("effect/DifferReadonlyArrayPatch");function _g(e){return e}const _c={...Wu.prototype,[r1]:{_Value:_g,_Patch:_g}},s1=Object.assign(Object.create(_c),{_tag:"Empty"}),o1=Object.create(s1),H_=()=>o1,i1=Object.assign(Object.create(_c),{_tag:"AndThen"}),c1=(e,t)=>{const n=Object.create(i1);return n.first=e,n.second=t,n},a1=Object.assign(Object.create(_c),{_tag:"Append"}),u1=e=>{const t=Object.create(a1);return t.values=e,t},l1=Object.assign(Object.create(_c),{_tag:"Slice"}),f1=(e,t)=>{const n=Object.create(l1);return n.from=e,n.until=t,n},h1=Object.assign(Object.create(_c),{_tag:"Update"}),d1=(e,t)=>{const n=Object.create(h1);return n.index=e,n.patch=t,n},p1=e=>{let t=0,n=H_();for(;t<e.oldValue.length&&t<e.newValue.length;){const r=e.oldValue[t],s=e.newValue[t],o=e.differ.diff(r,s);oe(o,e.differ.empty)||(n=ya(n,d1(t,o))),t=t+1}return t<e.oldValue.length&&(n=ya(n,f1(0,t))),t<e.newValue.length&&(n=ya(n,u1(vI(t)(e.newValue)))),n},ya=d(2,(e,t)=>c1(e,t)),m1=d(3,(e,t,n)=>{if(e._tag==="Empty")return t;let r=t.slice(),s=Sn(e);for(;da(s);){const o=zt(s),i=hs(s);switch(o._tag){case"Empty":{s=i;break}case"AndThen":{i.unshift(o.first,o.second),s=i;break}case"Append":{for(const c of o.values)r.push(c);s=i;break}case"Slice":{r=r.slice(o.from,o.until),s=i;break}case"Update":{r[o.index]=n.patch(o.patch,r[o.index]),s=i;break}}}return r}),g1=Symbol.for("effect/Differ"),y1={[g1]:{_P:ee,_V:ee},pipe(){return G(this,arguments)}},Qo=e=>{const t=Object.create(y1);return t.empty=e.empty,t.diff=e.diff,t.combine=e.combine,t.patch=e.patch,t},S1=()=>Qo({empty:M_(),combine:(e,t)=>ga(t)(e),diff:(e,t)=>zR(e,t),patch:(e,t)=>VR(t)(e)}),b1=()=>Qo({empty:L_(),combine:(e,t)=>hh(t)(e),diff:(e,t)=>t1(e,t),patch:(e,t)=>n1(t)(e)}),_1=e=>Qo({empty:H_(),combine:(t,n)=>ya(t,n),diff:(t,n)=>p1({oldValue:t,newValue:n,differ:e}),patch:(t,n)=>m1(t,n,e)}),D_=()=>w1((e,t)=>t),w1=e=>Qo({empty:ee,combine:(t,n)=>t===ee?n:n===ee?t:r=>n(t(r)),diff:(t,n)=>oe(t,n)?ee:vu(n),patch:(t,n)=>e(n,t(n))}),Xi=255,U_=8,dh=e=>e&Xi,ph=e=>e>>U_&Xi,wc=(e,t)=>(e&Xi)+((t&e&Xi)<<U_),v1=wc(0,0),T1=e=>wc(e,e),k1=e=>wc(e,0),E1=d(2,(e,t)=>wc(dh(e)&~t,ph(e))),C1=d(2,(e,t)=>e|t),I1=e=>~e>>>0&Xi,$1=0,$s=1,A1=2,K_=4,mh=16,j_=32,R1=e=>Gu(e,j_),O1=d(2,(e,t)=>e&~t),P1=d(2,(e,t)=>e|t),Tr=e=>z_(e)&&!F1(e),z_=e=>Gu(e,$s),Gu=d(2,(e,t)=>(e&t)!==0),V_=(...e)=>e.reduce((t,n)=>t|n,0),x1=V_($1),wg=e=>Gu(e,K_),F1=e=>Gu(e,mh),cs=d(2,(e,t)=>wc(e^t,t)),co=d(2,(e,t)=>e&(I1(dh(t))|ph(t))|dh(t)&ph(t)),vg=Qo({empty:v1,diff:(e,t)=>cs(e,t),combine:(e,t)=>C1(t)(e),patch:(e,t)=>co(t,e)}),N1=T1,q_=k1,Tg=E1,W_=(e,t)=>({_tag:"Par",left:e,right:t}),Jc=(e,t)=>({_tag:"Seq",left:e,right:t}),B1=e=>{let t=op(e),n=Io();for(;;){const[r,s]=OR(t,[J_(),Io()],([o,i],c)=>{const[a,u]=M1(c);return[K1(o,a),$R(i,u)]});if(n=L1(n,r),ur(s))return PR(n);t=s}throw new Error("BUG: BlockedRequests.flatten - please report an issue at https://github.com/Effect-TS/effect/issues")},M1=e=>{let t=e,n=J_(),r=Io(),s=Io();for(;;)switch(t._tag){case"Empty":{if(ur(r))return[n,s];t=r.head,r=r.tail;break}case"Par":{r=Ss(t.right,r),t=t.left;break}case"Seq":{const o=t.left,i=t.right;switch(o._tag){case"Empty":{t=i;break}case"Par":{const c=o.left,a=o.right;t=W_(Jc(c,i),Jc(a,i));break}case"Seq":{const c=o.left,a=o.right;t=Jc(c,Jc(a,i));break}case"Single":{t=o,s=Ss(i,s);break}}break}case"Single":{if(n=U1(n,t),ur(r))return[n,s];t=r.head,r=r.tail;break}}throw new Error("BUG: BlockedRequests.step - please report an issue at https://github.com/Effect-TS/effect/issues")},L1=(e,t)=>{if(ur(e))return op(cf(t));if(j1(t))return e;const n=G1(e.head),r=z1(t);return n.length===1&&r.length===1&&oe(n[0],r[0])?Ss(J1(e.head,cf(t)),e.tail):Ss(cf(t),e)},H1=Symbol.for("effect/RequestBlock/RequestBlockParallel"),D1={_R:e=>e};class ip{map;[H1]=D1;constructor(t){this.map=t}}const J_=()=>new ip(sp()),U1=(e,t)=>new ip(bR(e.map,t.dataSource,n=>eI(ro(n,wo(t.blockedRequest)),()=>Be(t.blockedRequest)))),K1=(e,t)=>new ip(F_(e.map,t.map,(n,r,s)=>P_(n,s,Fe(O_(n,s),{onNone:()=>r,onSome:o=>bt(r,o)})))),j1=e=>SR(e.map),z1=e=>Array.from(x_(e.map)),cf=e=>W1(_R(e.map,t=>Be(t))),V1=Symbol.for("effect/RequestBlock/RequestBlockSequential"),q1={_R:e=>e};class G_{map;[V1]=q1;constructor(t){this.map=t}}const W1=e=>new G_(e),J1=(e,t)=>new G_(F_(t.map,e.map,(n,r,s)=>P_(n,s,Fe(O_(n,s),{onNone:()=>We(),onSome:o=>bt(o,r)})))),G1=e=>Array.from(x_(e.map)),Y1=e=>Array.from(e.map),Xo="Die",bs="Empty",As="Fail",Zo="Interrupt",$o="Parallel",Ao="Sequential",Y_="effect/Cause",Q_=Symbol.for(Y_),Q1={_E:e=>e},ei={[Q_]:Q1,[he](){return p(Y(Y_),ye(Y(fO(this))),Ye(this))},[fe](e){return X1(e)&&lO(this,e)},pipe(){return G(this,arguments)},toJSON(){switch(this._tag){case"Empty":return{_id:"Cause",_tag:this._tag};case"Die":return{_id:"Cause",_tag:this._tag,defect:Ge(this.defect)};case"Interrupt":return{_id:"Cause",_tag:this._tag,fiberId:this.fiberId.toJSON()};case"Fail":return{_id:"Cause",_tag:this._tag,failure:Ge(this.error)};case"Sequential":case"Parallel":return{_id:"Cause",_tag:this._tag,left:Ge(this.left),right:Ge(this.right)}}},toString(){return ti(this)},[Me](){return this.toJSON()}},xr=(()=>{const e=Object.create(ei);return e._tag=bs,e})(),Fr=e=>{const t=Object.create(ei);return t._tag=As,t.error=e,t},nn=e=>{const t=Object.create(ei);return t._tag=Xo,t.defect=e,t},fn=e=>{const t=Object.create(ei);return t._tag=Zo,t.fiberId=e,t},Nr=(e,t)=>{const n=Object.create(ei);return n._tag=$o,n.left=e,n.right=t,n},Rt=(e,t)=>{const n=Object.create(ei);return n._tag=Ao,n.left=e,n.right=t,n},X1=e=>te(e,Q_),Z1=e=>e._tag===bs,eO=e=>e._tag===As,X_=e=>e._tag===Xo,tO=e=>e._tag===bs?!0:Ro(e,!0,(t,n)=>{switch(n._tag){case bs:return U(t);case Xo:case As:case Zo:return U(!1);default:return K()}}),Z_=e=>$e(iO(e)),Yu=e=>ap(void 0,dO)(e),nO=e=>pr(Ro(e,We(),(t,n)=>n._tag===As?U(p(t,Nt(n.error))):K())),rO=e=>pr(Ro(e,We(),(t,n)=>n._tag===Xo?U(p(t,Nt(n.defect))):K())),ew=e=>Ro(e,gs(),(t,n)=>n._tag===Zo?U(p(t,Fi(n.fiberId))):K()),sO=e=>cp(e,t=>t._tag===As?U(t.error):K()),tw=e=>{const t=sO(e);switch(t._tag){case"None":return pe(e);case"Some":return re(t.value)}},oO=e=>Qu(e,{onEmpty:U(xr),onFail:ro(Fr),onDie:t=>U(nn(t)),onInterrupt:t=>U(fn(t)),onSequential:Xm(Rt),onParallel:Xm(Nr)}),iO=e=>cp(e,t=>t._tag===Zo?U(t.fiberId):K()),kg=e=>Qu(e,{onEmpty:xr,onFail:()=>xr,onDie:nn,onInterrupt:fn,onSequential:Rt,onParallel:Nr}),cO=e=>Qu(e,{onEmpty:xr,onFail:nn,onDie:nn,onInterrupt:fn,onSequential:Rt,onParallel:Nr}),aO=d(2,(e,t)=>uO(e,n=>Fr(t(n)))),uO=d(2,(e,t)=>Qu(e,{onEmpty:xr,onFail:n=>t(n),onDie:n=>nn(n),onInterrupt:n=>fn(n),onSequential:(n,r)=>Rt(n,r),onParallel:(n,r)=>Nr(n,r)})),lO=(e,t)=>{let n=Be(e),r=Be(t);for(;Kn(n)&&Kn(r);){const[s,o]=p(Fn(n),Ro([gs(),We()],([a,u],l)=>{const[f,h]=gh(l);return U([p(a,Gi(f)),p(u,bt(h))])})),[i,c]=p(Fn(r),Ro([gs(),We()],([a,u],l)=>{const[f,h]=gh(l);return U([p(a,Gi(f)),p(u,bt(h))])}));if(!oe(s,i))return!1;n=o,r=c}return!0},fO=e=>hO(Be(e),We()),hO=(e,t)=>{for(;;){const[n,r]=p(e,Fd([gs(),We()],([o,i],c)=>{const[a,u]=gh(c);return[p(o,Gi(a)),p(i,bt(u))]})),s=np(n)>0?p(t,Nt(n)):t;if(Lu(r))return pr(s);e=r,t=s}throw new Error(Eu("Cause.flattenCauseLoop"))},cp=d(2,(e,t)=>{const n=[e];for(;n.length>0;){const r=n.pop(),s=t(r);switch(s._tag){case"None":{switch(r._tag){case Ao:case $o:{n.push(r.right),n.push(r.left);break}}break}case"Some":return s}}return K()}),gh=e=>{let t=e;const n=[];let r=gs(),s=We();for(;t!==void 0;)switch(t._tag){case bs:{if(n.length===0)return[r,s];t=n.pop();break}case As:{if(r=Fi(r,ma(t._tag,t.error)),n.length===0)return[r,s];t=n.pop();break}case Xo:{if(r=Fi(r,ma(t._tag,t.defect)),n.length===0)return[r,s];t=n.pop();break}case Zo:{if(r=Fi(r,ma(t._tag,t.fiberId)),n.length===0)return[r,s];t=n.pop();break}case Ao:{switch(t.left._tag){case bs:{t=t.right;break}case Ao:{t=Rt(t.left.left,Rt(t.left.right,t.right));break}case $o:{t=Nr(Rt(t.left.left,t.right),Rt(t.left.right,t.right));break}default:{s=Nt(s,t.right),t=t.left;break}}break}case $o:{n.push(t.right),t=t.left;break}}throw new Error(Eu("Cause.evaluateCauseLoop"))},dO={emptyCase:Gm,failCase:zf,dieCase:zf,interruptCase:Gm,sequentialCase:(e,t,n)=>t&&n,parallelCase:(e,t,n)=>t&&n},Eg="SequentialCase",Cg="ParallelCase",Qu=d(2,(e,{onDie:t,onEmpty:n,onFail:r,onInterrupt:s,onParallel:o,onSequential:i})=>ap(e,void 0,{emptyCase:()=>n,failCase:(c,a)=>r(a),dieCase:(c,a)=>t(a),interruptCase:(c,a)=>s(a),sequentialCase:(c,a,u)=>i(a,u),parallelCase:(c,a,u)=>o(a,u)})),Ro=d(3,(e,t,n)=>{let r=t,s=e;const o=[];for(;s!==void 0;){const i=n(r,s);switch(r=$e(i)?i.value:r,s._tag){case Ao:{o.push(s.right),s=s.left;break}case $o:{o.push(s.right),s=s.left;break}default:{s=void 0;break}}s===void 0&&o.length>0&&(s=o.pop())}return r}),ap=d(3,(e,t,n)=>{const r=[e],s=[];for(;r.length>0;){const i=r.pop();switch(i._tag){case bs:{s.push(pe(n.emptyCase(t)));break}case As:{s.push(pe(n.failCase(t,i.error)));break}case Xo:{s.push(pe(n.dieCase(t,i.defect)));break}case Zo:{s.push(pe(n.interruptCase(t,i.fiberId)));break}case Ao:{r.push(i.right),r.push(i.left),s.push(re({_tag:Eg}));break}case $o:{r.push(i.right),r.push(i.left),s.push(re({_tag:Cg}));break}}}const o=[];for(;s.length>0;){const i=s.pop();switch(i._tag){case"Left":{switch(i.left._tag){case Eg:{const c=o.pop(),a=o.pop(),u=n.sequentialCase(t,c,a);o.push(u);break}case Cg:{const c=o.pop(),a=o.pop(),u=n.parallelCase(t,c,a);o.push(u);break}}break}case"Right":{o.push(i.right);break}}}if(o.length===0)throw new Error("BUG: Cause.reduceWithContext - please report an issue at https://github.com/Effect-TS/effect/issues");return o.pop()}),ti=(e,t)=>Yu(e)?"All fibers interrupted without errors.":rw(e).map(function(n){return t?.renderErrorCause!==!0||n.cause===void 0?n.stack:`${n.stack} {
${nw(n.cause,"  ")}
}`}).join(`
`),nw=(e,t)=>{const n=e.stack.split(`
`);let r=`${t}[cause]: ${n[0]}`;for(let s=1,o=n.length;s<o;s++)r+=`
${t}${n[s]}`;return e.cause&&(r+=` {
${nw(e.cause,`${t}  `)}
${t}}`),r};class Ja extends globalThis.Error{span=void 0;constructor(t){const n=typeof t=="object"&&t!==null,r=Error.stackTraceLimit;Error.stackTraceLimit=1,super(pO(t),n&&"cause"in t&&typeof t.cause<"u"?{cause:new Ja(t.cause)}:void 0),this.message===""&&(this.message="An error has occurred"),Error.stackTraceLimit=r,this.name=t instanceof Error?t.name:"Error",n&&(Oo in t&&(this.span=t[Oo]),Object.keys(t).forEach(s=>{s in this||(this[s]=t[s])})),this.stack=yO(`${this.name}: ${this.message}`,t instanceof Error&&t.stack?t.stack:"",this.span)}}const pO=e=>{if(typeof e=="string")return e;if(typeof e=="object"&&e!==null&&e instanceof Error)return e.message;try{if(te(e,"toString")&&dc(e.toString)&&e.toString!==Object.prototype.toString&&e.toString!==globalThis.Array.prototype.toString)return e.toString()}catch{}return QS(e)},mO=/\((.*)\)/g,gO=be("effect/Tracer/spanToTrace",()=>new WeakMap),yO=(e,t,n)=>{const r=[e],s=t.startsWith(e)?t.slice(e.length).split(`
`):t.split(`
`);for(let o=1;o<s.length;o++){if(s[o].includes(" at new BaseEffectError")||s[o].includes(" at new YieldableError")){o++;continue}if(s[o].includes("Generator.next")||s[o].includes("effect_internal_function"))break;r.push(s[o].replace(/at .*effect_instruction_i.*\((.*)\)/,"at $1").replace(/EffectPrimitive\.\w+/,"<anonymous>"))}if(n){let o=n,i=0;for(;o&&o._tag==="Span"&&i<10;){const c=gO.get(o);if(typeof c=="function"){const a=c();if(typeof a=="string"){const u=a.matchAll(mO);let l=!1;for(const[,f]of u)l=!0,r.push(`    at ${o.name} (${f})`);l||r.push(`    at ${o.name} (${a.replace(/^at /,"")})`)}else r.push(`    at ${o.name}`)}else r.push(`    at ${o.name}`);o=Rn(o.parent),i++}}return r.join(`
`)},Oo=Symbol.for("effect/SpanAnnotation"),rw=e=>ap(e,void 0,{emptyCase:()=>[],dieCase:(t,n)=>[new Ja(n)],failCase:(t,n)=>[new Ja(n)],interruptCase:()=>[],parallelCase:(t,n,r)=>[...n,...r],sequentialCase:(t,n,r)=>[...n,...r]}),vc="Pending",Xu="Done",SO="effect/Deferred",bO=Symbol.for(SO),_O={_E:e=>e,_A:e=>e},wO=e=>({_tag:vc,joiners:e}),sw=e=>({_tag:Xu,effect:e});class Tc{self;called=!1;constructor(t){this.self=t}next(t){return this.called?{value:t,done:!0}:(this.called=!0,{value:this.self,done:!1})}return(t){return{value:t,done:!0}}throw(t){throw t}[Symbol.iterator](){return new Tc(this.self)}}const ow=(e,t)=>{const n=new dt("Blocked");return n.effect_instruction_i0=e,n.effect_instruction_i1=t,n},vO=e=>{const t=new dt("RunBlocked");return t.effect_instruction_i0=e,t},Po=Symbol.for("effect/Effect");class TO{patch;op;_op=$d;constructor(t,n){this.patch=t,this.op=n}}class dt{_op;effect_instruction_i0=void 0;effect_instruction_i1=void 0;effect_instruction_i2=void 0;trace=void 0;[Po]=bo;constructor(t){this._op=t}[fe](t){return this===t}[he](){return Ye(this,Td(this))}pipe(){return G(this,arguments)}toJSON(){return{_id:"Effect",_op:this._op,effect_instruction_i0:Ge(this.effect_instruction_i0),effect_instruction_i1:Ge(this.effect_instruction_i1),effect_instruction_i2:Ge(this.effect_instruction_i2)}}toString(){return at(this.toJSON())}[Me](){return this.toJSON()}[Symbol.iterator](){return new Tc(new pc(this))}}class iw{_op;effect_instruction_i0=void 0;effect_instruction_i1=void 0;effect_instruction_i2=void 0;trace=void 0;[Po]=bo;constructor(t){this._op=t,this._tag=t}[fe](t){return al(t)&&t._op==="Failure"&&oe(this.effect_instruction_i0,t.effect_instruction_i0)}[he](){return p(Ze(this._tag),ye(Y(this.effect_instruction_i0)),Ye(this))}get cause(){return this.effect_instruction_i0}pipe(){return G(this,arguments)}toJSON(){return{_id:"Exit",_tag:this._op,cause:this.cause.toJSON()}}toString(){return at(this.toJSON())}[Me](){return this.toJSON()}[Symbol.iterator](){return new Tc(new pc(this))}}class cw{_op;effect_instruction_i0=void 0;effect_instruction_i1=void 0;effect_instruction_i2=void 0;trace=void 0;[Po]=bo;constructor(t){this._op=t,this._tag=t}[fe](t){return al(t)&&t._op==="Success"&&oe(this.effect_instruction_i0,t.effect_instruction_i0)}[he](){return p(Ze(this._tag),ye(Y(this.effect_instruction_i0)),Ye(this))}get value(){return this.effect_instruction_i0}pipe(){return G(this,arguments)}toJSON(){return{_id:"Exit",_tag:this._op,value:Ge(this.value)}}toString(){return at(this.toJSON())}[Me](){return this.toJSON()}[Symbol.iterator](){return new Tc(new pc(this))}}const Sr=e=>te(e,Po),Ee=e=>{const t=new dt(eb);return t.effect_instruction_i0=e,t},aw=d(3,(e,t,n)=>kn(r=>P(e,s=>P(Ln(ae(()=>r(t(s)))),o=>ae(()=>n(s,o)).pipe(on({onFailure:i=>{switch(o._tag){case Pt:return ft(Rt(o.effect_instruction_i0,i));case xt:return ft(i)}},onSuccess:()=>o})))))),Gt=d(2,(e,t)=>P(e,()=>L(t))),cn=e=>Gt(e,void 0),uw=function(){const e=new dt(Iu);switch(arguments.length){case 2:{e.effect_instruction_i0=arguments[0],e.commit=arguments[1];break}case 3:{e.effect_instruction_i0=arguments[0],e.effect_instruction_i1=arguments[1],e.commit=arguments[2];break}case 4:{e.effect_instruction_i0=arguments[0],e.effect_instruction_i1=arguments[1],e.effect_instruction_i2=arguments[2],e.commit=arguments[3];break}default:throw new Error(Eu("you're not supposed to end up here"))}return e},Ga=(e,t=Co)=>{const n=new dt(Ri);let r;return n.effect_instruction_i0=s=>{r=e(s)},n.effect_instruction_i1=t,Cc(n,s=>Sr(r)?r:Ke)},lw=(e,t=Co)=>ae(()=>Ga(e,t)),jn=(e,t=Co)=>uw(e,function(){let n,r;function s(a){n?n(a):r===void 0&&(r=a)}const o=new dt(Ri);o.effect_instruction_i0=a=>{n=a,r&&a(r)},o.effect_instruction_i1=t;let i,c;return this.effect_instruction_i0.length!==1?(c=new AbortController,i=Ut(()=>this.effect_instruction_i0(s,c.signal))):i=Ut(()=>this.effect_instruction_i0(s)),i||c?Cc(o,a=>(c&&c.abort(),i??Ke)):o}),fw=d(2,(e,t)=>{const n=new dt(fa);return n.effect_instruction_i0=e,n.effect_instruction_i1=t,n}),xo=d(2,(e,t)=>zn(e,{onFailure:t,onSuccess:L})),Ig=Symbol.for("effect/OriginalAnnotation"),up=(e,t)=>$e(t)?new Proxy(e,{has(n,r){return r===Oo||r===Ig||r in n},get(n,r){return r===Oo?t.value:r===Ig?e:n[r]}}):e,Er=e=>gr(e)&&!(Oo in e)?Ee(t=>ft(nn(up(e,wp(t))))):ft(nn(e)),hw=e=>dw(()=>nn(new XO(e))),Fo=e=>zn(e,{onFailure:t=>L(re(t)),onSuccess:t=>L(pe(t))}),Ln=e=>pw(e,{onFailure:Oe,onSuccess:et}),st=e=>gr(e)&&!(Oo in e)?Ee(t=>ft(Fr(up(e,wp(t))))):ft(Fr(e)),Zu=e=>P(M(e),st),ft=e=>{const t=new iw(Pt);return t.effect_instruction_i0=e,t},dw=e=>P(M(e),ft),el=Ee(e=>L(e.id())),kc=e=>Ee(t=>e(t.id())),P=d(2,(e,t)=>{const n=new dt(Na);return n.effect_instruction_i0=e,n.effect_instruction_i1=t,n}),kO=e=>{const t=new dt("OnStep");return t.effect_instruction_i0=e,t},Ec=e=>P(e,ee),pw=d(2,(e,t)=>on(e,{onFailure:n=>L(t.onFailure(n)),onSuccess:n=>L(t.onSuccess(n))})),on=d(2,(e,t)=>{const n=new dt(Ba);return n.effect_instruction_i0=e,n.effect_instruction_i1=t.onFailure,n.effect_instruction_i2=t.onSuccess,n}),zn=d(2,(e,t)=>on(e,{onFailure:n=>{if(rO(n).length>0)return ft(cO(n));const s=nO(n);return s.length>0?t.onFailure(u_(s)):ft(n)},onSuccess:t.onSuccess})),or=d(2,(e,t)=>ae(()=>{const n=Ne(e),r=Au(n.length);let s=0;return Gt(dp({while:()=>s<n.length,body:()=>t(n[s],s),step:o=>{r[s++]=o}}),r)})),tl=d(2,(e,t)=>ae(()=>{const n=Ne(e);let r=0;return dp({while:()=>r<n.length,body:()=>t(n[r],r),step:()=>{r++}})})),Et=P(el,e=>mw(e)),mw=e=>ft(fn(e)),lp=e=>{const t=new dt(Wo);return t.effect_instruction_i0=N1($s),t.effect_instruction_i1=()=>e,t},EO=d(2,(e,t)=>kn(n=>P(Ln(n(e)),r=>aP(t,r)))),ne=d(2,(e,t)=>P(e,n=>M(()=>t(n)))),fp=d(2,(e,t)=>zn(e,{onFailure:n=>Zu(()=>t.onFailure(n)),onSuccess:n=>M(()=>t.onSuccess(n))})),nl=d(2,(e,t)=>on(e,{onFailure:n=>{const r=tw(n);switch(r._tag){case"Left":return Zu(()=>t(r.left));case"Right":return ft(r.right)}},onSuccess:L})),No=d(2,(e,t)=>kn(n=>on(n(e),{onFailure:r=>{const s=Oe(r);return on(t(s),{onFailure:o=>Oe(Rt(r,o)),onSuccess:()=>s})},onSuccess:r=>{const s=et(r);return gt(t(s),s)}}))),Cc=d(2,(e,t)=>No(e,ul({onFailure:n=>Yu(n)?cn(t(ew(n))):Ke,onSuccess:()=>Ke}))),hp=e=>CO(e,ee),CO=d(2,(e,t)=>zn(e,{onFailure:n=>Er(t(n)),onSuccess:L})),L=e=>{const t=new cw(xt);return t.effect_instruction_i0=e,t},ae=e=>{const t=new dt(Iu);return t.commit=e,t},M=e=>{const t=new dt(ZS);return t.effect_instruction_i0=e,t},rl=d(e=>e.length===3||e.length===2&&!(gr(e[1])&&"onlyEffect"in e[1]),(e,t)=>P(e,n=>{const r=typeof t=="function"?t(n):t;return Sr(r)?Gt(r,n):lC(r)?Ga(s=>{r.then(o=>s(L(n)),o=>s(st(new Cw(o,"An unknown error occurred in Effect.tap"))))}):L(n)})),IO=e=>Ee(t=>{const n=t.getFiberRef(bh),r=p(n,qe(()=>t.scope()));return e(Ic(bh,U(r)))}),Rs=e=>{const t=new dt(Wo);return t.effect_instruction_i0=q_($s),t.effect_instruction_i1=()=>e,t},kn=e=>uw(e,function(){const t=new dt(Wo);return t.effect_instruction_i0=q_($s),t.effect_instruction_i1=n=>z_(n)?Ut(()=>this.effect_instruction_i0(lp)):Ut(()=>this.effect_instruction_i0(Rs)),t}),Ke=L(void 0),$O=e=>{const t=new dt(Wo);return t.effect_instruction_i0=e,t.effect_instruction_i1=void 0,t},sl=d(2,(e,t)=>P(t,n=>n?p(e,ne(U)):L(K()))),dp=e=>{const t=new dt(Ma);return t.effect_instruction_i0=e.while,t.effect_instruction_i1=e.body,t.effect_instruction_i2=e.step,t},yh=e=>ae(()=>{const t=new dt(Oi);return t.effect_instruction_i0=e(),t}),gw=function(){const e=arguments.length===1?arguments[0]:arguments[1].bind(arguments[0]);return yh(()=>e(p))},AO=(e,...t)=>Object.defineProperty(t.length===0?function(...n){return yh(()=>e.apply(this,n))}:function(...n){let r=yh(()=>e.apply(this,n));for(const s of t)r=s(r,...n);return r},"length",{value:e.length,configurable:!0}),RO=d(2,(e,t)=>{const n=new dt(Wo);return n.effect_instruction_i0=t,n.effect_instruction_i1=()=>e,n}),ol=e=>{const t=new dt(ha);return typeof e?.priority<"u"?WO(t,e.priority):t},yw=d(2,(e,t)=>P(e,n=>ne(t,r=>[n,r]))),il=d(2,(e,t)=>P(e,n=>Gt(t,n))),gt=d(2,(e,t)=>P(e,()=>t)),Sw=d(3,(e,t,n)=>P(e,r=>ne(t,s=>n(r,s)))),pp=e=>P(el,t=>p(e,Zi(t))),Zi=d(2,(e,t)=>P(e.interruptAsFork(t),()=>e.await)),OO={_tag:"All",syslog:0,label:"ALL",ordinal:Number.MIN_SAFE_INTEGER,pipe(){return G(this,arguments)}},PO={_tag:"Fatal",syslog:2,label:"FATAL",ordinal:5e4,pipe(){return G(this,arguments)}},xO={_tag:"Error",syslog:3,label:"ERROR",ordinal:4e4,pipe(){return G(this,arguments)}},bw={_tag:"Warning",syslog:4,label:"WARN",ordinal:3e4,pipe(){return G(this,arguments)}},_w={_tag:"Info",syslog:6,label:"INFO",ordinal:2e4,pipe(){return G(this,arguments)}},ww={_tag:"Debug",syslog:7,label:"DEBUG",ordinal:1e4,pipe(){return G(this,arguments)}},FO={_tag:"Trace",syslog:7,label:"TRACE",ordinal:0,pipe(){return G(this,arguments)}},NO={_tag:"None",syslog:7,label:"OFF",ordinal:Number.MAX_SAFE_INTEGER,pipe(){return G(this,arguments)}},BO="effect/FiberRef",MO=Symbol.for(BO),LO={_A:e=>e},mp=e=>Ee(t=>et(t.getFiberRef(e))),cl=d(2,(e,t)=>P(mp(e),t)),$g=d(2,(e,t)=>HO(e,()=>[void 0,t])),HO=d(2,(e,t)=>Ee(n=>{const[r,s]=t(n.getFiberRef(e));return n.setFiberRef(e,s),L(r)})),Ic=d(3,(e,t,n)=>aw(il(mp(t),$g(t,n)),()=>e,r=>$g(t,r))),DO=d(3,(e,t,n)=>cl(t,r=>Ic(e,t,n(r)))),Yt=(e,t)=>ni(e,{differ:D_(),fork:t?.fork??ee,join:t?.join}),UO=e=>{const t=b1();return ni(e,{differ:t,fork:t.empty})},KO=e=>{const t=_1(D_());return ni(e,{differ:t,fork:t.empty})},vw=e=>{const t=S1();return ni(e,{differ:t,fork:t.empty})},ni=(e,t)=>({...yc,[MO]:LO,initial:e,commit(){return mp(this)},diff:(r,s)=>t.differ.diff(r,s),combine:(r,s)=>t.differ.combine(r,s),patch:r=>s=>t.differ.patch(r,s),fork:t.fork,join:t.join??((r,s)=>s)}),jO=e=>ni(e,{differ:vg,fork:vg.empty}),jr=be(Symbol.for("effect/FiberRef/currentContext"),()=>vw(jd())),$c=be(Symbol.for("effect/FiberRef/currentSchedulingPriority"),()=>Yt(0)),Tw=be(Symbol.for("effect/FiberRef/currentMaxOpsBeforeYield"),()=>Yt(2048)),zO=be(Symbol.for("effect/FiberRef/currentLogAnnotation"),()=>Yt(sp())),VO=be(Symbol.for("effect/FiberRef/currentLogLevel"),()=>Yt(_w)),qO=be(Symbol.for("effect/FiberRef/currentLogSpan"),()=>Yt(Io())),WO=d(2,(e,t)=>Ic(e,$c,t)),JO=be(Symbol.for("effect/FiberRef/currentConcurrency"),()=>Yt("unbounded")),GO=be(Symbol.for("effect/FiberRef/currentRequestBatching"),()=>Yt(!0)),YO=be(Symbol.for("effect/FiberRef/currentUnhandledErrorLogLevel"),()=>Yt(U(ww))),QO=be(Symbol.for("effect/FiberRef/versionMismatchErrorLogLevel"),()=>Yt(U(bw))),Sh=be(Symbol.for("effect/FiberRef/currentMetricLabels"),()=>KO(ds())),bh=be(Symbol.for("effect/FiberRef/currentForkScopeOverride"),()=>Yt(K(),{fork:()=>K(),join:(e,t)=>e})),Gc=be(Symbol.for("effect/FiberRef/currentInterruptedCause"),()=>Yt(xr,{fork:()=>xr,join:(e,t)=>e})),Ag=Symbol.for("effect/Scope"),Rg=Symbol.for("effect/CloseableScope"),kw=(e,t)=>e.addFinalizer(()=>cn(t)),Ya=(e,t)=>e.addFinalizer(t),_h=(e,t)=>e.close(t),tr=(e,t)=>e.fork(t),gp=(function(){class e extends globalThis.Error{commit(){return st(this)}toJSON(){const n={...this};return this.message&&(n.message=this.message),this.cause&&(n.cause=this.cause),n}[Me](){return this.toString!==globalThis.Error.prototype.toString?this.stack?`${this.toString()}
${this.stack.split(`
`).slice(1).join(`
`)}`:this.toString():"Bun"in globalThis?ti(Fr(this),{renderErrorCause:!0}):this}}return Object.assign(e.prototype,BC),e})(),Ew=(e,t)=>{class n extends gp{_tag=t}return Object.assign(n.prototype,e),n.prototype.name=t,n},Og=Symbol.for("effect/Cause/errors/RuntimeException"),XO=Ew({[Og]:Og},"RuntimeException"),ZO=Symbol.for("effect/Cause/errors/InterruptedException"),eP=e=>te(e,ZO),Pg=Symbol.for("effect/Cause/errors/NoSuchElement"),yp=Ew({[Pg]:Pg},"NoSuchElementException"),xg=Symbol.for("effect/Cause/errors/UnknownException"),Cw=(function(){class e extends gp{_tag="UnknownException";error;constructor(n,r){super(r??"An unknown error occurred",{cause:n}),this.error=n}}return Object.assign(e.prototype,{[xg]:xg,name:"UnknownException"}),e})(),al=e=>Sr(e)&&"_tag"in e&&(e._tag==="Success"||e._tag==="Failure"),tP=e=>e._tag==="Failure",nP=e=>e._tag==="Success",rP=d(2,(e,t)=>{switch(e._tag){case Pt:return Oe(e.effect_instruction_i0);case xt:return et(t)}}),af=e=>rP(e,void 0),ao=(e,t)=>iP(e,t?.parallel?Nr:Rt),Iw=e=>Oe(nn(e)),wh=e=>Oe(Fr(e)),Oe=e=>{const t=new iw(Pt);return t.effect_instruction_i0=e,t},$w=e=>Oe(fn(e)),Sa=d(2,(e,t)=>{switch(e._tag){case Pt:return Oe(e.effect_instruction_i0);case xt:return et(t(e.effect_instruction_i0))}}),ul=d(2,(e,{onFailure:t,onSuccess:n})=>{switch(e._tag){case Pt:return t(e.effect_instruction_i0);case xt:return n(e.effect_instruction_i0)}}),vh=d(2,(e,{onFailure:t,onSuccess:n})=>{switch(e._tag){case Pt:return t(e.effect_instruction_i0);case xt:return n(e.effect_instruction_i0)}}),et=e=>{const t=new cw(xt);return t.effect_instruction_i0=e,t},vn=et(void 0),sP=d(2,(e,t)=>Sp(e,t,{onSuccess:(n,r)=>[n,r],onFailure:Rt})),oP=d(2,(e,t)=>Sp(e,t,{onSuccess:(n,r)=>r,onFailure:Rt})),Sp=d(3,(e,t,{onFailure:n,onSuccess:r})=>{switch(e._tag){case Pt:switch(t._tag){case xt:return Oe(e.effect_instruction_i0);case Pt:return Oe(n(e.effect_instruction_i0,t.effect_instruction_i0))}case xt:switch(t._tag){case xt:return et(r(e.effect_instruction_i0,t.effect_instruction_i0));case Pt:return Oe(t.effect_instruction_i0)}}}),iP=(e,t)=>{const n=zi(e);return Kn(n)?p(sr(n),Fd(p(Fn(n),Sa(Be)),(r,s)=>p(r,Sp(s,{onSuccess:(o,i)=>p(o,Nt(i)),onFailure:t}))),Sa(pr),Sa(r=>cr(r)),U):K()},Ac=e=>({...yc,[bO]:_O,state:Cs(wO([])),commit(){return Vn(this)},blockingOn:e}),Rc=()=>P(el,e=>cP(e)),cP=e=>M(()=>Ac(e)),Vn=e=>lw(t=>{const n=_e(e.state);switch(n._tag){case Xu:return t(n.effect);case vc:return n.joiners.push(t),lP(e,t)}},e.blockingOn),ll=d(2,(e,t)=>M(()=>{const n=_e(e.state);switch(n._tag){case Xu:return!1;case vc:{Is(e.state,sw(t));for(let r=0,s=n.joiners.length;r<s;r++)n.joiners[r](t);return!0}}})),aP=d(2,(e,t)=>ll(e,t)),Aw=d(2,(e,t)=>ll(e,ft(t))),bp=d(2,(e,t)=>ll(e,mw(t))),uP=e=>M(()=>_e(e.state)._tag===Xu),Oc=d(2,(e,t)=>ll(e,L(t))),fl=(e,t)=>{const n=_e(e.state);if(n._tag===vc){Is(e.state,sw(t));for(let r=0,s=n.joiners.length;r<s;r++)n.joiners[r](t)}},lP=(e,t)=>M(()=>{const n=_e(e.state);if(n._tag===vc){const r=n.joiners.indexOf(t);r>=0&&n.joiners.splice(r,1)}}),fP=Ee(e=>et(e.currentContext)),hP=()=>fP,Os=e=>P(hP(),e),hl=d(2,(e,t)=>Ic(jr,t)(e)),_p=d(2,(e,t)=>DO(jr,n=>Nu(n,t))(e)),dP=d(2,(e,t)=>Os(n=>hl(e,t(n)))),wp=e=>{const t=e.currentSpan;return t!==void 0&&t._tag==="Span"?U(t):K()},dn=Rc,Ct=Vn,Rw=Aw,Th=uP,Nn=Oc,Ow=tP,Qa=nP,pP=ao,mP=Iw,Pw=wh,pn=Oe,gP=Sa,Bn=ul,hn=et,yP=vn,Fg=sP,ec=oP,Ng=Symbol.for("effect/MutableHashMap"),SP={[Ng]:Ng,[Symbol.iterator](){return new vp(this)},toString(){return at(this.toJSON())},toJSON(){return{_id:"MutableHashMap",values:Array.from(this).map(Ge)}},[Me](){return this.toJSON()},pipe(){return G(this,arguments)}};class vp{self;referentialIterator;bucketIterator;constructor(t){this.self=t,this.referentialIterator=t.referential[Symbol.iterator]()}next(){if(this.bucketIterator!==void 0)return this.bucketIterator.next();const t=this.referentialIterator.next();return t.done?(this.bucketIterator=new bP(this.self.buckets.values()),this.next()):t}[Symbol.iterator](){return new vp(this.self)}}class bP{backing;constructor(t){this.backing=t}currentBucket;next(){if(this.currentBucket===void 0){const n=this.backing.next();if(n.done)return n;this.currentBucket=n.value[Symbol.iterator]()}const t=this.currentBucket.next();return t.done?(this.currentBucket=void 0,this.next()):t}}const _P=()=>{const e=Object.create(SP);return e.referential=new Map,e.buckets=new Map,e.bucketsSize=0,e},Gr=d(2,(e,t)=>{if(Fa(t)===!1)return e.referential.has(t)?U(e.referential.get(t)):K();const n=t[he](),r=e.buckets.get(n);return r===void 0?K():wP(e,r,t)}),wP=(e,t,n,r=!1)=>{for(let s=0,o=t.length;s<o;s++)if(n[fe](t[s][0])){const i=t[s][1];return r&&(t.splice(s,1),e.bucketsSize--),U(i)}return K()},fi=d(2,(e,t)=>$e(Gr(e,t))),hi=d(3,(e,t,n)=>{if(Fa(t)===!1)return e.referential.set(t,n),e;const r=t[he](),s=e.buckets.get(r);return s===void 0?(e.buckets.set(r,[[t,n]]),e.bucketsSize++,e):(vP(e,s,t),s.push([t,n]),e.bucketsSize++,e)}),vP=(e,t,n)=>{for(let r=0,s=t.length;r<s;r++)if(n[fe](t[r][0])){t.splice(r,1),e.bucketsSize--;return}},Bg=Symbol.for("effect/MutableList"),TP={[Bg]:Bg,[Symbol.iterator](){let e=!1,t=this.head;return{next(){if(e)return this.return();if(t==null)return e=!0,this.return();const n=t.value;return t=t.next,{done:e,value:n}},return(n){return e||(e=!0),{done:!0,value:n}}}},toString(){return at(this.toJSON())},toJSON(){return{_id:"MutableList",values:Array.from(this).map(Ge)}},[Me](){return this.toJSON()},pipe(){return G(this,arguments)}},kP=e=>({value:e,removed:!1,prev:void 0,next:void 0}),EP=()=>{const e=Object.create(TP);return e.head=void 0,e.tail=void 0,e._length=0,e},xw=e=>Tp(e)===0,Tp=e=>e._length,CP=d(2,(e,t)=>{const n=kP(t);return e.head===void 0&&(e.head=n),e.tail===void 0||(e.tail.next=n,n.prev=e.tail),e.tail=n,e._length+=1,e}),IP=e=>{const t=e.head;if(t!==void 0)return $P(e,t),t.value},$P=(e,t)=>{t.removed||(t.removed=!0,t.prev!==void 0&&t.next!==void 0?(t.prev.next=t.next,t.next.prev=t.prev):t.prev!==void 0?(e.tail=t.prev,t.prev.next=void 0):t.next!==void 0?(e.head=t.next,t.next.prev=void 0):(e.tail=void 0,e.head=void 0),e._length>0&&(e._length-=1))},Mg=Symbol.for("effect/MutableQueue"),ot=Symbol.for("effect/mutable/MutableQueue/Empty"),AP={[Mg]:Mg,[Symbol.iterator](){return Array.from(this.queue)[Symbol.iterator]()},toString(){return at(this.toJSON())},toJSON(){return{_id:"MutableQueue",values:Array.from(this).map(Ge)}},[Me](){return this.toJSON()},pipe(){return G(this,arguments)}},Fw=e=>{const t=Object.create(AP);return t.queue=EP(),t.capacity=e,t},RP=e=>Fw(e),dl=()=>Fw(void 0),kp=e=>Tp(e.queue),as=e=>xw(e.queue),OP=e=>e.capacity===void 0?1/0:e.capacity,Bo=d(2,(e,t)=>{const n=Tp(e.queue);return e.capacity!==void 0&&n===e.capacity?!1:(CP(t)(e.queue),!0)}),Ep=d(2,(e,t)=>{const n=t[Symbol.iterator]();let r,s=We(),o=!0;for(;o&&(r=n.next())&&!r.done;)o=Bo(r.value)(e);for(;r!=null&&!r.done;)s=Nt(r.value)(s),r=n.next();return pr(s)}),lr=d(2,(e,t)=>xw(e.queue)?t:IP(e.queue)),pl=d(2,(e,t)=>{let n=We(),r=0;for(;r<t;){const s=lr(ot)(e);if(s===ot)break;n=Nt(s)(n),r+=1}return pr(n)}),PP="effect/Clock",Lg=Symbol.for(PP),ml=Es("effect/Clock"),xP=2**31-1,Hg={unsafeSchedule(e,t){const n=qi(t);if(n>xP)return zf;let r=!1;const s=setTimeout(()=>{r=!0,e()},n);return()=>(clearTimeout(s),!r)}},Dg=(function(){const e=BigInt(1e6);if(typeof performance>"u"||typeof performance.now!="function")return()=>BigInt(Date.now())*e;let t;return()=>(t===void 0&&(t=BigInt(Date.now())*e-BigInt(Math.round(performance.now()*1e6))),t+BigInt(Math.round(performance.now()*1e6)))})(),FP=(function(){const e=typeof process=="object"&&"hrtime"in process&&typeof process.hrtime.bigint=="function"?process.hrtime:void 0;if(!e)return Dg;const t=Dg()-e.bigint();return()=>t+e.bigint()})();class NP{[Lg]=Lg;unsafeCurrentTimeMillis(){return Date.now()}unsafeCurrentTimeNanos(){return FP()}currentTimeMillis=M(()=>this.unsafeCurrentTimeMillis());currentTimeNanos=M(()=>this.unsafeCurrentTimeNanos());scheduler(){return L(Hg)}sleep(t){return jn(n=>{const r=Hg.unsafeSchedule(()=>n(Ke),t);return cn(M(r))})}}const BP=()=>new NP,Nw="And",Bw="Or",Mw="InvalidData",Lw="MissingData",Hw="SourceUnavailable",Dw="Unsupported",MP="effect/ConfigError",Ug=Symbol.for(MP),ri={_tag:"ConfigError",[Ug]:Ug},Uw=(e,t)=>{const n=Object.create(ri);return n._op=Nw,n.left=e,n.right=t,Object.defineProperty(n,"toString",{enumerable:!1,value(){return`${this.left} and ${this.right}`}}),Object.defineProperty(n,"message",{enumerable:!1,get(){return this.toString()}}),n},Kw=(e,t)=>{const n=Object.create(ri);return n._op=Bw,n.left=e,n.right=t,Object.defineProperty(n,"toString",{enumerable:!1,value(){return`${this.left} or ${this.right}`}}),Object.defineProperty(n,"message",{enumerable:!1,get(){return this.toString()}}),n},LP=(e,t,n={pathDelim:"."})=>{const r=Object.create(ri);return r._op=Mw,r.path=e,r.message=t,Object.defineProperty(r,"toString",{enumerable:!1,value(){return`(Invalid data at ${p(this.path,Go(n.pathDelim))}: "${this.message}")`}}),r},_s=(e,t,n={pathDelim:"."})=>{const r=Object.create(ri);return r._op=Lw,r.path=e,r.message=t,Object.defineProperty(r,"toString",{enumerable:!1,value(){return`(Missing data at ${p(this.path,Go(n.pathDelim))}: "${this.message}")`}}),r},HP=(e,t,n,r={pathDelim:"."})=>{const s=Object.create(ri);return s._op=Hw,s.path=e,s.message=t,s.cause=n,Object.defineProperty(s,"toString",{enumerable:!1,value(){return`(Source unavailable at ${p(this.path,Go(r.pathDelim))}: "${this.message}")`}}),s},DP=(e,t,n={pathDelim:"."})=>{const r=Object.create(ri);return r._op=Dw,r.path=e,r.message=t,Object.defineProperty(r,"toString",{enumerable:!1,value(){return`(Unsupported operation at ${p(this.path,Go(n.pathDelim))}: "${this.message}")`}}),r},es=d(2,(e,t)=>{switch(e._op){case Nw:return Uw(es(e.left,t),es(e.right,t));case Bw:return Kw(es(e.left,t),es(e.right,t));case Mw:return LP([...t,...e.path],e.message);case Lw:return _s([...t,...e.path],e.message);case Hw:return HP([...t,...e.path],e.message,e.cause);case Dw:return DP([...t,...e.path],e.message)}}),UP={_tag:"Empty"},uf=d(2,(e,t)=>{let n=op(t),r=e;for(;CR(n);){const s=n.head;switch(s._tag){case"Empty":{n=n.tail;break}case"AndThen":{n=Ss(s.first,Ss(s.second,n.tail));break}case"MapName":{r=os(r,s.f),n=n.tail;break}case"Nested":{r=Ha(r,s.name),n=n.tail;break}case"Unnested":{if(p(Pi(r),cI(s.name)))r=hs(r),n=n.tail;else return re(_s(r,`Expected ${s.name} to be in path in ConfigProvider#unnested`));break}}}return pe(r)}),KP="Constant",jP="Fail",zP="Fallback",VP="Described",qP="Lazy",WP="MapOrFail",JP="Nested",GP="Primitive",YP="Sequence",QP="HashMap",XP="ZipWith";var Kg={};const Xa=(e,t)=>[...e,...t],ZP="effect/ConfigProvider",jg=Symbol.for(ZP),ex=Es("effect/ConfigProvider"),tx="effect/ConfigProviderFlat",zg=Symbol.for(tx),nx=e=>({[jg]:jg,pipe(){return G(this,arguments)},...e}),rx=e=>({[zg]:zg,patch:e.patch,load:(t,n,r=!0)=>e.load(t,n,r),enumerateChildren:e.enumerateChildren}),sx=e=>nx({load:t=>P(un(e,ds(),t,!1),n=>Fe(Pi(n),{onNone:()=>st(_s(ds(),`Expected a single value having structure: ${t}`)),onSome:L})),flattened:e}),ox=e=>{const{pathDelim:t,seqDelim:n}=Object.assign({},{pathDelim:"_",seqDelim:","},e),r=a=>p(a,Go(t)),s=a=>a.split(t),o=()=>typeof process<"u"&&"env"in process&&typeof Kg=="object"?Kg:{};return sx(rx({load:(a,u,l=!0)=>{const f=r(a),h=o(),m=f in h?U(h[f]):K();return p(m,nl(()=>_s(a,`Expected ${f} to exist in the process context`)),P(y=>lx(y,a,u,n,l)))},enumerateChildren:a=>M(()=>{const u=o(),h=Object.keys(u).map(m=>s(m.toUpperCase())).filter(m=>{for(let y=0;y<a.length;y++){const b=p(a,mb(y)),_=m[y];if(_===void 0||b!==_)return!1}return!0}).flatMap(m=>m.slice(a.length,a.length+1));return sR(h)}),patch:UP}))},ix=(e,t,n,r)=>{const s=tg(n.length,a=>a>=r.length?K():U([e(a),a+1])),o=tg(r.length,a=>a>=n.length?K():U([t(a),a+1])),i=Xa(n,s),c=Xa(r,o);return[i,c]},cx=(e,t)=>{let n=t;if(n._tag==="Nested"){const r=e.slice();for(;n._tag==="Nested";)r.push(n.name),n=n.config;return r}return e},un=(e,t,n,r)=>{const s=n;switch(s._tag){case KP:return L(Sn(s.value));case VP:return ae(()=>un(e,t,s.config,r));case jP:return st(_s(t,s.message));case zP:return p(ae(()=>un(e,t,s.first,r)),xo(o=>s.condition(o)?p(un(e,t,s.second,r),xo(i=>st(Kw(o,i)))):st(o)));case qP:return ae(()=>un(e,t,s.config(),r));case WP:return ae(()=>p(un(e,t,s.original,r),P(or(o=>p(s.mapOrFail(o),nl(es(cx(t,s.original))))))));case JP:return ae(()=>un(e,Xa(t,Sn(s.name)),s.config,r));case GP:return p(uf(t,e.patch),P(o=>p(e.load(o,s,r),P(i=>{if(i.length===0){const c=p(bI(o),qe(()=>"<n/a>"));return st(_s([],`Expected ${s.description} with name ${c}`))}return L(i)}))));case YP:return p(uf(t,e.patch),P(o=>p(e.enumerateChildren(o),P(hx),P(i=>i.length===0?ae(()=>ne(un(e,t,s.config,!0),Sn)):p(or(i,c=>un(e,dI(t,`[${c}]`),s.config,!0)),ne(c=>{const a=II(c);return a.length===0?Sn(ds()):Sn(a)}))))));case QP:return ae(()=>p(uf(t,e.patch),P(o=>p(e.enumerateChildren(o),P(i=>p(i,or(c=>un(e,Xa(o,Sn(c)),s.valueConfig,r)),ne(c=>c.length===0?Sn(sp()):p(fx(c),os(a=>yR(eg(Ne(i),a)))))))))));case XP:return ae(()=>p(un(e,t,s.left,r),Fo,P(o=>p(un(e,t,s.right,r),Fo,P(i=>{if(Tt(o)&&Tt(i))return st(Uw(o.left,i.left));if(Tt(o)&&xn(i))return st(o.left);if(xn(o)&&Tt(i))return st(i.left);if(xn(o)&&xn(i)){const c=p(t,Go(".")),a=ax(t,c),[u,l]=ix(a,a,p(o.right,os(pe)),p(i.right,os(pe)));return p(u,eg(l),or(([f,h])=>p(yw(f,h),ne(([m,y])=>s.zip(m,y)))))}throw new Error("BUG: ConfigProvider.fromFlatLoop - please report an issue at https://github.com/Effect-TS/effect/issues")})))))}},ax=(e,t)=>n=>re(_s(e,`The element at index ${n} in a sequence at path "${t}" was missing`)),ux=(e,t)=>e.split(new RegExp(`\\s*${Ua(t)}\\s*`)),lx=(e,t,n,r,s)=>s?p(ux(e,r),or(o=>n.parse(o.trim())),nl(es(t))):p(n.parse(e),fp({onFailure:es(t),onSuccess:Sn})),fx=e=>Object.keys(e[0]).map(t=>e.map(n=>n[t])),hx=e=>p(or(e,px),fp({onFailure:()=>ds(),onSuccess:ji(_o)}),Fo,ne(GC)),dx=/^(\[(\d+)\])$/,px=e=>{const t=e.match(dx);if(t!==null){const n=t[2];return p(n!==void 0&&n.length>0?U(n):K(),Jo(mx))}return K()},mx=e=>{const t=Number.parseInt(e);return Number.isNaN(t)?K():U(t)},Vg=Symbol.for("effect/Console"),jw=Es("effect/Console"),gx={[Vg]:Vg,assert(e,...t){return M(()=>{console.assert(e,...t)})},clear:M(()=>{console.clear()}),count(e){return M(()=>{console.count(e)})},countReset(e){return M(()=>{console.countReset(e)})},debug(...e){return M(()=>{console.debug(...e)})},dir(e,t){return M(()=>{console.dir(e,t)})},dirxml(...e){return M(()=>{console.dirxml(...e)})},error(...e){return M(()=>{console.error(...e)})},group(e){return e?.collapsed?M(()=>console.groupCollapsed(e?.label)):M(()=>console.group(e?.label))},groupEnd:M(()=>{console.groupEnd()}),info(...e){return M(()=>{console.info(...e)})},log(...e){return M(()=>{console.log(...e)})},table(e,t){return M(()=>{console.table(e,t)})},time(e){return M(()=>console.time(e))},timeEnd(e){return M(()=>console.timeEnd(e))},timeLog(e,...t){return M(()=>{console.timeLog(e,...t)})},trace(...e){return M(()=>{console.trace(...e)})},warn(...e){return M(()=>{console.warn(...e)})},unsafe:console},yx="effect/Random",qg=Symbol.for(yx),Sx=Es("effect/Random");class bx{seed;[qg]=qg;PRNG;constructor(t){this.seed=t,this.PRNG=new yC(t)}get next(){return M(()=>this.PRNG.number())}get nextBoolean(){return ne(this.next,t=>t>.5)}get nextInt(){return M(()=>this.PRNG.integer(Number.MAX_SAFE_INTEGER))}nextRange(t,n){return ne(this.next,r=>(n-t)*r+t)}nextIntBetween(t,n){return M(()=>this.PRNG.integer(n-t)+t)}shuffle(t){return _x(t,n=>this.nextIntBetween(0,n))}}const _x=(e,t)=>ae(()=>p(M(()=>Array.from(e)),P(n=>{const r=[];for(let s=n.length;s>=2;s=s-1)r.push(s);return p(r,tl(s=>p(t(s),ne(o=>wx(n,s-1,o)))),Gt(zi(n)))}))),wx=(e,t,n)=>{const r=e[t];return e[t]=e[n],e[n]=r,e},vx=e=>new bx(Y(e)),Wg=Symbol.for("effect/Tracer"),Tx=e=>({[Wg]:Wg,...e}),zw=Es("effect/Tracer"),Vw=Es("effect/ParentSpan"),Jg=(function(){const e="abcdef0123456789",t=e.length;return function(n){let r="";for(let s=0;s<n;s++)r+=e.charAt(Math.floor(Math.random()*t));return r}})();class kx{name;parent;context;startTime;kind;_tag="Span";spanId;traceId="native";sampled=!0;status;attributes;events=[];links;constructor(t,n,r,s,o,i){this.name=t,this.parent=n,this.context=r,this.startTime=o,this.kind=i,this.status={_tag:"Started",startTime:o},this.attributes=new Map,this.traceId=n._tag==="Some"?n.value.traceId:Jg(32),this.spanId=Jg(16),this.links=Array.from(s)}end(t,n){this.status={_tag:"Ended",endTime:t,exit:n,startTime:this.status.startTime}}attribute(t,n){this.attributes.set(t,n)}event(t,n,r){this.events.push([t,n,r??{}])}addLinks(t){this.links.push(...t)}}const Ex=Tx({span:(e,t,n,r,s,o)=>new kx(e,t,n,r,s,o),context:e=>e()}),Cx=p(jd(),Yr(ml,BP()),Yr(jw,gx),Yr(Sx,vx(Math.random())),Yr(ex,ox()),Yr(zw,Ex)),Za=be(Symbol.for("effect/DefaultServices/currentServices"),()=>vw(Cx)),Ix=e=>{const t=Wt(e);return qw(n=>n.sleep(t))},$x=e=>Ee(t=>e(t.currentDefaultServices)),qw=e=>$x(t=>e(t.unsafeMap.get(ml.key))),Ax=qw(e=>e.currentTimeMillis),Rx=Ix,Ox=Ax;function Px(e){return new Br(e)}function xx(){return Px(new Map)}const Gg=Symbol.for("effect/FiberRefs");class Br{locals;[Gg]=Gg;constructor(t){this.locals=t}pipe(){return G(this,arguments)}}const Fx=(e,t,n,r=!1)=>{const s=e;let o=t,i=n,c=r,a;for(;a===void 0;)if(wt(o)&&wt(i)){const u=zt(o)[0],l=hs(o),f=zt(i)[0],h=zt(i)[1],m=hs(i);u.startTimeMillis<f.startTimeMillis?(i=m,c=!0):u.startTimeMillis>f.startTimeMillis?o=l:u.id<f.id?(i=m,c=!0):u.id>f.id?o=l:a=[h,c]}else a=[s.initial,!0];return a},Nx=d(3,(e,t,n)=>{const r=new Map(e.locals);return n.locals.forEach((s,o)=>{const i=s[0][1];if(!s[0][0][fe](t)){if(!r.has(o)){if(oe(i,o.initial))return;r.set(o,[[t,o.join(o.initial,i)]]);return}const c=r.get(o),[a,u]=Fx(o,c,s);if(u){const l=o.diff(a,i),f=c[0][1],h=o.join(f,o.patch(l)(f));if(!oe(f,h)){let m;const y=c[0][0];y[fe](t)?m=[[y,h],...c.slice(1)]:m=[[t,h],...c],r.set(o,m)}}}}),new Br(r)}),Bx=d(2,(e,t)=>{const n=new Map;return Ww(e,n,t),new Br(n)}),Ww=(e,t,n)=>{e.locals.forEach((r,s)=>{const o=r[0][1],i=s.patch(s.fork)(o);oe(o,i)?t.set(s,r):t.set(s,[[n,i],...r])})},Jw=d(2,(e,t)=>{const n=new Map(e.locals);return n.delete(t),new Br(n)}),Mx=d(2,(e,t)=>e.locals.has(t)?U(zt(e.locals.get(t))[1]):K()),tc=d(2,(e,t)=>p(Mx(e,t),qe(()=>t.initial))),kh=d(2,(e,{fiberId:t,fiberRef:n,value:r})=>{if(e.locals.size===0)return new Br(new Map([[n,[[t,r]]]]));const s=new Map(e.locals);return Eh(s,t,n,r),new Br(s)}),Eh=(e,t,n,r)=>{const s=e.get(n)??[];let o;if(wt(s)){const[i,c]=zt(s);if(i[fe](t)){if(oe(c,r))return;o=[[t,r],...s.slice(1)]}else o=[[t,r],...s]}else o=[[t,r]];e.set(n,o)},Lx=d(2,(e,{entries:t,forkAs:n})=>{if(e.locals.size===0)return new Br(new Map(t));const r=new Map(e.locals);return n!==void 0&&Ww(e,r,n),t.forEach(([s,o])=>{o.length===1?Eh(r,o[0][0],s,o[0][1]):o.forEach(([i,c])=>{Eh(r,i,s,c)})}),new Br(r)}),Hx=tc,Dx=Lx,Ux=xx,Kx=OO,jx=PO,zx=xO,Vx=bw,qx=_w,Wx=ww,Jx=FO,Gx=NO,Yx=p(_o,hb(e=>e.ordinal)),Qx=XC(Yx),Xx=e=>{switch(e){case"All":return Kx;case"Debug":return Wx;case"Error":return zx;case"Fatal":return jx;case"Info":return qx;case"Trace":return Jx;case"None":return Gx;case"Warning":return Vx}},Gw=e=>e.replace(/[\s="]/g,"_"),Zx=e=>t=>`${Gw(t.label)}=${e-t.startTime}ms`,eF=gc,tF=MC;let si=class extends tF{};const Mo=Symbol.for("effect/Readable"),Cp=Symbol.for("effect/Ref"),Ip={_A:e=>e};class nF extends si{ref;commit(){return this.get}[Cp]=Ip;[Mo]=Mo;constructor(t){super(),this.ref=t,this.get=M(()=>_e(this.ref))}get;modify(t){return M(()=>{const n=_e(this.ref),[r,s]=t(n);return n!==s&&Is(s)(this.ref),r})}}const $p=e=>new nF(Cs(e)),eu=e=>M(()=>$p(e)),mn=e=>e.get,uo=d(2,(e,t)=>e.modify(()=>[void 0,t])),Yw=d(2,(e,t)=>e.modify(t)),tu=d(2,(e,t)=>e.modify(n=>[void 0,t(n)])),rF=Cp,Ap=eu,Ni=mn,di=Yw,Qw=uo,Xw=tu,Zw="Empty",ev="Add",tv="Remove",nv="Update",rv="AndThen",sF={_tag:Zw},sv=(e,t)=>{const n=new Map(e.locals);let r=sF;for(const[s,o]of t.locals.entries()){const i=zt(o)[1],c=n.get(s);if(c!==void 0){const a=zt(c)[1];oe(a,i)||(r=lf({_tag:nv,fiberRef:s,patch:s.diff(a,i)})(r))}else r=lf({_tag:ev,fiberRef:s,value:i})(r);n.delete(s)}for(const[s]of n.entries())r=lf({_tag:tv,fiberRef:s})(r);return r},lf=d(2,(e,t)=>({_tag:rv,first:e,second:t})),ov=d(3,(e,t,n)=>{let r=n,s=Sn(e);for(;wt(s);){const o=zt(s),i=hs(s);switch(o._tag){case Zw:{s=i;break}case ev:{r=kh(r,{fiberId:t,fiberRef:o.fiberRef,value:o.value}),s=i;break}case tv:{r=Jw(r,o.fiberRef),s=i;break}case nv:{const c=tc(r,o.fiberRef);r=kh(r,{fiberId:t,fiberRef:o.fiberRef,value:o.fiberRef.patch(o.patch)(c)}),s=i;break}case rv:{s=Ha(o.first)(Ha(o.second)(i));break}}}return r}),iv="effect/MetricLabel",Ch=Symbol.for(iv);class oF{key;value;[Ch]=Ch;_hash;constructor(t,n){this.key=t,this.value=n,this._hash=Ze(iv+this.key+this.value)}[he](){return this._hash}[fe](t){return cF(t)&&this.key===t.key&&this.value===t.value}pipe(){return G(this,arguments)}}const iF=(e,t)=>new oF(e,t),cF=e=>te(e,Ch),aF=e=>ne(e,U),uF=d(2,(e,t)=>on(e,{onFailure:n=>{const r=t(n);switch(r._tag){case"None":return ft(n);case"Some":return r.value}},onSuccess:L})),lF=e=>_F(e,hF,sv),cv=d(2,(e,t)=>zn(e,{onFailure:n=>L(t.onFailure(n)),onSuccess:n=>L(t.onSuccess(n))})),fF=e=>{const t=P(P(e,()=>ol()),()=>t);return t},hF=Ee(e=>L(e.getFiberRefs())),dF=e=>cv(e,{onFailure:Pa,onSuccess:Pa}),Yg=d(2,(e,t)=>on(e,{onFailure:n=>dw(()=>t(n)),onSuccess:L})),pF=e=>ne(e,t=>!t),mF=e=>TF((t,n)=>p(e,ov(t,n))),gF=e=>e.length>=1?jn((t,n)=>{try{e(n).then(r=>t(L(r)),r=>t(Er(r)))}catch(r){t(Er(r))}}):jn(t=>{try{e().then(n=>t(L(n)),n=>t(Er(n)))}catch(n){t(Er(n))}}),yF=d(3,(e,t,n)=>Os(r=>hl(e,Yr(r,t,n)))),nu=d(3,(e,t,n)=>Os(r=>P(n,s=>hl(e,p(r,Yr(t,s)))))),SF=d(3,(e,t,n)=>Ne(e).reduce((r,s,o)=>P(r,i=>n(i,s,o)),L(t))),av=Rx,bF=L(K()),_F=d(3,(e,t,n)=>P(t,r=>P(e,s=>ne(t,o=>[n(r,o),s])))),wF=d(2,(e,t)=>on(e,{onFailure:n=>gt(t(n),ft(n)),onSuccess:L})),vF=e=>{let t,n;typeof e=="function"?t=e:(t=e.try,n=e.catch);const r=s=>n?Zu(()=>n(s)):st(new Cw(s,"An unknown error occurred in Effect.tryPromise"));return t.length>=1?jn((s,o)=>{try{t(o).then(i=>s(L(i)),i=>s(r(i)))}catch(i){s(r(i))}}):jn(s=>{try{t().then(o=>s(L(o)),o=>s(r(o)))}catch(o){s(r(o))}})},TF=e=>Ee(t=>(t.setFiberRefs(e(t.id(),t.getFiberRefs())),Ke)),kF=d(2,(e,t)=>ae(()=>t()?ne(e,U):L(K()))),uv="Sequential",lv="Parallel",EF="ParallelN",Rr={_tag:uv},Ih={_tag:lv},CF=e=>({_tag:EF,parallelism:e}),IF=e=>e._tag===uv,$F=e=>e._tag===lv,ru=Rr,$h=Ih,Ah=CF,nc=sv,rc=ov,gl="effect/FiberStatus",ws=Symbol.for(gl),su="Done",Qg="Running",Xg="Suspended",AF=Ze(`${gl}-${su}`);let RF=class{[ws]=ws;_tag=su;[he](){return AF}[fe](t){return Rp(t)&&t._tag===su}};class OF{runtimeFlags;[ws]=ws;_tag=Qg;constructor(t){this.runtimeFlags=t}[he](){return p(Y(gl),ye(Y(this._tag)),ye(Y(this.runtimeFlags)),Ye(this))}[fe](t){return Rp(t)&&t._tag===Qg&&this.runtimeFlags===t.runtimeFlags}}class PF{runtimeFlags;blockingOn;[ws]=ws;_tag=Xg;constructor(t,n){this.runtimeFlags=t,this.blockingOn=n}[he](){return p(Y(gl),ye(Y(this._tag)),ye(Y(this.runtimeFlags)),ye(Y(this.blockingOn)),Ye(this))}[fe](t){return Rp(t)&&t._tag===Xg&&this.runtimeFlags===t.runtimeFlags&&oe(this.blockingOn,t.blockingOn)}}const xF=new RF,FF=e=>new OF(e),NF=(e,t)=>new PF(e,t),Rp=e=>te(e,ws),BF=e=>e._tag===su,MF=xF,fv=FF,LF=NF,hv=BF,HF=Symbol.for("effect/Micro"),ou=Symbol.for("effect/Micro/MicroExit"),Zg=Symbol.for("effect/Micro/MicroCause"),DF={_E:ee};class dv extends globalThis.Error{_tag;traces;[Zg];constructor(t,n,r){const s=`MicroCause.${t}`;let o,i,c;if(n instanceof globalThis.Error){o=`(${s}) ${n.name}`,i=n.message;const a=i.split(`
`).length;c=n.stack?`(${s}) ${n.stack.split(`
`).slice(0,a+3).join(`
`)}`:`${o}: ${i}`}else o=s,i=So(n,0),c=`${o}: ${i}`;r.length>0&&(c+=`
    ${r.join(`
    `)}`),super(i),this._tag=t,this.traces=r,this[Zg]=DF,this.name=o,this.stack=c}pipe(){return G(this,arguments)}toString(){return this.stack}[Me](){return this.stack}}class UF extends dv{defect;constructor(t,n=[]){super("Die",t,n),this.defect=t}}const KF=(e,t=[])=>new UF(e,t);class jF extends dv{constructor(t=[]){super("Interrupt","interrupted",t)}}const zF=(e=[])=>new jF(e),VF=e=>e._tag==="Interrupt",ey=Symbol.for("effect/Micro/MicroFiber"),qF={_A:ee,_E:ee};class WF{context;interruptible;[ey];_stack=[];_observers=[];_exit;_children;currentOpCount=0;constructor(t,n=!0){this.context=t,this.interruptible=n,this[ey]=qF}getRef(t){return U$(this.context,t)}addObserver(t){return this._exit?(t(this._exit),Pa):(this._observers.push(t),()=>{const n=this._observers.indexOf(t);n>=0&&this._observers.splice(n,1)})}_interrupted=!1;unsafeInterrupt(){this._exit||(this._interrupted=!0,this.interruptible&&this.evaluate(Np))}unsafePoll(){return this._exit}evaluate(t){if(this._exit)return;if(this._yielded!==void 0){const s=this._yielded;this._yielded=void 0,s()}const n=this.runLoop(t);if(n===Yc)return;const r=ty.interruptChildren&&ty.interruptChildren(this);if(r!==void 0)return this.evaluate(cu(r,()=>n));this._exit=n;for(let s=0;s<this._observers.length;s++)this._observers[s](n);this._observers.length=0}runLoop(t){let n=!1,r=t;this.currentOpCount=0;try{for(;;){if(this.currentOpCount++,!n&&this.getRef(Bp).shouldYield(this)){n=!0;const s=r;r=cu(XF,()=>s)}if(r=r[Rh](this),r===Yc){const s=this._yielded;return ou in s?(this._yielded=void 0,s):Yc}}}catch(s){return te(r,Rh)?Oh(s):Oh(`MicroFiber.runLoop: Not a valid effect: ${String(r)}`)}}getCont(t){for(;;){const n=this._stack.pop();if(!n)return;const r=n[iu]&&n[iu](this);if(r)return{[t]:r};if(n[t])return n}}_yielded=void 0;yieldWith(t){return this._yielded=t,Yc}children(){return this._children??=new Set}}const ty=be("effect/Micro/fiberMiddleware",()=>({interruptChildren:void 0})),pv=Symbol.for("effect/Micro/identifier"),yt=Symbol.for("effect/Micro/args"),Rh=Symbol.for("effect/Micro/evaluate"),Lo=Symbol.for("effect/Micro/successCont"),lo=Symbol.for("effect/Micro/failureCont"),iu=Symbol.for("effect/Micro/ensureCont"),Yc=Symbol.for("effect/Micro/Yield"),JF={_A:ee,_E:ee,_R:ee},GF={...eF,_op:"Micro",[HF]:JF,pipe(){return G(this,arguments)},[Symbol.iterator](){return new WS(new pc(this))},toJSON(){return{_id:"Micro",op:this[pv],...yt in this?{args:this[yt]}:void 0}},toString(){return at(this)},[Me](){return at(this)}};function YF(e){return Oh("Micro.evaluate: Not implemented")}const yl=e=>({...GF,[pv]:e.op,[Rh]:e.eval??YF,[Lo]:e.contA,[lo]:e.contE,[iu]:e.ensure}),Op=e=>{const t=yl(e);return function(){const n=Object.create(t);return n[yt]=e.single===!1?arguments:arguments[0],n}},mv=e=>{const t={...yl(e),[ou]:ou,_tag:e.op,get[e.prop](){return this[yt]},toJSON(){return{_id:"MicroExit",_tag:e.op,[e.prop]:this[yt]}},[fe](n){return tN(n)&&n._tag===e.op&&oe(this[yt],n[yt])},[he](){return Ye(this,ye(Ze(e.op))(Y(this[yt])))}};return function(n){const r=Object.create(t);return r[yt]=n,r[Lo]=void 0,r[lo]=void 0,r[iu]=void 0,r}},Pp=mv({op:"Success",prop:"value",eval(e){const t=e.getCont(Lo);return t?t[Lo](this[yt],e):e.yieldWith(this)}}),gv=mv({op:"Failure",prop:"cause",eval(e){let t=e.getCont(lo);for(;VF(this[yt])&&t&&e.interruptible;)t=e.getCont(lo);return t?t[lo](this[yt],e):e.yieldWith(this)}}),QF=Op({op:"Yield",eval(e){let t=!1;return e.getRef(Bp).scheduleTask(()=>{t||e.evaluate(nN)},this[yt]??0),e.yieldWith(()=>{t=!0})}}),XF=QF(0),ZF=Pp(void 0),xp=Op({op:"WithMicroFiber",eval(e){return this[yt](e)}}),cu=d(2,(e,t)=>{const n=Object.create(eN);return n[yt]=e,n[Lo]=t,n}),eN=yl({op:"OnSuccess",eval(e){return e._stack.push(this),this[yt]}}),tN=e=>te(e,ou),yv=Pp,Fp=gv,Np=Fp(zF()),Oh=e=>Fp(KF(e)),nN=yv(void 0),rN="setImmediate"in globalThis?globalThis.setImmediate:e=>setTimeout(e,0);class Sv{tasks=[];running=!1;scheduleTask(t,n){this.tasks.push(t),this.running||(this.running=!0,rN(this.afterScheduled))}afterScheduled=()=>{this.running=!1,this.runTasks()};runTasks(){const t=this.tasks;this.tasks=[];for(let n=0,r=t.length;n<r;n++)t[n]()}shouldYield(t){return t.currentOpCount>=t.getRef(iN)}flush(){for(;this.tasks.length>0;)this.runTasks()}}const sN=d(2,(e,t)=>xp(n=>{const r=n.context;return n.context=t(r),uN(e,()=>(n.context=r,ZF))})),oN=d(2,(e,t)=>sN(e,Nu(t)));class iN extends Bu()("effect/Micro/currentMaxOpsBeforeYield",{defaultValue:()=>2048}){}class Bp extends Bu()("effect/Micro/currentScheduler",{defaultValue:()=>new Sv}){}const cN=d(2,(e,t)=>{const n=Object.create(aN);return n[yt]=e,n[Lo]=t.onSuccess,n[lo]=t.onFailure,n}),aN=yl({op:"OnSuccessAndFailure",eval(e){return e._stack.push(this),this[yt]}}),uN=d(2,(e,t)=>fN(n=>cN(n(e),{onFailure:r=>cu(t(Fp(r)),()=>gv(r)),onSuccess:r=>cu(t(yv(r)),()=>Pp(r))}))),bv=Op({op:"SetInterruptible",ensure(e){if(e.interruptible=this[yt],e._interrupted&&e.interruptible)return()=>Np}}),lN=e=>xp(t=>t.interruptible?e:(t.interruptible=!0,t._stack.push(bv(!1)),t._interrupted?Np:e)),fN=e=>xp(t=>t.interruptible?(t.interruptible=!1,t._stack.push(bv(!0)),e(lN)):e(ee)),hN=(e,t)=>{const n=new WF(Bp.context(new Sv));return n.evaluate(e),n};class _v{buckets=[];scheduleTask(t,n){const r=this.buckets.length;let s,o=0;for(;o<r&&this.buckets[o][0]<=n;o++)s=this.buckets[o];s&&s[0]===n?s[1].push(t):o===r?this.buckets.push([n,[t]]):this.buckets.splice(o,0,[n,[t]])}}class dN{maxNextTickBeforeTimer;running=!1;tasks=new _v;constructor(t){this.maxNextTickBeforeTimer=t}starveInternal(t){const n=this.tasks.buckets;this.tasks.buckets=[];for(const[r,s]of n)for(let o=0;o<s.length;o++)s[o]();this.tasks.buckets.length===0?this.running=!1:this.starve(t)}starve(t=0){t>=this.maxNextTickBeforeTimer?setTimeout(()=>this.starveInternal(0),0):Promise.resolve(void 0).then(()=>this.starveInternal(t+1))}shouldYield(t){return t.currentOpCount>t.getFiberRef(Tw)?t.getFiberRef($c):!1}scheduleTask(t,n){this.tasks.scheduleTask(t,n),this.running||(this.running=!0,this.starve())}}const wv=be(Symbol.for("effect/Scheduler/defaultScheduler"),()=>new dN(2048));class vv{tasks=new _v;deferred=!1;scheduleTask(t,n){this.deferred?wv.scheduleTask(t,n):this.tasks.scheduleTask(t,n)}shouldYield(t){return t.currentOpCount>t.getFiberRef(Tw)?t.getFiberRef($c):!1}flush(){for(;this.tasks.buckets.length>0;){const t=this.tasks.buckets;this.tasks.buckets=[];for(const[n,r]of t)for(let s=0;s<r.length;s++)r[s]()}this.deferred=!0}}const Mp=be(Symbol.for("effect/FiberRef/currentScheduler"),()=>Yt(wv)),Tv=be(Symbol.for("effect/FiberRef/currentRequestMap"),()=>Yt(new Map)),ny=(e,t,n,r)=>{switch(e){case void 0:return t();case"unbounded":return n();case"inherit":return cl(JO,s=>s==="unbounded"?n():s>1?r(s):t());default:return e>1?r(e):t()}},Lp="InterruptSignal",Hp="Stateful",Dp="Resume",Up="YieldNow",ff=e=>({_tag:Lp,cause:e}),ba=e=>({_tag:Hp,onFiber:e}),Ls=e=>({_tag:Dp,effect:e}),pN=()=>({_tag:Up}),mN="effect/FiberScope",au=Symbol.for(mN);class gN{[au]=au;fiberId=Co;roots=new Set;add(t,n){this.roots.add(n),n.addObserver(()=>{this.roots.delete(n)})}}class yN{fiberId;parent;[au]=au;constructor(t,n){this.fiberId=t,this.parent=n}add(t,n){this.parent.tell(ba(r=>{r.addChild(n),n.addObserver(()=>{r.removeChild(n)})}))}}const SN=e=>new yN(e.id(),e),Sl=be(Symbol.for("effect/FiberScope/Global"),()=>new gN),bN="effect/Fiber",_N=Symbol.for(bN),wN={_E:e=>e,_A:e=>e},vN="effect/Fiber",TN=Symbol.for(vN),kN=e=>e.await,EN=e=>e.inheritAll,sc=e=>il(Ec(e.await),e.inheritAll);({...yc});const CN=e=>e.status,Vr="effect/FiberCurrent",IN="effect/Logger",$N=Symbol.for(IN),AN={_Message:e=>e,_Output:e=>e},Kp=e=>({[$N]:AN,log:e,pipe(){return G(this,arguments)}}),RN=/^[^\s"=]*$/,ON=(e,t)=>({annotations:n,cause:r,date:s,fiberId:o,logLevel:i,message:c,spans:a})=>{const u=y=>y.match(RN)?y:e(y),l=(y,b)=>`${Gw(y)}=${u(b)}`,f=(y,b)=>" "+l(y,b);let h=l("timestamp",s.toISOString());h+=f("level",i.label),h+=f("fiber",A_(o));const m=fI(c);for(let y=0;y<m.length;y++)h+=f("message",So(m[y],t));Z1(r)||(h+=f("cause",ti(r,{renderErrorCause:!0})));for(const y of a)h+=" "+Zx(s.getTime())(y);for(const[y,b]of n)h+=f(y,So(b,t));return h},PN=e=>`"${e.replace(/\\([\s\S])|(")/g,"\\$1$2")}"`,xN=Kp(ON(PN)),FN=typeof process=="object"&&process!==null&&typeof process.stdout=="object"&&process.stdout!==null;FN&&process.stdout.isTTY;const kv="effect/MetricBoundaries",Ph=Symbol.for(kv);class NN{values;[Ph]=Ph;constructor(t){this.values=t,this._hash=p(Ze(kv),ye(mc(this.values)))}_hash;[he](){return this._hash}[fe](t){return BN(t)&&oe(this.values,t.values)}pipe(){return G(this,arguments)}}const BN=e=>te(e,Ph),MN=e=>{const t=p(e,db(Be(Number.POSITIVE_INFINITY)),RI);return new NN(t)},LN=e=>p(lI(e.count-1,t=>e.start*Math.pow(e.factor,t)),sn,MN),HN="effect/MetricKeyType",Ev=Symbol.for(HN),Cv="effect/MetricKeyType/Counter",xh=Symbol.for(Cv),DN="effect/MetricKeyType/Frequency",UN=Symbol.for(DN),KN="effect/MetricKeyType/Gauge",jN=Symbol.for(KN),Iv="effect/MetricKeyType/Histogram",Fh=Symbol.for(Iv),zN="effect/MetricKeyType/Summary",VN=Symbol.for(zN),$v={_In:e=>e,_Out:e=>e};class qN{incremental;bigint;[Ev]=$v;[xh]=xh;constructor(t,n){this.incremental=t,this.bigint=n,this._hash=Ze(Cv)}_hash;[he](){return this._hash}[fe](t){return Av(t)}pipe(){return G(this,arguments)}}class WN{boundaries;[Ev]=$v;[Fh]=Fh;constructor(t){this.boundaries=t,this._hash=p(Ze(Iv),ye(Y(this.boundaries)))}_hash;[he](){return this._hash}[fe](t){return Rv(t)&&oe(this.boundaries,t.boundaries)}pipe(){return G(this,arguments)}}const JN=e=>new qN(e?.incremental??!1,e?.bigint??!1),GN=e=>new WN(e),Av=e=>te(e,xh),YN=e=>te(e,UN),QN=e=>te(e,jN),Rv=e=>te(e,Fh),XN=e=>te(e,VN),ZN="effect/MetricKey",Ov=Symbol.for(ZN),eB={_Type:e=>e},tB=Nd(oe);class jp{name;keyType;description;tags;[Ov]=eB;constructor(t,n,r,s=[]){this.name=t,this.keyType=n,this.description=r,this.tags=s,this._hash=p(Ze(this.name+this.description),ye(Y(this.keyType)),ye(mc(this.tags)))}_hash;[he](){return this._hash}[fe](t){return nB(t)&&this.name===t.name&&oe(this.keyType,t.keyType)&&oe(this.description,t.description)&&tB(this.tags,t.tags)}pipe(){return G(this,arguments)}}const nB=e=>te(e,Ov),rB=(e,t)=>new jp(e,JN(t),$u(t?.description)),sB=(e,t,n)=>new jp(e,GN(t),$u(n)),oB=d(2,(e,t)=>t.length===0?e:new jp(e.name,e.keyType,e.description,pa(e.tags,t))),iB="effect/MetricState",Pc=Symbol.for(iB),Pv="effect/MetricState/Counter",Nh=Symbol.for(Pv),xv="effect/MetricState/Frequency",Bh=Symbol.for(xv),Fv="effect/MetricState/Gauge",Mh=Symbol.for(Fv),Nv="effect/MetricState/Histogram",Lh=Symbol.for(Nv),Bv="effect/MetricState/Summary",Hh=Symbol.for(Bv),xc={_A:e=>e};class cB{count;[Pc]=xc;[Nh]=Nh;constructor(t){this.count=t}[he](){return p(Y(Pv),ye(Y(this.count)),Ye(this))}[fe](t){return SB(t)&&this.count===t.count}pipe(){return G(this,arguments)}}const aB=Nd(oe);class uB{occurrences;[Pc]=xc;[Bh]=Bh;constructor(t){this.occurrences=t}_hash;[he](){return p(Ze(xv),ye(mc(Ne(this.occurrences.entries()))),Ye(this))}[fe](t){return bB(t)&&aB(Ne(this.occurrences.entries()),Ne(t.occurrences.entries()))}pipe(){return G(this,arguments)}}class lB{value;[Pc]=xc;[Mh]=Mh;constructor(t){this.value=t}[he](){return p(Y(Fv),ye(Y(this.value)),Ye(this))}[fe](t){return _B(t)&&this.value===t.value}pipe(){return G(this,arguments)}}class fB{buckets;count;min;max;sum;[Pc]=xc;[Lh]=Lh;constructor(t,n,r,s,o){this.buckets=t,this.count=n,this.min=r,this.max=s,this.sum=o}[he](){return p(Y(Nv),ye(Y(this.buckets)),ye(Y(this.count)),ye(Y(this.min)),ye(Y(this.max)),ye(Y(this.sum)),Ye(this))}[fe](t){return wB(t)&&oe(this.buckets,t.buckets)&&this.count===t.count&&this.min===t.min&&this.max===t.max&&this.sum===t.sum}pipe(){return G(this,arguments)}}class hB{error;quantiles;count;min;max;sum;[Pc]=xc;[Hh]=Hh;constructor(t,n,r,s,o,i){this.error=t,this.quantiles=n,this.count=r,this.min=s,this.max=o,this.sum=i}[he](){return p(Y(Bv),ye(Y(this.error)),ye(Y(this.quantiles)),ye(Y(this.count)),ye(Y(this.min)),ye(Y(this.max)),ye(Y(this.sum)),Ye(this))}[fe](t){return vB(t)&&this.error===t.error&&oe(this.quantiles,t.quantiles)&&this.count===t.count&&this.min===t.min&&this.max===t.max&&this.sum===t.sum}pipe(){return G(this,arguments)}}const dB=e=>new cB(e),pB=e=>new uB(e),mB=e=>new lB(e),gB=e=>new fB(e.buckets,e.count,e.min,e.max,e.sum),yB=e=>new hB(e.error,e.quantiles,e.count,e.min,e.max,e.sum),SB=e=>te(e,Nh),bB=e=>te(e,Bh),_B=e=>te(e,Mh),wB=e=>te(e,Lh),vB=e=>te(e,Hh),TB="effect/MetricHook",kB=Symbol.for(TB),EB={_In:e=>e,_Out:e=>e},Fc=e=>({[kB]:EB,pipe(){return G(this,arguments)},...e}),ry=BigInt(0),CB=e=>{let t=e.keyType.bigint?ry:0;const n=e.keyType.incremental?e.keyType.bigint?s=>s>=ry:s=>s>=0:s=>!0,r=s=>{n(s)&&(t=t+s)};return Fc({get:()=>dB(t),update:r,modify:r})},IB=e=>{const t=new Map;for(const r of e.keyType.preregisteredWords)t.set(r,0);const n=r=>{const s=t.get(r)??0;t.set(r,s+1)};return Fc({get:()=>pB(t),update:n,modify:n})},$B=(e,t)=>{let n=t;return Fc({get:()=>mB(n),update:r=>{n=r},modify:r=>{n=n+r}})},AB=e=>{const t=e.keyType.boundaries.values,n=t.length,r=new Uint32Array(n+1),s=new Float64Array(n);let o=0,i=0,c=Number.MAX_VALUE,a=Number.MIN_VALUE;p(t,ji(_o),os((f,h)=>{s[h]=f}));const u=f=>{let h=0,m=n;for(;h!==m;){const y=Math.floor(h+(m-h)/2),b=s[y];f<=b?m=y:h=y,m===h+1&&(f<=s[h]?m=h:h=m)}r[h]=r[h]+1,o=o+1,i=i+f,f<c&&(c=f),f>a&&(a=f)},l=()=>{const f=Au(n);let h=0;for(let m=0;m<n;m++){const y=s[m],b=r[m];h=h+b,f[m]=[y,h]}return f};return Fc({get:()=>gB({buckets:l(),count:o,min:c,max:a,sum:i}),update:u,modify:u})},RB=e=>{const{error:t,maxAge:n,maxSize:r,quantiles:s}=e.keyType,o=p(s,ji(_o)),i=Au(r);let c=0,a=0,u=0,l=0,f=0;const h=y=>{const b=[];let _=0;for(;_!==r-1;){const T=i[_];if(T!=null){const[C,v]=T,k=ie(y-C);wA(k,vo)&&_A(k,n)&&b.push(v)}_=_+1}return OB(t,o,ji(b,_o))},m=(y,b)=>{if(r>0){c=c+1;const _=c%r;i[_]=[b,y]}l=a===0?y:Math.min(l,y),f=a===0?y:Math.max(f,y),a=a+1,u=u+y};return Fc({get:()=>yB({error:t,quantiles:h(Date.now()),count:a,min:l,max:f,sum:u}),update:([y,b])=>m(y,b),modify:([y,b])=>m(y,b)})},OB=(e,t,n)=>{const r=n.length;if(!wt(t))return ds();const s=t[0],o=t.slice(1),i=sy(e,r,K(),0,s,n),c=Sn(i);return o.forEach(a=>{c.push(sy(e,r,i.value,i.consumed,a,i.rest))}),os(c,a=>[a.quantile,a.value])},sy=(e,t,n,r,s,o)=>{let i=e,c=t,a=n,u=r,l=s,f=o,h=e,m=t,y=n,b=r,_=s,T=o;for(;;){if(!wt(f))return{quantile:l,value:K(),consumed:u,rest:[]};if(l===1)return{quantile:l,value:U(gb(f)),consumed:u+f.length,rest:[]};const C=zt(f),v=wI(f,O=>O===C),k=l*c,R=i/2*k,w=u+v[0].length,I=Math.abs(w-k);if(w<k-R){h=i,m=c,y=Pi(f),b=w,_=l,T=v[1],i=h,c=m,a=y,u=b,l=_,f=T;continue}if(w>k+R){const O=Ue(a)?U(C):a;return{quantile:l,value:O,consumed:u,rest:f}}switch(a._tag){case"None":{h=i,m=c,y=Pi(f),b=w,_=l,T=v[1],i=h,c=m,a=y,u=b,l=_,f=T;continue}case"Some":{const O=Math.abs(k-a.value);if(I<O){h=i,m=c,y=Pi(f),b=w,_=l,T=v[1],i=h,c=m,a=y,u=b,l=_,f=T;continue}return{quantile:l,value:U(a.value),consumed:u,rest:f}}}}throw new Error("BUG: MetricHook.resolveQuantiles - please report an issue at https://github.com/Effect-TS/effect/issues")},PB="effect/MetricPair",xB=Symbol.for(PB),FB={_Type:e=>e},NB=(e,t)=>({[xB]:FB,metricKey:e,metricState:t,pipe(){return G(this,arguments)}}),BB="effect/MetricRegistry",oy=Symbol.for(BB);class MB{[oy]=oy;map=_P();snapshot(){const t=[];for(const[n,r]of this.map)t.push(NB(n,r.get()));return t}get(t){const n=p(this.map,Gr(t),Rn);if(n==null){if(Av(t.keyType))return this.getCounter(t);if(QN(t.keyType))return this.getGauge(t);if(YN(t.keyType))return this.getFrequency(t);if(Rv(t.keyType))return this.getHistogram(t);if(XN(t.keyType))return this.getSummary(t);throw new Error("BUG: MetricRegistry.get - unknown MetricKeyType - please report an issue at https://github.com/Effect-TS/effect/issues")}else return n}getCounter(t){let n=p(this.map,Gr(t),Rn);if(n==null){const r=CB(t);p(this.map,fi(t))||p(this.map,hi(t,r)),n=r}return n}getFrequency(t){let n=p(this.map,Gr(t),Rn);if(n==null){const r=IB(t);p(this.map,fi(t))||p(this.map,hi(t,r)),n=r}return n}getGauge(t){let n=p(this.map,Gr(t),Rn);if(n==null){const r=$B(t,t.keyType.bigint?BigInt(0):0);p(this.map,fi(t))||p(this.map,hi(t,r)),n=r}return n}getHistogram(t){let n=p(this.map,Gr(t),Rn);if(n==null){const r=AB(t);p(this.map,fi(t))||p(this.map,hi(t,r)),n=r}return n}getSummary(t){let n=p(this.map,Gr(t),Rn);if(n==null){const r=RB(t);p(this.map,fi(t))||p(this.map,hi(t,r)),n=r}return n}}const LB=()=>new MB,HB="effect/Metric",DB=Symbol.for(HB),UB={_Type:e=>e,_In:e=>e,_Out:e=>e},iy=be(Symbol.for("effect/Metric/globalMetricRegistry"),()=>LB()),Mv=function(e,t,n,r){const s=Object.assign(o=>rl(o,i=>VB(s,i)),{[DB]:UB,keyType:e,unsafeUpdate:t,unsafeValue:n,unsafeModify:r,register(){return this.unsafeValue([]),this},pipe(){return G(this,arguments)}});return s},bl=(e,t)=>Lv(rB(e,t)),Lv=e=>{let t;const n=new WeakMap,r=s=>{if(s.length===0)return t!==void 0||(t=iy.get(e)),t;let o=n.get(s);return o!==void 0||(o=iy.get(oB(e,s)),n.set(s,o)),o};return Mv(e.keyType,(s,o)=>r(o).update(s),s=>r(s).get(),(s,o)=>r(o).modify(s))},KB=(e,t,n)=>Lv(sB(e,t,n)),jB=d(3,(e,t,n)=>zB(e,[iF(t,n)])),zB=d(2,(e,t)=>Mv(e.keyType,(n,r)=>e.unsafeUpdate(n,pa(t,r)),n=>e.unsafeValue(pa(t,n)),(n,r)=>e.unsafeModify(n,pa(t,r)))),VB=d(2,(e,t)=>cl(Sh,n=>M(()=>e.unsafeUpdate(t,n))));({...Rd});const qB=d(2,(e,t)=>cl(Tv,n=>M(()=>{if(n.has(e)){const r=n.get(e);r.state.completed||(r.state.completed=!0,fl(r.result,t))}}))),WB="effect/Supervisor",_l=Symbol.for(WB),zp={_T:e=>e};class wl{underlying;value0;[_l]=zp;constructor(t,n){this.underlying=t,this.value0=n}get value(){return this.value0}onStart(t,n,r,s){this.underlying.onStart(t,n,r,s)}onEnd(t,n){this.underlying.onEnd(t,n)}onEffect(t,n){this.underlying.onEffect(t,n)}onSuspend(t){this.underlying.onSuspend(t)}onResume(t){this.underlying.onResume(t)}map(t){return new wl(this,p(this.value,ne(t)))}zip(t){return new vl(this,t)}}class vl{left;right;_tag="Zip";[_l]=zp;constructor(t,n){this.left=t,this.right=n}get value(){return yw(this.left.value,this.right.value)}onStart(t,n,r,s){this.left.onStart(t,n,r,s),this.right.onStart(t,n,r,s)}onEnd(t,n){this.left.onEnd(t,n),this.right.onEnd(t,n)}onEffect(t,n){this.left.onEffect(t,n),this.right.onEffect(t,n)}onSuspend(t){this.left.onSuspend(t),this.right.onSuspend(t)}onResume(t){this.left.onResume(t),this.right.onResume(t)}map(t){return new wl(this,p(this.value,ne(t)))}zip(t){return new vl(this,t)}}const Hv=e=>te(e,_l)&&VS(e,"Zip");class JB{effect;[_l]=zp;constructor(t){this.effect=t}get value(){return this.effect}onStart(t,n,r,s){}onEnd(t,n){}onEffect(t,n){}onSuspend(t){}onResume(t){}map(t){return new wl(this,p(this.value,ne(t)))}zip(t){return new vl(this,t)}onRun(t,n){return t()}}const GB=e=>new JB(e),Tl=be("effect/Supervisor/none",()=>GB(Ke)),YB=Qo,Dv="Empty",Uv="AddSupervisor",Kv="RemoveSupervisor",jv="AndThen",Bi={_tag:Dv},_a=(e,t)=>({_tag:jv,first:e,second:t}),QB=(e,t)=>XB(t,Be(e)),XB=(e,t)=>{let n=e,r=t;for(;Kn(r);){const s=Fn(r);switch(s._tag){case Dv:{r=sr(r);break}case Uv:{n=n.zip(s.supervisor),r=sr(r);break}case Kv:{n=Dh(n,s.supervisor),r=sr(r);break}case jv:{r=Nt(s.first)(Nt(s.second)(sr(r)));break}}}return n},Dh=(e,t)=>oe(e,t)?Tl:Hv(e)?Dh(e.left,t).zip(Dh(e.right,t)):e,uu=e=>oe(e,Tl)?gs():Hv(e)?p(uu(e.left),Gi(uu(e.right))):tp(e),ZB=(e,t)=>{if(oe(e,t))return Bi;const n=uu(e),r=uu(t),s=p(r,gg(n),Yi(Bi,(i,c)=>_a(i,{_tag:Uv,supervisor:c}))),o=p(n,gg(r),Yi(Bi,(i,c)=>_a(i,{_tag:Kv,supervisor:c})));return _a(s,o)},eM=YB({empty:Bi,patch:QB,combine:_a,diff:ZB}),tM=bl("effect_fiber_started",{incremental:!0}),cy=bl("effect_fiber_active"),nM=bl("effect_fiber_successes",{incremental:!0}),rM=bl("effect_fiber_failures",{incremental:!0}),sM=jB(KB("effect_fiber_lifetimes",LN({start:.5,factor:2,count:35})),"time_unit","milliseconds"),pi="Continue",oM="Done",ay="Yield",iM={_E:e=>e,_A:e=>e},Qc=e=>{throw new Error(`BUG: FiberRuntime - ${So(e)} - please report an issue at https://github.com/Effect-TS/effect/issues`)},Yn=Symbol.for("effect/internal/fiberRuntime/YieldedOp"),Qn=be("effect/internal/fiberRuntime/yieldedOpChannel",()=>({currentOp:null})),mi={[Na]:(e,t,n)=>Ut(()=>t.effect_instruction_i1(n)),OnStep:(e,t,n)=>et(et(n)),[Ba]:(e,t,n)=>Ut(()=>t.effect_instruction_i2(n)),[$d]:(e,t,n)=>(e.patchRuntimeFlags(e.currentRuntimeFlags,t.patch),Tr(e.currentRuntimeFlags)&&e.isInterrupted()?Oe(e.getInterruptedCause()):et(n)),[Ma]:(e,t,n)=>(Ut(()=>t.effect_instruction_i2(n)),Ut(()=>t.effect_instruction_i0())?(e.pushStack(t),Ut(()=>t.effect_instruction_i1())):Ke),[Oi]:(e,t,n)=>{for(;;){const r=Ut(()=>t.effect_instruction_i0.next(n));if(r.done)return et(r.value);const s=bC(r.value);if(al(s)){if(s._tag==="Failure")return s}else return e.pushStack(t),s;n=s.value}}},cM={[Lp]:(e,t,n,r)=>(e.processNewInterruptSignal(r.cause),Tr(t)?Oe(r.cause):n),[Dp]:(e,t,n,r)=>{throw new Error("It is illegal to have multiple concurrent run loops in a single fiber")},[Hp]:(e,t,n,r)=>(r.onFiber(e,fv(t)),n),[Up]:(e,t,n,r)=>P(ol(),()=>n)},aM=e=>tl(B1(e),t=>Hn(Y1(t),([n,r])=>{const s=new Map,o=[];for(const c of r){o.push(cr(c));for(const a of c)s.set(a.request,a)}const i=o.flat();return Ic(OM(n.runAll(o),i,()=>i.forEach(c=>{c.listeners.interrupted=!0})),Tv,s)},!1,!1)),uM=Ad();class zv extends si{[_N]=wN;[TN]=iM;_fiberRefs;_fiberId;_queue=new Array;_children=null;_observers=new Array;_running=!1;_stack=[];_asyncInterruptor=null;_asyncBlockingOn=null;_exitValue=null;_steps=[];_isYielding=!1;currentRuntimeFlags;currentOpCount=0;currentSupervisor;currentScheduler;currentTracer;currentSpan;currentContext;currentDefaultServices;constructor(t,n,r){if(super(),this.currentRuntimeFlags=r,this._fiberId=t,this._fiberRefs=n,wg(r)){const s=this.getFiberRef(Sh);tM.unsafeUpdate(1,s),cy.unsafeUpdate(1,s)}this.refreshRefCache()}commit(){return sc(this)}id(){return this._fiberId}resume(t){this.tell(Ls(t))}get status(){return this.ask((t,n)=>n)}get runtimeFlags(){return this.ask((t,n)=>hv(n)?t.currentRuntimeFlags:n.runtimeFlags)}scope(){return SN(this)}get children(){return this.ask(t=>Array.from(t.getChildren()))}getChildren(){return this._children===null&&(this._children=new Set),this._children}getInterruptedCause(){return this.getFiberRef(Gc)}fiberRefs(){return this.ask(t=>t.getFiberRefs())}ask(t){return ae(()=>{const n=Ac(this._fiberId);return this.tell(ba((r,s)=>{fl(n,M(()=>t(r,s)))})),Vn(n)})}tell(t){this._queue.push(t),this._running||(this._running=!0,this.drainQueueLaterOnExecutor())}get await(){return jn(t=>{const n=r=>t(L(r));return this.tell(ba((r,s)=>{r._exitValue!==null?n(this._exitValue):r.addObserver(n)})),M(()=>this.tell(ba((r,s)=>{r.removeObserver(n)})))},this.id())}get inheritAll(){return Ee((t,n)=>{const r=t.id(),s=t.getFiberRefs(),o=n.runtimeFlags,i=this.getFiberRefs(),c=Nx(s,r,i);t.setFiberRefs(c);const a=t.getFiberRef(hy),u=p(cs(o,a),Tg($s),Tg(mh));return $O(u)})}get poll(){return M(()=>$u(this._exitValue))}unsafePoll(){return this._exitValue}interruptAsFork(t){return M(()=>this.tell(ff(fn(t))))}unsafeInterruptAsFork(t){this.tell(ff(fn(t)))}addObserver(t){this._exitValue!==null?t(this._exitValue):this._observers.push(t)}removeObserver(t){this._observers=this._observers.filter(n=>n!==t)}getFiberRefs(){return this.setFiberRef(hy,this.currentRuntimeFlags),this._fiberRefs}unsafeDeleteFiberRef(t){this._fiberRefs=Jw(this._fiberRefs,t)}getFiberRef(t){return this._fiberRefs.locals.has(t)?this._fiberRefs.locals.get(t)[0][1]:t.initial}setFiberRef(t,n){this._fiberRefs=kh(this._fiberRefs,{fiberId:this._fiberId,fiberRef:t,value:n}),this.refreshRefCache()}refreshRefCache(){this.currentDefaultServices=this.getFiberRef(Za),this.currentTracer=this.currentDefaultServices.unsafeMap.get(zw.key),this.currentSupervisor=this.getFiberRef(AM),this.currentScheduler=this.getFiberRef(Mp),this.currentContext=this.getFiberRef(jr),this.currentSpan=this.currentContext.unsafeMap.get(Vw.key)}setFiberRefs(t){this._fiberRefs=t,this.refreshRefCache()}addChild(t){this.getChildren().add(t)}removeChild(t){this.getChildren().delete(t)}transferChildren(t){const n=this._children;if(this._children=null,n!==null&&n.size>0)for(const r of n)r._exitValue===null&&t.add(this.currentRuntimeFlags,r)}drainQueueOnCurrentThread(){let t=!0;for(;t;){let n=pi;const r=globalThis[Vr];globalThis[Vr]=this;try{for(;n===pi;)n=this._queue.length===0?oM:this.evaluateMessageWhileSuspended(this._queue.splice(0,1)[0])}finally{this._running=!1,globalThis[Vr]=r}this._queue.length>0&&!this._running?(this._running=!0,n===ay?(this.drainQueueLaterOnExecutor(),t=!1):t=!0):t=!1}}drainQueueLaterOnExecutor(){this.currentScheduler.scheduleTask(this.run,this.getFiberRef($c))}drainQueueWhileRunning(t,n){let r=n;for(;this._queue.length>0;){const s=this._queue.splice(0,1)[0];r=cM[s._tag](this,t,r,s)}return r}isInterrupted(){return!tO(this.getFiberRef(Gc))}addInterruptedCause(t){const n=this.getFiberRef(Gc);this.setFiberRef(Gc,Rt(n,t))}processNewInterruptSignal(t){this.addInterruptedCause(t),this.sendInterruptSignalToAllChildren()}sendInterruptSignalToAllChildren(){if(this._children===null||this._children.size===0)return!1;let t=!1;for(const n of this._children)n.tell(ff(fn(this.id()))),t=!0;return t}interruptAllChildren(){if(this.sendInterruptSignalToAllChildren()){const t=this._children.values();this._children=null;let n=!1;return dp({while:()=>!n,body:()=>{const s=t.next();return s.done?M(()=>{n=!0}):cn(s.value.await)},step:()=>{}})}return null}reportExitValue(t){if(wg(this.currentRuntimeFlags)){const n=this.getFiberRef(Sh),r=this.id().startTimeMillis,s=Date.now();switch(sM.unsafeUpdate(s-r,n),cy.unsafeUpdate(-1,n),t._tag){case xt:{nM.unsafeUpdate(1,n);break}case Pt:{rM.unsafeUpdate(1,n);break}}}if(t._tag==="Failure"){const n=this.getFiberRef(YO);!Yu(t.cause)&&n._tag==="Some"&&this.log("Fiber terminated with an unhandled error",t.cause,n)}}setExitValue(t){this._exitValue=t,this.reportExitValue(t);for(let n=this._observers.length-1;n>=0;n--)this._observers[n](t);this._observers=[]}getLoggers(){return this.getFiberRef(pM)}log(t,n,r){const s=$e(r)?r.value:this.getFiberRef(VO),o=this.getFiberRef(lM);if(Qx(o,s))return;const i=this.getFiberRef(qO),c=this.getFiberRef(zO),a=this.getLoggers(),u=this.getFiberRefs();if(np(a)>0){const l=s_(this.getFiberRef(Za),ml),f=new Date(l.unsafeCurrentTimeMillis());CC(u,()=>{for(const h of a)h.log({fiberId:this.id(),logLevel:s,message:t,cause:n,context:u,spans:i,annotations:c,date:f})})}}evaluateMessageWhileSuspended(t){switch(t._tag){case Up:return ay;case Lp:return this.processNewInterruptSignal(t.cause),this._asyncInterruptor!==null&&(this._asyncInterruptor(Oe(t.cause)),this._asyncInterruptor=null),pi;case Dp:return this._asyncInterruptor=null,this._asyncBlockingOn=null,this.evaluateEffect(t.effect),pi;case Hp:return t.onFiber(this,this._exitValue!==null?MF:LF(this.currentRuntimeFlags,this._asyncBlockingOn)),pi;default:return Qc(t)}}evaluateEffect(t){this.currentSupervisor.onResume(this);try{let n=Tr(this.currentRuntimeFlags)&&this.isInterrupted()?Oe(this.getInterruptedCause()):t;for(;n!==null;){const r=n,s=this.runLoop(r);if(s===Yn){const o=Qn.currentOp;Qn.currentOp=null,o._op===ha?R1(this.currentRuntimeFlags)?(this.tell(pN()),this.tell(Ls(vn)),n=null):n=vn:o._op===Ri&&(n=null)}else{this.currentRuntimeFlags=p(this.currentRuntimeFlags,P1(mh));const o=this.interruptAllChildren();o!==null?n=P(o,()=>s):(this._queue.length===0?this.setExitValue(s):this.tell(Ls(s)),n=null)}}}finally{this.currentSupervisor.onSuspend(this)}}start(t){if(this._running)this.tell(Ls(t));else{this._running=!0;const n=globalThis[Vr];globalThis[Vr]=this;try{this.evaluateEffect(t)}finally{this._running=!1,globalThis[Vr]=n,this._queue.length>0&&this.drainQueueLaterOnExecutor()}}}startFork(t){this.tell(Ls(t))}patchRuntimeFlags(t,n){const r=co(t,n);return globalThis[Vr]=this,this.currentRuntimeFlags=r,r}initiateAsync(t,n){let r=!1;const s=o=>{r||(r=!0,this.tell(Ls(o)))};Tr(t)&&(this._asyncInterruptor=s);try{n(s)}catch(o){s(ft(nn(o)))}}pushStack(t){this._stack.push(t),t._op==="OnStep"&&this._steps.push({refs:this.getFiberRefs(),flags:this.currentRuntimeFlags})}popStack(){const t=this._stack.pop();if(t)return t._op==="OnStep"&&this._steps.pop(),t}getNextSuccessCont(){let t=this.popStack();for(;t;){if(t._op!==fa)return t;t=this.popStack()}}getNextFailCont(){let t=this.popStack();for(;t;){if(t._op!==Na&&t._op!==Ma&&t._op!==Oi)return t;t=this.popStack()}}[$C](t){return M(()=>o_(this.currentContext,t))}Left(t){return st(t.left)}None(t){return st(new yp)}Right(t){return et(t.right)}Some(t){return et(t.value)}Micro(t){return Ga(n=>{let r=n;const s=hN(oN(t,this.currentContext));return s.addObserver(o=>{if(o._tag==="Success")return r(et(o.value));switch(o.cause._tag){case"Interrupt":return r(Oe(fn(Co)));case"Fail":return r(st(o.cause.error));case"Die":return r(Er(o.cause.defect))}}),Ga(o=>{r=i=>{o(Ke)},s.unsafeInterrupt()})})}[ZS](t){const n=Ut(()=>t.effect_instruction_i0()),r=this.getNextSuccessCont();return r!==void 0?(r._op in mi||Qc(r),mi[r._op](this,r,n)):(Qn.currentOp=et(n),Yn)}[xt](t){const n=t,r=this.getNextSuccessCont();return r!==void 0?(r._op in mi||Qc(r),mi[r._op](this,r,n.effect_instruction_i0)):(Qn.currentOp=n,Yn)}[Pt](t){const n=t.effect_instruction_i0,r=this.getNextFailCont();if(r!==void 0)switch(r._op){case fa:case Ba:return Tr(this.currentRuntimeFlags)&&this.isInterrupted()?Oe(kg(n)):Ut(()=>r.effect_instruction_i1(n));case"OnStep":return Tr(this.currentRuntimeFlags)&&this.isInterrupted()?Oe(kg(n)):et(Oe(n));case $d:return this.patchRuntimeFlags(this.currentRuntimeFlags,r.patch),Tr(this.currentRuntimeFlags)&&this.isInterrupted()?Oe(Rt(n,this.getInterruptedCause())):Oe(n);default:Qc(r)}else return Qn.currentOp=Oe(n),Yn}[eb](t){return Ut(()=>t.effect_instruction_i0(this,fv(this.currentRuntimeFlags)))}Blocked(t){const n=this.getFiberRefs(),r=this.currentRuntimeFlags;if(this._steps.length>0){const s=[],o=this._steps[this._steps.length-1];let i=this.popStack();for(;i&&i._op!=="OnStep";)s.push(i),i=this.popStack();this.setFiberRefs(o.refs),this.currentRuntimeFlags=o.flags;const c=nc(o.refs,n),a=cs(o.flags,r);return et(ow(t.effect_instruction_i0,Ee(u=>{for(;s.length>0;)u.pushStack(s.pop());return u.setFiberRefs(rc(u.id(),u.getFiberRefs())(c)),u.currentRuntimeFlags=co(a)(u.currentRuntimeFlags),t.effect_instruction_i1})))}return kn(s=>P(Wp(vO(t.effect_instruction_i0)),()=>s(t.effect_instruction_i1)))}RunBlocked(t){return aM(t.effect_instruction_i0)}[Wo](t){const n=t.effect_instruction_i0,r=this.currentRuntimeFlags,s=co(r,n);if(Tr(s)&&this.isInterrupted())return Oe(this.getInterruptedCause());if(this.patchRuntimeFlags(this.currentRuntimeFlags,n),t.effect_instruction_i1){const o=cs(s,r);return this.pushStack(new TO(o,t)),Ut(()=>t.effect_instruction_i1(r))}else return vn}[Na](t){return this.pushStack(t),t.effect_instruction_i0}OnStep(t){return this.pushStack(t),t.effect_instruction_i0}[fa](t){return this.pushStack(t),t.effect_instruction_i0}[Ba](t){return this.pushStack(t),t.effect_instruction_i0}[Ri](t){return this._asyncBlockingOn=t.effect_instruction_i1,this.initiateAsync(this.currentRuntimeFlags,t.effect_instruction_i0),Qn.currentOp=t,Yn}[ha](t){return this._isYielding=!1,Qn.currentOp=t,Yn}[Ma](t){const n=t.effect_instruction_i0,r=t.effect_instruction_i1;return n()?(this.pushStack(t),r()):vn}[Oi](t){return mi[Oi](this,t,void 0)}[Iu](t){return Ut(()=>t.commit())}runLoop(t){let n=t;for(this.currentOpCount=0;;){if((this.currentRuntimeFlags&A1)!==0&&this.currentSupervisor.onEffect(this,n),this._queue.length>0&&(n=this.drainQueueWhileRunning(this.currentRuntimeFlags,n)),!this._isYielding){this.currentOpCount+=1;const r=this.currentScheduler.shouldYield(this);if(r!==!1){this._isYielding=!0,this.currentOpCount=0;const s=n;n=P(ol({priority:r}),()=>s)}}try{if(n=this.currentTracer.context(()=>{if(uM!==n[Po]._V){const r=this.getFiberRef(QO);if(r._tag==="Some"){const s=n[Po]._V;this.log(`Executing an Effect versioned ${s} with a Runtime of version ${Ad()}, you may want to dedupe the effect dependencies, you can use the language service plugin to detect this at compile time: https://github.com/Effect-TS/language-service`,xr,r)}}return this[n._op](n)},this),n===Yn){const r=Qn.currentOp;return r._op===ha||r._op===Ri?Yn:(Qn.currentOp=null,r._op===xt||r._op===Pt?r:Oe(nn(r)))}}catch(r){n!==Yn&&!te(n,"_op")||!(n._op in this)?n=hw(`Not a valid effect: ${So(n)}`):eP(r)?n=Oe(Rt(nn(r),fn(Co))):n=Er(r)}}}run=()=>{this.drainQueueOnCurrentThread()}}const lM=be("effect/FiberRef/currentMinimumLogLevel",()=>Yt(Xx("Info"))),fM=e=>Kp(t=>{const n=Hx(t.context,Za);s_(n,jw).unsafe.log(e.log(t))}),hM=be(Symbol.for("effect/Logger/defaultLogger"),()=>fM(xN)),dM=be(Symbol.for("effect/Logger/tracerLogger"),()=>Kp(({annotations:e,cause:t,context:n,fiberId:r,logLevel:s,message:o})=>{const i=Sc(tc(n,jr),Vw);if(i._tag==="None"||i.value._tag==="ExternalSpan")return;const c=o_(tc(n,Za),ml),a={};for(const[u,l]of e)a[u]=l;a["effect.fiberId"]=gR(r),a["effect.logLevel"]=s.label,t!==null&&t._tag!=="Empty"&&(a["effect.cause"]=ti(t,{renderErrorCause:!0})),i.value.event(So(Array.isArray(o)&&o.length===1?o[0]:o),c.unsafeCurrentTimeNanos(),a)})),pM=be(Symbol.for("effect/FiberRef/currentLoggers"),()=>UO(tp(hM,dM))),mM=d(e=>Sr(e[0]),(e,t)=>Rs(rl(e,n=>gM(r=>t(n,r))))),gM=e=>Ee(t=>{const n=t.getFiberRefs(),r=O1(t.currentRuntimeFlags,$s);return P(Wv,s=>Ya(s,o=>Ee(i=>{const c=i.getFiberRefs(),a=i.currentRuntimeFlags,u=nc(c,n),l=cs(a,r),f=nc(n,c);return i.setFiberRefs(rc(u,i.id(),n)),oc(RO(e(o),l),M(()=>{i.setFiberRefs(rc(f,i.id(),i.getFiberRefs()))}))})))}),yM=e=>{if(Array.isArray(e)||qS(e))return[e,K()];const t=Object.keys(e),n=t.length;return[t.map(r=>e[r]),U(r=>{const s={};for(let o=0;o<n;o++)s[t[o]]=r[o];return s})]},SM=(e,t,n)=>{const r=[];for(const s of e)r.push(Fo(s));return P(Ho(r,ee,{concurrency:n?.concurrency,batching:n?.batching,concurrentFinalizers:n?.concurrentFinalizers}),s=>{const o=K(),i=s.length,c=new Array(i),a=new Array(i);let u=!1;for(let l=0;l<i;l++){const f=s[l];f._tag==="Left"?(c[l]=U(f.left),u=!0):(a[l]=f.right,c[l]=o)}return u?t._tag==="Some"?st(t.value(c)):st(c):n?.discard?Ke:t._tag==="Some"?L(t.value(a)):L(a)})},bM=(e,t,n)=>{const r=[];for(const s of e)r.push(Fo(s));return n?.discard?Ho(r,ee,{concurrency:n?.concurrency,batching:n?.batching,discard:!0,concurrentFinalizers:n?.concurrentFinalizers}):ne(Ho(r,ee,{concurrency:n?.concurrency,batching:n?.batching,concurrentFinalizers:n?.concurrentFinalizers}),s=>t._tag==="Some"?t.value(s):s)},Vp=(e,t)=>{const[n,r]=yM(e);return t?.mode==="validate"?SM(n,r,t):t?.mode==="either"?bM(n,r,t):t?.discard!==!0&&r._tag==="Some"?ne(Ho(n,ee,t),r.value):Ho(n,ee,t)},Ho=d(e=>qS(e[0]),(e,t,n)=>Ee(r=>{const s=n?.batching===!0||n?.batching==="inherit"&&r.getFiberRef(GO);return n?.discard?ny(n.concurrency,()=>Hs(ru,n?.concurrentFinalizers)(o=>s?Hn(e,(i,c)=>o(t(i,c)),!0,!1,1):tl(e,(i,c)=>o(t(i,c)))),()=>Hs($h,n?.concurrentFinalizers)(o=>Hn(e,(i,c)=>o(t(i,c)),s,!1)),o=>Hs(Ah(o),n?.concurrentFinalizers)(i=>Hn(e,(c,a)=>i(t(c,a)),s,!1,o))):ny(n?.concurrency,()=>Hs(ru,n?.concurrentFinalizers)(o=>s?Uh(e,1,(i,c)=>o(t(i,c)),!0):or(e,(i,c)=>o(t(i,c)))),()=>Hs($h,n?.concurrentFinalizers)(o=>qp(e,(i,c)=>o(t(i,c)),s)),o=>Hs(Ah(o),n?.concurrentFinalizers)(i=>Uh(e,o,(c,a)=>i(t(c,a)),s)))})),qp=(e,t,n)=>ae(()=>{const r=Ne(e),s=new Array(r.length);return gt(Hn(r,(i,c)=>P(t(i,c),a=>M(()=>s[c]=a)),n,!1),L(s))}),Hn=(e,t,n,r,s)=>kn(o=>IO(i=>Ee(c=>{let a=Array.from(e).reverse(),u=a.length;if(u===0)return Ke;let l=0,f=!1;const h=s?Math.min(a.length,s):a.length,m=new Set,y=new Array,b=()=>m.forEach(O=>{O.currentScheduler.scheduleTask(()=>{O.unsafeInterruptAsFork(c.id())},0)}),_=new Array,T=new Array,C=new Array,v=()=>{const O=y.filter(({exit:H})=>H._tag==="Failure").sort((H,x)=>H.index<x.index?-1:H.index===x.index?0:1).map(({exit:H})=>H);return O.length===0&&O.push(vn),O},k=(O,H=!1)=>{const x=Rs(i(O)),E=_M(x,c,c.currentRuntimeFlags,Sl);return c.currentScheduler.scheduleTask(()=>{H&&E.unsafeInterruptAsFork(c.id()),E.resume(x)},0),E},R=()=>{r||(u-=a.length,a=[]),f=!0,b()},w=n?kO:Ln,I=k(jn(O=>{const H=(E,V)=>{E._op==="Blocked"?C.push(E):(y.push({index:V,exit:E}),E._op==="Failure"&&!f&&R())},x=()=>{if(a.length>0){const E=a.pop();let V=l++;const q=()=>{const ce=a.pop();return V=l++,P(ol(),()=>P(w(o(t(ce,V))),D))},D=ce=>a.length>0&&(H(ce,V),a.length>0)?q():L(ce),B=P(w(o(t(E,V))),D),F=k(B);_.push(F),m.add(F),f&&F.currentScheduler.scheduleTask(()=>{F.unsafeInterruptAsFork(c.id())},0),F.addObserver(ce=>{let je;if(ce._op==="Failure"?je=ce:je=ce.effect_instruction_i0,T.push(F),m.delete(F),H(je,V),y.length===u)O(L(qe(ao(v(),{parallel:!0}),()=>vn)));else if(C.length+y.length===u){const qt=v(),Bs=C.map(_r=>_r.effect_instruction_i0).reduce(W_);O(L(ow(Bs,Hn([qe(ao(qt,{parallel:!0}),()=>vn),...C.map(_r=>_r.effect_instruction_i1)],_r=>_r,n,!0,s))))}else x()})}};for(let E=0;E<h;E++)x()}));return cn(No(Ec(o(sc(I))),ul({onFailure:O=>{R();const H=C.length+1,x=Math.min(typeof s=="number"?s:C.length,C.length),E=Array.from(C);return jn(V=>{let q=0,D=0;const B=(ce,je)=>qt=>{q++,q===H&&V(et(Oe(O))),E.length>0&&je&&F()},F=()=>{k(E.pop(),!0).addObserver(B(D,!0)),D++};I.addObserver(B(D,!1)),D++;for(let ce=0;ce<x;ce++)F()})},onSuccess:()=>or(T,O=>O.inheritAll)})))}))),Uh=(e,t,n,r)=>ae(()=>{const s=Ne(e),o=new Array(s.length);return gt(Hn(s,(c,a)=>ne(n(c,a),u=>o[a]=u),r,!1,t),L(o))}),Wp=e=>wM(e,Sl),Vv=(e,t,n,r=null)=>{const s=lu(e,t,n,r);return s.resume(e),s},_M=(e,t,n,r=null)=>lu(e,t,n,r),lu=(e,t,n,r=null)=>{const s=R_(),o=t.getFiberRefs(),i=Bx(o,s),c=new zv(s,i,n),a=tc(i,jr),u=c.currentSupervisor;return u.onStart(a,e,U(t),c),c.addObserver(f=>u.onEnd(f,c)),(r!==null?r:p(t.getFiberRef(bh),qe(()=>t.scope()))).add(n,c),c},wM=(e,t)=>Ee((n,r)=>L(Vv(e,n,r.runtimeFlags,t))),uy=e=>Os(t=>Fe(Sc(t,Ps),{onNone:()=>e,onSome:n=>{switch(n.strategy._tag){case"Parallel":return e;case"Sequential":case"ParallelN":return P(tr(n,$h),r=>Bc(e,r))}}})),ly=e=>t=>Os(n=>Fe(Sc(n,Ps),{onNone:()=>t,onSome:r=>r.strategy._tag==="ParallelN"&&r.strategy.parallelism===e?t:P(tr(r,Ah(e)),s=>Bc(t,s))})),Hs=(e,t)=>n=>Os(r=>Fe(Sc(r,Ps),{onNone:()=>n(ee),onSome:s=>{if(t===!0){const o=e._tag==="Parallel"?uy:e._tag==="Sequential"?fy:ly(e.parallelism);switch(s.strategy._tag){case"Parallel":return o(n(uy));case"Sequential":return o(n(fy));case"ParallelN":return o(n(ly(s.strategy.parallelism)))}}else return n(ee)}})),vM=e=>P(Ps,e),qv=e=>P(kl(),t=>No(e(t),n=>t.close(n))),fy=e=>Os(t=>Fe(Sc(t,Ps),{onNone:()=>e,onSome:n=>{switch(n.strategy._tag){case"Sequential":return e;case"Parallel":case"ParallelN":return P(tr(n,ru),r=>Bc(e,r))}}})),TM=d(e=>Sr(e[1]),(e,t,n)=>Nc(e,t,(r,s)=>[r,s],n)),kM=d(e=>Sr(e[1]),(e,t,n)=>n?.concurrent!==!0&&(n?.batching===void 0||n.batching===!1)?il(e,t):Nc(e,t,(r,s)=>r,n)),EM=d(e=>Sr(e[1]),(e,t,n)=>n?.concurrent!==!0&&(n?.batching===void 0||n.batching===!1)?gt(e,t):Nc(e,t,(r,s)=>s,n)),Nc=d(e=>Sr(e[1]),(e,t,n,r)=>ne(Vp([e,t],{concurrency:r?.concurrent?2:1,batching:r?.batching,concurrentFinalizers:r?.concurrentFinalizers}),([s,o])=>n(s,o))),Ps=Es("effect/Scope"),Wv=Ps,CM=(e,t)=>{e.state._tag==="Open"&&e.state.finalizers.set({},t)},IM={[Ag]:Ag,[Rg]:Rg,pipe(){return G(this,arguments)},fork(e){return M(()=>{const t=Jv(e);if(this.state._tag==="Closed")return t.state=this.state,t;const n={},r=s=>t.close(s);return this.state.finalizers.set(n,r),CM(t,s=>M(()=>{this.state._tag==="Open"&&this.state.finalizers.delete(n)})),t})},close(e){return ae(()=>{if(this.state._tag==="Closed")return Ke;const t=Array.from(this.state.finalizers.values()).reverse();return this.state={_tag:"Closed",exit:e},t.length===0?Ke:IF(this.strategy)?p(or(t,n=>Ln(n(e))),P(n=>p(ao(n),ro(af),qe(()=>vn)))):$F(this.strategy)?p(qp(t,n=>Ln(n(e)),!1),P(n=>p(ao(n,{parallel:!0}),ro(af),qe(()=>vn)))):p(Uh(t,this.strategy.parallelism,n=>Ln(n(e)),!1),P(n=>p(ao(n,{parallel:!0}),ro(af),qe(()=>vn))))})},addFinalizer(e){return ae(()=>this.state._tag==="Closed"?e(this.state.exit):(this.state.finalizers.set({},e),Ke))}},Jv=(e=Rr)=>{const t=Object.create(IM);return t.strategy=e,t.state={_tag:"Open",finalizers:new Map},t},kl=(e=Rr)=>M(()=>Jv(e)),Bc=d(2,(e,t)=>dP(e,Nu(W$(Ps,t)))),$M=e=>ni(e,{differ:eM,fork:Bi}),hy=jO(x1),AM=$M(Tl),Gv=d(3,(e,t,n)=>RM(e,t,{onSelfWin:(r,s)=>P(r.await,o=>{switch(o._tag){case xt:return P(r.inheritAll,()=>n.onSelfDone(o,s));case Pt:return n.onSelfDone(o,s)}}),onOtherWin:(r,s)=>P(r.await,o=>{switch(o._tag){case xt:return P(r.inheritAll,()=>n.onOtherDone(o,s));case Pt:return n.onOtherDone(o,s)}})})),Yv=d(2,(e,t)=>kc(n=>Gv(e,t,{onSelfDone:(r,s)=>vh(r,{onFailure:o=>p(sc(s),Yg(i=>Nr(o,i))),onSuccess:o=>p(s,Zi(n),Gt(o))}),onOtherDone:(r,s)=>vh(r,{onFailure:o=>p(sc(s),Yg(i=>Nr(i,o))),onSuccess:o=>p(s,Zi(n),Gt(o))})}))),RM=d(3,(e,t,n)=>Ee((r,s)=>{const o=s.runtimeFlags,i=Cs(!0),c=lu(e,r,o,n.selfScope),a=lu(t,r,o,n.otherScope);return jn(u=>{c.addObserver(()=>dy(c,a,n.onSelfWin,i,u)),a.addObserver(()=>dy(a,c,n.onOtherWin,i,u)),c.startFork(e),a.startFork(t)},pR(c.id(),a.id()))})),dy=(e,t,n,r,s)=>{cR(!0,!1)(r)&&s(n(e,t))},oc=d(2,(e,t)=>kn(n=>on(n(e),{onFailure:r=>on(t,{onFailure:s=>ft(Rt(r,s)),onSuccess:()=>ft(r)}),onSuccess:r=>Gt(t,r)}))),OM=(e,t,n)=>kc(r=>P(P(Wp(lp(e)),s=>jn(o=>{const i=t.map(u=>u.listeners.count),c=()=>{i.every(u=>u===0)&&t.every(u=>u.result.state.current._tag==="Pending"?!0:!!(u.result.state.current._tag==="Done"&&al(u.result.state.current.effect)&&u.result.state.current.effect._tag==="Failure"&&Z_(u.result.state.current.effect.cause)))&&(a.forEach(u=>u()),n?.(),o(pp(s)))};s.addObserver(u=>{a.forEach(l=>l()),o(u)});const a=t.map((u,l)=>{const f=h=>{i[l]=h,c()};return u.listeners.addObserver(f),()=>u.listeners.removeObserver(f)});return c(),M(()=>{a.forEach(u=>u())})})),()=>ae(()=>{const s=t.flatMap(o=>o.state.completed?[]:[o]);return tl(s,o=>qB(o.request,$w(r)))}))),PM=Fr,Kh=nn,xM=fn,FM=eO,NM=X_,Qv=Z_,hf=Yu,BM=ew,MM=tw,LM=oO,Xv=aO,HM=ti,DM="effect/ScheduleInterval",fu=Symbol.for(DM),Zv={[fu]:fu,startMillis:0,endMillis:0},Jp=(e,t)=>e>t?Zv:{[fu]:fu,startMillis:e,endMillis:t},UM=d(2,(e,t)=>KM(e,t)===e),KM=d(2,(e,t)=>e.endMillis<=t.startMillis?e:t.endMillis<=e.startMillis?t:e.startMillis<t.startMillis?e:t.startMillis<e.startMillis?t:e.endMillis<=t.endMillis?e:t),jM=e=>e.startMillis>=e.endMillis,zM=d(2,(e,t)=>{const n=Math.max(e.startMillis,t.startMillis),r=Math.min(e.endMillis,t.endMillis);return Jp(n,r)}),VM=e=>ie(e.endMillis-e.startMillis),qM=e=>Jp(e,Number.POSITIVE_INFINITY),py=Jp,eT=Zv,WM=UM,JM=jM,GM=zM,YM=VM,QM=qM,XM="effect/ScheduleIntervals",my=Symbol.for(XM),tT=e=>({[my]:my,intervals:e}),ZM=d(2,(e,t)=>e2(e.intervals,t.intervals,We())),e2=(e,t,n)=>{let r=e,s=t,o=n;for(;Kn(r)&&Kn(s);){const i=p(Fn(r),GM(Fn(s))),c=JM(i)?o:p(o,Nt(i));p(Fn(r),WM(Fn(s)))?r=sr(r):s=sr(s),o=c}return tT(pr(o))},jh=e=>p(e.intervals,Vd,qe(()=>eT)).startMillis,t2=e=>p(e.intervals,Vd,qe(()=>eT)).endMillis,nT=d(2,(e,t)=>jh(e)<jh(t)),n2=e=>Kn(e.intervals),r2=d(2,(e,t)=>nT(e,t)?t:e),s2=tT,o2=ZM,zh=jh,Vh=t2,i2=nT,c2=n2,a2=r2,Gp="Continue",rT="Done",u2=e=>({_tag:Gp,intervals:e}),l2=e=>({_tag:Gp,intervals:s2(Be(e))}),f2={_tag:rT},h2=e=>e._tag===Gp,d2=e=>e._tag===rT,sT=u2,oT=l2,vs=f2,gy=h2,Ts=d2,ic=kw,p2=Ya,qh=_h,m2=Bc,iT=tr,g2=kl;class y2{permits;waiters=new Set;taken=0;constructor(t){this.permits=t}get free(){return this.permits-this.taken}take=t=>lw(n=>{if(this.free<t){const r=()=>{this.free<t||(this.waiters.delete(r),this.taken+=t,n(L(t)))};return this.waiters.add(r),M(()=>{this.waiters.delete(r)})}return this.taken+=t,n(L(t))});updateTakenUnsafe(t,n){return this.taken=n(this.taken),this.waiters.size>0&&t.getFiberRef(Mp).scheduleTask(()=>{const r=this.waiters.values();let s=r.next();for(;s.done===!1&&this.free>0;)s.value(),s=r.next()},t.getFiberRef($c)),L(this.free)}updateTaken(t){return Ee(n=>this.updateTakenUnsafe(n,t))}resize=t=>cn(Ee(n=>(this.permits=t,this.free<0?Ke:this.updateTakenUnsafe(n,r=>r))));release=t=>this.updateTaken(n=>n-t);releaseAll=this.updateTaken(t=>0);withPermits=t=>n=>kn(r=>P(r(this.take(t)),s=>oc(r(n),this.release(s))));withPermitsIfAvailable=t=>n=>kn(r=>ae(()=>this.free<t?bF:(this.taken+=t,oc(r(aF(n)),this.release(t)))))}const cT=e=>new y2(e),S2=e=>M(()=>cT(e)),b2=d(2,(e,t)=>Ee((n,r)=>{const s=t,o=Vv(e,n,r.runtimeFlags,Sl);if(s.state._tag==="Open"){const i=()=>kc(a=>oe(a,o.id())?Ke:cn(pp(o))),c={};s.state.finalizers.set(c,i),o.addObserver(()=>{s.state._tag!=="Closed"&&s.state.finalizers.delete(c)})}else o.unsafeInterruptAsFork(n.id());return L(o)})),_2=d(2,(e,t)=>p(Ln(e),Yv(Ln(t)),n=>Ec(n))),w2="effect/Ref/SynchronizedRef",aT=Symbol.for(w2),uT={_A:e=>e};class v2 extends si{ref;withLock;[aT]=uT;[Cp]=Ip;[Mo]=Mo;constructor(t,n){super(),this.ref=t,this.withLock=n,this.get=mn(this.ref)}get;commit(){return this.get}modify(t){return this.modifyEffect(n=>L(t(n)))}modifyEffect(t){return this.withLock(p(P(mn(this.ref),t),P(([n,r])=>Gt(uo(this.ref,r),n))))}}const T2=e=>M(()=>lT(e)),lT=e=>{const t=$p(e),n=cT(1);return new v2(t,n.withPermits(1))},k2=Symbol.for("effect/ManagedRuntime"),E2="Fresh",C2="MergeAll",fT=kN,yy=EN,xe=pp,I2=Zi,Sy=sc,$2=CN,Mc=e=>function(){if(arguments.length===1){const t=arguments[0];return(n,...r)=>e(t,n,...r)}return e.apply(this,arguments)},Yp=Mc((e,t,n)=>{const r=R_(),s=[[jr,[[r,e.context]]]];n?.scheduler&&s.push([Mp,[[r,n.scheduler]]]);let o=Dx(e.fiberRefs,{entries:s,forkAs:r});n?.updateRefs&&(o=n.updateRefs(o,r));const i=new zv(r,o,e.runtimeFlags);let c=t;n?.scope&&(c=P(iT(n.scope,Rr),u=>gt(kw(u,kc(l=>oe(l,i.id())?Ke:Zi(i,l))),No(t,l=>qh(u,l)))));const a=i.currentSupervisor;return a!==Tl&&(a.onStart(e.context,c,K(),i),i.addObserver(u=>a.onEnd(u,i))),Sl.add(e.runtimeFlags,i),n?.immediate===!1?i.resume(c):i.start(c),i}),A2=Mc((e,t)=>{const n=x2(e)(t);if(n._tag==="Failure")throw hT(n.effect_instruction_i0);return n.effect_instruction_i0});class R2 extends Error{fiber;_tag="AsyncFiberException";constructor(t){super(`Fiber #${t.id().id} cannot be resolved synchronously. This is caused by using runSync on an effect that performs async work`),this.fiber=t,this.name=this._tag,this.stack=this.message}}const O2=e=>{const t=Error.stackTraceLimit;Error.stackTraceLimit=0;const n=new R2(e);return Error.stackTraceLimit=t,n},df=Symbol.for("effect/Runtime/FiberFailure"),Xc=Symbol.for("effect/Runtime/FiberFailure/Cause");class P2 extends Error{[df];[Xc];constructor(t){const n=rw(t)[0];super(n?.message||"An error has occurred"),this[df]=df,this[Xc]=t,this.name=n?`(FiberFailure) ${n.name}`:"FiberFailure",n?.stack&&(this.stack=n.stack)}toJSON(){return{_id:"FiberFailure",cause:this[Xc].toJSON()}}toString(){return"(FiberFailure) "+ti(this[Xc],{renderErrorCause:!0})}[Me](){return this.toString()}}const hT=e=>{const t=Error.stackTraceLimit;Error.stackTraceLimit=0;const n=new P2(e);return Error.stackTraceLimit=t,n},dT=e=>{const t=e;switch(t._op){case"Failure":case"Success":return t;case"Left":return wh(t.left);case"Right":return et(t.right);case"Some":return et(t.value);case"None":return wh(new yp)}},x2=Mc((e,t)=>{const n=dT(t);if(n)return n;const r=new vv,s=Yp(e)(t,{scheduler:r});r.flush();const o=s.unsafePoll();return o||Iw(up(O2(s),wp(s)))}),F2=Mc((e,t,n)=>N2(e,t,n).then(r=>{switch(r._tag){case xt:return r.effect_instruction_i0;case Pt:throw hT(r.effect_instruction_i0)}})),N2=Mc((e,t,n)=>new Promise(r=>{const s=dT(t);s&&r(s);const o=Yp(e)(t);o.addObserver(i=>{r(i)}),n?.signal!==void 0&&(n.signal.aborted?o.unsafeInterruptAsFork(o.id()):n.signal.addEventListener("abort",()=>{o.unsafeInterruptAsFork(o.id())},{once:!0}))}));class pT{context;runtimeFlags;fiberRefs;constructor(t,n,r){this.context=t,this.runtimeFlags=n,this.fiberRefs=r}pipe(){return G(this,arguments)}}const B2=e=>new pT(e.context,e.runtimeFlags,e.fiberRefs),M2=()=>Ee((e,t)=>L(new pT(e.getFiberRef(jr),t.runtimeFlags,e.getFiberRefs()))),L2=V_($s,j_,K_),cc=B2({context:jd(),runtimeFlags:L2,fiberRefs:Ux()}),H2=Yp(cc),D2=F2(cc),U2=A2(cc),K2=d(2,(e,t)=>e.modifyEffect(t)),j2="effect/Layer",mT=Symbol.for(j2),z2={_RIn:e=>e,_E:e=>e,_ROut:e=>e},V2={[mT]:z2,pipe(){return G(this,arguments)}},q2="effect/Layer/MemoMap",pf=Symbol.for(q2),W2=Bu()("effect/Layer/CurrentMemoMap",{defaultValue:()=>Q2()}),J2=e=>te(e,mT),G2=e=>e._op_layer===E2;class gT{ref;[pf];constructor(t){this.ref=t,this[pf]=pf}getOrElseMemoize(t,n){return p(K2(this.ref,r=>{const s=r.get(t);if(s!==void 0){const[o,i]=s,c=p(o,P(([a,u])=>p(mF(a),Gt(u))),No(ul({onFailure:()=>Ke,onSuccess:()=>Ya(n,i)})));return L([c,r])}return p(eu(0),P(o=>p(Rc(),P(i=>p(eu(()=>Ke),ne(c=>{const a=kn(l=>p(kl(),P(f=>p(l(P(ST(t,f,!0),h=>lF(h(this)))),Ln,P(h=>{switch(h._tag){case Pt:return p(Aw(i,h.effect_instruction_i0),gt(_h(f,h)),gt(ft(h.effect_instruction_i0)));case xt:return p(uo(c,m=>p(_h(f,m),sl(Yw(o,y=>[y===1,y-1])),cn)),gt(tu(o,m=>m+1)),gt(Ya(n,m=>p(M(()=>r.delete(t)),gt(mn(c)),P(y=>y(m))))),gt(Oc(i,h.effect_instruction_i0)),Gt(h.effect_instruction_i0[1]))}}))))),u=[p(Vn(i),No(vh({onFailure:()=>Ke,onSuccess:()=>tu(o,l=>l+1)}))),l=>p(mn(c),P(f=>f(l)))];return[a,G2(t)?r:r.set(t,u)]}))))))}),Ec)}}const Y2=ae(()=>ne(T2(new Map),e=>new gT(e))),Q2=()=>new gT(lT(new Map)),yT=d(2,(e,t)=>P(Y2,n=>X2(e,n,t))),X2=d(3,(e,t,n)=>P(ST(e,n),r=>yF(r(t),W2,t))),ST=(e,t,n=!1)=>{const r=e;switch(r._op_layer){case"Locally":return M(()=>s=>r.f(s.getOrElseMemoize(r.self,t)));case"ExtendScope":return M(()=>s=>vM(o=>s.getOrElseMemoize(r.layer,o)));case"Fold":return M(()=>s=>p(s.getOrElseMemoize(r.layer,t),on({onFailure:o=>s.getOrElseMemoize(r.failureK(o),t),onSuccess:o=>s.getOrElseMemoize(r.successK(o),t)})));case"Fresh":return M(()=>s=>p(r.layer,yT(t)));case"FromEffect":return M(n?()=>s=>r.effect:()=>s=>s.getOrElseMemoize(e,t));case"Provide":return M(()=>s=>p(s.getOrElseMemoize(r.first,t),P(o=>p(s.getOrElseMemoize(r.second,t),hl(o)))));case"Scoped":return M(n?()=>s=>Bc(r.effect,t):()=>s=>s.getOrElseMemoize(e,t));case"Suspend":return M(()=>s=>s.getOrElseMemoize(r.evaluate(),t));case"ProvideMerge":return M(()=>s=>p(s.getOrElseMemoize(r.first,t),Sw(s.getOrElseMemoize(r.second,t),r.zipK)));case"ZipWith":return gw(function*(){const s=yield*tr(t,Ih),o=yield*tr(s,Rr),i=yield*tr(s,Rr);return c=>p(c.getOrElseMemoize(r.first,o),Nc(c.getOrElseMemoize(r.second,i),r.zipK,{concurrent:!0}))});case"MergeAll":{const s=r.layers;return ne(tr(t,Ih),o=>i=>{const c=new Array(s.length);return ne(Hn(s,AO(function*(a,u){const l=yield*tr(o,Rr),f=yield*i.getOrElseMemoize(a,l);c[u]=f}),!1,!1),()=>J$(...c))})}}},Z2=(...e)=>{const t=Object.create(V2);return t._op_layer=C2,t.layers=e,t},by=d(2,(e,t)=>qv(n=>P(yT(t,n),r=>_p(e,r)))),_y=d(2,(e,t)=>{const n=nc(cc.fiberRefs,t.fiberRefs),r=cs(cc.runtimeFlags,t.runtimeFlags);return kn(s=>Ee(o=>{const i=o.getFiberRef(jr),c=o.getFiberRefs(),a=rc(o.id(),c)(n),u=o.currentRuntimeFlags,l=co(r)(u),f=nc(a,c),h=cs(l,u);return o.setFiberRefs(a),o.currentRuntimeFlags=l,oc(_p(s(e),Nu(i,t.context)),Ee(m=>(m.setFiberRefs(rc(m.id(),m.getFiberRefs())(f)),m.currentRuntimeFlags=co(h)(m.currentRuntimeFlags),Ke)))}))}),eL=d(2,(e,t)=>Array.isArray(t)?by(e,Z2(...t)):J2(t)?by(e,t):q$(t)?_p(e,t):k2 in t?P(t.runtimeEffect,n=>_y(e,n)):_y(e,t)),tL=Wu,nL=(function(){const e=Symbol.for("effect/Data/Error/plainArgs");return{BaseEffectError:class extends gp{constructor(n){super(n?.message,n?.cause?{cause:n.cause}:void 0),n&&(Object.assign(this,n),Object.defineProperty(this,e,{value:n,enumerable:!1}))}toJSON(){return{...this[e],...this}}}}.BaseEffectError})(),rL=e=>{const t={BaseEffectError:class extends nL{_tag=e}};return t.BaseEffectError.prototype.name=e,t.BaseEffectError},sL="effect/Schedule",bT=Symbol.for(sL),_T=e=>te(e,bT),oL="effect/ScheduleDriver",iL=Symbol.for(oL),Wh={start:0,now:0,input:void 0,output:void 0,elapsed:vo,elapsedSincePrevious:vo,recurrence:0},hu=Bu()("effect/Schedule/CurrentIterationMetadata",{defaultValue:()=>Wh}),cL={_Out:e=>e,_In:e=>e,_R:e=>e},aL={_Out:e=>e,_In:e=>e,_R:e=>e};class uL{initial;step;[bT]=cL;constructor(t,n){this.initial=t,this.step=n}pipe(){return G(this,arguments)}}const wy=(e,t,n,r)=>tu(e,s=>s.recurrence===0?{now:t,input:n,output:r,recurrence:s.recurrence+1,elapsed:vo,elapsedSincePrevious:vo,start:t}:{now:t,input:n,output:r,recurrence:s.recurrence+1,elapsed:ie(t-s.start),elapsedSincePrevious:ie(t-s.now),start:s.start});class lL{schedule;ref;[iL]=aL;constructor(t,n){this.schedule=t,this.ref=n}get state(){return ne(mn(this.ref),t=>t[1])}get last(){return P(mn(this.ref),([t,n])=>{switch(t._tag){case"None":return Zu(()=>new yp);case"Some":return L(t.value)}})}iterationMeta=$p(Wh);get reset(){return uo(this.ref,[K(),this.schedule.initial]).pipe(il(uo(this.iterationMeta,Wh)))}next(t){return p(ne(mn(this.ref),n=>n[1]),P(n=>p(Ox,P(r=>p(ae(()=>this.schedule.step(r,t,n)),P(([s,o,i])=>{const c=uo(this.ref,[U(o),s]);if(Ts(i))return c.pipe(gt(st(K())));const a=zh(i.intervals)-r;if(a<=0)return c.pipe(gt(wy(this.iterationMeta,r,t,o)),Gt(o));const u=ie(a);return p(c,gt(wy(this.iterationMeta,r,t,o)),gt(av(u)),Gt(o))}))))))}}const xs=(e,t)=>new uL(e,t),wT=d(2,(e,t)=>fL(e,n=>M(()=>t(n)))),fL=d(2,(e,t)=>yL(e,(n,r)=>ne(t(n),s=>bA(r,Wt(s))))),vT=d(2,(e,t)=>Qp(e,(n,r)=>M(()=>t(n,r)))),Qp=d(2,(e,t)=>xs(e.initial,(n,r,s)=>P(e.step(n,r,s),([o,i,c])=>Ts(c)?L([o,i,vs]):ne(t(r,i),a=>a?[o,i,c]:[o,i,vs])))),hL=d(2,(e,t)=>xs([e.initial,t.initial],(n,r,s)=>P(e.step(n,r,s[0]),([o,i,c])=>ne(t.step(n,i,s[1]),([a,u,l])=>Ts(c)?[[o,a],u,vs]:Ts(l)?[[o,a],u,vs]:[[o,a],u,sT(p(c.intervals,a2(l.intervals)))])))),dL=e=>wT(e,t=>t),Xp=e=>p(eu([K(),e.initial]),ne(t=>new lL(e,t))),pL=(e,t=2)=>{const n=Wt(e);return dL(kT(Lc,r=>SA(n,Math.pow(t,r))))},TT=d(2,(e,t)=>mL(e,t,o2)),mL=d(3,(e,t,n)=>xs([e.initial,t.initial],(r,s,o)=>p(Sw(e.step(r,s,o[0]),t.step(r,s,o[1]),(i,c)=>[i,c]),P(([[i,c,a],[u,l,f]])=>gy(a)&&gy(f)?Jh(e,t,s,i,c,a.intervals,u,l,f.intervals,n):L([[i,u],[c,l],vs]))))),Jh=(e,t,n,r,s,o,i,c,a,u)=>{const l=u(o,a);return c2(l)?L([[r,i],[s,c],sT(l)]):p(o,i2(a))?P(e.step(Vh(o),n,r),([f,h,m])=>Ts(m)?L([[f,i],[h,c],vs]):Jh(e,t,n,f,h,m.intervals,i,c,a,u)):P(t.step(Vh(a),n,i),([f,h,m])=>Ts(m)?L([[r,f],[s,h],vs]):Jh(e,t,n,r,s,o,f,h,m.intervals,u))},kT=d(2,(e,t)=>gL(e,n=>M(()=>t(n)))),gL=d(2,(e,t)=>xs(e.initial,(n,r,s)=>P(e.step(n,r,s),([o,i,c])=>ne(t(i),a=>[o,a,c])))),yL=d(2,(e,t)=>xs(e.initial,(n,r,s)=>P(e.step(n,r,s),([o,i,c])=>{if(Ts(c))return L([o,i,c]);const a=c.intervals,u=YM(py(n,zh(a)));return ne(t(i,u),l=>{const f=Wt(l),h=zh(a),m=n+qi(f),y=m-h,b=Math.max(0,Vh(a)+y),_=py(m,b);return[o,i,oT(_)]})}))),SL=e=>xs(e.initial,(t,n,r)=>p(e.step(t,n,r),ne(([s,o,i])=>[s,n,i]))),Zp=e=>vL(Lc,t=>t<e),bL=e=>wT(Lc,()=>e),_L=(e,t)=>xs(e,(n,r,s)=>M(()=>[t(s),s,oT(QM(n))])),ET=d(2,(e,t)=>Qp(e,(n,r)=>pF(t(n)))),wL=d(2,(e,t)=>vT(e,(n,r)=>t(n))),CT=d(2,(e,t)=>Qp(e,(n,r)=>t(n))),vL=d(2,(e,t)=>vT(e,(n,r)=>t(r))),wa=Symbol.for("effect/Schedule/ScheduleDefect");class TL{error;[wa];constructor(t){this.error=t,this[wa]=wa}}const kL=e=>te(e,wa),du=e=>xo(e,t=>Er(new TL(t))),EL=e=>Fe(cp(e,t=>X_(t)&&kL(t.defect)?U(t.defect):K()),{onNone:()=>e,onSome:t=>Fr(t.error)}),IT=e=>fw(e,t=>ft(EL(t))),vy=d(2,(e,t)=>IL(e,t,(n,r)=>st(n))),CL=d(2,(e,t)=>{if(_T(t))return vy(e,t);const n=t.schedule??SL(Lc),r=t.while?CT(n,i=>{const c=t.while(i);return typeof c=="boolean"?L(c):du(c)}):n,s=t.until?ET(r,i=>{const c=t.until(i);return typeof c=="boolean"?L(c):du(c)}):r,o=t.times?TT(s,Zp(t.times)).pipe(kT(i=>i[0])):s;return IT(vy(e,o))}),IL=d(3,(e,t,n)=>P(Xp(t),r=>zn(e,{onFailure:s=>n(s,K()),onSuccess:s=>$T(nu(e,hu,mn(r.iterationMeta)),r,(o,i)=>nu(n(o,i),hu,mn(r.iterationMeta)),s)}))),$T=(e,t,n,r)=>zn(t.next(r),{onFailure:()=>hp(t.last),onSuccess:s=>zn(e,{onFailure:o=>n(o,U(s)),onSuccess:o=>$T(e,t,n,o)})}),Ty=d(2,(e,t)=>RL(e,t,(n,r)=>st(n))),$L=d(2,(e,t)=>_T(t)?Ty(e,t):IT(Ty(e,AL(t)))),AL=e=>{const t=e.schedule??Lc,n=e.while?CT(t,s=>{const o=e.while(s);return typeof o=="boolean"?L(o):du(o)}):t,r=e.until?ET(n,s=>{const o=e.until(s);return typeof o=="boolean"?L(o):du(o)}):n;return e.times!==void 0?TT(r,Zp(e.times)):r},RL=d(3,(e,t,n)=>P(Xp(t),r=>AT(nu(e,hu,mn(r.iterationMeta)),r,(s,o)=>nu(n(s,o),hu,mn(r.iterationMeta))))),AT=(e,t,n)=>xo(e,r=>zn(t.next(r),{onFailure:()=>p(t.last,hp,P(s=>n(r,s))),onSuccess:()=>AT(e,t,n)})),Lc=_L(0,e=>e+1),oi=Sr,ze=Vp,Tn=Ho,OL=SF,ky=Ee,It=st,fr=ft,PL=hw,$=gw,W=gF,z=L,tt=ae,Qe=M,me=Ke,Ve=xo,Mr=fw,mf=uF,xL=dF,Zc=$L,Fs=vF,Ds=Et,en=lp,vi=Rs,em=kn,us=Gt,Ae=cn,j=ne,FL=fp,El=nl,NL=aw,Zs=oc,BL=Wv,Gh=qv,ML=kc,it=Wp,Dn=b2,LL=av,Yh=eL,Us=Fo,St=Ln,RT=EO,HL=kF,X=P,Qr=Ec,gf=Yv,DL=_2,OT=Gv,Ie=rl,tm=wF,UL=fF,Ey=CL,PT=cv,pu=pw,Pn=on,KL=zn,jL=hp,zL=M2,nm=S2,ts=H2,Q=D2,VL=U2,Qh=TM,Cl=kM,Ce=EM,Il=Nc,qL="effect/QueueEnqueue",xT=Symbol.for(qL),WL="effect/QueueDequeue",rm=Symbol.for(WL),JL="effect/QueueStrategy",FT=Symbol.for(JL),GL="effect/BackingQueue",YL=Symbol.for(GL),NT={_A:e=>e},QL={_A:e=>e},BT={_In:e=>e},sm={_Out:e=>e};class XL extends si{queue;takers;shutdownHook;shutdownFlag;strategy;[xT]=BT;[rm]=sm;constructor(t,n,r,s,o){super(),this.queue=t,this.takers=n,this.shutdownHook=r,this.shutdownFlag=s,this.strategy=o}pipe(){return G(this,arguments)}commit(){return this.take}capacity(){return this.queue.capacity()}get size(){return ae(()=>xo(this.unsafeSize(),()=>Et))}unsafeSize(){return _e(this.shutdownFlag)?K():U(this.queue.length()-kp(this.takers)+this.strategy.surplusSize())}get isEmpty(){return ne(this.size,t=>t<=0)}get isFull(){return ne(this.size,t=>t>=this.capacity())}get shutdown(){return Rs(Ee(t=>(p(this.shutdownFlag,Is(!0)),p(Hn(fo(this.takers),n=>bp(n,t.id()),!1,!1),gt(this.strategy.shutdown),sl(Oc(this.shutdownHook,void 0)),cn))))}get isShutdown(){return M(()=>_e(this.shutdownFlag))}get awaitShutdown(){return Vn(this.shutdownHook)}isActive(){return!_e(this.shutdownFlag)}unsafeOffer(t){if(_e(this.shutdownFlag))return!1;let n;if(this.queue.length()===0){const s=p(this.takers,lr(ot));s!==ot?(ls(s,t),n=!0):n=!1}else n=!1;if(n)return!0;const r=this.queue.offer(t);return eo(this.strategy,this.queue,this.takers),r}offer(t){return ae(()=>{if(_e(this.shutdownFlag))return Et;let n;if(this.queue.length()===0){const s=p(this.takers,lr(ot));s!==ot?(ls(s,t),n=!0):n=!1}else n=!1;if(n)return L(!0);const r=this.queue.offer(t);return eo(this.strategy,this.queue,this.takers),r?L(!0):this.strategy.handleSurplus([t],this.queue,this.takers,this.shutdownFlag)})}offerAll(t){return ae(()=>{if(_e(this.shutdownFlag))return Et;const n=Ne(t),r=this.queue.length()===0?Ne(dH(this.takers,n.length)):ds,[s,o]=p(n,yb(r.length));for(let c=0;c<r.length;c++){const a=r[c],u=s[c];ls(a,u)}if(o.length===0)return L(!0);const i=this.queue.offerAll(o);return eo(this.strategy,this.queue,this.takers),Lu(i)?L(!0):this.strategy.handleSurplus(i,this.queue,this.takers,this.shutdownFlag)})}get take(){return Ee(t=>{if(_e(this.shutdownFlag))return Et;const n=this.queue.poll(ot);if(n!==ot)return this.strategy.unsafeOnQueueEmptySpace(this.queue,this.takers),L(n);{const r=Ac(t.id());return p(ae(()=>(p(this.takers,Bo(r)),eo(this.strategy,this.queue,this.takers),_e(this.shutdownFlag)?Et:Vn(r))),Cc(()=>M(()=>pH(this.takers,r))))}})}get takeAll(){return ae(()=>_e(this.shutdownFlag)?Et:M(()=>{const t=this.queue.pollUpTo(Number.POSITIVE_INFINITY);return this.strategy.unsafeOnQueueEmptySpace(this.queue,this.takers),zi(t)}))}takeUpTo(t){return ae(()=>_e(this.shutdownFlag)?Et:M(()=>{const n=this.queue.pollUpTo(t);return this.strategy.unsafeOnQueueEmptySpace(this.queue,this.takers),zi(n)}))}takeBetween(t,n){return ae(()=>MT(this,t,n,We()))}}const MT=(e,t,n,r)=>n<t?L(r):p(cH(e,n),P(s=>{const o=t-s.length;return o===1?p(Xh(e),ne(i=>p(r,bt(s),wo(i)))):o>1?p(Xh(e),P(i=>MT(e,o-1,n-s.length-1,p(r,bt(s),wo(i))))):L(p(r,bt(s)))})),ZL=e=>p(M(()=>RP(e)),P(t=>LT(HT(t),uH()))),eH=()=>p(M(()=>dl()),P(e=>LT(HT(e),lH()))),tH=(e,t,n,r,s)=>new XL(e,t,n,r,s),LT=(e,t)=>p(Rc(),ne(n=>tH(e,dl(),n,Cs(!1),t)));class nH{mutable;[YL]=QL;constructor(t){this.mutable=t}poll(t){return lr(this.mutable,t)}pollUpTo(t){return pl(this.mutable,t)}offerAll(t){return Ep(this.mutable,t)}offer(t){return Bo(this.mutable,t)}capacity(){return OP(this.mutable)}length(){return kp(this.mutable)}}const HT=e=>new nH(e),rH=e=>e.size,sH=e=>e.isShutdown,oH=e=>e.shutdown,iH=d(2,(e,t)=>e.offer(t)),Xh=e=>e.take,cH=d(2,(e,t)=>e.takeUpTo(t)),aH=d(3,(e,t,n)=>e.takeBetween(t,n)),uH=()=>new fH,lH=()=>new hH;class fH{[FT]=NT;putters=dl();surplusSize(){return kp(this.putters)}onCompleteTakersWithEmptyQueue(t){for(;!as(this.putters)&&!as(t);){const n=lr(t,void 0),r=lr(this.putters,void 0);r[2]&&ls(r[1],!0),ls(n,r[0])}}get shutdown(){return p(el,P(t=>p(M(()=>fo(this.putters)),P(n=>Hn(n,([r,s,o])=>o?p(bp(s,t),cn):Ke,!1,!1)))))}handleSurplus(t,n,r,s){return Ee(o=>{const i=Ac(o.id());return p(ae(()=>(this.unsafeOffer(t,i),this.unsafeOnQueueEmptySpace(n,r),eo(this,n,r),_e(s)?Et:Vn(i))),Cc(()=>M(()=>this.unsafeRemove(i))))})}unsafeOnQueueEmptySpace(t,n){let r=!0;for(;r&&(t.capacity()===Number.POSITIVE_INFINITY||t.length()<t.capacity());){const s=p(this.putters,lr(ot));if(s===ot)r=!1;else{const o=t.offer(s[0]);o&&s[2]?ls(s[1],!0):o||mu(this.putters,p(fo(this.putters),Nt(s))),eo(this,t,n)}}}unsafeOffer(t,n){const r=Ne(t);for(let s=0;s<r.length;s++){const o=r[s];s===r.length-1?p(this.putters,Bo([o,n,!0])):p(this.putters,Bo([o,n,!1]))}}unsafeRemove(t){mu(this.putters,p(fo(this.putters),Mu(([,n])=>n!==t)))}}let hH=class{[FT]=NT;surplusSize(){return 0}get shutdown(){return Ke}onCompleteTakersWithEmptyQueue(){}handleSurplus(t,n,r,s){return L(!1)}unsafeOnQueueEmptySpace(t,n){}};const ls=(e,t)=>fl(e,L(t)),mu=(e,t)=>p(e,Ep(t)),fo=e=>p(e,pl(Number.POSITIVE_INFINITY)),dH=(e,t)=>p(e,pl(t)),pH=(e,t)=>{mu(e,p(fo(e),Mu(n=>t!==n)))},eo=(e,t,n)=>{let r=!0;for(;r&&t.length()!==0;){const s=p(n,lr(ot));if(s!==ot){const o=t.poll(ot);o!==ot?(ls(s,o),e.unsafeOnQueueEmptySpace(t,n)):mu(n,p(fo(n),Nt(s))),r=!0}else r=!1}r&&t.length()===0&&!as(n)&&e.onCompleteTakersWithEmptyQueue(n)},On=Symbol.for("effect/PubSub/AbsentValue"),DT=(e,t)=>n=>{n.has(e)||n.set(e,new Set),n.get(e).add(t)},mH=(e,t)=>n=>{if(!n.has(e))return;const r=n.get(e);r.delete(t),r.size===0&&n.delete(e)},gH=e=>ae(()=>{const t=_H(e);return IH(t,new FH)}),yH=e=>e.shutdown,SH=d(2,(e,t)=>e.publish(t)),bH=e=>e.subscribe,_H=e=>new TH(e?.replay?new MH(e.replay):void 0),wH=(e,t,n)=>ne(Rc(),r=>vH(e,t,e.subscribe(),dl(),r,Cs(!1),n)),vH=(e,t,n,r,s,o,i)=>new EH(e,t,n,r,s,o,i,e.replayWindow());class TH{replayBuffer;publisherHead={value:On,subscribers:0,next:null};publisherTail=this.publisherHead;publisherIndex=0;subscribersIndex=0;capacity=Number.MAX_SAFE_INTEGER;constructor(t){this.replayBuffer=t}replayWindow(){return this.replayBuffer?new LH(this.replayBuffer):HH}isEmpty(){return this.publisherHead===this.publisherTail}isFull(){return!1}size(){return this.publisherIndex-this.subscribersIndex}publish(t){const n=this.publisherTail.subscribers;return n!==0&&(this.publisherTail.next={value:t,subscribers:n,next:null},this.publisherTail=this.publisherTail.next,this.publisherIndex+=1),this.replayBuffer&&this.replayBuffer.offer(t),!0}publishAll(t){if(this.publisherTail.subscribers!==0)for(const n of t)this.publish(n);else this.replayBuffer&&this.replayBuffer.offerAll(t);return We()}slide(){this.publisherHead!==this.publisherTail&&(this.publisherHead=this.publisherHead.next,this.publisherHead.value=On,this.subscribersIndex+=1),this.replayBuffer&&this.replayBuffer.slide()}subscribe(){return this.publisherTail.subscribers+=1,new kH(this,this.publisherTail,this.publisherIndex,!1)}}class kH{self;subscriberHead;subscriberIndex;unsubscribed;constructor(t,n,r,s){this.self=t,this.subscriberHead=n,this.subscriberIndex=r,this.unsubscribed=s}isEmpty(){if(this.unsubscribed)return!0;let t=!0,n=!0;for(;n;)this.subscriberHead===this.self.publisherTail?n=!1:this.subscriberHead.next.value!==On?(t=!1,n=!1):(this.subscriberHead=this.subscriberHead.next,this.subscriberIndex+=1);return t}size(){return this.unsubscribed?0:this.self.publisherIndex-Math.max(this.subscriberIndex,this.self.subscribersIndex)}poll(t){if(this.unsubscribed)return t;let n=!0,r=t;for(;n;)if(this.subscriberHead===this.self.publisherTail)n=!1;else{const s=this.subscriberHead.next.value;s!==On&&(r=s,this.subscriberHead.subscribers-=1,this.subscriberHead.subscribers===0&&(this.self.publisherHead=this.self.publisherHead.next,this.self.publisherHead.value=On,this.self.subscribersIndex+=1),n=!1),this.subscriberHead=this.subscriberHead.next,this.subscriberIndex+=1}return r}pollUpTo(t){const n=[],r=On;let s=0;for(;s!==t;){const o=this.poll(r);o===r?s=t:(n.push(o),s+=1)}return zi(n)}unsubscribe(){if(!this.unsubscribed)for(this.unsubscribed=!0,this.self.publisherTail.subscribers-=1;this.subscriberHead!==this.self.publisherTail;)this.subscriberHead.next.value!==On&&(this.subscriberHead.subscribers-=1,this.subscriberHead.subscribers===0&&(this.self.publisherHead=this.self.publisherHead.next,this.self.publisherHead.value=On,this.self.subscribersIndex+=1)),this.subscriberHead=this.subscriberHead.next}}class EH extends si{pubsub;subscribers;subscription;pollers;shutdownHook;shutdownFlag;strategy;replayWindow;[rm]=sm;constructor(t,n,r,s,o,i,c,a){super(),this.pubsub=t,this.subscribers=n,this.subscription=r,this.pollers=s,this.shutdownHook=o,this.shutdownFlag=i,this.strategy=c,this.replayWindow=a}commit(){return this.take}pipe(){return G(this,arguments)}capacity(){return this.pubsub.capacity}isActive(){return!_e(this.shutdownFlag)}get size(){return ae(()=>_e(this.shutdownFlag)?Et:L(this.subscription.size()+this.replayWindow.remaining))}unsafeSize(){return _e(this.shutdownFlag)?K():U(this.subscription.size()+this.replayWindow.remaining)}get isFull(){return ae(()=>_e(this.shutdownFlag)?Et:L(this.subscription.size()===this.capacity()))}get isEmpty(){return ne(this.size,t=>t===0)}get shutdown(){return Rs(Ee(t=>(Is(this.shutdownFlag,!0),p(qp(om(this.pollers),n=>bp(n,t.id()),!1),gt(M(()=>{this.subscribers.delete(this.subscription),this.subscription.unsubscribe(),this.strategy.unsafeOnPubSubEmptySpace(this.pubsub,this.subscribers)})),sl(Oc(this.shutdownHook,void 0)),cn))))}get isShutdown(){return M(()=>_e(this.shutdownFlag))}get awaitShutdown(){return Vn(this.shutdownHook)}get take(){return Ee(t=>{if(_e(this.shutdownFlag))return Et;if(this.replayWindow.remaining>0){const r=this.replayWindow.take();return L(r)}const n=as(this.pollers)?this.subscription.poll(ot):ot;if(n===ot){const r=Ac(t.id());return p(ae(()=>(p(this.pollers,Bo(r)),p(this.subscribers,DT(this.subscription,this.pollers)),this.strategy.unsafeCompletePollers(this.pubsub,this.subscribers,this.subscription,this.pollers),_e(this.shutdownFlag)?Et:Vn(r))),Cc(()=>M(()=>xH(this.pollers,r))))}else return this.strategy.unsafeOnPubSubEmptySpace(this.pubsub,this.subscribers),L(n)})}get takeAll(){return ae(()=>{if(_e(this.shutdownFlag))return Et;const t=as(this.pollers)?RH(this.subscription):We();return this.strategy.unsafeOnPubSubEmptySpace(this.pubsub,this.subscribers),this.replayWindow.remaining>0?L(bt(this.replayWindow.takeAll(),t)):L(t)})}takeUpTo(t){return ae(()=>{if(_e(this.shutdownFlag))return Et;let n;if(this.replayWindow.remaining>=t){const s=this.replayWindow.takeN(t);return L(s)}else this.replayWindow.remaining>0&&(n=this.replayWindow.takeAll(),t=t-n.length);const r=as(this.pollers)?OH(this.subscription,t):We();return this.strategy.unsafeOnPubSubEmptySpace(this.pubsub,this.subscribers),L(n?bt(n,r):r)})}takeBetween(t,n){return ae(()=>UT(this,t,n,We()))}}const UT=(e,t,n,r)=>n<t?L(r):p(e.takeUpTo(n),P(s=>{const o=t-s.length;return o===1?p(e.take,ne(i=>p(r,bt(s),wo(i)))):o>1?p(e.take,P(i=>UT(e,o-1,n-s.length-1,p(r,bt(s),wo(i))))):L(p(r,bt(s)))}));class CH{pubsub;subscribers;scope;shutdownHook;shutdownFlag;strategy;[xT]=BT;[rm]=sm;constructor(t,n,r,s,o,i){this.pubsub=t,this.subscribers=n,this.scope=r,this.shutdownHook=s,this.shutdownFlag=o,this.strategy=i}capacity(){return this.pubsub.capacity}get size(){return ae(()=>_e(this.shutdownFlag)?Et:M(()=>this.pubsub.size()))}unsafeSize(){return _e(this.shutdownFlag)?K():U(this.pubsub.size())}get isFull(){return ne(this.size,t=>t===this.capacity())}get isEmpty(){return ne(this.size,t=>t===0)}get awaitShutdown(){return Vn(this.shutdownHook)}get isShutdown(){return M(()=>_e(this.shutdownFlag))}get shutdown(){return Rs(Ee(t=>(p(this.shutdownFlag,Is(!0)),p(this.scope.close($w(t.id())),gt(this.strategy.shutdown),sl(Oc(this.shutdownHook,void 0)),cn))))}publish(t){return ae(()=>_e(this.shutdownFlag)?Et:this.pubsub.publish(t)?(this.strategy.unsafeCompleteSubscribers(this.pubsub,this.subscribers),L(!0)):this.strategy.handleSurplus(this.pubsub,this.subscribers,Be(t),this.shutdownFlag))}isActive(){return!_e(this.shutdownFlag)}unsafeOffer(t){return _e(this.shutdownFlag)?!1:this.pubsub.publish(t)?(this.strategy.unsafeCompleteSubscribers(this.pubsub,this.subscribers),!0):!1}publishAll(t){return ae(()=>{if(_e(this.shutdownFlag))return Et;const n=PH(this.pubsub,t);return this.strategy.unsafeCompleteSubscribers(this.pubsub,this.subscribers),Lu(n)?L(!0):this.strategy.handleSurplus(this.pubsub,this.subscribers,n,this.shutdownFlag)})}get subscribe(){const t=rl(Vp([this.scope.fork(Rr),wH(this.pubsub,this.subscribers,this.strategy)]),n=>n[0].addFinalizer(()=>n[1].shutdown));return ne(mM(t,(n,r)=>n[0].close(r)),n=>n[1])}offer(t){return this.publish(t)}offerAll(t){return this.publishAll(t)}pipe(){return G(this,arguments)}}const IH=(e,t)=>P(kl(),n=>ne(Rc(),r=>$H(e,new Map,n,r,Cs(!1),t))),$H=(e,t,n,r,s,o)=>new CH(e,t,n,r,s,o),AH=(e,t)=>{fl(e,L(t))},KT=(e,t)=>p(e,Ep(t)),om=e=>p(e,pl(Number.POSITIVE_INFINITY)),RH=e=>e.pollUpTo(Number.POSITIVE_INFINITY),OH=(e,t)=>e.pollUpTo(t),PH=(e,t)=>e.publishAll(t),xH=(e,t)=>{KT(e,p(om(e),Mu(n=>n!==t)))};class FH{get shutdown(){return Ke}handleSurplus(t,n,r,s){return L(!1)}unsafeOnPubSubEmptySpace(t,n){}unsafeCompletePollers(t,n,r,s){return NH(this,t,n,r,s)}unsafeCompleteSubscribers(t,n){return BH(this,t,n)}}const NH=(e,t,n,r,s)=>{let o=!0;for(;o&&!r.isEmpty();){const i=p(s,lr(ot));if(i===ot)p(n,mH(r,s)),as(s)?o=!1:p(n,DT(r,s));else{const c=r.poll(ot);c===ot?KT(s,p(om(s),Nt(i))):(AH(i,c),e.unsafeOnPubSubEmptySpace(t,n))}}},BH=(e,t,n)=>{for(const[r,s]of n)for(const o of s)e.unsafeCompletePollers(t,n,r,o)};class MH{capacity;constructor(t){this.capacity=t}head={value:On,next:null};tail=this.head;size=0;index=0;slide(){this.index++}offer(t){this.tail.value=t,this.tail.next={value:On,next:null},this.tail=this.tail.next,this.size===this.capacity?this.head=this.head.next:this.size+=1}offerAll(t){for(const n of t)this.offer(n)}}class LH{buffer;head;index;remaining;constructor(t){this.buffer=t,this.index=t.index,this.remaining=t.size,this.head=t.head}fastForward(){for(;this.index<this.buffer.index;)this.head=this.head.next,this.index++}take(){if(this.remaining===0)return;this.index<this.buffer.index&&this.fastForward(),this.remaining--;const t=this.head.value;return this.head=this.head.next,t}takeN(t){if(this.remaining===0)return We();this.index<this.buffer.index&&this.fastForward();const n=Math.min(t,this.remaining),r=new Array(n);for(let s=0;s<n;s++){const o=this.head.value;this.head=this.head.next,r[s]=o}return this.remaining-=n,sn(r)}takeAll(){return this.takeN(this.remaining)}}const HH={remaining:0,take:()=>{},takeN:()=>We(),takeAll:()=>We()},jT=gH,Zh=yH,im=SH,Cy=bH,cm=ZL,zT=eH,DH=rH,UH=sH,ac=oH,Kt=iH,ed=Xh,KH=aH,VT="Continue",jH="Close",zH="Yield",VH="effect/ChannelChildExecutorDecision",Iy=Symbol.for(VH),qH={[Iy]:Iy},qT=e=>{const t=Object.create(qH);return t._tag=VT,t},va="ContinuationK",WH="ContinuationFinalizer",WT=Symbol.for("effect/ChannelContinuation"),JT={_Env:e=>e,_InErr:e=>e,_InElem:e=>e,_InDone:e=>e,_OutErr:e=>e,_OutDone:e=>e,_OutErr2:e=>e,_OutElem:e=>e,_OutDone2:e=>e};class GT{onSuccess;onHalt;_tag=va;[WT]=JT;constructor(t,n){this.onSuccess=t,this.onHalt=n}onExit(t){return Ow(t)?this.onHalt(t.cause):this.onSuccess(t.value)}}class JH{finalizer;_tag=WH;[WT]=JT;constructor(t){this.finalizer=t}}const YT="PullAfterNext",GH="PullAfterAllEnqueued",YH="effect/ChannelUpstreamPullStrategy",QH=Symbol.for(YH),XH={_A:e=>e},ZH={[QH]:XH},QT=e=>{const t=Object.create(ZH);return t._tag=YT,t.emitSeparator=e,t},XT="BracketOut",ZT="Bridge",am="ConcatAll",ek="Emit",tk="Ensuring",nk="Fail",rk="Fold",sk="FromEffect",ok="PipeTo",eD="Provide",ik="Read",ck="Succeed",ak="SucceedNow",uk="Suspend",tD="effect/Channel",lk=Symbol.for(tD),nD={_Env:e=>e,_InErr:e=>e,_InElem:e=>e,_InDone:e=>e,_OutErr:e=>e,_OutElem:e=>e,_OutDone:e=>e},Qt={[lk]:nD,pipe(){return G(this,arguments)}},fk=e=>te(e,lk)||oi(e),rD=d(2,(e,t)=>{const n=Object.create(Qt);return n._tag=XT,n.acquire=()=>e,n.finalizer=t,n}),hk=(e,t,n)=>{const r=Object.create(Qt);return r._tag=am,r.combineInners=t,r.combineAll=n,r.onPull=()=>QT(K()),r.onEmit=()=>qT,r.value=()=>e,r.k=ee,r},sD=d(4,(e,t,n,r)=>{const s=Object.create(Qt);return s._tag=am,s.combineInners=n,s.combineAll=r,s.onPull=()=>QT(K()),s.onEmit=()=>qT,s.value=()=>e,s.k=t,s}),um=d(2,(e,t)=>{const n=Object.create(Qt);return n._tag=ZT,n.input=t,n.channel=e,n}),oD=d(2,(e,t)=>{const n=Object.create(Qt);return n._tag=tk,n.channel=e,n.finalizer=t,n}),Or=e=>_t(PM(e)),_t=e=>iD(()=>e),iD=e=>{const t=Object.create(Qt);return t._tag=nk,t.error=e,t},ke=d(2,(e,t)=>{const n=Object.create(Qt);return n._tag=rk,n.channel=e,n.k=new GT(t,_t),n}),kt=e=>{const t=Object.create(Qt);return t._tag=sk,t.effect=()=>e,t},Ft=d(2,(e,t)=>{const n=Object.create(Qt);return n._tag=ok,n.left=()=>e,n.right=()=>t,n}),Hc=e=>Gn({onInput:e.onInput,onFailure:t=>jt(MM(t),{onLeft:e.onFailure,onRight:_t}),onDone:e.onDone}),Gn=e=>{const t=Object.create(Qt);return t._tag=ik,t.more=e.onInput,t.done=new GT(e.onDone,e.onFailure),t},lm=e=>dk(()=>e),qn=e=>{const t=Object.create(Qt);return t._tag=ak,t.terminal=e,t},$l=e=>{const t=Object.create(Qt);return t._tag=uk,t.channel=e,t},dk=e=>{const t=Object.create(Qt);return t._tag=ck,t.evaluate=e,t},Lt=qn(void 0),Re=e=>{const t=Object.create(Qt);return t._tag=ek,t.out=e,t},Dc="Done",Uc="Emit",ii="FromEffect",Kc="Read",cD=Symbol.for("effect/ChannelState"),aD={_E:e=>e,_R:e=>e},Al={[cD]:aD},Ks=()=>{const e=Object.create(Al);return e._tag=Dc,e},yf=()=>{const e=Object.create(Al);return e._tag=Uc,e},gi=e=>{const t=Object.create(Al);return t._tag=ii,t.effect=e,t},Sf=(e,t,n,r)=>{const s=Object.create(Al);return s._tag=Kc,s.upstream=e,s.onEffect=t,s.onEmit=n,s.onDone=r,s},gu=e=>e._tag===ii,uD=e=>gu(e)?e.effect:me,$y=e=>gu(e)?xL(e.effect):void 0,pk="PullFromChild",td="PullFromUpstream",nd="DrainChildExecutors",mk="Emit";class ea{childExecutor;parentSubexecutor;onEmit;_tag=pk;constructor(t,n,r){this.childExecutor=t,this.parentSubexecutor=n,this.onEmit=r}close(t){const n=this.childExecutor.close(t),r=this.parentSubexecutor.close(t);return n!==void 0&&r!==void 0?Il(St(n),St(r),(s,o)=>p(s,ec(o))):n!==void 0?n:r!==void 0?r:void 0}enqueuePullFromChild(t){return this}}class Xr{upstreamExecutor;createChild;lastDone;activeChildExecutors;combineChildResults;combineWithChildResult;onPull;onEmit;_tag=td;constructor(t,n,r,s,o,i,c,a){this.upstreamExecutor=t,this.createChild=n,this.lastDone=r,this.activeChildExecutors=s,this.combineChildResults=o,this.combineWithChildResult=i,this.onPull=c,this.onEmit=a}close(t){const n=this.upstreamExecutor.close(t),s=[...this.activeChildExecutors.map(o=>o!==void 0?o.childExecutor.close(t):void 0),n].reduce((o,i)=>o!==void 0&&i!==void 0?Il(o,St(i),(c,a)=>ec(c,a)):o!==void 0?o:i!==void 0?St(i):void 0,void 0);return s}enqueuePullFromChild(t){return new Xr(this.upstreamExecutor,this.createChild,this.lastDone,[...this.activeChildExecutors,t],this.combineChildResults,this.combineWithChildResult,this.onPull,this.onEmit)}}class to{upstreamExecutor;lastDone;activeChildExecutors;upstreamDone;combineChildResults;combineWithChildResult;onPull;_tag=nd;constructor(t,n,r,s,o,i,c){this.upstreamExecutor=t,this.lastDone=n,this.activeChildExecutors=r,this.upstreamDone=s,this.combineChildResults=o,this.combineWithChildResult=i,this.onPull=c}close(t){const n=this.upstreamExecutor.close(t),s=[...this.activeChildExecutors.map(o=>o!==void 0?o.childExecutor.close(t):void 0),n].reduce((o,i)=>o!==void 0&&i!==void 0?Il(o,St(i),(c,a)=>ec(c,a)):o!==void 0?o:i!==void 0?St(i):void 0,void 0);return s}enqueuePullFromChild(t){return new to(this.upstreamExecutor,this.lastDone,[...this.activeChildExecutors,t],this.upstreamDone,this.combineChildResults,this.combineWithChildResult,this.onPull)}}class bf{value;next;_tag=mk;constructor(t,n){this.value=t,this.next=n}close(t){const n=this.next.close(t);return n}enqueuePullFromChild(t){return this}}const lD="Pulled",fD="NoUpstream",hD="effect/ChannelUpstreamPullRequest",dD=Symbol.for(hD),pD={_A:e=>e},gk={[dD]:pD},Ay=e=>{const t=Object.create(gk);return t._tag=lD,t.value=e,t},mD=e=>{const t=Object.create(gk);return t._tag=fD,t.activeDownstreamCount=e,t};class ns{_activeSubexecutor=void 0;_cancelled=void 0;_closeLastSubstream=void 0;_currentChannel;_done=void 0;_doneStack=[];_emitted=void 0;_executeCloseLastSubstream;_input=void 0;_inProgressFinalizer=void 0;_providedEnv;constructor(t,n,r){this._currentChannel=t,this._executeCloseLastSubstream=r,this._providedEnv=n}run(){let t;for(;t===void 0;)if(this._cancelled!==void 0)t=this.processCancellation();else if(this._activeSubexecutor!==void 0)t=this.runSubexecutor();else try{if(this._currentChannel===void 0)t=Ks();else switch(oi(this._currentChannel)&&(this._currentChannel=kt(this._currentChannel)),this._currentChannel._tag){case XT:{t=this.runBracketOut(this._currentChannel);break}case ZT:{const n=this._currentChannel.input;if(this._currentChannel=this._currentChannel.channel,this._input!==void 0){const r=this._input;this._input=void 0;const s=()=>X(n.awaitRead(),()=>tt(()=>{const o=r.run();switch(o._tag){case Dc:return Bn(r.getDone(),{onFailure:i=>n.error(i),onSuccess:i=>n.done(i)});case Uc:return X(n.emit(r.getEmit()),()=>s());case ii:return Pn(o.effect,{onFailure:i=>n.error(i),onSuccess:()=>s()});case Kc:return fm(o,()=>s(),i=>n.error(i))}}));t=gi(X(it(en(s())),o=>Qe(()=>this.addFinalizer(i=>X(xe(o),()=>tt(()=>{const c=this.restorePipe(i,r);return c!==void 0?c:me}))))))}break}case am:{const n=new ns(this._currentChannel.value(),this._providedEnv,s=>Qe(()=>{const o=this._closeLastSubstream===void 0?me:this._closeLastSubstream;this._closeLastSubstream=p(o,Ce(s))}));n._input=this._input;const r=this._currentChannel;this._activeSubexecutor=new Xr(n,s=>r.k(s),void 0,[],(s,o)=>r.combineInners(s,o),(s,o)=>r.combineAll(s,o),s=>r.onPull(s),s=>r.onEmit(s)),this._closeLastSubstream=void 0,this._currentChannel=void 0;break}case ek:{this._emitted=this._currentChannel.out,this._currentChannel=this._activeSubexecutor!==void 0?void 0:Lt,t=yf();break}case tk:{this.runEnsuring(this._currentChannel);break}case nk:{t=this.doneHalt(this._currentChannel.error());break}case rk:{this._doneStack.push(this._currentChannel.k),this._currentChannel=this._currentChannel.channel;break}case sk:{const n=this._providedEnv===void 0?this._currentChannel.effect():p(this._currentChannel.effect(),Yh(this._providedEnv));t=gi(Pn(n,{onFailure:r=>{const s=this.doneHalt(r);return s!==void 0&&gu(s)?s.effect:me},onSuccess:r=>{const s=this.doneSucceed(r);return s!==void 0&&gu(s)?s.effect:me}}));break}case ok:{const n=this._input,r=new ns(this._currentChannel.left(),this._providedEnv,s=>this._executeCloseLastSubstream(s));r._input=n,this._input=r,this.addFinalizer(s=>{const o=this.restorePipe(s,n);return o!==void 0?o:me}),this._currentChannel=this._currentChannel.right();break}case eD:{const n=this._providedEnv;this._providedEnv=this._currentChannel.context(),this._currentChannel=this._currentChannel.inner,this.addFinalizer(()=>Qe(()=>{this._providedEnv=n}));break}case ik:{const n=this._currentChannel;t=Sf(this._input,ee,r=>{try{this._currentChannel=n.more(r)}catch(s){this._currentChannel=n.done.onExit(mP(s))}},r=>{const s=o=>n.done.onExit(o);this._currentChannel=s(r)});break}case ck:{t=this.doneSucceed(this._currentChannel.evaluate());break}case ak:{t=this.doneSucceed(this._currentChannel.terminal);break}case uk:{this._currentChannel=this._currentChannel.channel();break}}}catch(n){this._currentChannel=_t(Kh(n))}return t}getDone(){return this._done}getEmit(){return this._emitted}cancelWith(t){this._cancelled=t}clearInProgressFinalizer(){this._inProgressFinalizer=void 0}storeInProgressFinalizer(t){this._inProgressFinalizer=t}popAllFinalizers(t){const n=[];let r=this._doneStack.pop();for(;r;)r._tag==="ContinuationFinalizer"&&n.push(r.finalizer),r=this._doneStack.pop();const s=n.length===0?me:wf(n,t);return this.storeInProgressFinalizer(s),s}popNextFinalizers(){const t=[];for(;this._doneStack.length!==0;){const n=this._doneStack[this._doneStack.length-1];if(n._tag===va)return t;t.push(n),this._doneStack.pop()}return t}restorePipe(t,n){const r=this._input;return this._input=n,r!==void 0?r.close(t):me}close(t){let n;const r=this._inProgressFinalizer;r!==void 0&&(n=p(r,Zs(Qe(()=>this.clearInProgressFinalizer()))));let s;const o=this.popAllFinalizers(t);o!==void 0&&(s=p(o,Zs(Qe(()=>this.clearInProgressFinalizer()))));const i=this._activeSubexecutor===void 0?void 0:this._activeSubexecutor.close(t);if(!(i===void 0&&n===void 0&&s===void 0))return p(St(_f(i)),Qh(St(_f(n))),Qh(St(_f(s))),j(([[c,a],u])=>p(c,ec(a),ec(u))),vi,X(c=>tt(()=>c)))}doneSucceed(t){if(this._doneStack.length===0)return this._done=hn(t),this._currentChannel=void 0,Ks();const n=this._doneStack[this._doneStack.length-1];if(n._tag===va){this._doneStack.pop(),this._currentChannel=n.onSuccess(t);return}const r=this.popNextFinalizers();if(this._doneStack.length===0)return this._doneStack=r.reverse(),this._done=hn(t),this._currentChannel=void 0,Ks();const s=wf(r.map(i=>i.finalizer),hn(t));this.storeInProgressFinalizer(s);const o=p(s,Zs(Qe(()=>this.clearInProgressFinalizer())),vi,X(()=>Qe(()=>this.doneSucceed(t))));return gi(o)}doneHalt(t){if(this._doneStack.length===0)return this._done=pn(t),this._currentChannel=void 0,Ks();const n=this._doneStack[this._doneStack.length-1];if(n._tag===va){this._doneStack.pop();try{this._currentChannel=n.onHalt(t)}catch(i){this._currentChannel=_t(Kh(i))}return}const r=this.popNextFinalizers();if(this._doneStack.length===0)return this._doneStack=r.reverse(),this._done=pn(t),this._currentChannel=void 0,Ks();const s=wf(r.map(i=>i.finalizer),pn(t));this.storeInProgressFinalizer(s);const o=p(s,Zs(Qe(()=>this.clearInProgressFinalizer())),vi,X(()=>Qe(()=>this.doneHalt(t))));return gi(o)}processCancellation(){return this._currentChannel=void 0,this._done=this._cancelled,this._cancelled=void 0,Ks()}runBracketOut(t){const n=vi(Pn(this.provide(t.acquire()),{onFailure:r=>Qe(()=>{this._currentChannel=_t(r)}),onSuccess:r=>Qe(()=>{this.addFinalizer(s=>this.provide(t.finalizer(r,s))),this._currentChannel=Re(r)})}));return gi(n)}provide(t){return this._providedEnv===void 0?t:p(t,Yh(this._providedEnv))}runEnsuring(t){this.addFinalizer(t.finalizer),this._currentChannel=t.channel}addFinalizer(t){this._doneStack.push(new JH(t))}runSubexecutor(){const t=this._activeSubexecutor;switch(t._tag){case pk:return this.pullFromChild(t.childExecutor,t.parentSubexecutor,t.onEmit,t);case td:return this.pullFromUpstream(t);case nd:return this.drainChildExecutors(t);case mk:return this._emitted=t.value,this._activeSubexecutor=t.next,yf()}}replaceSubexecutor(t){this._currentChannel=void 0,this._activeSubexecutor=t}finishWithExit(t){const n=Bn(t,{onFailure:r=>this.doneHalt(r),onSuccess:r=>this.doneSucceed(r)});return this._activeSubexecutor=void 0,n===void 0?me:uD(n)}finishSubexecutorWithCloseEffect(t,...n){this.addFinalizer(()=>p(n,Tn(s=>p(Qe(()=>s(t)),X(o=>o!==void 0?o:me)),{discard:!0})));const r=p(t,Bn({onFailure:s=>this.doneHalt(s),onSuccess:s=>this.doneSucceed(s)}));return this._activeSubexecutor=void 0,r}applyUpstreamPullStrategy(t,n,r){switch(r._tag){case YT:{const s=!t||n.some(o=>o!==void 0);return[r.emitSeparator,s?[void 0,...n]:n]}case GH:{const s=!t||n.some(o=>o!==void 0);return[r.emitSeparator,s?[...n,void 0]:n]}}}pullFromChild(t,n,r,s){return Sf(t,ee,o=>{const i=r(o);switch(i._tag){case VT:break;case jH:{this.finishWithDoneValue(t,n,i.value);break}case zH:{const c=n.enqueuePullFromChild(s);this.replaceSubexecutor(c);break}}this._activeSubexecutor=new bf(o,this._activeSubexecutor)},Bn({onFailure:o=>{const i=this.handleSubexecutorFailure(t,n,o);return i===void 0?void 0:$y(i)},onSuccess:o=>{this.finishWithDoneValue(t,n,o)}}))}finishWithDoneValue(t,n,r){const s=n;switch(s._tag){case td:{const o=new Xr(s.upstreamExecutor,s.createChild,s.lastDone!==void 0?s.combineChildResults(s.lastDone,r):r,s.activeChildExecutors,s.combineChildResults,s.combineWithChildResult,s.onPull,s.onEmit);this._closeLastSubstream=t.close(hn(r)),this.replaceSubexecutor(o);break}case nd:{const o=new to(s.upstreamExecutor,s.lastDone!==void 0?s.combineChildResults(s.lastDone,r):r,s.activeChildExecutors,s.upstreamDone,s.combineChildResults,s.combineWithChildResult,s.onPull);this._closeLastSubstream=t.close(hn(r)),this.replaceSubexecutor(o);break}}}handleSubexecutorFailure(t,n,r){return this.finishSubexecutorWithCloseEffect(pn(r),s=>n.close(s),s=>t.close(s))}pullFromUpstream(t){if(t.activeChildExecutors.length===0)return this.performPullFromUpstream(t);const n=t.activeChildExecutors[0],r=new Xr(t.upstreamExecutor,t.createChild,t.lastDone,t.activeChildExecutors.slice(1),t.combineChildResults,t.combineWithChildResult,t.onPull,t.onEmit);if(n===void 0)return this.performPullFromUpstream(r);this.replaceSubexecutor(new ea(n.childExecutor,r,n.onEmit))}performPullFromUpstream(t){return Sf(t.upstreamExecutor,n=>{const r=this._closeLastSubstream===void 0?me:this._closeLastSubstream;return this._closeLastSubstream=void 0,p(this._executeCloseLastSubstream(r),Ce(n))},n=>{if(this._closeLastSubstream!==void 0){const i=this._closeLastSubstream;return this._closeLastSubstream=void 0,p(this._executeCloseLastSubstream(i),j(()=>{const c=new ns(t.createChild(n),this._providedEnv,this._executeCloseLastSubstream);c._input=this._input;const[a,u]=this.applyUpstreamPullStrategy(!1,t.activeChildExecutors,t.onPull(Ay(n)));this._activeSubexecutor=new ea(c,new Xr(t.upstreamExecutor,t.createChild,t.lastDone,u,t.combineChildResults,t.combineWithChildResult,t.onPull,t.onEmit),t.onEmit),$e(a)&&(this._activeSubexecutor=new bf(a.value,this._activeSubexecutor))}))}const r=new ns(t.createChild(n),this._providedEnv,this._executeCloseLastSubstream);r._input=this._input;const[s,o]=this.applyUpstreamPullStrategy(!1,t.activeChildExecutors,t.onPull(Ay(n)));this._activeSubexecutor=new ea(r,new Xr(t.upstreamExecutor,t.createChild,t.lastDone,o,t.combineChildResults,t.combineWithChildResult,t.onPull,t.onEmit),t.onEmit),$e(s)&&(this._activeSubexecutor=new bf(s.value,this._activeSubexecutor))},n=>{if(t.activeChildExecutors.some(o=>o!==void 0)){const o=new to(t.upstreamExecutor,t.lastDone,[void 0,...t.activeChildExecutors],t.upstreamExecutor.getDone(),t.combineChildResults,t.combineWithChildResult,t.onPull);if(this._closeLastSubstream!==void 0){const i=this._closeLastSubstream;return this._closeLastSubstream=void 0,p(this._executeCloseLastSubstream(i),j(()=>this.replaceSubexecutor(o)))}this.replaceSubexecutor(o);return}const r=this._closeLastSubstream,s=this.finishSubexecutorWithCloseEffect(p(n,gP(o=>t.combineWithChildResult(t.lastDone,o))),()=>r,o=>t.upstreamExecutor.close(o));return s===void 0?void 0:$y(s)})}drainChildExecutors(t){if(t.activeChildExecutors.length===0){const o=this._closeLastSubstream;return o!==void 0&&this.addFinalizer(()=>z(o)),this.finishSubexecutorWithCloseEffect(t.upstreamDone,()=>o,i=>t.upstreamExecutor.close(i))}const n=t.activeChildExecutors[0],r=t.activeChildExecutors.slice(1);if(n===void 0){const[o,i]=this.applyUpstreamPullStrategy(!0,r,t.onPull(mD(r.reduce((c,a)=>a!==void 0?c+1:c,0))));return this.replaceSubexecutor(new to(t.upstreamExecutor,t.lastDone,i,t.upstreamDone,t.combineChildResults,t.combineWithChildResult,t.onPull)),$e(o)?(this._emitted=o.value,yf()):void 0}const s=new to(t.upstreamExecutor,t.lastDone,r,t.upstreamDone,t.combineChildResults,t.combineWithChildResult,t.onPull);this.replaceSubexecutor(new ea(n.childExecutor,s,n.onEmit))}}const _f=e=>e!==void 0?e:me,wf=(e,t)=>p(Tn(e,n=>St(n(t))),j(n=>p(pP(n),qe(()=>yP))),X(n=>tt(()=>n))),fm=(e,t,n)=>{const r=[e],s=()=>{const o=r.pop();if(o===void 0||o.upstream===void 0)return PL("Unexpected end of input for channel execution");const i=o.upstream.run();switch(i._tag){case Uc:{const c=o.onEmit(o.upstream.getEmit());return r.length===0?c===void 0?tt(t):p(c,Pn({onFailure:n,onSuccess:t})):c===void 0?tt(()=>s()):p(c,Pn({onFailure:n,onSuccess:()=>s()}))}case Dc:{const c=o.onDone(o.upstream.getDone());return r.length===0?c===void 0?tt(t):p(c,Pn({onFailure:n,onSuccess:t})):c===void 0?tt(()=>s()):p(c,Pn({onFailure:n,onSuccess:()=>s()}))}case ii:return r.push(o),p(o.onEffect(i.effect),Mr(c=>tt(()=>{const a=o.onDone(pn(c));return a===void 0?me:a})),Pn({onFailure:n,onSuccess:()=>s()}));case Kc:return r.push(o),r.push(i),tt(()=>s())}};return s()},yk=d(2,(e,t)=>{const n=(r,s,o)=>NL(Qe(()=>new ns(e,void 0,ee)),i=>tt(()=>Ta(i.run(),i).pipe(RT(r),Ce(Ct(r)),Cl(Ct(s)))),(i,c)=>{const a=i.close(c);return a===void 0?me:tm(a,u=>ic(o,fr(u)))});return em(r=>ze([iT(t,ru),dn(),dn()]).pipe(X(([s,o,i])=>r(n(o,i,s)).pipe(Dn(t),X(c=>t.addFinalizer(a=>{const u=Ow(a)?BM(a.cause):void 0;return Th(o).pipe(X(l=>l?Nn(i,void 0).pipe(Ce(fT(c)),Ce(yy(c))):Nn(i,void 0).pipe(Ce(u&&np(u)>0?I2(c,mR(u)):xe(c)),Ce(yy(c)))))}).pipe(Ce(r(Ct(o)))))))))}),Ta=(e,t)=>{const n=e;switch(n._tag){case ii:return p(n.effect,X(()=>Ta(t.run(),t)));case Uc:return Ta(t.run(),t);case Dc:return tt(()=>t.getDone());case Kc:return fm(n,()=>Ta(t.run(),t),fr)}},Sk="Done",gD="Await",yD="effect/ChannelMergeDecision",SD=Symbol.for(yD),bk={[SD]:{_R:e=>e,_E0:e=>e,_Z0:e=>e,_E:e=>e,_Z:e=>e}},bD=e=>{const t=Object.create(bk);return t._tag=Sk,t.effect=e,t},rd=e=>{const t=Object.create(bk);return t._tag=gD,t.f=e,t},_k="BothRunning",wk="LeftDone",vk="RightDone",_D="effect/ChannelMergeState",Ry=Symbol.for(_D),hm={[Ry]:Ry},vf=(e,t)=>{const n=Object.create(hm);return n._tag=_k,n.left=e,n.right=t,n},Oy=e=>{const t=Object.create(hm);return t._tag=wk,t.f=e,t},Py=e=>{const t=Object.create(hm);return t._tag=vk,t.f=e,t},Tk="BackPressure",kk="BufferSliding",wD="effect/ChannelMergeStrategy",xy=Symbol.for(wD),Ek={[xy]:xy},vD=e=>{const t=Object.create(Ek);return t._tag=Tk,t},TD=e=>{const t=Object.create(Ek);return t._tag=kk,t},kD=d(2,(e,{onBackPressure:t,onBufferSliding:n})=>{switch(e._tag){case Tk:return t();case kk:return n()}}),Js="Empty",Ti="Emit",ki="Error",Ei="Done",Ck=e=>({_tag:Js,notifyProducer:e}),Tf=e=>({_tag:Ti,notifyConsumers:e}),ED=e=>({_tag:ki,cause:e}),CD=e=>({_tag:Ei,done:e});class ID{ref;constructor(t){this.ref=t}awaitRead(){return Qr(di(this.ref,t=>t._tag===Js?[Ct(t.notifyProducer),t]:[me,t]))}get close(){return ML(t=>this.error(xM(t)))}done(t){return Qr(di(this.ref,n=>{switch(n._tag){case Js:return[Ct(n.notifyProducer),n];case Ti:return[Tn(n.notifyConsumers,r=>Nn(r,re(t)),{discard:!0}),CD(t)];case ki:return[Ds,n];case Ei:return[Ds,n]}}))}emit(t){return X(dn(),n=>Qr(di(this.ref,r=>{switch(r._tag){case Js:return[Ct(r.notifyProducer),r];case Ti:{const s=r.notifyConsumers[0],o=r.notifyConsumers.slice(1);if(s!==void 0)return[Nn(s,pe(t)),o.length===0?Ck(n):Tf(o)];throw new Error("Bug: Channel.SingleProducerAsyncInput.emit - Queue was empty! please report an issue at https://github.com/Effect-TS/effect/issues")}case ki:return[Ds,r];case Ei:return[Ds,r]}})))}error(t){return Qr(di(this.ref,n=>{switch(n._tag){case Js:return[Ct(n.notifyProducer),n];case Ti:return[Tn(n.notifyConsumers,r=>Rw(r,t),{discard:!0}),ED(t)];case ki:return[Ds,n];case Ei:return[Ds,n]}}))}get take(){return this.takeWith(t=>pn(Xv(t,re)),t=>hn(t),t=>Pw(pe(t)))}takeWith(t,n,r){return X(dn(),s=>Qr(di(this.ref,o=>{switch(o._tag){case Js:return[Ce(Nn(o.notifyProducer,void 0),pu(Ct(s),{onFailure:t,onSuccess:jt({onLeft:r,onRight:n})})),Tf([s])];case Ti:return[pu(Ct(s),{onFailure:t,onSuccess:jt({onLeft:r,onRight:n})}),Tf([...o.notifyConsumers,s])];case ki:return[z(t(o.cause)),o];case Ei:return[z(r(o.done)),o]}})))}}const dm=()=>p(dn(),X(e=>Ap(Ck(e))),j(e=>new ID(e))),$D=d(2,(e,t)=>mm(e,()=>t)),yu=d(2,(e,t)=>sD(e,t,()=>{},()=>{})),pm=e=>{const t=Gn({onInput:()=>t,onFailure:_t,onDone:lm});return Ft(e,t)},Ik=d(2,(e,t)=>oD(e,()=>t)),AD=e=>ke(e,ee),Rl=e=>rn(e.takeWith(_t,t=>ke(Re(t),()=>Rl(e)),lm)),$k=()=>Hc({onInput:e=>ke(Re(e),()=>$k()),onFailure:Or,onDone:qn}),mm=d(2,(e,t)=>ke(e,n=>dk(()=>t(n)))),Ol=d(2,(e,t)=>{const n=Hc({onInput:r=>ke(Re(t(r)),()=>n),onFailure:Or,onDone:qn});return Ft(e,n)}),RD=d(3,(e,t,n)=>gm(r=>$(function*(){const s=yield*dm(),o=Rl(s),i=yield*cm(n);yield*ic(r,ac(i));const c=yield*dn(),a=n===Number.POSITIVE_INFINITY?f=>ee:(yield*nm(n)).withPermits;yield*(yield*o.pipe(Ft(e),ho(r))).pipe(Pn({onFailure:f=>Kt(i,fr(f)),onSuccess:jt({onLeft:f=>Ce(en(a(n)(me)),Ae(Kt(i,z(re(f))))),onRight:f=>$(function*(){const h=yield*dn(),m=yield*dn();yield*Kt(i,j(Ct(h),pe)),yield*Nn(m,void 0).pipe(Ce(em(y=>St(y(Ct(c))).pipe(DL(St(y(t(f)))),X(ee))).pipe(tm(y=>Rw(c,y)),RT(h))),a(1),Dn(r)),yield*Ct(m)})})}),UL,en,Dn(r));const l=rn(pu(Qr(ed(i)),{onFailure:_t,onSuccess:jt({onLeft:qn,onRight:f=>ke(Re(f),()=>l)})}));return um(l,s)}))),OD=e=>t=>PD(e)(t,Pa),PD=({bufferSize:e=16,concurrency:t,mergeStrategy:n=vD()})=>(r,s)=>gm(o=>$(function*(){const i=t==="unbounded"?Number.MAX_SAFE_INTEGER:t,c=yield*dm(),a=Rl(c),u=yield*cm(e);yield*ic(o,ac(u));const l=yield*zT();yield*ic(o,ac(l));const f=yield*Ap(K()),h=yield*dn(),m=(yield*nm(i)).withPermits,y=yield*ho(Ft(a,r),o);function b(T){return T.pipe(X(jt({onLeft:C=>z(U(C)),onRight:C=>us(Kt(u,z(pe(C))),K())})),Ey({until:C=>$e(C)}),X(C=>Xw(f,Fe({onNone:()=>U(C.value),onSome:v=>U(s(v,C.value))}))),Mr(C=>Qv(C)?fr(C):Kt(u,fr(C)).pipe(Ce(Nn(h,void 0)),Ae)))}yield*y.pipe(Pn({onFailure:T=>Kt(u,fr(T)).pipe(Ce(z(!1))),onSuccess:jt({onLeft:T=>OT(en(Ct(h)),en(m(i)(me)),{onSelfDone:(C,v)=>us(xe(v),!1),onOtherDone:(C,v)=>Ce(xe(v),Ni(f).pipe(X(Fe({onNone:()=>Kt(u,z(re(T))),onSome:k=>Kt(u,z(re(s(k,T))))})),us(!1)))}),onRight:T=>kD(n,{onBackPressure:()=>$(function*(){const C=yield*dn(),v=Gh(R=>ho(Ft(a,T),R).pipe(X(w=>gf(St(b(w)),St(en(Ct(h))))),X(ee)));return yield*Nn(C,void 0).pipe(Ce(v),m(1),Dn(o)),yield*Ct(C),!(yield*Th(h))}),onBufferSliding:()=>$(function*(){const C=yield*dn(),v=yield*dn(),k=yield*DH(l);yield*ed(l).pipe(X(I=>Nn(I,void 0)),HL(()=>k>=i)),yield*Kt(l,C);const R=Gh(I=>ho(Ft(a,T),I).pipe(X(O=>St(b(O)).pipe(gf(St(en(Ct(h)))),gf(St(en(Ct(C)))))),X(ee)));return yield*Nn(v,void 0).pipe(Ce(R),m(1),Dn(o)),yield*Ct(v),!(yield*Th(h))})})})}),Ey({while:T=>T}),Dn(o));const _=p(ed(u),Qr,pu({onFailure:_t,onSuccess:jt({onLeft:qn,onRight:T=>ke(Re(T),()=>_)})}),rn);return um(_,c)})),Ak=d(3,(e,t,n)=>OD(n)(Ol(e,t))),Rk=d(2,(e,t)=>{function n(r){return $(function*(){const s=yield*dm(),o=Rl(s),i=yield*ho(Ft(o,e),r),c=yield*ho(Ft(o,t.other),r);function a(l,f,h){return(m,y,b)=>{function _(T){const C=T;return C._tag===Sk?z(kt(Ce(xe(f),C.effect))):j(fT(f),Bn({onFailure:v=>kt(C.f(pn(v))),onSuccess:jt({onLeft:v=>kt(C.f(hn(v))),onRight:v=>xl(Re(v),u(b(C.f)))})}))}return Bn(l,{onFailure:T=>_(m(pn(T))),onSuccess:jt({onLeft:T=>_(m(hn(T))),onRight:T=>z(ke(Re(T),()=>ke(kt(Dn(en(h),r)),C=>u(y(C,f)))))})})}}function u(l){switch(l._tag){case _k:{const f=en(Sy(l.left)),h=en(Sy(l.right));return rn(OT(f,h,{onSelfDone:(m,y)=>Ce(xe(y),a(m,l.right,i)(t.onSelfDone,vf,b=>Oy(b))),onOtherDone:(m,y)=>Ce(xe(y),a(m,l.left,c)(t.onOtherDone,(b,_)=>vf(_,b),b=>Py(b)))}))}case wk:return rn(j(St(c),Bn({onFailure:f=>kt(l.f(pn(f))),onSuccess:jt({onLeft:f=>kt(l.f(hn(f))),onRight:f=>ke(Re(f),()=>u(Oy(l.f)))})})));case vk:return rn(j(St(i),Bn({onFailure:f=>kt(l.f(pn(f))),onSuccess:jt({onLeft:f=>kt(l.f(hn(f))),onRight:f=>ke(Re(f),()=>u(Py(l.f)))})})))}}return kt(ky(l=>{const f=ky(y=>(y.transferChildren(l.scope()),me)),h=en(i).pipe(Zs(f),Dn(r)),m=en(c).pipe(Zs(f),Dn(r));return Il(h,m,(y,b)=>vf(y,b))})).pipe(ke(u),um(s))})}return gm(n)}),Ok=d(2,(e,t)=>$l(()=>{let n;const r=Hc({onInput:o=>ke(Re(o),()=>r),onFailure:o=>(n=MD(o),_t(Kh(n))),onDone:qn}),s=Gn({onInput:o=>p(Re(o),ke(()=>s)),onFailure:o=>NM(o)&&LD(o.defect)&&oe(o.defect,n)?Or(o.defect.error):_t(o),onDone:qn});return Ft(Ft(Ft(e,r),t),s)})),xD=e=>Gh(t=>yk(e,t)),FD=e=>xD(pm(e)),Pk=e=>rn(em(t=>j(g2(),n=>rD(tm(t(m2(e,n)),r=>qh(n,pn(r))),(r,s)=>qh(n,s))))),xk=e=>ND(j(BL,t=>ke(kt(e(t)),Re))),ho=d(2,(e,t)=>Qh(Qe(()=>new ns(e,void 0,ee)),zL()).pipe(Ie(([n,r])=>p2(t,s=>{const o=n.close(s);return o!==void 0?Yh(o,r):me})),vi,j(([n])=>tt(()=>sd(n.run(),n))))),sd=(e,t)=>{const n=e;switch(n._tag){case Dc:return Bn(t.getDone(),{onFailure:fr,onSuccess:r=>z(re(r))});case Uc:return z(pe(t.getEmit()));case ii:return p(n.effect,X(()=>sd(t.run(),t)));case Kc:return fm(n,()=>sd(t.run(),t),r=>fr(r))}},rn=e=>AD(kt(e)),ND=e=>hk(Pk(e),(t,n)=>t,(t,n)=>t),gm=e=>hk(xk(e),(t,n)=>t,(t,n)=>t),Pl=e=>Fk(0,e.length,e),Fk=(e,t,n)=>e===t?Lt:p(Re(p(n,ar(e))),ke(()=>Fk(e+1,t,n))),BD=d(e=>fk(e[1]),(e,t,n)=>n?.concurrent?Rk(e,{other:t,onSelfDone:r=>rd(s=>tt(()=>Fg(r,s))),onOtherDone:r=>rd(s=>tt(()=>Fg(s,r)))}):ke(e,r=>mm(t,s=>[r,s]))),xl=d(e=>fk(e[1]),(e,t,n)=>n?.concurrent?mm(BD(e,t,{concurrent:!0}),r=>r[1]):ke(e,()=>t)),od=Symbol.for("effect/Channel/ChannelException"),MD=e=>({_tag:"ChannelException",[od]:od,error:e}),LD=e=>te(e,od),HD=Symbol.for("effect/Sink"),DD={_A:e=>e,_In:e=>e,_L:e=>e,_E:e=>e,_R:e=>e};class jc{channel;[HD]=DD;constructor(t){this.channel=t}pipe(){return G(this,arguments)}}const UD=e=>new jc($l(()=>ym(e()))),KD=new jc(pm($k())),jD=(e,t,n)=>UD(()=>new jc(Nk(e,t,n))),Nk=(e,t,n)=>t(e)?Hc({onInput:r=>{const[s,o]=Bk(e,r,t,n,0,r.length);return Kn(o)?p(Re(o),$D(s)):Nk(s,t,n)},onFailure:Or,onDone:()=>qn(e)}):qn(e),Bk=(e,t,n,r,s,o)=>{if(s===o)return[e,We()];const i=r(e,p(t,ar(s)));return n(i)?Bk(i,t,n,r,s+1,o):[i,p(t,Vi(s+1))]},zD=e=>{const t=Gn({onInput:n=>p(kt(Tn(n,r=>e(r),{discard:!0})),ke(()=>t)),onFailure:_t,onDone:()=>Lt});return new jc(t)},VD=e=>new jc(kt(e)),qD=()=>jD(K(),Ue,(e,t)=>Fe(e,{onNone:()=>U(t),onSome:()=>e})),ym=e=>oi(e)?ym(VD(e)):e.channel,WD=bD,JD=rd,Sm=hL,GD=Xp,Mk=pL,bm=Zp,_m=bL,YD=wL,QD="Left",XD="Right",ZD="Both",eU="Either",tU={_tag:QD},nU={_tag:XD},Lk={_tag:ZD},rU={_tag:eU},sU=e=>{switch(e){case"left":return tU;case"right":return nU;case"both":return Lk;case"either":return rU;default:return e}},oU=Lk,iU="effect/Take",cU=Symbol.for(iU),aU={_A:e=>e,_E:e=>e};class Fl{exit;[cU]=aU;constructor(t){this.exit=t}pipe(){return G(this,arguments)}}const Fy=e=>new Fl(hn(e)),Ny=new Fl(Pw(K())),uU=e=>new Fl(pn(p(e,Xv(U)))),lU=e=>new Fl(hn(Be(e))),fU=()=>It(K()),hU=e=>El(fr(e),U),dU="effect/Stream",Hk=Symbol.for(dU),pU={_R:e=>e,_E:e=>e,_A:e=>e};class Je{channel;[Hk]=pU;constructor(t){this.channel=t}pipe(){return G(this,arguments)}}const wm=e=>te(e,Hk)||oi(e),vm=4096,mU=e=>p(e,gU((t,n)=>oe(n)(t))),gU=d(2,(e,t)=>{const n=r=>Gn({onInput:s=>{const[o,i]=f_(s,[r,We()],([c,a],u)=>$e(c)&&t(c.value,u)?[U(u),a]:[U(u),p(a,wo(u))]);return ke(Re(i),()=>n(o))},onFailure:_t,onDone:()=>Lt});return new Je(p(He(e),Ft(n(K()))))}),yU=d(2,(e,t)=>new Je(p(He(e),xl(He(t))))),SU=new Je(Lt),id=d(2,(e,t)=>new Je(p(He(e),Ik(t)))),bU=e=>Uk(It(U(e))),_U=d(2,(e,t)=>jk(e,Mu(t))),wU=d(2,(e,t)=>jk(e,a_(t))),Nl=d(e=>wm(e[0]),(e,t,n)=>{const r=n?.bufferSize??16;return n?.switch?cd(n?.concurrency,()=>By(e,1,r,t),s=>By(e,s,r,t)):cd(n?.concurrency,()=>new Je(yu(He(e),s=>p(s,l_(o=>He(t(o))),f_(Lt,(o,i)=>p(o,xl(i)))))),s=>new Je(p(He(e),yu(Pl),Ak(o=>He(t(o)),n))))}),cd=(e,t,n)=>{switch(e){case void 0:return t();case"unbounded":return n(Number.MAX_SAFE_INTEGER);default:return e>1?n(e):t()}},By=d(4,(e,t,n,r)=>new Je(p(He(e),yu(Pl),Ak(s=>He(r(s)),{concurrency:t,mergeStrategy:TD(),bufferSize:n})))),Tm=d(e=>wm(e[0]),(e,t)=>Nl(e,ee,t)),vU=e=>{const t=Gn({onInput:n=>ke(Pl(n),()=>t),onFailure:_t,onDone:()=>Lt});return new Je(p(He(e),Ft(t)))},TU=e=>{const t=(r,s)=>{const[o,i]=p(r,sA(a=>!Qa(a))),c=p(Vd(i),Fe({onNone:()=>s,onSome:Bn({onFailure:a=>Fe(LM(a),{onNone:()=>Lt,onSome:_t}),onSuccess:()=>Lt})}));return p(Re(p(o,a_(a=>Qa(a)?U(a.value):K()))),ke(()=>c))},n=Gn({onInput:r=>t(r,n),onFailure:r=>_t(r),onDone:()=>Lt});return new Je(p(He(e),Ft(n)))},Dk=e=>vU(TU(p(e,bu(t=>t.exit)))),He=e=>{if("channel"in e)return e.channel;if(oi(e))return He(Bl(e));throw new TypeError("Expected a Stream.")},kU=e=>new Je(Lu(e)?Lt:Re(e)),Bl=e=>p(e,El(U),Uk),Uk=e=>new Je(rn(PT(e,{onFailure:Fe({onNone:()=>Lt,onSome:Or}),onSuccess:t=>Re(Be(t))}))),Kk=(e,t)=>{const n=t?.maxChunkSize??vm;if(t?.scoped){const s=j(Cy(e),o=>Su(o,{maxChunkSize:n,shutdown:!0}));return t.shutdown?j(s,id(Zh(e))):s}const r=Nl(Vk(Cy(e)),s=>Su(s,{maxChunkSize:n}));return t?.shutdown?id(r,Zh(e)):r},EU=e=>Em(()=>zd(e)?kU(e):CU(e[Symbol.iterator]())),CU=(e,t=vm)=>p(Qe(()=>{let n=[];const r=s=>p(Qe(()=>{let o=s.next();if(t===1)return o.done?Lt:p(Re(Be(o.value)),ke(()=>r(s)));n=[];let i=0;for(;o.done===!1&&(n.push(o.value),i=i+1,!(i>=t));)o=s.next();return i>0?p(Re(sn(n)),ke(()=>r(s))):Lt}),rn);return new Je(r(e))}),jU),Su=(e,t)=>p(KH(e,1,t?.maxChunkSize??vm),Mr(n=>p(UH(e),X(r=>r&&Qv(n)?fU():hU(n)))),zk,t?.shutdown?id(ac(e)):ee),IU=(...e)=>EU(e),bu=d(2,(e,t)=>new Je(p(He(e),Ol(l_(t))))),$U=d(3,(e,t,n)=>Em(()=>{const r=s=>Hc({onInput:o=>p(tt(()=>{const i=[],c=a=>Qe(()=>{i.push(a)});return p(o,OL(s,(a,u)=>p(n(a,u),X(([l,f])=>p(c(f),us(l))))),PT({onFailure:a=>i.length!==0?xl(Re(sn(i)),Or(a)):Or(a),onSuccess:a=>ke(Re(sn(i)),()=>r(a))}))}),rn),onFailure:Or,onDone:()=>Lt});return new Je(p(He(e),Ok(r(t))))})),jk=d(2,(e,t)=>new Je(p(He(e),Ol(t)))),ad=d(2,(e,t)=>{const n=r=>{const s=r.next();if(s.done)return Gn({onInput:o=>n(o[Symbol.iterator]()),onFailure:_t,onDone:lm});{const o=s.value;return rn(j(t(o),i=>ke(Re(Be(i)),()=>n(r))))}};return new Je(p(He(e),Ft($l(()=>n(We()[Symbol.iterator]())))))}),AU=d(3,(e,t,n)=>new Je(p(He(e),yu(Pl),RD(n,t),Ol(Be)))),RU=d(e=>wm(e[1]),(e,t,n)=>OU(e,t,{onSelf:ee,onOther:ee,haltStrategy:n?.haltStrategy})),OU=d(3,(e,t,n)=>{const r=n.haltStrategy?sU(n.haltStrategy):oU,s=o=>i=>o||!Qa(i)?WD(tt(()=>i)):JD(c=>tt(()=>c));return new Je(Rk(He(bu(e,n.onSelf)),{other:He(bu(t,n.onOther)),onSelfDone:s(r._tag==="Either"||r._tag==="Left"),onOtherDone:s(r._tag==="Either"||r._tag==="Right")}))}),PU=e=>xU(p(e,El(U))),zk=e=>KU(e,t=>p(j(t,n=>U([n,t])),Ve(Fe({onNone:()=>z(K()),onSome:It})))),xU=e=>zk(p(e,j(Be))),km=d(2,(e,t)=>He(e).pipe(Ok(ym(t)),FD)),FU=e=>km(e,KD),NU=d(2,(e,t)=>km(e,zD(t))),BU=e=>km(e,qD()),MU=d(2,(e,t)=>wU(LU(e,t,{onElement:U,onSchedule:K}),ee)),LU=d(3,(e,t,n)=>{const r=(s,o)=>{const i=o.next();return i.done?Gn({onInput:c=>r(s,c[Symbol.iterator]()),onFailure:_t,onDone:qn}):rn(KL(s.next(i.value),{onFailure:()=>p(s.last,jL,j(c=>p(Re(ma(n.onElement(i.value),n.onSchedule(c))),ke(()=>r(s,o)))),Cl(s.reset)),onSuccess:()=>z(p(Re(Be(n.onElement(i.value))),ke(()=>r(s,o))))}))};return new Je(p(kt(GD(t)),ke(s=>p(He(e),Ft(r(s,We()[Symbol.iterator]()))))))}),HU=d(3,(e,t,n)=>new Je(p(Re(Be(t)),ke(()=>He(p(e,$U(t,(r,s)=>p(n(r,s),j(o=>[o,o]))))))))),Vk=e=>new Je(Ik(Pk(p(e,j(Be))),me)),DU=e=>new Je(xk(t=>e(t).pipe(j(Be)))),Em=e=>new Je($l(()=>He(e()))),UU=d(2,(e,t)=>ad(e,n=>us(t(n),n))),KU=(e,t)=>Em(()=>{const n=r=>rn(j(t(r),Fe({onNone:()=>Lt,onSome:([s,o])=>ke(Re(s),()=>n(o))})));return new Je(n(e))}),jU=e=>Tm(Bl(e)),zU=e=>Tm(Vk(e)),VU=e=>Tm(DU(t=>e(t))),qU="effect/GroupBy",qk=Symbol.for(qU),WU={_R:e=>e,_E:e=>e,_K:e=>e,_V:e=>e},JU=e=>te(e,qk),GU=d(e=>JU(e[0]),(e,t,n)=>Nl(e.grouped,([r,s])=>t(r,Dk(Su(s,{shutdown:!0}))),{concurrency:"unbounded",bufferSize:n?.bufferSize??16})),YU=e=>({[qk]:WU,pipe(){return G(this,arguments)},grouped:e}),QU=d(e=>typeof e[0]!="function",(e,t,n)=>n?.key?GU(XU(e,n.key,{bufferSize:n.bufferSize}),(r,s)=>ad(s,t)):cd(n?.concurrency,()=>ad(e,t),r=>n?.unordered?Nl(e,s=>Bl(t(s)),{concurrency:r}):AU(e,r,t))),XU=d(e=>typeof e[0]!="function",(e,t,n)=>{const r=(s,o)=>Gn({onInput:i=>ke(kt(Tn(ZU(i,t),([c,a])=>{const u=s.get(c);return u===void 0?p(cm(n?.bufferSize??16),X(l=>p(Qe(()=>{s.set(c,l)}),Ce(Kt(o,lU([c,l]))),Ce(p(Kt(l,Fy(a)),mf(f=>hf(f)?U(me):K())))))):mf(Kt(u,Fy(a)),l=>hf(l)?U(me):K())},{discard:!0})),()=>r(s,o)),onFailure:i=>kt(Kt(o,uU(i))),onDone:()=>kt(p(Tn(s.entries(),([i,c])=>p(Kt(c,Ny),mf(a=>hf(a)?U(me):K())),{discard:!0}),Ce(Kt(o,Ny))))});return YU(VU(s=>$(function*(){const o=new Map,i=yield*zT();return yield*ic(s,ac(i)),yield*He(e).pipe(Ft(r(o,i)),pm,yk(s),Dn(s),us(Dk(Su(i,{shutdown:!0}))))})))}),ZU=d(2,(e,t)=>{const n=[],r=e[Symbol.iterator](),s=new Map;let o;for(;(o=r.next())&&!o.done;){const i=o.value,c=t(i);if(s.has(c))s.get(c).push(i);else{const a=[i];n.push([c,a]),s.set(c,a)}}return sn(n.map(i=>[i[0],sn(i[1])]))});class Bt{path;actual;issue;_tag="Pointer";constructor(t,n,r){this.path=t,this.actual=n,this.issue=r}}class My{actual;message;_tag="Unexpected";constructor(t,n){this.actual=t,this.message=n}}class yi{ast;message;_tag="Missing";actual=void 0;constructor(t,n){this.ast=t,this.message=n}}class rt{ast;actual;issues;output;_tag="Composite";constructor(t,n,r,s){this.ast=t,this.actual=n,this.issues=r,this.output=s}}class kf{ast;actual;kind;issue;_tag="Refinement";constructor(t,n,r,s){this.ast=t,this.actual=n,this.kind=r,this.issue=s}}class Ef{ast;actual;kind;issue;_tag="Transformation";constructor(t,n,r,s){this.ast=t,this.actual=n,this.kind=r,this.issue=s}}class nr{ast;actual;message;_tag="Type";constructor(t,n,r){this.ast=t,this.actual=n,this.message=r}}class Ly{ast;actual;message;_tag="Forbidden";constructor(t,n,r){this.ast=t,this.actual=n,this.message=r}}const Hy=Symbol.for("effect/Schema/ParseErrorTypeId");class eK extends rL("ParseError"){[Hy]=Hy;get message(){return this.toString()}toString(){return ka.formatIssueSync(this.issue)}toJSON(){return{_id:"ParseError",message:this.toString()}}[Me](){return this.toJSON()}}const tK=e=>new eK({issue:e}),Do=pe,Cm=re,Dt=VC,Cr=d(2,(e,t)=>Dt(e)?jt(e,{onLeft:re,onRight:t}):X(e,t)),Zt=d(2,(e,t)=>Dt(e)?JC(e,t):j(e,t)),Cf=d(2,(e,t)=>Dt(e)?WC(e,t):El(e,t)),nK=d(2,(e,t)=>Dt(e)?qC(e,{onLeft:t.onFailure,onRight:t.onSuccess}):FL(e,t)),Wk=d(2,(e,t)=>Dt(e)?jt(e,{onLeft:t,onRight:pe}):Ve(e,t)),Ml=(e,t)=>t===void 0||dr(t)?e:e===void 0?t:{...e,...t},rK=(e,t,n)=>{const r=vt(e,t);return(s,o)=>r(s,Ml(n,o))},Jk=(e,t,n)=>{const r=rK(e,t,n);return(s,o)=>ub(r(s,o),tK)},Gk=(e,t,n)=>{const r=vt(e,t);return(s,o)=>r(s,{...Ml(n,o),isEffectAllowed:!0})},sK=(e,t)=>Jk(e.ast,!0,t),oK=(e,t)=>Gk(e.ast,!0,t),Yk=(e,t)=>Gk(e.ast,!1,t),Qk=(e,t)=>Jk(lt(e.ast),!0,t),iK=(e,t)=>{const n=vt(lt(e.ast),!0);return(r,s)=>xn(n(r,{exact:!0,...Ml(t,s)}))},cK=be(Symbol.for("effect/ParseResult/decodeMemoMap"),()=>new WeakMap),aK=be(Symbol.for("effect/ParseResult/encodeMemoMap"),()=>new WeakMap),vt=(e,t)=>{const n=t?cK:aK,r=n.get(e);if(r)return r;const s=uK(e,t),o=qI(e),i=$e(o)?(u,l)=>s(u,Ml(l,o.value)):s,c=WI(e),a=t&&$e(c)?(u,l)=>Ii(Wk(i(u,l),c.value),e,u,l):i;return n.set(e,a),a},If=e=>Rn(jI(e)),$f=e=>Rn(zI(e)),uK=(e,t)=>{switch(e._tag){case"Refinement":if(t){const n=vt(e.from,!0);return(r,s)=>{s=s??nf;const o=s?.errors==="all",i=Cr(Wk(n(r,s),c=>{const a=new kf(e,r,"From",c);return o&&GI(e)&&t0(c)?Fe(e.filter(r,s,e),{onNone:()=>re(a),onSome:u=>re(new rt(e,r,[a,new kf(e,r,"Predicate",u)]))}):re(a)}),c=>Fe(e.filter(c,s,e),{onNone:()=>pe(c),onSome:a=>re(new kf(e,r,"Predicate",a))}));return Ii(i,e,r,s)}}else{const n=vt(lt(e),!0),r=vt(Xk(e.from),!1);return(s,o)=>Ii(Cr(n(s,o),i=>r(i,o)),e,s,o)}case"Transformation":{const n=hK(e.transformation,t),r=t?vt(e.from,!0):vt(e.to,!1),s=t?vt(e.to,!0):vt(e.from,!1);return(o,i)=>Ii(Cr(Cf(r(o,i),c=>new Ef(e,o,t?"Encoded":"Type",c)),c=>Cr(Cf(n(c,i??nf,e,o),a=>new Ef(e,o,"Transformation",a)),a=>Cf(s(a,i),u=>new Ef(e,o,t?"Type":"Encoded",u)))),e,o,i)}case"Declaration":{const n=t?e.decodeUnknown(...e.typeParameters):e.encodeUnknown(...e.typeParameters);return(r,s)=>Ii(n(r,s??nf,e),e,r,s)}case"Literal":return Xt(e,n=>n===e.literal);case"UniqueSymbol":return Xt(e,n=>n===e.symbol);case"UndefinedKeyword":return Xt(e,sC);case"NeverKeyword":return Xt(e,iC);case"UnknownKeyword":case"AnyKeyword":case"VoidKeyword":return pe;case"StringKeyword":return Xt(e,gn);case"NumberKeyword":return Xt(e,dr);case"BooleanKeyword":return Xt(e,Ki);case"BigIntKeyword":return Xt(e,ku);case"SymbolKeyword":return Xt(e,Vf);case"ObjectKeyword":return Xt(e,gr);case"Enums":return Xt(e,n=>e.enums.some(([r,s])=>s===n));case"TemplateLiteral":{const n=E$(e);return Xt(e,r=>gn(r)&&n.test(r))}case"TupleType":{const n=e.elements.map(u=>vt(u.type,t)),r=e.rest.map(u=>vt(u.type,t));let s=e.elements.filter(u=>!u.isOptional);e.rest.length>0&&(s=s.concat(e.rest.slice(1)));const o=s.length,i=e.elements.length>0?e.elements.map((u,l)=>l).join(" | "):"never",c=If(e),a=$f(e);return(u,l)=>{if(!pI(u))return re(new nr(e,u));const f=l?.errors==="all",h=[];let m=0;const y=[],b=u.length;for(let v=b;v<=o-1;v++){const k=new Bt(v,u,new yi(s[v-b]));if(f){h.push([m++,k]);continue}else return re(new rt(e,u,k,y))}if(e.rest.length===0)for(let v=e.elements.length;v<=b-1;v++){const k=new Bt(v,u,new My(u[v],`is unexpected, expected: ${i}`));if(f){h.push([m++,k]);continue}else return re(new rt(e,u,k,y))}let _=0,T;for(;_<n.length;_++)if(b<_+1){if(e.elements[_].isOptional)continue}else{const v=n[_],k=v(u[_],l);if(Dt(k)){if(Tt(k)){const R=new Bt(_,u,k.left);if(f){h.push([m++,R]);continue}else return re(new rt(e,u,R,yn(y)))}y.push([m++,k.right])}else{const R=m++,w=_;T||(T=[]),T.push(({es:I,output:O})=>X(Us(k),H=>{if(Tt(H)){const x=new Bt(w,u,H.left);return f?(I.push([R,x]),me):re(new rt(e,u,x,yn(O)))}return O.push([R,H.right]),me}))}}if(wt(r)){const[v,...k]=r;for(;_<b-k.length;_++){const R=v(u[_],l);if(Dt(R))if(Tt(R)){const w=new Bt(_,u,R.left);if(f){h.push([m++,w]);continue}else return re(new rt(e,u,w,yn(y)))}else y.push([m++,R.right]);else{const w=m++,I=_;T||(T=[]),T.push(({es:O,output:H})=>X(Us(R),x=>{if(Tt(x)){const E=new Bt(I,u,x.left);return f?(O.push([w,E]),me):re(new rt(e,u,E,yn(H)))}else return H.push([w,x.right]),me}))}}for(let R=0;R<k.length;R++)if(_+=R,!(b<_+1)){const w=k[R](u[_],l);if(Dt(w)){if(Tt(w)){const I=new Bt(_,u,w.left);if(f){h.push([m++,I]);continue}else return re(new rt(e,u,I,yn(y)))}y.push([m++,w.right])}else{const I=m++,O=_;T||(T=[]),T.push(({es:H,output:x})=>X(Us(w),E=>{if(Tt(E)){const V=new Bt(O,u,E.left);return f?(H.push([I,V]),me):re(new rt(e,u,V,yn(x)))}return x.push([I,E.right]),me}))}}}const C=({es:v,output:k})=>da(v)?re(new rt(e,u,yn(v),yn(k))):pe(yn(k));if(T&&T.length>0){const v=T;return tt(()=>{const k={es:wi(h),output:wi(y)};return X(Tn(v,R=>R(k),{concurrency:c,batching:a,discard:!0}),()=>C(k))})}return C({output:y,es:h})}}case"TypeLiteral":{if(e.propertySignatures.length===0&&e.indexSignatures.length===0)return Xt(e,cC);const n=[],r={},s=[];for(const l of e.propertySignatures)n.push([vt(l.type,t),l]),r[l.name]=null,s.push(l.name);const o=e.indexSignatures.map(l=>[vt(l.parameter,t),vt(l.type,t),l.parameter]),i=bn.make(e.indexSignatures.map(l=>l.parameter).concat(s.map(l=>Vf(l)?new ZI(l):new ja(l)))),c=vt(i,t),a=If(e),u=$f(e);return(l,f)=>{if(!uC(l))return re(new nr(e,l));const h=f?.errors==="all",m=[];let y=0;const b=f?.onExcessProperty==="error",_=f?.onExcessProperty==="preserve",T={};let C;if(b||_){C=Reflect.ownKeys(l);for(const w of C){const I=c(w,f);if(Dt(I)&&Tt(I))if(b){const O=new Bt(w,l,new My(l[w],`is unexpected, expected: ${String(i)}`));if(h){m.push([y++,O]);continue}else return re(new rt(e,l,O,T))}else T[w]=l[w]}}let v;const k=f?.exact===!0;for(let w=0;w<n.length;w++){const I=n[w][1],O=I.name,H=Object.prototype.hasOwnProperty.call(l,O);if(!H){if(I.isOptional)continue;if(k){const V=new Bt(O,l,new yi(I));if(h){m.push([y++,V]);continue}else return re(new rt(e,l,V,T))}}const x=n[w][0],E=x(l[O],f);if(Dt(E)){if(Tt(E)){const V=new Bt(O,l,H?E.left:new yi(I));if(h){m.push([y++,V]);continue}else return re(new rt(e,l,V,T))}T[O]=E.right}else{const V=y++,q=O;v||(v=[]),v.push(({es:D,output:B})=>X(Us(E),F=>{if(Tt(F)){const ce=new Bt(q,l,H?F.left:new yi(I));return h?(D.push([V,ce]),me):re(new rt(e,l,ce,B))}return B[q]=F.right,me}))}}for(let w=0;w<o.length;w++){const I=o[w],O=I[0],H=I[1],x=bb(l,I[2]);for(const E of x){const V=O(E,f);if(Dt(V)&&xn(V)){const q=H(l[E],f);if(Dt(q))if(Tt(q)){const D=new Bt(E,l,q.left);if(h){m.push([y++,D]);continue}else return re(new rt(e,l,D,T))}else Object.prototype.hasOwnProperty.call(r,E)||(T[E]=q.right);else{const D=y++,B=E;v||(v=[]),v.push(({es:F,output:ce})=>X(Us(q),je=>{if(Tt(je)){const qt=new Bt(B,l,je.left);return h?(F.push([D,qt]),me):re(new rt(e,l,qt,ce))}else return Object.prototype.hasOwnProperty.call(r,E)||(ce[E]=je.right),me}))}}}}const R=({es:w,output:I})=>{if(da(w))return re(new rt(e,l,yn(w),I));if(f?.propertyOrder==="original"){const O=C||Reflect.ownKeys(l);for(const x of s)O.indexOf(x)===-1&&O.push(x);const H={};for(const x of O)Object.prototype.hasOwnProperty.call(I,x)&&(H[x]=I[x]);return pe(H)}return pe(I)};if(v&&v.length>0){const w=v;return tt(()=>{const I={es:wi(m),output:Object.assign({},T)};return X(Tn(w,O=>O(I),{concurrency:a,batching:u,discard:!0}),()=>R(I))})}return R({es:m,output:T})}}case"Union":{const n=lK(e.types,t),r=Reflect.ownKeys(n.keys),s=r.length,o=e.types.length,i=new Map;for(let u=0;u<o;u++)i.set(e.types[u],vt(e.types[u],t));const c=If(e)??1,a=$f(e);return(u,l)=>{const f=[];let h=0,m=[];if(s>0)if(vd(u))for(let _=0;_<s;_++){const T=r[_],C=n.keys[T].buckets;if(Object.prototype.hasOwnProperty.call(u,T)){const v=String(u[T]);if(Object.prototype.hasOwnProperty.call(C,v))m=m.concat(C[v]);else{const{candidates:k,literals:R}=n.keys[T],w=bn.make(R),I=k.length===o?new Ar([new $t(T,w,!1,!0)],[]):bn.make(k);f.push([h++,new rt(I,u,new Bt(T,u,new nr(w,u[T])))])}}else{const{candidates:v,literals:k}=n.keys[T],R=new $t(T,bn.make(k),!1,!0),w=v.length===o?new Ar([R],[]):bn.make(v);f.push([h++,new rt(w,u,new Bt(T,u,new yi(R)))])}}else{const _=n.candidates.length===o?e:bn.make(n.candidates);f.push([h++,new nr(_,u)])}n.otherwise.length>0&&(m=m.concat(n.otherwise));let y;for(let _=0;_<m.length;_++){const T=m[_],C=i.get(T)(u,l);if(Dt(C)&&(!y||y.length===0)){if(xn(C))return C;f.push([h++,C.left])}else{const v=h++;y||(y=[]),y.push(k=>tt(()=>"finalResult"in k?me:X(Us(C),R=>(xn(R)?k.finalResult=R:k.es.push([v,R.left]),me))))}}const b=_=>da(_)?_.length===1&&_[0][1]._tag==="Type"?re(_[0][1]):re(new rt(e,u,yn(_))):re(new nr(e,u));if(y&&y.length>0){const _=y;return tt(()=>{const T={es:wi(f)};return X(Tn(_,C=>C(T),{concurrency:c,batching:a,discard:!0}),()=>"finalResult"in T?T.finalResult:b(T.es))})}return b(f)}}case"Suspend":{const n=_b(()=>vt(e.f(),t));return(r,s)=>n()(r,s)}}},Xt=(e,t)=>n=>t(n)?pe(n):re(new nr(e,n)),Ci=(e,t)=>{switch(e._tag){case"Declaration":{const n=Db(e);if($e(n))return Ci(n.value,t);break}case"TypeLiteral":{const n=[];for(let r=0;r<e.propertySignatures.length;r++){const s=e.propertySignatures[r],o=t?eh(s.type):lt(s.type);xi(o)&&!s.isOptional&&n.push([s.name,o])}return n}case"TupleType":{const n=[];for(let r=0;r<e.elements.length;r++){const s=e.elements[r],o=t?eh(s.type):lt(s.type);xi(o)&&!s.isOptional&&n.push([r,o])}return n}case"Refinement":return Ci(e.from,t);case"Suspend":return Ci(e.f(),t);case"Transformation":return Ci(t?e.from:e.to,t)}return[]},lK=(e,t)=>{const n={},r=[],s=[];for(let o=0;o<e.length;o++){const i=e[o],c=Ci(i,t);if(c.length>0){s.push(i);for(let a=0;a<c.length;a++){const[u,l]=c[a],f=String(l.literal);n[u]=n[u]||{buckets:{},literals:[],candidates:[]};const h=n[u].buckets;if(Object.prototype.hasOwnProperty.call(h,f)){if(a<c.length-1)continue;h[f].push(i),n[u].literals.push(l),n[u].candidates.push(i)}else{h[f]=[i],n[u].literals.push(l),n[u].candidates.push(i);break}}}else r.push(i)}return{keys:n,otherwise:r,candidates:s}},Xk=e=>oo(e)?Xk(e.from):e,Ii=(e,t,n,r)=>{if(r?.isEffectAllowed===!0||Dt(e))return e;const s=new vv,o=ts(e,{scheduler:s});s.flush();const i=o.unsafePoll();if(i){if(Qa(i))return pe(i.value);const c=i.cause;return FM(c)?re(c.error):re(new Ly(t,n,HM(c)))}return re(new Ly(t,n,"cannot be be resolved synchronously, this is caused by using runSync on an effect that performs async work"))},fK=([e],[t])=>e>t?1:e<t?-1:0;function yn(e){return e.sort(fK).map(t=>t[1])}const hK=(e,t)=>{switch(e._tag){case"FinalTransformation":return t?e.decode:e.encode;case"ComposeTransformation":return pe;case"TypeLiteralTransformation":return n=>{let r=pe(n);for(const s of e.propertySignatureTransformations){const[o,i]=t?[s.from,s.to]:[s.to,s.from],c=t?s.decode:s.encode;r=Zt(r,u=>{const l=c(Object.prototype.hasOwnProperty.call(u,o)?U(u[o]):K());return delete u[o],$e(l)&&(u[i]=l.value),u})}return r}}},Ht=(e,t=[])=>({value:e,forest:t}),ka={formatIssue:e=>Zt(Gs(e),dK),formatIssueSync:e=>{const t=ka.formatIssue(e);return Dt(t)?YC(t):VL(t)},formatError:e=>ka.formatIssue(e.issue),formatErrorSync:e=>ka.formatIssueSync(e.issue)},dK=e=>e.value+Zk(`
`,e.forest),Zk=(e,t)=>{let n="";const r=t.length;let s;for(let o=0;o<r;o++){s=t[o];const i=o===r-1;n+=e+(i?"":"")+" "+s.value,n+=Zk(e+(r>1&&!i?"  ":"   "),s.forest)}return n},pK=e=>{switch(e){case"Encoded":return"Encoded side transformation failure";case"Transformation":return"Transformation process failure";case"Type":return"Type side transformation failure"}},mK=e=>{switch(e){case"From":return"From side refinement failure";case"Predicate":return"Predicate refinement failure"}},e0=e=>"ast"in e?U(e.ast):K(),ud=pe(void 0),gK=e=>e0(e).pipe(Jo(UI),Fe({onNone:()=>ud,onSome:t=>{const n=t(e);return gn(n)?pe({message:n,override:!1}):oi(n)?j(n,r=>({message:r,override:!1})):gn(n.message)?pe({message:n.message,override:n.override}):j(n.message,r=>({message:r,override:n.override}))}})),Im=e=>t=>t._tag===e,t0=Im("Composite"),Dy=Im("Refinement"),Uy=Im("Transformation"),Mi=e=>Cr(gK(e),t=>t!==void 0?!t.override&&(t0(e)||Dy(e)&&e.kind==="From"||Uy(e)&&e.kind!=="Transformation")?Uy(e)||Dy(e)?Mi(e.issue):ud:pe(t.message):ud),n0=e=>e0(e).pipe(Jo(VI),nI(t=>t(e)),Rn);function yK(e){return Hb(e).pipe(ir(()=>Mb(e)),ir(()=>Lb(e)),ir(()=>Ou(e)),qe(()=>`{ ${e.from} | filter }`))}function SK(e){return e.message!==void 0?e.message:`Expected ${oo(e.ast)?yK(e.ast):String(e.ast)}, actual ${Dr(e.actual)}`}const bK=e=>Zt(Mi(e),t=>t??n0(e)??SK(e)),ta=e=>n0(e)??String(e.ast),_K=e=>e.message??"is forbidden",wK=e=>e.message??"is unexpected",vK=e=>{const t=KI(e.ast);if($e(t)){const n=t.value();return gn(n)?pe(n):n}return pe(e.message??"is missing")},Gs=e=>{switch(e._tag){case"Type":return Zt(bK(e),Ht);case"Forbidden":return pe(Ht(ta(e),[Ht(_K(e))]));case"Unexpected":return pe(Ht(wK(e)));case"Missing":return Zt(vK(e),Ht);case"Transformation":return Cr(Mi(e),t=>t!==void 0?pe(Ht(t)):Zt(Gs(e.issue),n=>Ht(ta(e),[Ht(pK(e.kind),[n])])));case"Refinement":return Cr(Mi(e),t=>t!==void 0?pe(Ht(t)):Zt(Gs(e.issue),n=>Ht(ta(e),[Ht(mK(e.kind),[n])])));case"Pointer":return Zt(Gs(e.issue),t=>Ht(vb(e.path),[t]));case"Composite":return Cr(Mi(e),t=>{if(t!==void 0)return pe(Ht(t));const n=ta(e);return wb(e.issues)?Zt(Tn(e.issues,Gs),r=>Ht(n,r)):Zt(Gs(e.issues),r=>Ht(n,[r]))})}},TK=d(e=>gr(e[0]),(e,...t)=>{const n={};for(const r of t)r in e&&(n[r]=e[r]);return n}),kK=d(e=>gr(e[0]),(e,...t)=>{const n={...e};for(const r of t)delete n[r];return n}),Uo=Symbol.for("effect/Schema");function ut(e){return class{[Uo]=ld;static ast=e;static annotations(n){return ut(br(this.ast,n))}static pipe(){return G(this,arguments)}static toString(){return String(e)}static Type;static Encoded;static Context;static[Uo]=ld}}const ld={_A:e=>e,_I:e=>e,_R:e=>e},Ky={typeConstructor:NI,schemaId:MI,message:Eb,missingMessage:Bd,identifier:Ru,title:Jn,description:Yo,examples:Cb,default:Ib,documentation:LI,jsonSchema:$b,arbitrary:Ab,pretty:Rb,equivalence:Ob,concurrency:Pb,batching:xb,parseIssueTitle:Fb,parseOptions:Nb,decodingFallback:Bb},zc=e=>{if(!e)return{};const t={...e};for(const n in Ky)if(n in e){const r=Ky[n];t[r]=e[n],delete t[n]}return t},br=(e,t)=>Ud(e,zc(t)),EK=e=>ut(eh(e.ast)),An=e=>ut(lt(e.ast)),mr=e=>te(e,Uo)&&gr(e[Uo]);function CK(e){return Hd(e)?bn.make(g$(e,t=>new ja(t))):new ja(e[0])}function r0(e,t=CK(e)){return class extends ut(t){static annotations(r){return r0(this.literals,br(this.ast,r))}static literals=[...e]}}function Vc(...e){return wt(e)?r0(e):c0}const IK=(e,t,n)=>$m(e,new Pu(e.map(r=>r.ast),(...r)=>t.decode(...r.map(ut)),(...r)=>t.encode(...r.map(ut)),zc(n))),$K=(e,t)=>{const n=()=>(s,o,i)=>e(s)?Do(s):Cm(new nr(i,s)),r=n;return $m([],new Pu([],n,r,zc(t)))};function $m(e,t){return class extends ut(t){static annotations(r){return $m(this.typeParameters,br(this.ast,r))}static typeParameters=[...e]}}const s0=function(){if(Array.isArray(arguments[0])){const n=arguments[0],r=arguments[1],s=arguments[2];return IK(n,r,s)}const e=arguments[0],t=arguments[1];return $K(e,t)};class o0 extends ut(Wf){}class i0 extends ut(XI){}class c0 extends ut(Md){}class Ll extends ut(Kb){}class AK extends ut(u$){}class g extends ut(Jf){}class N extends ut(Yf){}class ve extends ut(Qf){}const RK=e=>bn.make(e.map(t=>t.ast));function a0(e,t=RK(e)){return class extends ut(t){static annotations(r){return a0(this.members,br(this.ast,r))}static members=[...e]}}function De(...e){return Hd(e)?a0(e):wt(e)?e[0]:c0}const we=e=>De(e,i0),$i=e=>De(e,o0),Af=e=>De(e,i0,o0),OK=(e,t)=>new Ld(e.map(n=>mr(n)?new ks(n.ast,!1):n.ast),t.map(n=>mr(n)?new xu(n.ast):n.ast),!0);function u0(e,t,n=OK(e,t)){return class extends ut(n){static annotations(s){return u0(this.elements,this.rest,br(this.ast,s))}static elements=[...e];static rest=[...t]}}function l0(e,t){return class extends u0([],[e],t){static annotations(r){return l0(this.value,br(this.ast,r))}static value=e}}const ue=e=>l0(e),fd=e=>e?'"?:"':'":"';class uc extends ks{isReadonly;defaultValue;_tag="PropertySignatureDeclaration";constructor(t,n,r,s,o){super(t,n,s),this.isReadonly=r,this.defaultValue=o}toString(){const t=fd(this.isOptional),n=String(this.type);return`PropertySignature<${t}, ${n}, never, ${t}, ${n}>`}}class f0 extends ks{isReadonly;fromKey;constructor(t,n,r,s,o){super(t,n,s),this.isReadonly=r,this.fromKey=o}}class Hl extends ks{isReadonly;defaultValue;constructor(t,n,r,s,o){super(t,n,s),this.isReadonly=r,this.defaultValue=o}}const PK=e=>e===void 0?"never":gn(e)?JSON.stringify(e):String(e);class Dl{from;to;decode;encode;_tag="PropertySignatureTransformation";constructor(t,n,r,s){this.from=t,this.to=n,this.decode=r,this.encode=s}toString(){return`PropertySignature<${fd(this.to.isOptional)}, ${this.to.type}, ${PK(this.from.fromKey)}, ${fd(this.from.isOptional)}, ${this.from.type}>`}}const h0=(e,t)=>{switch(e._tag){case"PropertySignatureDeclaration":return new uc(e.type,e.isOptional,e.isReadonly,{...e.annotations,...t},e.defaultValue);case"PropertySignatureTransformation":return new Dl(e.from,new Hl(e.to.type,e.to.isOptional,e.to.isReadonly,{...e.to.annotations,...t},e.to.defaultValue),e.decode,e.encode)}},d0=Symbol.for("effect/PropertySignature"),Am=e=>te(e,d0);class Ul{ast;[Uo];[d0]=null;_TypeToken;_Key;_EncodedToken;_HasDefault;constructor(t){this.ast=t}pipe(){return G(this,arguments)}annotations(t){return new Ul(h0(this.ast,zc(t)))}toString(){return String(this.ast)}}const _u=e=>new Ul(e);class Kl extends Ul{from;constructor(t,n){super(t),this.from=n}annotations(t){return new Kl(h0(this.ast,zc(t)),this.from)}}const na=d(2,(e,t)=>{const n=e.ast;switch(n._tag){case"PropertySignatureDeclaration":return _u(new uc(n.type,n.isOptional,n.isReadonly,n.annotations,t));case"PropertySignatureTransformation":return _u(new Dl(n.from,new Hl(n.to.type,n.to.isOptional,n.to.isReadonly,n.to.annotations,t),n.decode,n.encode))}}),wr=(e,t,n)=>_u(new Dl(new f0(e.ast,!0,!0,{},void 0),new Hl(t.ast,!1,!0,{},void 0),r=>U(n.decode(r)),Jo(n.encode))),jy=(e,t,n)=>_u(new Dl(new f0(e.ast,!0,!0,{},void 0),new Hl(t.ast,!0,!0,{},void 0),n.decode,n.encode)),xK=(e,t)=>{const n=t?.exact,r=t?.default,s=t?.nullable,o=t?.as=="Option",i=t?.onNoneEncoding?ir(t.onNoneEncoding):ee;if(n){if(r)return s?na(wr(we(e),An(e),{decode:Fe({onNone:r,onSome:c=>c===null?r():c}),encode:U}),r).ast:na(wr(e,An(e),{decode:Fe({onNone:r,onSome:ee}),encode:U}),r).ast;if(o){const c=qy(An(e));return s?wr(we(e),c,{decode:li(Xl),encode:i}).ast:wr(e,c,{decode:ee,encode:ee}).ast}else return s?jy(we(e),An(e),{decode:li(Xl),encode:ee}).ast:new uc(e.ast,!0,!0,{},void 0)}else{if(r)return s?na(wr(Af(e),An(e),{decode:Fe({onNone:r,onSome:c=>c??r()}),encode:U}),r).ast:na(wr($i(e),An(e),{decode:Fe({onNone:r,onSome:c=>c===void 0?r():c}),encode:U}),r).ast;if(o){const c=qy(An(e));return s?wr(Af(e),c,{decode:li(a=>a!=null),encode:i}).ast:wr($i(e),c,{decode:li(oC),encode:i}).ast}else return s?jy(Af(e),$i(An(e)),{decode:li(Xl),encode:ee}).ast:new uc($i(e).ast,!0,!0,{},void 0)}},S=e=>{const t=e.ast===Wf||e.ast===Md?Wf:$i(e).ast;return new Kl(new uc(t,!0,!0,{},void 0),e)},p0=d(e=>mr(e[0]),(e,t)=>new Kl(xK(e,t),e)),FK=Yb([Bd]),NK=(e,t)=>{const n=Reflect.ownKeys(e),r=[];if(n.length>0){const o=[],i=[],c=[];for(let a=0;a<n.length;a++){const u=n[a],l=e[u];if(Am(l)){const f=l.ast;switch(f._tag){case"PropertySignatureDeclaration":{const h=f.type,m=f.isOptional,y=f.annotations;o.push(new $t(u,h,m,!0,FK(f))),i.push(new $t(u,lt(h),m,!0,y)),r.push(new $t(u,h,m,!0,y));break}case"PropertySignatureTransformation":{const h=f.from.fromKey??u;o.push(new $t(h,f.from.type,f.from.isOptional,!0,f.from.annotations)),i.push(new $t(u,f.to.type,f.to.isOptional,!0,f.to.annotations)),c.push(new w$(h,u,f.decode,f.encode));break}}}else o.push(new $t(u,l.ast,!1,!0)),i.push(new $t(u,lt(l.ast),!1,!0)),r.push(new $t(u,l.ast,!1,!0))}if(wt(c)){const a=[],u=[];for(const l of t){const{indexSignatures:f,propertySignatures:h}=lg(l.key.ast,l.value.ast);h.forEach(m=>{o.push(m),i.push(new $t(m.name,lt(m.type),m.isOptional,m.isReadonly,m.annotations))}),f.forEach(m=>{a.push(m),u.push(new Fu(m.parameter,lt(m.type),m.isReadonly))})}return new Qs(new Ar(o,a,{[so]:"Struct (Encoded side)"}),new Ar(i,u,{[so]:"Struct (Type side)"}),new Zf(c))}}const s=[];for(const o of t){const{indexSignatures:i,propertySignatures:c}=lg(o.key.ast,o.value.ast);c.forEach(a=>r.push(a)),i.forEach(a=>s.push(a))}return new Ar(r,s)},m0=(e,t)=>{const n=Reflect.ownKeys(e);for(const r of n){const s=e[r];if(t[r]===void 0&&Am(s)){const o=s.ast,i=o._tag==="PropertySignatureDeclaration"?o.defaultValue:o.to.defaultValue;i!==void 0&&(t[r]=i())}}return t};function Rm(e,t,n=NK(e,t)){return class extends ut(n){static annotations(s){return Rm(this.fields,this.records,br(this.ast,s))}static fields={...e};static records=[...t];static make=(s,o)=>{const i=m0(e,{...s});return w0(o)?i:Qk(this)(i)};static pick(...s){return A(TK(e,...s))}static omit(...s){return A(kK(e,...s))}}}function A(e,...t){return Rm(e,t)}function g0(e,t,n){return class extends Rm({},[{key:e,value:t}],n){static annotations(s){return g0(e,t,br(this.ast,s))}static key=e;static value=t}}const zy=e=>g0(e.key,e.value),Si=(e,t,n)=>{if(ag(e)&&ag(t)){const r=[...e.propertySignatures];for(const s of t.propertySignatures){const o=s.name,i=r.findIndex(c=>c.name===o);if(i===-1)r.push(s);else{const{isOptional:c,type:a}=r[i];r[i]=new $t(o,wu(a,s.type,n.concat(o)),c,!0)}}return new Ar(r,e.indexSignatures.concat(t.indexSignatures))}throw new Error(Tb(e,t,n))},BK=C$([Ru]),bi=(e,t)=>t.map(n=>new qb(n,e.filter,BK(e))),wu=(e,t,n)=>bn.make(Xn([e],[t],n)),qr=e=>Dd(e)?e.types:[e],Xn=(e,t,n)=>Da(e,r=>Da(t,s=>{switch(s._tag){case"Literal":{if(gn(s.literal)&&Gf(r)||dr(s.literal)&&og(r)||Ki(s.literal)&&ig(r))return[s];break}case"StringKeyword":{if(s===Jf){if(Gf(r)||xi(r)&&gn(r.literal))return[r];if(oo(r))return bi(r,Xn(qr(r.from),[s],n))}else if(r===Jf)return[s];break}case"NumberKeyword":{if(s===Yf){if(og(r)||xi(r)&&dr(r.literal))return[r];if(oo(r))return bi(r,Xn(qr(r.from),[s],n))}else if(r===Yf)return[s];break}case"BooleanKeyword":{if(s===Qf){if(ig(r)||xi(r)&&Ki(r.literal))return[r];if(oo(r))return bi(r,Xn(qr(r.from),[s],n))}else if(r===Qf)return[s];break}case"Union":return Xn(qr(r),s.types,n);case"Suspend":return[new za(()=>wu(r,s.f(),n))];case"Refinement":return bi(s,Xn(qr(r),qr(s.from),n));case"TypeLiteral":{switch(r._tag){case"Union":return Xn(r.types,[s],n);case"Suspend":return[new za(()=>wu(r.f(),s,n))];case"Refinement":return bi(r,Xn(qr(r.from),[s],n));case"TypeLiteral":return[Si(r,s,n)];case"Transformation":{const o=r.transformation,i=Si(r.from,s,n),c=Si(r.to,lt(s),n);switch(o._tag){case"TypeLiteralTransformation":return[new Qs(i,c,new Zf(o.propertySignatureTransformations))];case"ComposeTransformation":return[new Qs(i,c,_$)];case"FinalTransformation":return[new Qs(i,c,new Wb((a,u,l,f)=>Zt(o.decode(a,u,l,f),h=>({...a,...h})),(a,u,l,f)=>Zt(o.encode(a,u,l,f),h=>({...a,...h}))))]}}}break}case"Transformation":{if(y$(r)){if(ug(s.transformation)&&ug(r.transformation))return[new Qs(Si(r.from,s.from,n),Si(r.to,s.to,n),new Zf(s.transformation.propertySignatureTransformations.concat(r.transformation.propertySignatureTransformations)))]}else return Xn([s],[r],n);break}}throw new Error(Tb(r,s,n))})),MK=d(2,(e,t)=>ut(wu(e.ast,t.ast,[]))),LK=Symbol.for("effect/SchemaId/Refine");function y0(e,t,n){return class extends ut(n){static annotations(s){return y0(this.from,this.to,br(this.ast,s))}static from=e;static to=t}}const hd=d(e=>mr(e[0])&&mr(e[1]),(e,t,n)=>y0(e,t,new Qs(e.ast,t.ast,new Wb(n.decode,n.encode)))),HK=d(e=>mr(e[0])&&mr(e[1]),(e,t,n)=>hd(e,t,{strict:!0,decode:(r,s,o,i)=>Do(n.decode(r,i)),encode:(r,s,o,i)=>Do(n.encode(r,i))})),DK=(e,t,n,r)=>nK(e,{onFailure:s=>new rt(n,r,s),onSuccess:t}),UK=e=>e._tag==="None"?K():U(e.value),KK=(e,t)=>n=>n.oneof(t,n.record({_tag:n.constant("None")}),n.record({_tag:n.constant("Some"),value:e(n)})).map(UK),jK=e=>Fe({onNone:()=>"none()",onSome:t=>`some(${e(t)})`}),Vy=e=>(t,n,r)=>ZC(t)?Ue(t)?Do(K()):DK(e(t.value,n),U,r,t):Cm(new nr(r,t)),qy=e=>s0([e],{decode:t=>Vy(oK(t)),encode:t=>Vy(Yk(t))},{typeConstructor:{_tag:"effect/Option"},pretty:jK,arbitrary:KK,equivalence:sI}),zK=e=>mr(e)||Am(e),S0=e=>Reflect.ownKeys(e).every(t=>zK(e[t])),Om=e=>"fields"in e?e.fields:Om(e[LK]),b0=e=>S0(e)?A(e):mr(e)?e:A(Om(e)),_0=e=>S0(e)?e:Om(e),Cn=e=>(t,n)=>Ea({kind:"Class",identifier:e,schema:b0(t),fields:_0(t),Base:tL,annotations:n}),Rf=(e,t)=>{const n={...e};for(const r of Reflect.ownKeys(t)){if(r in e)throw new Error(kb(r));n[r]=t[r]}return n};function w0(e){return Ki(e)?e:e?.disableValidation??!1}const Wy=be("effect/Schema/astCache",()=>new WeakMap),VK=e=>e===void 0?[]:Array.isArray(e)?e:[e],Ea=({Base:e,annotations:t,disableToString:n,fields:r,identifier:s,kind:o,schema:i})=>{const c=Symbol.for(`effect/Schema/${o}/${s}`),[a,u,l]=VK(t),f=An(i),h=f.annotations({identifier:s,...a}),m=f.annotations({[so]:`${s} (Type side)`,...a}),y=i.annotations({[so]:`${s} (Constructor)`,...a}),b=i.annotations({[so]:`${s} (Encoded side)`,...l}),_=i.annotations({...l,...a,...u}),T=v=>te(v,c)&&iK(m)(v),C=class extends e{constructor(v={},k=!1){v={...v},v=m0(r,v),w0(k)||(v=Qk(y)(v)),super(v,!0)}static[Uo]=ld;static get ast(){let v=Wy.get(this);if(v)return v;const k=s0([i],{decode:()=>(R,w,I)=>R instanceof this||T(R)?Do(R):Cm(new nr(I,R)),encode:()=>(R,w)=>R instanceof this?Do(R):Zt(Yk(m)(R,w),I=>new this(I,!0))},{identifier:s,pretty:R=>w=>`${s}(${R(w)})`,arbitrary:R=>w=>R(w).map(I=>new this(I)),equivalence:ee,[Ka]:h.ast,...a});return v=HK(b,k,{strict:!0,decode:R=>new this(R,!0),encode:ee}).annotations({[Ka]:_.ast,...u}).ast,Wy.set(this,v),v}static pipe(){return G(this,arguments)}static annotations(v){return ut(this.ast).annotations(v)}static toString(){return`(${String(b)} <-> ${s})`}static make(...v){return new this(...v)}static fields={...r};static identifier=s;static extend(v){return(k,R)=>{const w=_0(k),I=b0(k),O=Rf(r,w);return Ea({kind:o,identifier:v,schema:MK(i,I),fields:O,Base:this,annotations:R})}}static transformOrFail(v){return(k,R,w)=>{const I=Rf(r,k);return Ea({kind:o,identifier:v,schema:hd(i,An(A(I)),R),fields:I,Base:this,annotations:w})}}static transformOrFailFrom(v){return(k,R,w)=>{const I=Rf(r,k);return Ea({kind:o,identifier:v,schema:hd(EK(i),A(I),R),fields:I,Base:this,annotations:w})}}get[c](){return c}};return n!==!0&&Object.defineProperty(C.prototype,"toString",{value(){return`${s}({ ${Reflect.ownKeys(r).map(v=>`${Cd(v)}: ${Dr(this[v])}`).join(", ")} })`},configurable:!0,writable:!0}),C},qK=mU,Jy=SU,WK=bU,Ko=_U,JK=Bl,GK=Kk,YK=bu,Gy=QU,Yy=RU,v0=PU,hr=FU,Wn=NU,QK=BU,XK=HU,T0=MU,fs=UU,Qy=Symbol.for("effect/Subscribable"),ZK=aT,ej="effect/SubscriptionRef",tj=Symbol.for(ej),nj={_A:e=>e};class rj extends si{ref;pubsub;semaphore;[Mo]=Mo;[Qy]=Qy;[rF]=Ip;[ZK]=uT;[tj]=nj;constructor(t,n,r){super(),this.ref=t,this.pubsub=n,this.semaphore=r,this.get=Ni(this.ref)}commit(){return this.get}get;get changes(){return p(Ni(this.ref),X(t=>j(Kk(this.pubsub,{scoped:!0}),n=>yU(IU(t),n))),this.semaphore.withPermits(1),zU)}modify(t){return this.modifyEffect(n=>z(t(n)))}modifyEffect(t){return p(Ni(this.ref),X(t),X(([n,r])=>p(Qw(this.ref,r),us(n),Cl(im(this.pubsub,r)))),this.semaphore.withPermits(1))}}const sj=e=>Ni(e.ref),oj=e=>p(ze([jT(),Ap(e),nm(1)]),j(([t,n,r])=>new rj(n,t,r))),ij=d(2,(e,t)=>p(Qw(e.ref,t),Cl(im(e.pubsub,t)),e.semaphore.withPermits(1))),Mt=sj,At=oj,Ot=ij,tn=Xw;function cj(){if(typeof globalThis>"u")return;const e=globalThis.localStorage;if(e)try{const t=e.getItem("__CHAIN_EFFECT_DEBUG__");if(t===null)return;const n=t.trim();return n.length===0?void 0:n==="true"||n==="1"?!0:n==="false"||n==="0"?!1:n}catch{return}}function aj(){if(typeof globalThis>"u")return;const t=globalThis.__CHAIN_EFFECT_DEBUG__;if(typeof t=="boolean")return t;if(typeof t=="string")return t.trim()===""?void 0:t}function uj(e){if(!e.startsWith("/"))return null;const t=e.lastIndexOf("/");if(t<=0)return null;const n=e.slice(1,t),r=e.slice(t+1);try{return new RegExp(n,r)}catch{return null}}function lj(e){const t=aj()??cj();if(t===!0)return!0;if(!t)return!1;const n=uj(t);return n?n.test(e):e.includes(t)}function fj(){if(typeof globalThis>"u")return null;const t=globalThis.__CHAIN_EFFECT_LOG__;return typeof t=="function"?t:null}function Mn(e){if(e instanceof Error)return e.message;if(typeof e=="string")return e;try{return JSON.stringify(e)}catch{return String(e)}}function pt(e,...t){if(!lj(e))return;const n=fj();n&&n("[chain-effect]",e,...t)}class hj{constructor(){this.keyToValue=new Map,this.valueToKey=new Map}set(t,n){this.keyToValue.set(t,n),this.valueToKey.set(n,t)}getByKey(t){return this.keyToValue.get(t)}getByValue(t){return this.valueToKey.get(t)}clear(){this.keyToValue.clear(),this.valueToKey.clear()}}class k0{constructor(t){this.generateIdentifier=t,this.kv=new hj}register(t,n){this.kv.getByValue(t)||(n||(n=this.generateIdentifier(t)),this.kv.set(n,t))}clear(){this.kv.clear()}getIdentifier(t){return this.kv.getByValue(t)}getValue(t){return this.kv.getByKey(t)}}class dj extends k0{constructor(){super(t=>t.name),this.classToAllowedProps=new Map}register(t,n){typeof n=="object"?(n.allowProps&&this.classToAllowedProps.set(t,n.allowProps),super.register(t,n.identifier)):super.register(t,n)}getAllowedProps(t){return this.classToAllowedProps.get(t)}}function pj(e){if("values"in Object)return Object.values(e);const t=[];for(const n in e)e.hasOwnProperty(n)&&t.push(e[n]);return t}function mj(e,t){const n=pj(e);if("find"in n)return n.find(t);const r=n;for(let s=0;s<r.length;s++){const o=r[s];if(t(o))return o}}function jo(e,t){Object.entries(e).forEach(([n,r])=>t(r,n))}function Ca(e,t){return e.indexOf(t)!==-1}function Xy(e,t){for(let n=0;n<e.length;n++){const r=e[n];if(t(r))return r}}class gj{constructor(){this.transfomers={}}register(t){this.transfomers[t.name]=t}findApplicable(t){return mj(this.transfomers,n=>n.isApplicable(t))}findByName(t){return this.transfomers[t]}}const yj=e=>Object.prototype.toString.call(e).slice(8,-1),E0=e=>typeof e>"u",Sj=e=>e===null,lc=e=>typeof e!="object"||e===null||e===Object.prototype?!1:Object.getPrototypeOf(e)===null?!0:Object.getPrototypeOf(e)===Object.prototype,dd=e=>lc(e)&&Object.keys(e).length===0,Lr=e=>Array.isArray(e),bj=e=>typeof e=="string",_j=e=>typeof e=="number"&&!isNaN(e),wj=e=>typeof e=="boolean",vj=e=>e instanceof RegExp,fc=e=>e instanceof Map,hc=e=>e instanceof Set,C0=e=>yj(e)==="Symbol",Tj=e=>e instanceof Date&&!isNaN(e.valueOf()),I0=e=>e instanceof Error,Zy=e=>typeof e=="number"&&isNaN(e),kj=e=>wj(e)||Sj(e)||E0(e)||_j(e)||bj(e)||C0(e),Ej=e=>typeof e=="bigint",Cj=e=>e===1/0||e===-1/0,Ij=e=>ArrayBuffer.isView(e)&&!(e instanceof DataView),$j=e=>e instanceof URL,pd=e=>e.replace(/\\/g,"\\\\").replace(/\./g,"\\."),Of=e=>e.map(String).map(pd).join("."),Li=(e,t)=>{const n=[];let r="";for(let o=0;o<e.length;o++){let i=e.charAt(o);if(!t&&i==="\\"){const u=e.charAt(o+1);if(u==="\\"){r+="\\",o++;continue}else if(u!==".")throw Error("invalid path")}if(i==="\\"&&e.charAt(o+1)==="."){r+=".",o++;continue}if(i==="."){n.push(r),r="";continue}r+=i}const s=r;return n.push(s),n};function In(e,t,n,r){return{isApplicable:e,annotation:t,transform:n,untransform:r}}const $0=[In(E0,"undefined",()=>null,()=>{}),In(Ej,"bigint",e=>e.toString(),e=>typeof BigInt<"u"?BigInt(e):(console.error("Please add a BigInt polyfill."),e)),In(Tj,"Date",e=>e.toISOString(),e=>new Date(e)),In(I0,"Error",(e,t)=>{const n={name:e.name,message:e.message};return"cause"in e&&(n.cause=e.cause),t.allowedErrorProps.forEach(r=>{n[r]=e[r]}),n},(e,t)=>{const n=new Error(e.message,{cause:e.cause});return n.name=e.name,n.stack=e.stack,t.allowedErrorProps.forEach(r=>{n[r]=e[r]}),n}),In(vj,"regexp",e=>""+e,e=>{const t=e.slice(1,e.lastIndexOf("/")),n=e.slice(e.lastIndexOf("/")+1);return new RegExp(t,n)}),In(hc,"set",e=>[...e.values()],e=>new Set(e)),In(fc,"map",e=>[...e.entries()],e=>new Map(e)),In(e=>Zy(e)||Cj(e),"number",e=>Zy(e)?"NaN":e>0?"Infinity":"-Infinity",Number),In(e=>e===0&&1/e===-1/0,"number",()=>"-0",Number),In($j,"URL",e=>e.toString(),e=>new URL(e))];function jl(e,t,n,r){return{isApplicable:e,annotation:t,transform:n,untransform:r}}const A0=jl((e,t)=>C0(e)?!!t.symbolRegistry.getIdentifier(e):!1,(e,t)=>["symbol",t.symbolRegistry.getIdentifier(e)],e=>e.description,(e,t,n)=>{const r=n.symbolRegistry.getValue(t[1]);if(!r)throw new Error("Trying to deserialize unknown symbol");return r}),Aj=[Int8Array,Uint8Array,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Float64Array,Uint8ClampedArray].reduce((e,t)=>(e[t.name]=t,e),{}),R0=jl(Ij,e=>["typed-array",e.constructor.name],e=>[...e],(e,t)=>{const n=Aj[t[1]];if(!n)throw new Error("Trying to deserialize unknown typed array");return new n(e)});function O0(e,t){return e?.constructor?!!t.classRegistry.getIdentifier(e.constructor):!1}const P0=jl(O0,(e,t)=>["class",t.classRegistry.getIdentifier(e.constructor)],(e,t)=>{const n=t.classRegistry.getAllowedProps(e.constructor);if(!n)return{...e};const r={};return n.forEach(s=>{r[s]=e[s]}),r},(e,t,n)=>{const r=n.classRegistry.getValue(t[1]);if(!r)throw new Error(`Trying to deserialize unknown class '${t[1]}' - check https://github.com/blitz-js/superjson/issues/116#issuecomment-773996564`);return Object.assign(Object.create(r.prototype),e)}),x0=jl((e,t)=>!!t.customTransformerRegistry.findApplicable(e),(e,t)=>["custom",t.customTransformerRegistry.findApplicable(e).name],(e,t)=>t.customTransformerRegistry.findApplicable(e).serialize(e),(e,t,n)=>{const r=n.customTransformerRegistry.findByName(t[1]);if(!r)throw new Error("Trying to deserialize unknown custom value");return r.deserialize(e)}),Rj=[P0,A0,x0,R0],eS=(e,t)=>{const n=Xy(Rj,s=>s.isApplicable(e,t));if(n)return{value:n.transform(e,t),type:n.annotation(e,t)};const r=Xy($0,s=>s.isApplicable(e,t));if(r)return{value:r.transform(e,t),type:r.annotation}},F0={};$0.forEach(e=>{F0[e.annotation]=e});const Oj=(e,t,n)=>{if(Lr(t))switch(t[0]){case"symbol":return A0.untransform(e,t,n);case"class":return P0.untransform(e,t,n);case"custom":return x0.untransform(e,t,n);case"typed-array":return R0.untransform(e,t,n);default:throw new Error("Unknown transformation: "+t)}else{const r=F0[t];if(!r)throw new Error("Unknown transformation: "+t);return r.untransform(e,n)}},no=(e,t)=>{if(t>e.size)throw new Error("index out of bounds");const n=e.keys();for(;t>0;)n.next(),t--;return n.next().value};function N0(e){if(Ca(e,"__proto__"))throw new Error("__proto__ is not allowed as a property");if(Ca(e,"prototype"))throw new Error("prototype is not allowed as a property");if(Ca(e,"constructor"))throw new Error("constructor is not allowed as a property")}const Pj=(e,t)=>{N0(t);for(let n=0;n<t.length;n++){const r=t[n];if(hc(e))e=no(e,+r);else if(fc(e)){const s=+r,o=+t[++n]==0?"key":"value",i=no(e,s);switch(o){case"key":e=i;break;case"value":e=e.get(i);break}}else e=e[r]}return e},md=(e,t,n)=>{if(N0(t),t.length===0)return n(e);let r=e;for(let o=0;o<t.length-1;o++){const i=t[o];if(Lr(r)){const c=+i;r=r[c]}else if(lc(r))r=r[i];else if(hc(r)){const c=+i;r=no(r,c)}else if(fc(r)){if(o===t.length-2)break;const a=+i,u=+t[++o]==0?"key":"value",l=no(r,a);switch(u){case"key":r=l;break;case"value":r=r.get(l);break}}}const s=t[t.length-1];if(Lr(r)?r[+s]=n(r[+s]):lc(r)&&(r[s]=n(r[s])),hc(r)){const o=no(r,+s),i=n(o);o!==i&&(r.delete(o),r.add(i))}if(fc(r)){const o=+t[t.length-2],i=no(r,o);switch(+s==0?"key":"value"){case"key":{const a=n(i);r.set(a,r.get(i)),a!==i&&r.delete(i);break}case"value":{r.set(i,n(r.get(i)));break}}}return e},B0=e=>e<1;function gd(e,t,n,r=[]){if(!e)return;const s=B0(n);if(!Lr(e)){jo(e,(c,a)=>gd(c,t,n,[...r,...Li(a,s)]));return}const[o,i]=e;i&&jo(i,(c,a)=>{gd(c,t,n,[...r,...Li(a,s)])}),t(o,r)}function xj(e,t,n,r){return gd(t,(s,o)=>{e=md(e,o,i=>Oj(i,s,r))},n),e}function Fj(e,t,n){const r=B0(n);function s(o,i){const c=Pj(e,Li(i,r));o.map(a=>Li(a,r)).forEach(a=>{e=md(e,a,()=>c)})}if(Lr(t)){const[o,i]=t;o.forEach(c=>{e=md(e,Li(c,r),()=>e)}),i&&jo(i,s)}else jo(t,s);return e}const Nj=(e,t)=>lc(e)||Lr(e)||fc(e)||hc(e)||I0(e)||O0(e,t);function Bj(e,t,n){const r=n.get(e);r?r.push(t):n.set(e,[t])}function Mj(e,t){const n={};let r;return e.forEach(s=>{if(s.length<=1)return;t||(s=s.map(c=>c.map(String)).sort((c,a)=>c.length-a.length));const[o,...i]=s;o.length===0?r=i.map(Of):n[Of(o)]=i.map(Of)}),r?dd(n)?[r]:[r,n]:dd(n)?void 0:n}const M0=(e,t,n,r,s=[],o=[],i=new Map)=>{const c=kj(e);if(!c){Bj(e,s,t);const m=i.get(e);if(m)return r?{transformedValue:null}:m}if(!Nj(e,n)){const m=eS(e,n),y=m?{transformedValue:m.value,annotations:[m.type]}:{transformedValue:e};return c||i.set(e,y),y}if(Ca(o,e))return{transformedValue:null};const a=eS(e,n),u=a?.value??e,l=Lr(u)?[]:{},f={};jo(u,(m,y)=>{if(y==="__proto__"||y==="constructor"||y==="prototype")throw new Error(`Detected property ${y}. This is a prototype pollution risk, please remove it from your object.`);const b=M0(m,t,n,r,[...s,y],[...o,e],i);l[y]=b.transformedValue,Lr(b.annotations)?f[pd(y)]=b.annotations:lc(b.annotations)&&jo(b.annotations,(_,T)=>{f[pd(y)+"."+T]=_})});const h=dd(f)?{transformedValue:l,annotations:a?[a.type]:void 0}:{transformedValue:l,annotations:a?[a.type,f]:f};return c||i.set(e,h),h};function L0(e){return Object.prototype.toString.call(e).slice(8,-1)}function tS(e){return L0(e)==="Array"}function Lj(e){if(L0(e)!=="Object")return!1;const t=Object.getPrototypeOf(e);return!!t&&t.constructor===Object&&t===Object.prototype}function Hj(e,t,n,r,s){const o={}.propertyIsEnumerable.call(r,t)?"enumerable":"nonenumerable";o==="enumerable"&&(e[t]=n),s&&o==="nonenumerable"&&Object.defineProperty(e,t,{value:n,enumerable:!1,writable:!0,configurable:!0})}function yd(e,t={}){if(tS(e))return e.map(s=>yd(s,t));if(!Lj(e))return e;const n=Object.getOwnPropertyNames(e),r=Object.getOwnPropertySymbols(e);return[...n,...r].reduce((s,o)=>{if(o==="__proto__"||tS(t.props)&&!t.props.includes(o))return s;const i=e[o],c=yd(i,t);return Hj(s,o,c,e,t.nonenumerable),s},{})}class Pe{constructor({dedupe:t=!1}={}){this.classRegistry=new dj,this.symbolRegistry=new k0(n=>n.description??""),this.customTransformerRegistry=new gj,this.allowedErrorProps=[],this.dedupe=t}serialize(t){const n=new Map,r=M0(t,n,this,this.dedupe),s={json:r.transformedValue};r.annotations&&(s.meta={...s.meta,values:r.annotations});const o=Mj(n,this.dedupe);return o&&(s.meta={...s.meta,referentialEqualities:o}),s.meta&&(s.meta.v=1),s}deserialize(t,n){const{json:r,meta:s}=t;let o=n?.inPlace?r:yd(r);return s?.values&&(o=xj(o,s.values,s.v??0,this)),s?.referentialEqualities&&(o=Fj(o,s.referentialEqualities,s.v??0)),o}stringify(t){return JSON.stringify(this.serialize(t))}parse(t){return this.deserialize(JSON.parse(t),{inPlace:!0})}registerClass(t,n){this.classRegistry.register(t,n)}registerSymbol(t,n){this.symbolRegistry.register(t,n)}registerCustom(t,n){this.customTransformerRegistry.register({name:n,...t})}allowErrorProps(...t){this.allowedErrorProps.push(...t)}}Pe.defaultInstance=new Pe;Pe.serialize=Pe.defaultInstance.serialize.bind(Pe.defaultInstance);Pe.deserialize=Pe.defaultInstance.deserialize.bind(Pe.defaultInstance);Pe.stringify=Pe.defaultInstance.stringify.bind(Pe.defaultInstance);Pe.parse=Pe.defaultInstance.parse.bind(Pe.defaultInstance);Pe.registerClass=Pe.defaultInstance.registerClass.bind(Pe.defaultInstance);Pe.registerSymbol=Pe.defaultInstance.registerSymbol.bind(Pe.defaultInstance);Pe.registerCustom=Pe.defaultInstance.registerCustom.bind(Pe.defaultInstance);Pe.allowErrorProps=Pe.defaultInstance.allowErrorProps.bind(Pe.defaultInstance);const H0=new Pe({dedupe:!0});class D0 extends Cn("AmountValue")({raw:g,decimals:N,symbol:g,formatted:S(g)}){}class hW extends Cn("AddressParams")({address:g}){}class dW extends Cn("TxHistoryParams")({address:g,limit:p0(N,{default:()=>20}),page:S(N)}){}class pW extends Cn("TransactionParams")({txHash:g}){}class mW extends Cn("BalanceOutput")({amount:D0,symbol:g}){}class Dj extends Cn("TokenMetadata")({possibleSpam:S(ve),securityScore:S(we(N)),verified:S(ve),totalSupply:S(g)}){}class Uj extends Cn("TokenBalance")({symbol:g,name:g,amount:D0,isNative:ve,decimals:N,icon:S(g),contractAddress:S(g),metadata:S(Dj)}){}ue(Uj);const Kj=Vc("native","token","nft"),jj=Vc("in","out","self"),zj=Vc("transfer","approve","swap","stake","unstake","claim","bridge","contract","mint","burn","gift","grab","trust","signFor","emigrate","immigrate","issueAsset","increaseAsset","destroyAsset","issueEntity","destroyEntity","locationName","dapp","certificate","mark","signature","unknown"),U0=Vc("pending","confirming","confirmed","failed");class Vj extends Cn("Asset")({assetType:Kj,value:g,symbol:g,decimals:N,contractAddress:S(g),name:S(g),logoUrl:S(g),tokenId:S(g)}){}class qj extends Cn("FeeInfo")({value:g,symbol:g,decimals:N}){}class K0 extends Cn("Transaction")({hash:g,from:g,to:g,timestamp:N,status:U0,blockNumber:S(AK),action:zj,direction:jj,assets:ue(Vj),fee:S(qj),nonce:S(N),fromEntity:S(g),toEntity:S(g),summary:S(g)}){}ue(K0);we(K0);class gW extends Cn("TransactionStatusOutput")({status:U0,confirmations:N,requiredConfirmations:N}){}const Pm="chain-effect-http-cache";function Wj(e){return typeof e=="object"&&e!==null}function Ia(e){if(typeof e=="bigint")return e.toString();if(!Wj(e))return Array.isArray(e)?e.map(Ia):e;if(Array.isArray(e))return e.map(Ia);const t={};for(const n of Object.keys(e).slice().sort())t[n]=Ia(e[n]);return t}function Jj(e){return JSON.stringify(Ia(e))}function xm(e,t){if(!t)return e;const n=btoa(Jj(t)).replace(/[+/=]/g,r=>r==="+"?"-":r==="/"?"_":"");return`${e}?__body=${n}`}function Fm(e){return new Request(e,{method:"GET"})}const Gj=(e,t,n)=>Fs({try:async()=>{const r=Pm,s=await caches.open(r),o=xm(e,t),i=Fm(o),c=await s.match(i);if(!c)return K();const a=await c.json();return U({data:a.data,timestamp:a.timestamp,fromCache:!0})},catch:()=>new Error("Cache read failed")}).pipe(Ve(()=>z(K()))),Pf=(e,t,n,r)=>Fs({try:async()=>{const s=Pm,o=await caches.open(s),i=xm(e,t),c=Fm(i),a={data:n,timestamp:Date.now()},u=new Response(JSON.stringify(a),{headers:{"Content-Type":"application/json","X-Cache-Timestamp":String(a.timestamp)}});await o.put(c,u)},catch:()=>new Error("Cache write failed")}).pipe(Ve(()=>me)),Yj=(e,t,n)=>Fs({try:async()=>{const r=Pm,s=await caches.open(r),o=xm(e,t),i=Fm(o);return s.delete(i)},catch:()=>new Error("Cache delete failed")}).pipe(Ve(()=>z(!1)));class ct{constructor(t,n,r){this.message=t,this.status=n,this.body=r}_tag="HttpError"}class nS{constructor(t,n){this.message=t,this.retryAfter=n}_tag="RateLimitError"}class Qj{constructor(t,n){this.message=t,this.errors=n}_tag="SchemaError"}class yW extends Error{_tag="NoSupportError";constructor(t="This feature is not supported by the provider"){super(t),this.name="NoSupportError"}}class SW extends Error{constructor(t="This service is limited",n){super(t),this.reason=n,this.name="ServiceLimitedError"}_tag="ServiceLimitedError"}function Xj(e,t){if(!t)return e;let n=e;for(const[r,s]of Object.entries(t))n=n.replace(`:${r}`,encodeURIComponent(String(s)));return n}function Zj(e,t){if(!t)return e;const n=new URL(e);for(const[r,s]of Object.entries(t))s!==void 0&&n.searchParams.set(r,String(s));return n.toString()}function po(e){const{url:t,method:n="GET",pathParams:r,searchParams:s,headers:o={},body:i,schema:c,timeout:a=3e4,cache:u}=e;let l=Xj(t,r);return l=Zj(l,s),Fs({try:async()=>{const f=new AbortController,h=setTimeout(()=>f.abort(),a);try{const m={method:n,headers:{"Content-Type":"application/json",...o},signal:f.signal,cache:u};n==="POST"&&i!==void 0&&(m.body=j0(i));const y=await fetch(l,m);if(clearTimeout(h),y.status===429){const _=y.headers.get("retry-after");throw new nS("Rate limit exceeded",_?parseInt(_,10):void 0)}if(!y.ok){const _=await y.text().catch(()=>"");throw new ct(`HTTP ${y.status}: ${y.statusText}`,y.status,_.slice(0,500))}const b=await y.json();return c?sK(c)(b):b}finally{clearTimeout(h)}},catch:f=>f instanceof nS||f instanceof ct||f instanceof Qj?f:f instanceof Error&&f.name==="AbortError"?new ct(`Request timeout after ${a}ms`):new ct(f instanceof Error?f.message:String(f))})}Mk(ie(1e3),2).pipe(Sm(bm(3)));_m(qd(5)).pipe(Sm(bm(3)));const xf=new Map;function ez(e){return typeof e=="object"&&e!==null}function $a(e){if(typeof e=="bigint")return e.toString();if(!ez(e))return Array.isArray(e)?e.map($a):e;if(Array.isArray(e))return e.map($a);const t={};for(const n of Object.keys(e).slice().sort())t[n]=$a(e[n]);return t}function j0(e){return JSON.stringify($a(e))}function tz(e,t){if(!t)return e;const n=btoa(j0(t)).replace(/[+/=]/g,r=>r==="+"?"-":r==="/"?"_":"");return`${e}?__body=${n}`}function Z(e){const{cacheStrategy:t="ttl",cacheTtl:n=5e3,canCache:r,...s}=e,o=tz(e.url,e.body);return W(async()=>{const i=xf.get(o);if(i)return pt("httpFetchCached pending",e.url),i;const c=async u=>{if(!r)return!0;try{return await r(u)}catch(l){return pt("httpFetchCached can-cache error",e.url,Mn(l)),!1}},a=(async()=>{const u=await Q(Gj(e.url,e.body)),l=$e(u)?u.value.data:null,f=$e(u)?await c(u.value.data):!1;if($e(u)&&!f&&await Q(Yj(e.url,e.body)),t==="cache-first"){if($e(u)&&f&&l!==null)return pt("httpFetchCached cache-first hit",e.url),l;pt("httpFetchCached cache-first miss",e.url);try{const h=await Q(po(s));return await c(h)&&await Q(Pf(e.url,e.body,h)),h}catch(h){throw pt("httpFetchCached cache-first fetch error",e.url,Mn(h)),h}}if(t==="network-first")try{pt("httpFetchCached network-first fetch",e.url);const h=await Q(po(s));return await c(h)&&await Q(Pf(e.url,e.body,h)),h}catch(h){if(pt("httpFetchCached network-first fetch error",e.url,Mn(h)),$e(u)&&f&&l!==null)return pt("httpFetchCached network-first fallback",e.url),l;throw h}if($e(u)&&f){const h=Date.now()-u.value.timestamp;if(h<n)return pt("httpFetchCached ttl hit",e.url,`age=${h}ms`,`ttl=${n}ms`),l;pt("httpFetchCached ttl expired",e.url,`age=${h}ms`,`ttl=${n}ms`)}else pt("httpFetchCached ttl miss",e.url);try{const h=await Q(po(s));return await c(h)&&await Q(Pf(e.url,e.body,h)),h}catch(h){throw pt("httpFetchCached ttl fetch error",e.url,Mn(h)),h}})();xf.set(o,a);try{return await a}finally{xf.delete(o)}})}function nz(e){return typeof e=="object"&&e!==null}function Hi(e){return Array.isArray(e)?`array(len=${e.length})`:nz(e)?"hash"in e?`object(hash=${String(e.hash)})`:"symbol"in e?`object(symbol=${String(e.symbol)})`:"object":String(e)}function Zn(e,...t){pt(e,...t)}const Te=e=>$(function*(){const{fetch:t,interval:n,events:r,walletEvents:s,immediate:o=!0}=e,i=yield*At(null),c=v0(t).pipe(T0(_m(n))),a=r?r.pipe(Gy(()=>t)):Jy,u=s?s.eventBus.forWalletEvents(s.chainId,s.address,s.types).pipe(Gy(()=>t)):Jy,h=yield*Yy(Yy(c,a),u).pipe(qK).pipe(Wn(m=>$(function*(){Zn(`${e.name} poll`,Hi(m)),yield*Ot(i,m)})),it);if(o){const m=yield*Ve(t,()=>z(null));m!==null&&(Zn(`${e.name} initial`,Hi(m)),yield*Ot(i,m))}return{ref:i,fiber:h,get:Mt(i),changes:i.changes.pipe(Ko(m=>m!==null)),refresh:$(function*(){const m=yield*t;return yield*Ot(i,m),m}),stop:xe(h).pipe(Ae)}}),Le=e=>$(function*(){const{name:t,dependsOn:n,hasChanged:r,fetch:s}=e,o=yield*At(null),i=yield*Mt(n),c=n.changes.pipe(Ko(u=>u!==null),XK({prev:i},(u,l)=>$(function*(){if(Zn(`${t} dep`,Hi(l)),r(u.prev,l)){const h=u.prev!==null;Zn(`${t} fetch`,h?"force":"cache");const m=yield*Ve(s(l,h),y=>(Zn(`${t} fetch error`,Mn(y)),z(null)));m!==null&&(Zn(`${t} set`,Hi(m)),yield*Ot(o,m))}else Zn(`${t} skip`,"unchanged");return{prev:l}})),hr),a=yield*it(c);if(i!==null){const u=yield*Ve(s(i,!1),l=>(Zn(`${t} initial fetch error`,Mn(l)),z(null)));u!==null&&(Zn(`${t} initial`,Hi(u)),yield*Ot(o,u))}return{ref:o,fiber:a,get:Mt(o),changes:o.changes.pipe(Ko(u=>u!==null)),refresh:$(function*(){const u=yield*Mt(n);if(u===null)return yield*It(new Error("Dependency not available"));const l=yield*s(u,!0);return yield*Ot(o,l),l}),stop:xe(a).pipe(Ae)}}),rz=$(function*(){const e=yield*jT(),t=GK(e);return{emit:n=>im(e,n),stream:t,forWallet:(n,r)=>t.pipe(Ko(s=>s.chainId===n&&s.address.toLowerCase()===r.toLowerCase())),forWalletEvents:(n,r,s)=>t.pipe(Ko(o=>o.chainId===n&&o.address.toLowerCase()===r.toLowerCase()&&s.includes(o.type))),shutdown:Zh(e)}}),sz=(e,t,n)=>({type:"tx:confirmed",chainId:e,address:t,txHash:n,timestamp:Date.now()}),oz="chain-effect-snapshots",iz=1,Hr="snapshots",z0=3,Nm=new Map;let ra=null;function zl(){return typeof indexedDB<"u"}function Bm(){return zl()?ra||(ra=new Promise((e,t)=>{const n=indexedDB.open(oz,iz);n.addEventListener("error",()=>t(n.error)),n.addEventListener("success",()=>e(n.result)),n.onupgradeneeded=r=>{const s=r.target.result;s.objectStoreNames.contains(Hr)||s.createObjectStore(Hr,{keyPath:"key"})}}),ra):Promise.reject(new Error("IndexedDB is not available"))}function Mm(e){const t=Nm.get(e);return t||null}function cz(e){Nm.set(e.key,e)}function Lm(e){Nm.delete(e)}async function Hm(e){if(!zl())return Mm(e);try{const t=await Bm(),n=await new Promise((s,o)=>{const a=t.transaction(Hr,"readonly").objectStore(Hr).get(e);a.addEventListener("error",()=>o(a.error)),a.addEventListener("success",()=>s(a.result??null))});if(!n)return null;if(n.serializerVersion!==z0)return await Vl(e),null;const r=H0.parse(n.payload);return{key:n.key,data:r,timestamp:n.timestamp}}catch{return null}}async function zo(e){if(cz(e),!!zl())try{const t=await Bm();await new Promise((n,r)=>{const i=t.transaction(Hr,"readwrite").objectStore(Hr).put({key:e.key,payload:H0.stringify(e.data),timestamp:e.timestamp,serializerVersion:z0});i.addEventListener("error",()=>r(i.error)),i.addEventListener("success",()=>n())})}catch{}}async function Vl(e){if(Lm(e),!!zl())try{const t=await Bm();await new Promise((n,r)=>{const i=t.transaction(Hr,"readwrite").objectStore(Hr).delete(e);i.addEventListener("error",()=>r(i.error)),i.addEventListener("success",()=>n())})}catch{}}function Sd(e){return typeof e=="object"&&e!==null}function Aa(e){if(typeof e=="bigint")return e.toString();if(!Sd(e))return Array.isArray(e)?e.map(Aa):e;if(Array.isArray(e))return e.map(Aa);const t={};for(const n of Object.keys(e).slice().sort())t[n]=Aa(e[n]);return t}function V0(e){return JSON.stringify(Aa(e))}function rS(e){if(Array.isArray(e)){const t=e[0];if(Sd(t)&&"hash"in t){const n=typeof t.hash=="string"?t.hash:String(t.hash);return`array(len=${e.length}, firstHash=${n})`}return`array(len=${e.length})`}return Sd(e)?"hash"in e?`object(hash=${typeof e.hash=="string"?e.hash:String(e.hash)})`:"symbol"in e?`object(symbol=${typeof e.symbol=="string"?e.symbol:String(e.symbol)})`:"object":String(e)}function vr(e,...t){pt(e,...t)}const az="chain-effect:snapshot";function q0(e,t){return`${az}:${e}:${t}`}function Dm(e,t){return Number.isFinite(t)?Date.now()-e>t:!1}function W0(e,t){const n=Mm(e);return n?Dm(n.timestamp,t)?(Lm(e),null):n:null}function Se(e,t){const n=new Map,r=i=>i==null?"__empty__":V0(i),s=async i=>{const c=r(i),a=n.get(c);if(a)return a.refCount++,vr(`${e} reuse source`,c,`refs=${a.refCount}`),a.source;vr(`${e} create source`,c);const u=await Q(t(i));return n.set(c,{source:u,refCount:1}),u},o=i=>{const c=r(i),a=n.get(c);a&&(a.refCount--,a.refCount<=0&&(ts(a.source.stop),n.delete(c)))};return{name:e,async fetch(i){const c=await s(i);try{const a=await Q(c.get);return a===null?Q(c.refresh):a}finally{o(i)}},subscribe(i,c,a){let u=!1,l=null;return vr(`${e} subscribe`,r(i)),s(i).then(f=>{if(u){o(i);return}let h=!0;const m=Wn(f.changes,b=>Qe(()=>{u||(vr(`${e} emit`,h?"initial":"update",rS(b)),c(b,h?"initial":"update"),h=!1)})).pipe(Mr(b=>Qe(()=>{u||(vr(`${e} changes stream failed`,Mn(b)),a?.(b))}))),y=ts(m);l=()=>{ts(xe(y)),o(i)}}).catch(f=>{vr(`${e} getOrCreateSource failed`,Mn(f)),a?.(f)}),()=>{u=!0,l?.()}},useState(i,c){const a=c?.enabled!==!1,u=c?.useSnapshot!==!1,l=c?.snapshotMaxAgeMs??Number.POSITIVE_INFINITY,f=J.useMemo(()=>r(i),[i]),h=J.useMemo(()=>q0(e,f),[f]),m=J.useMemo(()=>u?W0(h,l):null,[h,l,u]),[y,b]=J.useState(()=>a?!m:!1),[_,T]=J.useState(!1),[C,v]=J.useState(void 0),k=J.useRef(i);k.current=i;const R=J.useRef(this),w=J.useRef(m?.data),I=J.useRef(m?{key:h,timestamp:m.timestamp}:null),O=J.useRef(null),H=J.useRef(h);H.current!==h&&(H.current=h,m?(w.current=m.data,I.current={key:h,timestamp:m.timestamp}):(w.current=void 0,I.current=null)),J.useEffect(()=>{if(!a||!u)return;let D=!0;return(async()=>{const B=await Hm(h);if(!D||!B)return;if(Dm(B.timestamp,l)){await Vl(h);return}const F=I.current;F&&F.key===h&&F.timestamp>=B.timestamp||(w.current=B.data,I.current={key:h,timestamp:B.timestamp},b(!1),O.current?.())})(),()=>{D=!1}},[a,h,l,u]);const x=J.useCallback(D=>{if(O.current=D,!a)return w.current=void 0,()=>{};const B=w.current!==void 0;b(!B),T(!0),v(void 0),vr(`${e} subscribe`,f);const F=R.current.subscribe(k.current,ce=>{const je=Date.now();w.current=ce,I.current={key:h,timestamp:je},u&&zo({key:h,data:ce,timestamp:je}),b(!1),T(!1),v(void 0),vr(`${e} storeChange`,rS(ce)),D()});return()=>{O.current=null,F()}},[a,f,h,u]),E=J.useCallback(()=>w.current,[]),V=J.useSyncExternalStore(x,E,E),q=J.useCallback(async()=>{if(a){T(!0),v(void 0);try{const D=await s(k.current),B=await Q(D.refresh),F=Date.now();w.current=B,I.current={key:h,timestamp:F},u&&zo({key:h,data:B,timestamp:F})}catch(D){v(D instanceof Error?D:new Error(String(D)))}finally{T(!1),b(!1)}}},[a,h,u]);return J.useEffect(()=>{a||(w.current=void 0,b(!1),T(!1),v(void 0))},[a]),J.useEffect(()=>{!a||!u||b(!m)},[a,m,u]),{data:V,isLoading:y,isFetching:_,error:C,refetch:q}},invalidate(){for(const[i,c]of n)ts(c.source.stop);n.clear()}}}function J0(e,t,n){const r=new Map,s=3e4,o=i=>i==null?"__empty__":V0(i);return{name:e,async fetch(i){const c=o(i),a=r.get(c),u=Date.now();if(a&&u-a.timestamp<s)return a.value;const l=t(i),f=await Q(QK(l).pipe(X(h=>h._tag==="Some"?z(h.value):It(new Error("No data")))));return r.set(c,{value:f,timestamp:u}),f},subscribe(i,c){let a=!0,u=!1;const l=t(i),f=Wn(l,m=>Qe(()=>{if(u)return;const y=o(i);r.set(y,{value:m,timestamp:Date.now()}),c(m,a?"initial":"update"),a=!1})),h=ts(f);return()=>{u=!0,ts(xe(h))}},useState(i,c){const a=c?.enabled!==!1,u=c?.useSnapshot!==!1,l=c?.snapshotMaxAgeMs??Number.POSITIVE_INFINITY,f=J.useMemo(()=>o(i),[i]),h=J.useMemo(()=>q0(e,f),[f]),m=J.useMemo(()=>{const F=r.get(f);return!F||Date.now()-F.timestamp>=s?null:{key:h,data:F.value,timestamp:F.timestamp}},[f,h]),y=J.useMemo(()=>u?W0(h,l):null,[h,l,u]),b=J.useMemo(()=>u?m?y?m.timestamp>=y.timestamp?m:y:m:y:m,[m,y,u]),[_,T]=J.useState(()=>a?!b:!1),[C,v]=J.useState(!1),[k,R]=J.useState(void 0),w=J.useRef(i);w.current=i;const I=J.useRef(this),O=J.useRef(b?.data),H=J.useRef(b?{key:h,timestamp:b.timestamp}:null),x=J.useRef(null),E=J.useRef(h);E.current!==h&&(E.current=h,b?(O.current=b.data,H.current={key:h,timestamp:b.timestamp}):(O.current=void 0,H.current=null)),J.useEffect(()=>{if(!a||!u)return;let F=!0;return(async()=>{const ce=await Hm(h);if(!F||!ce)return;if(Dm(ce.timestamp,l)){await Vl(h);return}const je=H.current;je&&je.key===h&&je.timestamp>=ce.timestamp||(O.current=ce.data,H.current={key:h,timestamp:ce.timestamp},T(!1),x.current?.())})(),()=>{F=!1}},[a,h,l,u]);const V=J.useCallback(F=>{if(x.current=F,!a)return O.current=void 0,()=>{};const ce=O.current!==void 0;T(!ce),v(!0),R(void 0);const je=I.current.subscribe(w.current,qt=>{const Bs=Date.now();O.current=qt,H.current={key:h,timestamp:Bs},u&&zo({key:h,data:qt,timestamp:Bs}),T(!1),v(!1),R(void 0),F()});return()=>{x.current=null,je()}},[a,h,u]),q=J.useCallback(()=>O.current,[]),D=J.useSyncExternalStore(V,q,q),B=J.useCallback(async()=>{if(a){v(!0),R(void 0);try{r.delete(o(w.current));const F=await I.current.fetch(w.current),ce=Date.now();O.current=F,H.current={key:h,timestamp:ce},u&&zo({key:h,data:F,timestamp:ce})}catch(F){R(F instanceof Error?F:new Error(String(F)))}finally{v(!1),T(!1)}}},[a,h,u]);return J.useEffect(()=>{a||(O.current=void 0,T(!1),v(!1),R(void 0))},[a]),J.useEffect(()=>{!a||!u||T(!b)},[a,b,u]),{data:D,isLoading:_,isFetching:C,error:k,refetch:B}},invalidate(){r.clear()}}}const uz="chain-effect-poll-meta",lz=1,Vo="poll-meta";let sa=null;function G0(){return sa||(sa=new Promise((e,t)=>{const n=indexedDB.open(uz,lz);n.addEventListener("error",()=>t(n.error)),n.addEventListener("success",()=>e(n.result)),n.onupgradeneeded=r=>{const s=r.target.result;s.objectStoreNames.contains(Vo)||s.createObjectStore(Vo,{keyPath:"key"})}}),sa)}const fz=e=>Fs({try:async()=>{const t=await G0();return new Promise((n,r)=>{const i=t.transaction(Vo,"readonly").objectStore(Vo).get(e);i.addEventListener("error",()=>r(i.error)),i.addEventListener("success",()=>n(i.result??null))})},catch:t=>new Error(`Failed to get poll meta: ${t}`)}).pipe(Ve(()=>z(null))),hz=e=>Fs({try:async()=>{const t=await G0();return new Promise((n,r)=>{const i=t.transaction(Vo,"readwrite").objectStore(Vo).put(e);i.addEventListener("error",()=>r(i.error)),i.addEventListener("success",()=>n())})},catch:t=>new Error(`Failed to set poll meta: ${t}`)}).pipe(Ve(()=>me)),Ff=(e,t)=>$(function*(){const n=Date.now(),r={key:e,nextPollTime:n+t,lastSuccessTime:n,interval:t};yield*hz(r)}),dz=(e,t)=>$(function*(){const n=yield*fz(e);if(!n)return 0;const r=Date.now(),s=n.nextPollTime-r,o=t??n.interval;return s>o?0:Math.max(0,s)}),mo=new Map,Nf=new Map;function ql(e,t,n){return`${e}:${t.toLowerCase()}:${n}`}function Wl(e,t){return W(async()=>{const n=mo.get(e);if(n)if(n.pollFiber){const o=await Q($2(n.pollFiber));if(!hv(o))return n.refCount++,n.source;mo.delete(e)}else return n.refCount++,n.source;const r=Nf.get(e);if(r){const o=await r,i=mo.get(e);return i&&i.refCount++,o}const s=pz(e,t);Nf.set(e,s);try{return await s}finally{Nf.delete(e)}})}async function pz(e,t){return Q($(function*(){const n=yield*At(null),r=qi(Wt(t.interval)),s=e,o=$(function*(){const l=yield*dz(s,r);pt(`${s} poll fiber started`,`delay=${l}ms`,`interval=${r}ms`),l>0&&(yield*LL(ie(l))),yield*v0($(function*(){pt(`${s} polling`);const f=yield*Ve(t.fetch,h=>(pt(`${s} poll error`,Mn(h)),z(null)));return f!==null&&(pt(`${s} poll success`,"update ref"),yield*Ot(n,f),yield*Ff(s,r)),f})).pipe(T0(_m(t.interval)),hr)}),i=yield*it(o),c=yield*Ve(t.fetch,l=>(pt(`${e} immediate fetch error`,Mn(l)),z(null)));c!==null&&(yield*Ot(n,c),yield*Ff(s,r));const a={ref:n,fiber:i,get:Mt(n),changes:n.changes.pipe(Ko(l=>l!==null)),refresh:$(function*(){const l=yield*t.fetch;return yield*Ot(n,l),yield*Ff(s,r),l}),stop:mz(e)},u={source:a,refCount:1,pollFiber:i};return mo.set(e,u),a}))}function mz(e){return $(function*(){const t=mo.get(e);t&&(t.refCount--,t.refCount<=0&&(t.pollFiber&&(yield*xe(t.pollFiber)),mo.delete(e)))})}function gz(){if(typeof globalThis>"u")return;const e=globalThis.localStorage;if(e)try{const t=e.getItem("__CHAIN_EFFECT_DEBUG__");if(t===null)return;const n=t.trim();return n.length===0?void 0:n==="true"||n==="1"?!0:n==="false"||n==="0"?!1:n}catch{return}}function yz(){if(typeof globalThis>"u")return;const t=globalThis.__CHAIN_EFFECT_DEBUG__;if(typeof t=="boolean")return t;if(typeof t=="string")return t.trim()===""?void 0:t}function Sz(){if(typeof globalThis>"u")return;const t=globalThis.__CHAIN_EFFECT_LOG__;if(typeof t=="function")return t}function bz(e){if(!e.startsWith("/"))return null;const t=e.lastIndexOf("/");if(t<=0)return null;const n=e.slice(1,t),r=e.slice(t+1);try{return new RegExp(n,r)}catch{return null}}function Y0(e){const t=yz()??gz();if(t===!0)return!0;if(!t)return!1;const n=bz(t);return n?n.test(e):e.includes(t)}function bW(e,t){if(!Y0(e))return;const n=Sz();n&&n(e,t)}const _W=wd({chainId:go(),data:qE(),signature:go()});class de extends Error{code;details;constructor(t,n,r,s){super(n,{cause:s}),this.name="ChainServiceError",this.code=t,this.details=r}}const ge={CHAIN_NOT_SUPPORTED:"CHAIN_NOT_SUPPORTED",NOT_SUPPORTED:"NOT_SUPPORTED",NETWORK_ERROR:"NETWORK_ERROR",INSUFFICIENT_BALANCE:"INSUFFICIENT_BALANCE",INSUFFICIENT_FEE:"INSUFFICIENT_FEE",INVALID_ADDRESS:"INVALID_ADDRESS",TRANSACTION_REJECTED:"TRANSACTION_REJECTED",TRANSACTION_TIMEOUT:"TRANSACTION_TIMEOUT",TX_BUILD_FAILED:"TX_BUILD_FAILED",TX_BROADCAST_FAILED:"TX_BROADCAST_FAILED",SIGNATURE_FAILED:"SIGNATURE_FAILED",ADDRESS_FROZEN:"ADDRESS_FROZEN",PAYSECRET_REQUIRED:"PAYSECRET_REQUIRED",ADDRESS_NOT_ACTIVATED:"ADDRESS_NOT_ACTIVATED",ENERGY_INSUFFICIENT:"ENERGY_INSUFFICIENT",NONCE_TOO_LOW:"NONCE_TOO_LOW",GAS_TOO_LOW:"GAS_TOO_LOW",UTXO_INSUFFICIENT:"UTXO_INSUFFICIENT"},_z=new Set(["isValidAddress","normalizeAddress"]);function bd(e){return typeof e=="object"&&e!==null}function Ra(e){if(typeof e=="bigint")return e.toString();if(!bd(e))return Array.isArray(e)?e.map(Ra):e;if(Array.isArray(e))return e.map(Ra);const t={};for(const n of Object.keys(e).sort())t[n]=Ra(e[n]);return t}function sS(e){return JSON.stringify(Ra(e))}const wz="chain-effect:snapshot";function vz(e,t){return`${wz}:${e}:${t}`}function Q0(e,t){return Number.isFinite(t)?Date.now()-e>t:!1}function Tz(e,t){const n=Mm(e);return n?Q0(n.timestamp,t)?(Lm(e),null):n:null}function Wr(...e){const t=`[chain-provider] ${e.join(" ")}`;Y0(t)&&console.log("[chain-provider]",...e)}function oS(e){if(Array.isArray(e)){const t=e[0];return bd(t)&&"hash"in t?`array(len=${e.length}, firstHash=${String(t.hash)})`:`array(len=${e.length})`}return bd(e)?"hash"in e?`object(hash=${String(e.hash)})`:"symbol"in e?`object(symbol=${String(e.symbol)})`:"object":String(e)}function Jr(e,t){if(t.length===0)return J0(e,()=>WK({_tag:"HttpError",message:"No providers available"}));if(t.length===1)return t[0];Wr(`${e} fallback`,`sources=${t.map(o=>o.name).join(",")}`);let n=null;const r=async o=>{for(const i of t)try{const c=await i.fetch(o);return n=i,c}catch{}throw new Error("All providers failed")},s=(o,i,c)=>{let a=!1,u=null;const l=o==null?"__empty__":sS(o);Wr(`${e} subscribe`,l);const f=m=>{if(a)return;if(m>=t.length){c?.(new Error(`[${e}] all providers failed`));return}const y=t[m];Wr(`${e} probe`,y.name);let b=!1;u=y.subscribe(o,(_,T)=>{a||(b||(b=!0,n=y,Wr(`${e} resolved`,y.name)),Wr(`${e} emit`,T,oS(_)),i(_,T))},_=>{a||b||(Wr(`${e} error`,y.name,String(_)),u?.(),u=null,f(m+1))})},h=n?t.indexOf(n):-1;return f(h>=0?h:0),()=>{a=!0,u?.()}};return{name:e,fetch:r,subscribe:s,useState(o,i){const c=i?.enabled!==!1,a=i?.useSnapshot!==!1,u=i?.snapshotMaxAgeMs??Number.POSITIVE_INFINITY,l=q=>q==null?"__empty__":sS(q),f=J.useMemo(()=>l(o),[o]),h=J.useMemo(()=>vz(e,f),[f]),m=J.useMemo(()=>a?Tz(h,u):null,[h,u,a]),[y,b]=J.useState(()=>c?!m:!1),[_,T]=J.useState(!1),[C,v]=J.useState(void 0),k=J.useRef(o);k.current=o;const R=J.useRef(m?.data),w=J.useRef(m?{key:h,timestamp:m.timestamp}:null),I=J.useRef(null),O=J.useRef(h);O.current!==h&&(O.current=h,m?(R.current=m.data,w.current={key:h,timestamp:m.timestamp}):(R.current=void 0,w.current=null)),J.useEffect(()=>{if(!c||!a)return;let q=!0;return(async()=>{const D=await Hm(h);if(!q||!D)return;if(Q0(D.timestamp,u)){await Vl(h);return}const B=w.current;B&&B.key===h&&B.timestamp>=D.timestamp||(R.current=D.data,w.current={key:h,timestamp:D.timestamp},b(!1),I.current?.())})(),()=>{q=!1}},[c,h,u,a]);const H=J.useCallback(q=>{if(I.current=q,!c)return R.current=void 0,()=>{};const D=R.current!==void 0;b(!D),T(!0),v(void 0);const B=s(k.current,F=>{const ce=Date.now();R.current=F,w.current={key:h,timestamp:ce},a&&zo({key:h,data:F,timestamp:ce}),b(!1),T(!1),v(void 0),Wr(`${e} storeChange`,oS(F)),q()},F=>{v(F instanceof Error?F:new Error(String(F))),T(!1),b(!1)});return()=>{I.current=null,B()}},[c,f,h,a]),x=J.useCallback(()=>R.current,[]),E=J.useSyncExternalStore(H,x,x),V=J.useCallback(async()=>{if(c){T(!0),v(void 0);try{const q=await r(k.current),D=Date.now();R.current=q,w.current={key:h,timestamp:D},a&&zo({key:h,data:q,timestamp:D})}catch(q){v(q instanceof Error?q:new Error(String(q)))}finally{T(!1),b(!1)}}},[c,h,a]);return J.useEffect(()=>{c||(R.current=void 0,b(!1),T(!1),v(void 0))},[c]),J.useEffect(()=>{!c||!a||b(!m)},[c,m,a]),{data:E,isLoading:y,isFetching:_,error:C,refetch:V}},invalidate(){n=null;for(const o of t)o.invalidate()}}}class X0{chainId;providers;_nativeBalance;_tokenBalances;_transactionHistory;_transaction;_transactionStatus;_blockHeight;_allBalances;constructor(t,n){this.chainId=t,this.providers=n}supports(t){return t==="nativeBalance"?this.providers.some(n=>n.nativeBalance!==void 0):t==="tokenBalances"?this.providers.some(n=>n.tokenBalances!==void 0):t==="transactionHistory"?this.providers.some(n=>n.transactionHistory!==void 0):t==="blockHeight"?this.providers.some(n=>n.blockHeight!==void 0):t==="transactionStatus"?this.providers.some(n=>n.transactionStatus!==void 0):this.providers.some(n=>typeof n[t]=="function")}getMethod(t){const n=this.providers.filter(i=>typeof i[t]=="function");if(n.length===0)return;const r=n[0],s=r[t];return typeof s!="function"?void 0:_z.has(t)?s.bind(r):(async(...i)=>{let c=null,a=null;for(const u of n){const l=u[t];if(typeof l=="function")try{return await l.apply(u,i)}catch(f){if(c=f,f instanceof de&&f.code===ge.NOT_SUPPORTED)continue;a||(a=f instanceof Error?f:new Error(String(f)))}}throw a||(c instanceof Error?c:new Error("All providers failed"))})}get supportsNativeBalance(){return this.supports("nativeBalance")}get supportsTokenBalances(){return this.supports("tokenBalances")}get supportsTransactionHistory(){return this.supports("transactionHistory")}get supportsBlockHeight(){return this.supports("blockHeight")}get supportsFeeEstimate(){return this.supports("estimateFee")}get supportsBuildTransaction(){return this.supports("buildTransaction")}get supportsSignTransaction(){return this.supports("signTransaction")}get supportsBroadcast(){return this.supports("broadcastTransaction")}get supportsFullTransaction(){return this.supportsBuildTransaction&&this.supportsSignTransaction&&this.supportsBroadcast}get supportsDeriveAddress(){return this.supports("deriveAddress")}get supportsAddressValidation(){return this.supports("isValidAddress")}get nativeBalance(){if(!this._nativeBalance){const t=this.providers.map(n=>n.nativeBalance).filter(n=>n!==void 0);this._nativeBalance=Jr(`${this.chainId}.nativeBalance`,t)}return this._nativeBalance}get tokenBalances(){if(!this._tokenBalances){const t=this.providers.map(n=>n.tokenBalances).filter(n=>n!==void 0);this._tokenBalances=Jr(`${this.chainId}.tokenBalances`,t)}return this._tokenBalances}get allBalances(){if(!this._allBalances){const t=this.supportsTokenBalances,n=this.supportsNativeBalance;if(t)this._allBalances=this.tokenBalances;else if(n){const{chainId:r}=this,s=le.getSymbol(r),o=le.getDecimals(r);this._allBalances=J0(`${r}.allBalances`,i=>{const c=this.nativeBalance;return JK(Fs({try:()=>c.fetch(i),catch:a=>({_tag:"HttpError",message:String(a)})})).pipe(YK(a=>a?[{symbol:a.symbol||s,name:a.symbol||s,amount:a.amount,isNative:!0,decimals:o}]:[]))})}else this._allBalances=Jr(`${this.chainId}.allBalances`,[])}return this._allBalances}get transactionHistory(){if(!this._transactionHistory){const t=this.providers.map(n=>n.transactionHistory).filter(n=>n!==void 0);this._transactionHistory=Jr(`${this.chainId}.transactionHistory`,t)}return this._transactionHistory}get transaction(){if(!this._transaction){const t=this.providers.map(n=>n.transaction).filter(n=>n!==void 0);this._transaction=Jr(`${this.chainId}.transaction`,t)}return this._transaction}get transactionStatus(){if(!this._transactionStatus){const t=this.providers.map(n=>n.transactionStatus).filter(n=>n!==void 0);this._transactionStatus=Jr(`${this.chainId}.transactionStatus`,t)}return this._transactionStatus}get blockHeight(){if(!this._blockHeight){const t=this.providers.map(n=>n.blockHeight).filter(n=>n!==void 0);this._blockHeight=Jr(`${this.chainId}.blockHeight`,t)}return this._blockHeight}get buildTransaction(){return this.getMethod("buildTransaction")}get estimateFee(){return this.getMethod("estimateFee")}get signTransaction(){return this.getMethod("signTransaction")}get broadcastTransaction(){return this.getMethod("broadcastTransaction")}get deriveAddress(){return this.getMethod("deriveAddress")}get deriveAddresses(){return this.getMethod("deriveAddresses")}get isValidAddress(){return this.getMethod("isValidAddress")}get normalizeAddress(){return this.getMethod("normalizeAddress")}get bioGetAccountInfo(){return this.getMethod("bioGetAccountInfo")}get bioVerifyPayPassword(){return this.getMethod("bioVerifyPayPassword")}get bioGetAssetDetail(){return this.getMethod("bioGetAssetDetail")}get supportsBioAccountInfo(){return this.supports("bioGetAccountInfo")}getProviders(){return this.providers}getProviderByType(t){return this.providers.find(n=>n.type===t)}}function ci(e){return class extends e{async deriveAddress(n,r=0){const s=new TextDecoder().decode(n);return Oa(s,"ethereum",r).address}async deriveAddresses(n,r,s){const o=new TextDecoder().decode(n),i=[];for(let c=0;c<s;c++){const a=Oa(o,"ethereum",r+c);i.push(a.address)}return i}isValidAddress(n){return JE(n,"ethereum")}normalizeAddress(n){return GE(n)}async signMessage(n,r){throw new Error("Not implemented")}async verifyMessage(n,r,s){throw new Error("Not implemented")}}}const kz={ethereum:1,"ethereum-sepolia":11155111,binance:56,"bsc-testnet":97},Ez=$r(Ai(new TextEncoder().encode("transfer(address,uint256)"))).slice(0,8);function ai(e){return class extends e{#e=null;get#n(){return le.getRpcUrl(this.chainId)}get#t(){return le.getDecimals(this.chainId)}get#r(){return le.getSymbol(this.chainId)}async#o(){if(this.#e!==null)return this.#e;try{const n=await this.#s("eth_chainId"),r=parseInt(n,16);if(Number.isFinite(r))return this.#e=r,r}catch{}return this.#e=kz[this.chainId]??1,this.#e}async#s(n,r=[]){const s=await fetch(this.#n,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({jsonrpc:"2.0",id:Date.now(),method:n,params:r})});if(!s.ok)throw new de(ge.NETWORK_ERROR,`HTTP ${s.status}: ${s.statusText}`);const o=await s.json();if(o.error)throw new de(ge.NETWORK_ERROR,o.error.message,{code:o.error.code});return o.result}async buildTransaction(n){if(n.type!=="transfer")throw new de(ge.NOT_SUPPORTED,`Transaction type not supported: ${n.type}`);const r=n,s=await this.#s("eth_getTransactionCount",[r.from,"pending"]),o=parseInt(s,16),i=await this.#s("eth_gasPrice"),c=await this.#o(),a=r.tokenAddress?.toLowerCase(),u=!!a;let l=r.to,f="0x"+r.amount.raw.toString(16),h="0x",m="0x5208";return u&&a&&(h=this.#u(r.to,r.amount.raw),l=a,f="0x",m=await this.#f({from:r.from,to:l,data:h,value:f})),{chainId:this.chainId,intentType:"transfer",data:{nonce:o,gasPrice:i,gasLimit:m,to:l,value:f,data:h,chainId:c}}}async estimateFee(n){const r=await this.#s("eth_gasPrice"),i=21000n*BigInt(r),c=se.fromRaw((i*80n/100n).toString(),this.#t,this.#r),a=se.fromRaw(i.toString(),this.#t,this.#r),u=se.fromRaw((i*120n/100n).toString(),this.#t,this.#r);return{slow:{amount:c,estimatedTime:60},standard:{amount:a,estimatedTime:15},fast:{amount:u,estimatedTime:5}}}async signTransaction(n,r){if(!r.privateKey)throw new de(ge.SIGNATURE_FAILED,"privateKey is required for EVM signing");const s=n.data,o=await this.#l(s.chainId),i=this.#c([this.#i(s.nonce),s.gasPrice,s.gasLimit,s.to.toLowerCase(),s.value,s.data,this.#i(o),"0x","0x"]),c=Ai(Ir(i.slice(2))),a=yo.sign(c,r.privateKey,{prehash:!1,format:"recovered"}),u=a[0],l=BigInt("0x"+$r(a.slice(1,33))),f=BigInt("0x"+$r(a.slice(33,65))),h=o*2+35+u,m=l.toString(16).padStart(64,"0"),y=f.toString(16).padStart(64,"0"),b=this.#c([this.#i(s.nonce),s.gasPrice,s.gasLimit,s.to.toLowerCase(),s.value,s.data,this.#i(h),"0x"+m,"0x"+y]);return{chainId:this.chainId,data:b,signature:"0x"+m+y}}async broadcastTransaction(n){const r=n.data;return await this.#s("eth_sendRawTransaction",[r])}#i(n){return n===0?"0x":"0x"+n.toString(16)}#c(n){const r=n.map(a=>{if(a==="0x"||a==="")return new Uint8Array([128]);let u=a.startsWith("0x")?a.slice(2):a;u.length%2===1&&(u="0"+u);const l=Ir(u);if(l.length===1&&l[0]<128)return l;if(l.length<=55)return new Uint8Array([128+l.length,...l]);const f=this.#a(l.length);return new Uint8Array([183+f.length,...f,...l])}),s=r.reduce((a,u)=>a+u.length,0);let o;if(s<=55)o=new Uint8Array([192+s]);else{const a=this.#a(s);o=new Uint8Array([247+a.length,...a])}const i=new Uint8Array(o.length+s);i.set(o);let c=o.length;for(const a of r)i.set(a,c),c+=a.length;return"0x"+$r(i)}#u(n,r){const s=n.toLowerCase().replace(/^0x/,"").padStart(64,"0"),o=r.toString(16).padStart(64,"0");return`0x${Ez}${s}${o}`}async#l(n){if(typeof n=="number"&&Number.isFinite(n))return n;if(typeof n=="string"){const r=n.trim();if(r){const s=r.startsWith("0x")?parseInt(r,16):parseInt(r,10);if(Number.isFinite(s))return s}}return this.#o()}async#f(n){try{return await this.#s("eth_estimateGas",[n])}catch{return"0x186a0"}}#a(n){const r=n.toString(16),s=r.length%2?"0"+r:r;return Ir(s)}}}const Bf=new Map;function Cz(e,t){if(!e||e.trim()==="")return;if(Bf.has(t))return Bf.get(t);const n=e.split(",").map(s=>s.trim()).filter(s=>s.length>0);if(n.length===0)return;const r=n[Math.floor(Math.random()*n.length)];return Bf.set(t,r),r}function Jl(e,t){if(!e)return;const n=globalThis.__API_KEYS__;return Cz(n?.[e],t)}let Mf=null;const En=()=>Mf?z(Mf):rz.pipe(Ie(e=>Qe(()=>{Mf=e}))),iS=A({status:g,message:g,result:Ll}),Iz=A({hash:g,from:g,to:g,value:g,timeStamp:g,isError:g,blockNumber:g,input:S(g),methodId:S(g),functionName:S(g)});function $z(e,t,n){const r=e.toLowerCase(),s=t.toLowerCase();return r===n&&s===n?"self":r===n?"out":"in"}function Az(e){try{const{Schema:t}=require("effect");return t.decodeUnknownSync(Iz)(e)}catch{return null}}function Rz(e,t){return!e||e.length!==t.length?!0:e.length===0&&t.length===0?!1:e[0]?.hash!==t[0]?.hash}class Oz{chainId;type;endpoint;config;constructor(t,n){this.type=t.type,this.endpoint=t.endpoint,this.config=t.config,this.chainId=n}}class Z0 extends ci(ai(Oz)){symbol;decimals;baseUrl;apiKey;pollingInterval=3e4;_eventBus=null;_txHistorySources=new Map;_txHistoryCreations=new Map;_balanceSources=new Map;_balanceCreations=new Map;nativeBalance;transactionHistory;constructor(t,n){super(t,n),this.symbol=le.getSymbol(n),this.decimals=le.getDecimals(n),this.baseUrl=this.endpoint,this.apiKey=Jl(this.config?.apiKeyEnv,`etherscan-${n}`);const r=this;this.transactionHistory=Se(`etherscan.${n}.transactionHistory`,s=>r.createTransactionHistorySource(s)),this.nativeBalance=Se(`etherscan.${n}.nativeBalance`,s=>r.createBalanceSource(s))}buildUrl(t){const n=new URL(this.baseUrl);for(const[r,s]of Object.entries(t))n.searchParams.set(r,s);return this.apiKey&&n.searchParams.set("apikey",this.apiKey),n.toString()}createTransactionHistorySource(t){return this.getSharedTxHistorySource(t.address)}createBalanceSource(t){return this.getSharedBalanceSource(t.address)}getSharedTxHistorySource(t){const n=this,r=t.toLowerCase(),s=r,o=this.symbol,i=this.decimals,c=l=>({...l,stop:n.releaseSharedTxHistorySource(s)}),a=n._txHistorySources.get(s);if(a)return a.refCount+=1,z(c(a.source));const u=n._txHistoryCreations.get(s);return W(u?async()=>{const l=await u,f=n._txHistorySources.get(s);return f&&(f.refCount+=1),c(l)}:async()=>{const l=Q($(function*(){n._eventBus||(n._eventBus=yield*En());const f=n._eventBus,h=n.fetchTransactionHistory({address:t,limit:50},!0).pipe(j(b=>{if(b.status==="0"||!Array.isArray(b.result))throw new ct("API rate limited",429);return b.result.map(Az).filter(_=>_!==null).map(_=>({hash:_.hash,from:_.from,to:_.to,timestamp:parseInt(_.timeStamp,10)*1e3,status:_.isError==="0"?"confirmed":"failed",blockNumber:BigInt(_.blockNumber),action:"transfer",direction:$z(_.from,_.to,r),assets:[{assetType:"native",value:_.value,symbol:o,decimals:i}]}))})),m=yield*Te({name:`etherscan.${n.chainId}.txHistory.${s}`,fetch:h,interval:ie(n.pollingInterval),walletEvents:{eventBus:f,chainId:n.chainId,address:t,types:["tx:confirmed","tx:sent"]}}),y=m.stop;return n._txHistorySources.set(s,{source:m,refCount:1,stopAll:y}),m}));n._txHistoryCreations.set(s,l);try{const f=await l;return c(f)}finally{n._txHistoryCreations.delete(s)}})}releaseSharedTxHistorySource(t){const n=this;return $(function*(){const r=n._txHistorySources.get(t);r&&(r.refCount-=1,r.refCount<=0&&(yield*r.stopAll,n._txHistorySources.delete(t)))})}getSharedBalanceSource(t){const n=this,r=t.toLowerCase(),s=this.symbol,o=this.decimals,i=u=>({...u,stop:n.releaseSharedBalanceSource(r)}),c=n._balanceSources.get(r);if(c)return c.refCount+=1,z(i(c.source));const a=n._balanceCreations.get(r);return W(a?async()=>{const u=await a,l=n._balanceSources.get(r);return l&&(l.refCount+=1),i(u)}:async()=>{const u=Q($(function*(){const l=yield*n.getSharedTxHistorySource(t),f=yield*Le({name:`etherscan.${n.chainId}.balance`,dependsOn:l.ref,hasChanged:Rz,fetch:(m,y)=>n.fetchBalance(t,y).pipe(j(b=>{if(b.status==="0"||typeof b.result!="string")throw new ct("API rate limited",429);return{amount:se.fromRaw(b.result,o,s),symbol:s}}))}),h=ze([f.stop,l.stop]).pipe(Ae);return n._balanceSources.set(r,{source:f,refCount:1,stopAll:h}),f}));n._balanceCreations.set(r,u);try{const l=await u;return i(l)}finally{n._balanceCreations.delete(r)}})}releaseSharedBalanceSource(t){const n=this;return $(function*(){const r=n._balanceSources.get(t);r&&(r.refCount-=1,r.refCount<=0&&(yield*r.stopAll,n._balanceSources.delete(t)))})}fetchBalance(t,n=!1){return Z({url:this.buildUrl({module:"account",action:"balance",address:t,tag:"latest"}),schema:iS,cacheStrategy:n?"network-first":"cache-first"})}fetchTransactionHistory(t,n=!1){return Z({url:this.buildUrl({module:"account",action:"txlist",address:t.address,page:"1",offset:String(t.limit??20),sort:"desc"}),schema:iS,cacheStrategy:n?"network-first":"cache-first"})}}function eE(e,t){return e.type==="etherscan-v1"||e.type.includes("blockscout")?new Z0(e,t):null}const cS=A({status:g,message:g,result:Ll}),Pz=A({hash:g,from:g,to:g,value:g,timeStamp:g,isError:g,blockNumber:g,input:S(g),methodId:S(g),functionName:S(g)});function xz(e,t,n){const r=e.toLowerCase(),s=t.toLowerCase();return r===n&&s===n?"self":r===n?"out":"in"}function Fz(e){try{const{Schema:t}=require("effect");return t.decodeUnknownSync(Pz)(e)}catch{return null}}function Nz(e,t){return!e||e.length!==t.length?!0:e.length===0&&t.length===0?!1:e[0]?.hash!==t[0]?.hash}class Bz{chainId;type;endpoint;config;constructor(t,n){this.type=t.type,this.endpoint=t.endpoint,this.config=t.config,this.chainId=n}}class tE extends ci(ai(Bz)){symbol;decimals;baseUrl;apiKey;evmChainId;pollingInterval=3e4;_eventBus=null;_txHistorySources=new Map;_txHistoryCreations=new Map;_balanceSources=new Map;_balanceCreations=new Map;nativeBalance;transactionHistory;constructor(t,n){super(t,n),this.symbol=le.getSymbol(n),this.decimals=le.getDecimals(n),this.baseUrl=this.endpoint,this.apiKey=Jl(this.config?.apiKeyEnv,`etherscan-${n}`);const r=this.config?.evmChainId;if(!r)throw new Error(`[EtherscanV2Provider] evmChainId is required for chain ${n}`);this.evmChainId=r;const s=this;this.transactionHistory=Se(`etherscan-v2.${n}.transactionHistory`,o=>s.createTransactionHistorySource(o)),this.nativeBalance=Se(`etherscan-v2.${n}.nativeBalance`,o=>s.createBalanceSource(o))}buildUrl(t){const n=new URL(this.baseUrl);n.searchParams.set("chainid",this.evmChainId.toString());for(const[r,s]of Object.entries(t))n.searchParams.set(r,s);return this.apiKey&&n.searchParams.set("apikey",this.apiKey),n.toString()}createTransactionHistorySource(t){return this.getSharedTxHistorySource(t.address)}createBalanceSource(t){return this.getSharedBalanceSource(t.address)}getSharedTxHistorySource(t){const n=this,r=t.toLowerCase(),s=r,o=this.symbol,i=this.decimals,c=l=>({...l,stop:n.releaseSharedTxHistorySource(s)}),a=n._txHistorySources.get(s);if(a)return a.refCount+=1,z(c(a.source));const u=n._txHistoryCreations.get(s);return W(u?async()=>{const l=await u,f=n._txHistorySources.get(s);return f&&(f.refCount+=1),c(l)}:async()=>{const l=Q($(function*(){n._eventBus||(n._eventBus=yield*En());const f=n._eventBus,h=n.fetchTransactionHistory({address:t,limit:50},!0).pipe(j(b=>{if(b.status==="0"||!Array.isArray(b.result))throw new ct("API rate limited",429);return b.result.map(Fz).filter(_=>_!==null).map(_=>({hash:_.hash,from:_.from,to:_.to,timestamp:parseInt(_.timeStamp,10)*1e3,status:_.isError==="0"?"confirmed":"failed",blockNumber:BigInt(_.blockNumber),action:"transfer",direction:xz(_.from,_.to,r),assets:[{assetType:"native",value:_.value,symbol:o,decimals:i}]}))})),m=yield*Te({name:`etherscan-v2.${n.chainId}.txHistory.${s}`,fetch:h,interval:ie(n.pollingInterval),walletEvents:{eventBus:f,chainId:n.chainId,address:t,types:["tx:confirmed","tx:sent"]}}),y=m.stop;return n._txHistorySources.set(s,{source:m,refCount:1,stopAll:y}),m}));n._txHistoryCreations.set(s,l);try{const f=await l;return c(f)}finally{n._txHistoryCreations.delete(s)}})}releaseSharedTxHistorySource(t){const n=this;return $(function*(){const r=n._txHistorySources.get(t);r&&(r.refCount-=1,r.refCount<=0&&(yield*r.stopAll,n._txHistorySources.delete(t)))})}getSharedBalanceSource(t){const n=this,r=t.toLowerCase(),s=this.symbol,o=this.decimals,i=u=>({...u,stop:n.releaseSharedBalanceSource(r)}),c=n._balanceSources.get(r);if(c)return c.refCount+=1,z(i(c.source));const a=n._balanceCreations.get(r);return W(a?async()=>{const u=await a,l=n._balanceSources.get(r);return l&&(l.refCount+=1),i(u)}:async()=>{const u=Q($(function*(){const l=yield*n.getSharedTxHistorySource(t),f=yield*Le({name:`etherscan-v2.${n.chainId}.balance`,dependsOn:l.ref,hasChanged:Nz,fetch:(m,y)=>n.fetchBalance(t,y).pipe(j(b=>{if(b.status==="0"||typeof b.result!="string")throw new ct("API rate limited",429);const _=b.result.startsWith("0x")?BigInt(b.result).toString():b.result;return{amount:se.fromRaw(_,o,s),symbol:s}}))}),h=ze([f.stop,l.stop]).pipe(Ae);return n._balanceSources.set(r,{source:f,refCount:1,stopAll:h}),f}));n._balanceCreations.set(r,u);try{const l=await u;return i(l)}finally{n._balanceCreations.delete(r)}})}releaseSharedBalanceSource(t){const n=this;return $(function*(){const r=n._balanceSources.get(t);r&&(r.refCount-=1,r.refCount<=0&&(yield*r.stopAll,n._balanceSources.delete(t)))})}fetchBalance(t,n=!1){return Z({url:this.buildUrl({module:"account",action:"balance",address:t,tag:"latest"}),schema:cS,cacheStrategy:n?"network-first":"cache-first"})}fetchTransactionHistory(t,n=!1){return Z({url:this.buildUrl({module:"account",action:"txlist",address:t.address,page:"1",offset:String(t.limit??20),sort:"desc"}),schema:cS,cacheStrategy:n?"network-first":"cache-first"})}}function nE(e,t){return e.type==="etherscan-v2"?new tE(e,t):null}const aS=A({jsonrpc:g,id:N,result:g}),Mz=A({hash:g,from:g,to:we(g),value:g,blockNumber:we(g),input:g}),Lz=A({jsonrpc:g,id:N,result:we(Mz)}),Hz=A({status:g,blockNumber:g,transactionHash:g}),Dz=A({jsonrpc:g,id:N,result:we(Hz)});function uS(e,t){return e===null?!0:e!==t}class Uz{chainId;type;endpoint;config;constructor(t,n){this.type=t.type,this.endpoint=t.endpoint,this.config=t.config,this.chainId=n}}class rE extends ci(ai(Uz)){symbol;decimals;pollingInterval=3e4;_balanceSources=new Map;_balanceCreations=new Map;_transactionSources=new Map;_transactionCreations=new Map;nativeBalance;blockHeight;transaction;constructor(t,n){super(t,n),this.symbol=le.getSymbol(n),this.decimals=le.getDecimals(n);const r=this;this.blockHeight=Se(`evm-rpc.${n}.blockHeight`,()=>r.createBlockHeightSource()),this.nativeBalance=Se(`evm-rpc.${n}.nativeBalance`,s=>r.createBalanceSource(s)),this.transaction=Se(`evm-rpc.${n}.transaction`,s=>r.createTransactionSource(s))}createBlockHeightSource(){return this.getSharedBlockHeightSource()}getSharedBlockHeightSource(){const t=this,n=ql(this.chainId,"global","blockHeight"),r=t.fetchBlockNumber(!0).pipe(j(s=>BigInt(s.result)));return Wl(n,{fetch:r,interval:ie(t.pollingInterval)})}createBalanceSource(t){return this.getSharedBalanceSource(t.address)}createTransactionSource(t){return this.getSharedTransactionSource(t)}getSharedBalanceSource(t){const n=this,r=t.toLowerCase(),s=this.symbol,o=this.decimals,i=u=>({...u,stop:n.releaseSharedBalanceSource(r)}),c=n._balanceSources.get(r);if(c)return c.refCount+=1,z(i(c.source));const a=n._balanceCreations.get(r);return W(a?async()=>{const u=await a,l=n._balanceSources.get(r);return l&&(l.refCount+=1),i(u)}:async()=>{const u=Q($(function*(){const l=yield*n.getSharedBlockHeightSource(),f=yield*Le({name:`evm-rpc.${n.chainId}.balance`,dependsOn:l.ref,hasChanged:uS,fetch:(m,y)=>n.fetchBalance(t,y).pipe(j(b=>{const _=BigInt(b.result).toString();return{amount:se.fromRaw(_,o,s),symbol:s}}))}),h=ze([f.stop,l.stop]).pipe(Ae);return n._balanceSources.set(r,{source:f,refCount:1,stopAll:h}),f}));n._balanceCreations.set(r,u);try{const l=await u;return i(l)}finally{n._balanceCreations.delete(r)}})}releaseSharedBalanceSource(t){const n=this;return $(function*(){const r=n._balanceSources.get(t);r&&(r.refCount-=1,r.refCount<=0&&(yield*r.stopAll,n._balanceSources.delete(t)))})}getSharedTransactionSource(t){const n=this,r=t.txHash,s=this.symbol,o=this.decimals,i=u=>({...u,stop:n.releaseSharedTransactionSource(r)}),c=n._transactionSources.get(r);if(c)return c.refCount+=1,z(i(c.source));const a=n._transactionCreations.get(r);return W(a?async()=>{const u=await a,l=n._transactionSources.get(r);return l&&(l.refCount+=1),i(u)}:async()=>{const u=Q($(function*(){const l=yield*n.getSharedBlockHeightSource(),f=$(function*(){const[y,b]=yield*ze([n.fetchTransaction(t.txHash,!0),n.fetchTransactionReceipt(t.txHash,!0)]),_=y.result,T=b.result;if(!_)return null;let C;T?C=T.status==="0x1"?"confirmed":"failed":C="pending";const v=BigInt(_.value||"0x0").toString(),k=T?.blockNumber?BigInt(T.blockNumber):void 0,R={hash:_.hash,from:_.from,to:_.to??"",timestamp:Date.now(),status:C,action:_.to?"transfer":"contract",direction:"out",assets:[{assetType:"native",value:v,symbol:s,decimals:o}]};return k===void 0?R:{...R,blockNumber:k}}),h=yield*Le({name:`evm-rpc.${n.chainId}.transaction`,dependsOn:l.ref,hasChanged:uS,fetch:()=>f}),m=ze([h.stop,l.stop]).pipe(Ae);return n._transactionSources.set(r,{source:h,refCount:1,stopAll:m}),h}));n._transactionCreations.set(r,u);try{const l=await u;return i(l)}finally{n._transactionCreations.delete(r)}})}releaseSharedTransactionSource(t){const n=this;return $(function*(){const r=n._transactionSources.get(t);r&&(r.refCount-=1,r.refCount<=0&&(yield*r.stopAll,n._transactionSources.delete(t)))})}fetchBlockNumber(t=!1){return Z({url:this.endpoint,method:"POST",body:{jsonrpc:"2.0",id:1,method:"eth_blockNumber",params:[]},schema:aS,cacheStrategy:t?"network-first":"cache-first"})}fetchBalance(t,n=!1){return Z({url:this.endpoint,method:"POST",body:{jsonrpc:"2.0",id:1,method:"eth_getBalance",params:[t,"latest"]},schema:aS,cacheStrategy:n?"network-first":"cache-first"})}fetchTransaction(t,n=!1){return Z({url:this.endpoint,method:"POST",body:{jsonrpc:"2.0",id:1,method:"eth_getTransactionByHash",params:[t]},schema:Lz,cacheStrategy:n?"network-first":"cache-first"})}fetchTransactionReceipt(t,n=!1){return Z({url:this.endpoint,method:"POST",body:{jsonrpc:"2.0",id:1,method:"eth_getTransactionReceipt",params:[t]},schema:Dz,cacheStrategy:n?"network-first":"cache-first"})}}function sE(e,t){return e.type.endsWith("-rpc")&&(e.type.includes("ethereum")||e.type.includes("bsc"))?new rE(e,t):null}A({success:ve,result:A({height:N,timestamp:N,signature:S(g)})});A({success:ve,result:S(A({assets:S(ue(A({symbol:g,balance:g})))}))});A({success:ve,result:S(A({trs:S(ue(A({height:N,signature:g,tIndex:N,transaction:A({signature:g,senderId:g,recipientId:S(g),fee:g,timestamp:N,type:S(g),asset:S(A({transferAsset:S(A({amount:g,assetType:S(g)}))}))})}))),count:S(N)}))});A({genesisBlock:A({forgeInterval:N,beginEpochTime:S(N)})});const oE=new Map,Kz=15e3;function jz(e,t){oE.set(e,t)}function TW(e){return oE.get(e)??Kz}function zz(e){return Array.from(e).map(t=>t.toString(16).padStart(2,"0")).join("")}function Vz(e){return class extends e{#e=null;#n(){if(!this.#e){const n=le.getConfig(this.chainId);this.#e=n?.prefix??"b"}return this.#e}async deriveAddress(n,r=0){const s=new TextDecoder().decode(n),o=YE(s);return QE(o.publicKey,this.#n())}async deriveAddresses(n,r,s){const o=await this.deriveAddress(n,r);return Array(s).fill(o)}isValidAddress(n){return XE(n)}normalizeAddress(n){return n}async signMessage(n,r){const s=ZE(n,r);return zz(s)}async verifyMessage(n,r,s){return!1}}}class Ys extends Error{constructor(t,n,r){super(t),this.status=n,this.response=r,this.name="ApiError"}}class qz{baseUrl;timeout;fetchFn;constructor(t){this.baseUrl=t.baseUrl.replace(/\/$/,""),this.timeout=t.timeout??3e4,this.fetchFn=t.fetch??((n,r)=>fetch(n,r))}async request(t,n,r){const s=`${this.baseUrl}${n}`,o=new AbortController,i=setTimeout(()=>o.abort(),this.timeout);try{const c={method:t,signal:o.signal};r&&(c.headers={"Content-Type":"application/json"},c.body=JSON.stringify(r));const a=await this.fetchFn(s,c),u=await a.json();if(!a.ok)throw new Ys(u.message??`Request failed: ${a.status}`,a.status,u);if(!u.success)throw new Ys(u.message??"Request failed",a.status,u);return u.result}catch(c){throw c instanceof Ys?c:c instanceof Error&&c.name==="AbortError"?new Ys("Request timeout",void 0,void 0):new Ys(c instanceof Error?c.message:"Unknown error",void 0,void 0)}finally{clearTimeout(i)}}async get(t){return this.request("GET",t)}async post(t,n){return this.request("POST",t,n)}}const Wz="https://walletapi.bfmeta.info";class Jz{client;chainPath;constructor(t){this.chainPath=t.chainPath;const n={baseUrl:t.baseUrl??Wz};t.timeout!==void 0&&(n.timeout=t.timeout),t.fetch!==void 0&&(n.fetch=t.fetch),this.client=new qz(n)}path(t){return`/wallet/${this.chainPath}${t}`}async getLastBlock(){return this.client.get(this.path("/lastblock"))}async getBlockByHeight(t){return this.client.post(this.path("/block/query"),{height:t})}async getBalance(t){return this.client.post(this.path("/address/balance"),t)}async getAddressInfo(t){return this.client.post(this.path("/address/info"),{address:t})}async getAddressAssets(t){return this.client.post(this.path("/address/asset"),{address:t})}async getBlockAverageFee(){return this.client.get(this.path("/blockAveFee"))}async broadcastTransaction(t){return this.client.post(this.path("/transactions/broadcast"),t)}async queryTransactions(t){return this.client.post(this.path("/transactions/query"),t)}async queryPendingTransactions(t){return this.client.post(this.path("/pendingTr"),t)}async queryTokenList(t){return this.client.post(this.path("/assets"),t)}async queryTokenDetail(t){return this.client.post(this.path("/asset/details"),t)}}const Gz=wd({code:go(),message:go()}),lS=wd({success:WE(),minFee:go().optional(),message:go().optional(),error:Gz.optional()});class oa extends Error{constructor(t,n,r){super(n),this.code=t,this.minFee=r,this.name="BroadcastError",this.isRetryable=Yz(t,n)}isRetryable}function Yz(e,t){if(e&&["001-11028","001-11029","002-41011","001-00034"].includes(e))return!1;const r=t.toLowerCase();return["timeout","timed out","network","connection","econnrefused","enotfound","socket","fetch failed","failed to fetch"].some(i=>r.includes(i))?!0:["insufficient","not enough","rejected","invalid","expired"].some(i=>r.includes(i))?!1:e===void 0}const fS=new Map;function Qz(e){const t=e.match(/^(https?:\/\/[^/]+)\/wallet\/([^/]+)\/?$/);if(t)return{baseUrl:t[1],chainPath:t[2]};throw new Error(`Invalid wallet API URL format: ${e}. Expected format: https://host/wallet/chainPath`)}function Gl(e){let t=fS.get(e);if(!t){const{baseUrl:n,chainPath:r}=Qz(e);t=new Jz({baseUrl:n,chainPath:r}),fS.set(e,t)}return t}const hS=new Map,dS=new Map;let ia=null,ca=null;async function Um(e,t){const n=t,r=hS.get(n);if(r)return r;let s;typeof document<"u"?s=new URL(`./configs/${t.replace(/^\.\//,"")}`,document.baseURI).href:s=`./configs/${t.replace(/^\.\//,"")}`;let o;if(s.startsWith("http://")||s.startsWith("https://")){const i=await fetch(s);if(!i.ok)throw new Error(`Failed to fetch genesis block for ${e}: ${i.status}`);o=await i.json()}else o=(await import(s)).default;return hS.set(n,o),o}async function Xz(){const{sha256:e}=await rs(async()=>{const{sha256:o}=await import("./derivation-DZMe6kEi.js").then(i=>i.O);return{sha256:o}},__vite__mapDeps([0,1,2,3]),import.meta.url),{md5:t,ripemd160:n}=await rs(async()=>{const{md5:o,ripemd160:i}=await import("./derivation-DZMe6kEi.js").then(c=>c.P);return{md5:o,ripemd160:i}},__vite__mapDeps([0,1,2,3]),import.meta.url),r=o=>{const i=[];return{update(c){const a=typeof c=="string"?new TextEncoder().encode(c):c;return i.push(a),this},async digest(){const c=i.reduce((l,f)=>l+f.length,0),a=new Uint8Array(c);let u=0;for(const l of i)a.set(l,u),u+=l.length;return Buffer.from(o(a))}}};return{sha256(o){if(!o)return r(c=>e(c));const i=typeof o=="string"?new TextEncoder().encode(o):o;return Promise.resolve(Buffer.from(e(i)))},md5(o){if(!o)return r(c=>t(c));const i=typeof o=="string"?new TextEncoder().encode(o):o;return Promise.resolve(Buffer.from(t(i)))},ripemd160(o){if(!o)return r(c=>n(c));const i=typeof o=="string"?new TextEncoder().encode(o):o;return Promise.resolve(Buffer.from(n(i)))}}}async function Zz(){return ia||ca||(ca=(async()=>(ia={setup:(await rs(()=>import("./bioforest-chain-bundle-DDhYlOk5.js"),[],import.meta.url)).setup},ia))(),ca)}async function zr(e){const{chainConfigService:t}=await rs(async()=>{const{chainConfigService:u}=await import("./service-n17MZ-NQ.js").then(l=>l.s);return{chainConfigService:u}},__vite__mapDeps([4,1,2,3,5,6,0]),import.meta.url),n=t.getBiowalletGenesisBlock(e);if(!n)throw new Error(`Genesis block path not configured for chain: ${e}`);const r=await Um(e,n),s=r.magic,o=dS.get(s);if(o)return o;const i=await Zz(),c=await Xz(),a=await i.setup(r,c,{n:"KeyApp",m:"true",a:"web"});return dS.set(s,a),a}async function Ns(e){const n=await Gl(e).getLastBlock();return{height:n.height,timestamp:n.timestamp}}async function Yl(e,t){const n=Gl(e);try{return await n.getAddressInfo(t)??{address:t}}catch{return{address:t}}}async function iE(e){const t=await zr(e.chainId),n=await Ns(e.baseUrl),r=n.height,s=n.timestamp;let o=e.fee;o||(o=await t.transactionController.getTransferTransactionMinFee({transaction:{applyBlockHeight:r,timestamp:s,remark:e.remark??{}},assetInfo:{sourceChainName:await t.getChainName(),sourceChainMagic:await t.getMagic(),assetType:e.assetType,amount:e.amount}}));let i=!1;if(e.paySecret){const u=await Yl(e.baseUrl,e.from);u.secondPublicKey&&(i=await Km(e.chainId,e.mainSecret,e.paySecret,u.secondPublicKey)==="v1")}const c={mainSecret:e.mainSecret,...e.paySecret?{paySecret:e.paySecret,usePaySecretV1:i}:{}},a={sourceChainName:await t.getChainName(),sourceChainMagic:await t.getMagic(),assetType:e.assetType,amount:e.amount};return t.transactionController.createTransferTransactionJSON({secrets:c,transaction:{fee:o,recipientId:e.to,applyBlockHeight:r,timestamp:s,remark:e.remark??{},effectiveBlockHeight:r+100},assetInfo:a})}async function cE(e,t){const{nonce:n,...r}=t,s=Gl(e);try{const o=await s.broadcastTransaction(r);if(o&&typeof o=="object"&&"signature"in o)return{txHash:t.signature,alreadyExists:!1};const i=lS.safeParse(o);if(i.success){const c=i.data;if(!c.success){const a=c.error?.code,u=c.error?.message??c.message??"Transaction rejected";if(a==="001-00034")return{txHash:t.signature,alreadyExists:!0};throw new oa(a,u,c.minFee)}return{txHash:t.signature,alreadyExists:!1}}return{txHash:t.signature,alreadyExists:!1}}catch(o){if(o instanceof oa)throw o;if(o instanceof Ys&&o.response){const i=lS.safeParse(o.response);if(i.success){const c=i.data,a=c.error?.code,u=c.error?.message??c.message??"Transaction rejected";if(a==="001-00034")return{txHash:t.signature,alreadyExists:!0};throw new oa(a,u,c.minFee)}}throw new oa(void 0,o instanceof Error?o.message:"Transaction rejected")}}async function Km(e,t,n,r){const o=(await zr(e)).accountBaseHelper();try{if((await o.createSecondSecretKeypairV2(t,n)).publicKey.toString("hex")===r)return"v2"}catch{}try{if((await o.createSecondSecretKeypair(t,n)).publicKey.toString("hex")===r)return"v1"}catch{}return!1}async function aE(e){const{baseUrl:t,chainId:n,intent:r,fromAddress:s}=e,o=await zr(n),i=await Ns(t),c=i.height,a=i.timestamp;switch(r.type){case"transfer":{let u=!1;if(s)try{u=!!(await Yl(t,s)).secondPublicKey}catch{}const l=r.amount||"99999999999999999";let f=await o.transactionController.getTransferTransactionMinFee({transaction:{applyBlockHeight:c,timestamp:a,remark:r.remark??{}},assetInfo:{sourceChainName:await o.getChainName(),sourceChainMagic:await o.getMagic(),assetType:await o.getAssetType(),amount:l}});return u&&(f=String(BigInt(f)*BigInt(105)/BigInt(100))),f}case"setPayPassword":return o.transactionController.getSignatureTransactionMinFee({newPaySecret:`${Date.now()}getSignatureTransactionMinFee`,applyBlockHeight:c,timestamp:a});default:throw new Error(`Unknown fee intent type: ${r.type}`)}}async function uE(e,t,n,r,s){return aE({baseUrl:e,chainId:t,intent:{type:"transfer",amount:r??"0",remark:s},fromAddress:n})}async function lE(e,t){const n=await zr(t),r=await Ns(e),s=r.height,o=r.timestamp;return n.transactionController.getSignatureTransactionMinFee({newPaySecret:`${Date.now()}getSignatureTransactionMinFee`,applyBlockHeight:s,timestamp:o})}async function fE(e){const t=await zr(e.chainId),n=await Ns(e.baseUrl),r=n.height,s=n.timestamp;let o=e.fee;return o||(o=await t.transactionController.getSignatureTransactionMinFee({newPaySecret:e.newPaySecret,applyBlockHeight:r,timestamp:s})),t.transactionController.createSignatureTransactionJSON({mainSecret:e.mainSecret},{newPaySecret:e.newPaySecret,fee:o,applyBlockHeight:r,timestamp:s,effectiveBlockHeight:r+100})}async function jm(e,t,n,r){const s=await zr(t),o=await Ns(e),i=o.height,c=o.timestamp;return s.transactionController.getDestoryAssetTransactionMinFee({transaction:{applyBlockHeight:i,timestamp:c,remark:{}},assetInfo:{sourceChainName:await s.getChainName(),sourceChainMagic:await s.getMagic(),assetType:n,amount:r}})}async function hE(e){const t=await zr(e.chainId),n=await Ns(e.baseUrl),r=n.height,s=n.timestamp;let o=e.fee;o||(o=await jm(e.baseUrl,e.chainId,e.assetType,e.amount));let i=!1;if(e.paySecret){const l=await Yl(e.baseUrl,e.from);l.secondPublicKey&&(i=await Km(e.chainId,e.mainSecret,e.paySecret,l.secondPublicKey)==="v1")}const c={mainSecret:e.mainSecret,...e.paySecret?{paySecret:e.paySecret,usePaySecretV1:i}:{}},a={sourceChainName:await t.getChainName(),sourceChainMagic:await t.getMagic(),assetType:e.assetType,amount:e.amount};return t.transactionController.createDestoryAssetTransactionJSON({secrets:c,transaction:{fee:o,recipientId:e.recipientId,applyBlockHeight:r,timestamp:s,remark:e.remark??{},effectiveBlockHeight:r+100},assetInfo:a})}async function eV(e,t,n){const r=Gl(e);try{const s=await r.queryTokenDetail({assetType:t,address:n});return s?.applyAddress?{applyAddress:s.applyAddress,assetType:s.assetType}:null}catch{return null}}const Lf=Object.freeze(Object.defineProperty({__proto__:null,broadcastTransaction:cE,createDestroyTransaction:hE,createSignatureTransaction:fE,createTransferTransaction:iE,fetchGenesisBlock:Um,getAddressInfo:Yl,getAssetDetail:eV,getBioforestCore:zr,getDestroyTransactionMinFee:jm,getLastBlock:Ns,getMinFee:aE,getSignatureTransactionMinFee:lE,getTransferMinFee:uE,verifyTwoStepSecret:Km},Symbol.toStringTag,{value:"Module"}));function tV(e){return class extends e{#e=null;get#n(){return le.getConfig(this.chainId)}get#t(){return this.#e||(this.#e=le.getBiowalletApi(this.chainId)??""),this.#e}async buildTransaction(n){switch(n.type){case"transfer":return this.#r(n);case"destroy":return this.#o(n);case"setPayPassword":return this.#s(n);default:throw new de(ge.NOT_SUPPORTED,`Transaction type not supported: ${n.type}`)}}async#r(n){const r=this.#n;if(!n.from||!n.to)throw new de(ge.INVALID_ADDRESS,"Invalid address");return{chainId:r.id,intentType:"transfer",data:{from:n.from,to:n.to,amount:n.amount.toRawString(),assetType:n.bioAssetType??r.symbol,memo:n.memo,remark:n.remark},estimatedFee:n.fee}}async#o(n){const r=this.#n;if(!n.from||!n.recipientId)throw new de(ge.INVALID_ADDRESS,"Invalid address");return{chainId:r.id,intentType:"destroy",data:{from:n.from,recipientId:n.recipientId,amount:n.amount.toRawString(),assetType:n.bioAssetType,...n.remark?{remark:n.remark}:{}},estimatedFee:n.fee}}async#s(n){const r=this.#n;if(!n.from)throw new de(ge.INVALID_ADDRESS,"Invalid address");return{chainId:r.id,intentType:"setPayPassword",data:{from:n.from},estimatedFee:n.fee}}async estimateFee(n){const r=this.#n,{decimals:s,symbol:o}=r,i=(c,a)=>({amount:c,estimatedTime:a});if(!this.#t)throw new de(ge.NETWORK_ERROR,"RPC URL not configured for BioForest chain");try{let c;switch(n.intentType){case"transfer":{const u=n.data;c=await uE(this.#t,r.id,u.from,u.amount,void 0);break}case"destroy":{const u=n.data;c=await jm(this.#t,r.id,u.assetType,u.amount);break}case"setPayPassword":{c=await lE(this.#t,r.id);break}default:throw new de(ge.NOT_SUPPORTED,`Fee estimation not supported for: ${n.intentType}`)}const a=se.fromRaw(c,s,o);return{slow:i(a,30),standard:i(a,15),fast:i(a.mul(2),5)}}catch(c){throw c instanceof de?c:new de(ge.NETWORK_ERROR,"Failed to calculate minimum fee from SDK",void 0,c instanceof Error?c:void 0)}}async signTransaction(n,r){if(!r.bioSecret)throw new de(ge.SIGNATURE_FAILED,"bioSecret is required for BioChain signing");if(!this.#t)throw new de(ge.NETWORK_ERROR,"RPC URL not configured");const s=this.#n;try{switch(n.intentType){case"transfer":{const o=n.data,i=n.estimatedFee?n.estimatedFee.toRawString():(await this.estimateFee(n)).standard.amount.toRawString(),c=o.remark??(o.memo?{memo:o.memo}:void 0),a=await iE({baseUrl:this.#t,chainId:s.id,mainSecret:r.bioSecret,paySecret:r.bioPaySecret,from:o.from,to:o.to,amount:o.amount,assetType:o.assetType,fee:i,remark:c});return{chainId:n.chainId,data:a,signature:a.signature}}case"destroy":{const o=n.data,i=n.estimatedFee?n.estimatedFee.toRawString():(await this.estimateFee(n)).standard.amount.toRawString(),c=await hE({baseUrl:this.#t,chainId:s.id,mainSecret:r.bioSecret,paySecret:r.bioPaySecret,from:o.from,recipientId:o.recipientId,assetType:o.assetType,amount:o.amount,fee:i,remark:o.remark});return{chainId:n.chainId,data:c,signature:c.signature}}case"setPayPassword":{if(!r.bioNewPaySecret)throw new de(ge.SIGNATURE_FAILED,"bioNewPaySecret is required for setPayPassword");const o=await fE({baseUrl:this.#t,chainId:s.id,mainSecret:r.bioSecret,newPaySecret:r.bioNewPaySecret});return{chainId:n.chainId,data:o,signature:o.signature}}default:throw new de(ge.NOT_SUPPORTED,`Signing not supported for: ${n.intentType}`)}}catch(o){throw o instanceof de?o:new de(ge.SIGNATURE_FAILED,"Failed to sign transaction",void 0,o instanceof Error?o:void 0)}}async broadcastTransaction(n){if(!this.#t)throw new de(ge.NETWORK_ERROR,"RPC URL not configured");try{return(await cE(this.#t,n.data)).txHash}catch(r){throw r instanceof de?r:new de(ge.TX_BROADCAST_FAILED,"Failed to broadcast transaction",void 0,r instanceof Error?r:void 0)}}}}function nV(e){return class extends e{async bioGetAccountInfo(t){const{getAddressInfo:n}=await rs(async()=>{const{getAddressInfo:r}=await Promise.resolve().then(()=>Lf);return{getAddressInfo:r}},void 0,import.meta.url);try{const r=await n(this.endpoint,t);return{address:t,secondPublicKey:r?.secondPublicKey??null}}catch{return{address:t,secondPublicKey:null}}}async bioVerifyPayPassword(t){const{getBioforestCore:n}=await rs(async()=>{const{getBioforestCore:o}=await Promise.resolve().then(()=>Lf);return{getBioforestCore:o}},void 0,import.meta.url),s=(await n(this.chainId)).accountBaseHelper();try{if((await s.createSecondSecretKeypairV2(t.mainSecret,t.paySecret)).publicKey.toString("hex")===t.publicKey)return!0}catch{}try{if((await s.createSecondSecretKeypair(t.mainSecret,t.paySecret)).publicKey.toString("hex")===t.publicKey)return!0}catch{}return!1}async bioGetAssetDetail(t,n){const{getAssetDetail:r}=await rs(async()=>{const{getAssetDetail:s}=await Promise.resolve().then(()=>Lf);return{getAssetDetail:s}},void 0,import.meta.url);try{const s=await r(this.endpoint,t,n);return s?.applyAddress?{assetType:s.assetType,applyAddress:s.applyAddress}:null}catch{return null}}}}const rV=A({assetNumber:g,assetType:g}),sV=A({address:g,assets:zy({key:g,value:zy({key:g,value:rV})})}),oV=A({success:ve,result:S(we(sV))}),iV=A({assetType:g,amount:g}),cV=A({totalAmount:g,assetType:g}),aV=A({transactionSignature:g}),uV=A({trustees:ue(g),numberOfSignFor:N,assetType:g,amount:g}),lV=A({publicKey:S(g)}),fV=A({assetType:g,amount:g}),hV=A({entityId:S(g)}),dV=A({factoryId:S(g)}),pV=A({transferAsset:S(iV),giftAsset:S(cV),grabAsset:S(aV),trustAsset:S(uV),signature:S(lV),destroyAsset:S(fV),issueEntity:S(hV),issueEntityFactory:S(dV)}),dE=A({type:g,senderId:g,recipientId:p0(g,{default:()=>""}),timestamp:N,signature:g,asset:S(pV)}),mV=A({height:N,signature:g,transaction:dE}),gV=A({trs:ue(mV),count:S(N)}),pS=A({success:ve,result:S(gV)}),yV=A({height:N}),SV=A({success:ve,result:S(yV)}),bV=A({state:N,trJson:dE,signature:S(g),createdTime:g}),_V=A({success:ve,result:S(ue(bV))});function pE(e,t,n){const r=e.toLowerCase(),s=t.toLowerCase(),o=n.toLowerCase();return s&&r===o&&s===o?"self":r===o?"out":"in"}const wV=0;function mE(e){const t={"AST-01":"transfer","AST-02":"transfer","AST-03":"destroyAsset","BSE-01":"signature","ETY-01":"issueEntity","ETY-02":"issueEntity","GFT-01":"gift","GFT-02":"gift","GRB-01":"grab","GRB-02":"grab","TRS-01":"trust","TRS-02":"trust","SGN-01":"signFor","SGN-02":"signFor","EMI-01":"emigrate","EMI-02":"emigrate","IMI-01":"immigrate","IMI-02":"immigrate","ISA-01":"issueAsset","ICA-01":"increaseAsset","DSA-01":"destroyAsset","ISE-01":"issueEntity","DSE-01":"destroyEntity","LNS-01":"locationName","DAP-01":"dapp","CRT-01":"certificate","MRK-01":"mark"},n=e.split("-");if(n.length>=4){const r=`${n[n.length-2]}-${n[n.length-1]}`;return t[r]??"unknown"}return"unknown"}function gE(e,t){return e?e.transferAsset?{value:e.transferAsset.amount,assetType:e.transferAsset.assetType}:e.giftAsset?{value:e.giftAsset.totalAmount,assetType:e.giftAsset.assetType}:e.trustAsset?{value:e.trustAsset.amount,assetType:e.trustAsset.assetType}:e.grabAsset?{value:"0",assetType:t}:e.destroyAsset?{value:e.destroyAsset.amount,assetType:e.destroyAsset.assetType}:e.issueEntity||e.issueEntityFactory?{value:"0",assetType:t}:e.signature?{value:"0",assetType:t}:{value:null,assetType:t}:{value:null,assetType:t}}function mS(e,t){const{signature:n,height:r,status:s,createdTime:o,address:i="",epochMs:c}=t,{value:a,assetType:u}=gE(e.asset,"BFM"),l=o?new Date(o).getTime():c+e.timestamp*1e3,f=i?pE(e.senderId,e.recipientId??"",i):"out";return{hash:n,from:e.senderId,to:e.recipientId??"",timestamp:l,status:s,blockNumber:r!==void 0?BigInt(r):void 0,action:mE(e.type),direction:f,assets:[{assetType:"native",value:a??"0",symbol:u,decimals:8}]}}class vV{chainId;type;endpoint;config;constructor(t,n){this.type=t.type,this.endpoint=t.endpoint,this.config=t.config,this.chainId=n}}class yE extends nV(Vz(tV(vV))){symbol;decimals;baseUrl;forgeInterval=15e3;epochMs=wV;get pendingTxCacheTtl(){return Math.max(1e3,Math.floor(this.forgeInterval/4))}_eventBus=null;_txHistorySources=new Map;_txHistoryCreations=new Map;_balanceSources=new Map;_balanceCreations=new Map;_tokenBalanceSources=new Map;_tokenBalanceCreations=new Map;nativeBalance;tokenBalances;transactionHistory;blockHeight;transaction;constructor(t,n){super(t,n),this.symbol=le.getSymbol(n),this.decimals=le.getDecimals(n),this.baseUrl=this.endpoint;const r=le.getBiowalletGenesisBlock(n);r&&Um(n,r).then(c=>{const a=c.asset.genesisAsset.forgeInterval;typeof a=="number"&&(this.forgeInterval=a*1e3,jz(n,this.forgeInterval));const u=c.asset.genesisAsset.beginEpochTime;typeof u=="number"&&(this.epochMs=u)}).catch(c=>{console.warn("Failed to fetch genesis block:",c)});const s=this.symbol,o=this.decimals,i=this;this.transactionHistory=Se(`biowallet.${n}.transactionHistory`,c=>i.createTransactionHistorySource(c,s,o)),this.nativeBalance=Se(`biowallet.${n}.nativeBalance`,c=>i.createBalanceSource(c,s,o)),this.tokenBalances=Se(`biowallet.${n}.tokenBalances`,c=>i.createTokenBalancesSource(c,s,o)),this.blockHeight=Se(`biowallet.${n}.blockHeight`,()=>i.createBlockHeightSource()),this.transaction=Se(`biowallet.${n}.transaction`,c=>i.createTransactionSource(c))}getSharedBlockHeightSource(){const t=this,n=ql(this.chainId,"global","blockHeight"),r=t.fetchBlockHeight().pipe(j(s=>s.result?.height?BigInt(s.result.height):BigInt(0)));return Wl(n,{fetch:r,interval:ie(this.forgeInterval)})}getSharedTxHistorySource(t,n,r){const s=this,o=t.toLowerCase(),i=o,c=l=>({...l,stop:s.releaseSharedTxHistorySource(i)}),a=s._txHistorySources.get(i);if(a)return a.refCount+=1,z(c(a.source));const u=s._txHistoryCreations.get(i);return W(u?async()=>{const l=await u,f=s._txHistorySources.get(i);return f&&(f.refCount+=1),c(l)}:async()=>{const l=Q($(function*(){const f=yield*s.getSharedBlockHeightSource(),h=yield*Le({name:`biowallet.${s.chainId}.txHistory.${o}`,dependsOn:f.ref,hasChanged:()=>!0,fetch:(_,T)=>s.fetchTransactionList({address:t,limit:50},!0).pipe(j(C=>C.result?.trs?C.result.trs.map(v=>{const k=v.transaction,R=mE(k.type),w=pE(k.senderId,k.recipientId??"",o),{value:I,assetType:O}=gE(k.asset,n);return I===null?null:{hash:k.signature??v.signature,from:k.senderId,to:k.recipientId??"",timestamp:s.epochMs+k.timestamp*1e3,status:"confirmed",blockNumber:BigInt(v.height),action:R,direction:w,assets:[{assetType:"native",value:I,symbol:O,decimals:r}]}}).filter(v=>v!==null).sort((v,k)=>k.timestamp-v.timestamp):[]))});s._eventBus||(s._eventBus=yield*En());const y=yield*s._eventBus.forWalletEvents(s.chainId,o,["tx:confirmed"]).pipe(Wn(()=>Ve(h.refresh,()=>me)),it),b=ze([h.stop,xe(y)]).pipe(Ae);return s._txHistorySources.set(i,{source:h,refCount:1,stopAll:b}),h}));s._txHistoryCreations.set(i,l);try{const f=await l;return c(f)}finally{s._txHistoryCreations.delete(i)}})}releaseSharedTxHistorySource(t){const n=this;return $(function*(){const r=n._txHistorySources.get(t);r&&(r.refCount-=1,r.refCount<=0&&(yield*r.stopAll,n._txHistorySources.delete(t)))})}getSharedBalanceSource(t,n,r){const s=this,i=t.toLowerCase(),c=l=>({...l,stop:s.releaseSharedBalanceSource(i)}),a=s._balanceSources.get(i);if(a)return a.refCount+=1,z(c(a.source));const u=s._balanceCreations.get(i);return W(u?async()=>{const l=await u,f=s._balanceSources.get(i);return f&&(f.refCount+=1),c(l)}:async()=>{const l=Q($(function*(){const f=yield*s.getSharedTxHistorySource(t,n,r),h=yield*Le({name:`biowallet.${s.chainId}.balance`,dependsOn:f.ref,hasChanged:()=>!0,fetch:(y,b)=>s.fetchAddressAsset(t,b??!1).pipe(j(_=>{if(!_.result?.assets)return{amount:se.zero(r,n),symbol:n};for(const T of Object.values(_.result.assets))for(const C of Object.values(T))if(C.assetType===n)return{amount:se.fromRaw(C.assetNumber,r,n),symbol:n};return{amount:se.zero(r,n),symbol:n}}))}),m=ze([h.stop,f.stop]).pipe(Ae);return s._balanceSources.set(i,{source:h,refCount:1,stopAll:m}),h}));s._balanceCreations.set(i,l);try{const f=await l;return c(f)}finally{s._balanceCreations.delete(i)}})}releaseSharedBalanceSource(t){const n=this;return $(function*(){const r=n._balanceSources.get(t);r&&(r.refCount-=1,r.refCount<=0&&(yield*r.stopAll,n._balanceSources.delete(t)))})}getSharedTokenBalancesSource(t,n,r){const s=this,i=t.toLowerCase(),c=l=>({...l,stop:s.releaseSharedTokenBalancesSource(i)}),a=s._tokenBalanceSources.get(i);if(a)return a.refCount+=1,z(c(a.source));const u=s._tokenBalanceCreations.get(i);return W(u?async()=>{const l=await u,f=s._tokenBalanceSources.get(i);return f&&(f.refCount+=1),c(l)}:async()=>{const l=Q($(function*(){const f=yield*s.getSharedTxHistorySource(t,n,r),h=yield*Le({name:`biowallet.${s.chainId}.tokenBalances`,dependsOn:f.ref,hasChanged:()=>!0,fetch:(y,b)=>s.fetchAddressAsset(t,b??!1).pipe(j(_=>{if(!_.result?.assets)return[];const T=[];for(const C of Object.values(_.result.assets))for(const v of Object.values(C)){const k=v.assetType===n;T.push({symbol:v.assetType,name:v.assetType,amount:se.fromRaw(v.assetNumber,r,v.assetType),isNative:k,decimals:r})}return T.sort((C,v)=>C.isNative&&!v.isNative?-1:!C.isNative&&v.isNative?1:v.amount.toNumber()-C.amount.toNumber()),T}))}),m=ze([h.stop,f.stop]).pipe(Ae);return s._tokenBalanceSources.set(i,{source:h,refCount:1,stopAll:m}),h}));s._tokenBalanceCreations.set(i,l);try{const f=await l;return c(f)}finally{s._tokenBalanceCreations.delete(i)}})}releaseSharedTokenBalancesSource(t){const n=this;return $(function*(){const r=n._tokenBalanceSources.get(t);r&&(r.refCount-=1,r.refCount<=0&&(yield*r.stopAll,n._tokenBalanceSources.delete(t)))})}createTransactionHistorySource(t,n,r){return this.getSharedTxHistorySource(t.address,n,r)}createBalanceSource(t,n,r){return this.getSharedBalanceSource(t.address,n,r)}createTokenBalancesSource(t,n,r){return this.getSharedTokenBalancesSource(t.address,n,r)}createBlockHeightSource(){return this.getSharedBlockHeightSource()}createTransactionSource(t){const n=this;return $(function*(){const r=ze({pending:n.fetchPendingTransactions(t.senderId??""),confirmed:n.fetchSingleTransaction(t.txHash)}).pipe(j(({pending:o,confirmed:i})=>{if(i.result?.trs?.length){const c=i.result.trs[0];return mS(c.transaction,{signature:c.transaction.signature??c.signature,height:c.height,status:"confirmed",epochMs:n.epochMs})}if(o.result&&o.result.length>0){const c=o.result.find(a=>a.signature===t.txHash);if(c)return mS(c.trJson,{signature:c.trJson.signature??c.signature??"",status:"pending",createdTime:c.createdTime,epochMs:n.epochMs})}return null}));return yield*Te({name:`biowallet.${n.chainId}.transaction`,fetch:r,interval:ie(n.forgeInterval)})})}fetchBlockHeight(){return Z({url:`${this.baseUrl}/lastblock`,schema:SV,cacheStrategy:"network-first",cache:"no-store",headers:{"Cache-Control":"no-cache"}})}fetchAddressAsset(t,n=!1){return Z({url:`${this.baseUrl}/address/asset`,method:"POST",body:{address:t},schema:oV,cacheStrategy:n?"network-first":"cache-first"})}fetchTransactionList(t,n=!1){return Z({url:`${this.baseUrl}/transactions/query`,method:"POST",body:{address:t.address,page:t.page??1,pageSize:t.limit??50,sort:-1},schema:pS,cacheStrategy:n?"network-first":"cache-first"})}fetchSingleTransaction(t){return Z({url:`${this.baseUrl}/transactions/query`,method:"POST",body:{signature:t},schema:pS,cacheStrategy:"ttl",cacheTtl:this.pendingTxCacheTtl})}fetchPendingTransactions(t){return Z({url:`${this.baseUrl}/pendingTr`,method:"POST",body:{senderId:t,sort:-1},schema:_V,cacheStrategy:"ttl",cacheTtl:this.pendingTxCacheTtl})}}function SE(e,t){return e.type==="biowallet-v1"?new yE(e,t):null}const TV=A({success:ve,result:S(we(De(g,N)))}),kV=De(TV,g,N),EV=A({blockNumber:S(g),timeStamp:g,hash:g,from:g,to:g,value:g,isError:S(g),txreceipt_status:S(g)}),CV=A({blockNumber:S(g),timeStamp:g,hash:g,from:g,to:g,value:g,tokenSymbol:S(g),tokenName:S(g),tokenDecimal:S(g),contractAddress:S(g)}),IV=A({status:S(g),message:S(g),result:ue(EV)}),$V=A({status:S(g),message:S(g),result:ue(CV)}),AV=A({success:ve,result:S(IV)}),RV=A({success:ve,result:S($V)}),bE=A({amount:we(De(g,N)),contractAddress:S(we(g)),decimals:S(we(N)),icon:S(we(g)),symbol:S(we(g)),name:S(we(g))}),OV=ue(bE),PV=A({success:ve,result:S(we(ue(bE)))}),gS=De(OV,PV),xV=A({chain:S(g),address:g,name:g,icon:S(g),symbol:g,decimals:N}),FV=A({data:ue(xV),page:N,pageSize:N,total:N,pages:S(N)}),NV=A({success:ve,result:S(FV)});function yS(e,t,n){const r=e.toLowerCase(),s=t.toLowerCase();return r===n&&s===n?"self":r===n?"out":"in"}function Di(e){return e==null?"0":String(e)}function js(e){return typeof e=="string"||typeof e=="number"?{success:!0,amount:Di(e)}:{success:e.success,amount:Di(e.result)}}function BV(e){return Promise.resolve(e.success)}function qc(e){if(!e)return!1;const t=e.status?.toUpperCase(),n=e.message?.toUpperCase();return n==="NO TRANSACTIONS FOUND"?!0:!(t==="0"||n==="NOTOK")}function SS(e){return e.success?Promise.resolve(qc(e.result)):Promise.resolve(!1)}function MV(e){return typeof e=="string"||typeof e=="number"?Promise.resolve(!0):Promise.resolve(e.success)}function bS(e){return Array.isArray(e)?Promise.resolve(!0):Promise.resolve(e.success)}function _S(e){return Array.isArray(e)?e:e.result??[]}function LV(e){return!e||!e.success?!1:qc(e.result)}function zs(e,t){t.success}function HV(e){if(typeof e=="number")return e;if(typeof e=="string"){const t=Number.parseInt(e,10);return Number.isNaN(t)?0:t}return 0}function wS(e,t){return!e||e.length!==t.length?!0:e.length===0&&t.length===0?!1:e[0]?.hash!==t[0]?.hash}function DV(e,t){const n=new Map;for(const r of e)n.set(r.hash,r);for(const r of t){const s=n.get(r.hash);if(s){s.assets=[...s.assets,...r.assets],n.set(r.hash,s);continue}n.set(r.hash,r)}return Array.from(n.values()).sort((r,s)=>s.timestamp-r.timestamp)}function UV(e){const t=new Set;for(const n of e)for(const r of n.assets)r.assetType==="token"&&r.contractAddress&&t.add(r.contractAddress);return[...t].sort()}function vS(e){return!e.success||!e.result?[]:e.result.data.map(t=>t.address).filter(t=>t.length>0).map(t=>t.toLowerCase()).sort()}function KV(e){return e.success&&e.result?e:{success:!0,result:{data:[],page:1,pageSize:0,total:0}}}function jV(e,t){return t.success&&qc(t.result)?z(t):It(new ct(`[bscwallet] ${e} NOTOK`))}function zV(e,t){return t.success&&qc(t.result)?z(t):It(new ct(`[bscwallet] ${e} NOTOK`))}class VV{chainId;type;endpoint;config;constructor(t,n){this.type=t.type,this.endpoint=t.endpoint,this.config=t.config,this.chainId=n}}class _E extends ci(ai(VV)){symbol;decimals;baseUrl;pollingInterval=3e4;balanceCacheTtlMs=5e3;tokenListCacheTtl=600*1e3;_normalHistoryDisabled=!1;_eventBus=null;_txHistorySources=new Map;_txHistoryCreations=new Map;_balanceSources=new Map;_balanceCreations=new Map;_tokenBalanceSources=new Map;_tokenBalanceCreations=new Map;_tokenListSource=null;_tokenListCreation=null;nativeBalance;tokenBalances;transactionHistory;constructor(t,n){super(t,n),this.symbol=le.getSymbol(n),this.decimals=le.getDecimals(n),this.baseUrl=this.endpoint;const r=this;this.transactionHistory=Se(`bscwallet.${n}.transactionHistory`,s=>r.createTransactionHistorySource(s)),this.nativeBalance=Se(`bscwallet.${n}.nativeBalance`,s=>r.createBalanceSource(s)),this.tokenBalances=Se(`bscwallet.${n}.tokenBalances`,s=>r.createTokenBalancesSource(s))}createTransactionHistorySource(t){return this.getSharedTxHistorySource(t.address)}createBalanceSource(t){return this.getSharedBalanceSource(t.address).pipe(Mr(n=>this.createBalanceFallbackSource(t.address)))}createTokenBalancesSource(t){return this.getSharedTokenBalanceSource(t.address).pipe(Mr(n=>this.createTokenBalancesFallbackSource(t.address)))}createBalanceFallbackSource(t){const n=this.symbol,r=this.decimals;return Te({name:`bscwallet.${this.chainId}.balance.fallback`,interval:ie(this.pollingInterval),immediate:!0,fetch:this.fetchBalance(t,!0).pipe(j(s=>{const o=js(s);return{amount:se.fromRaw(o.amount,r,n),symbol:n}}))})}createTokenBalancesFallbackSource(t){const n=this.symbol,r=this.decimals;return Te({name:`bscwallet.${this.chainId}.tokenBalances.fallback`,interval:ie(this.pollingInterval),immediate:!0,fetch:this.fetchTokenBalances(t,[],!0).pipe(j(s=>{const o=[],i=js(s.native);o.push({symbol:n,name:n,amount:se.fromRaw(i.amount,r,n),isNative:!0,decimals:r});for(const c of s.tokens){const a=c.symbol??"BEP20",u=c.decimals??0;o.push({symbol:a,name:c.name??a,amount:se.fromRaw(Di(c.amount),u,a),isNative:!1,decimals:u,icon:c.icon,contractAddress:c.contractAddress})}return o}))})}getSharedTxHistorySource(t){const n=this,r=t.toLowerCase(),s=r,o=this.symbol,i=this.decimals,c=l=>({...l,stop:n.releaseSharedTxHistorySource(s)}),a=n._txHistorySources.get(s);if(a)return a.refCount+=1,z(c(a.source));const u=n._txHistoryCreations.get(s);return W(u?async()=>{const l=await u,f=n._txHistorySources.get(s);return f&&(f.refCount+=1),c(l)}:async()=>{const l=Q($(function*(){n._eventBus||(n._eventBus=yield*En());const f=n._eventBus,h=yield*Te({name:`bscwallet.${n.chainId}.txHistory.native.${s}`,fetch:n.fetchNativeHistory({address:t,limit:50},!0),interval:ie(n.pollingInterval),walletEvents:{eventBus:f,chainId:n.chainId,address:t,types:["tx:confirmed","tx:sent"]}}),m=yield*h.get;if(!LV(m))return yield*h.stop,yield*It(new ct("[bscwallet] trans/normal/history NOTOK"));const y=yield*n.getSharedTokenListSource(),b=yield*At(0),_=tn(b,E=>E+1).pipe(Ae),T=yield*At(new Map),C=[],v=E=>it(E.pipe(fs(()=>_),hr));C.push(yield*v(h.changes));const k=new Map,R=new Map,w=E=>$(function*(){if(k.has(E))return;const V=yield*Te({name:`bscwallet.${n.chainId}.txHistory.bep20.${s}.${E}`,fetch:n.fetchTokenHistory({address:t,limit:50,contractAddress:E},!0),interval:ie(n.pollingInterval),immediate:!1,walletEvents:{eventBus:f,chainId:n.chainId,address:t,types:["tx:confirmed","tx:sent"]}});k.set(E,V);const q=yield*it(V.changes.pipe(Wn(D=>tn(T,B=>{const F=new Map(B);return F.set(E,D),F}).pipe(Ce(_)))));R.set(E,q),yield*it(V.refresh.pipe(Ae))}),I=E=>$(function*(){const V=k.get(E);V&&(yield*V.stop,k.delete(E));const q=R.get(E);q&&(yield*xe(q),R.delete(E)),yield*tn(T,D=>{const B=new Map(D);return B.delete(E),B}).pipe(Ce(_))}),O=E=>$(function*(){const V=E?vS(E):[],q=new Set(V);for(const D of k.keys())q.has(D)||(yield*I(D));for(const D of q)k.has(D)||(yield*w(D))});yield*O(yield*y.get),C.push(yield*it(y.changes.pipe(Wn(E=>O(E).pipe(Ce(_))))));const H=yield*Le({name:`bscwallet.${n.chainId}.txHistory.${s}`,dependsOn:b,hasChanged:(E,V)=>E!==V,fetch:()=>$(function*(){const V=((yield*h.get)?.result?.result??[]).map(B=>{const F=B.isError==="1"||B.txreceipt_status==="0"?"failed":"confirmed";return{hash:B.hash,from:B.from,to:B.to,timestamp:parseInt(B.timeStamp,10)*1e3,status:F,blockNumber:B.blockNumber?BigInt(B.blockNumber):void 0,action:"transfer",direction:yS(B.from,B.to,r),assets:[{assetType:"native",value:B.value,symbol:o,decimals:i}]}}),D=[...(yield*Mt(T)).values()].flatMap(B=>(B?.result?.result??[]).map(F=>{const ce=F.tokenSymbol??"BEP20",je=HV(F.tokenDecimal),qt=F.contractAddress?.toLowerCase();return{hash:F.hash,from:F.from,to:F.to,timestamp:parseInt(F.timeStamp,10)*1e3,status:"confirmed",blockNumber:F.blockNumber?BigInt(F.blockNumber):void 0,action:"transfer",direction:yS(F.from,F.to,r),assets:[{assetType:"token",value:F.value,symbol:ce,decimals:je,contractAddress:qt,name:F.tokenName}]}}));return DV(V,D)})}),x=$(function*(){for(const E of C)yield*xe(E);for(const E of k.values())yield*E.stop;for(const E of R.values())yield*xe(E);yield*H.stop,yield*h.stop,yield*n.releaseSharedTokenListSource()});return n._txHistorySources.set(s,{source:H,refCount:1,stopAll:x}),H}));n._txHistoryCreations.set(s,l);try{const f=await l;return c(f)}finally{n._txHistoryCreations.delete(s)}})}releaseSharedTxHistorySource(t){const n=this;return $(function*(){const r=n._txHistorySources.get(t);r&&(r.refCount-=1,r.refCount<=0&&(yield*r.stopAll,n._txHistorySources.delete(t)))})}getSharedBalanceSource(t){const n=this,r=t.toLowerCase(),s=this.symbol,o=this.decimals,i=u=>({...u,stop:n.releaseSharedBalanceSource(r)}),c=n._balanceSources.get(r);if(c)return c.refCount+=1,z(i(c.source));const a=n._balanceCreations.get(r);return W(a?async()=>{const u=await a,l=n._balanceSources.get(r);return l&&(l.refCount+=1),i(u)}:async()=>{const u=Q($(function*(){const l=yield*Ve(n.getSharedTxHistorySource(t),w=>$(function*(){return null}));if(l===null){const w=yield*Te({name:`bscwallet.${n.chainId}.balance.poll`,interval:ie(n.pollingInterval),immediate:!0,fetch:n.fetchBalance(t,!0).pipe(j(I=>{const O=js(I);return{amount:se.fromRaw(O.amount,o,s),symbol:s}}))});return n._balanceSources.set(r,{source:w,refCount:1,stopAll:w.stop}),w}const f=yield*At(null),h=yield*At(0),m=tn(h,w=>w+1).pipe(Ae),y=w=>{const I=js(w);return{amount:se.fromRaw(I.amount,o,s),symbol:s}},b=yield*Le({name:`bscwallet.${n.chainId}.balance.dep`,dependsOn:l.ref,hasChanged:wS,fetch:(w,I)=>n.fetchBalance(t,I).pipe(j(y),Ie(O=>Ot(f,O)))}),_=(yield*l.get)===null,T=yield*Te({name:`bscwallet.${n.chainId}.balance.poll`,interval:ie(n.pollingInterval),immediate:_,fetch:$(function*(){const w=yield*l.get,I=yield*Mt(f);if(w!==null&&I!==null)return I;const O=yield*n.fetchBalance(t,!0),H=y(O);return yield*Ot(f,H),H})}),C=[],v=w=>it(w.pipe(fs(()=>m),hr));C.push(yield*v(b.changes)),C.push(yield*v(T.changes));const k=yield*Le({name:`bscwallet.${n.chainId}.balance`,dependsOn:h,hasChanged:(w,I)=>w!==I,fetch:()=>$(function*(){const w=yield*Mt(f);return w||(yield*It(new ct("[bscwallet] balance cache empty")))})}),R=$(function*(){for(const w of C)yield*xe(w);yield*b.stop,yield*T.stop,yield*k.stop,yield*l.stop});return n._balanceSources.set(r,{source:k,refCount:1,stopAll:R}),k}));n._balanceCreations.set(r,u);try{const l=await u;return i(l)}finally{n._balanceCreations.delete(r)}})}releaseSharedBalanceSource(t){const n=this;return $(function*(){const r=n._balanceSources.get(t);r&&(r.refCount-=1,r.refCount<=0&&(yield*r.stopAll,n._balanceSources.delete(t)))})}getSharedTokenBalanceSource(t){const n=this,r=t.toLowerCase(),s=this.symbol,o=this.decimals,i=u=>({...u,stop:n.releaseSharedTokenBalanceSource(r)}),c=n._tokenBalanceSources.get(r);if(c)return c.refCount+=1,z(i(c.source));const a=n._tokenBalanceCreations.get(r);return W(a?async()=>{const u=await a,l=n._tokenBalanceSources.get(r);return l&&(l.refCount+=1),i(u)}:async()=>{const u=Q($(function*(){const l=yield*Ve(n.getSharedTxHistorySource(t),w=>$(function*(){return null}));if(l===null){const w=yield*Te({name:`bscwallet.${n.chainId}.tokenBalances.poll`,interval:ie(n.pollingInterval),immediate:!0,fetch:n.fetchTokenBalances(t,[],!0).pipe(j(I=>{const O=[],H=js(I.native);O.push({symbol:s,name:s,amount:se.fromRaw(H.amount,o,s),isNative:!0,decimals:o});for(const x of I.tokens){const E=x.symbol??"BEP20",V=x.decimals??0;O.push({symbol:E,name:x.name??E,amount:se.fromRaw(Di(x.amount),V,E),isNative:!1,decimals:V,icon:x.icon,contractAddress:x.contractAddress})}return O}))});return n._tokenBalanceSources.set(r,{source:w,refCount:1,stopAll:w.stop}),w}const f=yield*At(null),h=yield*At(0),m=tn(h,w=>w+1).pipe(Ae),y=w=>{const I=[],O=js(w.native);I.push({symbol:s,name:s,amount:se.fromRaw(O.amount,o,s),isNative:!0,decimals:o});for(const H of w.tokens){const x=H.symbol??"BEP20",E=H.decimals??0;I.push({symbol:x,name:H.name??x,amount:se.fromRaw(Di(H.amount),E,x),isNative:!1,decimals:E,icon:H.icon,contractAddress:H.contractAddress})}return I},b=yield*Le({name:`bscwallet.${n.chainId}.tokenBalances.dep`,dependsOn:l.ref,hasChanged:wS,fetch:(w,I)=>n.fetchTokenBalances(t,UV(w),I).pipe(j(y),Ie(O=>Ot(f,O)))}),_=(yield*l.get)===null,T=yield*Te({name:`bscwallet.${n.chainId}.tokenBalances.poll`,interval:ie(n.pollingInterval),immediate:_,fetch:$(function*(){const w=yield*l.get,I=yield*Mt(f);if(w!==null&&I!==null)return I;const O=yield*n.fetchTokenBalances(t,[],!0),H=y(O);return yield*Ot(f,H),H})}),C=[],v=w=>it(w.pipe(fs(()=>m),hr));C.push(yield*v(b.changes)),C.push(yield*v(T.changes));const k=yield*Le({name:`bscwallet.${n.chainId}.tokenBalances`,dependsOn:h,hasChanged:(w,I)=>w!==I,fetch:()=>$(function*(){const w=yield*Mt(f);return w||(yield*It(new ct("[bscwallet] tokenBalances cache empty")))})}),R=$(function*(){for(const w of C)yield*xe(w);yield*b.stop,yield*T.stop,yield*k.stop,yield*l.stop});return n._tokenBalanceSources.set(r,{source:k,refCount:1,stopAll:R}),k}));n._tokenBalanceCreations.set(r,u);try{const l=await u;return i(l)}finally{n._tokenBalanceCreations.delete(r)}})}releaseSharedTokenBalanceSource(t){const n=this;return $(function*(){const r=n._tokenBalanceSources.get(t);r&&(r.refCount-=1,r.refCount<=0&&(yield*r.stopAll,n._tokenBalanceSources.delete(t)))})}getSharedTokenListSource(){const t=this;return t._tokenListSource?(t._tokenListSource.refCount+=1,z(t._tokenListSource.source)):t._tokenListCreation?W(async()=>{const n=await t._tokenListCreation;return t._tokenListSource&&(t._tokenListSource.refCount+=1),n}):W(async()=>{const n=Q($(function*(){const r=yield*Te({name:`bscwallet.${t.chainId}.tokenList`,fetch:t.fetchTokenList(!1),interval:ie(t.tokenListCacheTtl),immediate:!0});return t._tokenListSource={source:r,refCount:1,stopAll:r.stop},r}));t._tokenListCreation=n;try{return await n}finally{t._tokenListCreation=null}})}releaseSharedTokenListSource(){const t=this;return $(function*(){const n=t._tokenListSource;n&&(n.refCount-=1,n.refCount<=0&&(yield*n.stopAll,t._tokenListSource=null))})}fetchBalance(t,n=!1){return Z({url:`${this.baseUrl}/balance?address=${t}`,schema:kV,cacheStrategy:n?"ttl":"cache-first",cacheTtl:this.balanceCacheTtlMs,canCache:MV}).pipe(Ie(r=>{typeof r=="object"&&r!==null&&"success"in r&&zs("balance",r)}))}fetchNativeHistory(t,n=!1){return this._normalHistoryDisabled?It(new ct("[bscwallet] trans/normal/history disabled")):Z({url:`${this.baseUrl}/trans/normal/history`,method:"POST",body:{address:t.address,page:1,offset:t.limit??50},schema:AV,cacheStrategy:n?"ttl":"cache-first",cacheTtl:this.balanceCacheTtlMs,canCache:SS}).pipe(Ie(r=>zs("trans/normal/history",r)),X(r=>(r.success&&r.result&&!qc(r.result)&&(this._normalHistoryDisabled=!0),jV("trans/normal/history",r))))}fetchTokenHistory(t,n=!1){return t.contractAddress?Z({url:`${this.baseUrl}/trans/bep20/history`,method:"POST",body:{address:t.address,contractaddress:t.contractAddress,page:1,offset:t.limit??50},schema:RV,cacheStrategy:n?"ttl":"cache-first",cacheTtl:this.balanceCacheTtlMs,canCache:SS}).pipe(Ie(r=>zs("trans/bep20/history",r)),X(r=>zV("trans/bep20/history",r))):z({success:!0,result:{result:[]}})}fetchTokenBalances(t,n,r=!1){const s=[...n].sort();if(s.length===0){const o=this;return $(function*(){const i=yield*o.fetchTokenList(!1),c=vS(i),a=yield*o.fetchBalance(t,r);if(c.length===0)return{native:a,tokens:[]};const u=yield*Z({url:`${o.baseUrl}/account/balance/v2`,method:"POST",body:{address:t,contracts:c},schema:gS,cacheStrategy:r?"ttl":"cache-first",cacheTtl:o.balanceCacheTtlMs,canCache:bS}).pipe(Ie(l=>{Array.isArray(l)||zs("account/balance/v2",l)}),j(_S),Ve(()=>z([])));return{native:a,tokens:u}})}return ze({native:this.fetchBalance(t,r),tokens:Z({url:`${this.baseUrl}/account/balance/v2`,method:"POST",body:{address:t,contracts:s},schema:gS,cacheStrategy:r?"ttl":"cache-first",cacheTtl:this.balanceCacheTtlMs,canCache:bS}).pipe(Ie(o=>{Array.isArray(o)||zs("account/balance/v2",o)}),j(_S),Ve(()=>z([])))})}fetchTokenList(t=!1){return Z({url:`${this.baseUrl}/contract/tokens`,method:"POST",body:{page:1,pageSize:50,chain:"BSC"},schema:NV,cacheStrategy:t?"network-first":"ttl",cacheTtl:this.tokenListCacheTtl,canCache:BV}).pipe(Ie(n=>zs("contract/tokens",n)),j(KV))}}function wE(e,t){return e.type==="bscwallet-v1"?new _E(e,t):null}const aa="123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz";function vE(e){return class extends e{async deriveAddress(n,r=0){const s=new TextDecoder().decode(n);return Oa(s,"tron",r).address}async deriveAddresses(n,r,s){const o=new TextDecoder().decode(n),i=[];for(let c=0;c<s;c++){const a=Oa(o,"tron",r+c);i.push(a.address)}return i}isValidAddress(n){if(!n.startsWith("T")||n.length!==34)return!1;for(const r of n)if(!aa.includes(r))return!1;try{const r=this.#e(n);if(r.length!==25)return!1;const s=r.slice(0,21),o=r.slice(21),i=kr(kr(s));return o.every((c,a)=>c===i[a])}catch{return!1}}#e(n){let r=BigInt(0);for(const i of n){const c=aa.indexOf(i);if(c===-1)throw new Error(`Invalid base58 character: ${i}`);r=r*58n+BigInt(c)}const s=r.toString(16).padStart(50,"0"),o=new Uint8Array(25);for(let i=0;i<25;i++)o[i]=parseInt(s.slice(i*2,i*2+2),16);return o}normalizeAddress(n){return n}async signMessage(n,r){const s=typeof n=="string"?new TextEncoder().encode(n):n,o=new TextEncoder().encode(`TRON Signed Message:
`+s.length),i=Ai(new Uint8Array([...o,...s])),c=yo.sign(i,r,{prehash:!1,format:"recovered"});return $r(c)}async verifyMessage(n,r,s){try{const o=typeof n=="string"?new TextEncoder().encode(n):n,i=new TextEncoder().encode(`TRON Signed Message:
`+o.length),c=Ai(new Uint8Array([...i,...o])),a=Ir(r),u=yo.recoverPublicKey(c,a);if(!u)return!1;const f=Ai(u.slice(1)).slice(-20),h=new Uint8Array([65,...f]),m=kr(kr(h)).slice(0,4),y=new Uint8Array([...h,...m]);return this.#n(y)===s}catch{return!1}}#n(n){let r=BigInt(0);for(const o of n)r=r*256n+BigInt(o);let s="";for(;r>0n;){const o=Number(r%58n);r=r/58n,s=aa[o]+s}for(const o of n)if(o===0)s=aa[0]+s;else break;return s}}}const qV="https://api.trongrid.io";function qo(e){return typeof e=="object"&&e!==null}function WV(e,t){const n=Ir(e),r=yo.sign(n,t,{prehash:!1,format:"recovered"}),s=r[0],o=r.subarray(1),i=(s+27).toString(16).padStart(2,"0");return`${$r(o)}${i}`}function JV(e){if(typeof e!="string")return null;const t=e.trim();if(!t)return null;const n=t.startsWith("0x")?t.slice(2):t;if(!/^[0-9a-fA-F]+$/.test(n)||n.length%2!==0)return t;try{return new TextDecoder().decode(Ir(n)).trim()||t}catch{return t}}function GV(e){if(!qo(e))return"Unknown error";const t=[e.message,e.code,e.error];qo(e.result)&&t.push(e.result.message,e.result.code,e.result.error);for(const n of t){const r=JV(n);if(r)return r}return"Unknown error"}function YV(e){return qo(e)?typeof e.result=="boolean"?e.result:typeof e.success=="boolean"?e.success:!1:!1}function QV(e){const t=e.data;return qo(t)&&qo(t.signedTx)?t.signedTx:t}function TE(e){return class extends e{#e=null;#n="";#t(){if(!this.#e){const n=le.getConfig(this.chainId);if(!n)throw new de(ge.CHAIN_NOT_SUPPORTED,`Chain config not found: ${this.chainId}`);this.#e=n,this.#n=le.getRpcUrl(this.chainId)||qV}return this.#e}async#r(n,r){const s=`${this.#n}${n}`,o=r?{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(r)}:{method:"GET"},i=await fetch(s,o);if(!i.ok)throw new de(ge.NETWORK_ERROR,`Tron API error: ${i.status} ${i.statusText}`);return i.json()}#o(n){const r="123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz";let s=BigInt(0);for(const i of n){const c=r.indexOf(i);if(c===-1)throw new Error(`Invalid base58 character: ${i}`);s=s*58n+BigInt(c)}return s.toString(16).padStart(50,"0").slice(0,42)}async buildTransaction(n){if(n.type!=="transfer")throw new de(ge.NOT_SUPPORTED,`Transaction type not supported: ${n.type}`);const r=n;if(r.tokenAddress)throw new de(ge.NOT_SUPPORTED,"TRC20 transaction builder not available");const s=this.#t(),o=this.#o(r.from),i=this.#o(r.to),c=await this.#r("/wallet/createtransaction",{owner_address:o,to_address:i,amount:Number(r.amount.raw),visible:!1});if(!c.txID)throw new de(ge.TX_BUILD_FAILED,"Failed to create Tron transaction");return{chainId:s.id,intentType:"transfer",data:c}}async estimateFee(n){const r=this.#t(),o={amount:se.fromRaw("0",r.decimals,r.symbol),estimatedTime:3};return{slow:o,standard:o,fast:o}}async signTransaction(n,r){if(!r.privateKey)throw new de(ge.SIGNATURE_FAILED,"privateKey is required for Tron signing");const s=n.data,o=WV(s.txID,r.privateKey),i={...s,signature:[o]};return{chainId:n.chainId,data:i,signature:o}}async broadcastTransaction(n){const r=QV(n),s=await this.#r("/wallet/broadcasttransaction",r);if(!YV(s)){const o=GV(s);throw new de(ge.TX_BROADCAST_FAILED,`Broadcast failed: ${o}`,{reason:o,response:qo(s)?s:void 0})}return typeof s.txid=="string"&&s.txid.length>0?s.txid:r.txID}}}const kE=jS(kr);function zm(e){return e.startsWith("0x")||e.startsWith("0X")?e.slice(2):e}function Vm(e){return/^[0-9a-fA-F]+$/.test(e)}function XV(e){const t=zm(e);if(t.length%2!==0||!Vm(t))throw new Error(`Invalid hex: ${e}`);const n=new Uint8Array(t.length/2);for(let r=0;r<n.length;r++)n[r]=parseInt(t.slice(r*2,r*2+2),16);return n}function ZV(e){return Array.from(e,t=>t.toString(16).padStart(2,"0")).join("")}function er(e){const t=e.trim(),n=zm(t);if(n.length===42&&Vm(n)&&n.startsWith("41"))return n;if(!t.startsWith("T"))throw new Error(`Invalid Tron address: ${e}`);const r=kE.decode(t);if(r.length!==21)throw new Error(`Invalid Tron address length: ${e}`);return ZV(r)}function e3(e){const t=zm(e).toLowerCase();if(!Vm(t))throw new Error(`Invalid Tron hex address: ${e}`);const n=t.length===40?`41${t}`:t;if(n.length!==42)throw new Error(`Invalid Tron hex length: ${e}`);const r=XV(n);return kE.encode(r)}function mt(e){const t=e.trim();return t.startsWith("T")?t:e3(t)}function rr(e){return er(e).toLowerCase()}const t3=A({balance:S(N),address:S(g)}),n3=A({block_header:S(A({raw_data:S(A({number:S(N)}))}))}),r3=A({amount:S(N),owner_address:S(g),to_address:S(g)}),s3=A({parameter:S(A({value:S(r3)})),type:S(g)}),EE=A({txID:g,block_timestamp:S(N),raw_data:S(A({contract:S(ue(s3)),timestamp:S(N)})),ret:S(ue(A({contractRet:S(g)})))}),o3=A({success:ve,data:S(ue(EE))});function Hf(e){try{return rr(e)}catch{return e.toLowerCase()}}function TS(e,t,n){const r=Hf(e),s=Hf(t),o=Hf(n);return r===o&&s===o?"self":r===o?"out":"in"}function i3(e,t){return!e||e.length!==t.length?!0:e.length===0&&t.length===0?!1:e[0]?.hash!==t[0]?.hash}class c3{chainId;type;endpoint;config;constructor(t,n){this.type=t.type,this.endpoint=t.endpoint,this.config=t.config,this.chainId=n}}class CE extends vE(TE(c3)){symbol;decimals;baseUrl;headers;pollingInterval=3e4;_eventBus=null;_txHistorySources=new Map;_txHistoryCreations=new Map;_balanceSources=new Map;_balanceCreations=new Map;nativeBalance;transactionHistory;transaction;blockHeight;constructor(t,n){super(t,n),this.symbol=le.getSymbol(n),this.decimals=le.getDecimals(n),this.baseUrl=this.endpoint;const r=Jl(this.config?.apiKeyEnv,`trongrid-${n}`);this.headers=r?{"TRON-PRO-API-KEY":r}:{};const s=this;this.blockHeight=Se(`tron-rpc.${n}.blockHeight`,()=>s.createBlockHeightSource()),this.transactionHistory=Se(`tron-rpc.${n}.transactionHistory`,o=>s.createTransactionHistorySource(o)),this.nativeBalance=Se(`tron-rpc.${n}.nativeBalance`,o=>s.createBalanceSource(o)),this.transaction=Se(`tron-rpc.${n}.transaction`,o=>s.createTransactionSource(o))}createBlockHeightSource(){return this.getSharedBlockHeightSource()}getSharedBlockHeightSource(){const t=this,n=ql(this.chainId,"global","blockHeight"),r=t.fetchNowBlock(!0).pipe(j(s=>BigInt(s.block_header?.raw_data?.number??0)));return Wl(n,{fetch:r,interval:ie(t.pollingInterval)})}createTransactionHistorySource(t){return this.getSharedTxHistorySource(t.address)}createBalanceSource(t){return this.getSharedBalanceSource(t.address)}getSharedTxHistorySource(t){const n=this,r=mt(t),s=rr(t),o=this.symbol,i=this.decimals,c=l=>({...l,stop:n.releaseSharedTxHistorySource(s)}),a=n._txHistorySources.get(s);if(a)return a.refCount+=1,z(c(a.source));const u=n._txHistoryCreations.get(s);return W(u?async()=>{const l=await u,f=n._txHistorySources.get(s);return f&&(f.refCount+=1),c(l)}:async()=>{const l=Q($(function*(){n._eventBus||(n._eventBus=yield*En());const f=n._eventBus,h=n.fetchTransactionList(r,!0).pipe(j(b=>!b.success||!b.data?[]:b.data.map(_=>{const C=_.raw_data?.contract?.[0]?.parameter?.value,v=C?.owner_address??"",k=C?.to_address??"",R=mt(v),w=mt(k),I=_.ret?.[0]?.contractRet==="SUCCESS"?"confirmed":"failed";return{hash:_.txID,from:R,to:w,timestamp:_.block_timestamp??_.raw_data?.timestamp??0,status:I,action:"transfer",direction:TS(v,k,r),assets:[{assetType:"native",value:(C?.amount??0).toString(),symbol:o,decimals:i}]}}))),m=yield*Te({name:`tron-rpc.${n.chainId}.txHistory.${s}`,fetch:h,interval:ie(n.pollingInterval),walletEvents:{eventBus:f,chainId:n.chainId,address:r,types:["tx:confirmed","tx:sent"]}}),y=m.stop;return n._txHistorySources.set(s,{source:m,refCount:1,stopAll:y}),m}));n._txHistoryCreations.set(s,l);try{const f=await l;return c(f)}finally{n._txHistoryCreations.delete(s)}})}releaseSharedTxHistorySource(t){const n=this;return $(function*(){const r=n._txHistorySources.get(t);r&&(r.refCount-=1,r.refCount<=0&&(yield*r.stopAll,n._txHistorySources.delete(t)))})}getSharedBalanceSource(t){const n=this,r=rr(t),s=this.symbol,o=this.decimals,i=u=>({...u,stop:n.releaseSharedBalanceSource(r)}),c=n._balanceSources.get(r);if(c)return c.refCount+=1,z(i(c.source));const a=n._balanceCreations.get(r);return W(a?async()=>{const u=await a,l=n._balanceSources.get(r);return l&&(l.refCount+=1),i(u)}:async()=>{const u=Q($(function*(){const l=yield*n.getSharedTxHistorySource(t),f=yield*Le({name:`tron-rpc.${n.chainId}.balance`,dependsOn:l.ref,hasChanged:i3,fetch:(m,y)=>n.fetchAccount(t,y).pipe(j(b=>({amount:se.fromRaw((b.balance??0).toString(),o,s),symbol:s})))}),h=ze([f.stop,l.stop]).pipe(Ae);return n._balanceSources.set(r,{source:f,refCount:1,stopAll:h}),f}));n._balanceCreations.set(r,u);try{const l=await u;return i(l)}finally{n._balanceCreations.delete(r)}})}releaseSharedBalanceSource(t){const n=this;return $(function*(){const r=n._balanceSources.get(t);r&&(r.refCount-=1,r.refCount<=0&&(yield*r.stopAll,n._balanceSources.delete(t)))})}createTransactionSource(t){const n=this,r=this.symbol,s=this.decimals;return $(function*(){const o=n.fetchTransactionById(t.txHash).pipe(j(c=>{if(!c.txID)return null;const u=c.raw_data?.contract?.[0]?.parameter?.value,l=u?.owner_address??"",f=u?.to_address??"",h=mt(l),m=mt(f);let y;!c.ret||c.ret.length===0?y="pending":y=c.ret[0]?.contractRet==="SUCCESS"?"confirmed":"failed";const b=t.senderId??h;return{hash:c.txID,from:h,to:m,timestamp:c.block_timestamp??c.raw_data?.timestamp??0,status:y,action:"transfer",direction:TS(l,f,b),assets:[{assetType:"native",value:(u?.amount??0).toString(),symbol:r,decimals:s}]}}));return yield*Te({name:`tron-rpc.${n.chainId}.transaction`,fetch:o,interval:ie(3e3)})})}fetchNowBlock(t=!1){return Z({url:`${this.baseUrl}/wallet/getnowblock`,method:"POST",headers:this.headers,schema:n3,cacheStrategy:t?"network-first":"cache-first",cache:"no-store"})}fetchAccount(t,n=!1){return Z({url:`${this.baseUrl}/wallet/getaccount`,method:"POST",headers:this.headers,body:{address:er(t)},schema:t3,cacheStrategy:n?"network-first":"cache-first"})}fetchTransactionList(t,n=!1){const r=mt(t);return Z({url:`${this.baseUrl}/v1/accounts/${r}/transactions`,headers:this.headers,schema:o3,cacheStrategy:n?"network-first":"cache-first"})}fetchTransactionById(t){return Z({url:`${this.baseUrl}/wallet/gettransactionbyid`,method:"POST",headers:this.headers,body:{value:t},schema:EE,cacheStrategy:"ttl",cacheTtl:Math.max(1e3,Math.floor(this.pollingInterval/4))})}}function IE(e,t){return e.type==="tron-rpc"||e.type==="tron-rpc-pro"?new CE(e,t):null}function $E(e){return class extends e{async deriveAddress(n,r=0){const s=new TextDecoder().decode(n);return qm(s,84,r).address}async deriveAddresses(n,r,s){const o=new TextDecoder().decode(n),i=[];for(let c=0;c<s;c++){const a=qm(o,84,r+c);i.push(a.address)}return i}isValidAddress(n){try{if(n.startsWith("1")||n.startsWith("3"))return jS(kr).decode(n).length===21;if(n.toLowerCase().startsWith("bc1q")){const r=n.toLowerCase(),s=Wm.decode(r),o=Wm.fromWords(s.words.slice(1));return s.prefix==="bc"&&s.words[0]===0&&o.length===20}if(n.toLowerCase().startsWith("bc1p")){const r=n.toLowerCase(),s=Jm.decode(r),o=Jm.fromWords(s.words.slice(1));return s.prefix==="bc"&&s.words[0]===1&&o.length===32}return!1}catch{return!1}}normalizeAddress(n){return n.startsWith("bc1")||n.startsWith("BC1")?n.toLowerCase():n}async signMessage(n,r){const s=typeof n=="string"?new TextEncoder().encode(n):n,o=new TextEncoder().encode(`Bitcoin Signed Message:
`),i=new Uint8Array([s.length]),c=new Uint8Array([...o,...i,...s]),a=kr(kr(c)),u=yo.sign(a,r,{prehash:!1,format:"recovered"});return $r(u)}async verifyMessage(n,r,s){return!1}}}const a3="https://mempool.space/api";function AE(e){return class extends e{#e=null;get#n(){return this.#e||(this.#e=le.getMempoolApi(this.chainId)??a3),this.#e}get#t(){return le.getConfig(this.chainId)}async#r(n,r){const s=`${this.#n}${n}`,o=await fetch(s,r);if(!o.ok)throw new de(ge.NETWORK_ERROR,`Bitcoin API error: ${o.status}`);const i=await o.text();try{return JSON.parse(i)}catch{return i}}async buildTransaction(n){if(n.type!=="transfer")throw new de(ge.NOT_SUPPORTED,`Transaction type not supported: ${n.type}`);const r=n,s=await this.#r(`/address/${r.from}/utxo`);if(s.length===0)throw new de(ge.INSUFFICIENT_BALANCE,"No UTXOs available");const i=(await this.#r("/v1/fees/recommended")).halfHourFee,c=s.reduce((y,b)=>y+b.value,0),a=Number(r.amount.raw),u=10+s.length*68+62,l=i*u;if(c<a+l)throw new de(ge.INSUFFICIENT_BALANCE,`Insufficient balance: need ${a+l}, have ${c}`);const f=c-a-l,h=this.#t,m={inputs:s.map(y=>({txid:y.txid,vout:y.vout,value:y.value,scriptPubKey:""})),outputs:[{address:r.to,value:a}],fee:l,changeAddress:r.from};return f>546&&m.outputs.push({address:r.from,value:f}),{chainId:h.id,intentType:"transfer",data:m}}async estimateFee(n){try{const r=await this.#r("/v1/fees/recommended"),s=140,o=this.#t,i={amount:se.fromRaw((r.hourFee*s).toString(),o.decimals,o.symbol),estimatedTime:3600},c={amount:se.fromRaw((r.halfHourFee*s).toString(),o.decimals,o.symbol),estimatedTime:1800},a={amount:se.fromRaw((r.fastestFee*s).toString(),o.decimals,o.symbol),estimatedTime:600};return{slow:i,standard:c,fast:a}}catch{const r=this.#t,s={amount:se.fromRaw("2000",r.decimals,r.symbol),estimatedTime:1800};return{slow:s,standard:s,fast:s}}}async signTransaction(n,r){throw new de(ge.CHAIN_NOT_SUPPORTED,"Bitcoin transaction signing requires specialized library (bitcoinjs-lib or similar)")}async broadcastTransaction(n){const r=n.data;return await this.#r("/tx",{method:"POST",body:r})}}}const u3=A({chain_stats:A({funded_txo_sum:N,spent_txo_sum:N})}),l3=A({txid:g,vin:ue(A({prevout:S(A({scriptpubkey_address:S(g)}))})),vout:ue(A({scriptpubkey_address:S(g),value:S(N)})),status:A({confirmed:ve,block_time:S(N)})}),f3=ue(l3);function h3(e,t,n){const r=e?.some(o=>o.prevout?.scriptpubkey_address===n),s=t?.some(o=>o.scriptpubkey_address===n);return r&&s?"self":r?"out":"in"}function d3(e,t){return!e||e.length!==t.length?!0:e.length===0&&t.length===0?!1:e[0]?.hash!==t[0]?.hash}class p3{chainId;type;endpoint;config;constructor(t,n){this.type=t.type,this.endpoint=t.endpoint,this.config=t.config,this.chainId=n}}class RE extends $E(AE(p3)){symbol;decimals;baseUrl;pollingInterval=6e4;_eventBus=null;_txHistorySources=new Map;_txHistoryCreations=new Map;_balanceSources=new Map;_balanceCreations=new Map;nativeBalance;transactionHistory;blockHeight;constructor(t,n){super(t,n),this.symbol=le.getSymbol(n),this.decimals=le.getDecimals(n),this.baseUrl=this.endpoint;const r=this;this.blockHeight=Se(`mempool.${n}.blockHeight`,()=>r.createBlockHeightSource()),this.transactionHistory=Se(`mempool.${n}.transactionHistory`,s=>r.createTransactionHistorySource(s)),this.nativeBalance=Se(`mempool.${n}.nativeBalance`,s=>r.createBalanceSource(s))}createBlockHeightSource(){return this.getSharedBlockHeightSource()}getSharedBlockHeightSource(){const t=this,n=ql(this.chainId,"global","blockHeight"),r=t.fetchBlockHeight(!0).pipe(j(s=>BigInt(s)));return Wl(n,{fetch:r,interval:ie(t.pollingInterval)})}createTransactionHistorySource(t){return this.getSharedTxHistorySource(t.address)}createBalanceSource(t){return this.getSharedBalanceSource(t.address)}getSharedTxHistorySource(t){const n=this,r=t,s=this.symbol,o=this.decimals,i=u=>({...u,stop:n.releaseSharedTxHistorySource(r)}),c=n._txHistorySources.get(r);if(c)return c.refCount+=1,z(i(c.source));const a=n._txHistoryCreations.get(r);return W(a?async()=>{const u=await a,l=n._txHistorySources.get(r);return l&&(l.refCount+=1),i(u)}:async()=>{const u=Q($(function*(){n._eventBus||(n._eventBus=yield*En());const l=n._eventBus,f=n.fetchTransactionHistory(t,!0).pipe(j(y=>y.map(b=>({hash:b.txid,from:b.vin[0]?.prevout?.scriptpubkey_address??"",to:b.vout[0]?.scriptpubkey_address??"",timestamp:(b.status.block_time??0)*1e3,status:b.status.confirmed?"confirmed":"pending",action:"transfer",direction:h3(b.vin,b.vout,t),assets:[{assetType:"native",value:(b.vout[0]?.value??0).toString(),symbol:s,decimals:o}]})))),h=yield*Te({name:`mempool.${n.chainId}.txHistory.${r}`,fetch:f,interval:ie(n.pollingInterval),walletEvents:{eventBus:l,chainId:n.chainId,address:t,types:["tx:confirmed","tx:sent"]}}),m=h.stop;return n._txHistorySources.set(r,{source:h,refCount:1,stopAll:m}),h}));n._txHistoryCreations.set(r,u);try{const l=await u;return i(l)}finally{n._txHistoryCreations.delete(r)}})}releaseSharedTxHistorySource(t){const n=this;return $(function*(){const r=n._txHistorySources.get(t);r&&(r.refCount-=1,r.refCount<=0&&(yield*r.stopAll,n._txHistorySources.delete(t)))})}getSharedBalanceSource(t){const n=this,r=t,s=this.symbol,o=this.decimals,i=u=>({...u,stop:n.releaseSharedBalanceSource(r)}),c=n._balanceSources.get(r);if(c)return c.refCount+=1,z(i(c.source));const a=n._balanceCreations.get(r);return W(a?async()=>{const u=await a,l=n._balanceSources.get(r);return l&&(l.refCount+=1),i(u)}:async()=>{const u=Q($(function*(){const l=yield*n.getSharedTxHistorySource(t),f=yield*Le({name:`mempool.${n.chainId}.balance`,dependsOn:l.ref,hasChanged:d3,fetch:(m,y)=>n.fetchAddressInfo(t,y).pipe(j(b=>{const _=b.chain_stats.funded_txo_sum-b.chain_stats.spent_txo_sum;return{amount:se.fromRaw(_.toString(),o,s),symbol:s}}))}),h=ze([f.stop,l.stop]).pipe(Ae);return n._balanceSources.set(r,{source:f,refCount:1,stopAll:h}),f}));n._balanceCreations.set(r,u);try{const l=await u;return i(l)}finally{n._balanceCreations.delete(r)}})}releaseSharedBalanceSource(t){const n=this;return $(function*(){const r=n._balanceSources.get(t);r&&(r.refCount-=1,r.refCount<=0&&(yield*r.stopAll,n._balanceSources.delete(t)))})}fetchBlockHeight(t=!1){return Z({url:`${this.baseUrl}/blocks/tip/height`,cacheStrategy:t?"network-first":"cache-first"})}fetchAddressInfo(t,n=!1){return Z({url:`${this.baseUrl}/address/${t}`,schema:u3,cacheStrategy:n?"network-first":"cache-first"})}fetchTransactionHistory(t,n=!1){return Z({url:`${this.baseUrl}/address/${t}/txs`,schema:f3,cacheStrategy:n?"network-first":"cache-first"})}}function OE(e,t){return e.type.startsWith("mempool-")?new RE(e,t):null}const m3=A({success:ve,result:S(De(g,N))}),g3=De(m3,g,N),y3=A({blockNumber:S(g),timeStamp:g,hash:g,from:g,to:g,value:g,isError:S(g),txreceipt_status:S(g),input:S(g),methodId:S(g),functionName:S(g)}),S3=A({blockNumber:S(g),timeStamp:g,hash:g,from:g,to:g,value:g,tokenSymbol:S(g),tokenName:S(g),tokenDecimal:S(g),contractAddress:S(g)}),b3=A({status:S(g),message:S(g),result:ue(y3)}),_3=A({status:S(g),message:S(g),result:ue(S3)}),w3=A({success:ve,result:S(b3)}),v3=A({success:ve,result:S(_3)}),PE=A({amount:De(g,N),contractAddress:S(g),decimals:S(N),icon:S(g),symbol:S(g),name:S(g)}),T3=ue(PE),k3=A({success:ve,result:S(ue(PE))}),kS=De(T3,k3),E3=A({chain:S(g),address:g,name:g,icon:S(g),symbol:g,decimals:N}),C3=A({data:ue(E3),page:N,pageSize:N,total:N,pages:S(N)}),I3=A({success:ve,result:S(C3)});function ES(e,t,n){const r=e.toLowerCase(),s=t.toLowerCase();return r===n&&s===n?"self":r===n?"out":"in"}function $3(e){return e.value&&e.value!=="0"?"transfer":"contract"}function Ui(e){return e==null?"0":String(e)}function Vs(e){return typeof e=="string"||typeof e=="number"?{success:!0,amount:Ui(e)}:{success:e.success,amount:Ui(e.result)}}function A3(e){return Promise.resolve(e.success)}function Ql(e){if(!e)return!1;const t=e.status?.toUpperCase(),n=e.message?.toUpperCase();return n==="NO TRANSACTIONS FOUND"?!0:!(t==="0"||n==="NOTOK")}function CS(e){return e.success?Promise.resolve(Ql(e.result)):Promise.resolve(!1)}function R3(e){return typeof e=="string"||typeof e=="number"?Promise.resolve(!0):Promise.resolve(e.success)}function IS(e){return Array.isArray(e)?Promise.resolve(!0):Promise.resolve(e.success)}function $S(e){return Array.isArray(e)?e:e.result??[]}function O3(e){return!e||!e.success?!1:Ql(e.result)}function qs(e,t){t.success}function P3(e){if(typeof e=="number")return e;if(typeof e=="string"){const t=Number.parseInt(e,10);return Number.isNaN(t)?0:t}return 0}function AS(e,t){return!e||e.length!==t.length?!0:e.length===0&&t.length===0?!1:e[0]?.hash!==t[0]?.hash}function x3(e,t){const n=new Map;for(const r of e)n.set(r.hash,r);for(const r of t){const s=n.get(r.hash);if(s){s.assets=[...s.assets,...r.assets],n.set(r.hash,s);continue}n.set(r.hash,r)}return Array.from(n.values()).sort((r,s)=>s.timestamp-r.timestamp)}function F3(e){const t=new Set;for(const n of e)for(const r of n.assets)r.assetType==="token"&&r.contractAddress&&t.add(r.contractAddress);return[...t].sort()}function RS(e){return!e.success||!e.result?[]:e.result.data.map(t=>t.address).filter(t=>t.length>0).map(t=>t.toLowerCase()).sort()}function N3(e){return e.success&&e.result?e:{success:!0,result:{data:[],page:1,pageSize:0,total:0}}}function B3(e,t){return t.success&&Ql(t.result)?z(t):It(new ct(`[ethwallet] ${e} NOTOK`))}function M3(e,t){return t.success&&Ql(t.result)?z(t):It(new ct(`[ethwallet] ${e} NOTOK`))}class L3{chainId;type;endpoint;config;constructor(t,n){this.type=t.type,this.endpoint=t.endpoint,this.config=t.config,this.chainId=n}}class xE extends ci(ai(L3)){symbol;decimals;baseUrl;pollingInterval=3e4;balanceCacheTtlMs=5e3;tokenListCacheTtl=600*1e3;_eventBus=null;_txHistorySources=new Map;_txHistoryCreations=new Map;_balanceSources=new Map;_balanceCreations=new Map;_tokenBalanceSources=new Map;_tokenBalanceCreations=new Map;_tokenListSource=null;_tokenListCreation=null;nativeBalance;tokenBalances;transactionHistory;constructor(t,n){super(t,n),this.symbol=le.getSymbol(n),this.decimals=le.getDecimals(n),this.baseUrl=this.endpoint;const r=this;this.transactionHistory=Se(`ethwallet.${n}.transactionHistory`,s=>r.createTransactionHistorySource(s)),this.nativeBalance=Se(`ethwallet.${n}.nativeBalance`,s=>r.createBalanceSource(s)),this.tokenBalances=Se(`ethwallet.${n}.tokenBalances`,s=>r.createTokenBalancesSource(s))}createTransactionHistorySource(t){return this.getSharedTxHistorySource(t.address)}createBalanceSource(t){return this.getSharedBalanceSource(t.address).pipe(Mr(n=>this.createBalanceFallbackSource(t.address)))}createTokenBalancesSource(t){return this.getSharedTokenBalanceSource(t.address).pipe(Mr(n=>this.createTokenBalancesFallbackSource(t.address)))}createBalanceFallbackSource(t){const n=this.symbol,r=this.decimals;return Te({name:`ethwallet.${this.chainId}.balance.fallback`,interval:ie(this.pollingInterval),immediate:!0,fetch:this.fetchBalance(t,!0).pipe(j(s=>{const o=Vs(s);return{amount:se.fromRaw(o.amount,r,n),symbol:n}}))})}createTokenBalancesFallbackSource(t){const n=this.symbol,r=this.decimals;return Te({name:`ethwallet.${this.chainId}.tokenBalances.fallback`,interval:ie(this.pollingInterval),immediate:!0,fetch:this.fetchTokenBalances(t,[],!0).pipe(j(s=>{const o=[],i=Vs(s.native);o.push({symbol:n,name:n,amount:se.fromRaw(i.amount,r,n),isNative:!0,decimals:r});for(const c of s.tokens){const a=c.symbol??"ERC20",u=c.decimals??0;o.push({symbol:a,name:c.name??a,amount:se.fromRaw(Ui(c.amount),u,a),isNative:!1,decimals:u,icon:c.icon,contractAddress:c.contractAddress})}return o}))})}getSharedTxHistorySource(t){const n=this,r=t.toLowerCase(),s=r,o=this.symbol,i=this.decimals,c=l=>({...l,stop:n.releaseSharedTxHistorySource(s)}),a=n._txHistorySources.get(s);if(a)return a.refCount+=1,z(c(a.source));const u=n._txHistoryCreations.get(s);return W(u?async()=>{const l=await u,f=n._txHistorySources.get(s);return f&&(f.refCount+=1),c(l)}:async()=>{const l=Q($(function*(){n._eventBus||(n._eventBus=yield*En());const f=n._eventBus,h=yield*Te({name:`ethwallet.${n.chainId}.txHistory.native.${s}`,fetch:n.fetchNativeHistory({address:t,limit:50},!0),interval:ie(n.pollingInterval),walletEvents:{eventBus:f,chainId:n.chainId,address:t,types:["tx:confirmed","tx:sent"]}}),m=yield*h.get;if(!O3(m))return yield*h.stop,yield*It(new ct("[ethwallet] trans/normal/history NOTOK"));const y=yield*n.getSharedTokenListSource(),b=yield*At(0),_=tn(b,E=>E+1).pipe(Ae),T=yield*At(new Map),C=[],v=E=>it(E.pipe(fs(()=>_),hr));C.push(yield*v(h.changes));const k=new Map,R=new Map,w=E=>$(function*(){if(k.has(E))return;const V=yield*Te({name:`ethwallet.${n.chainId}.txHistory.erc20.${s}.${E}`,fetch:n.fetchTokenHistory({address:t,limit:50,contractAddress:E},!0),interval:ie(n.pollingInterval),immediate:!1,walletEvents:{eventBus:f,chainId:n.chainId,address:t,types:["tx:confirmed","tx:sent"]}});k.set(E,V);const q=yield*it(V.changes.pipe(Wn(D=>tn(T,B=>{const F=new Map(B);return F.set(E,D),F}).pipe(Ce(_)))));R.set(E,q),yield*it(V.refresh.pipe(Ae))}),I=E=>$(function*(){const V=k.get(E);V&&(yield*V.stop,k.delete(E));const q=R.get(E);q&&(yield*xe(q),R.delete(E)),yield*tn(T,D=>{const B=new Map(D);return B.delete(E),B}).pipe(Ce(_))}),O=E=>$(function*(){const V=E?RS(E):[],q=new Set(V);for(const D of k.keys())q.has(D)||(yield*I(D));for(const D of q)k.has(D)||(yield*w(D))});yield*O(yield*y.get),C.push(yield*it(y.changes.pipe(Wn(E=>O(E).pipe(Ce(_))))));const H=yield*Le({name:`ethwallet.${n.chainId}.txHistory.${s}`,dependsOn:b,hasChanged:(E,V)=>E!==V,fetch:()=>$(function*(){const V=((yield*h.get)?.result?.result??[]).map(B=>{const F=B.isError==="1"||B.txreceipt_status==="0"?"failed":"confirmed";return{hash:B.hash,from:B.from,to:B.to,timestamp:parseInt(B.timeStamp,10)*1e3,status:F,blockNumber:B.blockNumber?BigInt(B.blockNumber):void 0,action:$3(B),direction:ES(B.from,B.to,r),assets:[{assetType:"native",value:B.value,symbol:o,decimals:i}]}}),D=[...(yield*Mt(T)).values()].flatMap(B=>(B?.result?.result??[]).map(F=>{const ce=F.tokenSymbol??"ERC20",je=P3(F.tokenDecimal),qt=F.contractAddress?.toLowerCase();return{hash:F.hash,from:F.from,to:F.to,timestamp:parseInt(F.timeStamp,10)*1e3,status:"confirmed",blockNumber:F.blockNumber?BigInt(F.blockNumber):void 0,action:"transfer",direction:ES(F.from,F.to,r),assets:[{assetType:"token",value:F.value,symbol:ce,decimals:je,contractAddress:qt,name:F.tokenName}]}}));return x3(V,D)})}),x=$(function*(){for(const E of C)yield*xe(E);for(const E of k.values())yield*E.stop;for(const E of R.values())yield*xe(E);yield*H.stop,yield*h.stop,yield*n.releaseSharedTokenListSource()});return n._txHistorySources.set(s,{source:H,refCount:1,stopAll:x}),H}));n._txHistoryCreations.set(s,l);try{const f=await l;return c(f)}finally{n._txHistoryCreations.delete(s)}})}releaseSharedTxHistorySource(t){const n=this;return $(function*(){const r=n._txHistorySources.get(t);r&&(r.refCount-=1,r.refCount<=0&&(yield*r.stopAll,n._txHistorySources.delete(t)))})}getSharedBalanceSource(t){const n=this,r=t.toLowerCase(),s=this.symbol,o=this.decimals,i=u=>({...u,stop:n.releaseSharedBalanceSource(r)}),c=n._balanceSources.get(r);if(c)return c.refCount+=1,z(i(c.source));const a=n._balanceCreations.get(r);return W(a?async()=>{const u=await a,l=n._balanceSources.get(r);return l&&(l.refCount+=1),i(u)}:async()=>{const u=Q($(function*(){const l=yield*Ve(n.getSharedTxHistorySource(t),w=>$(function*(){return null}));if(l===null){const w=yield*Te({name:`ethwallet.${n.chainId}.balance.poll`,interval:ie(n.pollingInterval),immediate:!0,fetch:n.fetchBalance(t,!0).pipe(j(I=>{const O=Vs(I);return{amount:se.fromRaw(O.amount,o,s),symbol:s}}))});return n._balanceSources.set(r,{source:w,refCount:1,stopAll:w.stop}),w}const f=yield*At(null),h=yield*At(0),m=tn(h,w=>w+1).pipe(Ae),y=w=>{const I=Vs(w);return{amount:se.fromRaw(I.amount,o,s),symbol:s}},b=yield*Le({name:`ethwallet.${n.chainId}.balance.dep`,dependsOn:l.ref,hasChanged:AS,fetch:(w,I)=>n.fetchBalance(t,I).pipe(j(y),Ie(O=>Ot(f,O)))}),_=(yield*l.get)===null,T=yield*Te({name:`ethwallet.${n.chainId}.balance.poll`,interval:ie(n.pollingInterval),immediate:_,fetch:$(function*(){const w=yield*l.get,I=yield*Mt(f);if(w!==null&&I!==null)return I;const O=yield*n.fetchBalance(t,!0),H=y(O);return yield*Ot(f,H),H})}),C=[],v=w=>it(w.pipe(fs(()=>m),hr));C.push(yield*v(b.changes)),C.push(yield*v(T.changes));const k=yield*Le({name:`ethwallet.${n.chainId}.balance`,dependsOn:h,hasChanged:(w,I)=>w!==I,fetch:()=>$(function*(){const w=yield*Mt(f);return w||(yield*It(new ct("[ethwallet] balance cache empty")))})}),R=$(function*(){for(const w of C)yield*xe(w);yield*b.stop,yield*T.stop,yield*k.stop,yield*l.stop});return n._balanceSources.set(r,{source:k,refCount:1,stopAll:R}),k}));n._balanceCreations.set(r,u);try{const l=await u;return i(l)}finally{n._balanceCreations.delete(r)}})}releaseSharedBalanceSource(t){const n=this;return $(function*(){const r=n._balanceSources.get(t);r&&(r.refCount-=1,r.refCount<=0&&(yield*r.stopAll,n._balanceSources.delete(t)))})}getSharedTokenBalanceSource(t){const n=this,r=t.toLowerCase(),s=this.symbol,o=this.decimals,i=u=>({...u,stop:n.releaseSharedTokenBalanceSource(r)}),c=n._tokenBalanceSources.get(r);if(c)return c.refCount+=1,z(i(c.source));const a=n._tokenBalanceCreations.get(r);return W(a?async()=>{const u=await a,l=n._tokenBalanceSources.get(r);return l&&(l.refCount+=1),i(u)}:async()=>{const u=Q($(function*(){const l=yield*Ve(n.getSharedTxHistorySource(t),w=>$(function*(){return null}));if(l===null){const w=yield*Te({name:`ethwallet.${n.chainId}.tokenBalances.poll`,interval:ie(n.pollingInterval),immediate:!0,fetch:n.fetchTokenBalances(t,[],!0).pipe(j(I=>{const O=[],H=Vs(I.native);O.push({symbol:s,name:s,amount:se.fromRaw(H.amount,o,s),isNative:!0,decimals:o});for(const x of I.tokens){const E=x.symbol??"ERC20",V=x.decimals??0;O.push({symbol:E,name:x.name??E,amount:se.fromRaw(Ui(x.amount),V,E),isNative:!1,decimals:V,icon:x.icon,contractAddress:x.contractAddress})}return O}))});return n._tokenBalanceSources.set(r,{source:w,refCount:1,stopAll:w.stop}),w}const f=yield*At(null),h=yield*At(0),m=tn(h,w=>w+1).pipe(Ae),y=w=>{const I=[],O=Vs(w.native);I.push({symbol:s,name:s,amount:se.fromRaw(O.amount,o,s),isNative:!0,decimals:o});for(const H of w.tokens){const x=H.symbol??"ERC20",E=H.decimals??0;I.push({symbol:x,name:H.name??x,amount:se.fromRaw(Ui(H.amount),E,x),isNative:!1,decimals:E,icon:H.icon,contractAddress:H.contractAddress})}return I},b=yield*Le({name:`ethwallet.${n.chainId}.tokenBalances.dep`,dependsOn:l.ref,hasChanged:AS,fetch:(w,I)=>n.fetchTokenBalances(t,F3(w),I).pipe(j(y),Ie(O=>Ot(f,O)))}),_=(yield*l.get)===null,T=yield*Te({name:`ethwallet.${n.chainId}.tokenBalances.poll`,interval:ie(n.pollingInterval),immediate:_,fetch:$(function*(){const w=yield*l.get,I=yield*Mt(f);if(w!==null&&I!==null)return I;const O=yield*n.fetchTokenBalances(t,[],!0),H=y(O);return yield*Ot(f,H),H})}),C=[],v=w=>it(w.pipe(fs(()=>m),hr));C.push(yield*v(b.changes)),C.push(yield*v(T.changes));const k=yield*Le({name:`ethwallet.${n.chainId}.tokenBalances`,dependsOn:h,hasChanged:(w,I)=>w!==I,fetch:()=>$(function*(){const w=yield*Mt(f);return w||(yield*It(new ct("[ethwallet] tokenBalances cache empty")))})}),R=$(function*(){for(const w of C)yield*xe(w);yield*b.stop,yield*T.stop,yield*k.stop,yield*l.stop});return n._tokenBalanceSources.set(r,{source:k,refCount:1,stopAll:R}),k}));n._tokenBalanceCreations.set(r,u);try{const l=await u;return i(l)}finally{n._tokenBalanceCreations.delete(r)}})}releaseSharedTokenBalanceSource(t){const n=this;return $(function*(){const r=n._tokenBalanceSources.get(t);r&&(r.refCount-=1,r.refCount<=0&&(yield*r.stopAll,n._tokenBalanceSources.delete(t)))})}getSharedTokenListSource(){const t=this;return t._tokenListSource?(t._tokenListSource.refCount+=1,z(t._tokenListSource.source)):t._tokenListCreation?W(async()=>{const n=await t._tokenListCreation;return t._tokenListSource&&(t._tokenListSource.refCount+=1),n}):W(async()=>{const n=Q($(function*(){const r=yield*Te({name:`ethwallet.${t.chainId}.tokenList`,fetch:t.fetchTokenList(!1),interval:ie(t.tokenListCacheTtl),immediate:!0});return t._tokenListSource={source:r,refCount:1,stopAll:r.stop},r}));t._tokenListCreation=n;try{return await n}finally{t._tokenListCreation=null}})}releaseSharedTokenListSource(){const t=this;return $(function*(){const n=t._tokenListSource;n&&(n.refCount-=1,n.refCount<=0&&(yield*n.stopAll,t._tokenListSource=null))})}fetchBalance(t,n=!1){return Z({url:`${this.baseUrl}/balance?address=${t}`,schema:g3,cacheStrategy:n?"ttl":"cache-first",cacheTtl:this.balanceCacheTtlMs,canCache:R3}).pipe(Ie(r=>{typeof r=="object"&&r!==null&&"success"in r&&qs("balance",r)}))}fetchNativeHistory(t,n=!1){return Z({url:`${this.baseUrl}/trans/normal/history`,method:"POST",body:{address:t.address,page:1,offset:t.limit??50},schema:w3,cacheStrategy:n?"ttl":"cache-first",cacheTtl:this.balanceCacheTtlMs,canCache:CS}).pipe(Ie(r=>qs("trans/normal/history",r)),X(r=>B3("trans/normal/history",r)))}fetchTokenHistory(t,n=!1){return t.contractAddress?Z({url:`${this.baseUrl}/trans/erc20/history`,method:"POST",body:{address:t.address,contractaddress:t.contractAddress,page:1,offset:t.limit??50},schema:v3,cacheStrategy:n?"ttl":"cache-first",cacheTtl:this.balanceCacheTtlMs,canCache:CS}).pipe(Ie(r=>qs("trans/erc20/history",r)),X(r=>M3("trans/erc20/history",r))):z({success:!0,result:{result:[]}})}fetchTokenBalances(t,n,r=!1){const s=[...n].sort();if(s.length===0){const o=this;return $(function*(){const i=yield*o.fetchTokenList(!1),c=RS(i),a=yield*o.fetchBalance(t,r);if(c.length===0)return{native:a,tokens:[]};const u=yield*Z({url:`${o.baseUrl}/account/balance/v2`,method:"POST",body:{address:t,contracts:c},schema:kS,cacheStrategy:r?"ttl":"cache-first",cacheTtl:o.balanceCacheTtlMs,canCache:IS}).pipe(Ie(l=>{Array.isArray(l)||qs("account/balance/v2",l)}),j($S),Ve(()=>z([])));return{native:a,tokens:u}})}return ze({native:this.fetchBalance(t,r),tokens:Z({url:`${this.baseUrl}/account/balance/v2`,method:"POST",body:{address:t,contracts:s},schema:kS,cacheStrategy:r?"ttl":"cache-first",cacheTtl:this.balanceCacheTtlMs,canCache:IS}).pipe(Ie(o=>{Array.isArray(o)||qs("account/balance/v2",o)}),j($S),Ve(()=>z([])))})}fetchTokenList(t=!1){return Z({url:`${this.baseUrl}/contract/tokens`,method:"POST",body:{page:1,pageSize:50,chain:"ETH"},schema:I3,cacheStrategy:t?"network-first":"ttl",cacheTtl:this.tokenListCacheTtl,canCache:A3}).pipe(Ie(n=>qs("contract/tokens",n)),j(N3))}}function FE(e,t){return e.type==="ethwallet-v1"?new xE(e,t):null}const H3=A({success:ve,result:S(De(g,N))}),D3=De(H3,g,N),U3=A({txID:g,from:g,to:g,amount:De(g,N),timestamp:N,contractRet:S(g),blockNumber:S(De(g,N)),fee:S(De(g,N))}),K3=A({txID:g,from:g,to:g,value:De(g,N),timestamp:N,tokenSymbol:S(g),token_symbol:S(g),tokenName:S(g),token_name:S(g),tokenDecimal:S(N),token_decimals:S(N),contractAddress:S(g),token_address:S(g),contractRet:S(g)}),j3=A({success:ve,data:S(ue(U3)),fingerprint:S(g),pageSize:S(N)}),z3=A({success:ve,data:S(ue(K3)),fingerprint:S(g),pageSize:S(N)}),NE=A({amount:De(g,N),contractAddress:S(g),decimals:S(N),icon:S(g),symbol:S(g),name:S(g)}),V3=ue(NE),q3=A({success:ve,result:S(ue(NE))}),OS=De(V3,q3),W3=A({chain:S(g),address:g,name:g,icon:S(g),symbol:g,decimals:N}),J3=A({data:ue(W3),page:N,pageSize:N,total:N,pages:S(N)}),G3=A({success:ve,result:J3}),Y3=A({from:g,to:g,state:S(De(g,N)),createdTime:De(g,N),txHash:g,value:De(g,N),assetSymbol:S(g),fee:S(De(g,N)),extra:S(Ll)}),Q3=ue(Y3),X3=Ll;function nt(e){return typeof e=="object"&&e!==null}function Z3(e,t){const n=Ir(e),r=yo.sign(n,t,{prehash:!1,format:"recovered"}),s=r[0],o=r.subarray(1),i=(s+27).toString(16).padStart(2,"0");return`${$r(o)}${i}`}function Zr(e){return e==null?"0":String(e)}function Df(e){try{return rr(e)}catch{return e.toLowerCase()}}function Uf(e,t,n){const r=Df(e),s=Df(t),o=Df(n);return r===o&&s===o?"self":r===o?"out":"in"}function eq(e){if(typeof e=="string"){const t=e.toLowerCase();return t.includes("success")||t.includes("confirm")?"confirmed":t.includes("fail")?"failed":"pending"}return typeof e=="number"&&e>=2?"confirmed":"pending"}function tq(e,t){const n=new Map;for(const r of e)n.set(r.hash,r);for(const r of t){const s=n.get(r.hash);if(s){s.assets=[...s.assets,...r.assets],n.set(r.hash,s);continue}n.set(r.hash,r)}return Array.from(n.values()).sort((r,s)=>s.timestamp-r.timestamp)}function BE(e){if(typeof e!="string")return null;const t=e.trim();if(!t)return null;const n=t.startsWith("0x")?t.slice(2):t;if(!/^[0-9a-fA-F]+$/.test(n)||n.length%2!==0)return t;try{return new TextDecoder().decode(Ir(n)).trim()||t}catch{return t}}function nq(e){if(!nt(e))return"Unknown error";const t=[e.message,e.code,e.error];nt(e.result)&&t.push(e.result.message,e.result.code,e.result.error);for(const n of t){const r=BE(n);if(r)return r}return"Unknown error"}function PS(e){if(!nt(e))return"Unknown error";const t=nt(e.error)?e.error:null,n=nt(e.result)?e.result:null,r=n&&nt(n.error)?n.error:null,s=nt(e.data)?e.data:null,o=s&&nt(s.error)?s.error:null,i=[t?.message,t?.info,t?.code,e.message,e.code,n?.message,n?.code,r?.message,r?.info,r?.code,s?.message,s?.code,o?.message,o?.info,o?.code];for(const c of i){const a=BE(c);if(a)return a}return"Unknown error"}function rq(e){return nt(e)?typeof e.result=="boolean"?e.result:typeof e.success=="boolean"?e.success:!1:!1}function sq(e){return nt(e)&&nt(e.signedTx)?e:{signedTx:e,detail:{from:"",to:"",amount:"0",fee:"0",assetSymbol:""},isToken:!1}}function xS(e){if(!nt(e))return null;if(typeof e.txID=="string")return e;if(nt(e.transaction)&&typeof e.transaction.txID=="string")return e.transaction;if(nt(e.result)){if(typeof e.result.txID=="string")return e.result;if(nt(e.result.transaction)&&typeof e.result.transaction.txID=="string")return e.result.transaction}if(nt(e.data)){if(typeof e.data.txID=="string")return e.data;if(nt(e.data.transaction)&&typeof e.data.transaction.txID=="string")return e.data.transaction}return null}function oq(e){return nt(e)?Object.keys(e).length>0:!1}function Kf(e){return Promise.resolve(e.success)}function iq(e){return typeof e=="string"||typeof e=="number"?Promise.resolve(!0):Promise.resolve(e.success)}function FS(e){return typeof e=="string"||typeof e=="number"?{success:!0,amount:Zr(e)}:{success:e.success,amount:Zr(e.result)}}function NS(e){return Array.isArray(e)?Promise.resolve(!0):Promise.resolve(e.success)}function BS(e){return Array.isArray(e)?e:e.result??[]}function Ws(e,t){t.success}function cq(e){const t=new Set;for(const n of e)for(const r of n.assets)r.assetType==="token"&&r.contractAddress&&t.add(r.contractAddress);return[...t].sort()}function MS(e,t){return!e||e.length!==t.length?!0:e.length===0&&t.length===0?!1:e[0]?.hash!==t[0]?.hash}function LS(e){return e.success?e.result.data.map(t=>t.address).filter(t=>t.length>0).map(t=>mt(t)).sort():[]}class aq{chainId;type;endpoint;config;constructor(t,n){this.type=t.type,this.endpoint=t.endpoint,this.config=t.config,this.chainId=n}}function HS(e,t){const n=Math.max(e.length,0);return(BigInt(Math.floor(n/2)+68)*1000n+(t?10000000n:0n)).toString()}class ME extends vE(TE(aq)){symbol;decimals;baseUrl;pollingInterval=3e4;tokenListCacheTtl=600*1e3;_eventBus=null;_txHistorySources=new Map;_txHistoryCreations=new Map;_balanceSources=new Map;_balanceCreations=new Map;_tokenBalanceSources=new Map;_tokenBalanceCreations=new Map;_tokenListSource=null;_tokenListCreation=null;get pendingTxCacheTtl(){return Math.max(1e3,Math.floor(this.pollingInterval/4))}nativeBalance;tokenBalances;transactionHistory;transaction;constructor(t,n){super(t,n),this.symbol=le.getSymbol(n),this.decimals=le.getDecimals(n),this.baseUrl=this.endpoint;const r=this;this.transactionHistory=Se(`tronwallet.${n}.transactionHistory`,s=>r.createTransactionHistorySource(s)),this.nativeBalance=Se(`tronwallet.${n}.nativeBalance`,s=>r.createBalanceSource(s)),this.tokenBalances=Se(`tronwallet.${n}.tokenBalances`,s=>r.createTokenBalancesSource(s)),this.transaction=Se(`tronwallet.${n}.transaction`,s=>r.createTransactionSource(s))}createTransactionHistorySource(t){return this.getSharedTxHistorySource(t.address)}createBalanceSource(t){return this.getSharedBalanceSource(t.address)}createTokenBalancesSource(t){return this.getSharedTokenBalanceSource(t.address)}createTransactionSource(t){const n=this,r=this.symbol,s=this.decimals;return $(function*(){const o=$(function*(){const[c,a]=yield*ze([n.fetchTransactionReceipt(t.txHash),t.senderId?n.fetchPendingTransactions(t.senderId):z([])]),u=a.find(f=>f.txHash===t.txHash),l=oq(c);if(u){const f=mt(u.from),h=mt(u.to);return{hash:u.txHash,from:f,to:h,timestamp:Number(u.createdTime)||Date.now(),status:l?"confirmed":eq(u.state),action:"transfer",direction:Uf(u.from,u.to,t.senderId??f),assets:[{assetType:"native",value:Zr(u.value),symbol:r,decimals:s}]}}if(l){const f=t.senderId?mt(t.senderId):"";return{hash:t.txHash,from:f,to:"",timestamp:Date.now(),status:"confirmed",action:"transfer",direction:f?"out":"in",assets:[{assetType:"native",value:"0",symbol:r,decimals:s}]}}return null});return yield*Te({name:`tronwallet.${n.chainId}.transaction`,fetch:o,interval:ie(3e3)})})}async buildTransaction(t){if(t.type!=="transfer")throw new de(ge.NOT_SUPPORTED,`Transaction type not supported: ${t.type}`);const n=t,r=er(n.from),s=er(n.to),o=!!n.fee,i=n.fee?.toRawString()??"0",c=n.tokenAddress?.trim(),a=!!c;let u=this.symbol;if(c)try{u=await this.resolveTokenSymbol(c)}catch(y){console.warn("[tronwallet] resolveTokenSymbol failed",y),u=c}if(a&&c){const y=er(c),b=o&&Number.isFinite(Number(i))?Number(i):1e8,_=await Q(po({url:`${this.baseUrl}/trans/contract`,method:"POST",body:{owner_address:r,contract_address:y,function_selector:"transfer(address,uint256)",input:[{type:"address",value:s},{type:"uint256",value:n.amount.toRawString()}],fee_limit:b,call_value:0}})),T=this.extractTrc20Transaction(_),C=o?i:HS(T.raw_data_hex??"",!0),v={from:r,to:s,amount:n.amount.toRawString(),fee:C,assetSymbol:u};return{chainId:this.chainId,intentType:"transfer",data:{rawTx:T,detail:v,isToken:!0}}}const l=await Q(po({url:`${this.baseUrl}/trans/create`,method:"POST",body:{owner_address:r,to_address:s,amount:Number(n.amount.raw),extra_data:n.memo}})),f=this.extractNativeTransaction(l),h=o?i:HS(f.raw_data_hex??"",!1),m={from:r,to:s,amount:n.amount.toRawString(),fee:h,assetSymbol:u};return{chainId:this.chainId,intentType:"transfer",data:{rawTx:f,detail:m,isToken:!1}}}async signTransaction(t,n){if(!n.privateKey)throw new de(ge.SIGNATURE_FAILED,"privateKey is required for Tron signing");const r=t.data,s=Z3(r.rawTx.txID,n.privateKey),o={...r.rawTx,signature:[s]};return{chainId:t.chainId,data:{signedTx:o,detail:r.detail,isToken:r.isToken},signature:s}}async broadcastTransaction(t){const n=sq(t.data),r=n.isToken?`${this.baseUrl}/trans/trc20/broadcast`:`${this.baseUrl}/trans/broadcast`,s=n.detail.assetSymbol?{...n.signedTx,detail:n.detail}:n.signedTx,o=await Q(po({url:r,method:"POST",body:s}));if(!rq(o)){const i=nq(o);throw new de(ge.TX_BROADCAST_FAILED,`Broadcast failed: ${i}`,nt(o)?{provider:this.type,response:o,reason:i}:{provider:this.type,reason:i})}return nt(o)&&typeof o.txid=="string"&&o.txid.length>0?o.txid:n.signedTx.txID}getSharedTxHistorySource(t){const n=this,r=mt(t),s=rr(t),o=this.symbol,i=this.decimals,c=l=>({...l,stop:n.releaseSharedTxHistorySource(s)}),a=n._txHistorySources.get(s);if(a)return a.refCount+=1,z(c(a.source));const u=n._txHistoryCreations.get(s);return W(u?async()=>{const l=await u,f=n._txHistorySources.get(s);return f&&(f.refCount+=1),c(l)}:async()=>{const l=Q($(function*(){n._eventBus||(n._eventBus=yield*En());const f=n._eventBus,h=yield*Te({name:`tronwallet.${n.chainId}.txHistory.native.${s}`,fetch:n.fetchNativeHistory({address:r,limit:50},!0),interval:ie(n.pollingInterval),walletEvents:{eventBus:f,chainId:n.chainId,address:r,types:["tx:confirmed","tx:sent"]}}),m=yield*n.getSharedTokenListSource(),y=yield*At(0),b=tn(y,x=>x+1).pipe(Ae),_=yield*At(new Map),T=[],C=x=>it(x.pipe(fs(()=>b),hr));T.push(yield*C(h.changes));const v=new Map,k=new Map,R=x=>$(function*(){if(v.has(x))return;const E=yield*Te({name:`tronwallet.${n.chainId}.txHistory.trc20.${s}.${x}`,fetch:n.fetchTrc20History({address:r,limit:50,contractAddress:x},!0),interval:ie(n.pollingInterval),immediate:!1,walletEvents:{eventBus:f,chainId:n.chainId,address:r,types:["tx:confirmed","tx:sent"]}});v.set(x,E);const V=yield*it(E.changes.pipe(Wn(q=>tn(_,D=>{const B=new Map(D);return B.set(x,q),B}).pipe(Ce(b)))));k.set(x,V),yield*it(E.refresh.pipe(Ae))}),w=x=>$(function*(){const E=v.get(x);E&&(yield*E.stop,v.delete(x));const V=k.get(x);V&&(yield*xe(V),k.delete(x)),yield*tn(_,q=>{const D=new Map(q);return D.delete(x),D}).pipe(Ce(b))}),I=x=>$(function*(){const E=x?LS(x):[],V=new Set(E);for(const q of v.keys())V.has(q)||(yield*w(q));for(const q of V)v.has(q)||(yield*R(q))});yield*I(yield*m.get),T.push(yield*it(m.changes.pipe(Wn(x=>I(x).pipe(Ce(b))))));const O=yield*Le({name:`tronwallet.${n.chainId}.txHistory.${s}`,dependsOn:y,hasChanged:(x,E)=>x!==E,fetch:()=>$(function*(){const E=((yield*h.get)?.data??[]).map(D=>{const B=mt(D.from),F=mt(D.to),ce=D.contractRet==="SUCCESS"?"confirmed":"failed";return{hash:D.txID,from:B,to:F,timestamp:D.timestamp,status:ce,blockNumber:D.blockNumber?BigInt(String(D.blockNumber)):void 0,action:"transfer",direction:Uf(D.from,D.to,r),assets:[{assetType:"native",value:Zr(D.amount),symbol:o,decimals:i}],fee:D.fee!==void 0?{value:Zr(D.fee),symbol:o,decimals:i}:void 0}}),q=[...(yield*Mt(_)).values()].flatMap(D=>(D?.data??[]).map(B=>{const F=mt(B.from),ce=mt(B.to),je=B.contractRet?B.contractRet==="SUCCESS"?"confirmed":"failed":"confirmed",qt=B.tokenSymbol??B.token_symbol??"TRC20",Bs=B.tokenDecimal??B.token_decimals??0,_r=B.contractAddress??B.token_address,zE=_r?mt(_r):"";return{hash:B.txID,from:F,to:ce,timestamp:B.timestamp,status:je,action:"transfer",direction:Uf(B.from,B.to,r),assets:[{assetType:"token",value:Zr(B.value),symbol:qt,decimals:Bs,contractAddress:zE,name:B.tokenName??B.token_name}]}}));return tq(E,q)})}),H=$(function*(){for(const x of T)yield*xe(x);for(const x of v.values())yield*x.stop;for(const x of k.values())yield*xe(x);yield*O.stop,yield*h.stop,yield*n.releaseSharedTokenListSource()});return n._txHistorySources.set(s,{source:O,refCount:1,stopAll:H}),O}));n._txHistoryCreations.set(s,l);try{const f=await l;return c(f)}finally{n._txHistoryCreations.delete(s)}})}releaseSharedTxHistorySource(t){const n=this;return $(function*(){const r=n._txHistorySources.get(t);r&&(r.refCount-=1,r.refCount<=0&&(yield*r.stopAll,n._txHistorySources.delete(t)))})}getSharedBalanceSource(t){const n=this,r=rr(t),s=this.symbol,o=this.decimals,i=u=>({...u,stop:n.releaseSharedBalanceSource(r)}),c=n._balanceSources.get(r);if(c)return c.refCount+=1,z(i(c.source));const a=n._balanceCreations.get(r);return W(a?async()=>{const u=await a,l=n._balanceSources.get(r);return l&&(l.refCount+=1),i(u)}:async()=>{const u=Q($(function*(){const l=yield*n.getSharedTxHistorySource(t),f=yield*Le({name:`tronwallet.${n.chainId}.balance`,dependsOn:l.ref,hasChanged:MS,fetch:(m,y)=>n.fetchBalance(t,y).pipe(j(b=>{const _=FS(b);return{amount:se.fromRaw(_.amount,o,s),symbol:s}}))}),h=ze([f.stop,l.stop]).pipe(Ae);return n._balanceSources.set(r,{source:f,refCount:1,stopAll:h}),f}));n._balanceCreations.set(r,u);try{const l=await u;return i(l)}finally{n._balanceCreations.delete(r)}})}releaseSharedBalanceSource(t){const n=this;return $(function*(){const r=n._balanceSources.get(t);r&&(r.refCount-=1,r.refCount<=0&&(yield*r.stopAll,n._balanceSources.delete(t)))})}getSharedTokenBalanceSource(t){const n=this,r=rr(t),s=this.symbol,o=this.decimals,i=u=>({...u,stop:n.releaseSharedTokenBalanceSource(r)}),c=n._tokenBalanceSources.get(r);if(c)return c.refCount+=1,z(i(c.source));const a=n._tokenBalanceCreations.get(r);return W(a?async()=>{const u=await a,l=n._tokenBalanceSources.get(r);return l&&(l.refCount+=1),i(u)}:async()=>{const u=Q($(function*(){const l=yield*n.getSharedTxHistorySource(t),f=yield*Le({name:`tronwallet.${n.chainId}.tokenBalances`,dependsOn:l.ref,hasChanged:MS,fetch:(m,y)=>n.fetchTokenBalances(t,cq(m),y).pipe(j(b=>{const _=[],T=FS(b.native);_.push({symbol:s,name:s,amount:se.fromRaw(T.amount,o,s),isNative:!0,decimals:o});for(const C of b.tokens){const v=C.symbol??"TRC20",k=C.decimals??0,R=C.contractAddress?mt(C.contractAddress):void 0;_.push({symbol:v,name:C.name??v,amount:se.fromRaw(Zr(C.amount),k,v),isNative:!1,decimals:k,icon:C.icon,contractAddress:R})}return _}))}),h=ze([f.stop,l.stop]).pipe(Ae);return n._tokenBalanceSources.set(r,{source:f,refCount:1,stopAll:h}),f}));n._tokenBalanceCreations.set(r,u);try{const l=await u;return i(l)}finally{n._tokenBalanceCreations.delete(r)}})}releaseSharedTokenBalanceSource(t){const n=this;return $(function*(){const r=n._tokenBalanceSources.get(t);r&&(r.refCount-=1,r.refCount<=0&&(yield*r.stopAll,n._tokenBalanceSources.delete(t)))})}getSharedTokenListSource(){const t=this;return t._tokenListSource?(t._tokenListSource.refCount+=1,z(t._tokenListSource.source)):t._tokenListCreation?W(async()=>{const n=await t._tokenListCreation;return t._tokenListSource&&(t._tokenListSource.refCount+=1),n}):W(async()=>{const n=Q($(function*(){const r=yield*Te({name:`tronwallet.${t.chainId}.tokenList`,fetch:t.fetchTokenList(!1),interval:ie(t.tokenListCacheTtl),immediate:!0});return t._tokenListSource={source:r,refCount:1,stopAll:r.stop},r}));t._tokenListCreation=n;try{return await n}finally{t._tokenListCreation=null}})}releaseSharedTokenListSource(){const t=this;return $(function*(){const n=t._tokenListSource;n&&(n.refCount-=1,n.refCount<=0&&(yield*n.stopAll,t._tokenListSource=null))})}fetchBalance(t,n=!1){return Z({url:`${this.baseUrl}/balance`,method:"GET",searchParams:{address:er(t)},schema:D3,cacheStrategy:n?"network-first":"cache-first",canCache:iq}).pipe(Ie(r=>{typeof r=="object"&&r!==null&&"success"in r&&Ws("balance",r)}))}fetchNativeHistory(t,n=!1){return Z({url:`${this.baseUrl}/trans/common/history`,method:"POST",body:{address:er(t.address),limit:t.limit??50},schema:j3,cacheStrategy:n?"network-first":"cache-first",canCache:Kf}).pipe(Ie(r=>Ws("trans/common/history",r)))}fetchTrc20History(t,n=!1){return t.contractAddress?Z({url:`${this.baseUrl}/trans/trc20/history`,method:"POST",body:{address:er(t.address),limit:t.limit??50,contract_address:mt(t.contractAddress)},schema:z3,cacheStrategy:n?"network-first":"cache-first",canCache:Kf}).pipe(Ie(r=>Ws("trans/trc20/history",r))):z({success:!0,data:[],fingerprint:"",pageSize:0})}fetchTransactions(t,n=!1){return ze({native:this.fetchNativeHistory(t,n),trc20:this.fetchTrc20History(t,n).pipe(Ve(()=>z({success:!1,data:[]})))})}fetchTokenBalances(t,n,r=!1){const s=mt(t),o=[...n].sort();if(o.length===0){const i=this;return $(function*(){const c=yield*i.fetchTokenList(!1),a=LS(c),u=yield*i.fetchBalance(t,r);if(a.length===0)return{native:u,tokens:[]};const l=yield*Z({url:`${i.baseUrl}/account/balance/v2`,method:"POST",body:{address:s,contracts:a},schema:OS,cacheStrategy:r?"network-first":"cache-first",canCache:NS}).pipe(Ie(f=>{Array.isArray(f)||Ws("account/balance/v2",f)}),j(BS),Ve(()=>z([])));return{native:u,tokens:l}})}return ze({native:this.fetchBalance(t,r),tokens:Z({url:`${this.baseUrl}/account/balance/v2`,method:"POST",body:{address:s,contracts:o},schema:OS,cacheStrategy:r?"network-first":"cache-first",canCache:NS}).pipe(Ie(i=>{Array.isArray(i)||Ws("account/balance/v2",i)}),j(BS),Ve(()=>z([])))})}fetchTokenList(t=!1){return Z({url:`${this.baseUrl}/contract/tokens`,method:"POST",body:{page:1,pageSize:50,chain:"TRON"},schema:G3,cacheStrategy:t?"network-first":"ttl",cacheTtl:this.tokenListCacheTtl,canCache:Kf}).pipe(Ie(n=>Ws("contract/tokens",n)))}async resolveTokenSymbol(t){const n=t.trim();if(!n)return t;const r=rr(n);return(await Q(this.fetchTokenList(!1))).result.data.find(i=>i.address&&rr(i.address)===r)?.symbol??t}extractTrc20Transaction(t){const n=xS(t);if(n)return n;const r=PS(t);throw new de(ge.TX_BUILD_FAILED,`TRC20 transaction build failed: ${r}`,nt(t)?{provider:this.type,response:t,reason:r}:{provider:this.type,reason:r})}extractNativeTransaction(t){const n=xS(t);if(n)return n;const r=PS(t);throw new de(ge.TX_BUILD_FAILED,`Failed to create Tron transaction: ${r}`,nt(t)?{provider:this.type,response:t,reason:r}:{provider:this.type,reason:r})}fetchPendingTransactions(t){return Z({url:`${this.baseUrl}/trans/pending`,method:"POST",body:{address:er(t),assetSymbol:this.symbol},schema:Q3,cacheStrategy:"ttl",cacheTtl:this.pendingTxCacheTtl})}fetchTransactionReceipt(t){return Z({url:`${this.baseUrl}/trans/receipt`,method:"POST",body:{txId:t},schema:X3,cacheStrategy:"ttl",cacheTtl:this.pendingTxCacheTtl})}}function LE(e,t){return e.type==="tronwallet-v1"?new ME(e,t):null}const uq=A({txid:g,vin:S(ue(A({addresses:S(ue(g))}))),vout:S(ue(A({addresses:S(ue(g)),value:S(g)}))),blockTime:S(N),confirmations:S(N)}),lq=A({balance:g,txs:S(N),transactions:S(ue(uq))}),fq=A({success:ve,result:S(lq)}),hq=A({txid:g,vin:S(ue(A({addresses:S(ue(g))}))),vout:S(ue(A({addresses:S(ue(g)),value:S(g)}))),blockTime:S(N),confirmations:S(N),blockHeight:S(N)}),dq=A({success:ve,result:S(hq)}),pq=A({txid:g,vout:N,value:De(g,N),scriptPubKey:S(g)}),mq=A({success:ve,result:S(ue(pq))}),gq=A({success:ve,result:S(De(g,N))}),yq=A({success:ve,result:S(g)});function DS(e,t,n){const r=e?.some(o=>o.addresses?.includes(n)),s=t?.some(o=>o.addresses?.includes(n));return r&&s?"self":r?"out":"in"}function Sq(e,t){return!e||e.length!==t.length?!0:e.length===0&&t.length===0?!1:e[0]?.hash!==t[0]?.hash}function bq(e){return e.result??{balance:"0",transactions:[]}}function ua(e){return Promise.resolve(e.success)}function jf(e,t){return t.success&&t.result!==void 0?z(t.result):It(new ct(`[btcwallet] ${e} failed`))}function _q(e,t){return t.success?z(t.result??null):It(new ct(`[btcwallet] ${e} failed`))}function _i(e,t){t.success}class wq{chainId;type;endpoint;config;constructor(t,n){this.type=t.type,this.endpoint=t.endpoint,this.config=t.config,this.chainId=n}}class HE extends $E(AE(wq)){symbol;decimals;baseUrl;pollingInterval=6e4;_eventBus=null;_txHistorySources=new Map;_txHistoryCreations=new Map;_balanceSources=new Map;_balanceCreations=new Map;_transactionSources=new Map;_transactionCreations=new Map;nativeBalance;transactionHistory;transaction;constructor(t,n){super(t,n),this.symbol=le.getSymbol(n),this.decimals=le.getDecimals(n),this.baseUrl=this.endpoint;const r=this;this.transactionHistory=Se(`btcwallet.${n}.transactionHistory`,s=>r.createTransactionHistorySource(s)),this.nativeBalance=Se(`btcwallet.${n}.nativeBalance`,s=>r.createBalanceSource(s)),this.transaction=Se(`btcwallet.${n}.transaction`,s=>r.createTransactionSource(s))}createTransactionHistorySource(t){return this.getSharedTxHistorySource(t.address)}createBalanceSource(t){return this.getSharedBalanceSource(t.address)}createTransactionSource(t){return this.getSharedTransactionSource(t.txHash,t.senderId)}getSharedTxHistorySource(t){const n=this,r=t,s=this.symbol,o=this.decimals,i=u=>({...u,stop:n.releaseSharedTxHistorySource(r)}),c=n._txHistorySources.get(r);if(c)return c.refCount+=1,z(i(c.source));const a=n._txHistoryCreations.get(r);return W(a?async()=>{const u=await a,l=n._txHistorySources.get(r);return l&&(l.refCount+=1),i(u)}:async()=>{const u=Q($(function*(){n._eventBus||(n._eventBus=yield*En());const l=n._eventBus,f=n.fetchAddressInfo(t,!0).pipe(j(y=>(y.transactions??[]).map(b=>({hash:b.txid,from:b.vin?.[0]?.addresses?.[0]??"",to:b.vout?.[0]?.addresses?.[0]??"",timestamp:(b.blockTime??0)*1e3,status:(b.confirmations??0)>0?"confirmed":"pending",action:"transfer",direction:DS(b.vin,b.vout,t),assets:[{assetType:"native",value:b.vout?.[0]?.value??"0",symbol:s,decimals:o}]})))),h=yield*Te({name:`btcwallet.${n.chainId}.txHistory.${r}`,fetch:f,interval:ie(n.pollingInterval),walletEvents:{eventBus:l,chainId:n.chainId,address:t,types:["tx:confirmed","tx:sent"]}}),m=h.stop;return n._txHistorySources.set(r,{source:h,refCount:1,stopAll:m}),h}));n._txHistoryCreations.set(r,u);try{const l=await u;return i(l)}finally{n._txHistoryCreations.delete(r)}})}releaseSharedTxHistorySource(t){const n=this;return $(function*(){const r=n._txHistorySources.get(t);r&&(r.refCount-=1,r.refCount<=0&&(yield*r.stopAll,n._txHistorySources.delete(t)))})}getSharedBalanceSource(t){const n=this,r=t,s=this.symbol,o=this.decimals,i=u=>({...u,stop:n.releaseSharedBalanceSource(r)}),c=n._balanceSources.get(r);if(c)return c.refCount+=1,z(i(c.source));const a=n._balanceCreations.get(r);return W(a?async()=>{const u=await a,l=n._balanceSources.get(r);return l&&(l.refCount+=1),i(u)}:async()=>{const u=Q($(function*(){const l=yield*n.getSharedTxHistorySource(t),f=yield*Le({name:`btcwallet.${n.chainId}.balance`,dependsOn:l.ref,hasChanged:Sq,fetch:(m,y)=>n.fetchAddressInfo(t,y).pipe(j(b=>({amount:se.fromRaw(b.balance,o,s),symbol:s})))}),h=ze([f.stop,l.stop]).pipe(Ae);return n._balanceSources.set(r,{source:f,refCount:1,stopAll:h}),f}));n._balanceCreations.set(r,u);try{const l=await u;return i(l)}finally{n._balanceCreations.delete(r)}})}releaseSharedBalanceSource(t){const n=this;return $(function*(){const r=n._balanceSources.get(t);r&&(r.refCount-=1,r.refCount<=0&&(yield*r.stopAll,n._balanceSources.delete(t)))})}getSharedTransactionSource(t,n){const r=this,s=n?`${t}:${n}`:t,o=this.symbol,i=this.decimals,c=l=>({...l,stop:r.releaseSharedTransactionSource(s)}),a=r._transactionSources.get(s);if(a)return a.refCount+=1,z(c(a.source));const u=r._transactionCreations.get(s);return W(u?async()=>{const l=await u,f=r._transactionSources.get(s);return f&&(f.refCount+=1),c(l)}:async()=>{const l=Q($(function*(){const f=r.fetchTransactionDetail(t,!0).pipe(j(y=>{if(!y)return null;const b=n?DS(y.vin,y.vout,n):"self";return{hash:y.txid,from:y.vin?.[0]?.addresses?.[0]??"",to:y.vout?.[0]?.addresses?.[0]??"",timestamp:(y.blockTime??0)*1e3,status:(y.confirmations??0)>0?"confirmed":"pending",action:"transfer",direction:b,assets:[{assetType:"native",value:y.vout?.[0]?.value??"0",symbol:o,decimals:i}]}})),h=yield*Te({name:`btcwallet.${r.chainId}.transaction.${s}`,fetch:f,interval:ie(r.pollingInterval)}),m=h.stop;return r._transactionSources.set(s,{source:h,refCount:1,stopAll:m}),h}));r._transactionCreations.set(s,l);try{const f=await l;return c(f)}finally{r._transactionCreations.delete(s)}})}releaseSharedTransactionSource(t){const n=this;return $(function*(){const r=n._transactionSources.get(t);r&&(r.refCount-=1,r.refCount<=0&&(yield*r.stopAll,n._transactionSources.delete(t)))})}fetchAddressInfo(t,n=!1){const r=`/api/v2/address/${t}?page=1&pageSize=50&details=txs`;return Z({url:this.baseUrl,method:"POST",body:{url:r,method:"GET"},schema:fq,cacheStrategy:n?"ttl":"cache-first",cacheTtl:5e3,canCache:ua}).pipe(Ie(s=>_i("blockbook/address",s)),j(bq))}fetchTransactionDetail(t,n=!1){const r=`/api/v2/tx/${t}`;return Z({url:this.baseUrl,method:"POST",body:{url:r,method:"GET"},schema:dq,cacheStrategy:n?"ttl":"cache-first",cacheTtl:5e3,canCache:ua}).pipe(Ie(s=>_i("blockbook/tx",s)),X(s=>_q("blockbook/tx",s)))}fetchUtxos(t,n=!1){const r=`/api/v2/utxo/${t}`;return Z({url:this.baseUrl,method:"POST",body:{url:r,method:"GET"},schema:mq,cacheStrategy:n?"ttl":"cache-first",cacheTtl:15e3,canCache:ua}).pipe(Ie(s=>_i("blockbook/utxo",s)),X(s=>jf("blockbook/utxo",s)))}fetchFeeRate(t=6,n=!1){const r=`/api/v2/estimatefee/${t}`;return Z({url:this.baseUrl,method:"POST",body:{url:r,method:"GET"},schema:gq,cacheStrategy:n?"ttl":"cache-first",cacheTtl:3e4,canCache:ua}).pipe(Ie(s=>_i("blockbook/estimatefee",s)),X(s=>jf("blockbook/estimatefee",s)),j(s=>String(s)))}broadcastRawTransaction(t){const n=`/api/v2/sendtx/${t}`;return Z({url:this.baseUrl,method:"POST",body:{url:n,method:"GET"},schema:yq,cacheStrategy:"network-first",cacheTtl:0,canCache:async()=>!1}).pipe(Ie(r=>_i("blockbook/sendtx",r)),X(r=>jf("blockbook/sendtx",r)))}async buildTransaction(t){if(t.type!=="transfer")throw new Error(`Transaction type not supported: ${t.type}`);const n=t,r=await Q(this.fetchUtxos(n.from,!0));if(r.length===0)throw new Error("No UTXOs available");const s=await Q(this.fetchFeeRate(6,!0)),o=Number(s),i=Number.isFinite(o)?o*1e8:0,c=i>0?Math.ceil(i/1e3):1,a=r.reduce((y,b)=>y+Number(b.value),0),u=Number(n.amount.raw),l=10+r.length*68+62,f=c*l;if(a<u+f)throw new Error(`Insufficient balance: need ${u+f}, have ${a}`);const h=a-u-f,m={inputs:r.map(y=>({txid:y.txid,vout:y.vout,value:Number(y.value),scriptPubKey:y.scriptPubKey??""})),outputs:[{address:n.to,value:u}],fee:f,changeAddress:n.from};return h>546&&m.outputs.push({address:n.from,value:h}),{chainId:this.chainId,intentType:"transfer",data:m}}async estimateFee(t){const n=await Q(this.fetchFeeRate(6,!0)),r=Number(n),s=Number.isFinite(r)?r*1e8:0,o=s>0?Math.ceil(s/1e3):1,i=le.getConfig(this.chainId),a=BigInt(o*140),u={amount:se.fromRaw((a*80n/100n).toString(),i.decimals,i.symbol),estimatedTime:3600},l={amount:se.fromRaw(a.toString(),i.decimals,i.symbol),estimatedTime:1800},f={amount:se.fromRaw((a*120n/100n).toString(),i.decimals,i.symbol),estimatedTime:600};return{slow:u,standard:l,fast:f}}async broadcastTransaction(t){const n=t.data;return Q(this.broadcastRawTransaction(n))}}function DE(e,t){return e.type==="btcwallet-v1"?new HE(e,t):null}const vq={ethereum:"eth",binance:"bsc",polygon:"polygon",avalanche:"avalanche",fantom:"fantom",arbitrum:"arbitrum",optimism:"optimism",base:"base"},Tq=A({balance:g}),kq=A({transactionHash:g,blockNumber:g,status:S(g)}),Eq=A({jsonrpc:g,id:N,result:we(kq)}),Cq=A({token_address:g,symbol:g,name:g,decimals:N,balance:g,logo:S(we(g)),thumbnail:S(we(g)),possible_spam:S(ve),verified_contract:S(ve),total_supply:S(we(g)),security_score:S(we(N))}),Iq=ue(Cq),$q=A({from_address:g,to_address:g,value:g,value_formatted:S(we(g)),direction:S(Vc("send","receive")),token_symbol:S(we(g)),token_logo:S(we(g))}),Aq=A({from_address:g,to_address:g,value:g,value_formatted:S(we(g)),token_name:S(we(g)),token_symbol:S(we(g)),token_decimals:S(we(g)),token_logo:S(we(g)),address:g}),Rq=A({hash:g,from_address:g,to_address:we(g),value:g,block_timestamp:g,block_number:g,receipt_status:S(g),transaction_fee:S(g),category:S(g),summary:S(g),possible_spam:S(ve),from_address_entity:S(we(g)),to_address_entity:S(we(g)),native_transfers:S(ue($q)),erc20_transfers:S(ue(Aq))}),Oq=A({result:ue(Rq),cursor:S(we(g)),page:S(N),page_size:S(N)});function Pq(e,t,n){const r=e.toLowerCase(),s=t.toLowerCase(),o=n.toLowerCase();return r===o&&s===o?"self":r===o?"out":"in"}function xq(e){switch(e){case"send":case"receive":return"transfer";case"token send":case"token receive":return"transfer";case"nft send":case"nft receive":return"transfer";case"approve":return"approve";case"contract interaction":return"contract";default:return"transfer"}}function US(e,t){return!e||e.length!==t.length?!0:e.length===0&&t.length===0?!1:e[0]?.hash!==t[0]?.hash}const la=Mk(qd(5),2).pipe(Sm(bm(3)),YD(e=>e._tag==="RateLimitError"||e._tag==="HttpError"&&(e.status===429||e.status===401)));class Fq{chainId;type;endpoint;config;constructor(t,n){this.type=t.type,this.endpoint=t.endpoint,this.config=t.config,this.chainId=n}}class UE extends ci(ai(Fq)){symbol;decimals;moralisChain;apiKey;baseUrl;txStatusInterval;erc20Interval;rpcUrl;_eventBus=null;_txHistorySources=new Map;_txHistoryCreations=new Map;_balanceSources=new Map;_balanceCreations=new Map;_tokenBalanceSources=new Map;_tokenBalanceCreations=new Map;nativeBalance;tokenBalances;transactionHistory;transactionStatus;constructor(t,n){if(super(t,n),this.symbol=le.getSymbol(n),this.decimals=le.getDecimals(n),this.moralisChain=vq[n],!this.moralisChain)throw new Error(`[MoralisProviderEffect] Unsupported chain: ${n}`);this.baseUrl=this.endpoint;const r=Jl("MORALIS_API_KEY",`moralis-${n}`);if(!r)throw new Error("[MoralisProviderEffect] MORALIS_API_KEY is required");this.apiKey=r,this.txStatusInterval=this.config?.txStatusInterval??3e3,this.erc20Interval=this.config?.erc20Interval??12e4,this.rpcUrl=le.getRpcUrl(n);const s=this;this.transactionHistory=Se(`moralis.${n}.transactionHistory`,o=>s.createTransactionHistorySource(o)),this.nativeBalance=Se(`moralis.${n}.nativeBalance`,o=>s.createBalanceSource(o)),this.tokenBalances=Se(`moralis.${n}.tokenBalances`,o=>s.createTokenBalancesSource(o)),this.transactionStatus=Se(`moralis.${n}.transactionStatus`,o=>s.createTransactionStatusSource(o))}createTransactionHistorySource(t){return this.getSharedTxHistorySource(t.address)}createBalanceSource(t){return this.getSharedBalanceSource(t.address)}createTokenBalancesSource(t){return this.getSharedTokenBalanceSource(t.address)}getSharedTxHistorySource(t){const n=this,r=t.toLowerCase(),s=r,o=this.symbol,i=this.decimals,c=l=>({...l,stop:n.releaseSharedTxHistorySource(s)}),a=n._txHistorySources.get(s);if(a)return a.refCount+=1,z(c(a.source));const u=n._txHistoryCreations.get(s);return W(u?async()=>{const l=await u,f=n._txHistorySources.get(s);return f&&(f.refCount+=1),c(l)}:async()=>{const l=Q($(function*(){n._eventBus||(n._eventBus=yield*En());const f=n._eventBus,h=n.fetchWalletHistory({address:t,limit:50},!0).pipe(Zc(la),j(b=>b.result.filter(_=>!_.possible_spam).map(_=>{const T=Pq(_.from_address,_.to_address??"",r),C=xq(_.category),v=_.erc20_transfers&&_.erc20_transfers.length>0,k=_.native_transfers&&_.native_transfers.length>0,R=[];if(v)for(const w of _.erc20_transfers)R.push({assetType:"token",value:w.value,symbol:w.token_symbol??"Unknown",decimals:parseInt(w.token_decimals??"18",10),contractAddress:w.address,name:w.token_name,logoUrl:w.token_logo??void 0});if(k||R.length===0){const w=k?_.native_transfers[0].value:_.value;R.unshift({assetType:"native",value:w,symbol:o,decimals:i})}return{hash:_.hash,from:_.from_address,to:_.to_address??"",timestamp:new Date(_.block_timestamp).getTime(),status:_.receipt_status==="1"?"confirmed":"failed",blockNumber:BigInt(_.block_number),action:C,direction:T,assets:R,fee:_.transaction_fee?{value:_.transaction_fee,symbol:o,decimals:i}:void 0,fromEntity:_.from_address_entity??void 0,toEntity:_.to_address_entity??void 0,summary:_.summary}}))),m=yield*Te({name:`moralis.${n.chainId}.txHistory.${s}`,fetch:h,interval:ie(n.erc20Interval),walletEvents:{eventBus:f,chainId:n.chainId,address:t,types:["tx:confirmed","tx:sent"]}}),y=m.stop;return n._txHistorySources.set(s,{source:m,refCount:1,stopAll:y}),m}));n._txHistoryCreations.set(s,l);try{const f=await l;return c(f)}finally{n._txHistoryCreations.delete(s)}})}releaseSharedTxHistorySource(t){const n=this;return $(function*(){const r=n._txHistorySources.get(t);r&&(r.refCount-=1,r.refCount<=0&&(yield*r.stopAll,n._txHistorySources.delete(t)))})}getSharedBalanceSource(t){const n=this,r=t.toLowerCase(),s=this.symbol,o=this.decimals,i=u=>({...u,stop:n.releaseSharedBalanceSource(r)}),c=n._balanceSources.get(r);if(c)return c.refCount+=1,z(i(c.source));const a=n._balanceCreations.get(r);return W(a?async()=>{const u=await a,l=n._balanceSources.get(r);return l&&(l.refCount+=1),i(u)}:async()=>{const u=Q($(function*(){const l=yield*n.getSharedTxHistorySource(t),f=yield*Le({name:`moralis.${n.chainId}.balance`,dependsOn:l.ref,hasChanged:US,fetch:(m,y)=>n.fetchNativeBalance(t,y).pipe(Zc(la),j(b=>({amount:se.fromRaw(b.balance,o,s),symbol:s})))}),h=ze([f.stop,l.stop]).pipe(Ae);return n._balanceSources.set(r,{source:f,refCount:1,stopAll:h}),f}));n._balanceCreations.set(r,u);try{const l=await u;return i(l)}finally{n._balanceCreations.delete(r)}})}releaseSharedBalanceSource(t){const n=this;return $(function*(){const r=n._balanceSources.get(t);r&&(r.refCount-=1,r.refCount<=0&&(yield*r.stopAll,n._balanceSources.delete(t)))})}getSharedTokenBalanceSource(t){const n=this,r=t.toLowerCase(),s=this.symbol,o=this.decimals,i=this.chainId,c=l=>({...l,stop:n.releaseSharedTokenBalanceSource(r)}),a=n._tokenBalanceSources.get(r);if(a)return a.refCount+=1,z(c(a.source));const u=n._tokenBalanceCreations.get(r);return W(u?async()=>{const l=await u,f=n._tokenBalanceSources.get(r);return f&&(f.refCount+=1),c(l)}:async()=>{const l=Q($(function*(){const f=yield*n.getSharedTxHistorySource(t),h=ze({native:n.fetchNativeBalance(t),tokens:n.fetchTokenBalances(t)}).pipe(Zc(la),j(({native:b,tokens:_})=>{const T=[];T.push({symbol:s,name:s,amount:se.fromRaw(b.balance,o,s),isNative:!0,decimals:o});const C=_.filter(v=>!v.possible_spam);for(const v of C){const k=v.logo??v.thumbnail??le.getTokenIconByContract(i,v.token_address)??void 0;T.push({symbol:v.symbol,name:v.name,amount:se.fromRaw(v.balance,v.decimals,v.symbol),isNative:!1,decimals:v.decimals,icon:k,contractAddress:v.token_address,metadata:{possibleSpam:v.possible_spam,securityScore:v.security_score??void 0,verified:v.verified_contract,totalSupply:v.total_supply??void 0}})}return T})),m=yield*Le({name:`moralis.${n.chainId}.tokenBalances`,dependsOn:f.ref,hasChanged:US,fetch:()=>h}),y=ze([m.stop,f.stop]).pipe(Ae);return n._tokenBalanceSources.set(r,{source:m,refCount:1,stopAll:y}),m}));n._tokenBalanceCreations.set(r,l);try{const f=await l;return c(f)}finally{n._tokenBalanceCreations.delete(r)}})}releaseSharedTokenBalanceSource(t){const n=this;return $(function*(){const r=n._tokenBalanceSources.get(t);r&&(r.refCount-=1,r.refCount<=0&&(yield*r.stopAll,n._tokenBalanceSources.delete(t)))})}createTransactionStatusSource(t){const n=this,r=this.chainId;return $(function*(){n._eventBus||(n._eventBus=yield*En());const s=n._eventBus,o=n.fetchTransactionReceipt(t.txHash).pipe(Zc(la),X(c=>$(function*(){const a=c.result;return!a?.blockNumber?{status:"pending",confirmations:0,requiredConfirmations:1}:(t.address&&(yield*s.emit(sz(r,t.address,t.txHash))),{status:a.status==="0x1"||a.status===void 0?"confirmed":"failed",confirmations:1,requiredConfirmations:1})})));return yield*Te({name:`moralis.${n.chainId}.txStatus`,fetch:o,interval:ie(n.txStatusInterval)})})}fetchNativeBalance(t,n=!1){return Z({url:`${this.baseUrl}/${t}/balance`,searchParams:{chain:this.moralisChain},headers:{"X-API-Key":this.apiKey,accept:"application/json"},schema:Tq,cacheStrategy:n?"network-first":"cache-first"})}fetchTokenBalances(t,n=!1){return Z({url:`${this.baseUrl}/${t}/erc20`,searchParams:{chain:this.moralisChain},headers:{"X-API-Key":this.apiKey,accept:"application/json"},schema:Iq,cacheStrategy:n?"network-first":"cache-first"}).pipe(j(r=>r.slice()))}fetchWalletHistory(t,n=!1){return Z({url:`${this.baseUrl}/wallets/${t.address}/history`,searchParams:{chain:this.moralisChain,limit:String(t.limit??20)},headers:{"X-API-Key":this.apiKey,accept:"application/json"},schema:Oq,cacheStrategy:n?"network-first":"cache-first"})}fetchTransactionReceipt(t,n=!1){return Z({url:this.rpcUrl,method:"POST",body:{jsonrpc:"2.0",id:1,method:"eth_getTransactionReceipt",params:[t]},schema:Eq,cacheStrategy:n?"network-first":"cache-first"})}}function KE(e,t){if(e.type==="moralis")try{return new UE(e,t)}catch(n){return console.warn(`[MoralisProviderEffect] Failed to create provider for ${t}:`,n),null}return null}const Nq=[KE,SE,wE,nE,eE,sE,IE,OE,FE,LE,DE];function jE(e){const t=e.trim();if(t.length===0)return t;const n=le.getConfig(t);return n?n.id:t.toLowerCase()}function Bq(e,t){for(const n of Nq){const r=n(e,t);if(r)return r}return null}function _d(e){const t=jE(e),n=le.getApi(t),r=[];for(const s of n){const o=Bq(s,t);o&&r.push(o)}return new X0(t,r)}const KS=new Map;function Mq(e){return e.map(t=>{const n=t.config?JSON.stringify(t.config):"";return`${t.type}|${t.endpoint}|${n}`}).join(",")}function Lq(e){const t=jE(e);if(!VE.state.snapshot)return _d(t);const n=le.getApi(t),r=Mq(n),s=KS.get(t);if(s&&s.apiKey===r)return s.provider;const o=_d(t);return KS.set(t,{provider:o,apiKey:r}),o}const RW=Object.freeze(Object.defineProperty({__proto__:null,BiowalletProviderEffect:yE,BscWalletProviderEffect:_E,BtcWalletProviderEffect:HE,ChainProvider:X0,EthWalletProviderEffect:xE,EtherscanV1ProviderEffect:Z0,EtherscanV2ProviderEffect:tE,EvmRpcProviderEffect:rE,InvalidDataError:eC,MempoolProviderEffect:RE,MoralisProviderEffect:UE,TronRpcProviderEffect:CE,TronWalletProviderEffect:ME,createBiowalletProviderEffect:SE,createBscWalletProviderEffect:wE,createBtcwalletProviderEffect:DE,createChainProvider:_d,createEtherscanV1ProviderEffect:eE,createEtherscanV2ProviderEffect:nE,createEthwalletProviderEffect:FE,createEvmRpcProviderEffect:sE,createMempoolProviderEffect:OE,createMoralisProviderEffect:KE,createTronRpcProviderEffect:IE,createTronwalletProviderEffect:LE,getChainProvider:Lq},Symbol.toStringTag,{value:"Module"}));export{de as C,ct as H,eC as I,yW as N,_W as S,$ as a,TW as b,Te as c,En as d,sz as e,ts as f,Lq as g,Wn as h,Y0 as i,xe as j,_d as k,bW as l,ie as m,mt as n,SW as o,W as p,H0 as q,Q as r,z as s,Fs as t,uE as u,ge as v,X0 as w,RW as x};
