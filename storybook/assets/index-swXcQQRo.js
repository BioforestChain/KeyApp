const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./web-BBw18cUM.js","./address-book-Dx0_vESo.js","./iframe-BthQp-yI.js","./preload-helper-PPVm8Dsz.js","./iframe-Depx4dix.css","./schemas-jh0dXz-I.js","./index-D0E7N0oa.js","./bioforest-D91I-84E.js","./address-format-Bt4Tl7ZW.js","./breakpoint-BtpSOnE_.js"])))=>i.map(i=>d[i]);
import{t as at}from"./web-BBw18cUM.js";import{_ as ge}from"./preload-helper-PPVm8Dsz.js";import{S as fe,r as he}from"./iframe-BthQp-yI.js";import{a as rt,g as ot,b as me}from"./index-C_NqyCS_.js";import{w as ct,d as O,c as lt,g as ut,h as dt}from"./address-book-Dx0_vESo.js";import{A as pt}from"./amount-BQsqQYGO.js";import{h as gt,c as ft,p as ht}from"./bioforest-D91I-84E.js";import"./index-D0E7N0oa.js";import{p as mt,g as wt,t as At,E as St}from"./index-Cx7hNgYy.js";const we={motion:{timeScale:1,layoutDuration:.45,uiFastDuration:.15,layoutEase:[.4,0,.1,1],spring:{stiffness:220,damping:28,mass:.85}},css:{}};function q(e){return!Number.isFinite(e)||e<=0?1:e}function T(e,t){const n=q(t);return e/n}function re(e,t,n){const s=q(t);return e*Math.pow(s,n)}function bt(e,t){return t?{motion:{...e.motion,...t.motion,spring:{...e.motion.spring,...t.motion?.spring}},css:{...e.css,...t.css}}:e}const oe=new WeakMap,ce=new WeakMap;function Ys(e){const t=oe.get(e);if(t)return t;const{motion:n}=e,s={type:"spring",stiffness:re(n.spring.stiffness,n.timeScale,2),damping:re(n.spring.damping,n.timeScale,1),mass:n.spring.mass},a={layout:{duration:T(n.layoutDuration,n.timeScale),ease:n.layoutEase}},o={duration:T(n.uiFastDuration,n.timeScale),ease:"easeOut"},l={motionConfig:s,sharedLayout:a,uiFast:o};return oe.set(e,l),l}function Zs(e){const t=ce.get(e);if(t)return t;const{motion:n}=e,s={"--miniapp-motion-time-scale":String(q(n.timeScale)),"--miniapp-motion-layout-duration":`${T(n.layoutDuration,n.timeScale)}s`,"--miniapp-motion-ui-fast-duration":`${T(n.uiFastDuration,n.timeScale)}s`,"--miniapp-motion-layout-ease":`cubic-bezier(${n.layoutEase.join(",")})`};return ce.set(e,s),s}const Rt=4,V="miniapp-iframe-container",Ae="miniapp-hidden-container";function W(e,t){let n=document.getElementById(e);return n||(n=document.createElement("div"),n.id=e,t&&(n.style.cssText=`
        position: fixed;
        top: -9999px;
        left: -9999px;
        width: 1px;
        height: 1px;
        overflow: hidden;
        visibility: hidden;
        pointer-events: none;
      `),document.body.appendChild(n)),n}function Et(e,t,n){const s=document.createElement("iframe");s.id=`miniapp-iframe-${e}`,s.dataset.appId=e;const i=new URL(t,window.location.origin);return n&&Object.entries(n).forEach(([a,o])=>{i.searchParams.set(a,o)}),s.src=i.toString(),s.sandbox.add("allow-scripts","allow-forms","allow-same-origin"),s.style.cssText=`
    width: 100%;
    height: 100%;
    border: none;
    background: transparent;
  `,s}function _t(e){W(V,!1).appendChild(e)}function yt(e){W(Ae,!0).appendChild(e)}function Tt(e){W(V,!1).appendChild(e)}function x(e){e.src="about:blank",e.remove()}function It(e,t,n=Rt){const s=[],i=Array.from(e.values()).filter(a=>a.appId!==t&&a.state==="background").toSorted((a,o)=>a.lastActiveAt-o.lastActiveAt);for(;i.length>n;){const a=i.shift();a?.iframeRef&&(x(a.iframeRef),a.iframeRef=null,s.push(a.appId))}return s}function Dt(){const e=document.getElementById(V),t=document.getElementById(Ae);e&&(e.innerHTML="",e.remove()),t&&(t.innerHTML="",t.remove())}const Qs={bio_requestAccounts:{id:"bio_requestAccounts",name:"请求账户",description:"获取您的钱包地址列表",risk:"low"},bio_selectAccount:{id:"bio_selectAccount",name:"选择账户",description:"让您选择一个账户",risk:"low"},bio_pickWallet:{id:"bio_pickWallet",name:"选择钱包",description:"让您选择一个钱包",risk:"low"},bio_createTransaction:{id:"bio_createTransaction",name:"创建交易",description:"构造未签名交易（不做签名/不做广播）",risk:"low"},bio_signMessage:{id:"bio_signMessage",name:"签名消息",description:"使用您的私钥签名消息（需要您确认）",risk:"medium"},bio_signTypedData:{id:"bio_signTypedData",name:"签名数据",description:"签名结构化数据（需要您确认）",risk:"medium"},bio_signTransaction:{id:"bio_signTransaction",name:"签名交易",description:"对未签名交易进行签名（需要您确认）",risk:"high"},bio_sendTransaction:{id:"bio_sendTransaction",name:"发送交易",description:"请求发送转账（需要您确认）",risk:"high"},bio_destroyAsset:{id:"bio_destroyAsset",name:"销毁资产",description:"请求销毁资产（需要您确认，不可撤销）",risk:"high"}},r={USER_REJECTED:4001,UNAUTHORIZED:4100,UNSUPPORTED_METHOD:4200,INTERNAL_ERROR:-32603,INVALID_PARAMS:-32602,METHOD_NOT_FOUND:-32601};function le(e,t,n,s){return{type:"bio_response",id:e,success:!1,error:{code:t,message:n,data:s}}}const Se="ecosystem_my_apps",vt={teleport:"xin.dweb.teleport",forge:"xin.dweb.forge"};function R(e){return vt[e]??e}function ue(){try{const e=localStorage.getItem(Se),t=e?JSON.parse(e):[],n=t.map(s=>({...s,appId:R(s.appId)}));return JSON.stringify(t)!==JSON.stringify(n)&&be(n),n}catch{return[]}}function be(e){localStorage.setItem(Se,JSON.stringify(e))}const C=["discover","mine"],Re="ecosystem_store";function kt(){try{const e=localStorage.getItem(Re);if(e){const t=JSON.parse(e),n=Array.isArray(t.availableSubPages)&&t.availableSubPages.length>0?t.availableSubPages:C,s=t.activeSubPage??"discover",i=n.includes(s)?n:[...n,s];return{permissions:t.permissions??[],sources:t.sources??[{url:"./miniapps/ecosystem.json",name:"Bio 官方生态",lastUpdated:new Date().toISOString(),enabled:!0}],myApps:ue(),availableSubPages:i,activeSubPage:s,swiperProgress:0,syncSource:null}}}catch{}return{permissions:[],sources:[{url:"./miniapps/ecosystem.json",name:"Bio 官方生态",lastUpdated:new Date().toISOString(),enabled:!0}],myApps:ue(),availableSubPages:C,activeSubPage:"discover",swiperProgress:0,syncSource:null}}function Ot(e){try{localStorage.setItem(Re,JSON.stringify({permissions:e.permissions,sources:e.sources,availableSubPages:e.availableSubPages,activeSubPage:e.activeSubPage})),be(e.myApps)}catch{}}const p=new fe(kt());p.subscribe(()=>{Ot(p.state)});const Ee={getGrantedPermissions:(e,t)=>e.permissions.find(n=>n.appId===t)?.granted??[],hasPermission:(e,t,n)=>Ee.getGrantedPermissions(e,t).includes(n),getEnabledSources:e=>e.sources.filter(t=>t.enabled),isAppInstalled:(e,t)=>{const n=R(t);return e.myApps.some(s=>s.appId===n)}},Pt={installApp:e=>{p.setState(t=>{const n=R(e);return t.myApps.some(s=>s.appId===n)?t:{...t,myApps:[{appId:n,installedAt:Date.now(),lastUsedAt:Date.now()},...t.myApps]}})},uninstallApp:e=>{p.setState(t=>{const n=R(e);return{...t,myApps:t.myApps.filter(s=>s.appId!==n)}})},updateAppLastUsed:e=>{p.setState(t=>{const n=R(e);return t.myApps.find(i=>i.appId===n)?{...t,myApps:t.myApps.map(i=>i.appId===n?{...i,lastUsedAt:Date.now()}:i)}:t})},grantPermissions:(e,t)=>{p.setState(n=>{const s=n.permissions.find(i=>i.appId===e);if(s){const i=[...new Set([...s.granted,...t])];return{...n,permissions:n.permissions.map(a=>a.appId===e?{...a,granted:i,grantedAt:Date.now()}:a)}}else return{...n,permissions:[...n.permissions,{appId:e,granted:t,grantedAt:Date.now()}]}})},revokePermissions:(e,t)=>{p.setState(n=>t?{...n,permissions:n.permissions.map(s=>s.appId===e?{...s,granted:s.granted.filter(i=>!t.includes(i))}:s)}:{...n,permissions:n.permissions.filter(s=>s.appId!==e)})},addSource:(e,t)=>{p.setState(n=>n.sources.some(s=>s.url===e)?n:{...n,sources:[...n.sources,{url:e,name:t,lastUpdated:new Date().toISOString(),enabled:!0}]})},removeSource:e=>{p.setState(t=>({...t,sources:t.sources.filter(n=>n.url!==e)}))},toggleSource:e=>{p.setState(t=>({...t,sources:t.sources.map(n=>n.url===e?{...n,enabled:!n.enabled}:n)}))},updateSourceTimestamp:e=>{p.setState(t=>({...t,sources:t.sources.map(n=>n.url===e?{...n,lastUpdated:new Date().toISOString()}:n)}))},setActiveSubPage:e=>{p.setState(t=>({...t,activeSubPage:e}))},setAvailableSubPages:e=>{p.setState(t=>{const n=e.length>0?e:C,s=n.includes(t.activeSubPage)?t.activeSubPage:n[0]??"mine";return{...t,availableSubPages:n,activeSubPage:s}})},setSwiperProgress:e=>{p.setState(t=>({...t,swiperProgress:e}))},setSyncSource:e=>{p.setState(t=>({...t,syncSource:e}))}},Ct=["bio_requestAccounts","bio_signMessage","bio_signTypedData","bio_signTransaction","bio_sendTransaction"];function _e(e){return Ct.includes(e)}function Mt(e,t){return _e(t)?Ee.hasPermission(p.state,e,t):!0}function Nt(e,t){Pt.grantPermissions(e,t)}class jt{handlers=new Map;iframe=null;appId="";appName="";origin="*";manifestPermissions=[];messageHandler=null;permissionRequestCallback=null;registerHandler(t,n){this.handlers.set(t,n)}setPermissionRequestCallback(t){this.permissionRequestCallback=t}attach(t,n,s,i=[]){this.detach(),this.iframe=t,this.appId=n,this.appName=s,this.manifestPermissions=i;try{const a=new URL(t.src,window.location.origin);this.origin=a.origin}catch{this.origin="*"}this.messageHandler=this.handleMessage.bind(this),window.addEventListener("message",this.messageHandler),console.log("[BioProvider] Attached to iframe:",n)}detach(){this.messageHandler&&(window.removeEventListener("message",this.messageHandler),this.messageHandler=null),this.iframe=null,this.appId="",this.appName="",this.manifestPermissions=[]}emit(t,...n){this.emitTo("bio",t,...n)}emitEth(t,...n){this.emitTo("eth",t,...n)}emitTron(t,...n){this.emitTo("tron",t,...n)}emitTo(t,n,...s){if(!this.iframe?.contentWindow)return;const i={type:`${t}_event`,event:n,args:s};this.iframe.contentWindow.postMessage(i,this.origin)}handleMessage(t){if(this.origin!=="*"&&t.origin!==this.origin||t.source!==this.iframe?.contentWindow)return;const n=t.data;!n||typeof n!="object"||!("type"in n)||(n.type==="bio_request"?this.processRequest(n,"bio"):n.type==="eth_request"?this.processRequest(n,"eth"):n.type==="tron_request"&&this.processRequest(n,"tron"))}async processRequest(t,n){const{id:s,method:i,params:a}=t;console.log(`[BioProvider] ${n.toUpperCase()} Request:`,i,a);const o=this.handlers.get(i);if(!o){this.sendResponse(n,{type:`${n}_response`,id:s,success:!1,error:{code:r.METHOD_NOT_FOUND,message:`Method not found: ${i}`}});return}if(!(n!=="bio"||["bio_connect","bio_closeSplashScreen"].includes(i))){const d=["bio_accounts","bio_selectAccount","bio_pickWallet"].includes(i)&&this.manifestPermissions.includes("bio_requestAccounts"),g=d?"bio_requestAccounts":i;if(!(this.manifestPermissions.includes(i)||i==="bio_requestAccounts"||d)){this.sendResponse(n,le(s,r.UNAUTHORIZED,`Permission not declared in manifest: ${i}`));return}if(_e(g)&&!Mt(this.appId,g)&&!await this.requestPermission([g])){this.sendResponse(n,le(s,r.USER_REJECTED,"Permission denied by user"));return}}try{const d=c.state.apps.get(this.appId)?.manifest;let g=d?.icon;if(g&&!g.startsWith("http")&&!g.startsWith("data:"))try{const ae=new URL(d?.url??"",window.location.origin);g=new URL(g,ae).href}catch{}const S={appId:this.appId,appName:this.appName,appIcon:g,origin:this.origin,permissions:this.manifestPermissions},b=await o(a?.[0],S);this.sendResponse(n,{type:`${n}_response`,id:s,success:!0,result:b})}catch(f){const d=f instanceof Error?f.message:"Unknown error",g=f.code??r.INTERNAL_ERROR;this.sendResponse(n,{type:`${n}_response`,id:s,success:!1,error:{code:g,message:d}})}}async requestPermission(t){if(!this.permissionRequestCallback)return console.warn("[BioProvider] No permission request callback set"),!1;try{const n=await this.permissionRequestCallback(this.appId,this.appName,t);return n&&Nt(this.appId,t),n}catch(n){return console.error("[BioProvider] Permission request failed:",n),!1}}sendResponse(t,n){this.iframe?.contentWindow&&(console.log(`[BioProvider] ${t.toUpperCase()} Response:`,n),this.iframe.contentWindow.postMessage(n,this.origin))}}const u=new jt,w=new Map,h={register(e,t){w.set(e,t),console.log("[HandlerContext] Registered callbacks for:",e)},unregister(e){w.delete(e),console.log("[HandlerContext] Unregistered callbacks for:",e)},get(e){return w.get(e)},has(e){return w.has(e)},getRegisteredApps(){return Array.from(w.keys())},clear(){w.clear()}},Ut=async(e,t)=>{nt(t.appId)};let ye=null,Te=null;function Xs(e){ye=e}function ei(e){Te=e}function $(e){return h.get(e)?.showWalletPicker??ye}function Lt(e){return h.get(e)?.getConnectedAccounts??Te}const Ht=async(e,t)=>({connected:!0}),Bt=async(e,t)=>{const n=$(t.appId);if(!n)throw Object.assign(new Error("Wallet picker not available"),{code:r.INTERNAL_ERROR});const s=await n({app:{name:t.appName,icon:t.appIcon}});if(!s)throw Object.assign(new Error("User rejected"),{code:r.USER_REJECTED});return[s]},qt=async(e,t)=>{const n=Lt(t.appId);return n?n():[]},Vt=async(e,t)=>{const n=$(t.appId);if(!n)throw Object.assign(new Error("Wallet picker not available"),{code:r.INTERNAL_ERROR});const i=await n({...e,app:{name:t.appName,icon:t.appIcon}});if(!i)throw Object.assign(new Error("User rejected"),{code:r.USER_REJECTED});return i},Wt=async(e,t)=>{const n=$(t.appId);if(!n)throw Object.assign(new Error("Wallet picker not available"),{code:r.INTERNAL_ERROR});const i=await n({...e,app:{name:t.appName,icon:t.appIcon}});if(!i)throw Object.assign(new Error("User rejected"),{code:r.USER_REJECTED});return i},xt=async(e,t)=>"bfmeta",$t=async(e,t)=>{const n=e;if(!n?.address||!n?.chain)throw Object.assign(new Error("Missing address or chain"),{code:r.INVALID_PARAMS});const s=rt.getBiowalletApi(n.chain);if(!s)return"0";try{return await ot(s,n.chain,n.address)}catch(i){return console.warn("[bio_getBalance] Failed to query balance:",i),"0"}};let Ie=null;function ti(e){Ie=e}function De(e){return h.get(e)?.showSigningDialog??Ie}const zt=async(e,t)=>{const n=e;if(!n?.message||!n?.address)throw Object.assign(new Error("Missing message or address"),{code:r.INVALID_PARAMS});const s=De(t.appId);if(!s)throw Object.assign(new Error("Signing dialog not available"),{code:r.INTERNAL_ERROR});const i=await s({message:n.message,address:n.address,app:{name:t.appName}});if(!i)throw Object.assign(new Error("User rejected"),{code:r.USER_REJECTED});return i},Jt=async(e,t)=>{const n=e;if(!n?.data||!n?.address)throw Object.assign(new Error("Missing data or address"),{code:r.INVALID_PARAMS});const s=De(t.appId);if(!s)throw Object.assign(new Error("Signing dialog not available"),{code:r.INTERNAL_ERROR});const i=JSON.stringify(n.data,null,2),a=await s({message:i,address:n.address,app:{name:t.appName}});if(!a)throw Object.assign(new Error("User rejected"),{code:r.USER_REJECTED});return a};let ve=null;function ni(e){ve=e}function Ft(e){return h.get(e)?.showTransferDialog??ve}const Kt=async(e,t)=>{const n=e;if(!n?.from||!n?.to||!n?.amount||!n?.chain)throw Object.assign(new Error("Missing required parameters: from, to, amount, chain"),{code:r.INVALID_PARAMS});const s=Ft(t.appId);if(!s)throw Object.assign(new Error("Transfer dialog not available"),{code:r.INTERNAL_ERROR});const i={from:n.from,to:n.to,amount:n.amount,chain:n.chain,app:{name:t.appName}};n.asset&&(i.asset=n.asset);const a=await s(i);if(!a)throw Object.assign(new Error("User rejected"),{code:r.USER_REJECTED});return a};let Gt=null;function Yt(e){return h.get(e)?.showDestroyDialog??Gt}const Zt=async(e,t)=>{const n=e;if(!n?.from||!n?.amount||!n?.chain||!n?.asset)throw Object.assign(new Error("Missing required parameters: from, amount, chain, asset"),{code:r.INVALID_PARAMS});const s=Yt(t.appId);if(!s)throw Object.assign(new Error("Destroy dialog not available"),{code:r.INTERNAL_ERROR});const i={from:n.from,amount:n.amount,chain:n.chain,asset:n.asset,app:{name:t.appName}},a=await s(i);if(!a)throw Object.assign(new Error("User rejected"),{code:r.USER_REJECTED});return a};function Qt(e,t){const n=ct.state.wallets,s=t.startsWith("0x"),i=s?t.toLowerCase():t;for(const a of n)if(a.chainAddresses.find(l=>l.chain!==e?!1:s||l.address.startsWith("0x")?l.address.toLowerCase()===i:l.address===i))return a.id;return null}async function ke(e){if(O.state.snapshot||await lt.initialize(),!O.state.snapshot)throw Object.assign(new Error("Chain configs not initialized"),{code:r.INTERNAL_ERROR});const n=ut.getChainById(O.state,e);if(!n)throw Object.assign(new Error(`Unsupported chain: ${e}`),{code:r.INVALID_PARAMS});return n}const Xt=async(e,t)=>{const n=e;if(!n?.from||!n?.to||!n?.amount||!n?.chain)throw Object.assign(new Error("Missing required parameters: from, to, amount, chain"),{code:r.INVALID_PARAMS});if(!Qt(n.chain,n.from))throw Object.assign(new Error("From address is not owned by current user"),{code:r.UNAUTHORIZED});const i=await ke(n.chain),a=pt.parse(n.amount,i.decimals,i.symbol),o=me(i.id);if(!o.supportsBuildTransaction)throw Object.assign(new Error(`Chain ${i.id} does not support transaction building`),{code:r.UNSUPPORTED_METHOD});const l=await o.buildTransaction({from:n.from,to:n.to,amount:a});return{chainId:l.chainId,data:l.data}};let Oe=null;function si(e){Oe=e}function en(e){return h.get(e)?.showSignTransactionDialog??Oe}const tn=async(e,t)=>{const n=e;if(!n?.from||!n?.chain||!n?.unsignedTx)throw Object.assign(new Error("Missing required parameters: from, chain, unsignedTx"),{code:r.INVALID_PARAMS});const s=en(t.appId);if(!s)throw Object.assign(new Error("SignTransaction dialog not available"),{code:r.INTERNAL_ERROR});const i=await s({from:n.from,chain:n.chain,unsignedTx:n.unsignedTx,app:{name:t.appName}});if(!i)throw Object.assign(new Error("User rejected"),{code:r.USER_REJECTED});return i};async function ii(e){const t=await ke(e.chainId),n=me(t.id);if(!n.supportsSignTransaction)throw Object.assign(new Error(`Chain ${t.id} does not support transaction signing`),{code:r.UNSUPPORTED_METHOD});const s=await(await ge(async()=>{const{walletStorageService:o}=await import("./web-BBw18cUM.js").then(l=>l.i);return{walletStorageService:o}},__vite__mapDeps([0,1,2,3,4,5,6,7,8,9]),import.meta.url)).walletStorageService.getMnemonic(e.walletId,e.password);let i;if(t.chainKind==="evm"){const o=dt(s,"ethereum",0,0);if(o.address.toLowerCase()!==e.from.toLowerCase())throw Object.assign(new Error("Signing address mismatch"),{code:r.INVALID_PARAMS});i=gt(o.privateKey)}else if(t.chainKind==="bioforest"){const o=ft(s);if(ht(o.publicKey,t.prefix??"b")!==e.from)throw Object.assign(new Error("Signing address mismatch"),{code:r.INVALID_PARAMS});i=o.secretKey}else throw Object.assign(new Error(`Unsupported chain kind: ${t.chainKind}`),{code:r.UNSUPPORTED_METHOD});const a=await n.signTransaction({chainId:e.unsignedTx.chainId,data:e.unsignedTx.data},i);return{chainId:a.chainId,data:a.data,signature:a.signature}}const Pe=new Map,Ce=new Map;let Me=null,M=null,Ne=null,je=null;function ai(e){Me=e}function ri(e){M=e}function oi(e){Ne=e}function ci(e){je=e}function nn(e){return h.get(e)?.showEvmWalletPicker??Me}function Ue(e){return h.get(e)?.showEvmSigningDialog??Ne}function sn(e){return h.get(e)?.showEvmTransactionDialog??je}function y(e){return Pe.get(e)??At(St.binance)}function an(e,t){Pe.set(e,t)}function rn(e){return Ce.get(e)??[]}function on(e,t){Ce.set(e,t)}const cn=async(e,t)=>y(t.appId),ln=async(e,t)=>{const n=nn(t.appId);if(!n)throw Object.assign(new Error("Wallet picker not available"),{code:r.INTERNAL_ERROR});const s=y(t.appId),i=await n({chainId:s,app:{name:t.appName,icon:t.appIcon}});if(!i)throw Object.assign(new Error("User rejected"),{code:r.USER_REJECTED});const a=[i.address];return on(t.appId,a),a},un=async(e,t)=>rn(t.appId),dn=async(e,t)=>{const n=e;if(!n?.chainId)throw Object.assign(new Error("Missing chainId"),{code:r.INVALID_PARAMS});const s=n.chainId;if(!wt(s))throw Object.assign(new Error(`Chain ${s} not supported`),{code:4902});const a=y(t.appId);if(a===s)return null;if(M&&!await M({fromChainId:a,toChainId:s,appName:t.appName,appIcon:t.appIcon}))throw Object.assign(new Error("User rejected"),{code:r.USER_REJECTED});return an(t.appId,s),null},pn=async(e,t)=>{throw Object.assign(new Error("Adding custom chains is not supported"),{code:r.UNSUPPORTED_METHOD})},Le=async(e,t)=>{const[n,s]=e;if(!n||!s)throw Object.assign(new Error("Missing message or address"),{code:r.INVALID_PARAMS});const i=Ue(t.appId);if(!i)throw Object.assign(new Error("Signing dialog not available"),{code:r.INTERNAL_ERROR});const a=await i({message:n,address:s,appName:t.appName});if(!a)throw Object.assign(new Error("User rejected"),{code:r.USER_REJECTED});return a.signature},gn=async(e,t)=>{const[n,s]=e;return Le([s,n],t)},fn=async(e,t)=>{const[n,s]=e;if(!n||!s)throw Object.assign(new Error("Missing address or typedData"),{code:r.INVALID_PARAMS});const i=typeof s=="string"?JSON.parse(s):s,a=Ue(t.appId);if(!a)throw Object.assign(new Error("Signing dialog not available"),{code:r.INTERNAL_ERROR});const o=JSON.stringify(i,null,2),l=await a({message:o,address:n,appName:t.appName});if(!l)throw Object.assign(new Error("User rejected"),{code:r.USER_REJECTED});return l.signature},hn=async(e,t)=>{const n=e;if(!n?.from)throw Object.assign(new Error("Missing transaction data"),{code:r.INVALID_PARAMS});const s=sn(t.appId);if(!s)throw Object.assign(new Error("Transaction dialog not available"),{code:r.INTERNAL_ERROR});n.chainId||(n.chainId=y(t.appId));const i=await s({tx:n,appName:t.appName});if(!i)throw Object.assign(new Error("User rejected"),{code:r.USER_REJECTED});return i.txHash},mn=async(e,t)=>{throw e?.from?Object.assign(new Error("eth_signTransaction not yet supported, use eth_sendTransaction"),{code:r.UNSUPPORTED_METHOD}):Object.assign(new Error("Missing transaction data"),{code:r.INVALID_PARAMS})},wn=async(e,t)=>{const[n,s]=e;if(!n)throw Object.assign(new Error("Missing address"),{code:r.INVALID_PARAMS});return"0x0"},An=async(e,t)=>{const n=y(t.appId),s=mt(n);return String(s)},Sn=async(e,t)=>"0x0",bn=async(e,t)=>"KeyApp/1.0.0",Rn={eth_chainId:cn,eth_requestAccounts:ln,eth_accounts:un,wallet_switchEthereumChain:dn,wallet_addEthereumChain:pn,personal_sign:Le,eth_sign:gn,eth_signTypedData_v4:fn,eth_sendTransaction:hn,eth_signTransaction:mn,eth_getBalance:wn,net_version:An,eth_blockNumber:Sn,web3_clientVersion:bn};function En(e){for(const[t,n]of Object.entries(Rn))e(t,n)}const He=new Map;let Be=null,_n=null;function li(e){Be=e}function yn(e){return h.get(e)?.showTronWalletPicker??Be}function Tn(e){return h.get(e)?.showTronSigningDialog??_n}function qe(e){return He.get(e)??null}function In(e,t){He.set(e,t)}function Dn(e){return{base58:e.address,hex:e.address}}const vn=async(e,t)=>{const n=yn(t.appId);if(!n)throw Object.assign(new Error("Wallet picker not available"),{code:r.INTERNAL_ERROR});const s=await n({app:{name:t.appName,icon:t.appIcon}});if(!s)throw Object.assign(new Error("User rejected"),{code:r.USER_REJECTED});const i=Dn(s);return In(t.appId,i),{code:200,message:"ok",data:i}},kn=async(e,t)=>{const n=qe(t.appId);return n?{code:200,message:"ok",data:n}:{code:4e3,message:"Not connected",data:null}},On=async(e,t)=>qe(t.appId),Pn=async(e,t)=>{const n=e;if(!n?.txID)throw Object.assign(new Error("Invalid transaction"),{code:r.INVALID_PARAMS});const s=Tn(t.appId);if(!s)throw Object.assign(new Error("Signing dialog not available"),{code:r.INTERNAL_ERROR});const i=await s({transaction:n,appName:t.appName});if(!i)throw Object.assign(new Error("User rejected"),{code:r.USER_REJECTED});return i.signedTransaction},Cn=async(e,t)=>{const n=e;if(!n?.txID||!n.signature)throw Object.assign(new Error("Invalid signed transaction"),{code:r.INVALID_PARAMS});return{result:!0,txid:n.txID}},Mn=async(e,t)=>{if(!e)throw Object.assign(new Error("Missing address"),{code:r.INVALID_PARAMS});return 0},Nn=async(e,t)=>{const n=e;if(!n)throw Object.assign(new Error("Missing address"),{code:r.INVALID_PARAMS});return{address:n,balance:0}},jn={tron_requestAccounts:vn,tron_accounts:kn,tron_getDefaultAddress:On,tron_signTransaction:Pn,tron_sendRawTransaction:Cn,tron_getBalance:Mn,tron_getAccount:Nn};function Un(e){for(const[t,n]of Object.entries(jn))e(t,n)}let de=!1;function Ln(){de||(de=!0,u.registerHandler("bio_connect",Ht),u.registerHandler("bio_closeSplashScreen",Ut),u.registerHandler("bio_requestAccounts",Bt),u.registerHandler("bio_accounts",qt),u.registerHandler("bio_selectAccount",Vt),u.registerHandler("bio_pickWallet",Wt),u.registerHandler("bio_chainId",xt),u.registerHandler("bio_getBalance",$t),u.registerHandler("bio_signMessage",zt),u.registerHandler("bio_signTypedData",Jt),u.registerHandler("bio_createTransaction",Xt),u.registerHandler("bio_signTransaction",tn),u.registerHandler("bio_sendTransaction",Kt),u.registerHandler("bio_destroyAsset",Zt),En((e,t)=>u.registerHandler(e,t)),Un((e,t)=>u.registerHandler(e,t)),console.log("[BioProvider] Initialized with handlers:",{bio:["bio_connect","bio_closeSplashScreen","bio_requestAccounts","bio_accounts","bio_selectAccount","bio_pickWallet","bio_chainId","bio_getBalance","bio_signMessage","bio_signTypedData","bio_createTransaction","bio_signTransaction","bio_sendTransaction","bio_destroyAsset"],evm:["eth_chainId","eth_requestAccounts","eth_accounts","wallet_switchEthereumChain","personal_sign","eth_sendTransaction"],tron:["tron_requestAccounts","tron_accounts","tron_signTransaction"]}))}Ln();function z(){return u}const J=new Map,N=new Set;function j(e,t){const n=`${e}:${t}`;return J.get(n)??null}function Ve(e){return N.add(e),()=>N.delete(e)}function We(){N.forEach(e=>e())}const F=new Map,K=new Map,G=new Map,Y=new Map;let xe=null,$e=null;const Z=new Map,Q=new Map,E=new Map;function Hn(e,t){F.set(e,t)}function Bn(e,t){K.set(e,t)}function qn(e){F.delete(e),K.delete(e)}function X(e){return F.get(e)??null}function Vn(e){return K.get(e)??null}function Wn(e,t){G.set(e,t)}function xn(e){G.delete(e)}function $n(e){return G.get(e)??null}function zn(e,t){Y.set(e,t)}function Jn(e){Y.delete(e)}function Fn(e){return Y.get(e)??null}function Kn(e){xe=e}function Gn(){return xe}function Yn(e){$e=e}function Zn(){return $e}function ze(e,t){Z.set(e,t)}function Je(e){Z.delete(e)}function ee(e){return Z.get(e)??null}function Fe(e){const t=ee(e);if(!t)return null;const n=t.closest(".swiper-slide");if(n&&!n.classList.contains("swiper-slide-active"))return null;const s=t.getBoundingClientRect();return s.width<=0||s.height<=0?null:s}function Qn(e,t){Q.set(e,t)}function Xn(e){Q.delete(e)}function es(e){return Q.get(e)??null}function ts(e,t,n){const s=E.get(e)??new Map;s.set(t,n),E.set(e,s);const i=`${e}:${t}`;J.set(i,"ready"),We()}function ns(e,t){const n=E.get(e);if(!n)return;n.delete(t),n.size===0&&E.delete(e);const s=`${e}:${t}`;J.set(s,"lost"),We()}function Ke(e,t){return E.get(e)?.get(t)??null}function Ge(e,t){const n=Ke(e,t);if(!n)return null;const s=n.closest(".swiper-slide");if(s&&!s.classList.contains("swiper-slide-active"))return null;const i=n.getBoundingClientRect();return i.width<=0||i.height<=0?null:i}function ss(e){ze("stack",e)}function is(){Je("stack")}function as(){return ee("stack")}function rs(){return Fe("stack")}async function os(){return ge(()=>Promise.resolve().then(()=>qs),void 0,import.meta.url)}function cs(){he.useEffect(()=>{os().then(({miniappRuntimeStore:e,activateApp:t})=>{const{activeAppId:n}=e.state;n&&t(n)})})}function ls(e,t){return he.useSyncExternalStore(Ve,()=>j(e,t),()=>j(e,t))}const us={apps:new Map,visualConfig:we,activeAppId:null,focusedAppId:null,presentations:new Map,zOrderSeed:1,isStackViewOpen:!1,maxBackgroundApps:4};function Ye(e){const t=c.state.apps.get(e),n=t?.iframeRef;!t||!n||z().attach(n,e,t.manifest.name,t.manifest.permissions??[])}function ds(e,t,n){z().attach(t,e,n.name,n.permissions??[])}const c=new fe(us);function Ze(e){c.setState(t=>({...t,visualConfig:bt(t.visualConfig,e)}))}function ps(e){Ze({motion:{timeScale:e}})}function gs(){c.setState(e=>({...e,visualConfig:we}))}const U=new Set;function m(e){U.forEach(t=>t(e))}let pe=0;function Qe(e,t){return pe+=1,{id:`${e}:${t}:${Date.now()}:${pe}`,kind:e,status:"requested",startedAt:Date.now()}}function fs(e){const t=e.splashScreen;return t?typeof t=="object"&&typeof t.timeout=="number"?t.timeout:5e3:null}function hs(e,t){if(!e||e==="preparing"){if(t==="launching")return"opening";if(t==="splash")return"splash";if(t==="active")return"opened"}return e==="launching"&&t==="splash"?"splash":(e==="launching"||e==="splash")&&t==="active"?"opened":e==="active"&&t==="background"?"backgrounding":e==="background"&&t==="active"?"foregrounding":t==="closing"?"closing":t==="preparing"?"closed":t==="launching"?"opening":t==="splash"?"splash":t==="active"?"opened":t==="background"?"backgrounded":"closed"}function _(e,t){c.setState(n=>{const s=n.apps.get(e);if(!s)return n;const i=hs(s.state,t),a=new Map(n.apps);return a.set(e,{...s,state:t,flow:i}),{...n,apps:a}}),m({type:"app:state-change",appId:e,state:t})}function ms(e,t){c.setState(n=>{const s=n.apps.get(e);if(!s||s.processStatus===t)return n;const i=new Map(n.apps);return i.set(e,{...s,processStatus:t}),{...n,apps:i}})}function ws(e,t){c.setState(n=>{const s=n.apps.get(e);if(!s||s.readiness===t)return n;const i=new Map(n.apps);return i.set(e,{...s,readiness:t}),{...n,apps:i}})}function Xe(e){ws(e,"ready");const t=c.state.apps.get(e);t&&!t.manifest.splashScreen&&(t.state==="launching"||t.state==="splash")&&k(e)}function As(e){switch(e){case"opening":return"opened";case"backgrounding":return"backgrounded";case"foregrounding":return"opened";default:return e}}function Ss(e){c.setState(t=>{const n=t.apps.get(e);if(!n)return t;const s=As(n.flow);if(s===n.flow)return t;const i=new Map(t.apps);return i.set(e,{...n,flow:s}),{...t,apps:i}})}const bs={launchToSplash:100},I=new Map,L=new Map,H=new Map,Rs=3e4,Es=2500,B=new Map;function A(e){const t=B.get(e);t&&(t.cancelled=!0,t.rafId!==null&&cancelAnimationFrame(t.rafId),B.delete(e))}function _s(e){if(!e)return!1;const t=e.getBoundingClientRect();return t.width>0&&t.height>0}function ys(e){return!!e&&e.isConnected}function D(e){const t=L.get(e);t&&(clearTimeout(t),L.delete(e))}function te(e,t,n){c.setState(s=>{const a=s.presentations.get(e)??{appId:e,desktop:t,state:"hidden",zOrder:s.zOrderSeed,transitionId:null,transitionKind:null},o={...a,...n,appId:e,desktop:n.desktop??a.desktop},l=new Map(s.presentations);return l.set(e,o),{...s,presentations:l}})}function et(e){c.setState(t=>{const n=t.presentations.get(e),s=t.zOrderSeed+1,i=new Map(t.presentations);return n&&i.set(e,{...n,zOrder:s}),{...t,activeAppId:e,focusedAppId:e,presentations:i,zOrderSeed:s}})}function Ts(e,t){const n=c.state.presentations.get(e);n&&(n.transitionKind!=="present"||n.transitionId!==t||te(e,n.desktop,{state:"presented",transitionId:null,transitionKind:null}))}function Is(e,t){const n=c.state.presentations.get(e);n&&(n.transitionKind!=="dismiss"||n.transitionId!==t||v(e))}function ne(e){D(e),Xe(e),k(e)}function P(e,t){A(e);const n=c.state.apps.get(e);n?.iframeRef&&x(n.iframeRef),c.setState(s=>{const i=new Map(s.apps);i.delete(e);const a=new Map(s.presentations);return a.delete(e),{...s,apps:i,presentations:a,activeAppId:s.activeAppId===e?null:s.activeAppId,focusedAppId:s.focusedAppId===e?null:s.focusedAppId}}),at.show({message:t,duration:2e3})}function Ds(e,t){if(_(e,"launching"),se(e),t){const n=setTimeout(()=>{const s=c.state.apps.get(e);if(!s||s.state!=="launching")return;_(e,"splash"),D(e);const i=fs(s.manifest);i!==null&&L.set(e,setTimeout(()=>{const a=c.state.apps.get(e);a&&a.state==="splash"&&ne(e)},i))},bs.launchToSplash);I.set(e,[n]);return}I.set(e,[])}function vs(e,t,n){A(e);const s={cancelled:!1,rafId:null};B.set(e,s);const i=performance.now(),a=()=>{if(s.cancelled)return;const o=c.state.apps.get(e);if(!o||o.state!=="preparing"){A(e);return}const l=_s(X(e)),f=!!Ge(t,e),d=ys(o.iframeRef);if(l&&f&&d){A(e),Ds(e,n);return}if(performance.now()-i>Es){f?l?P(e,"启动失败：加载容器未就绪，请重试"):P(e,"启动失败：图标未就绪，请返回桌面重试"):P(e,"启动失败：请停留在目标桌面页后重试");return}s.rafId=requestAnimationFrame(a)};s.rafId=requestAnimationFrame(a)}function se(e){const t=I.get(e);t&&(t.forEach(n=>clearTimeout(n)),I.delete(e))}function tt(e){const t=H.get(e);t&&(clearTimeout(t),H.delete(e))}function v(e){se(e),tt(e),D(e),A(e),c.setState(t=>{const n=t.apps.get(e);if(!n)return t;n.iframeRef&&x(n.iframeRef);const s=new Map(t.apps);s.delete(e);const i=new Map(t.presentations);return i.delete(e),{...t,apps:s,presentations:i,activeAppId:t.activeAppId===e?null:t.activeAppId,focusedAppId:t.focusedAppId===e?null:t.focusedAppId}}),c.state.apps.size===0&&z().detach()}function nt(e){ne(e)}function st(e,t,n){const i=c.state.apps.get(e);if(i){Ye(e);const d=i.manifest.targetDesktop??"stack";return te(e,d,{state:"presented",transitionId:null,transitionKind:null}),et(e),k(e),i}const a=!!t.splashScreen,o={appId:e,manifest:t,state:"preparing",flow:"closed",ctx:{capsuleTheme:t.capsuleTheme??"auto"},processStatus:"loading",readiness:"notReady",launchedAt:Date.now(),lastActiveAt:Date.now(),iframeRef:null,iconRef:X(e)};o.iframeRef=Et(e,t.url,n),ds(e,o.iframeRef,t),o.iframeRef.addEventListener("load",()=>{ms(e,"loaded"),t.splashScreen||Xe(e)}),_t(o.iframeRef);const l=t.targetDesktop??"stack",f=Qe("present",e);return c.setState(d=>{const g=d.zOrderSeed+1,S=new Map(d.apps);S.set(e,o);const b=new Map(d.presentations);return b.set(e,{appId:e,desktop:l,state:"presenting",zOrder:g,transitionId:f.id,transitionKind:"present"}),{...d,apps:S,presentations:b,activeAppId:e,focusedAppId:e,zOrderSeed:g}}),m({type:"app:launch",appId:e,manifest:t}),vs(e,l,a),o}function ks(e,t,n){return st(e,t,n)}function k(e){const t=c.state,n=t.apps.get(e);n&&n.state!=="preparing"&&(t.activeAppId&&t.activeAppId!==e&&it(t.activeAppId),n.iframeRef&&n.state==="background"&&Tt(n.iframeRef),_(e,"active"),Ye(e),c.setState(s=>{const i=new Map(s.apps),a=i.get(e);return a&&i.set(e,{...a,lastActiveAt:Date.now()}),{...s,apps:i,activeAppId:e,focusedAppId:e}}),m({type:"app:activate",appId:e}))}function it(e){const t=c.state,n=t.apps.get(e);n&&n.state!=="preparing"&&(n.iframeRef&&yt(n.iframeRef),_(e,"background"),It(c.state.apps,c.state.activeAppId,t.maxBackgroundApps),m({type:"app:deactivate",appId:e}))}function ie(e){const n=c.state.apps.get(e);if(!n)return;se(e),tt(e),A(e),_(e,"closing"),D(e);const s=n.manifest.targetDesktop??"stack",i=Qe("dismiss",e);te(e,s,{state:"dismissing",transitionId:i.id,transitionKind:"dismiss"}),H.set(e,setTimeout(()=>{const a=c.state.presentations.get(e);a&&(a.transitionKind!=="dismiss"||a.transitionId!==i.id||v(e))},Rs)),m({type:"app:close",appId:e})}function Os(e){ie(e)}function Ps(e,t){const s=c.state.apps.get(e);if(!s)return;const i={...s.ctx,...t};c.setState(a=>{const o=new Map(a.apps),l=o.get(e);return l&&o.set(e,{...l,ctx:i}),{...a,apps:o}}),m({type:"app:ctx-change",appId:e,ctx:i})}function Cs(){c.state.apps.forEach((t,n)=>{ie(n),v(n)}),Dt()}function Ms(){c.setState(e=>({...e,isStackViewOpen:!0})),m({type:"stack-view:open"})}function Ns(){c.setState(e=>({...e,isStackViewOpen:!1})),m({type:"stack-view:close"})}function js(e){return U.add(e),()=>U.delete(e)}function Us(){return Array.from(c.state.apps.values())}function Ls(){const e=c.state;return e.activeAppId?e.apps.get(e.activeAppId)??null:null}function Hs(){return c.state.apps.size>0}const Bs={getApps:e=>Array.from(e.apps.values()),getVisualConfig:e=>e.visualConfig,getActiveApp:e=>e.activeAppId?e.apps.get(e.activeAppId)??null:null,getFocusedAppId:e=>e.focusedAppId??e.activeAppId,getFocusedApp:e=>{const t=e.focusedAppId??e.activeAppId;return t?e.apps.get(t)??null:null},getPresentations:e=>Array.from(e.presentations.values()).sort((t,n)=>t.zOrder-n.zOrder),getPresentation:(e,t)=>e.presentations.get(t)??null,hasPresentations:e=>e.presentations.size>0,hasRunningApps:e=>e.apps.size>0,hasRunningStackApps:e=>Array.from(e.apps.values()).some(t=>(t.manifest.targetDesktop??"stack")==="stack"),isStackViewOpen:e=>e.isStackViewOpen,getBackgroundApps:e=>Array.from(e.apps.values()).filter(t=>t.state==="background"),isLaunchOverlayVisible:e=>{const t=e.focusedAppId??e.activeAppId?e.apps.get(e.focusedAppId??e.activeAppId):null;return t?.state==="launching"||t?.state==="splash"},isShowingSplash:e=>(e.focusedAppId??e.activeAppId?e.apps.get(e.focusedAppId??e.activeAppId):null)?.state==="splash",isAnimating:e=>{const t=e.focusedAppId??e.activeAppId?e.apps.get(e.focusedAppId??e.activeAppId):null;return t?.state==="launching"||t?.state==="splash"||t?.state==="closing"}},qs=Object.freeze(Object.defineProperty({__proto__:null,activateApp:k,closeAllApps:Cs,closeApp:ie,closeStackView:Ns,deactivateApp:it,didDismiss:Is,didPresent:Ts,dismissSplash:nt,finalizeCloseApp:v,getActiveApp:Ls,getDesktopAppSlotRect:Ge,getDesktopAppSlotRef:Ke,getDesktopContainerRef:ee,getDesktopGridHostRef:es,getDesktopRect:Fe,getIconInnerRef:Vn,getIconRef:X,getRunningApps:Us,getSlotStatus:j,getSplashBgRef:$n,getSplashIconRef:Fn,getStackContainerRef:as,getStackRect:rs,getWindowInnerRef:Zn,getWindowRef:Gn,hasRunningApps:Hs,launchApp:st,miniappRuntimeSelectors:Bs,miniappRuntimeStore:c,openStackView:Ms,registerDesktopAppSlotRef:ts,registerDesktopContainerRef:ze,registerDesktopGridHostRef:Qn,registerIconInnerRef:Bn,registerIconRef:Hn,registerSplashBgRef:Wn,registerSplashIconRef:zn,registerStackContainerRef:ss,registerWindowInnerRef:Yn,registerWindowRef:Kn,requestDismiss:Os,requestDismissSplash:ne,requestFocus:et,requestPresent:ks,resetMiniappVisualConfig:gs,setMiniappMotionTimeScale:ps,setMiniappVisualConfig:Ze,settleFlow:Ss,subscribe:js,subscribeSlotStatus:Ve,unregisterDesktopAppSlotRef:ns,unregisterDesktopContainerRef:Je,unregisterDesktopGridHostRef:Xn,unregisterIconRef:qn,unregisterSplashBgRef:xn,unregisterSplashIconRef:Jn,unregisterStackContainerRef:is,updateAppContext:Ps,useMiniappVisibilityRestore:cs,useSlotStatus:ls},Symbol.toStringTag,{value:"Module"}));export{ne as A,Is as B,Qn as C,we as D,Xn as E,ts as F,ns as G,Pt as H,Ee as I,ii as J,Ln as K,z as L,Xs as M,ei as N,ti as O,ni as P,si as Q,ai as R,oi as S,ci as T,li as U,ri as V,Qs as W,Zs as a,Bs as b,Cs as c,c as d,p as e,ze as f,Ys as g,Je as h,Hn as i,Bn as j,qn as k,st as l,bt as m,ss as n,Ms as o,is as p,ls as q,gs as r,ps as s,Ke as t,cs as u,Ts as v,Ss as w,Kn as x,Yn as y,Os as z};
