const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./derivation-BZaKSuyr.js","./iframe-Bu8vBBK2.js","./preload-helper-PPVm8Dsz.js","./iframe-dKmOljRT.css","./service--Mqh_DSQ.js","./schemas-CO8_C8zP.js","./index-D0E7N0oa.js"])))=>i.map(i=>d[i]);
import{r as G}from"./iframe-Bu8vBBK2.js";import{c as he,e as QE}from"./service--Mqh_DSQ.js";import{A as ee}from"./amount-BQsqQYGO.js";import{o as Cd,s as _o,u as XE,c as ZE}from"./schemas-CO8_C8zP.js";import"./index-D0E7N0oa.js";import{D as Na,F as eC,u as tC,G as co,j as Dn,H as wo,k as ur,q as Ar,I as GS,J as Qm,K as Xm,L as Zm}from"./derivation-BZaKSuyr.js";import{c as nC,p as rC,i as sC,s as oC}from"./bioforest-BHTl2ieS.js";import{_ as is}from"./preload-helper-PPVm8Dsz.js";class iC extends Error{source;chainId;method;issues;constructor(t){super(`[InvalidData] ${t.source}:${t.chainId}:${t.method}`,{cause:t.cause instanceof Error?t.cause:void 0}),this.name="InvalidDataError",this.source=t.source,this.chainId=t.chainId,this.method=t.method,this.issues=t.issues??[]}}const cC=e=>typeof e=="function",d=function(e,t){if(typeof e=="function")return function(){return e(arguments)?t.apply(this,arguments):n=>t(n,...arguments)};switch(e){case 0:case 1:throw new RangeError(`Invalid arity ${e}`);case 2:return function(n,r){return arguments.length>=2?t(n,r):function(s){return t(s,n)}};case 3:return function(n,r,s){return arguments.length>=3?t(n,r,s):function(o){return t(o,n,r)}};case 4:return function(n,r,s,o){return arguments.length>=4?t(n,r,s,o):function(i){return t(i,n,r,s)}};case 5:return function(n,r,s,o,i){return arguments.length>=5?t(n,r,s,o,i):function(c){return t(c,n,r,s,o)}};default:return function(){if(arguments.length>=e)return t.apply(this,arguments);const n=arguments;return function(r){return t(r,...n)}}}},ne=e=>e,Cu=e=>()=>e,eg=Cu(!0),Gf=Cu(!1),YS=Cu(void 0),Ba=YS;function p(e,t,n,r,s,o,i,c,a){switch(arguments.length){case 1:return e;case 2:return t(e);case 3:return n(t(e));case 4:return r(n(t(e)));case 5:return s(r(n(t(e))));case 6:return o(s(r(n(t(e)))));case 7:return i(o(s(r(n(t(e))))));case 8:return c(i(o(s(r(n(t(e)))))));case 9:return a(c(i(o(s(r(n(t(e))))))));default:{let u=arguments[0];for(let l=1;l<arguments.length;l++)u=arguments[l](u);return u}}}const Iu=e=>(t,n)=>t===n||e(t,n),aC=d(2,(e,t)=>Iu((n,r)=>e(t(n),t(r)))),uC=e=>Iu((t,n)=>{if(t.length!==n.length)return!1;for(let r=0;r<t.length;r++)if(!e(t[r],n[r]))return!1;return!0}),tg="effect/GlobalValue";let di;const be=(e,t)=>(di||(globalThis[tg]??=new Map,di=globalThis[tg]),di.has(e)||di.set(e,t()),di.get(e)),yn=e=>typeof e=="string",yr=e=>typeof e=="number",Vi=e=>typeof e=="boolean",$u=e=>typeof e=="bigint",Yf=e=>typeof e=="symbol",gc=cC,lC=e=>e===void 0,fC=e=>e!==void 0,nf=e=>e!==null,hC=e=>!1,Id=e=>typeof e=="object"&&e!==null,_r=e=>Id(e)||gc(e),re=d(2,(e,t)=>_r(e)&&t in e),QS=d(2,(e,t)=>re(e,"_tag")&&e._tag===t),Ds=e=>e==null,dC=e=>e!=null,pC=e=>e instanceof Date,XS=e=>typeof e=="string"||re(e,Symbol.iterator),mC=e=>Id(e)&&!Array.isArray(e),gC=e=>re(e,"then")&&gc(e.then),Au=e=>`BUG: ${e} - please report an issue at https://github.com/Effect-TS/effect/issues`;let ZS=class eb{self;called=!1;constructor(t){this.self=t}next(t){return this.called?{value:t,done:!0}:(this.called=!0,{value:this.self,done:!1})}return(t){return{value:t,done:!0}}throw(t){throw t}[Symbol.iterator](){return new eb(this.self)}};const yC=335903614,SC=4150755663,bC=1481765933,_C=1284865837,wC=9007199254740992,vC=134217728;class TC{_state;constructor(t,n,r,s){return Ds(n)&&Ds(t)?(n=Math.random()*4294967295>>>0,t=0):Ds(n)&&(n=t,t=0),Ds(s)&&Ds(r)?(s=this._state?this._state[3]:SC,r=this._state?this._state[2]:yC):Ds(s)&&(s=r,r=0),this._state=new Int32Array([0,0,r>>>0,((s||0)|1)>>>0]),this._next(),ng(this._state,this._state[0],this._state[1],t>>>0,n>>>0),this._next(),this}getState(){return[this._state[0],this._state[1],this._state[2],this._state[3]]}setState(t){this._state[0]=t[0],this._state[1]=t[1],this._state[2]=t[2],this._state[3]=t[3]|1}integer(t){return Math.round(this.number()*Number.MAX_SAFE_INTEGER)%t}number(){const t=(this._next()&67108863)*1,n=(this._next()&134217727)*1;return(t*vC+n)/wC}_next(){const t=this._state[0]>>>0,n=this._state[1]>>>0;kC(this._state,t,n,bC,_C),ng(this._state,this._state[0],this._state[1],this._state[2],this._state[3]);let r=t>>>18,s=(n>>>18|t<<14)>>>0;r=(r^t)>>>0,s=(s^n)>>>0;const o=(s>>>27|r<<5)>>>0,i=t>>>27,c=(-i>>>0&31)>>>0;return(o>>>i|o<<c)>>>0}}function kC(e,t,n,r,s){let o=(n>>>16)*(s&65535)>>>0,i=(n&65535)*(s>>>16)>>>0,c=(n&65535)*(s&65535)>>>0,a=(n>>>16)*(s>>>16)+((i>>>16)+(o>>>16))>>>0;i=i<<16>>>0,c=c+i>>>0,c>>>0<i>>>0&&(a=a+1>>>0),o=o<<16>>>0,c=c+o>>>0,c>>>0<o>>>0&&(a=a+1>>>0),a=a+Math.imul(n,r)>>>0,a=a+Math.imul(t,s)>>>0,e[0]=a,e[1]=c}function ng(e,t,n,r,s){let o=t+r>>>0;const i=n+s>>>0;i>>>0<n>>>0&&(o=o+1|0),e[0]=o,e[1]=i}const Qf=Symbol.for("effect/Utils/YieldWrap");class yc{#e;constructor(t){this.#e=t}[Qf](){return this.#e}}function EC(e){if(typeof e=="object"&&e!==null&&Qf in e)return e[Qf]();throw new Error(Au("yieldWrapGet"))}const un=be("effect/Utils/isStructuralRegion",()=>({enabled:!1,tester:void 0})),tb={effect_internal_function:e=>e()},CC={effect_internal_function:e=>e()},IC=tb.effect_internal_function(()=>new Error().stack)?.includes("effect_internal_function")===!0,Kt=IC?tb.effect_internal_function:CC.effect_internal_function,rf=be(Symbol.for("effect/Hash/randomHashCache"),()=>new WeakMap),pe=Symbol.for("effect/Hash"),Q=e=>{if(un.enabled===!0)return 0;switch(typeof e){case"number":return Ad(e);case"bigint":return Ze(e.toString(10));case"boolean":return Ze(String(e));case"symbol":return Ze(String(e));case"string":return Ze(e);case"undefined":return Ze("undefined");case"function":case"object":return e===null?Ze("null"):e instanceof Date?Number.isNaN(e.getTime())?Ze("Invalid Date"):Q(e.toISOString()):e instanceof URL?Q(e.href):$C(e)?e[pe]():$d(e);default:throw new Error(`BUG: unhandled typeof ${typeof e} - please report an issue at https://github.com/Effect-TS/effect/issues`)}},$d=e=>(rf.has(e)||rf.set(e,Ad(Math.floor(Math.random()*Number.MAX_SAFE_INTEGER))),rf.get(e)),ye=e=>t=>t*53^e,Ru=e=>e&3221225471|e>>>1&1073741824,$C=e=>re(e,pe),Ad=e=>{if(e!==e||e===1/0)return 0;let t=e|0;for(t!==e&&(t^=e*4294967295);e>4294967295;)t^=e/=4294967295;return Ru(t)},Ze=e=>{let t=5381,n=e.length;for(;n;)t=t*33^e.charCodeAt(--n);return Ru(t)},AC=(e,t)=>{let n=12289;for(let r=0;r<t.length;r++)n^=p(Ze(t[r]),ye(Q(e[t[r]])));return Ru(n)},nb=e=>AC(e,Object.keys(e)),Sc=e=>{let t=6151;for(let n=0;n<e.length;n++)t=p(t,ye(Q(e[n])));return Ru(t)},Ye=function(){if(arguments.length===1){const n=arguments[0];return function(r){return Object.defineProperty(n,pe,{value(){return r},enumerable:!1}),r}}const e=arguments[0],t=arguments[1];return Object.defineProperty(e,pe,{value(){return t},enumerable:!1}),t},de=Symbol.for("effect/Equal");function ie(){return arguments.length===1?e=>Ma(e,arguments[0]):Ma(arguments[0],arguments[1])}function Ma(e,t){if(e===t)return!0;const n=typeof e;if(n!==typeof t)return!1;if(n==="object"||n==="function"){if(e!==null&&t!==null){if(La(e)&&La(t))return Q(e)===Q(t)&&e[de](t)?!0:un.enabled&&un.tester?un.tester(e,t):!1;if(e instanceof Date&&t instanceof Date){const r=e.getTime(),s=t.getTime();return r===s||Number.isNaN(r)&&Number.isNaN(s)}else if(e instanceof URL&&t instanceof URL)return e.href===t.href}if(un.enabled){if(Array.isArray(e)&&Array.isArray(t))return e.length===t.length&&e.every((r,s)=>Ma(r,t[s]));if(Object.getPrototypeOf(e)===Object.prototype&&Object.getPrototypeOf(t)===Object.prototype){const r=Object.keys(e),s=Object.keys(t);if(r.length===s.length){for(const o of r)if(!(o in t&&Ma(e[o],t[o])))return un.tester?un.tester(e,t):!1;return!0}}return un.tester?un.tester(e,t):!1}}return un.enabled&&un.tester?un.tester(e,t):!1}const La=e=>re(e,de),Rd=()=>ie,Me=Symbol.for("nodejs.util.inspect.custom"),Ge=e=>{try{if(re(e,"toJSON")&&gc(e.toJSON)&&e.toJSON.length===0)return e.toJSON();if(Array.isArray(e))return e.map(Ge)}catch{return{}}return xC(e)},sf="[Circular]";function RC(e){try{return e.toISOString()}catch{return"Invalid Date"}}function OC(e){try{const t=e.toString();return typeof t=="string"?t:String(t)}catch{return"[toString threw]"}}function Od(e){return yn(e)?JSON.stringify(e):String(e)}function jr(e,t){const n=new WeakSet,r=(i,c)=>{const a=i?.constructor;return a&&a!==Object.prototype.constructor&&a.name?`${a.name}(${c})`:c},s=i=>{try{return Reflect.ownKeys(i)}catch{return["[ownKeys threw]"]}};function o(i,c=0){if(Array.isArray(i))return n.has(i)?sf:(n.add(i),`[${i.map(a=>o(a,c)).join(",")}]`);if(pC(i))return RC(i);if(re(i,"toString")&&gc(i.toString)&&i.toString!==Object.prototype.toString&&i.toString!==Array.prototype.toString){const a=OC(i);return i instanceof Error&&i.cause?`${a} (cause: ${o(i.cause,c)})`:a}if(yn(i))return JSON.stringify(i);if(yr(i)||i==null||Vi(i)||Yf(i))return String(i);if($u(i))return String(i)+"n";if(i instanceof Set||i instanceof Map)return n.has(i)?sf:(n.add(i),`${i.constructor.name}(${o(Array.from(i),c)})`);if(_r(i)){if(n.has(i))return sf;n.add(i);const a=s(i);{const u=`{${a.map(l=>`${Od(l)}:${o(i[l],c)}`).join(",")}}`;return r(i,u)}}return String(i)}return o(e,0)}const at=e=>JSON.stringify(e,null,2),vo=(e,t=2)=>{if(typeof e=="string")return e;try{return typeof e=="object"?rb(e,t):String(e)}catch{return String(e)}},rb=(e,t)=>{let n=[];const r=JSON.stringify(e,(s,o)=>typeof o=="object"&&o!==null?n.includes(o)?void 0:n.push(o)&&(cs.fiberRefs!==void 0&&sb(o)?o[Pd](cs.fiberRefs):o):o,t);return n=void 0,r},Pd=Symbol.for("effect/Inspectable/Redactable"),sb=e=>typeof e=="object"&&e!==null&&Pd in e,cs=be("effect/Inspectable/redactableState",()=>({fiberRefs:void 0})),PC=(e,t)=>{const n=cs.fiberRefs;cs.fiberRefs=e;try{return t()}finally{cs.fiberRefs=n}},xC=e=>sb(e)&&cs.fiberRefs!==void 0?e[Pd](cs.fiberRefs):e,Y=(e,t)=>{switch(t.length){case 0:return e;case 1:return t[0](e);case 2:return t[1](t[0](e));case 3:return t[2](t[1](t[0](e)));case 4:return t[3](t[2](t[1](t[0](e))));case 5:return t[4](t[3](t[2](t[1](t[0](e)))));case 6:return t[5](t[4](t[3](t[2](t[1](t[0](e))))));case 7:return t[6](t[5](t[4](t[3](t[2](t[1](t[0](e)))))));case 8:return t[7](t[6](t[5](t[4](t[3](t[2](t[1](t[0](e))))))));case 9:return t[8](t[7](t[6](t[5](t[4](t[3](t[2](t[1](t[0](e)))))))));default:{let n=e;for(let r=0,s=t.length;r<s;r++)n=t[r](n);return n}}},xi="Async",Ou="Commit",xt="Failure",pa="OnFailure",Ha="OnSuccess",Da="OnSuccessAndFailure",Ft="Success",ob="Sync",FC="Tag",Qo="UpdateRuntimeFlags",Ua="While",Fi="Iterator",ib="WithRuntime",ma="Yield",xd="RevertFlags";let NC="3.19.15";const Fd=()=>NC,BC=Symbol.for("effect/Effect"),MC=Symbol.for("effect/Stream"),LC=Symbol.for("effect/Sink"),HC=Symbol.for("effect/Channel"),To={_R:e=>e,_E:e=>e,_A:e=>e,_V:Fd()},DC={_A:e=>e,_In:e=>e,_L:e=>e,_E:e=>e,_R:e=>e},UC={_Env:e=>e,_InErr:e=>e,_InElem:e=>e,_InDone:e=>e,_OutErr:e=>e,_OutElem:e=>e,_OutDone:e=>e},bc={[BC]:To,[MC]:To,[LC]:DC,[HC]:UC,[de](e){return this===e},[pe](){return Ye(this,$d(this))},[Symbol.iterator](){return new ZS(new yc(this))},pipe(){return Y(this,arguments)}},Nd={[pe](){return Ye(this,nb(this))},[de](e){const t=Object.keys(this),n=Object.keys(e);if(t.length!==n.length)return!1;for(const r of t)if(!(r in e&&ie(this[r],e[r])))return!1;return!0}},_c={...bc,_op:Ou},KC={..._c,...Nd},jC=(function(){function e(){}return e.prototype=_c,e})(),cb=Symbol.for("effect/Option"),ab={...bc,[cb]:{_A:e=>e},[Me](){return this.toJSON()},toString(){return at(this.toJSON())}},zC=Object.assign(Object.create(ab),{_tag:"Some",_op:"Some",[de](e){return Bd(e)&&lb(e)&&ie(this.value,e.value)},[pe](){return Ye(this,ye(Q(this._tag))(Q(this.value)))},toJSON(){return{_id:"Option",_tag:this._tag,value:Ge(this.value)}}}),VC=Q("None"),qC=Object.assign(Object.create(ab),{_tag:"None",_op:"None",[de](e){return Bd(e)&&ub(e)},[pe](){return VC},toJSON(){return{_id:"Option",_tag:this._tag}}}),Bd=e=>re(e,cb),ub=e=>e._tag==="None",lb=e=>e._tag==="Some",Md=Object.create(qC),Ka=e=>{const t=Object.create(zC);return t.value=e,t},fb=Symbol.for("effect/Either"),hb={...bc,[fb]:{_R:e=>e},[Me](){return this.toJSON()},toString(){return at(this.toJSON())}},WC=Object.assign(Object.create(hb),{_tag:"Right",_op:"Right",[de](e){return Ld(e)&&pb(e)&&ie(this.right,e.right)},[pe](){return ye(Q(this._tag))(Q(this.right))},toJSON(){return{_id:"Either",_tag:this._tag,right:Ge(this.right)}}}),JC=Object.assign(Object.create(hb),{_tag:"Left",_op:"Left",[de](e){return Ld(e)&&db(e)&&ie(this.left,e.left)},[pe](){return ye(Q(this._tag))(Q(this.left))},toJSON(){return{_id:"Either",_tag:this._tag,left:Ge(this.left)}}}),Ld=e=>re(e,fb),db=e=>e._tag==="Left",pb=e=>e._tag==="Right",GC=e=>{const t=Object.create(JC);return t.left=e,t},YC=e=>{const t=Object.create(WC);return t.right=e,t},me=YC,oe=GC,QC=Ld,Tt=db,Nn=pb,XC=d(2,(e,{onLeft:t,onRight:n})=>Tt(e)?oe(t(e.left)):me(n(e.right))),ZC=d(2,(e,t)=>Tt(e)?oe(t(e.left)):me(e.right)),eI=d(2,(e,t)=>Nn(e)?me(t(e.right)):oe(e.left)),zt=d(2,(e,{onLeft:t,onRight:n})=>Tt(e)?t(e.left):n(e.right)),tI=zt({onLeft:ne,onRight:ne}),mb=d(2,(e,t)=>{if(Nn(e))return e.right;throw t(e.left)}),nI=mb(()=>new Error("getOrThrow called on a Left")),gb=e=>e.length>0,yb=e=>(t,n)=>t===n?0:e(t,n),rI=yb((e,t)=>e<t?-1:1),Sb=d(2,(e,t)=>yb((n,r)=>e(t(n),t(r)))),sI=e=>d(2,(t,n)=>e(t,n)===1),K=()=>Md,U=Ka,oI=Bd,Ue=ub,$e=lb,Fe=d(2,(e,{onNone:t,onSome:n})=>Ue(e)?t():n(e.value)),qe=d(2,(e,t)=>Ue(e)?t():e.value),lr=d(2,(e,t)=>Ue(e)?t():e),iI=d(2,(e,t)=>Ue(e)?U(t()):e),Pu=e=>e==null?K():U(e),Pn=qe(YS),cI=e=>(...t)=>{try{return U(e(...t))}catch{return K()}},ao=d(2,(e,t)=>Ue(e)?K():U(t(e.value))),Xo=d(2,(e,t)=>Ue(e)?K():t(e.value)),aI=d(2,(e,t)=>Ue(e)?K():Pu(t(e.value))),uI=Xo,pi=d(2,(e,t)=>uI(e,n=>t(n)?Ka(n):Md)),lI=e=>Iu((t,n)=>Ue(t)?Ue(n):Ue(n)?!1:e(t.value,n.value)),fI=e=>d(2,(t,n)=>Ue(t)?!1:e(t.value,n)),hI=Rd(),dI=fI(hI),pI=d(2,(e,t)=>Ue(e)?!1:t(e.value)),rg=e=>(t,n)=>Ue(t)?n:Ue(n)?t:U(e(t.value,n.value)),mI=(...e)=>e,xu=e=>new Array(e),gI=d(2,(e,t)=>{const n=Math.max(1,Math.floor(e)),r=new Array(n);for(let s=0;s<n;s++)r[s]=t(s);return r}),Ne=e=>Array.isArray(e)?e:Array.from(e),yI=e=>Array.isArray(e)?e:[e],SI=d(2,(e,{onEmpty:t,onNonEmpty:n})=>wt(e)?n(Vt(e),ms(e)):t()),ja=d(2,(e,t)=>[t,...e]),bI=d(2,(e,t)=>[...e,t]),bb=d(2,(e,t)=>Ne(e).concat(Ne(t))),_I=Array.isArray,wI=e=>e.length===0,vI=wI,ga=gb,wt=gb,_b=(e,t)=>e<0||e>=t.length,TI=(e,t)=>Math.floor(Math.min(Math.max(0,e),t.length)),kI=d(2,(e,t)=>{const n=Math.floor(t);return _b(n,e)?K():U(e[n])}),wb=d(2,(e,t)=>{const n=Math.floor(t);if(_b(n,e))throw new Error(`Index ${n} out of bounds`);return e[n]}),Ni=kI(0),Vt=wb(0),EI=e=>wt(e)?U(vb(e)):K(),vb=e=>e[e.length-1],ms=e=>e.slice(1),CI=(e,t)=>{let n=0;for(const r of e){if(!t(r,n))break;n++}return n},II=d(2,(e,t)=>Tb(e,CI(e,t))),$I=d(2,(e,t)=>{const n=Ne(e);return n.slice(TI(t,n),n.length)}),sg=e=>Array.from(e).reverse(),qi=d(2,(e,t)=>{const n=Array.from(e);return n.sort(t),n}),og=d(2,(e,t)=>AI(e,t,mI)),AI=d(3,(e,t,n)=>{const r=Ne(e),s=Ne(t);if(wt(r)&&wt(s)){const o=[n(Vt(r),Vt(s))],i=Math.min(r.length,s.length);for(let c=1;c<i;c++)o[c]=n(r[c],s[c]);return o}return[]}),RI=Rd(),Tb=d(2,(e,t)=>{const n=Array.from(e),r=Math.floor(t);return wt(n)?r>=1?OI(n,r):[[],n]:[n,[]]}),OI=d(2,(e,t)=>{const n=Math.max(1,Math.floor(t));return n>=e.length?[Ei(e),[]]:[ja(e.slice(1,n),Vt(e)),e.slice(n)]}),Ei=e=>e.slice(),PI=d(3,(e,t,n)=>{const r=Ne(e),s=Ne(t);return wt(r)?wt(s)?kb(n)(bb(r,s)):r:s}),ya=d(2,(e,t)=>PI(e,t,RI)),gs=()=>[],bn=e=>[e],as=d(2,(e,t)=>e.map(t)),za=d(2,(e,t)=>{if(vI(e))return[];const n=[];for(let r=0;r<e.length;r++){const s=t(e[r],r);for(let o=0;o<s.length;o++)n.push(s[o])}return n}),xI=za(ne),FI=d(2,(e,t)=>{const n=Ne(e),r=[];for(let s=0;s<n.length;s++){const o=t(n[s],s);$e(o)&&r.push(o.value)}return r}),NI=d(2,(e,t)=>{const n=Ne(e),r=[];for(let s=0;s<n.length;s++)t(n[s],s)&&r.push(n[s]);return r}),Hd=d(3,(e,t,n)=>Ne(e).reduce((r,s,o)=>n(r,s,o),t)),ig=(e,t)=>{const n=[];let r=e,s;for(;$e(s=t(r));){const[o,i]=s.value;n.push(o),r=i}return n},Dd=uC,kb=d(2,(e,t)=>{const n=Ne(e);if(wt(n)){const r=[Vt(n)],s=ms(n);for(const o of s)r.every(i=>!t(o,i))&&r.push(o);return r}return[]}),BI=e=>kb(e,Rd()),Zo=d(2,(e,t)=>Ne(e).join(t)),Eb=(e,t)=>{switch(t._tag){case"StringKeyword":case"TemplateLiteral":return Object.keys(e);case"SymbolKeyword":return Object.getOwnPropertySymbols(e);case"Refinement":return Eb(e,t.from)}},Cb=e=>{let t=!1,n;return()=>(t||(n=e(),t=!0),n)},Ib=e=>Array.isArray(e),cg=e=>`[${Od(e)}]`,$b=e=>Ib(e)?e.map(cg).join(""):cg(e),zr=(e,t,n,r)=>{let s=e;return n&&wt(n)&&(s+=`
at path: ${$b(n)}`),t!==void 0&&(s+=`
details: ${t}`),r&&(s+=`
schema (${r._tag}): ${r}`),s},Ab=(e,t,n)=>zr("Unsupported schema or overlapping types",`cannot extend ${e} with ${t}`,n),MI=e=>zr("Unsupported key schema",void 0,void 0,e),LI=e=>zr("Unsupported literal",`literal value: ${jr(e)}`),ag=e=>zr("Duplicate index signature",`${e} index signature`),HI=zr("Unsupported index signature parameter","An index signature parameter type must be `string`, `symbol`, a template literal type or a refinement of the previous types"),DI=zr("Invalid element","A required element cannot follow an optional element. ts(1257)"),ug=e=>zr("Duplicate property signature transformation",`Duplicate key ${jr(e)}`),Rb=e=>zr("Duplicate property signature",`Duplicate key ${jr(e)}`),ko=rI,Va=e=>e.replace(/[/\\^$*+?.()|[\]{}]/g,"\\$&"),UI=Symbol.for("effect/annotation/TypeConstructor"),KI=Symbol.for("effect/annotation/Brand"),jI=Symbol.for("effect/annotation/SchemaId"),Ob=Symbol.for("effect/annotation/Message"),Ud=Symbol.for("effect/annotation/MissingMessage"),Fu=Symbol.for("effect/annotation/Identifier"),Qn=Symbol.for("effect/annotation/Title"),uo=Symbol.for("effect/annotation/AutoTitle"),ei=Symbol.for("effect/annotation/Description"),Pb=Symbol.for("effect/annotation/Examples"),xb=Symbol.for("effect/annotation/Default"),Fb=Symbol.for("effect/annotation/JSONSchema"),Nb=Symbol.for("effect/annotation/Arbitrary"),Bb=Symbol.for("effect/annotation/Pretty"),Mb=Symbol.for("effect/annotation/Equivalence"),zI=Symbol.for("effect/annotation/Documentation"),Lb=Symbol.for("effect/annotation/Concurrency"),Hb=Symbol.for("effect/annotation/Batching"),Db=Symbol.for("effect/annotation/ParseIssueTitle"),Ub=Symbol.for("effect/annotation/ParseOptions"),Kb=Symbol.for("effect/annotation/DecodingFallback"),qa=Symbol.for("effect/annotation/Surrogate"),VI=Symbol.for("effect/annotation/StableFilter"),qt=d(2,(e,t)=>Object.prototype.hasOwnProperty.call(e.annotations,t)?U(e.annotations[t]):K()),qI=qt(KI),WI=qt(Ob),JI=qt(Ud),jb=qt(Qn),zb=qt(uo),Nu=qt(Fu),Vb=qt(ei),GI=qt(Lb),YI=qt(Hb),QI=qt(Db),XI=qt(Ub),ZI=qt(Kb),qb=qt(qa),e$=qt(VI),t$=e=>pI(e$(e),t=>t===!0),Wb=Symbol.for("effect/annotation/JSONIdentifier"),n$=qt(Wb),r$=e=>lr(n$(e),()=>Nu(e));class Bu{typeParameters;decodeUnknown;encodeUnknown;annotations;_tag="Declaration";constructor(t,n,r,s={}){this.typeParameters=t,this.decodeUnknown=n,this.encodeUnknown=r,this.annotations=s}toString(){return qe(zn(this),()=>"<declaration schema>")}toJSON(){return{_tag:this._tag,typeParameters:this.typeParameters.map(t=>t.toJSON()),annotations:ht(this.annotations)}}}const wr=e=>t=>t._tag===e;let Wa=class{literal;annotations;_tag="Literal";constructor(t,n={}){this.literal=t,this.annotations=n}toString(){return qe(zn(this),()=>jr(this.literal))}toJSON(){return{_tag:this._tag,literal:$u(this.literal)?String(this.literal):this.literal,annotations:ht(this.annotations)}}};const Bi=wr("Literal"),s$=new Wa(null);class o${symbol;annotations;_tag="UniqueSymbol";constructor(t,n={}){this.symbol=t,this.annotations=n}toString(){return qe(zn(this),()=>jr(this.symbol))}toJSON(){return{_tag:this._tag,symbol:String(this.symbol),annotations:ht(this.annotations)}}}class i${annotations;_tag="UndefinedKeyword";constructor(t={}){this.annotations=t}toString(){return Vr(this)}toJSON(){return{_tag:this._tag,annotations:ht(this.annotations)}}}const Xf=new i$({[Qn]:"undefined"});class c${annotations;_tag="NeverKeyword";constructor(t={}){this.annotations=t}toString(){return Vr(this)}toJSON(){return{_tag:this._tag,annotations:ht(this.annotations)}}}const Kd=new c$({[Qn]:"never"});class a${annotations;_tag="UnknownKeyword";constructor(t={}){this.annotations=t}toString(){return Vr(this)}toJSON(){return{_tag:this._tag,annotations:ht(this.annotations)}}}const Jb=new a$({[Qn]:"unknown"});class u${annotations;_tag="AnyKeyword";constructor(t={}){this.annotations=t}toString(){return Vr(this)}toJSON(){return{_tag:this._tag,annotations:ht(this.annotations)}}}const l$=new u$({[Qn]:"any"});class f${annotations;_tag="StringKeyword";constructor(t={}){this.annotations=t}toString(){return Vr(this)}toJSON(){return{_tag:this._tag,annotations:ht(this.annotations)}}}const Zf=new f$({[Qn]:"string",[ei]:"a string"}),eh=wr("StringKeyword");class h${annotations;_tag="NumberKeyword";constructor(t={}){this.annotations=t}toString(){return Vr(this)}toJSON(){return{_tag:this._tag,annotations:ht(this.annotations)}}}const th=new h$({[Qn]:"number",[ei]:"a number"}),lg=wr("NumberKeyword");class d${annotations;_tag="BooleanKeyword";constructor(t={}){this.annotations=t}toString(){return Vr(this)}toJSON(){return{_tag:this._tag,annotations:ht(this.annotations)}}}const nh=new d$({[Qn]:"boolean",[ei]:"a boolean"}),fg=wr("BooleanKeyword");class p${annotations;_tag="BigIntKeyword";constructor(t={}){this.annotations=t}toString(){return Vr(this)}toJSON(){return{_tag:this._tag,annotations:ht(this.annotations)}}}const m$=new p$({[Qn]:"bigint",[ei]:"a bigint"}),g$=wr("SymbolKeyword");let Mu=class{type;annotations;constructor(t,n={}){this.type=t,this.annotations=n}toJSON(){return{type:this.type.toJSON(),annotations:ht(this.annotations)}}toString(){return String(this.type)}};class Is extends Mu{isOptional;constructor(t,n,r={}){super(t,r),this.isOptional=n}toJSON(){return{type:this.type.toJSON(),isOptional:this.isOptional,annotations:ht(this.annotations)}}toString(){return String(this.type)+(this.isOptional?"?":"")}}const Gb=e=>e.map(t=>t.type);class jd{elements;rest;isReadonly;annotations;_tag="TupleType";constructor(t,n,r,s={}){this.elements=t,this.rest=n,this.isReadonly=r,this.annotations=s;let o=!1,i=!1;for(const c of t)if(c.isOptional)o=!0;else if(o){i=!0;break}if(i||o&&n.length>1)throw new Error(DI)}toString(){return qe(zn(this),()=>y$(this))}toJSON(){return{_tag:this._tag,elements:this.elements.map(t=>t.toJSON()),rest:this.rest.map(t=>t.toJSON()),isReadonly:this.isReadonly,annotations:ht(this.annotations)}}}const y$=e=>{const t=e.elements.map(String).join(", ");return SI(e.rest,{onEmpty:()=>`readonly [${t}]`,onNonEmpty:(n,r)=>{const s=String(n),o=s.includes(" | ")?`(${s})`:s;if(r.length>0){const i=r.map(String).join(", ");return e.elements.length>0?`readonly [${t}, ...${o}[], ${i}]`:`readonly [...${o}[], ${i}]`}else return e.elements.length>0?`readonly [${t}, ...${o}[]]`:`ReadonlyArray<${s}>`}})};class At extends Is{name;isReadonly;constructor(t,n,r,s,o){super(n,r,o),this.name=t,this.isReadonly=s}toString(){return(this.isReadonly?"readonly ":"")+String(this.name)+(this.isOptional?"?":"")+": "+this.type}toJSON(){return{name:String(this.name),type:this.type.toJSON(),isOptional:this.isOptional,isReadonly:this.isReadonly,annotations:ht(this.annotations)}}}const Yb=e=>{switch(e._tag){case"StringKeyword":case"SymbolKeyword":case"TemplateLiteral":return!0;case"Refinement":return Yb(e.from)}return!1};class Lu{type;isReadonly;parameter;constructor(t,n,r){if(this.type=n,this.isReadonly=r,Yb(t))this.parameter=t;else throw new Error(HI)}toString(){return(this.isReadonly?"readonly ":"")+`[x: ${this.parameter}]: ${this.type}`}toJSON(){return{parameter:this.parameter.toJSON(),type:this.type.toJSON(),isReadonly:this.isReadonly}}}class Pr{annotations;_tag="TypeLiteral";propertySignatures;indexSignatures;constructor(t,n,r={}){this.annotations=r;const s={};for(let i=0;i<t.length;i++){const c=t[i].name;if(Object.prototype.hasOwnProperty.call(s,c))throw new Error(Rb(c));s[c]=null}const o={string:!1,symbol:!1};for(let i=0;i<n.length;i++){const c=r_(n[i].parameter);if(eh(c)){if(o.string)throw new Error(ag("string"));o.string=!0}else if(g$(c)){if(o.symbol)throw new Error(ag("symbol"));o.symbol=!0}}this.propertySignatures=t,this.indexSignatures=n}toString(){return qe(zn(this),()=>S$(this))}toJSON(){return{_tag:this._tag,propertySignatures:this.propertySignatures.map(t=>t.toJSON()),indexSignatures:this.indexSignatures.map(t=>t.toJSON()),annotations:ht(this.annotations)}}}const hg=e=>e.map(String).join("; "),S$=e=>{if(e.propertySignatures.length>0){const t=e.propertySignatures.map(String).join("; ");return e.indexSignatures.length>0?`{ ${t}; ${hg(e.indexSignatures)} }`:`{ ${t} }`}else return e.indexSignatures.length>0?`{ ${hg(e.indexSignatures)} }`:"{}"},dg=wr("TypeLiteral"),b$=qi(Sb(ko,e=>{switch(e._tag){case"AnyKeyword":return 0;case"UnknownKeyword":return 1;case"ObjectKeyword":return 2;case"StringKeyword":case"NumberKeyword":case"BooleanKeyword":case"BigIntKeyword":case"SymbolKeyword":return 3}return 4})),_$={string:"StringKeyword",number:"NumberKeyword",boolean:"BooleanKeyword",bigint:"BigIntKeyword"},Qb=e=>za(e,t=>Vd(t)?Qb(t.types):[t]),w$=e=>{const t=b$(e),n=[],r={},s=[];for(const o of t)switch(o._tag){case"NeverKeyword":break;case"AnyKeyword":return[l$];case"UnknownKeyword":return[Jb];case"ObjectKeyword":case"UndefinedKeyword":case"VoidKeyword":case"StringKeyword":case"NumberKeyword":case"BooleanKeyword":case"BigIntKeyword":case"SymbolKeyword":{r[o._tag]||(r[o._tag]=o,n.push(o));break}case"Literal":{const i=typeof o.literal;switch(i){case"string":case"number":case"bigint":case"boolean":{const c=_$[i];!r[c]&&!s.includes(o.literal)&&(s.push(o.literal),n.push(o));break}case"object":{s.includes(o.literal)||(s.push(o.literal),n.push(o));break}}break}case"UniqueSymbol":{!r.SymbolKeyword&&!s.includes(o.symbol)&&(s.push(o.symbol),n.push(o));break}case"TupleType":{r.ObjectKeyword||n.push(o);break}case"TypeLiteral":{o.propertySignatures.length===0&&o.indexSignatures.length===0?r["{}"]||(r["{}"]=o,n.push(o)):r.ObjectKeyword||n.push(o);break}default:n.push(o)}return n};let _n=class rh{types;annotations;static make=(t,n)=>zd(t)?new rh(t,n):t.length===1?t[0]:Kd;static unify=(t,n)=>rh.make(w$(Qb(t)),n);_tag="Union";constructor(t,n={}){this.types=t,this.annotations=n}toString(){return qe(zn(this),()=>this.types.map(String).join(" | "))}toJSON(){return{_tag:this._tag,types:this.types.map(t=>t.toJSON()),annotations:ht(this.annotations)}}};const v$=(e,t)=>e.map(t),zd=e=>e.length>1,Vd=wr("Union"),of=be(Symbol.for("effect/Schema/AST/toJSONMemoMap"),()=>new WeakMap);class Ja{f;annotations;_tag="Suspend";constructor(t,n={}){this.f=t,this.annotations=n,this.f=Cb(t)}toString(){return zn(this).pipe(lr(()=>Xo(cI(this.f)(),t=>zn(t))),qe(()=>"<suspended schema>"))}toJSON(){const t=this.f();let n=of.get(t);return n||(of.set(t,{_tag:this._tag}),n={_tag:this._tag,ast:t.toJSON(),annotations:ht(this.annotations)},of.set(t,n),n)}}let Xb=class{from;filter;annotations;_tag="Refinement";constructor(t,n,r={}){this.from=t,this.filter=n,this.annotations=r}toString(){return Nu(this).pipe(qe(()=>Fe(s_(this),{onNone:()=>`{ ${this.from} | filter }`,onSome:t=>lo(this.from)?String(this.from)+" & "+t:t})))}toJSON(){return{_tag:this._tag,from:this.from.toJSON(),annotations:ht(this.annotations)}}};const lo=wr("Refinement"),cf={};let to=class{from;to;transformation;annotations;_tag="Transformation";constructor(t,n,r,s={}){this.from=t,this.to=n,this.transformation=r,this.annotations=s}toString(){return qe(zn(this),()=>`(${String(this.from)} <-> ${String(this.to)})`)}toJSON(){return{_tag:this._tag,from:this.from.toJSON(),to:this.to.toJSON(),annotations:ht(this.annotations)}}};const T$=wr("Transformation");class Zb{decode;encode;_tag="FinalTransformation";constructor(t,n){this.decode=t,this.encode=n}}const k$=e=>t=>t._tag===e;class E${_tag="ComposeTransformation"}const C$=new E$;let I$=class{from;to;decode;encode;constructor(t,n,r,s){this.from=t,this.to=n,this.decode=r,this.encode=s}};class sh{propertySignatureTransformations;_tag="TypeLiteralTransformation";constructor(t){this.propertySignatureTransformations=t;const n={},r={};for(const s of t){const o=s.from;if(n[o])throw new Error(ug(o));n[o]=!0;const i=s.to;if(r[i])throw new Error(ug(i));r[i]=!0}}}const pg=k$("TypeLiteralTransformation"),qd=(e,t)=>{const n=Object.getOwnPropertyDescriptors(e),r={...e.annotations};delete r[Fu];const s={...r,...t},o=qb(e);return $e(o)&&(s[qa]=qd(o.value,t)),n.annotations.value=s,Object.create(Object.getPrototypeOf(e),n)},$$="[\\s\\S]*?",A$="[+-]?\\d*\\.?\\d+(?:[Ee][+-]?\\d+)?",e_=(e,t)=>{switch(e._tag){case"Literal":return Va(String(e.literal));case"StringKeyword":return $$;case"NumberKeyword":return A$;case"TemplateLiteral":return t_(e);case"Union":return e.types.map(n=>e_(n)).join("|")}},R$=(e,t,n,r)=>Vd(e)?`(${t})`:t,t_=(e,t,n)=>{let r="";if(e.head!==""){const s=Va(e.head);r+=s}for(const s of e.spans){const o=e_(s.type);if(r+=R$(s.type,o),s.literal!==""){const i=Va(s.literal);r+=i}}return r},O$=e=>new RegExp(`^${t_(e)}$`),mg=(e,t)=>{const n=[],r=[],s=o=>{switch(o._tag){case"NeverKeyword":break;case"StringKeyword":case"SymbolKeyword":case"TemplateLiteral":case"Refinement":r.push(new Lu(o,t,!0));break;case"Literal":if(yn(o.literal)||yr(o.literal))n.push(new At(o.literal,t,!1,!0));else throw new Error(LI(o.literal));break;case"Enums":{for(const[i,c]of o.enums)n.push(new At(c,t,!1,!0));break}case"UniqueSymbol":n.push(new At(o.symbol,t,!1,!0));break;case"Union":o.types.forEach(s);break;default:throw new Error(MI(o))}};return s(e),{propertySignatures:n,indexSignatures:r}},n_=e=>t=>{let n;for(const r of e)Object.prototype.hasOwnProperty.call(t.annotations,r)&&(n===void 0&&(n={}),n[r]=t.annotations[r]);return n},P$=e=>t=>{const n={...t.annotations};for(const r of e)delete n[r];return n},x$=n_([Pb,xb,Fb,Nb,Bb,Mb]),lt=e=>{switch(e._tag){case"Declaration":{const t=fn(e.typeParameters,lt);return t===e.typeParameters?e:new Bu(t,e.decodeUnknown,e.encodeUnknown,e.annotations)}case"TupleType":{const t=fn(e.elements,s=>{const o=lt(s.type);return o===s.type?s:new Is(o,s.isOptional)}),n=Gb(e.rest),r=fn(n,lt);return t===e.elements&&r===n?e:new jd(t,r.map(s=>new Mu(s)),e.isReadonly,e.annotations)}case"TypeLiteral":{const t=fn(e.propertySignatures,r=>{const s=lt(r.type);return s===r.type?r:new At(r.name,s,r.isOptional,r.isReadonly)}),n=fn(e.indexSignatures,r=>{const s=lt(r.type);return s===r.type?r:new Lu(r.parameter,s,r.isReadonly)});return t===e.propertySignatures&&n===e.indexSignatures?e:new Pr(t,n,e.annotations)}case"Union":{const t=fn(e.types,lt);return t===e.types?e:_n.make(t,e.annotations)}case"Suspend":return new Ja(()=>lt(e.f()),e.annotations);case"Refinement":{const t=lt(e.from);return t===e.from?e:new Xb(t,e.filter,e.annotations)}case"Transformation":{const t=x$(e);return lt(t!==void 0?qd(e.to,t):e.to)}}return e};function fn(e,t){let n=!1;const r=xu(e.length);for(let s=0;s<e.length;s++){const o=e[s],i=t(o);i!==o&&(n=!0),r[s]=i}return n?r:e}const Rn=(e,t)=>{switch(e._tag){case"Declaration":{const n=fn(e.typeParameters,r=>Rn(r));return n===e.typeParameters?e:new Bu(n,e.decodeUnknown,e.encodeUnknown)}case"TupleType":{const n=fn(e.elements,o=>{const i=Rn(o.type);return i===o.type?o:new Is(i,o.isOptional)}),r=Gb(e.rest),s=fn(r,o=>Rn(o));return n===e.elements&&s===r?e:new jd(n,s.map(o=>new Mu(o)),e.isReadonly)}case"TypeLiteral":{const n=fn(e.propertySignatures,s=>{const o=Rn(s.type);return o===s.type?s:new At(s.name,o,s.isOptional,s.isReadonly)}),r=fn(e.indexSignatures,s=>{const o=Rn(s.type);return o===s.type?s:new Lu(s.parameter,o,s.isReadonly)});return n===e.propertySignatures&&r===e.indexSignatures?e:new Pr(n,r)}case"Union":{const n=fn(e.types,r=>Rn(r));return n===e.types?e:_n.make(n)}case"Suspend":{let n;const r=r$(e);return $e(r)&&(n={[Wb]:`${r.value}Encoded`}),new Ja(()=>Rn(e.f()),n)}case"Refinement":return Rn(e.from);case"Transformation":return Rn(e.from)}return e},oh=e=>Rn(e),ht=e=>{const t={};for(const n of Object.getOwnPropertySymbols(e))t[String(n)]=e[n];return t},r_=e=>{switch(e._tag){case"StringKeyword":case"SymbolKeyword":case"TemplateLiteral":return e;case"Refinement":return r_(e.from)}},Vr=e=>qe(zn(e),()=>e._tag);function F$(e){return Fe(qI(e),{onNone:()=>"",onSome:t=>t.map(n=>` & Brand<${jr(n)}>`).join("")})}const s_=e=>jb(e).pipe(lr(()=>Vb(e)),lr(()=>zb(e)),ao(t=>t+F$(e))),zn=e=>lr(Nu(e),()=>s_(e)),N$=Symbol.for("effect/Context/Tag"),Ga=Symbol.for("effect/Context/Reference"),B$="effect/STM",M$=Symbol.for(B$),o_={...bc,_op:"Tag",[M$]:To,[N$]:{_Service:e=>e,_Identifier:e=>e},toString(){return at(this.toJSON())},toJSON(){return{_id:"Tag",key:this.key,stack:this.stack}},[Me](){return this.toJSON()},of(e){return e},context(e){return a_(this,e)}},L$={...o_,[Ga]:Ga},H$=e=>{const t=Error.stackTraceLimit;Error.stackTraceLimit=2;const n=new Error;Error.stackTraceLimit=t;const r=Object.create(o_);return Object.defineProperty(r,"stack",{get(){return n.stack}}),r.key=e,r},D$=()=>(e,t)=>{const n=Error.stackTraceLimit;Error.stackTraceLimit=2;const r=new Error;Error.stackTraceLimit=n;function s(){}return Object.setPrototypeOf(s,L$),s.key=e,s.defaultValue=t.defaultValue,Object.defineProperty(s,"stack",{get(){return r.stack}}),s},i_=Symbol.for("effect/Context"),U$={[i_]:{_Services:e=>e},[de](e){if(c_(e)&&this.unsafeMap.size===e.unsafeMap.size){for(const t of this.unsafeMap.keys())if(!e.unsafeMap.has(t)||!ie(this.unsafeMap.get(t),e.unsafeMap.get(t)))return!1;return!0}return!1},[pe](){return Ye(this,Ad(this.unsafeMap.size))},pipe(){return Y(this,arguments)},toString(){return at(this.toJSON())},toJSON(){return{_id:"Context",services:Array.from(this.unsafeMap).map(Ge)}},[Me](){return this.toJSON()}},ys=e=>{const t=Object.create(U$);return t.unsafeMap=e,t},K$=e=>{const t=new Error(`Service not found${e.key?`: ${String(e.key)}`:""}`);if(e.stack){const n=e.stack.split(`
`);if(n.length>2){const r=n[2].match(/at (.*)/);r&&(t.message=t.message+` (defined at ${r[1]})`)}}if(t.stack){const n=t.stack.split(`
`);n.splice(1,3),t.stack=n.join(`
`)}return t},c_=e=>re(e,i_),j$=e=>re(e,Ga),z$=ys(new Map),V$=()=>z$,a_=(e,t)=>ys(new Map([[e.key,t]])),q$=d(3,(e,t,n)=>{const r=new Map(e.unsafeMap);return r.set(t.key,n),ys(r)}),af=be("effect/Context/defaultValueCache",()=>new Map),Wd=e=>{if(af.has(e.key))return af.get(e.key);const t=e.defaultValue();return af.set(e.key,t),t},W$=(e,t)=>e.unsafeMap.has(t.key)?e.unsafeMap.get(t.key):Wd(t),u_=d(2,(e,t)=>{if(!e.unsafeMap.has(t.key)){if(Ga in t)return Wd(t);throw K$(t)}return e.unsafeMap.get(t.key)}),J$=u_,G$=d(2,(e,t)=>e.unsafeMap.has(t.key)?Ka(e.unsafeMap.get(t.key)):j$(t)?Ka(Wd(t)):Md),Y$=d(2,(e,t)=>{const n=new Map(e.unsafeMap);for(const[r,s]of t.unsafeMap)n.set(r,s);return ys(n)}),Q$=(...e)=>{const t=new Map;for(let n=0;n<e.length;n++)e[n].unsafeMap.forEach((r,s)=>{t.set(s,r)});return ys(t)},$s=H$,X$=c_,Jd=V$,Z$=a_,Zr=q$,l_=J$,f_=u_,wc=G$,Hu=Y$,eA=Q$,Du=D$,h_=Symbol.for("effect/Chunk");function tA(e,t,n,r,s){for(let o=t;o<Math.min(e.length,t+s);o++)n[r+o-t]=e[o];return n}const d_=[],nA=e=>Iu((t,n)=>t.length===n.length&&fr(t).every((r,s)=>e(r,hr(n,s)))),rA=nA(ie),sA={[h_]:{_A:e=>e},toString(){return at(this.toJSON())},toJSON(){return{_id:"Chunk",values:fr(this).map(Ge)}},[Me](){return this.toJSON()},[de](e){return Gd(e)&&rA(this,e)},[pe](){return Ye(this,Sc(fr(this)))},[Symbol.iterator](){switch(this.backing._tag){case"IArray":return this.backing.array[Symbol.iterator]();case"IEmpty":return d_[Symbol.iterator]();default:return fr(this)[Symbol.iterator]()}},pipe(){return Y(this,arguments)}},Xe=e=>{const t=Object.create(sA);switch(t.backing=e,e._tag){case"IEmpty":{t.length=0,t.depth=0,t.left=t,t.right=t;break}case"IConcat":{t.length=e.left.length+e.right.length,t.depth=1+Math.max(e.left.depth,e.right.depth),t.left=e.left,t.right=e.right;break}case"IArray":{t.length=e.array.length,t.depth=0,t.left=wn,t.right=wn;break}case"ISingleton":{t.length=1,t.depth=0,t.left=wn,t.right=wn;break}case"ISlice":{t.length=e.length,t.depth=e.chunk.depth+1,t.left=wn,t.right=wn;break}}return t},Gd=e=>re(e,h_),wn=Xe({_tag:"IEmpty"}),We=()=>wn,Sa=(...e)=>aA(e),Be=e=>Xe({_tag:"ISingleton",a:e}),Wi=e=>Gd(e)?e:on(Ne(e)),ih=(e,t,n)=>{switch(e.backing._tag){case"IArray":{tA(e.backing.array,0,t,n,e.length);break}case"IConcat":{ih(e.left,t,n),ih(e.right,t,n+e.left.length);break}case"ISingleton":{t[n]=e.backing.a;break}case"ISlice":{let r=0,s=n;for(;r<e.length;)t[s]=hr(e,r),r+=1,s+=1;break}}},oA=e=>{switch(e.backing._tag){case"IEmpty":return d_;case"IArray":return e.backing.array;default:{const t=new Array(e.length);return ih(e,t,0),e.backing={_tag:"IArray",array:t},e.left=wn,e.right=wn,e.depth=0,t}}},fr=oA,iA=e=>{switch(e.backing._tag){case"IEmpty":case"ISingleton":return e;case"IArray":return Xe({_tag:"IArray",array:sg(e.backing.array)});case"IConcat":return Xe({_tag:"IConcat",left:Sr(e.backing.right),right:Sr(e.backing.left)});case"ISlice":return on(sg(fr(e)))}},Sr=iA,cA=d(2,(e,t)=>t<0||t>=e.length?K():U(hr(e,t))),on=e=>e.length===0?We():e.length===1?Be(e[0]):Xe({_tag:"IArray",array:e}),aA=e=>on(e),hr=d(2,(e,t)=>{switch(e.backing._tag){case"IEmpty":throw new Error("Index out of bounds");case"ISingleton":{if(t!==0)throw new Error("Index out of bounds");return e.backing.a}case"IArray":{if(t>=e.length||t<0)throw new Error("Index out of bounds");return e.backing.array[t]}case"IConcat":return t<e.left.length?hr(e.left,t):hr(e.right,t-e.left.length);case"ISlice":return hr(e.backing.chunk,t+e.backing.offset)}}),Eo=d(2,(e,t)=>bt(e,Be(t))),Bt=d(2,(e,t)=>bt(Be(t),e)),ch=d(2,(e,t)=>{if(t<=0)return wn;if(t>=e.length)return e;switch(e.backing._tag){case"ISlice":return Xe({_tag:"ISlice",chunk:e.backing.chunk,length:t,offset:e.backing.offset});case"IConcat":return t>e.left.length?Xe({_tag:"IConcat",left:e.left,right:ch(e.right,t-e.left.length)}):ch(e.left,t);default:return Xe({_tag:"ISlice",chunk:e,offset:0,length:t})}}),Ji=d(2,(e,t)=>{if(t<=0)return e;if(t>=e.length)return wn;switch(e.backing._tag){case"ISlice":return Xe({_tag:"ISlice",chunk:e.backing.chunk,offset:e.backing.offset+t,length:e.backing.length-t});case"IConcat":return t>e.left.length?Ji(e.right,t-e.left.length):Xe({_tag:"IConcat",left:Ji(e.left,t),right:e.right});default:return Xe({_tag:"ISlice",chunk:e,offset:t,length:e.length-t})}}),bt=d(2,(e,t)=>{if(e.backing._tag==="IEmpty")return t;if(t.backing._tag==="IEmpty")return e;const n=t.depth-e.depth;if(Math.abs(n)<=1)return Xe({_tag:"IConcat",left:e,right:t});if(n<-1)if(e.left.depth>=e.right.depth){const r=bt(e.right,t);return Xe({_tag:"IConcat",left:e.left,right:r})}else{const r=bt(e.right.right,t);if(r.depth===e.depth-3){const s=Xe({_tag:"IConcat",left:e.right.left,right:r});return Xe({_tag:"IConcat",left:e.left,right:s})}else{const s=Xe({_tag:"IConcat",left:e.left,right:e.right.left});return Xe({_tag:"IConcat",left:s,right:r})}}else if(t.right.depth>=t.left.depth){const r=bt(e,t.left);return Xe({_tag:"IConcat",left:r,right:t.right})}else{const r=bt(e,t.left.left);if(r.depth===t.depth-3){const s=Xe({_tag:"IConcat",left:r,right:t.left.right});return Xe({_tag:"IConcat",left:s,right:t.right})}else{const s=Xe({_tag:"IConcat",left:t.left.right,right:t.right});return Xe({_tag:"IConcat",left:r,right:s})}}}),p_=d(2,(e,t)=>on(FI(e,t))),Uu=d(2,(e,t)=>on(NI(e,t))),Ku=e=>e.length===0,Vn=e=>e.length>0,Yd=cA(0),m_=e=>hr(e,0),Bn=m_,g_=d(2,(e,t)=>e.backing._tag==="ISingleton"?Be(t(e.backing.a,0)):on(p(fr(e),as((n,r)=>t(n,r))))),uA=d(2,(e,t)=>[ch(e,t),Ji(e,t)]),lA=d(2,(e,t)=>{let n=0;for(const r of fr(e)){if(t(r))break;n++}return uA(e,n)}),cr=e=>Ji(e,1),y_=Hd,ah=Symbol.for("effect/Duration"),S_=BigInt(0),gg=BigInt(24),Yc=BigInt(60),uh=BigInt(1e3),yg=BigInt(1e6),Sg=BigInt(1e9),fA=/^(-?\d+(?:\.\d+)?)\s+(nanos?|micros?|millis?|seconds?|minutes?|hours?|days?|weeks?)$/,Jt=e=>{if(b_(e))return e;if(yr(e))return ae(e);if($u(e))return uf(e);if(Array.isArray(e)&&e.length===2&&e.every(yr))return e[0]===-1/0||e[1]===-1/0||Number.isNaN(e[0])||Number.isNaN(e[1])?Co:e[0]===1/0||e[1]===1/0?mA:uf(BigInt(Math.round(e[0]*1e9))+BigInt(Math.round(e[1])));if(yn(e)){const t=fA.exec(e);if(t){const[n,r,s]=t,o=Number(r);switch(s){case"nano":case"nanos":return uf(BigInt(r));case"micro":case"micros":return gA(BigInt(r));case"milli":case"millis":return ae(o);case"second":case"seconds":return Qd(o);case"minute":case"minutes":return yA(o);case"hour":case"hours":return SA(o);case"day":case"days":return bA(o);case"week":case"weeks":return _A(o)}}}throw new Error("Invalid DurationInput")},bg={_tag:"Millis",millis:0},hA={_tag:"Infinity"},dA={[ah]:ah,[pe](){return Ye(this,nb(this.value))},[de](e){return b_(e)&&$A(this,e)},toString(){return`Duration(${RA(this)})`},toJSON(){switch(this.value._tag){case"Millis":return{_id:"Duration",_tag:"Millis",millis:this.value.millis};case"Nanos":return{_id:"Duration",_tag:"Nanos",hrtime:vA(this)};case"Infinity":return{_id:"Duration",_tag:"Infinity"}}},[Me](){return this.toJSON()},pipe(){return Y(this,arguments)}},Gt=e=>{const t=Object.create(dA);return yr(e)?isNaN(e)||e<=0?t.value=bg:Number.isFinite(e)?Number.isInteger(e)?t.value={_tag:"Millis",millis:e}:t.value={_tag:"Nanos",nanos:BigInt(Math.round(e*1e6))}:t.value=hA:e<=S_?t.value=bg:t.value={_tag:"Nanos",nanos:e},t},b_=e=>re(e,ah),pA=e=>{switch(e.value._tag){case"Millis":return e.value.millis===0;case"Nanos":return e.value.nanos===S_;case"Infinity":return!1}},Co=Gt(0),mA=Gt(1/0),uf=e=>Gt(e),gA=e=>Gt(e*uh),ae=e=>Gt(e),Qd=e=>Gt(e*1e3),yA=e=>Gt(e*6e4),SA=e=>Gt(e*36e5),bA=e=>Gt(e*864e5),_A=e=>Gt(e*6048e5),Gi=e=>__(e,{onMillis:t=>t,onNanos:t=>Number(t)/1e6}),wA=e=>{const t=Jt(e);switch(t.value._tag){case"Infinity":throw new Error("Cannot convert infinite duration to nanos");case"Nanos":return t.value.nanos;case"Millis":return BigInt(Math.round(t.value.millis*1e6))}},vA=e=>{const t=Jt(e);switch(t.value._tag){case"Infinity":return[1/0,0];case"Nanos":return[Number(t.value.nanos/Sg),Number(t.value.nanos%Sg)];case"Millis":return[Math.floor(t.value.millis/1e3),Math.round(t.value.millis%1e3*1e6)]}},__=d(2,(e,t)=>{const n=Jt(e);switch(n.value._tag){case"Nanos":return t.onNanos(n.value.nanos);case"Infinity":return t.onMillis(1/0);case"Millis":return t.onMillis(n.value.millis)}}),ju=d(3,(e,t,n)=>{const r=Jt(e),s=Jt(t);if(r.value._tag==="Infinity"||s.value._tag==="Infinity")return n.onMillis(Gi(r),Gi(s));if(r.value._tag==="Nanos"||s.value._tag==="Nanos"){const o=r.value._tag==="Nanos"?r.value.nanos:BigInt(Math.round(r.value.millis*1e6)),i=s.value._tag==="Nanos"?s.value.nanos:BigInt(Math.round(s.value.millis*1e6));return n.onNanos(o,i)}return n.onMillis(r.value.millis,s.value.millis)}),TA=(e,t)=>ju(e,t,{onMillis:(n,r)=>n===r,onNanos:(n,r)=>n===r}),kA=d(2,(e,t)=>__(e,{onMillis:n=>Gt(n*t),onNanos:n=>Gt(n*BigInt(t))})),EA=d(2,(e,t)=>ju(e,t,{onMillis:(n,r)=>Gt(n+r),onNanos:(n,r)=>Gt(n+r)})),CA=d(2,(e,t)=>ju(e,t,{onMillis:(n,r)=>n<=r,onNanos:(n,r)=>n<=r})),IA=d(2,(e,t)=>ju(e,t,{onMillis:(n,r)=>n>=r,onNanos:(n,r)=>n>=r})),$A=d(2,(e,t)=>TA(Jt(e),Jt(t))),AA=e=>{const t=Jt(e);if(t.value._tag==="Infinity")return{days:1/0,hours:1/0,minutes:1/0,seconds:1/0,millis:1/0,nanos:1/0};const n=wA(t),r=n/yg,s=r/uh,o=s/Yc,i=o/Yc,c=i/gg;return{days:Number(c),hours:Number(i%gg),minutes:Number(o%Yc),seconds:Number(s%Yc),millis:Number(r%uh),nanos:Number(n%yg)}},RA=e=>{const t=Jt(e);if(t.value._tag==="Infinity")return"Infinity";if(pA(t))return"0";const n=AA(t),r=[];return n.days!==0&&r.push(`${n.days}d`),n.hours!==0&&r.push(`${n.hours}h`),n.minutes!==0&&r.push(`${n.minutes}m`),n.seconds!==0&&r.push(`${n.seconds}s`),n.millis!==0&&r.push(`${n.millis}ms`),n.nanos!==0&&r.push(`${n.nanos}ns`),r.join(" ")},Ss=5,Xd=Math.pow(2,Ss),OA=Xd-1,PA=Xd/2,xA=Xd/4;function FA(e){return e-=e>>1&1431655765,e=(e&858993459)+(e>>2&858993459),e=e+(e>>4)&252645135,e+=e>>8,e+=e>>16,e&127}function Io(e,t){return t>>>e&OA}function no(e){return 1<<e}function w_(e,t){return FA(e&t-1)}const NA=(e,t)=>({value:e,previous:t});function fo(e,t,n,r){let s=r;if(!e){const o=r.length;s=new Array(o);for(let i=0;i<o;++i)s[i]=r[i]}return s[t]=n,s}function v_(e,t,n){const r=n.length-1;let s=0,o=0,i=n;if(e)s=o=t;else for(i=new Array(r);s<t;)i[o++]=n[s++];for(++s;s<=r;)i[o++]=n[s++];return e&&(i.length=r),i}function BA(e,t,n,r){const s=r.length;if(e){let a=s;for(;a>=t;)r[a--]=r[a];return r[t]=n,r}let o=0,i=0;const c=new Array(s+1);for(;o<t;)c[i++]=r[o++];for(c[t]=n;o<s;)c[++i]=r[o++];return c}class Nr{_tag="EmptyNode";modify(t,n,r,s,o,i){const c=r(K());return Ue(c)?new Nr:(++i.value,new us(t,s,o,c))}}function Tn(e){return QS(e,"EmptyNode")}function MA(e){return Tn(e)||e._tag==="LeafNode"||e._tag==="CollisionNode"}function zu(e,t){return Tn(e)?!1:t===e.edit}class us{edit;hash;key;value;_tag="LeafNode";constructor(t,n,r,s){this.edit=t,this.hash=n,this.key=r,this.value=s}modify(t,n,r,s,o,i){if(ie(o,this.key)){const a=r(this.value);return a===this.value?this:Ue(a)?(--i.value,new Nr):zu(this,t)?(this.value=a,this):new us(t,s,o,a)}const c=r(K());return Ue(c)?this:(++i.value,T_(t,n,this.hash,this,s,new us(t,s,o,c)))}}class Zd{edit;hash;children;_tag="CollisionNode";constructor(t,n,r){this.edit=t,this.hash=n,this.children=r}modify(t,n,r,s,o,i){if(s===this.hash){const a=zu(this,t),u=this.updateCollisionList(a,t,this.hash,this.children,r,o,i);return u===this.children?this:u.length>1?new Zd(t,this.hash,u):u[0]}const c=r(K());return Ue(c)?this:(++i.value,T_(t,n,this.hash,this,s,new us(t,s,o,c)))}updateCollisionList(t,n,r,s,o,i,c){const a=s.length;for(let l=0;l<a;++l){const f=s[l];if("key"in f&&ie(i,f.key)){const h=f.value,m=o(h);return m===h?s:Ue(m)?(--c.value,v_(t,l,s)):fo(t,l,new us(n,r,i,m),s)}}const u=o(K());return Ue(u)?s:(++c.value,fo(t,a,new us(n,r,i,u),s))}}class $o{edit;mask;children;_tag="IndexedNode";constructor(t,n,r){this.edit=t,this.mask=n,this.children=r}modify(t,n,r,s,o,i){const c=this.mask,a=this.children,u=Io(n,s),l=no(u),f=w_(c,l),h=c&l,m=zu(this,t);if(!h){const C=new Nr().modify(t,n+Ss,r,s,o,i);return C?a.length>=PA?HA(t,u,C,c,a):new $o(t,c|l,BA(m,f,C,a)):this}const y=a[f],S=y.modify(t,n+Ss,r,s,o,i);if(y===S)return this;let _=c,T;if(Tn(S)){if(_&=~l,!_)return new Nr;if(a.length<=2&&MA(a[f^1]))return a[f^1];T=v_(m,f,a)}else T=fo(m,f,S,a);return m?(this.mask=_,this.children=T,this):new $o(t,_,T)}}class ep{edit;size;children;_tag="ArrayNode";constructor(t,n,r){this.edit=t,this.size=n,this.children=r}modify(t,n,r,s,o,i){let c=this.size;const a=this.children,u=Io(n,s),l=a[u],f=(l||new Nr).modify(t,n+Ss,r,s,o,i);if(l===f)return this;const h=zu(this,t);let m;if(Tn(l)&&!Tn(f))++c,m=fo(h,u,f,a);else if(!Tn(l)&&Tn(f)){if(--c,c<=xA)return LA(t,c,u,a);m=fo(h,u,new Nr,a)}else m=fo(h,u,f,a);return h?(this.size=c,this.children=m,this):new ep(t,c,m)}}function LA(e,t,n,r){const s=new Array(t-1);let o=0,i=0;for(let c=0,a=r.length;c<a;++c)if(c!==n){const u=r[c];u&&!Tn(u)&&(s[o++]=u,i|=1<<c)}return new $o(e,i,s)}function HA(e,t,n,r,s){const o=[];let i=r,c=0;for(let a=0;i;++a)i&1&&(o[a]=s[c++]),i>>>=1;return o[t]=n,new ep(e,c+1,o)}function DA(e,t,n,r,s,o){if(n===s)return new Zd(e,n,[o,r]);const i=Io(t,n),c=Io(t,s);if(i===c)return a=>new $o(e,no(i)|no(c),[a]);{const a=i<c?[r,o]:[o,r];return new $o(e,no(i)|no(c),a)}}function T_(e,t,n,r,s,o){let i,c=t;for(;;){const a=DA(e,c,n,r,s,o);if(typeof a=="function")i=NA(a,i),c=c+Ss;else{let u=a;for(;i!=null;)u=i.value(u),i=i.previous;return u}}}const k_="effect/HashMap",lh=Symbol.for(k_),UA={[lh]:lh,[Symbol.iterator](){return new Vu(this,(e,t)=>[e,t])},[pe](){let e=Q(k_);for(const t of this)e^=p(Q(t[0]),ye(Q(t[1])));return Ye(this,e)},[de](e){if(zA(e)){if(e._size!==this._size)return!1;for(const t of this){const n=p(e,np(t[0],Q(t[0])));if(Ue(n))return!1;if(!ie(t[1],n.value))return!1}return!0}return!1},toString(){return at(this.toJSON())},toJSON(){return{_id:"HashMap",values:Array.from(this).map(Ge)}},[Me](){return this.toJSON()},pipe(){return Y(this,arguments)}},tp=(e,t,n,r)=>{const s=Object.create(UA);return s._editable=e,s._edit=t,s._root=n,s._size=r,s};class Vu{map;f;v;constructor(t,n){this.map=t,this.f=n,this.v=E_(this.map._root,this.f,void 0)}next(){if(Ue(this.v))return{done:!0,value:void 0};const t=this.v.value;return this.v=Ya(t.cont),{done:!1,value:t.value}}[Symbol.iterator](){return new Vu(this.map,this.f)}}const Ya=e=>e?C_(e[0],e[1],e[2],e[3],e[4]):K(),E_=(e,t,n=void 0)=>{switch(e._tag){case"LeafNode":return $e(e.value)?U({value:t(e.key,e.value.value),cont:n}):Ya(n);case"CollisionNode":case"ArrayNode":case"IndexedNode":{const r=e.children;return C_(r.length,r,0,t,n)}default:return Ya(n)}},C_=(e,t,n,r,s)=>{for(;n<e;){const o=t[n++];if(o&&!Tn(o))return E_(o,r,[e,t,n,r,s])}return Ya(s)},KA=tp(!1,0,new Nr,0),qu=()=>KA,jA=e=>{const t=$_(qu());for(const n of e)Yi(t,n[0],n[1]);return GA(t)},zA=e=>re(e,lh),VA=e=>e&&Tn(e._root),qA=d(2,(e,t)=>np(e,t,Q(t))),np=d(3,(e,t,n)=>{let r=e._root,s=0;for(;;)switch(r._tag){case"LeafNode":return ie(t,r.key)?r.value:K();case"CollisionNode":{if(n===r.hash){const o=r.children;for(let i=0,c=o.length;i<c;++i){const a=o[i];if("key"in a&&ie(t,a.key))return a.value}}return K()}case"IndexedNode":{const o=Io(s,n),i=no(o);if(r.mask&i){r=r.children[w_(r.mask,i)],s+=Ss;break}return K()}case"ArrayNode":{if(r=r.children[Io(s,n)],r){s+=Ss;break}return K()}default:return K()}}),WA=d(2,(e,t)=>$e(np(e,t,Q(t)))),Yi=d(3,(e,t,n)=>rp(e,t,()=>U(n))),JA=d(3,(e,t,n)=>e._editable?(e._root=t,e._size=n,e):t===e._root?e:tp(e._editable,e._edit,t,n)),I_=e=>new Vu(e,t=>t),fh=e=>e._size,$_=e=>tp(!0,e._edit+1,e._root,e._size),GA=e=>(e._editable=!1,e),rp=d(3,(e,t,n)=>YA(e,t,Q(t),n)),YA=d(4,(e,t,n,r)=>{const s={value:e._size},o=e._root.modify(e._editable?e._edit:NaN,0,r,n,t,s);return p(e,JA(o,s.value))}),_g=d(2,(e,t)=>rp(e,t,K)),QA=d(2,(e,t)=>Wu(e,qu(),(n,r,s)=>Yi(n,s,t(r,s)))),XA=d(2,(e,t)=>Wu(e,void 0,(n,r,s)=>t(r,s))),Wu=d(3,(e,t,n)=>{const r=e._root;if(r._tag==="LeafNode")return $e(r.value)?n(t,r.value.value,r.key):t;if(r._tag==="EmptyNode")return t;const s=[r.children];let o;for(;o=s.pop();)for(let i=0,c=o.length;i<c;){const a=o[i++];a&&!Tn(a)&&(a._tag==="LeafNode"?$e(a.value)&&(t=n(t,a.value.value,a.key)):s.push(a.children))}return t}),A_="effect/HashSet",hh=Symbol.for(A_),ZA={[hh]:hh,[Symbol.iterator](){return I_(this._keyMap)},[pe](){return Ye(this,ye(Q(this._keyMap))(Q(A_)))},[de](e){return eR(e)?fh(this._keyMap)===fh(e._keyMap)&&ie(this._keyMap,e._keyMap):!1},toString(){return at(this.toJSON())},toJSON(){return{_id:"HashSet",values:Array.from(this).map(Ge)}},[Me](){return this.toJSON()},pipe(){return Y(this,arguments)}},Ju=e=>{const t=Object.create(ZA);return t._keyMap=e,t},eR=e=>re(e,hh),tR=Ju(qu()),Gu=()=>tR,nR=e=>{const t=sp(Gu());for(const n of e)Qi(t,n);return op(t)},rR=(...e)=>{const t=sp(Gu());for(const n of e)Qi(t,n);return op(t)},sR=d(2,(e,t)=>WA(e._keyMap,t)),oR=e=>fh(e._keyMap),sp=e=>Ju($_(e._keyMap)),op=e=>(e._keyMap._editable=!1,e),R_=d(2,(e,t)=>{const n=sp(e);return t(n),op(n)}),Qi=d(2,(e,t)=>e._keyMap._editable?(Yi(t,!0)(e._keyMap),e):Ju(Yi(t,!0)(e._keyMap))),O_=d(2,(e,t)=>e._keyMap._editable?(_g(t)(e._keyMap),e):Ju(_g(t)(e._keyMap))),iR=d(2,(e,t)=>R_(e,n=>{for(const r of t)O_(n,r)})),cR=d(2,(e,t)=>R_(Gu(),n=>{aR(e,r=>Qi(n,r));for(const r of t)Qi(n,r)})),aR=d(2,(e,t)=>XA(e._keyMap,(n,r)=>t(r))),uR=d(3,(e,t,n)=>Wu(e._keyMap,t,(r,s,o)=>n(r,o))),bs=Gu,lR=nR,ip=rR,fR=sR,cp=oR,Mi=Qi,P_=O_,wg=iR,Xi=cR,Zi=uR,vg=Symbol.for("effect/MutableRef"),hR={[vg]:vg,toString(){return at(this.toJSON())},toJSON(){return{_id:"MutableRef",current:Ge(this.current)}},[Me](){return this.toJSON()},pipe(){return Y(this,arguments)}},As=e=>{const t=Object.create(hR);return t.current=e,t},dR=d(3,(e,t,n)=>ie(t,e.current)?(e.current=n,!0):!1),_e=e=>e.current,Rs=d(2,(e,t)=>(e.current=t,e)),Yu="effect/FiberId",_s=Symbol.for(Yu),Ao="None",dh="Runtime",ph="Composite",pR=Ze(`${Yu}-${Ao}`);let mR=class{[_s]=_s;_tag=Ao;id=-1;startTimeMillis=-1;[pe](){return pR}[de](t){return ap(t)&&t._tag===Ao}toString(){return at(this.toJSON())}toJSON(){return{_id:"FiberId",_tag:this._tag}}[Me](){return this.toJSON()}};class gR{id;startTimeMillis;[_s]=_s;_tag=dh;constructor(t,n){this.id=t,this.startTimeMillis=n}[pe](){return Ye(this,Ze(`${Yu}-${this._tag}-${this.id}-${this.startTimeMillis}`))}[de](t){return ap(t)&&t._tag===dh&&this.id===t.id&&this.startTimeMillis===t.startTimeMillis}toString(){return at(this.toJSON())}toJSON(){return{_id:"FiberId",_tag:this._tag,id:this.id,startTimeMillis:this.startTimeMillis}}[Me](){return this.toJSON()}}let yR=class{left;right;[_s]=_s;_tag=ph;constructor(t,n){this.left=t,this.right=n}_hash;[pe](){return p(Ze(`${Yu}-${this._tag}`),ye(Q(this.left)),ye(Q(this.right)),Ye(this))}[de](t){return ap(t)&&t._tag===ph&&ie(this.left,t.left)&&ie(this.right,t.right)}toString(){return at(this.toJSON())}toJSON(){return{_id:"FiberId",_tag:this._tag,left:Ge(this.left),right:Ge(this.right)}}[Me](){return this.toJSON()}};const x_=new mR,ap=e=>re(e,_s),F_=d(2,(e,t)=>e._tag===Ao?t:t._tag===Ao?e:new yR(e,t)),SR=e=>p(e,Zi(x_,(t,n)=>F_(n)(t))),mh=e=>{switch(e._tag){case Ao:return bs();case dh:return ip(e.id);case ph:return p(mh(e.left),Xi(mh(e.right)))}},Tg=be(Symbol.for("effect/Fiber/Id/_fiberCounter"),()=>As(0)),N_=e=>Array.from(mh(e)).map(n=>`#${n}`).join(","),bR=()=>{const e=_e(Tg);return p(Tg,Rs(e+1)),new gR(e,Date.now())},Ro=x_,_R=F_,wR=SR,vR=N_,B_=bR,up=qu,TR=jA,kR=VA,M_=qA,L_=Yi,H_=I_,ER=rp,CR=QA,D_=Wu,ec=Symbol.for("effect/List"),gh=e=>Ne(e),IR=e=>aC(Dd(e),gh),$R=IR(ie),AR={[ec]:ec,_tag:"Cons",toString(){return at(this.toJSON())},toJSON(){return{_id:"List",_tag:"Cons",values:gh(this).map(Ge)}},[Me](){return this.toJSON()},[de](e){return K_(e)&&this._tag===e._tag&&$R(this,e)},[pe](){return Ye(this,Sc(gh(this)))},[Symbol.iterator](){let e=!1,t=this;return{next(){if(e)return this.return();if(t._tag==="Nil")return e=!0,this.return();const n=t.head;return t=t.tail,{done:e,value:n}},return(n){return e||(e=!0),{done:!0,value:n}}}},pipe(){return Y(this,arguments)}},Qa=(e,t)=>{const n=Object.create(AR);return n.head=e,n.tail=t,n},RR=Ze("Nil"),OR={[ec]:ec,_tag:"Nil",toString(){return at(this.toJSON())},toJSON(){return{_id:"List",_tag:"Nil"}},[Me](){return this.toJSON()},[pe](){return RR},[de](e){return K_(e)&&this._tag===e._tag},[Symbol.iterator](){return{next(){return{done:!0,value:void 0}}}},pipe(){return Y(this,arguments)}},U_=Object.create(OR),K_=e=>re(e,ec),dr=e=>e._tag==="Nil",PR=e=>e._tag==="Cons",xR=()=>U_,ws=(e,t)=>Qa(e,t),Oo=xR,lp=e=>Qa(e,U_),FR=d(2,(e,t)=>BR(t,e)),NR=d(2,(e,t)=>ws(t,e)),BR=d(2,(e,t)=>{if(dr(e))return t;if(dr(t))return e;{const n=Qa(t.head,e);let r=n,s=t.tail;for(;!dr(s);){const o=Qa(s.head,e);r.tail=o,r=o,s=s.tail}return n}}),MR=d(3,(e,t,n)=>{let r=t,s=e;for(;!dr(s);)r=n(r,s.head),s=s.tail;return r}),LR=e=>{let t=Oo(),n=e;for(;!dr(n);)t=NR(t,n.head),n=n.tail;return t},Qu=(function(){function e(t){t&&Object.assign(this,t)}return e.prototype=Nd,e})(),HR=Symbol.for("effect/DifferContextPatch");function kg(e){return e}const vc={...Qu.prototype,[HR]:{_Value:kg,_Patch:kg}},DR=Object.assign(Object.create(vc),{_tag:"Empty"}),UR=Object.create(DR),j_=()=>UR,KR=Object.assign(Object.create(vc),{_tag:"AndThen"}),jR=(e,t)=>{const n=Object.create(KR);return n.first=e,n.second=t,n},zR=Object.assign(Object.create(vc),{_tag:"AddService"}),VR=(e,t)=>{const n=Object.create(zR);return n.key=e,n.service=t,n},qR=Object.assign(Object.create(vc),{_tag:"RemoveService"}),WR=e=>{const t=Object.create(qR);return t.key=e,t},JR=Object.assign(Object.create(vc),{_tag:"UpdateService"}),GR=(e,t)=>{const n=Object.create(JR);return n.key=e,n.update=t,n},YR=(e,t)=>{const n=new Map(e.unsafeMap);let r=j_();for(const[s,o]of t.unsafeMap.entries())if(n.has(s)){const i=n.get(s);n.delete(s),ie(i,o)||(r=ba(GR(s,()=>o))(r))}else n.delete(s),r=ba(VR(s,o))(r);for(const[s]of n.entries())r=ba(WR(s))(r);return r},ba=d(2,(e,t)=>jR(e,t)),QR=d(2,(e,t)=>{if(e._tag==="Empty")return t;let n=!1,r=Be(e);const s=new Map(t.unsafeMap);for(;Vn(r);){const i=Bn(r),c=cr(r);switch(i._tag){case"Empty":{r=c;break}case"AddService":{s.set(i.key,i.service),r=c;break}case"AndThen":{r=Bt(Bt(c,i.second),i.first);break}case"RemoveService":{s.delete(i.key),r=c;break}case"UpdateService":{s.set(i.key,i.update(s.get(i.key))),n=!0,r=c;break}}}if(!n)return ys(s);const o=new Map;for(const[i]of t.unsafeMap)s.has(i)&&(o.set(i,s.get(i)),s.delete(i));for(const[i,c]of s)o.set(i,c);return ys(o)}),XR=Symbol.for("effect/DifferHashSetPatch");function lf(e){return e}const Xu={...Qu.prototype,[XR]:{_Value:lf,_Key:lf,_Patch:lf}},ZR=Object.assign(Object.create(Xu),{_tag:"Empty"}),e1=Object.create(ZR),z_=()=>e1,t1=Object.assign(Object.create(Xu),{_tag:"AndThen"}),n1=(e,t)=>{const n=Object.create(t1);return n.first=e,n.second=t,n},r1=Object.assign(Object.create(Xu),{_tag:"Add"}),s1=e=>{const t=Object.create(r1);return t.value=e,t},o1=Object.assign(Object.create(Xu),{_tag:"Remove"}),i1=e=>{const t=Object.create(o1);return t.value=e,t},c1=(e,t)=>{const[n,r]=Zi([e,z_()],([s,o],i)=>fR(i)(s)?[P_(i)(s),o]:[s,yh(s1(i))(o)])(t);return Zi(r,(s,o)=>yh(i1(o))(s))(n)},yh=d(2,(e,t)=>n1(e,t)),a1=d(2,(e,t)=>{if(e._tag==="Empty")return t;let n=t,r=Be(e);for(;Vn(r);){const s=Bn(r),o=cr(r);switch(s._tag){case"Empty":{r=o;break}case"AndThen":{r=Bt(s.first)(Bt(s.second)(o));break}case"Add":{n=Mi(s.value)(n),r=o;break}case"Remove":n=P_(s.value)(n),r=o}}return n}),u1=Symbol.for("effect/DifferReadonlyArrayPatch");function Eg(e){return e}const Tc={...Qu.prototype,[u1]:{_Value:Eg,_Patch:Eg}},l1=Object.assign(Object.create(Tc),{_tag:"Empty"}),f1=Object.create(l1),V_=()=>f1,h1=Object.assign(Object.create(Tc),{_tag:"AndThen"}),d1=(e,t)=>{const n=Object.create(h1);return n.first=e,n.second=t,n},p1=Object.assign(Object.create(Tc),{_tag:"Append"}),m1=e=>{const t=Object.create(p1);return t.values=e,t},g1=Object.assign(Object.create(Tc),{_tag:"Slice"}),y1=(e,t)=>{const n=Object.create(g1);return n.from=e,n.until=t,n},S1=Object.assign(Object.create(Tc),{_tag:"Update"}),b1=(e,t)=>{const n=Object.create(S1);return n.index=e,n.patch=t,n},_1=e=>{let t=0,n=V_();for(;t<e.oldValue.length&&t<e.newValue.length;){const r=e.oldValue[t],s=e.newValue[t],o=e.differ.diff(r,s);ie(o,e.differ.empty)||(n=_a(n,b1(t,o))),t=t+1}return t<e.oldValue.length&&(n=_a(n,y1(0,t))),t<e.newValue.length&&(n=_a(n,m1($I(t)(e.newValue)))),n},_a=d(2,(e,t)=>d1(e,t)),w1=d(3,(e,t,n)=>{if(e._tag==="Empty")return t;let r=t.slice(),s=bn(e);for(;ga(s);){const o=Vt(s),i=ms(s);switch(o._tag){case"Empty":{s=i;break}case"AndThen":{i.unshift(o.first,o.second),s=i;break}case"Append":{for(const c of o.values)r.push(c);s=i;break}case"Slice":{r=r.slice(o.from,o.until),s=i;break}case"Update":{r[o.index]=n.patch(o.patch,r[o.index]),s=i;break}}}return r}),v1=Symbol.for("effect/Differ"),T1={[v1]:{_P:ne,_V:ne},pipe(){return Y(this,arguments)}},ti=e=>{const t=Object.create(T1);return t.empty=e.empty,t.diff=e.diff,t.combine=e.combine,t.patch=e.patch,t},k1=()=>ti({empty:j_(),combine:(e,t)=>ba(t)(e),diff:(e,t)=>YR(e,t),patch:(e,t)=>QR(t)(e)}),E1=()=>ti({empty:z_(),combine:(e,t)=>yh(t)(e),diff:(e,t)=>c1(e,t),patch:(e,t)=>a1(t)(e)}),C1=e=>ti({empty:V_(),combine:(t,n)=>_a(t,n),diff:(t,n)=>_1({oldValue:t,newValue:n,differ:e}),patch:(t,n)=>w1(t,n,e)}),q_=()=>I1((e,t)=>t),I1=e=>ti({empty:ne,combine:(t,n)=>t===ne?n:n===ne?t:r=>n(t(r)),diff:(t,n)=>ie(t,n)?ne:Cu(n),patch:(t,n)=>e(n,t(n))}),tc=255,W_=8,Sh=e=>e&tc,bh=e=>e>>W_&tc,kc=(e,t)=>(e&tc)+((t&e&tc)<<W_),$1=kc(0,0),A1=e=>kc(e,e),R1=e=>kc(e,0),O1=d(2,(e,t)=>kc(Sh(e)&~t,bh(e))),P1=d(2,(e,t)=>e|t),x1=e=>~e>>>0&tc,F1=0,Os=1,N1=2,J_=4,_h=16,G_=32,B1=e=>Zu(e,G_),M1=d(2,(e,t)=>e&~t),L1=d(2,(e,t)=>e|t),$r=e=>Y_(e)&&!D1(e),Y_=e=>Zu(e,Os),Zu=d(2,(e,t)=>(e&t)!==0),Q_=(...e)=>e.reduce((t,n)=>t|n,0),H1=Q_(F1),Cg=e=>Zu(e,J_),D1=e=>Zu(e,_h),ls=d(2,(e,t)=>kc(e^t,t)),ho=d(2,(e,t)=>e&(x1(Sh(t))|bh(t))|Sh(t)&bh(t)),Ig=ti({empty:$1,diff:(e,t)=>ls(e,t),combine:(e,t)=>P1(t)(e),patch:(e,t)=>ho(t,e)}),U1=A1,X_=R1,$g=O1,Z_=(e,t)=>({_tag:"Par",left:e,right:t}),Qc=(e,t)=>({_tag:"Seq",left:e,right:t}),K1=e=>{let t=lp(e),n=Oo();for(;;){const[r,s]=MR(t,[ew(),Oo()],([o,i],c)=>{const[a,u]=j1(c);return[J1(o,a),FR(i,u)]});if(n=z1(n,r),dr(s))return LR(n);t=s}throw new Error("BUG: BlockedRequests.flatten - please report an issue at https://github.com/Effect-TS/effect/issues")},j1=e=>{let t=e,n=ew(),r=Oo(),s=Oo();for(;;)switch(t._tag){case"Empty":{if(dr(r))return[n,s];t=r.head,r=r.tail;break}case"Par":{r=ws(t.right,r),t=t.left;break}case"Seq":{const o=t.left,i=t.right;switch(o._tag){case"Empty":{t=i;break}case"Par":{const c=o.left,a=o.right;t=Z_(Qc(c,i),Qc(a,i));break}case"Seq":{const c=o.left,a=o.right;t=Qc(c,Qc(a,i));break}case"Single":{t=o,s=ws(i,s);break}}break}case"Single":{if(n=W1(n,t),dr(r))return[n,s];t=r.head,r=r.tail;break}}throw new Error("BUG: BlockedRequests.step - please report an issue at https://github.com/Effect-TS/effect/issues")},z1=(e,t)=>{if(dr(e))return lp(ff(t));if(G1(t))return e;const n=tO(e.head),r=Y1(t);return n.length===1&&r.length===1&&ie(n[0],r[0])?ws(eO(e.head,ff(t)),e.tail):ws(ff(t),e)},V1=Symbol.for("effect/RequestBlock/RequestBlockParallel"),q1={_R:e=>e};class fp{map;[V1]=q1;constructor(t){this.map=t}}const ew=()=>new fp(up()),W1=(e,t)=>new fp(ER(e.map,t.dataSource,n=>iI(ao(n,Eo(t.blockedRequest)),()=>Be(t.blockedRequest)))),J1=(e,t)=>new fp(D_(e.map,t.map,(n,r,s)=>L_(n,s,Fe(M_(n,s),{onNone:()=>r,onSome:o=>bt(r,o)})))),G1=e=>kR(e.map),Y1=e=>Array.from(H_(e.map)),ff=e=>Z1(CR(e.map,t=>Be(t))),Q1=Symbol.for("effect/RequestBlock/RequestBlockSequential"),X1={_R:e=>e};class tw{map;[Q1]=X1;constructor(t){this.map=t}}const Z1=e=>new tw(e),eO=(e,t)=>new tw(D_(t.map,e.map,(n,r,s)=>L_(n,s,Fe(M_(n,s),{onNone:()=>We(),onSome:o=>bt(o,r)})))),tO=e=>Array.from(H_(e.map)),nO=e=>Array.from(e.map),ni="Die",vs="Empty",Ps="Fail",ri="Interrupt",Po="Parallel",xo="Sequential",nw="effect/Cause",rw=Symbol.for(nw),rO={_E:e=>e},si={[rw]:rO,[pe](){return p(Q(nw),ye(Q(yO(this))),Ye(this))},[de](e){return sO(e)&&gO(this,e)},pipe(){return Y(this,arguments)},toJSON(){switch(this._tag){case"Empty":return{_id:"Cause",_tag:this._tag};case"Die":return{_id:"Cause",_tag:this._tag,defect:Ge(this.defect)};case"Interrupt":return{_id:"Cause",_tag:this._tag,fiberId:this.fiberId.toJSON()};case"Fail":return{_id:"Cause",_tag:this._tag,failure:Ge(this.error)};case"Sequential":case"Parallel":return{_id:"Cause",_tag:this._tag,left:Ge(this.left),right:Ge(this.right)}}},toString(){return oi(this)},[Me](){return this.toJSON()}},Br=(()=>{const e=Object.create(si);return e._tag=vs,e})(),Mr=e=>{const t=Object.create(si);return t._tag=Ps,t.error=e,t},rn=e=>{const t=Object.create(si);return t._tag=ni,t.defect=e,t},hn=e=>{const t=Object.create(si);return t._tag=ri,t.fiberId=e,t},Lr=(e,t)=>{const n=Object.create(si);return n._tag=Po,n.left=e,n.right=t,n},Ot=(e,t)=>{const n=Object.create(si);return n._tag=xo,n.left=e,n.right=t,n},sO=e=>re(e,rw),oO=e=>e._tag===vs,iO=e=>e._tag===Ps,sw=e=>e._tag===ni,cO=e=>e._tag===vs?!0:Fo(e,!0,(t,n)=>{switch(n._tag){case vs:return U(t);case ni:case Ps:case ri:return U(!1);default:return K()}}),ow=e=>$e(hO(e)),el=e=>dp(void 0,bO)(e),aO=e=>Sr(Fo(e,We(),(t,n)=>n._tag===Ps?U(p(t,Bt(n.error))):K())),uO=e=>Sr(Fo(e,We(),(t,n)=>n._tag===ni?U(p(t,Bt(n.defect))):K())),iw=e=>Fo(e,bs(),(t,n)=>n._tag===ri?U(p(t,Mi(n.fiberId))):K()),lO=e=>hp(e,t=>t._tag===Ps?U(t.error):K()),cw=e=>{const t=lO(e);switch(t._tag){case"None":return me(e);case"Some":return oe(t.value)}},fO=e=>tl(e,{onEmpty:U(Br),onFail:ao(Mr),onDie:t=>U(rn(t)),onInterrupt:t=>U(hn(t)),onSequential:rg(Ot),onParallel:rg(Lr)}),hO=e=>hp(e,t=>t._tag===ri?U(t.fiberId):K()),Ag=e=>tl(e,{onEmpty:Br,onFail:()=>Br,onDie:rn,onInterrupt:hn,onSequential:Ot,onParallel:Lr}),dO=e=>tl(e,{onEmpty:Br,onFail:rn,onDie:rn,onInterrupt:hn,onSequential:Ot,onParallel:Lr}),pO=d(2,(e,t)=>mO(e,n=>Mr(t(n)))),mO=d(2,(e,t)=>tl(e,{onEmpty:Br,onFail:n=>t(n),onDie:n=>rn(n),onInterrupt:n=>hn(n),onSequential:(n,r)=>Ot(n,r),onParallel:(n,r)=>Lr(n,r)})),gO=(e,t)=>{let n=Be(e),r=Be(t);for(;Vn(n)&&Vn(r);){const[s,o]=p(Bn(n),Fo([bs(),We()],([a,u],l)=>{const[f,h]=wh(l);return U([p(a,Xi(f)),p(u,bt(h))])})),[i,c]=p(Bn(r),Fo([bs(),We()],([a,u],l)=>{const[f,h]=wh(l);return U([p(a,Xi(f)),p(u,bt(h))])}));if(!ie(s,i))return!1;n=o,r=c}return!0},yO=e=>SO(Be(e),We()),SO=(e,t)=>{for(;;){const[n,r]=p(e,Hd([bs(),We()],([o,i],c)=>{const[a,u]=wh(c);return[p(o,Xi(a)),p(i,bt(u))]})),s=cp(n)>0?p(t,Bt(n)):t;if(Ku(r))return Sr(s);e=r,t=s}throw new Error(Au("Cause.flattenCauseLoop"))},hp=d(2,(e,t)=>{const n=[e];for(;n.length>0;){const r=n.pop(),s=t(r);switch(s._tag){case"None":{switch(r._tag){case xo:case Po:{n.push(r.right),n.push(r.left);break}}break}case"Some":return s}}return K()}),wh=e=>{let t=e;const n=[];let r=bs(),s=We();for(;t!==void 0;)switch(t._tag){case vs:{if(n.length===0)return[r,s];t=n.pop();break}case Ps:{if(r=Mi(r,Sa(t._tag,t.error)),n.length===0)return[r,s];t=n.pop();break}case ni:{if(r=Mi(r,Sa(t._tag,t.defect)),n.length===0)return[r,s];t=n.pop();break}case ri:{if(r=Mi(r,Sa(t._tag,t.fiberId)),n.length===0)return[r,s];t=n.pop();break}case xo:{switch(t.left._tag){case vs:{t=t.right;break}case xo:{t=Ot(t.left.left,Ot(t.left.right,t.right));break}case Po:{t=Lr(Ot(t.left.left,t.right),Ot(t.left.right,t.right));break}default:{s=Bt(s,t.right),t=t.left;break}}break}case Po:{n.push(t.right),t=t.left;break}}throw new Error(Au("Cause.evaluateCauseLoop"))},bO={emptyCase:eg,failCase:Gf,dieCase:Gf,interruptCase:eg,sequentialCase:(e,t,n)=>t&&n,parallelCase:(e,t,n)=>t&&n},Rg="SequentialCase",Og="ParallelCase",tl=d(2,(e,{onDie:t,onEmpty:n,onFail:r,onInterrupt:s,onParallel:o,onSequential:i})=>dp(e,void 0,{emptyCase:()=>n,failCase:(c,a)=>r(a),dieCase:(c,a)=>t(a),interruptCase:(c,a)=>s(a),sequentialCase:(c,a,u)=>i(a,u),parallelCase:(c,a,u)=>o(a,u)})),Fo=d(3,(e,t,n)=>{let r=t,s=e;const o=[];for(;s!==void 0;){const i=n(r,s);switch(r=$e(i)?i.value:r,s._tag){case xo:{o.push(s.right),s=s.left;break}case Po:{o.push(s.right),s=s.left;break}default:{s=void 0;break}}s===void 0&&o.length>0&&(s=o.pop())}return r}),dp=d(3,(e,t,n)=>{const r=[e],s=[];for(;r.length>0;){const i=r.pop();switch(i._tag){case vs:{s.push(me(n.emptyCase(t)));break}case Ps:{s.push(me(n.failCase(t,i.error)));break}case ni:{s.push(me(n.dieCase(t,i.defect)));break}case ri:{s.push(me(n.interruptCase(t,i.fiberId)));break}case xo:{r.push(i.right),r.push(i.left),s.push(oe({_tag:Rg}));break}case Po:{r.push(i.right),r.push(i.left),s.push(oe({_tag:Og}));break}}}const o=[];for(;s.length>0;){const i=s.pop();switch(i._tag){case"Left":{switch(i.left._tag){case Rg:{const c=o.pop(),a=o.pop(),u=n.sequentialCase(t,c,a);o.push(u);break}case Og:{const c=o.pop(),a=o.pop(),u=n.parallelCase(t,c,a);o.push(u);break}}break}case"Right":{o.push(i.right);break}}}if(o.length===0)throw new Error("BUG: Cause.reduceWithContext - please report an issue at https://github.com/Effect-TS/effect/issues");return o.pop()}),oi=(e,t)=>el(e)?"All fibers interrupted without errors.":uw(e).map(function(n){return t?.renderErrorCause!==!0||n.cause===void 0?n.stack:`${n.stack} {
${aw(n.cause,"  ")}
}`}).join(`
`),aw=(e,t)=>{const n=e.stack.split(`
`);let r=`${t}[cause]: ${n[0]}`;for(let s=1,o=n.length;s<o;s++)r+=`
${t}${n[s]}`;return e.cause&&(r+=` {
${aw(e.cause,`${t}  `)}
${t}}`),r};class Xa extends globalThis.Error{span=void 0;constructor(t){const n=typeof t=="object"&&t!==null,r=Error.stackTraceLimit;Error.stackTraceLimit=1,super(_O(t),n&&"cause"in t&&typeof t.cause<"u"?{cause:new Xa(t.cause)}:void 0),this.message===""&&(this.message="An error has occurred"),Error.stackTraceLimit=r,this.name=t instanceof Error?t.name:"Error",n&&(No in t&&(this.span=t[No]),Object.keys(t).forEach(s=>{s in this||(this[s]=t[s])})),this.stack=TO(`${this.name}: ${this.message}`,t instanceof Error&&t.stack?t.stack:"",this.span)}}const _O=e=>{if(typeof e=="string")return e;if(typeof e=="object"&&e!==null&&e instanceof Error)return e.message;try{if(re(e,"toString")&&gc(e.toString)&&e.toString!==Object.prototype.toString&&e.toString!==globalThis.Array.prototype.toString)return e.toString()}catch{}return rb(e)},wO=/\((.*)\)/g,vO=be("effect/Tracer/spanToTrace",()=>new WeakMap),TO=(e,t,n)=>{const r=[e],s=t.startsWith(e)?t.slice(e.length).split(`
`):t.split(`
`);for(let o=1;o<s.length;o++){if(s[o].includes(" at new BaseEffectError")||s[o].includes(" at new YieldableError")){o++;continue}if(s[o].includes("Generator.next")||s[o].includes("effect_internal_function"))break;r.push(s[o].replace(/at .*effect_instruction_i.*\((.*)\)/,"at $1").replace(/EffectPrimitive\.\w+/,"<anonymous>"))}if(n){let o=n,i=0;for(;o&&o._tag==="Span"&&i<10;){const c=vO.get(o);if(typeof c=="function"){const a=c();if(typeof a=="string"){const u=a.matchAll(wO);let l=!1;for(const[,f]of u)l=!0,r.push(`    at ${o.name} (${f})`);l||r.push(`    at ${o.name} (${a.replace(/^at /,"")})`)}else r.push(`    at ${o.name}`)}else r.push(`    at ${o.name}`);o=Pn(o.parent),i++}}return r.join(`
`)},No=Symbol.for("effect/SpanAnnotation"),uw=e=>dp(e,void 0,{emptyCase:()=>[],dieCase:(t,n)=>[new Xa(n)],failCase:(t,n)=>[new Xa(n)],interruptCase:()=>[],parallelCase:(t,n,r)=>[...n,...r],sequentialCase:(t,n,r)=>[...n,...r]}),Ec="Pending",nl="Done",kO="effect/Deferred",EO=Symbol.for(kO),CO={_E:e=>e,_A:e=>e},IO=e=>({_tag:Ec,joiners:e}),lw=e=>({_tag:nl,effect:e});class Cc{self;called=!1;constructor(t){this.self=t}next(t){return this.called?{value:t,done:!0}:(this.called=!0,{value:this.self,done:!1})}return(t){return{value:t,done:!0}}throw(t){throw t}[Symbol.iterator](){return new Cc(this.self)}}const fw=(e,t)=>{const n=new dt("Blocked");return n.effect_instruction_i0=e,n.effect_instruction_i1=t,n},$O=e=>{const t=new dt("RunBlocked");return t.effect_instruction_i0=e,t},Bo=Symbol.for("effect/Effect");class AO{patch;op;_op=xd;constructor(t,n){this.patch=t,this.op=n}}class dt{_op;effect_instruction_i0=void 0;effect_instruction_i1=void 0;effect_instruction_i2=void 0;trace=void 0;[Bo]=To;constructor(t){this._op=t}[de](t){return this===t}[pe](){return Ye(this,$d(this))}pipe(){return Y(this,arguments)}toJSON(){return{_id:"Effect",_op:this._op,effect_instruction_i0:Ge(this.effect_instruction_i0),effect_instruction_i1:Ge(this.effect_instruction_i1),effect_instruction_i2:Ge(this.effect_instruction_i2)}}toString(){return at(this.toJSON())}[Me](){return this.toJSON()}[Symbol.iterator](){return new Cc(new yc(this))}}class hw{_op;effect_instruction_i0=void 0;effect_instruction_i1=void 0;effect_instruction_i2=void 0;trace=void 0;[Bo]=To;constructor(t){this._op=t,this._tag=t}[de](t){return hl(t)&&t._op==="Failure"&&ie(this.effect_instruction_i0,t.effect_instruction_i0)}[pe](){return p(Ze(this._tag),ye(Q(this.effect_instruction_i0)),Ye(this))}get cause(){return this.effect_instruction_i0}pipe(){return Y(this,arguments)}toJSON(){return{_id:"Exit",_tag:this._op,cause:this.cause.toJSON()}}toString(){return at(this.toJSON())}[Me](){return this.toJSON()}[Symbol.iterator](){return new Cc(new yc(this))}}class dw{_op;effect_instruction_i0=void 0;effect_instruction_i1=void 0;effect_instruction_i2=void 0;trace=void 0;[Bo]=To;constructor(t){this._op=t,this._tag=t}[de](t){return hl(t)&&t._op==="Success"&&ie(this.effect_instruction_i0,t.effect_instruction_i0)}[pe](){return p(Ze(this._tag),ye(Q(this.effect_instruction_i0)),Ye(this))}get value(){return this.effect_instruction_i0}pipe(){return Y(this,arguments)}toJSON(){return{_id:"Exit",_tag:this._op,value:Ge(this.value)}}toString(){return at(this.toJSON())}[Me](){return this.toJSON()}[Symbol.iterator](){return new Cc(new yc(this))}}const vr=e=>re(e,Bo),Ee=e=>{const t=new dt(ib);return t.effect_instruction_i0=e,t},pw=d(3,(e,t,n)=>Cn(r=>P(e,s=>P(Un(le(()=>r(t(s)))),o=>le(()=>n(s,o)).pipe(cn({onFailure:i=>{switch(o._tag){case xt:return ft(Ot(o.effect_instruction_i0,i));case Ft:return ft(i)}},onSuccess:()=>o})))))),Yt=d(2,(e,t)=>P(e,()=>L(t))),an=e=>Yt(e,void 0),mw=function(){const e=new dt(Ou);switch(arguments.length){case 2:{e.effect_instruction_i0=arguments[0],e.commit=arguments[1];break}case 3:{e.effect_instruction_i0=arguments[0],e.effect_instruction_i1=arguments[1],e.commit=arguments[2];break}case 4:{e.effect_instruction_i0=arguments[0],e.effect_instruction_i1=arguments[1],e.effect_instruction_i2=arguments[2],e.commit=arguments[3];break}default:throw new Error(Au("you're not supposed to end up here"))}return e},Za=(e,t=Ro)=>{const n=new dt(xi);let r;return n.effect_instruction_i0=s=>{r=e(s)},n.effect_instruction_i1=t,Ac(n,s=>vr(r)?r:Ke)},gw=(e,t=Ro)=>le(()=>Za(e,t)),qn=(e,t=Ro)=>mw(e,function(){let n,r;function s(a){n?n(a):r===void 0&&(r=a)}const o=new dt(xi);o.effect_instruction_i0=a=>{n=a,r&&a(r)},o.effect_instruction_i1=t;let i,c;return this.effect_instruction_i0.length!==1?(c=new AbortController,i=Kt(()=>this.effect_instruction_i0(s,c.signal))):i=Kt(()=>this.effect_instruction_i0(s)),i||c?Ac(o,a=>(c&&c.abort(),i??Ke)):o}),yw=d(2,(e,t)=>{const n=new dt(pa);return n.effect_instruction_i0=e,n.effect_instruction_i1=t,n}),Mo=d(2,(e,t)=>Wn(e,{onFailure:t,onSuccess:L})),Pg=Symbol.for("effect/OriginalAnnotation"),pp=(e,t)=>$e(t)?new Proxy(e,{has(n,r){return r===No||r===Pg||r in n},get(n,r){return r===No?t.value:r===Pg?e:n[r]}}):e,Rr=e=>_r(e)&&!(No in e)?Ee(t=>ft(rn(pp(e,Cp(t))))):ft(rn(e)),Sw=e=>bw(()=>rn(new sP(e))),Lo=e=>Wn(e,{onFailure:t=>L(oe(t)),onSuccess:t=>L(me(t))}),Un=e=>_w(e,{onFailure:Oe,onSuccess:et}),st=e=>_r(e)&&!(No in e)?Ee(t=>ft(Mr(pp(e,Cp(t))))):ft(Mr(e)),rl=e=>P(M(e),st),ft=e=>{const t=new hw(xt);return t.effect_instruction_i0=e,t},bw=e=>P(M(e),ft),sl=Ee(e=>L(e.id())),Ic=e=>Ee(t=>e(t.id())),P=d(2,(e,t)=>{const n=new dt(Ha);return n.effect_instruction_i0=e,n.effect_instruction_i1=t,n}),RO=e=>{const t=new dt("OnStep");return t.effect_instruction_i0=e,t},$c=e=>P(e,ne),_w=d(2,(e,t)=>cn(e,{onFailure:n=>L(t.onFailure(n)),onSuccess:n=>L(t.onSuccess(n))})),cn=d(2,(e,t)=>{const n=new dt(Da);return n.effect_instruction_i0=e,n.effect_instruction_i1=t.onFailure,n.effect_instruction_i2=t.onSuccess,n}),Wn=d(2,(e,t)=>cn(e,{onFailure:n=>{if(uO(n).length>0)return ft(dO(n));const s=aO(n);return s.length>0?t.onFailure(m_(s)):ft(n)},onSuccess:t.onSuccess})),ar=d(2,(e,t)=>le(()=>{const n=Ne(e),r=xu(n.length);let s=0;return Yt(Sp({while:()=>s<n.length,body:()=>t(n[s],s),step:o=>{r[s++]=o}}),r)})),ol=d(2,(e,t)=>le(()=>{const n=Ne(e);let r=0;return Sp({while:()=>r<n.length,body:()=>t(n[r],r),step:()=>{r++}})})),Ct=P(sl,e=>ww(e)),ww=e=>ft(hn(e)),mp=e=>{const t=new dt(Qo);return t.effect_instruction_i0=U1(Os),t.effect_instruction_i1=()=>e,t},OO=d(2,(e,t)=>Cn(n=>P(Un(n(e)),r=>pP(t,r)))),se=d(2,(e,t)=>P(e,n=>M(()=>t(n)))),gp=d(2,(e,t)=>Wn(e,{onFailure:n=>rl(()=>t.onFailure(n)),onSuccess:n=>M(()=>t.onSuccess(n))})),il=d(2,(e,t)=>cn(e,{onFailure:n=>{const r=cw(n);switch(r._tag){case"Left":return rl(()=>t(r.left));case"Right":return ft(r.right)}},onSuccess:L})),Ho=d(2,(e,t)=>Cn(n=>cn(n(e),{onFailure:r=>{const s=Oe(r);return cn(t(s),{onFailure:o=>Oe(Ot(r,o)),onSuccess:()=>s})},onSuccess:r=>{const s=et(r);return gt(t(s),s)}}))),Ac=d(2,(e,t)=>Ho(e,dl({onFailure:n=>el(n)?an(t(iw(n))):Ke,onSuccess:()=>Ke}))),yp=e=>PO(e,ne),PO=d(2,(e,t)=>Wn(e,{onFailure:n=>Rr(t(n)),onSuccess:L})),L=e=>{const t=new dw(Ft);return t.effect_instruction_i0=e,t},le=e=>{const t=new dt(Ou);return t.commit=e,t},M=e=>{const t=new dt(ob);return t.effect_instruction_i0=e,t},cl=d(e=>e.length===3||e.length===2&&!(_r(e[1])&&"onlyEffect"in e[1]),(e,t)=>P(e,n=>{const r=typeof t=="function"?t(n):t;return vr(r)?Yt(r,n):gC(r)?Za(s=>{r.then(o=>s(L(n)),o=>s(st(new Pw(o,"An unknown error occurred in Effect.tap"))))}):L(n)})),xO=e=>Ee(t=>{const n=t.getFiberRef(kh),r=p(n,qe(()=>t.scope()));return e(Rc(kh,U(r)))}),xs=e=>{const t=new dt(Qo);return t.effect_instruction_i0=X_(Os),t.effect_instruction_i1=()=>e,t},Cn=e=>mw(e,function(){const t=new dt(Qo);return t.effect_instruction_i0=X_(Os),t.effect_instruction_i1=n=>Y_(n)?Kt(()=>this.effect_instruction_i0(mp)):Kt(()=>this.effect_instruction_i0(xs)),t}),Ke=L(void 0),FO=e=>{const t=new dt(Qo);return t.effect_instruction_i0=e,t.effect_instruction_i1=void 0,t},al=d(2,(e,t)=>P(t,n=>n?p(e,se(U)):L(K()))),Sp=e=>{const t=new dt(Ua);return t.effect_instruction_i0=e.while,t.effect_instruction_i1=e.body,t.effect_instruction_i2=e.step,t},vh=e=>le(()=>{const t=new dt(Fi);return t.effect_instruction_i0=e(),t}),vw=function(){const e=arguments.length===1?arguments[0]:arguments[1].bind(arguments[0]);return vh(()=>e(p))},NO=(e,...t)=>Object.defineProperty(t.length===0?function(...n){return vh(()=>e.apply(this,n))}:function(...n){let r=vh(()=>e.apply(this,n));for(const s of t)r=s(r,...n);return r},"length",{value:e.length,configurable:!0}),BO=d(2,(e,t)=>{const n=new dt(Qo);return n.effect_instruction_i0=t,n.effect_instruction_i1=()=>e,n}),ul=e=>{const t=new dt(ma);return typeof e?.priority<"u"?ZO(t,e.priority):t},Tw=d(2,(e,t)=>P(e,n=>se(t,r=>[n,r]))),ll=d(2,(e,t)=>P(e,n=>Yt(t,n))),gt=d(2,(e,t)=>P(e,()=>t)),kw=d(3,(e,t,n)=>P(e,r=>se(t,s=>n(r,s)))),bp=e=>P(sl,t=>p(e,nc(t))),nc=d(2,(e,t)=>P(e.interruptAsFork(t),()=>e.await)),MO={_tag:"All",syslog:0,label:"ALL",ordinal:Number.MIN_SAFE_INTEGER,pipe(){return Y(this,arguments)}},LO={_tag:"Fatal",syslog:2,label:"FATAL",ordinal:5e4,pipe(){return Y(this,arguments)}},HO={_tag:"Error",syslog:3,label:"ERROR",ordinal:4e4,pipe(){return Y(this,arguments)}},Ew={_tag:"Warning",syslog:4,label:"WARN",ordinal:3e4,pipe(){return Y(this,arguments)}},Cw={_tag:"Info",syslog:6,label:"INFO",ordinal:2e4,pipe(){return Y(this,arguments)}},Iw={_tag:"Debug",syslog:7,label:"DEBUG",ordinal:1e4,pipe(){return Y(this,arguments)}},DO={_tag:"Trace",syslog:7,label:"TRACE",ordinal:0,pipe(){return Y(this,arguments)}},UO={_tag:"None",syslog:7,label:"OFF",ordinal:Number.MAX_SAFE_INTEGER,pipe(){return Y(this,arguments)}},KO="effect/FiberRef",jO=Symbol.for(KO),zO={_A:e=>e},_p=e=>Ee(t=>et(t.getFiberRef(e))),fl=d(2,(e,t)=>P(_p(e),t)),xg=d(2,(e,t)=>VO(e,()=>[void 0,t])),VO=d(2,(e,t)=>Ee(n=>{const[r,s]=t(n.getFiberRef(e));return n.setFiberRef(e,s),L(r)})),Rc=d(3,(e,t,n)=>pw(ll(_p(t),xg(t,n)),()=>e,r=>xg(t,r))),qO=d(3,(e,t,n)=>fl(t,r=>Rc(e,t,n(r)))),Qt=(e,t)=>ii(e,{differ:q_(),fork:t?.fork??ne,join:t?.join}),WO=e=>{const t=E1();return ii(e,{differ:t,fork:t.empty})},JO=e=>{const t=C1(q_());return ii(e,{differ:t,fork:t.empty})},$w=e=>{const t=k1();return ii(e,{differ:t,fork:t.empty})},ii=(e,t)=>({..._c,[jO]:zO,initial:e,commit(){return _p(this)},diff:(r,s)=>t.differ.diff(r,s),combine:(r,s)=>t.differ.combine(r,s),patch:r=>s=>t.differ.patch(r,s),fork:t.fork,join:t.join??((r,s)=>s)}),GO=e=>ii(e,{differ:Ig,fork:Ig.empty}),qr=be(Symbol.for("effect/FiberRef/currentContext"),()=>$w(Jd())),Oc=be(Symbol.for("effect/FiberRef/currentSchedulingPriority"),()=>Qt(0)),Aw=be(Symbol.for("effect/FiberRef/currentMaxOpsBeforeYield"),()=>Qt(2048)),YO=be(Symbol.for("effect/FiberRef/currentLogAnnotation"),()=>Qt(up())),QO=be(Symbol.for("effect/FiberRef/currentLogLevel"),()=>Qt(Cw)),XO=be(Symbol.for("effect/FiberRef/currentLogSpan"),()=>Qt(Oo())),ZO=d(2,(e,t)=>Rc(e,Oc,t)),eP=be(Symbol.for("effect/FiberRef/currentConcurrency"),()=>Qt("unbounded")),tP=be(Symbol.for("effect/FiberRef/currentRequestBatching"),()=>Qt(!0)),nP=be(Symbol.for("effect/FiberRef/currentUnhandledErrorLogLevel"),()=>Qt(U(Iw))),rP=be(Symbol.for("effect/FiberRef/versionMismatchErrorLogLevel"),()=>Qt(U(Ew))),Th=be(Symbol.for("effect/FiberRef/currentMetricLabels"),()=>JO(gs())),kh=be(Symbol.for("effect/FiberRef/currentForkScopeOverride"),()=>Qt(K(),{fork:()=>K(),join:(e,t)=>e})),Xc=be(Symbol.for("effect/FiberRef/currentInterruptedCause"),()=>Qt(Br,{fork:()=>Br,join:(e,t)=>e})),Fg=Symbol.for("effect/Scope"),Ng=Symbol.for("effect/CloseableScope"),Rw=(e,t)=>e.addFinalizer(()=>an(t)),eu=(e,t)=>e.addFinalizer(t),Eh=(e,t)=>e.close(t),sr=(e,t)=>e.fork(t),wp=(function(){class e extends globalThis.Error{commit(){return st(this)}toJSON(){const n={...this};return this.message&&(n.message=this.message),this.cause&&(n.cause=this.cause),n}[Me](){return this.toString!==globalThis.Error.prototype.toString?this.stack?`${this.toString()}
${this.stack.split(`
`).slice(1).join(`
`)}`:this.toString():"Bun"in globalThis?oi(Mr(this),{renderErrorCause:!0}):this}}return Object.assign(e.prototype,KC),e})(),Ow=(e,t)=>{class n extends wp{_tag=t}return Object.assign(n.prototype,e),n.prototype.name=t,n},Bg=Symbol.for("effect/Cause/errors/RuntimeException"),sP=Ow({[Bg]:Bg},"RuntimeException"),oP=Symbol.for("effect/Cause/errors/InterruptedException"),iP=e=>re(e,oP),Mg=Symbol.for("effect/Cause/errors/NoSuchElement"),vp=Ow({[Mg]:Mg},"NoSuchElementException"),Lg=Symbol.for("effect/Cause/errors/UnknownException"),Pw=(function(){class e extends wp{_tag="UnknownException";error;constructor(n,r){super(r??"An unknown error occurred",{cause:n}),this.error=n}}return Object.assign(e.prototype,{[Lg]:Lg,name:"UnknownException"}),e})(),hl=e=>vr(e)&&"_tag"in e&&(e._tag==="Success"||e._tag==="Failure"),cP=e=>e._tag==="Failure",aP=e=>e._tag==="Success",uP=d(2,(e,t)=>{switch(e._tag){case xt:return Oe(e.effect_instruction_i0);case Ft:return et(t)}}),hf=e=>uP(e,void 0),po=(e,t)=>hP(e,t?.parallel?Lr:Ot),xw=e=>Oe(rn(e)),Ch=e=>Oe(Mr(e)),Oe=e=>{const t=new hw(xt);return t.effect_instruction_i0=e,t},Fw=e=>Oe(hn(e)),wa=d(2,(e,t)=>{switch(e._tag){case xt:return Oe(e.effect_instruction_i0);case Ft:return et(t(e.effect_instruction_i0))}}),dl=d(2,(e,{onFailure:t,onSuccess:n})=>{switch(e._tag){case xt:return t(e.effect_instruction_i0);case Ft:return n(e.effect_instruction_i0)}}),Ih=d(2,(e,{onFailure:t,onSuccess:n})=>{switch(e._tag){case xt:return t(e.effect_instruction_i0);case Ft:return n(e.effect_instruction_i0)}}),et=e=>{const t=new dw(Ft);return t.effect_instruction_i0=e,t},kn=et(void 0),lP=d(2,(e,t)=>Tp(e,t,{onSuccess:(n,r)=>[n,r],onFailure:Ot})),fP=d(2,(e,t)=>Tp(e,t,{onSuccess:(n,r)=>r,onFailure:Ot})),Tp=d(3,(e,t,{onFailure:n,onSuccess:r})=>{switch(e._tag){case xt:switch(t._tag){case Ft:return Oe(e.effect_instruction_i0);case xt:return Oe(n(e.effect_instruction_i0,t.effect_instruction_i0))}case Ft:switch(t._tag){case Ft:return et(r(e.effect_instruction_i0,t.effect_instruction_i0));case xt:return Oe(t.effect_instruction_i0)}}}),hP=(e,t)=>{const n=Wi(e);return Vn(n)?p(cr(n),Hd(p(Bn(n),wa(Be)),(r,s)=>p(r,Tp(s,{onSuccess:(o,i)=>p(o,Bt(i)),onFailure:t}))),wa(Sr),wa(r=>fr(r)),U):K()},Pc=e=>({..._c,[EO]:CO,state:As(IO([])),commit(){return Jn(this)},blockingOn:e}),xc=()=>P(sl,e=>dP(e)),dP=e=>M(()=>Pc(e)),Jn=e=>gw(t=>{const n=_e(e.state);switch(n._tag){case nl:return t(n.effect);case Ec:return n.joiners.push(t),gP(e,t)}},e.blockingOn),pl=d(2,(e,t)=>M(()=>{const n=_e(e.state);switch(n._tag){case nl:return!1;case Ec:{Rs(e.state,lw(t));for(let r=0,s=n.joiners.length;r<s;r++)n.joiners[r](t);return!0}}})),pP=d(2,(e,t)=>pl(e,t)),Nw=d(2,(e,t)=>pl(e,ft(t))),kp=d(2,(e,t)=>pl(e,ww(t))),mP=e=>M(()=>_e(e.state)._tag===nl),Fc=d(2,(e,t)=>pl(e,L(t))),ml=(e,t)=>{const n=_e(e.state);if(n._tag===Ec){Rs(e.state,lw(t));for(let r=0,s=n.joiners.length;r<s;r++)n.joiners[r](t)}},gP=(e,t)=>M(()=>{const n=_e(e.state);if(n._tag===Ec){const r=n.joiners.indexOf(t);r>=0&&n.joiners.splice(r,1)}}),yP=Ee(e=>et(e.currentContext)),SP=()=>yP,Fs=e=>P(SP(),e),gl=d(2,(e,t)=>Rc(qr,t)(e)),Ep=d(2,(e,t)=>qO(qr,n=>Hu(n,t))(e)),bP=d(2,(e,t)=>Fs(n=>gl(e,t(n)))),Cp=e=>{const t=e.currentSpan;return t!==void 0&&t._tag==="Span"?U(t):K()},pn=xc,It=Jn,Bw=Nw,$h=mP,Mn=Fc,Mw=cP,tu=aP,_P=po,wP=xw,Lw=Ch,mn=Oe,vP=wa,Ln=dl,dn=et,TP=kn,Hg=lP,rc=fP,Dg=Symbol.for("effect/MutableHashMap"),kP={[Dg]:Dg,[Symbol.iterator](){return new Ip(this)},toString(){return at(this.toJSON())},toJSON(){return{_id:"MutableHashMap",values:Array.from(this).map(Ge)}},[Me](){return this.toJSON()},pipe(){return Y(this,arguments)}};class Ip{self;referentialIterator;bucketIterator;constructor(t){this.self=t,this.referentialIterator=t.referential[Symbol.iterator]()}next(){if(this.bucketIterator!==void 0)return this.bucketIterator.next();const t=this.referentialIterator.next();return t.done?(this.bucketIterator=new EP(this.self.buckets.values()),this.next()):t}[Symbol.iterator](){return new Ip(this.self)}}class EP{backing;constructor(t){this.backing=t}currentBucket;next(){if(this.currentBucket===void 0){const n=this.backing.next();if(n.done)return n;this.currentBucket=n.value[Symbol.iterator]()}const t=this.currentBucket.next();return t.done?(this.currentBucket=void 0,this.next()):t}}const CP=()=>{const e=Object.create(kP);return e.referential=new Map,e.buckets=new Map,e.bucketsSize=0,e},Xr=d(2,(e,t)=>{if(La(t)===!1)return e.referential.has(t)?U(e.referential.get(t)):K();const n=t[pe](),r=e.buckets.get(n);return r===void 0?K():IP(e,r,t)}),IP=(e,t,n,r=!1)=>{for(let s=0,o=t.length;s<o;s++)if(n[de](t[s][0])){const i=t[s][1];return r&&(t.splice(s,1),e.bucketsSize--),U(i)}return K()},mi=d(2,(e,t)=>$e(Xr(e,t))),gi=d(3,(e,t,n)=>{if(La(t)===!1)return e.referential.set(t,n),e;const r=t[pe](),s=e.buckets.get(r);return s===void 0?(e.buckets.set(r,[[t,n]]),e.bucketsSize++,e):($P(e,s,t),s.push([t,n]),e.bucketsSize++,e)}),$P=(e,t,n)=>{for(let r=0,s=t.length;r<s;r++)if(n[de](t[r][0])){t.splice(r,1),e.bucketsSize--;return}},Ug=Symbol.for("effect/MutableList"),AP={[Ug]:Ug,[Symbol.iterator](){let e=!1,t=this.head;return{next(){if(e)return this.return();if(t==null)return e=!0,this.return();const n=t.value;return t=t.next,{done:e,value:n}},return(n){return e||(e=!0),{done:!0,value:n}}}},toString(){return at(this.toJSON())},toJSON(){return{_id:"MutableList",values:Array.from(this).map(Ge)}},[Me](){return this.toJSON()},pipe(){return Y(this,arguments)}},RP=e=>({value:e,removed:!1,prev:void 0,next:void 0}),OP=()=>{const e=Object.create(AP);return e.head=void 0,e.tail=void 0,e._length=0,e},Hw=e=>$p(e)===0,$p=e=>e._length,PP=d(2,(e,t)=>{const n=RP(t);return e.head===void 0&&(e.head=n),e.tail===void 0||(e.tail.next=n,n.prev=e.tail),e.tail=n,e._length+=1,e}),xP=e=>{const t=e.head;if(t!==void 0)return FP(e,t),t.value},FP=(e,t)=>{t.removed||(t.removed=!0,t.prev!==void 0&&t.next!==void 0?(t.prev.next=t.next,t.next.prev=t.prev):t.prev!==void 0?(e.tail=t.prev,t.prev.next=void 0):t.next!==void 0?(e.head=t.next,t.next.prev=void 0):(e.tail=void 0,e.head=void 0),e._length>0&&(e._length-=1))},Kg=Symbol.for("effect/MutableQueue"),ot=Symbol.for("effect/mutable/MutableQueue/Empty"),NP={[Kg]:Kg,[Symbol.iterator](){return Array.from(this.queue)[Symbol.iterator]()},toString(){return at(this.toJSON())},toJSON(){return{_id:"MutableQueue",values:Array.from(this).map(Ge)}},[Me](){return this.toJSON()},pipe(){return Y(this,arguments)}},Dw=e=>{const t=Object.create(NP);return t.queue=OP(),t.capacity=e,t},BP=e=>Dw(e),yl=()=>Dw(void 0),Ap=e=>$p(e.queue),fs=e=>Hw(e.queue),MP=e=>e.capacity===void 0?1/0:e.capacity,Do=d(2,(e,t)=>{const n=$p(e.queue);return e.capacity!==void 0&&n===e.capacity?!1:(PP(t)(e.queue),!0)}),Rp=d(2,(e,t)=>{const n=t[Symbol.iterator]();let r,s=We(),o=!0;for(;o&&(r=n.next())&&!r.done;)o=Do(r.value)(e);for(;r!=null&&!r.done;)s=Bt(r.value)(s),r=n.next();return Sr(s)}),pr=d(2,(e,t)=>Hw(e.queue)?t:xP(e.queue)),Sl=d(2,(e,t)=>{let n=We(),r=0;for(;r<t;){const s=pr(ot)(e);if(s===ot)break;n=Bt(s)(n),r+=1}return Sr(n)}),LP="effect/Clock",jg=Symbol.for(LP),bl=$s("effect/Clock"),HP=2**31-1,zg={unsafeSchedule(e,t){const n=Gi(t);if(n>HP)return Gf;let r=!1;const s=setTimeout(()=>{r=!0,e()},n);return()=>(clearTimeout(s),!r)}},Vg=(function(){const e=BigInt(1e6);if(typeof performance>"u"||typeof performance.now!="function")return()=>BigInt(Date.now())*e;let t;return()=>(t===void 0&&(t=BigInt(Date.now())*e-BigInt(Math.round(performance.now()*1e6))),t+BigInt(Math.round(performance.now()*1e6)))})(),DP=(function(){const e=typeof process=="object"&&"hrtime"in process&&typeof process.hrtime.bigint=="function"?process.hrtime:void 0;if(!e)return Vg;const t=Vg()-e.bigint();return()=>t+e.bigint()})();class UP{[jg]=jg;unsafeCurrentTimeMillis(){return Date.now()}unsafeCurrentTimeNanos(){return DP()}currentTimeMillis=M(()=>this.unsafeCurrentTimeMillis());currentTimeNanos=M(()=>this.unsafeCurrentTimeNanos());scheduler(){return L(zg)}sleep(t){return qn(n=>{const r=zg.unsafeSchedule(()=>n(Ke),t);return an(M(r))})}}const KP=()=>new UP,Uw="And",Kw="Or",jw="InvalidData",zw="MissingData",Vw="SourceUnavailable",qw="Unsupported",jP="effect/ConfigError",qg=Symbol.for(jP),ci={_tag:"ConfigError",[qg]:qg},Ww=(e,t)=>{const n=Object.create(ci);return n._op=Uw,n.left=e,n.right=t,Object.defineProperty(n,"toString",{enumerable:!1,value(){return`${this.left} and ${this.right}`}}),Object.defineProperty(n,"message",{enumerable:!1,get(){return this.toString()}}),n},Jw=(e,t)=>{const n=Object.create(ci);return n._op=Kw,n.left=e,n.right=t,Object.defineProperty(n,"toString",{enumerable:!1,value(){return`${this.left} or ${this.right}`}}),Object.defineProperty(n,"message",{enumerable:!1,get(){return this.toString()}}),n},zP=(e,t,n={pathDelim:"."})=>{const r=Object.create(ci);return r._op=jw,r.path=e,r.message=t,Object.defineProperty(r,"toString",{enumerable:!1,value(){return`(Invalid data at ${p(this.path,Zo(n.pathDelim))}: "${this.message}")`}}),r},Ts=(e,t,n={pathDelim:"."})=>{const r=Object.create(ci);return r._op=zw,r.path=e,r.message=t,Object.defineProperty(r,"toString",{enumerable:!1,value(){return`(Missing data at ${p(this.path,Zo(n.pathDelim))}: "${this.message}")`}}),r},VP=(e,t,n,r={pathDelim:"."})=>{const s=Object.create(ci);return s._op=Vw,s.path=e,s.message=t,s.cause=n,Object.defineProperty(s,"toString",{enumerable:!1,value(){return`(Source unavailable at ${p(this.path,Zo(r.pathDelim))}: "${this.message}")`}}),s},qP=(e,t,n={pathDelim:"."})=>{const r=Object.create(ci);return r._op=qw,r.path=e,r.message=t,Object.defineProperty(r,"toString",{enumerable:!1,value(){return`(Unsupported operation at ${p(this.path,Zo(n.pathDelim))}: "${this.message}")`}}),r},rs=d(2,(e,t)=>{switch(e._op){case Uw:return Ww(rs(e.left,t),rs(e.right,t));case Kw:return Jw(rs(e.left,t),rs(e.right,t));case jw:return zP([...t,...e.path],e.message);case zw:return Ts([...t,...e.path],e.message);case Vw:return VP([...t,...e.path],e.message,e.cause);case qw:return qP([...t,...e.path],e.message)}}),WP={_tag:"Empty"},df=d(2,(e,t)=>{let n=lp(t),r=e;for(;PR(n);){const s=n.head;switch(s._tag){case"Empty":{n=n.tail;break}case"AndThen":{n=ws(s.first,ws(s.second,n.tail));break}case"MapName":{r=as(r,s.f),n=n.tail;break}case"Nested":{r=ja(r,s.name),n=n.tail;break}case"Unnested":{if(p(Ni(r),dI(s.name)))r=ms(r),n=n.tail;else return oe(Ts(r,`Expected ${s.name} to be in path in ConfigProvider#unnested`));break}}}return me(r)}),JP="Constant",GP="Fail",YP="Fallback",QP="Described",XP="Lazy",ZP="MapOrFail",ex="Nested",tx="Primitive",nx="Sequence",rx="HashMap",sx="ZipWith";var Wg={};const nu=(e,t)=>[...e,...t],ox="effect/ConfigProvider",Jg=Symbol.for(ox),ix=$s("effect/ConfigProvider"),cx="effect/ConfigProviderFlat",Gg=Symbol.for(cx),ax=e=>({[Jg]:Jg,pipe(){return Y(this,arguments)},...e}),ux=e=>({[Gg]:Gg,patch:e.patch,load:(t,n,r=!0)=>e.load(t,n,r),enumerateChildren:e.enumerateChildren}),lx=e=>ax({load:t=>P(ln(e,gs(),t,!1),n=>Fe(Ni(n),{onNone:()=>st(Ts(gs(),`Expected a single value having structure: ${t}`)),onSome:L})),flattened:e}),fx=e=>{const{pathDelim:t,seqDelim:n}=Object.assign({},{pathDelim:"_",seqDelim:","},e),r=a=>p(a,Zo(t)),s=a=>a.split(t),o=()=>typeof process<"u"&&"env"in process&&typeof Wg=="object"?Wg:{};return lx(ux({load:(a,u,l=!0)=>{const f=r(a),h=o(),m=f in h?U(h[f]):K();return p(m,il(()=>Ts(a,`Expected ${f} to exist in the process context`)),P(y=>gx(y,a,u,n,l)))},enumerateChildren:a=>M(()=>{const u=o(),h=Object.keys(u).map(m=>s(m.toUpperCase())).filter(m=>{for(let y=0;y<a.length;y++){const S=p(a,wb(y)),_=m[y];if(_===void 0||S!==_)return!1}return!0}).flatMap(m=>m.slice(a.length,a.length+1));return lR(h)}),patch:WP}))},hx=(e,t,n,r)=>{const s=ig(n.length,a=>a>=r.length?K():U([e(a),a+1])),o=ig(r.length,a=>a>=n.length?K():U([t(a),a+1])),i=nu(n,s),c=nu(r,o);return[i,c]},dx=(e,t)=>{let n=t;if(n._tag==="Nested"){const r=e.slice();for(;n._tag==="Nested";)r.push(n.name),n=n.config;return r}return e},ln=(e,t,n,r)=>{const s=n;switch(s._tag){case JP:return L(bn(s.value));case QP:return le(()=>ln(e,t,s.config,r));case GP:return st(Ts(t,s.message));case YP:return p(le(()=>ln(e,t,s.first,r)),Mo(o=>s.condition(o)?p(ln(e,t,s.second,r),Mo(i=>st(Jw(o,i)))):st(o)));case XP:return le(()=>ln(e,t,s.config(),r));case ZP:return le(()=>p(ln(e,t,s.original,r),P(ar(o=>p(s.mapOrFail(o),il(rs(dx(t,s.original))))))));case ex:return le(()=>ln(e,nu(t,bn(s.name)),s.config,r));case tx:return p(df(t,e.patch),P(o=>p(e.load(o,s,r),P(i=>{if(i.length===0){const c=p(EI(o),qe(()=>"<n/a>"));return st(Ts([],`Expected ${s.description} with name ${c}`))}return L(i)}))));case nx:return p(df(t,e.patch),P(o=>p(e.enumerateChildren(o),P(Sx),P(i=>i.length===0?le(()=>se(ln(e,t,s.config,!0),bn)):p(ar(i,c=>ln(e,bI(t,`[${c}]`),s.config,!0)),se(c=>{const a=xI(c);return a.length===0?bn(gs()):bn(a)}))))));case rx:return le(()=>p(df(t,e.patch),P(o=>p(e.enumerateChildren(o),P(i=>p(i,ar(c=>ln(e,nu(o,bn(c)),s.valueConfig,r)),se(c=>c.length===0?bn(up()):p(yx(c),as(a=>TR(og(Ne(i),a)))))))))));case sx:return le(()=>p(ln(e,t,s.left,r),Lo,P(o=>p(ln(e,t,s.right,r),Lo,P(i=>{if(Tt(o)&&Tt(i))return st(Ww(o.left,i.left));if(Tt(o)&&Nn(i))return st(o.left);if(Nn(o)&&Tt(i))return st(i.left);if(Nn(o)&&Nn(i)){const c=p(t,Zo(".")),a=px(t,c),[u,l]=hx(a,a,p(o.right,as(me)),p(i.right,as(me)));return p(u,og(l),ar(([f,h])=>p(Tw(f,h),se(([m,y])=>s.zip(m,y)))))}throw new Error("BUG: ConfigProvider.fromFlatLoop - please report an issue at https://github.com/Effect-TS/effect/issues")})))))}},px=(e,t)=>n=>oe(Ts(e,`The element at index ${n} in a sequence at path "${t}" was missing`)),mx=(e,t)=>e.split(new RegExp(`\\s*${Va(t)}\\s*`)),gx=(e,t,n,r,s)=>s?p(mx(e,r),ar(o=>n.parse(o.trim())),il(rs(t))):p(n.parse(e),gp({onFailure:rs(t),onSuccess:bn})),yx=e=>Object.keys(e[0]).map(t=>e.map(n=>n[t])),Sx=e=>p(ar(e,_x),gp({onFailure:()=>gs(),onSuccess:qi(ko)}),Lo,se(tI)),bx=/^(\[(\d+)\])$/,_x=e=>{const t=e.match(bx);if(t!==null){const n=t[2];return p(n!==void 0&&n.length>0?U(n):K(),Xo(wx))}return K()},wx=e=>{const t=Number.parseInt(e);return Number.isNaN(t)?K():U(t)},Yg=Symbol.for("effect/Console"),Gw=$s("effect/Console"),vx={[Yg]:Yg,assert(e,...t){return M(()=>{console.assert(e,...t)})},clear:M(()=>{console.clear()}),count(e){return M(()=>{console.count(e)})},countReset(e){return M(()=>{console.countReset(e)})},debug(...e){return M(()=>{console.debug(...e)})},dir(e,t){return M(()=>{console.dir(e,t)})},dirxml(...e){return M(()=>{console.dirxml(...e)})},error(...e){return M(()=>{console.error(...e)})},group(e){return e?.collapsed?M(()=>console.groupCollapsed(e?.label)):M(()=>console.group(e?.label))},groupEnd:M(()=>{console.groupEnd()}),info(...e){return M(()=>{console.info(...e)})},log(...e){return M(()=>{console.log(...e)})},table(e,t){return M(()=>{console.table(e,t)})},time(e){return M(()=>console.time(e))},timeEnd(e){return M(()=>console.timeEnd(e))},timeLog(e,...t){return M(()=>{console.timeLog(e,...t)})},trace(...e){return M(()=>{console.trace(...e)})},warn(...e){return M(()=>{console.warn(...e)})},unsafe:console},Tx="effect/Random",Qg=Symbol.for(Tx),kx=$s("effect/Random");class Ex{seed;[Qg]=Qg;PRNG;constructor(t){this.seed=t,this.PRNG=new TC(t)}get next(){return M(()=>this.PRNG.number())}get nextBoolean(){return se(this.next,t=>t>.5)}get nextInt(){return M(()=>this.PRNG.integer(Number.MAX_SAFE_INTEGER))}nextRange(t,n){return se(this.next,r=>(n-t)*r+t)}nextIntBetween(t,n){return M(()=>this.PRNG.integer(n-t)+t)}shuffle(t){return Cx(t,n=>this.nextIntBetween(0,n))}}const Cx=(e,t)=>le(()=>p(M(()=>Array.from(e)),P(n=>{const r=[];for(let s=n.length;s>=2;s=s-1)r.push(s);return p(r,ol(s=>p(t(s),se(o=>Ix(n,s-1,o)))),Yt(Wi(n)))}))),Ix=(e,t,n)=>{const r=e[t];return e[t]=e[n],e[n]=r,e},$x=e=>new Ex(Q(e)),Xg=Symbol.for("effect/Tracer"),Ax=e=>({[Xg]:Xg,...e}),Yw=$s("effect/Tracer"),Qw=$s("effect/ParentSpan"),Zg=(function(){const e="abcdef0123456789",t=e.length;return function(n){let r="";for(let s=0;s<n;s++)r+=e.charAt(Math.floor(Math.random()*t));return r}})();class Rx{name;parent;context;startTime;kind;_tag="Span";spanId;traceId="native";sampled=!0;status;attributes;events=[];links;constructor(t,n,r,s,o,i){this.name=t,this.parent=n,this.context=r,this.startTime=o,this.kind=i,this.status={_tag:"Started",startTime:o},this.attributes=new Map,this.traceId=n._tag==="Some"?n.value.traceId:Zg(32),this.spanId=Zg(16),this.links=Array.from(s)}end(t,n){this.status={_tag:"Ended",endTime:t,exit:n,startTime:this.status.startTime}}attribute(t,n){this.attributes.set(t,n)}event(t,n,r){this.events.push([t,n,r??{}])}addLinks(t){this.links.push(...t)}}const Ox=Ax({span:(e,t,n,r,s,o)=>new Rx(e,t,n,r,s,o),context:e=>e()}),Px=p(Jd(),Zr(bl,KP()),Zr(Gw,vx),Zr(kx,$x(Math.random())),Zr(ix,fx()),Zr(Yw,Ox)),ru=be(Symbol.for("effect/DefaultServices/currentServices"),()=>$w(Px)),xx=e=>{const t=Jt(e);return Xw(n=>n.sleep(t))},Fx=e=>Ee(t=>e(t.currentDefaultServices)),Xw=e=>Fx(t=>e(t.unsafeMap.get(bl.key))),Nx=Xw(e=>e.currentTimeMillis),Bx=xx,Mx=Nx;function Lx(e){return new Hr(e)}function Hx(){return Lx(new Map)}const ey=Symbol.for("effect/FiberRefs");class Hr{locals;[ey]=ey;constructor(t){this.locals=t}pipe(){return Y(this,arguments)}}const Dx=(e,t,n,r=!1)=>{const s=e;let o=t,i=n,c=r,a;for(;a===void 0;)if(wt(o)&&wt(i)){const u=Vt(o)[0],l=ms(o),f=Vt(i)[0],h=Vt(i)[1],m=ms(i);u.startTimeMillis<f.startTimeMillis?(i=m,c=!0):u.startTimeMillis>f.startTimeMillis?o=l:u.id<f.id?(i=m,c=!0):u.id>f.id?o=l:a=[h,c]}else a=[s.initial,!0];return a},Ux=d(3,(e,t,n)=>{const r=new Map(e.locals);return n.locals.forEach((s,o)=>{const i=s[0][1];if(!s[0][0][de](t)){if(!r.has(o)){if(ie(i,o.initial))return;r.set(o,[[t,o.join(o.initial,i)]]);return}const c=r.get(o),[a,u]=Dx(o,c,s);if(u){const l=o.diff(a,i),f=c[0][1],h=o.join(f,o.patch(l)(f));if(!ie(f,h)){let m;const y=c[0][0];y[de](t)?m=[[y,h],...c.slice(1)]:m=[[t,h],...c],r.set(o,m)}}}}),new Hr(r)}),Kx=d(2,(e,t)=>{const n=new Map;return Zw(e,n,t),new Hr(n)}),Zw=(e,t,n)=>{e.locals.forEach((r,s)=>{const o=r[0][1],i=s.patch(s.fork)(o);ie(o,i)?t.set(s,r):t.set(s,[[n,i],...r])})},ev=d(2,(e,t)=>{const n=new Map(e.locals);return n.delete(t),new Hr(n)}),jx=d(2,(e,t)=>e.locals.has(t)?U(Vt(e.locals.get(t))[1]):K()),sc=d(2,(e,t)=>p(jx(e,t),qe(()=>t.initial))),Ah=d(2,(e,{fiberId:t,fiberRef:n,value:r})=>{if(e.locals.size===0)return new Hr(new Map([[n,[[t,r]]]]));const s=new Map(e.locals);return Rh(s,t,n,r),new Hr(s)}),Rh=(e,t,n,r)=>{const s=e.get(n)??[];let o;if(wt(s)){const[i,c]=Vt(s);if(i[de](t)){if(ie(c,r))return;o=[[t,r],...s.slice(1)]}else o=[[t,r],...s]}else o=[[t,r]];e.set(n,o)},zx=d(2,(e,{entries:t,forkAs:n})=>{if(e.locals.size===0)return new Hr(new Map(t));const r=new Map(e.locals);return n!==void 0&&Zw(e,r,n),t.forEach(([s,o])=>{o.length===1?Rh(r,o[0][0],s,o[0][1]):o.forEach(([i,c])=>{Rh(r,i,s,c)})}),new Hr(r)}),Vx=sc,qx=zx,Wx=Hx,Jx=MO,Gx=LO,Yx=HO,Qx=Ew,Xx=Cw,Zx=Iw,eF=DO,tF=UO,nF=p(ko,Sb(e=>e.ordinal)),rF=sI(nF),sF=e=>{switch(e){case"All":return Jx;case"Debug":return Zx;case"Error":return Yx;case"Fatal":return Gx;case"Info":return Xx;case"Trace":return eF;case"None":return tF;case"Warning":return Qx}},tv=e=>e.replace(/[\s="]/g,"_"),oF=e=>t=>`${tv(t.label)}=${e-t.startTime}ms`,iF=bc,cF=jC;let ai=class extends cF{};const Uo=Symbol.for("effect/Readable"),Op=Symbol.for("effect/Ref"),Pp={_A:e=>e};class aF extends ai{ref;commit(){return this.get}[Op]=Pp;[Uo]=Uo;constructor(t){super(),this.ref=t,this.get=M(()=>_e(this.ref))}get;modify(t){return M(()=>{const n=_e(this.ref),[r,s]=t(n);return n!==s&&Rs(s)(this.ref),r})}}const xp=e=>new aF(As(e)),su=e=>M(()=>xp(e)),gn=e=>e.get,mo=d(2,(e,t)=>e.modify(()=>[void 0,t])),nv=d(2,(e,t)=>e.modify(t)),ou=d(2,(e,t)=>e.modify(n=>[void 0,t(n)])),uF=Op,Fp=su,Li=gn,yi=nv,rv=mo,sv=ou,ov="Empty",iv="Add",cv="Remove",av="Update",uv="AndThen",lF={_tag:ov},lv=(e,t)=>{const n=new Map(e.locals);let r=lF;for(const[s,o]of t.locals.entries()){const i=Vt(o)[1],c=n.get(s);if(c!==void 0){const a=Vt(c)[1];ie(a,i)||(r=pf({_tag:av,fiberRef:s,patch:s.diff(a,i)})(r))}else r=pf({_tag:iv,fiberRef:s,value:i})(r);n.delete(s)}for(const[s]of n.entries())r=pf({_tag:cv,fiberRef:s})(r);return r},pf=d(2,(e,t)=>({_tag:uv,first:e,second:t})),fv=d(3,(e,t,n)=>{let r=n,s=bn(e);for(;wt(s);){const o=Vt(s),i=ms(s);switch(o._tag){case ov:{s=i;break}case iv:{r=Ah(r,{fiberId:t,fiberRef:o.fiberRef,value:o.value}),s=i;break}case cv:{r=ev(r,o.fiberRef),s=i;break}case av:{const c=sc(r,o.fiberRef);r=Ah(r,{fiberId:t,fiberRef:o.fiberRef,value:o.fiberRef.patch(o.patch)(c)}),s=i;break}case uv:{s=ja(o.first)(ja(o.second)(i));break}}}return r}),hv="effect/MetricLabel",Oh=Symbol.for(hv);class fF{key;value;[Oh]=Oh;_hash;constructor(t,n){this.key=t,this.value=n,this._hash=Ze(hv+this.key+this.value)}[pe](){return this._hash}[de](t){return dF(t)&&this.key===t.key&&this.value===t.value}pipe(){return Y(this,arguments)}}const hF=(e,t)=>new fF(e,t),dF=e=>re(e,Oh),pF=e=>se(e,U),mF=d(2,(e,t)=>cn(e,{onFailure:n=>{const r=t(n);switch(r._tag){case"None":return ft(n);case"Some":return r.value}},onSuccess:L})),gF=e=>CF(e,SF,lv),dv=d(2,(e,t)=>Wn(e,{onFailure:n=>L(t.onFailure(n)),onSuccess:n=>L(t.onSuccess(n))})),yF=e=>{const t=P(P(e,()=>ul()),()=>t);return t},SF=Ee(e=>L(e.getFiberRefs())),bF=e=>dv(e,{onFailure:Ba,onSuccess:Ba}),ty=d(2,(e,t)=>cn(e,{onFailure:n=>bw(()=>t(n)),onSuccess:L})),_F=e=>se(e,t=>!t),wF=e=>AF((t,n)=>p(e,fv(t,n))),vF=e=>e.length>=1?qn((t,n)=>{try{e(n).then(r=>t(L(r)),r=>t(Rr(r)))}catch(r){t(Rr(r))}}):qn(t=>{try{e().then(n=>t(L(n)),n=>t(Rr(n)))}catch(n){t(Rr(n))}}),TF=d(3,(e,t,n)=>Fs(r=>gl(e,Zr(r,t,n)))),iu=d(3,(e,t,n)=>Fs(r=>P(n,s=>gl(e,p(r,Zr(t,s)))))),kF=d(3,(e,t,n)=>Ne(e).reduce((r,s,o)=>P(r,i=>n(i,s,o)),L(t))),pv=Bx,EF=L(K()),CF=d(3,(e,t,n)=>P(t,r=>P(e,s=>se(t,o=>[n(r,o),s])))),IF=d(2,(e,t)=>cn(e,{onFailure:n=>gt(t(n),ft(n)),onSuccess:L})),$F=e=>{let t,n;typeof e=="function"?t=e:(t=e.try,n=e.catch);const r=s=>n?rl(()=>n(s)):st(new Pw(s,"An unknown error occurred in Effect.tryPromise"));return t.length>=1?qn((s,o)=>{try{t(o).then(i=>s(L(i)),i=>s(r(i)))}catch(i){s(r(i))}}):qn(s=>{try{t().then(o=>s(L(o)),o=>s(r(o)))}catch(o){s(r(o))}})},AF=e=>Ee(t=>(t.setFiberRefs(e(t.id(),t.getFiberRefs())),Ke)),RF=d(2,(e,t)=>le(()=>t()?se(e,U):L(K()))),mv="Sequential",gv="Parallel",OF="ParallelN",xr={_tag:mv},Ph={_tag:gv},PF=e=>({_tag:OF,parallelism:e}),xF=e=>e._tag===mv,FF=e=>e._tag===gv,cu=xr,xh=Ph,Fh=PF,oc=lv,ic=fv,_l="effect/FiberStatus",ks=Symbol.for(_l),au="Done",ny="Running",ry="Suspended",NF=Ze(`${_l}-${au}`);let BF=class{[ks]=ks;_tag=au;[pe](){return NF}[de](t){return Np(t)&&t._tag===au}};class MF{runtimeFlags;[ks]=ks;_tag=ny;constructor(t){this.runtimeFlags=t}[pe](){return p(Q(_l),ye(Q(this._tag)),ye(Q(this.runtimeFlags)),Ye(this))}[de](t){return Np(t)&&t._tag===ny&&this.runtimeFlags===t.runtimeFlags}}class LF{runtimeFlags;blockingOn;[ks]=ks;_tag=ry;constructor(t,n){this.runtimeFlags=t,this.blockingOn=n}[pe](){return p(Q(_l),ye(Q(this._tag)),ye(Q(this.runtimeFlags)),ye(Q(this.blockingOn)),Ye(this))}[de](t){return Np(t)&&t._tag===ry&&this.runtimeFlags===t.runtimeFlags&&ie(this.blockingOn,t.blockingOn)}}const HF=new BF,DF=e=>new MF(e),UF=(e,t)=>new LF(e,t),Np=e=>re(e,ks),KF=e=>e._tag===au,jF=HF,yv=DF,zF=UF,Sv=KF,VF=Symbol.for("effect/Micro"),uu=Symbol.for("effect/Micro/MicroExit"),sy=Symbol.for("effect/Micro/MicroCause"),qF={_E:ne};class bv extends globalThis.Error{_tag;traces;[sy];constructor(t,n,r){const s=`MicroCause.${t}`;let o,i,c;if(n instanceof globalThis.Error){o=`(${s}) ${n.name}`,i=n.message;const a=i.split(`
`).length;c=n.stack?`(${s}) ${n.stack.split(`
`).slice(0,a+3).join(`
`)}`:`${o}: ${i}`}else o=s,i=vo(n,0),c=`${o}: ${i}`;r.length>0&&(c+=`
    ${r.join(`
    `)}`),super(i),this._tag=t,this.traces=r,this[sy]=qF,this.name=o,this.stack=c}pipe(){return Y(this,arguments)}toString(){return this.stack}[Me](){return this.stack}}class WF extends bv{defect;constructor(t,n=[]){super("Die",t,n),this.defect=t}}const JF=(e,t=[])=>new WF(e,t);class GF extends bv{constructor(t=[]){super("Interrupt","interrupted",t)}}const YF=(e=[])=>new GF(e),QF=e=>e._tag==="Interrupt",oy=Symbol.for("effect/Micro/MicroFiber"),XF={_A:ne,_E:ne};class ZF{context;interruptible;[oy];_stack=[];_observers=[];_exit;_children;currentOpCount=0;constructor(t,n=!0){this.context=t,this.interruptible=n,this[oy]=XF}getRef(t){return W$(this.context,t)}addObserver(t){return this._exit?(t(this._exit),Ba):(this._observers.push(t),()=>{const n=this._observers.indexOf(t);n>=0&&this._observers.splice(n,1)})}_interrupted=!1;unsafeInterrupt(){this._exit||(this._interrupted=!0,this.interruptible&&this.evaluate(Dp))}unsafePoll(){return this._exit}evaluate(t){if(this._exit)return;if(this._yielded!==void 0){const s=this._yielded;this._yielded=void 0,s()}const n=this.runLoop(t);if(n===Zc)return;const r=iy.interruptChildren&&iy.interruptChildren(this);if(r!==void 0)return this.evaluate(fu(r,()=>n));this._exit=n;for(let s=0;s<this._observers.length;s++)this._observers[s](n);this._observers.length=0}runLoop(t){let n=!1,r=t;this.currentOpCount=0;try{for(;;){if(this.currentOpCount++,!n&&this.getRef(Up).shouldYield(this)){n=!0;const s=r;r=fu(sN,()=>s)}if(r=r[Nh](this),r===Zc){const s=this._yielded;return uu in s?(this._yielded=void 0,s):Zc}}}catch(s){return re(r,Nh)?Bh(s):Bh(`MicroFiber.runLoop: Not a valid effect: ${String(r)}`)}}getCont(t){for(;;){const n=this._stack.pop();if(!n)return;const r=n[lu]&&n[lu](this);if(r)return{[t]:r};if(n[t])return n}}_yielded=void 0;yieldWith(t){return this._yielded=t,Zc}children(){return this._children??=new Set}}const iy=be("effect/Micro/fiberMiddleware",()=>({interruptChildren:void 0})),_v=Symbol.for("effect/Micro/identifier"),yt=Symbol.for("effect/Micro/args"),Nh=Symbol.for("effect/Micro/evaluate"),Ko=Symbol.for("effect/Micro/successCont"),go=Symbol.for("effect/Micro/failureCont"),lu=Symbol.for("effect/Micro/ensureCont"),Zc=Symbol.for("effect/Micro/Yield"),eN={_A:ne,_E:ne,_R:ne},tN={...iF,_op:"Micro",[VF]:eN,pipe(){return Y(this,arguments)},[Symbol.iterator](){return new ZS(new yc(this))},toJSON(){return{_id:"Micro",op:this[_v],...yt in this?{args:this[yt]}:void 0}},toString(){return at(this)},[Me](){return at(this)}};function nN(e){return Bh("Micro.evaluate: Not implemented")}const wl=e=>({...tN,[_v]:e.op,[Nh]:e.eval??nN,[Ko]:e.contA,[go]:e.contE,[lu]:e.ensure}),Bp=e=>{const t=wl(e);return function(){const n=Object.create(t);return n[yt]=e.single===!1?arguments:arguments[0],n}},wv=e=>{const t={...wl(e),[uu]:uu,_tag:e.op,get[e.prop](){return this[yt]},toJSON(){return{_id:"MicroExit",_tag:e.op,[e.prop]:this[yt]}},[de](n){return cN(n)&&n._tag===e.op&&ie(this[yt],n[yt])},[pe](){return Ye(this,ye(Ze(e.op))(Q(this[yt])))}};return function(n){const r=Object.create(t);return r[yt]=n,r[Ko]=void 0,r[go]=void 0,r[lu]=void 0,r}},Mp=wv({op:"Success",prop:"value",eval(e){const t=e.getCont(Ko);return t?t[Ko](this[yt],e):e.yieldWith(this)}}),vv=wv({op:"Failure",prop:"cause",eval(e){let t=e.getCont(go);for(;QF(this[yt])&&t&&e.interruptible;)t=e.getCont(go);return t?t[go](this[yt],e):e.yieldWith(this)}}),rN=Bp({op:"Yield",eval(e){let t=!1;return e.getRef(Up).scheduleTask(()=>{t||e.evaluate(aN)},this[yt]??0),e.yieldWith(()=>{t=!0})}}),sN=rN(0),oN=Mp(void 0),Lp=Bp({op:"WithMicroFiber",eval(e){return this[yt](e)}}),fu=d(2,(e,t)=>{const n=Object.create(iN);return n[yt]=e,n[Ko]=t,n}),iN=wl({op:"OnSuccess",eval(e){return e._stack.push(this),this[yt]}}),cN=e=>re(e,uu),Tv=Mp,Hp=vv,Dp=Hp(YF()),Bh=e=>Hp(JF(e)),aN=Tv(void 0),uN="setImmediate"in globalThis?globalThis.setImmediate:e=>setTimeout(e,0);class kv{tasks=[];running=!1;scheduleTask(t,n){this.tasks.push(t),this.running||(this.running=!0,uN(this.afterScheduled))}afterScheduled=()=>{this.running=!1,this.runTasks()};runTasks(){const t=this.tasks;this.tasks=[];for(let n=0,r=t.length;n<r;n++)t[n]()}shouldYield(t){return t.currentOpCount>=t.getRef(hN)}flush(){for(;this.tasks.length>0;)this.runTasks()}}const lN=d(2,(e,t)=>Lp(n=>{const r=n.context;return n.context=t(r),mN(e,()=>(n.context=r,oN))})),fN=d(2,(e,t)=>lN(e,Hu(t)));class hN extends Du()("effect/Micro/currentMaxOpsBeforeYield",{defaultValue:()=>2048}){}class Up extends Du()("effect/Micro/currentScheduler",{defaultValue:()=>new kv}){}const dN=d(2,(e,t)=>{const n=Object.create(pN);return n[yt]=e,n[Ko]=t.onSuccess,n[go]=t.onFailure,n}),pN=wl({op:"OnSuccessAndFailure",eval(e){return e._stack.push(this),this[yt]}}),mN=d(2,(e,t)=>yN(n=>dN(n(e),{onFailure:r=>fu(t(Hp(r)),()=>vv(r)),onSuccess:r=>fu(t(Tv(r)),()=>Mp(r))}))),Ev=Bp({op:"SetInterruptible",ensure(e){if(e.interruptible=this[yt],e._interrupted&&e.interruptible)return()=>Dp}}),gN=e=>Lp(t=>t.interruptible?e:(t.interruptible=!0,t._stack.push(Ev(!1)),t._interrupted?Dp:e)),yN=e=>Lp(t=>t.interruptible?(t.interruptible=!1,t._stack.push(Ev(!0)),e(gN)):e(ne)),SN=(e,t)=>{const n=new ZF(Up.context(new kv));return n.evaluate(e),n};class Cv{buckets=[];scheduleTask(t,n){const r=this.buckets.length;let s,o=0;for(;o<r&&this.buckets[o][0]<=n;o++)s=this.buckets[o];s&&s[0]===n?s[1].push(t):o===r?this.buckets.push([n,[t]]):this.buckets.splice(o,0,[n,[t]])}}class bN{maxNextTickBeforeTimer;running=!1;tasks=new Cv;constructor(t){this.maxNextTickBeforeTimer=t}starveInternal(t){const n=this.tasks.buckets;this.tasks.buckets=[];for(const[r,s]of n)for(let o=0;o<s.length;o++)s[o]();this.tasks.buckets.length===0?this.running=!1:this.starve(t)}starve(t=0){t>=this.maxNextTickBeforeTimer?setTimeout(()=>this.starveInternal(0),0):Promise.resolve(void 0).then(()=>this.starveInternal(t+1))}shouldYield(t){return t.currentOpCount>t.getFiberRef(Aw)?t.getFiberRef(Oc):!1}scheduleTask(t,n){this.tasks.scheduleTask(t,n),this.running||(this.running=!0,this.starve())}}const Iv=be(Symbol.for("effect/Scheduler/defaultScheduler"),()=>new bN(2048));class $v{tasks=new Cv;deferred=!1;scheduleTask(t,n){this.deferred?Iv.scheduleTask(t,n):this.tasks.scheduleTask(t,n)}shouldYield(t){return t.currentOpCount>t.getFiberRef(Aw)?t.getFiberRef(Oc):!1}flush(){for(;this.tasks.buckets.length>0;){const t=this.tasks.buckets;this.tasks.buckets=[];for(const[n,r]of t)for(let s=0;s<r.length;s++)r[s]()}this.deferred=!0}}const Kp=be(Symbol.for("effect/FiberRef/currentScheduler"),()=>Qt(Iv)),Av=be(Symbol.for("effect/FiberRef/currentRequestMap"),()=>Qt(new Map)),cy=(e,t,n,r)=>{switch(e){case void 0:return t();case"unbounded":return n();case"inherit":return fl(eP,s=>s==="unbounded"?n():s>1?r(s):t());default:return e>1?r(e):t()}},jp="InterruptSignal",zp="Stateful",Vp="Resume",qp="YieldNow",mf=e=>({_tag:jp,cause:e}),va=e=>({_tag:zp,onFiber:e}),Us=e=>({_tag:Vp,effect:e}),_N=()=>({_tag:qp}),wN="effect/FiberScope",hu=Symbol.for(wN);class vN{[hu]=hu;fiberId=Ro;roots=new Set;add(t,n){this.roots.add(n),n.addObserver(()=>{this.roots.delete(n)})}}class TN{fiberId;parent;[hu]=hu;constructor(t,n){this.fiberId=t,this.parent=n}add(t,n){this.parent.tell(va(r=>{r.addChild(n),n.addObserver(()=>{r.removeChild(n)})}))}}const kN=e=>new TN(e.id(),e),vl=be(Symbol.for("effect/FiberScope/Global"),()=>new vN),EN="effect/Fiber",CN=Symbol.for(EN),IN={_E:e=>e,_A:e=>e},$N="effect/Fiber",AN=Symbol.for($N),RN=e=>e.await,ON=e=>e.inheritAll,cc=e=>ll($c(e.await),e.inheritAll);({..._c});const PN=e=>e.status,Jr="effect/FiberCurrent",xN="effect/Logger",FN=Symbol.for(xN),NN={_Message:e=>e,_Output:e=>e},Wp=e=>({[FN]:NN,log:e,pipe(){return Y(this,arguments)}}),BN=/^[^\s"=]*$/,MN=(e,t)=>({annotations:n,cause:r,date:s,fiberId:o,logLevel:i,message:c,spans:a})=>{const u=y=>y.match(BN)?y:e(y),l=(y,S)=>`${tv(y)}=${u(S)}`,f=(y,S)=>" "+l(y,S);let h=l("timestamp",s.toISOString());h+=f("level",i.label),h+=f("fiber",N_(o));const m=yI(c);for(let y=0;y<m.length;y++)h+=f("message",vo(m[y],t));oO(r)||(h+=f("cause",oi(r,{renderErrorCause:!0})));for(const y of a)h+=" "+oF(s.getTime())(y);for(const[y,S]of n)h+=f(y,vo(S,t));return h},LN=e=>`"${e.replace(/\\([\s\S])|(")/g,"\\$1$2")}"`,HN=Wp(MN(LN)),DN=typeof process=="object"&&process!==null&&typeof process.stdout=="object"&&process.stdout!==null;DN&&process.stdout.isTTY;const Rv="effect/MetricBoundaries",Mh=Symbol.for(Rv);class UN{values;[Mh]=Mh;constructor(t){this.values=t,this._hash=p(Ze(Rv),ye(Sc(this.values)))}_hash;[pe](){return this._hash}[de](t){return KN(t)&&ie(this.values,t.values)}pipe(){return Y(this,arguments)}}const KN=e=>re(e,Mh),jN=e=>{const t=p(e,bb(Be(Number.POSITIVE_INFINITY)),BI);return new UN(t)},zN=e=>p(gI(e.count-1,t=>e.start*Math.pow(e.factor,t)),on,jN),VN="effect/MetricKeyType",Ov=Symbol.for(VN),Pv="effect/MetricKeyType/Counter",Lh=Symbol.for(Pv),qN="effect/MetricKeyType/Frequency",WN=Symbol.for(qN),JN="effect/MetricKeyType/Gauge",GN=Symbol.for(JN),xv="effect/MetricKeyType/Histogram",Hh=Symbol.for(xv),YN="effect/MetricKeyType/Summary",QN=Symbol.for(YN),Fv={_In:e=>e,_Out:e=>e};class XN{incremental;bigint;[Ov]=Fv;[Lh]=Lh;constructor(t,n){this.incremental=t,this.bigint=n,this._hash=Ze(Pv)}_hash;[pe](){return this._hash}[de](t){return Nv(t)}pipe(){return Y(this,arguments)}}class ZN{boundaries;[Ov]=Fv;[Hh]=Hh;constructor(t){this.boundaries=t,this._hash=p(Ze(xv),ye(Q(this.boundaries)))}_hash;[pe](){return this._hash}[de](t){return Bv(t)&&ie(this.boundaries,t.boundaries)}pipe(){return Y(this,arguments)}}const eB=e=>new XN(e?.incremental??!1,e?.bigint??!1),tB=e=>new ZN(e),Nv=e=>re(e,Lh),nB=e=>re(e,WN),rB=e=>re(e,GN),Bv=e=>re(e,Hh),sB=e=>re(e,QN),oB="effect/MetricKey",Mv=Symbol.for(oB),iB={_Type:e=>e},cB=Dd(ie);class Jp{name;keyType;description;tags;[Mv]=iB;constructor(t,n,r,s=[]){this.name=t,this.keyType=n,this.description=r,this.tags=s,this._hash=p(Ze(this.name+this.description),ye(Q(this.keyType)),ye(Sc(this.tags)))}_hash;[pe](){return this._hash}[de](t){return aB(t)&&this.name===t.name&&ie(this.keyType,t.keyType)&&ie(this.description,t.description)&&cB(this.tags,t.tags)}pipe(){return Y(this,arguments)}}const aB=e=>re(e,Mv),uB=(e,t)=>new Jp(e,eB(t),Pu(t?.description)),lB=(e,t,n)=>new Jp(e,tB(t),Pu(n)),fB=d(2,(e,t)=>t.length===0?e:new Jp(e.name,e.keyType,e.description,ya(e.tags,t))),hB="effect/MetricState",Nc=Symbol.for(hB),Lv="effect/MetricState/Counter",Dh=Symbol.for(Lv),Hv="effect/MetricState/Frequency",Uh=Symbol.for(Hv),Dv="effect/MetricState/Gauge",Kh=Symbol.for(Dv),Uv="effect/MetricState/Histogram",jh=Symbol.for(Uv),Kv="effect/MetricState/Summary",zh=Symbol.for(Kv),Bc={_A:e=>e};class dB{count;[Nc]=Bc;[Dh]=Dh;constructor(t){this.count=t}[pe](){return p(Q(Lv),ye(Q(this.count)),Ye(this))}[de](t){return kB(t)&&this.count===t.count}pipe(){return Y(this,arguments)}}const pB=Dd(ie);class mB{occurrences;[Nc]=Bc;[Uh]=Uh;constructor(t){this.occurrences=t}_hash;[pe](){return p(Ze(Hv),ye(Sc(Ne(this.occurrences.entries()))),Ye(this))}[de](t){return EB(t)&&pB(Ne(this.occurrences.entries()),Ne(t.occurrences.entries()))}pipe(){return Y(this,arguments)}}class gB{value;[Nc]=Bc;[Kh]=Kh;constructor(t){this.value=t}[pe](){return p(Q(Dv),ye(Q(this.value)),Ye(this))}[de](t){return CB(t)&&this.value===t.value}pipe(){return Y(this,arguments)}}class yB{buckets;count;min;max;sum;[Nc]=Bc;[jh]=jh;constructor(t,n,r,s,o){this.buckets=t,this.count=n,this.min=r,this.max=s,this.sum=o}[pe](){return p(Q(Uv),ye(Q(this.buckets)),ye(Q(this.count)),ye(Q(this.min)),ye(Q(this.max)),ye(Q(this.sum)),Ye(this))}[de](t){return IB(t)&&ie(this.buckets,t.buckets)&&this.count===t.count&&this.min===t.min&&this.max===t.max&&this.sum===t.sum}pipe(){return Y(this,arguments)}}class SB{error;quantiles;count;min;max;sum;[Nc]=Bc;[zh]=zh;constructor(t,n,r,s,o,i){this.error=t,this.quantiles=n,this.count=r,this.min=s,this.max=o,this.sum=i}[pe](){return p(Q(Kv),ye(Q(this.error)),ye(Q(this.quantiles)),ye(Q(this.count)),ye(Q(this.min)),ye(Q(this.max)),ye(Q(this.sum)),Ye(this))}[de](t){return $B(t)&&this.error===t.error&&ie(this.quantiles,t.quantiles)&&this.count===t.count&&this.min===t.min&&this.max===t.max&&this.sum===t.sum}pipe(){return Y(this,arguments)}}const bB=e=>new dB(e),_B=e=>new mB(e),wB=e=>new gB(e),vB=e=>new yB(e.buckets,e.count,e.min,e.max,e.sum),TB=e=>new SB(e.error,e.quantiles,e.count,e.min,e.max,e.sum),kB=e=>re(e,Dh),EB=e=>re(e,Uh),CB=e=>re(e,Kh),IB=e=>re(e,jh),$B=e=>re(e,zh),AB="effect/MetricHook",RB=Symbol.for(AB),OB={_In:e=>e,_Out:e=>e},Mc=e=>({[RB]:OB,pipe(){return Y(this,arguments)},...e}),ay=BigInt(0),PB=e=>{let t=e.keyType.bigint?ay:0;const n=e.keyType.incremental?e.keyType.bigint?s=>s>=ay:s=>s>=0:s=>!0,r=s=>{n(s)&&(t=t+s)};return Mc({get:()=>bB(t),update:r,modify:r})},xB=e=>{const t=new Map;for(const r of e.keyType.preregisteredWords)t.set(r,0);const n=r=>{const s=t.get(r)??0;t.set(r,s+1)};return Mc({get:()=>_B(t),update:n,modify:n})},FB=(e,t)=>{let n=t;return Mc({get:()=>wB(n),update:r=>{n=r},modify:r=>{n=n+r}})},NB=e=>{const t=e.keyType.boundaries.values,n=t.length,r=new Uint32Array(n+1),s=new Float64Array(n);let o=0,i=0,c=Number.MAX_VALUE,a=Number.MIN_VALUE;p(t,qi(ko),as((f,h)=>{s[h]=f}));const u=f=>{let h=0,m=n;for(;h!==m;){const y=Math.floor(h+(m-h)/2),S=s[y];f<=S?m=y:h=y,m===h+1&&(f<=s[h]?m=h:h=m)}r[h]=r[h]+1,o=o+1,i=i+f,f<c&&(c=f),f>a&&(a=f)},l=()=>{const f=xu(n);let h=0;for(let m=0;m<n;m++){const y=s[m],S=r[m];h=h+S,f[m]=[y,h]}return f};return Mc({get:()=>vB({buckets:l(),count:o,min:c,max:a,sum:i}),update:u,modify:u})},BB=e=>{const{error:t,maxAge:n,maxSize:r,quantiles:s}=e.keyType,o=p(s,qi(ko)),i=xu(r);let c=0,a=0,u=0,l=0,f=0;const h=y=>{const S=[];let _=0;for(;_!==r-1;){const T=i[_];if(T!=null){const[C,v]=T,k=ae(y-C);IA(k,Co)&&CA(k,n)&&S.push(v)}_=_+1}return MB(t,o,qi(S,ko))},m=(y,S)=>{if(r>0){c=c+1;const _=c%r;i[_]=[S,y]}l=a===0?y:Math.min(l,y),f=a===0?y:Math.max(f,y),a=a+1,u=u+y};return Mc({get:()=>TB({error:t,quantiles:h(Date.now()),count:a,min:l,max:f,sum:u}),update:([y,S])=>m(y,S),modify:([y,S])=>m(y,S)})},MB=(e,t,n)=>{const r=n.length;if(!wt(t))return gs();const s=t[0],o=t.slice(1),i=uy(e,r,K(),0,s,n),c=bn(i);return o.forEach(a=>{c.push(uy(e,r,i.value,i.consumed,a,i.rest))}),as(c,a=>[a.quantile,a.value])},uy=(e,t,n,r,s,o)=>{let i=e,c=t,a=n,u=r,l=s,f=o,h=e,m=t,y=n,S=r,_=s,T=o;for(;;){if(!wt(f))return{quantile:l,value:K(),consumed:u,rest:[]};if(l===1)return{quantile:l,value:U(vb(f)),consumed:u+f.length,rest:[]};const C=Vt(f),v=II(f,O=>O===C),k=l*c,R=i/2*k,w=u+v[0].length,I=Math.abs(w-k);if(w<k-R){h=i,m=c,y=Ni(f),S=w,_=l,T=v[1],i=h,c=m,a=y,u=S,l=_,f=T;continue}if(w>k+R){const O=Ue(a)?U(C):a;return{quantile:l,value:O,consumed:u,rest:f}}switch(a._tag){case"None":{h=i,m=c,y=Ni(f),S=w,_=l,T=v[1],i=h,c=m,a=y,u=S,l=_,f=T;continue}case"Some":{const O=Math.abs(k-a.value);if(I<O){h=i,m=c,y=Ni(f),S=w,_=l,T=v[1],i=h,c=m,a=y,u=S,l=_,f=T;continue}return{quantile:l,value:U(a.value),consumed:u,rest:f}}}}throw new Error("BUG: MetricHook.resolveQuantiles - please report an issue at https://github.com/Effect-TS/effect/issues")},LB="effect/MetricPair",HB=Symbol.for(LB),DB={_Type:e=>e},UB=(e,t)=>({[HB]:DB,metricKey:e,metricState:t,pipe(){return Y(this,arguments)}}),KB="effect/MetricRegistry",ly=Symbol.for(KB);class jB{[ly]=ly;map=CP();snapshot(){const t=[];for(const[n,r]of this.map)t.push(UB(n,r.get()));return t}get(t){const n=p(this.map,Xr(t),Pn);if(n==null){if(Nv(t.keyType))return this.getCounter(t);if(rB(t.keyType))return this.getGauge(t);if(nB(t.keyType))return this.getFrequency(t);if(Bv(t.keyType))return this.getHistogram(t);if(sB(t.keyType))return this.getSummary(t);throw new Error("BUG: MetricRegistry.get - unknown MetricKeyType - please report an issue at https://github.com/Effect-TS/effect/issues")}else return n}getCounter(t){let n=p(this.map,Xr(t),Pn);if(n==null){const r=PB(t);p(this.map,mi(t))||p(this.map,gi(t,r)),n=r}return n}getFrequency(t){let n=p(this.map,Xr(t),Pn);if(n==null){const r=xB(t);p(this.map,mi(t))||p(this.map,gi(t,r)),n=r}return n}getGauge(t){let n=p(this.map,Xr(t),Pn);if(n==null){const r=FB(t,t.keyType.bigint?BigInt(0):0);p(this.map,mi(t))||p(this.map,gi(t,r)),n=r}return n}getHistogram(t){let n=p(this.map,Xr(t),Pn);if(n==null){const r=NB(t);p(this.map,mi(t))||p(this.map,gi(t,r)),n=r}return n}getSummary(t){let n=p(this.map,Xr(t),Pn);if(n==null){const r=BB(t);p(this.map,mi(t))||p(this.map,gi(t,r)),n=r}return n}}const zB=()=>new jB,VB="effect/Metric",qB=Symbol.for(VB),WB={_Type:e=>e,_In:e=>e,_Out:e=>e},fy=be(Symbol.for("effect/Metric/globalMetricRegistry"),()=>zB()),jv=function(e,t,n,r){const s=Object.assign(o=>cl(o,i=>QB(s,i)),{[qB]:WB,keyType:e,unsafeUpdate:t,unsafeValue:n,unsafeModify:r,register(){return this.unsafeValue([]),this},pipe(){return Y(this,arguments)}});return s},Tl=(e,t)=>zv(uB(e,t)),zv=e=>{let t;const n=new WeakMap,r=s=>{if(s.length===0)return t!==void 0||(t=fy.get(e)),t;let o=n.get(s);return o!==void 0||(o=fy.get(fB(e,s)),n.set(s,o)),o};return jv(e.keyType,(s,o)=>r(o).update(s),s=>r(s).get(),(s,o)=>r(o).modify(s))},JB=(e,t,n)=>zv(lB(e,t,n)),GB=d(3,(e,t,n)=>YB(e,[hF(t,n)])),YB=d(2,(e,t)=>jv(e.keyType,(n,r)=>e.unsafeUpdate(n,ya(t,r)),n=>e.unsafeValue(ya(t,n)),(n,r)=>e.unsafeModify(n,ya(t,r)))),QB=d(2,(e,t)=>fl(Th,n=>M(()=>e.unsafeUpdate(t,n))));({...Nd});const XB=d(2,(e,t)=>fl(Av,n=>M(()=>{if(n.has(e)){const r=n.get(e);r.state.completed||(r.state.completed=!0,ml(r.result,t))}}))),ZB="effect/Supervisor",kl=Symbol.for(ZB),Gp={_T:e=>e};class El{underlying;value0;[kl]=Gp;constructor(t,n){this.underlying=t,this.value0=n}get value(){return this.value0}onStart(t,n,r,s){this.underlying.onStart(t,n,r,s)}onEnd(t,n){this.underlying.onEnd(t,n)}onEffect(t,n){this.underlying.onEffect(t,n)}onSuspend(t){this.underlying.onSuspend(t)}onResume(t){this.underlying.onResume(t)}map(t){return new El(this,p(this.value,se(t)))}zip(t){return new Cl(this,t)}}class Cl{left;right;_tag="Zip";[kl]=Gp;constructor(t,n){this.left=t,this.right=n}get value(){return Tw(this.left.value,this.right.value)}onStart(t,n,r,s){this.left.onStart(t,n,r,s),this.right.onStart(t,n,r,s)}onEnd(t,n){this.left.onEnd(t,n),this.right.onEnd(t,n)}onEffect(t,n){this.left.onEffect(t,n),this.right.onEffect(t,n)}onSuspend(t){this.left.onSuspend(t),this.right.onSuspend(t)}onResume(t){this.left.onResume(t),this.right.onResume(t)}map(t){return new El(this,p(this.value,se(t)))}zip(t){return new Cl(this,t)}}const Vv=e=>re(e,kl)&&QS(e,"Zip");class eM{effect;[kl]=Gp;constructor(t){this.effect=t}get value(){return this.effect}onStart(t,n,r,s){}onEnd(t,n){}onEffect(t,n){}onSuspend(t){}onResume(t){}map(t){return new El(this,p(this.value,se(t)))}zip(t){return new Cl(this,t)}onRun(t,n){return t()}}const tM=e=>new eM(e),Il=be("effect/Supervisor/none",()=>tM(Ke)),nM=ti,qv="Empty",Wv="AddSupervisor",Jv="RemoveSupervisor",Gv="AndThen",Hi={_tag:qv},Ta=(e,t)=>({_tag:Gv,first:e,second:t}),rM=(e,t)=>sM(t,Be(e)),sM=(e,t)=>{let n=e,r=t;for(;Vn(r);){const s=Bn(r);switch(s._tag){case qv:{r=cr(r);break}case Wv:{n=n.zip(s.supervisor),r=cr(r);break}case Jv:{n=Vh(n,s.supervisor),r=cr(r);break}case Gv:{r=Bt(s.first)(Bt(s.second)(cr(r)));break}}}return n},Vh=(e,t)=>ie(e,t)?Il:Vv(e)?Vh(e.left,t).zip(Vh(e.right,t)):e,du=e=>ie(e,Il)?bs():Vv(e)?p(du(e.left),Xi(du(e.right))):ip(e),oM=(e,t)=>{if(ie(e,t))return Hi;const n=du(e),r=du(t),s=p(r,wg(n),Zi(Hi,(i,c)=>Ta(i,{_tag:Wv,supervisor:c}))),o=p(n,wg(r),Zi(Hi,(i,c)=>Ta(i,{_tag:Jv,supervisor:c})));return Ta(s,o)},iM=nM({empty:Hi,patch:rM,combine:Ta,diff:oM}),cM=Tl("effect_fiber_started",{incremental:!0}),hy=Tl("effect_fiber_active"),aM=Tl("effect_fiber_successes",{incremental:!0}),uM=Tl("effect_fiber_failures",{incremental:!0}),lM=GB(JB("effect_fiber_lifetimes",zN({start:.5,factor:2,count:35})),"time_unit","milliseconds"),Si="Continue",fM="Done",dy="Yield",hM={_E:e=>e,_A:e=>e},ea=e=>{throw new Error(`BUG: FiberRuntime - ${vo(e)} - please report an issue at https://github.com/Effect-TS/effect/issues`)},Zn=Symbol.for("effect/internal/fiberRuntime/YieldedOp"),er=be("effect/internal/fiberRuntime/yieldedOpChannel",()=>({currentOp:null})),bi={[Ha]:(e,t,n)=>Kt(()=>t.effect_instruction_i1(n)),OnStep:(e,t,n)=>et(et(n)),[Da]:(e,t,n)=>Kt(()=>t.effect_instruction_i2(n)),[xd]:(e,t,n)=>(e.patchRuntimeFlags(e.currentRuntimeFlags,t.patch),$r(e.currentRuntimeFlags)&&e.isInterrupted()?Oe(e.getInterruptedCause()):et(n)),[Ua]:(e,t,n)=>(Kt(()=>t.effect_instruction_i2(n)),Kt(()=>t.effect_instruction_i0())?(e.pushStack(t),Kt(()=>t.effect_instruction_i1())):Ke),[Fi]:(e,t,n)=>{for(;;){const r=Kt(()=>t.effect_instruction_i0.next(n));if(r.done)return et(r.value);const s=EC(r.value);if(hl(s)){if(s._tag==="Failure")return s}else return e.pushStack(t),s;n=s.value}}},dM={[jp]:(e,t,n,r)=>(e.processNewInterruptSignal(r.cause),$r(t)?Oe(r.cause):n),[Vp]:(e,t,n,r)=>{throw new Error("It is illegal to have multiple concurrent run loops in a single fiber")},[zp]:(e,t,n,r)=>(r.onFiber(e,yv(t)),n),[qp]:(e,t,n,r)=>P(ul(),()=>n)},pM=e=>ol(K1(e),t=>Kn(nO(t),([n,r])=>{const s=new Map,o=[];for(const c of r){o.push(fr(c));for(const a of c)s.set(a.request,a)}const i=o.flat();return Rc(MM(n.runAll(o),i,()=>i.forEach(c=>{c.listeners.interrupted=!0})),Av,s)},!1,!1)),mM=Fd();class Yv extends ai{[CN]=IN;[AN]=hM;_fiberRefs;_fiberId;_queue=new Array;_children=null;_observers=new Array;_running=!1;_stack=[];_asyncInterruptor=null;_asyncBlockingOn=null;_exitValue=null;_steps=[];_isYielding=!1;currentRuntimeFlags;currentOpCount=0;currentSupervisor;currentScheduler;currentTracer;currentSpan;currentContext;currentDefaultServices;constructor(t,n,r){if(super(),this.currentRuntimeFlags=r,this._fiberId=t,this._fiberRefs=n,Cg(r)){const s=this.getFiberRef(Th);cM.unsafeUpdate(1,s),hy.unsafeUpdate(1,s)}this.refreshRefCache()}commit(){return cc(this)}id(){return this._fiberId}resume(t){this.tell(Us(t))}get status(){return this.ask((t,n)=>n)}get runtimeFlags(){return this.ask((t,n)=>Sv(n)?t.currentRuntimeFlags:n.runtimeFlags)}scope(){return kN(this)}get children(){return this.ask(t=>Array.from(t.getChildren()))}getChildren(){return this._children===null&&(this._children=new Set),this._children}getInterruptedCause(){return this.getFiberRef(Xc)}fiberRefs(){return this.ask(t=>t.getFiberRefs())}ask(t){return le(()=>{const n=Pc(this._fiberId);return this.tell(va((r,s)=>{ml(n,M(()=>t(r,s)))})),Jn(n)})}tell(t){this._queue.push(t),this._running||(this._running=!0,this.drainQueueLaterOnExecutor())}get await(){return qn(t=>{const n=r=>t(L(r));return this.tell(va((r,s)=>{r._exitValue!==null?n(this._exitValue):r.addObserver(n)})),M(()=>this.tell(va((r,s)=>{r.removeObserver(n)})))},this.id())}get inheritAll(){return Ee((t,n)=>{const r=t.id(),s=t.getFiberRefs(),o=n.runtimeFlags,i=this.getFiberRefs(),c=Ux(s,r,i);t.setFiberRefs(c);const a=t.getFiberRef(yy),u=p(ls(o,a),$g(Os),$g(_h));return FO(u)})}get poll(){return M(()=>Pu(this._exitValue))}unsafePoll(){return this._exitValue}interruptAsFork(t){return M(()=>this.tell(mf(hn(t))))}unsafeInterruptAsFork(t){this.tell(mf(hn(t)))}addObserver(t){this._exitValue!==null?t(this._exitValue):this._observers.push(t)}removeObserver(t){this._observers=this._observers.filter(n=>n!==t)}getFiberRefs(){return this.setFiberRef(yy,this.currentRuntimeFlags),this._fiberRefs}unsafeDeleteFiberRef(t){this._fiberRefs=ev(this._fiberRefs,t)}getFiberRef(t){return this._fiberRefs.locals.has(t)?this._fiberRefs.locals.get(t)[0][1]:t.initial}setFiberRef(t,n){this._fiberRefs=Ah(this._fiberRefs,{fiberId:this._fiberId,fiberRef:t,value:n}),this.refreshRefCache()}refreshRefCache(){this.currentDefaultServices=this.getFiberRef(ru),this.currentTracer=this.currentDefaultServices.unsafeMap.get(Yw.key),this.currentSupervisor=this.getFiberRef(NM),this.currentScheduler=this.getFiberRef(Kp),this.currentContext=this.getFiberRef(qr),this.currentSpan=this.currentContext.unsafeMap.get(Qw.key)}setFiberRefs(t){this._fiberRefs=t,this.refreshRefCache()}addChild(t){this.getChildren().add(t)}removeChild(t){this.getChildren().delete(t)}transferChildren(t){const n=this._children;if(this._children=null,n!==null&&n.size>0)for(const r of n)r._exitValue===null&&t.add(this.currentRuntimeFlags,r)}drainQueueOnCurrentThread(){let t=!0;for(;t;){let n=Si;const r=globalThis[Jr];globalThis[Jr]=this;try{for(;n===Si;)n=this._queue.length===0?fM:this.evaluateMessageWhileSuspended(this._queue.splice(0,1)[0])}finally{this._running=!1,globalThis[Jr]=r}this._queue.length>0&&!this._running?(this._running=!0,n===dy?(this.drainQueueLaterOnExecutor(),t=!1):t=!0):t=!1}}drainQueueLaterOnExecutor(){this.currentScheduler.scheduleTask(this.run,this.getFiberRef(Oc))}drainQueueWhileRunning(t,n){let r=n;for(;this._queue.length>0;){const s=this._queue.splice(0,1)[0];r=dM[s._tag](this,t,r,s)}return r}isInterrupted(){return!cO(this.getFiberRef(Xc))}addInterruptedCause(t){const n=this.getFiberRef(Xc);this.setFiberRef(Xc,Ot(n,t))}processNewInterruptSignal(t){this.addInterruptedCause(t),this.sendInterruptSignalToAllChildren()}sendInterruptSignalToAllChildren(){if(this._children===null||this._children.size===0)return!1;let t=!1;for(const n of this._children)n.tell(mf(hn(this.id()))),t=!0;return t}interruptAllChildren(){if(this.sendInterruptSignalToAllChildren()){const t=this._children.values();this._children=null;let n=!1;return Sp({while:()=>!n,body:()=>{const s=t.next();return s.done?M(()=>{n=!0}):an(s.value.await)},step:()=>{}})}return null}reportExitValue(t){if(Cg(this.currentRuntimeFlags)){const n=this.getFiberRef(Th),r=this.id().startTimeMillis,s=Date.now();switch(lM.unsafeUpdate(s-r,n),hy.unsafeUpdate(-1,n),t._tag){case Ft:{aM.unsafeUpdate(1,n);break}case xt:{uM.unsafeUpdate(1,n);break}}}if(t._tag==="Failure"){const n=this.getFiberRef(nP);!el(t.cause)&&n._tag==="Some"&&this.log("Fiber terminated with an unhandled error",t.cause,n)}}setExitValue(t){this._exitValue=t,this.reportExitValue(t);for(let n=this._observers.length-1;n>=0;n--)this._observers[n](t);this._observers=[]}getLoggers(){return this.getFiberRef(_M)}log(t,n,r){const s=$e(r)?r.value:this.getFiberRef(QO),o=this.getFiberRef(gM);if(rF(o,s))return;const i=this.getFiberRef(XO),c=this.getFiberRef(YO),a=this.getLoggers(),u=this.getFiberRefs();if(cp(a)>0){const l=l_(this.getFiberRef(ru),bl),f=new Date(l.unsafeCurrentTimeMillis());PC(u,()=>{for(const h of a)h.log({fiberId:this.id(),logLevel:s,message:t,cause:n,context:u,spans:i,annotations:c,date:f})})}}evaluateMessageWhileSuspended(t){switch(t._tag){case qp:return dy;case jp:return this.processNewInterruptSignal(t.cause),this._asyncInterruptor!==null&&(this._asyncInterruptor(Oe(t.cause)),this._asyncInterruptor=null),Si;case Vp:return this._asyncInterruptor=null,this._asyncBlockingOn=null,this.evaluateEffect(t.effect),Si;case zp:return t.onFiber(this,this._exitValue!==null?jF:zF(this.currentRuntimeFlags,this._asyncBlockingOn)),Si;default:return ea(t)}}evaluateEffect(t){this.currentSupervisor.onResume(this);try{let n=$r(this.currentRuntimeFlags)&&this.isInterrupted()?Oe(this.getInterruptedCause()):t;for(;n!==null;){const r=n,s=this.runLoop(r);if(s===Zn){const o=er.currentOp;er.currentOp=null,o._op===ma?B1(this.currentRuntimeFlags)?(this.tell(_N()),this.tell(Us(kn)),n=null):n=kn:o._op===xi&&(n=null)}else{this.currentRuntimeFlags=p(this.currentRuntimeFlags,L1(_h));const o=this.interruptAllChildren();o!==null?n=P(o,()=>s):(this._queue.length===0?this.setExitValue(s):this.tell(Us(s)),n=null)}}}finally{this.currentSupervisor.onSuspend(this)}}start(t){if(this._running)this.tell(Us(t));else{this._running=!0;const n=globalThis[Jr];globalThis[Jr]=this;try{this.evaluateEffect(t)}finally{this._running=!1,globalThis[Jr]=n,this._queue.length>0&&this.drainQueueLaterOnExecutor()}}}startFork(t){this.tell(Us(t))}patchRuntimeFlags(t,n){const r=ho(t,n);return globalThis[Jr]=this,this.currentRuntimeFlags=r,r}initiateAsync(t,n){let r=!1;const s=o=>{r||(r=!0,this.tell(Us(o)))};$r(t)&&(this._asyncInterruptor=s);try{n(s)}catch(o){s(ft(rn(o)))}}pushStack(t){this._stack.push(t),t._op==="OnStep"&&this._steps.push({refs:this.getFiberRefs(),flags:this.currentRuntimeFlags})}popStack(){const t=this._stack.pop();if(t)return t._op==="OnStep"&&this._steps.pop(),t}getNextSuccessCont(){let t=this.popStack();for(;t;){if(t._op!==pa)return t;t=this.popStack()}}getNextFailCont(){let t=this.popStack();for(;t;){if(t._op!==Ha&&t._op!==Ua&&t._op!==Fi)return t;t=this.popStack()}}[FC](t){return M(()=>f_(this.currentContext,t))}Left(t){return st(t.left)}None(t){return st(new vp)}Right(t){return et(t.right)}Some(t){return et(t.value)}Micro(t){return Za(n=>{let r=n;const s=SN(fN(t,this.currentContext));return s.addObserver(o=>{if(o._tag==="Success")return r(et(o.value));switch(o.cause._tag){case"Interrupt":return r(Oe(hn(Ro)));case"Fail":return r(st(o.cause.error));case"Die":return r(Rr(o.cause.defect))}}),Za(o=>{r=i=>{o(Ke)},s.unsafeInterrupt()})})}[ob](t){const n=Kt(()=>t.effect_instruction_i0()),r=this.getNextSuccessCont();return r!==void 0?(r._op in bi||ea(r),bi[r._op](this,r,n)):(er.currentOp=et(n),Zn)}[Ft](t){const n=t,r=this.getNextSuccessCont();return r!==void 0?(r._op in bi||ea(r),bi[r._op](this,r,n.effect_instruction_i0)):(er.currentOp=n,Zn)}[xt](t){const n=t.effect_instruction_i0,r=this.getNextFailCont();if(r!==void 0)switch(r._op){case pa:case Da:return $r(this.currentRuntimeFlags)&&this.isInterrupted()?Oe(Ag(n)):Kt(()=>r.effect_instruction_i1(n));case"OnStep":return $r(this.currentRuntimeFlags)&&this.isInterrupted()?Oe(Ag(n)):et(Oe(n));case xd:return this.patchRuntimeFlags(this.currentRuntimeFlags,r.patch),$r(this.currentRuntimeFlags)&&this.isInterrupted()?Oe(Ot(n,this.getInterruptedCause())):Oe(n);default:ea(r)}else return er.currentOp=Oe(n),Zn}[ib](t){return Kt(()=>t.effect_instruction_i0(this,yv(this.currentRuntimeFlags)))}Blocked(t){const n=this.getFiberRefs(),r=this.currentRuntimeFlags;if(this._steps.length>0){const s=[],o=this._steps[this._steps.length-1];let i=this.popStack();for(;i&&i._op!=="OnStep";)s.push(i),i=this.popStack();this.setFiberRefs(o.refs),this.currentRuntimeFlags=o.flags;const c=oc(o.refs,n),a=ls(o.flags,r);return et(fw(t.effect_instruction_i0,Ee(u=>{for(;s.length>0;)u.pushStack(s.pop());return u.setFiberRefs(ic(u.id(),u.getFiberRefs())(c)),u.currentRuntimeFlags=ho(a)(u.currentRuntimeFlags),t.effect_instruction_i1})))}return Cn(s=>P(Xp($O(t.effect_instruction_i0)),()=>s(t.effect_instruction_i1)))}RunBlocked(t){return pM(t.effect_instruction_i0)}[Qo](t){const n=t.effect_instruction_i0,r=this.currentRuntimeFlags,s=ho(r,n);if($r(s)&&this.isInterrupted())return Oe(this.getInterruptedCause());if(this.patchRuntimeFlags(this.currentRuntimeFlags,n),t.effect_instruction_i1){const o=ls(s,r);return this.pushStack(new AO(o,t)),Kt(()=>t.effect_instruction_i1(r))}else return kn}[Ha](t){return this.pushStack(t),t.effect_instruction_i0}OnStep(t){return this.pushStack(t),t.effect_instruction_i0}[pa](t){return this.pushStack(t),t.effect_instruction_i0}[Da](t){return this.pushStack(t),t.effect_instruction_i0}[xi](t){return this._asyncBlockingOn=t.effect_instruction_i1,this.initiateAsync(this.currentRuntimeFlags,t.effect_instruction_i0),er.currentOp=t,Zn}[ma](t){return this._isYielding=!1,er.currentOp=t,Zn}[Ua](t){const n=t.effect_instruction_i0,r=t.effect_instruction_i1;return n()?(this.pushStack(t),r()):kn}[Fi](t){return bi[Fi](this,t,void 0)}[Ou](t){return Kt(()=>t.commit())}runLoop(t){let n=t;for(this.currentOpCount=0;;){if((this.currentRuntimeFlags&N1)!==0&&this.currentSupervisor.onEffect(this,n),this._queue.length>0&&(n=this.drainQueueWhileRunning(this.currentRuntimeFlags,n)),!this._isYielding){this.currentOpCount+=1;const r=this.currentScheduler.shouldYield(this);if(r!==!1){this._isYielding=!0,this.currentOpCount=0;const s=n;n=P(ul({priority:r}),()=>s)}}try{if(n=this.currentTracer.context(()=>{if(mM!==n[Bo]._V){const r=this.getFiberRef(rP);if(r._tag==="Some"){const s=n[Bo]._V;this.log(`Executing an Effect versioned ${s} with a Runtime of version ${Fd()}, you may want to dedupe the effect dependencies, you can use the language service plugin to detect this at compile time: https://github.com/Effect-TS/language-service`,Br,r)}}return this[n._op](n)},this),n===Zn){const r=er.currentOp;return r._op===ma||r._op===xi?Zn:(er.currentOp=null,r._op===Ft||r._op===xt?r:Oe(rn(r)))}}catch(r){n!==Zn&&!re(n,"_op")||!(n._op in this)?n=Sw(`Not a valid effect: ${vo(n)}`):iP(r)?n=Oe(Ot(rn(r),hn(Ro))):n=Rr(r)}}}run=()=>{this.drainQueueOnCurrentThread()}}const gM=be("effect/FiberRef/currentMinimumLogLevel",()=>Qt(sF("Info"))),yM=e=>Wp(t=>{const n=Vx(t.context,ru);l_(n,Gw).unsafe.log(e.log(t))}),SM=be(Symbol.for("effect/Logger/defaultLogger"),()=>yM(HN)),bM=be(Symbol.for("effect/Logger/tracerLogger"),()=>Wp(({annotations:e,cause:t,context:n,fiberId:r,logLevel:s,message:o})=>{const i=wc(sc(n,qr),Qw);if(i._tag==="None"||i.value._tag==="ExternalSpan")return;const c=f_(sc(n,ru),bl),a={};for(const[u,l]of e)a[u]=l;a["effect.fiberId"]=vR(r),a["effect.logLevel"]=s.label,t!==null&&t._tag!=="Empty"&&(a["effect.cause"]=oi(t,{renderErrorCause:!0})),i.value.event(vo(Array.isArray(o)&&o.length===1?o[0]:o),c.unsafeCurrentTimeNanos(),a)})),_M=be(Symbol.for("effect/FiberRef/currentLoggers"),()=>WO(ip(SM,bM))),wM=d(e=>vr(e[0]),(e,t)=>xs(cl(e,n=>vM(r=>t(n,r))))),vM=e=>Ee(t=>{const n=t.getFiberRefs(),r=M1(t.currentRuntimeFlags,Os);return P(Zv,s=>eu(s,o=>Ee(i=>{const c=i.getFiberRefs(),a=i.currentRuntimeFlags,u=oc(c,n),l=ls(a,r),f=oc(n,c);return i.setFiberRefs(ic(u,i.id(),n)),ac(BO(e(o),l),M(()=>{i.setFiberRefs(ic(f,i.id(),i.getFiberRefs()))}))})))}),TM=e=>{if(Array.isArray(e)||XS(e))return[e,K()];const t=Object.keys(e),n=t.length;return[t.map(r=>e[r]),U(r=>{const s={};for(let o=0;o<n;o++)s[t[o]]=r[o];return s})]},kM=(e,t,n)=>{const r=[];for(const s of e)r.push(Lo(s));return P(jo(r,ne,{concurrency:n?.concurrency,batching:n?.batching,concurrentFinalizers:n?.concurrentFinalizers}),s=>{const o=K(),i=s.length,c=new Array(i),a=new Array(i);let u=!1;for(let l=0;l<i;l++){const f=s[l];f._tag==="Left"?(c[l]=U(f.left),u=!0):(a[l]=f.right,c[l]=o)}return u?t._tag==="Some"?st(t.value(c)):st(c):n?.discard?Ke:t._tag==="Some"?L(t.value(a)):L(a)})},EM=(e,t,n)=>{const r=[];for(const s of e)r.push(Lo(s));return n?.discard?jo(r,ne,{concurrency:n?.concurrency,batching:n?.batching,discard:!0,concurrentFinalizers:n?.concurrentFinalizers}):se(jo(r,ne,{concurrency:n?.concurrency,batching:n?.batching,concurrentFinalizers:n?.concurrentFinalizers}),s=>t._tag==="Some"?t.value(s):s)},Yp=(e,t)=>{const[n,r]=TM(e);return t?.mode==="validate"?kM(n,r,t):t?.mode==="either"?EM(n,r,t):t?.discard!==!0&&r._tag==="Some"?se(jo(n,ne,t),r.value):jo(n,ne,t)},jo=d(e=>XS(e[0]),(e,t,n)=>Ee(r=>{const s=n?.batching===!0||n?.batching==="inherit"&&r.getFiberRef(tP);return n?.discard?cy(n.concurrency,()=>Ks(cu,n?.concurrentFinalizers)(o=>s?Kn(e,(i,c)=>o(t(i,c)),!0,!1,1):ol(e,(i,c)=>o(t(i,c)))),()=>Ks(xh,n?.concurrentFinalizers)(o=>Kn(e,(i,c)=>o(t(i,c)),s,!1)),o=>Ks(Fh(o),n?.concurrentFinalizers)(i=>Kn(e,(c,a)=>i(t(c,a)),s,!1,o))):cy(n?.concurrency,()=>Ks(cu,n?.concurrentFinalizers)(o=>s?qh(e,1,(i,c)=>o(t(i,c)),!0):ar(e,(i,c)=>o(t(i,c)))),()=>Ks(xh,n?.concurrentFinalizers)(o=>Qp(e,(i,c)=>o(t(i,c)),s)),o=>Ks(Fh(o),n?.concurrentFinalizers)(i=>qh(e,o,(c,a)=>i(t(c,a)),s)))})),Qp=(e,t,n)=>le(()=>{const r=Ne(e),s=new Array(r.length);return gt(Kn(r,(i,c)=>P(t(i,c),a=>M(()=>s[c]=a)),n,!1),L(s))}),Kn=(e,t,n,r,s)=>Cn(o=>xO(i=>Ee(c=>{let a=Array.from(e).reverse(),u=a.length;if(u===0)return Ke;let l=0,f=!1;const h=s?Math.min(a.length,s):a.length,m=new Set,y=new Array,S=()=>m.forEach(O=>{O.currentScheduler.scheduleTask(()=>{O.unsafeInterruptAsFork(c.id())},0)}),_=new Array,T=new Array,C=new Array,v=()=>{const O=y.filter(({exit:H})=>H._tag==="Failure").sort((H,x)=>H.index<x.index?-1:H.index===x.index?0:1).map(({exit:H})=>H);return O.length===0&&O.push(kn),O},k=(O,H=!1)=>{const x=xs(i(O)),E=CM(x,c,c.currentRuntimeFlags,vl);return c.currentScheduler.scheduleTask(()=>{H&&E.unsafeInterruptAsFork(c.id()),E.resume(x)},0),E},R=()=>{r||(u-=a.length,a=[]),f=!0,S()},w=n?RO:Un,I=k(qn(O=>{const H=(E,V)=>{E._op==="Blocked"?C.push(E):(y.push({index:V,exit:E}),E._op==="Failure"&&!f&&R())},x=()=>{if(a.length>0){const E=a.pop();let V=l++;const q=()=>{const ue=a.pop();return V=l++,P(ul(),()=>P(w(o(t(ue,V))),D))},D=ue=>a.length>0&&(H(ue,V),a.length>0)?q():L(ue),B=P(w(o(t(E,V))),D),F=k(B);_.push(F),m.add(F),f&&F.currentScheduler.scheduleTask(()=>{F.unsafeInterruptAsFork(c.id())},0),F.addObserver(ue=>{let je;if(ue._op==="Failure"?je=ue:je=ue.effect_instruction_i0,T.push(F),m.delete(F),H(je,V),y.length===u)O(L(qe(po(v(),{parallel:!0}),()=>kn)));else if(C.length+y.length===u){const Wt=v(),Hs=C.map(kr=>kr.effect_instruction_i0).reduce(Z_);O(L(fw(Hs,Kn([qe(po(Wt,{parallel:!0}),()=>kn),...C.map(kr=>kr.effect_instruction_i1)],kr=>kr,n,!0,s))))}else x()})}};for(let E=0;E<h;E++)x()}));return an(Ho($c(o(cc(I))),dl({onFailure:O=>{R();const H=C.length+1,x=Math.min(typeof s=="number"?s:C.length,C.length),E=Array.from(C);return qn(V=>{let q=0,D=0;const B=(ue,je)=>Wt=>{q++,q===H&&V(et(Oe(O))),E.length>0&&je&&F()},F=()=>{k(E.pop(),!0).addObserver(B(D,!0)),D++};I.addObserver(B(D,!1)),D++;for(let ue=0;ue<x;ue++)F()})},onSuccess:()=>ar(T,O=>O.inheritAll)})))}))),qh=(e,t,n,r)=>le(()=>{const s=Ne(e),o=new Array(s.length);return gt(Kn(s,(c,a)=>se(n(c,a),u=>o[a]=u),r,!1,t),L(o))}),Xp=e=>IM(e,vl),Qv=(e,t,n,r=null)=>{const s=pu(e,t,n,r);return s.resume(e),s},CM=(e,t,n,r=null)=>pu(e,t,n,r),pu=(e,t,n,r=null)=>{const s=B_(),o=t.getFiberRefs(),i=Kx(o,s),c=new Yv(s,i,n),a=sc(i,qr),u=c.currentSupervisor;return u.onStart(a,e,U(t),c),c.addObserver(f=>u.onEnd(f,c)),(r!==null?r:p(t.getFiberRef(kh),qe(()=>t.scope()))).add(n,c),c},IM=(e,t)=>Ee((n,r)=>L(Qv(e,n,r.runtimeFlags,t))),py=e=>Fs(t=>Fe(wc(t,Ns),{onNone:()=>e,onSome:n=>{switch(n.strategy._tag){case"Parallel":return e;case"Sequential":case"ParallelN":return P(sr(n,xh),r=>Hc(e,r))}}})),my=e=>t=>Fs(n=>Fe(wc(n,Ns),{onNone:()=>t,onSome:r=>r.strategy._tag==="ParallelN"&&r.strategy.parallelism===e?t:P(sr(r,Fh(e)),s=>Hc(t,s))})),Ks=(e,t)=>n=>Fs(r=>Fe(wc(r,Ns),{onNone:()=>n(ne),onSome:s=>{if(t===!0){const o=e._tag==="Parallel"?py:e._tag==="Sequential"?gy:my(e.parallelism);switch(s.strategy._tag){case"Parallel":return o(n(py));case"Sequential":return o(n(gy));case"ParallelN":return o(n(my(s.strategy.parallelism)))}}else return n(ne)}})),$M=e=>P(Ns,e),Xv=e=>P($l(),t=>Ho(e(t),n=>t.close(n))),gy=e=>Fs(t=>Fe(wc(t,Ns),{onNone:()=>e,onSome:n=>{switch(n.strategy._tag){case"Sequential":return e;case"Parallel":case"ParallelN":return P(sr(n,cu),r=>Hc(e,r))}}})),AM=d(e=>vr(e[1]),(e,t,n)=>Lc(e,t,(r,s)=>[r,s],n)),RM=d(e=>vr(e[1]),(e,t,n)=>n?.concurrent!==!0&&(n?.batching===void 0||n.batching===!1)?ll(e,t):Lc(e,t,(r,s)=>r,n)),OM=d(e=>vr(e[1]),(e,t,n)=>n?.concurrent!==!0&&(n?.batching===void 0||n.batching===!1)?gt(e,t):Lc(e,t,(r,s)=>s,n)),Lc=d(e=>vr(e[1]),(e,t,n,r)=>se(Yp([e,t],{concurrency:r?.concurrent?2:1,batching:r?.batching,concurrentFinalizers:r?.concurrentFinalizers}),([s,o])=>n(s,o))),Ns=$s("effect/Scope"),Zv=Ns,PM=(e,t)=>{e.state._tag==="Open"&&e.state.finalizers.set({},t)},xM={[Fg]:Fg,[Ng]:Ng,pipe(){return Y(this,arguments)},fork(e){return M(()=>{const t=eT(e);if(this.state._tag==="Closed")return t.state=this.state,t;const n={},r=s=>t.close(s);return this.state.finalizers.set(n,r),PM(t,s=>M(()=>{this.state._tag==="Open"&&this.state.finalizers.delete(n)})),t})},close(e){return le(()=>{if(this.state._tag==="Closed")return Ke;const t=Array.from(this.state.finalizers.values()).reverse();return this.state={_tag:"Closed",exit:e},t.length===0?Ke:xF(this.strategy)?p(ar(t,n=>Un(n(e))),P(n=>p(po(n),ao(hf),qe(()=>kn)))):FF(this.strategy)?p(Qp(t,n=>Un(n(e)),!1),P(n=>p(po(n,{parallel:!0}),ao(hf),qe(()=>kn)))):p(qh(t,this.strategy.parallelism,n=>Un(n(e)),!1),P(n=>p(po(n,{parallel:!0}),ao(hf),qe(()=>kn))))})},addFinalizer(e){return le(()=>this.state._tag==="Closed"?e(this.state.exit):(this.state.finalizers.set({},e),Ke))}},eT=(e=xr)=>{const t=Object.create(xM);return t.strategy=e,t.state={_tag:"Open",finalizers:new Map},t},$l=(e=xr)=>M(()=>eT(e)),Hc=d(2,(e,t)=>bP(e,Hu(Z$(Ns,t)))),FM=e=>ii(e,{differ:iM,fork:Hi}),yy=GO(H1),NM=FM(Il),tT=d(3,(e,t,n)=>BM(e,t,{onSelfWin:(r,s)=>P(r.await,o=>{switch(o._tag){case Ft:return P(r.inheritAll,()=>n.onSelfDone(o,s));case xt:return n.onSelfDone(o,s)}}),onOtherWin:(r,s)=>P(r.await,o=>{switch(o._tag){case Ft:return P(r.inheritAll,()=>n.onOtherDone(o,s));case xt:return n.onOtherDone(o,s)}})})),nT=d(2,(e,t)=>Ic(n=>tT(e,t,{onSelfDone:(r,s)=>Ih(r,{onFailure:o=>p(cc(s),ty(i=>Lr(o,i))),onSuccess:o=>p(s,nc(n),Yt(o))}),onOtherDone:(r,s)=>Ih(r,{onFailure:o=>p(cc(s),ty(i=>Lr(i,o))),onSuccess:o=>p(s,nc(n),Yt(o))})}))),BM=d(3,(e,t,n)=>Ee((r,s)=>{const o=s.runtimeFlags,i=As(!0),c=pu(e,r,o,n.selfScope),a=pu(t,r,o,n.otherScope);return qn(u=>{c.addObserver(()=>Sy(c,a,n.onSelfWin,i,u)),a.addObserver(()=>Sy(a,c,n.onOtherWin,i,u)),c.startFork(e),a.startFork(t)},_R(c.id(),a.id()))})),Sy=(e,t,n,r,s)=>{dR(!0,!1)(r)&&s(n(e,t))},ac=d(2,(e,t)=>Cn(n=>cn(n(e),{onFailure:r=>cn(t,{onFailure:s=>ft(Ot(r,s)),onSuccess:()=>ft(r)}),onSuccess:r=>Yt(t,r)}))),MM=(e,t,n)=>Ic(r=>P(P(Xp(mp(e)),s=>qn(o=>{const i=t.map(u=>u.listeners.count),c=()=>{i.every(u=>u===0)&&t.every(u=>u.result.state.current._tag==="Pending"?!0:!!(u.result.state.current._tag==="Done"&&hl(u.result.state.current.effect)&&u.result.state.current.effect._tag==="Failure"&&ow(u.result.state.current.effect.cause)))&&(a.forEach(u=>u()),n?.(),o(bp(s)))};s.addObserver(u=>{a.forEach(l=>l()),o(u)});const a=t.map((u,l)=>{const f=h=>{i[l]=h,c()};return u.listeners.addObserver(f),()=>u.listeners.removeObserver(f)});return c(),M(()=>{a.forEach(u=>u())})})),()=>le(()=>{const s=t.flatMap(o=>o.state.completed?[]:[o]);return ol(s,o=>XB(o.request,Fw(r)))}))),LM=Mr,Wh=rn,HM=hn,DM=iO,UM=sw,rT=ow,gf=el,KM=iw,jM=cw,zM=fO,sT=pO,VM=oi,qM="effect/ScheduleInterval",mu=Symbol.for(qM),oT={[mu]:mu,startMillis:0,endMillis:0},Zp=(e,t)=>e>t?oT:{[mu]:mu,startMillis:e,endMillis:t},WM=d(2,(e,t)=>JM(e,t)===e),JM=d(2,(e,t)=>e.endMillis<=t.startMillis?e:t.endMillis<=e.startMillis?t:e.startMillis<t.startMillis?e:t.startMillis<e.startMillis?t:e.endMillis<=t.endMillis?e:t),GM=e=>e.startMillis>=e.endMillis,YM=d(2,(e,t)=>{const n=Math.max(e.startMillis,t.startMillis),r=Math.min(e.endMillis,t.endMillis);return Zp(n,r)}),QM=e=>ae(e.endMillis-e.startMillis),XM=e=>Zp(e,Number.POSITIVE_INFINITY),by=Zp,iT=oT,ZM=WM,e2=GM,t2=YM,n2=QM,r2=XM,s2="effect/ScheduleIntervals",_y=Symbol.for(s2),cT=e=>({[_y]:_y,intervals:e}),o2=d(2,(e,t)=>i2(e.intervals,t.intervals,We())),i2=(e,t,n)=>{let r=e,s=t,o=n;for(;Vn(r)&&Vn(s);){const i=p(Bn(r),t2(Bn(s))),c=e2(i)?o:p(o,Bt(i));p(Bn(r),ZM(Bn(s)))?r=cr(r):s=cr(s),o=c}return cT(Sr(o))},Jh=e=>p(e.intervals,Yd,qe(()=>iT)).startMillis,c2=e=>p(e.intervals,Yd,qe(()=>iT)).endMillis,aT=d(2,(e,t)=>Jh(e)<Jh(t)),a2=e=>Vn(e.intervals),u2=d(2,(e,t)=>aT(e,t)?t:e),l2=cT,f2=o2,Gh=Jh,Yh=c2,h2=aT,d2=a2,p2=u2,em="Continue",uT="Done",m2=e=>({_tag:em,intervals:e}),g2=e=>({_tag:em,intervals:l2(Be(e))}),y2={_tag:uT},S2=e=>e._tag===em,b2=e=>e._tag===uT,lT=m2,fT=g2,Es=y2,wy=S2,Cs=b2,uc=Rw,_2=eu,Qh=Eh,w2=Hc,hT=sr,v2=$l;class T2{permits;waiters=new Set;taken=0;constructor(t){this.permits=t}get free(){return this.permits-this.taken}take=t=>gw(n=>{if(this.free<t){const r=()=>{this.free<t||(this.waiters.delete(r),this.taken+=t,n(L(t)))};return this.waiters.add(r),M(()=>{this.waiters.delete(r)})}return this.taken+=t,n(L(t))});updateTakenUnsafe(t,n){return this.taken=n(this.taken),this.waiters.size>0&&t.getFiberRef(Kp).scheduleTask(()=>{const r=this.waiters.values();let s=r.next();for(;s.done===!1&&this.free>0;)s.value(),s=r.next()},t.getFiberRef(Oc)),L(this.free)}updateTaken(t){return Ee(n=>this.updateTakenUnsafe(n,t))}resize=t=>an(Ee(n=>(this.permits=t,this.free<0?Ke:this.updateTakenUnsafe(n,r=>r))));release=t=>this.updateTaken(n=>n-t);releaseAll=this.updateTaken(t=>0);withPermits=t=>n=>Cn(r=>P(r(this.take(t)),s=>ac(r(n),this.release(s))));withPermitsIfAvailable=t=>n=>Cn(r=>le(()=>this.free<t?EF:(this.taken+=t,ac(r(pF(n)),this.release(t)))))}const dT=e=>new T2(e),k2=e=>M(()=>dT(e)),E2=d(2,(e,t)=>Ee((n,r)=>{const s=t,o=Qv(e,n,r.runtimeFlags,vl);if(s.state._tag==="Open"){const i=()=>Ic(a=>ie(a,o.id())?Ke:an(bp(o))),c={};s.state.finalizers.set(c,i),o.addObserver(()=>{s.state._tag!=="Closed"&&s.state.finalizers.delete(c)})}else o.unsafeInterruptAsFork(n.id());return L(o)})),C2=d(2,(e,t)=>p(Un(e),nT(Un(t)),n=>$c(n))),I2="effect/Ref/SynchronizedRef",pT=Symbol.for(I2),mT={_A:e=>e};class $2 extends ai{ref;withLock;[pT]=mT;[Op]=Pp;[Uo]=Uo;constructor(t,n){super(),this.ref=t,this.withLock=n,this.get=gn(this.ref)}get;commit(){return this.get}modify(t){return this.modifyEffect(n=>L(t(n)))}modifyEffect(t){return this.withLock(p(P(gn(this.ref),t),P(([n,r])=>Yt(mo(this.ref,r),n))))}}const A2=e=>M(()=>gT(e)),gT=e=>{const t=xp(e),n=dT(1);return new $2(t,n.withPermits(1))},R2=Symbol.for("effect/ManagedRuntime"),O2="Fresh",P2="MergeAll",yT=RN,vy=ON,xe=bp,x2=nc,Ty=cc,F2=PN,Dc=e=>function(){if(arguments.length===1){const t=arguments[0];return(n,...r)=>e(t,n,...r)}return e.apply(this,arguments)},tm=Dc((e,t,n)=>{const r=B_(),s=[[qr,[[r,e.context]]]];n?.scheduler&&s.push([Kp,[[r,n.scheduler]]]);let o=qx(e.fiberRefs,{entries:s,forkAs:r});n?.updateRefs&&(o=n.updateRefs(o,r));const i=new Yv(r,o,e.runtimeFlags);let c=t;n?.scope&&(c=P(hT(n.scope,xr),u=>gt(Rw(u,Ic(l=>ie(l,i.id())?Ke:nc(i,l))),Ho(t,l=>Qh(u,l)))));const a=i.currentSupervisor;return a!==Il&&(a.onStart(e.context,c,K(),i),i.addObserver(u=>a.onEnd(u,i))),vl.add(e.runtimeFlags,i),n?.immediate===!1?i.resume(c):i.start(c),i}),N2=Dc((e,t)=>{const n=H2(e)(t);if(n._tag==="Failure")throw ST(n.effect_instruction_i0);return n.effect_instruction_i0});class B2 extends Error{fiber;_tag="AsyncFiberException";constructor(t){super(`Fiber #${t.id().id} cannot be resolved synchronously. This is caused by using runSync on an effect that performs async work`),this.fiber=t,this.name=this._tag,this.stack=this.message}}const M2=e=>{const t=Error.stackTraceLimit;Error.stackTraceLimit=0;const n=new B2(e);return Error.stackTraceLimit=t,n},yf=Symbol.for("effect/Runtime/FiberFailure"),ta=Symbol.for("effect/Runtime/FiberFailure/Cause");class L2 extends Error{[yf];[ta];constructor(t){const n=uw(t)[0];super(n?.message||"An error has occurred"),this[yf]=yf,this[ta]=t,this.name=n?`(FiberFailure) ${n.name}`:"FiberFailure",n?.stack&&(this.stack=n.stack)}toJSON(){return{_id:"FiberFailure",cause:this[ta].toJSON()}}toString(){return"(FiberFailure) "+oi(this[ta],{renderErrorCause:!0})}[Me](){return this.toString()}}const ST=e=>{const t=Error.stackTraceLimit;Error.stackTraceLimit=0;const n=new L2(e);return Error.stackTraceLimit=t,n},bT=e=>{const t=e;switch(t._op){case"Failure":case"Success":return t;case"Left":return Ch(t.left);case"Right":return et(t.right);case"Some":return et(t.value);case"None":return Ch(new vp)}},H2=Dc((e,t)=>{const n=bT(t);if(n)return n;const r=new $v,s=tm(e)(t,{scheduler:r});r.flush();const o=s.unsafePoll();return o||xw(pp(M2(s),Cp(s)))}),D2=Dc((e,t,n)=>U2(e,t,n).then(r=>{switch(r._tag){case Ft:return r.effect_instruction_i0;case xt:throw ST(r.effect_instruction_i0)}})),U2=Dc((e,t,n)=>new Promise(r=>{const s=bT(t);s&&r(s);const o=tm(e)(t);o.addObserver(i=>{r(i)}),n?.signal!==void 0&&(n.signal.aborted?o.unsafeInterruptAsFork(o.id()):n.signal.addEventListener("abort",()=>{o.unsafeInterruptAsFork(o.id())},{once:!0}))}));class _T{context;runtimeFlags;fiberRefs;constructor(t,n,r){this.context=t,this.runtimeFlags=n,this.fiberRefs=r}pipe(){return Y(this,arguments)}}const K2=e=>new _T(e.context,e.runtimeFlags,e.fiberRefs),j2=()=>Ee((e,t)=>L(new _T(e.getFiberRef(qr),t.runtimeFlags,e.getFiberRefs()))),z2=Q_(Os,G_,J_),lc=K2({context:Jd(),runtimeFlags:z2,fiberRefs:Wx()}),V2=tm(lc),q2=D2(lc),W2=N2(lc),J2=d(2,(e,t)=>e.modifyEffect(t)),G2="effect/Layer",wT=Symbol.for(G2),Y2={_RIn:e=>e,_E:e=>e,_ROut:e=>e},Q2={[wT]:Y2,pipe(){return Y(this,arguments)}},X2="effect/Layer/MemoMap",Sf=Symbol.for(X2),Z2=Du()("effect/Layer/CurrentMemoMap",{defaultValue:()=>rL()}),eL=e=>re(e,wT),tL=e=>e._op_layer===O2;class vT{ref;[Sf];constructor(t){this.ref=t,this[Sf]=Sf}getOrElseMemoize(t,n){return p(J2(this.ref,r=>{const s=r.get(t);if(s!==void 0){const[o,i]=s,c=p(o,P(([a,u])=>p(wF(a),Yt(u))),Ho(dl({onFailure:()=>Ke,onSuccess:()=>eu(n,i)})));return L([c,r])}return p(su(0),P(o=>p(xc(),P(i=>p(su(()=>Ke),se(c=>{const a=Cn(l=>p($l(),P(f=>p(l(P(kT(t,f,!0),h=>gF(h(this)))),Un,P(h=>{switch(h._tag){case xt:return p(Nw(i,h.effect_instruction_i0),gt(Eh(f,h)),gt(ft(h.effect_instruction_i0)));case Ft:return p(mo(c,m=>p(Eh(f,m),al(nv(o,y=>[y===1,y-1])),an)),gt(ou(o,m=>m+1)),gt(eu(n,m=>p(M(()=>r.delete(t)),gt(gn(c)),P(y=>y(m))))),gt(Fc(i,h.effect_instruction_i0)),Yt(h.effect_instruction_i0[1]))}}))))),u=[p(Jn(i),Ho(Ih({onFailure:()=>Ke,onSuccess:()=>ou(o,l=>l+1)}))),l=>p(gn(c),P(f=>f(l)))];return[a,tL(t)?r:r.set(t,u)]}))))))}),$c)}}const nL=le(()=>se(A2(new Map),e=>new vT(e))),rL=()=>new vT(gT(new Map)),TT=d(2,(e,t)=>P(nL,n=>sL(e,n,t))),sL=d(3,(e,t,n)=>P(kT(e,n),r=>TF(r(t),Z2,t))),kT=(e,t,n=!1)=>{const r=e;switch(r._op_layer){case"Locally":return M(()=>s=>r.f(s.getOrElseMemoize(r.self,t)));case"ExtendScope":return M(()=>s=>$M(o=>s.getOrElseMemoize(r.layer,o)));case"Fold":return M(()=>s=>p(s.getOrElseMemoize(r.layer,t),cn({onFailure:o=>s.getOrElseMemoize(r.failureK(o),t),onSuccess:o=>s.getOrElseMemoize(r.successK(o),t)})));case"Fresh":return M(()=>s=>p(r.layer,TT(t)));case"FromEffect":return M(n?()=>s=>r.effect:()=>s=>s.getOrElseMemoize(e,t));case"Provide":return M(()=>s=>p(s.getOrElseMemoize(r.first,t),P(o=>p(s.getOrElseMemoize(r.second,t),gl(o)))));case"Scoped":return M(n?()=>s=>Hc(r.effect,t):()=>s=>s.getOrElseMemoize(e,t));case"Suspend":return M(()=>s=>s.getOrElseMemoize(r.evaluate(),t));case"ProvideMerge":return M(()=>s=>p(s.getOrElseMemoize(r.first,t),kw(s.getOrElseMemoize(r.second,t),r.zipK)));case"ZipWith":return vw(function*(){const s=yield*sr(t,Ph),o=yield*sr(s,xr),i=yield*sr(s,xr);return c=>p(c.getOrElseMemoize(r.first,o),Lc(c.getOrElseMemoize(r.second,i),r.zipK,{concurrent:!0}))});case"MergeAll":{const s=r.layers;return se(sr(t,Ph),o=>i=>{const c=new Array(s.length);return se(Kn(s,NO(function*(a,u){const l=yield*sr(o,xr),f=yield*i.getOrElseMemoize(a,l);c[u]=f}),!1,!1),()=>eA(...c))})}}},oL=(...e)=>{const t=Object.create(Q2);return t._op_layer=P2,t.layers=e,t},ky=d(2,(e,t)=>Xv(n=>P(TT(t,n),r=>Ep(e,r)))),Ey=d(2,(e,t)=>{const n=oc(lc.fiberRefs,t.fiberRefs),r=ls(lc.runtimeFlags,t.runtimeFlags);return Cn(s=>Ee(o=>{const i=o.getFiberRef(qr),c=o.getFiberRefs(),a=ic(o.id(),c)(n),u=o.currentRuntimeFlags,l=ho(r)(u),f=oc(a,c),h=ls(l,u);return o.setFiberRefs(a),o.currentRuntimeFlags=l,ac(Ep(s(e),Hu(i,t.context)),Ee(m=>(m.setFiberRefs(ic(m.id(),m.getFiberRefs())(f)),m.currentRuntimeFlags=ho(h)(m.currentRuntimeFlags),Ke)))}))}),iL=d(2,(e,t)=>Array.isArray(t)?ky(e,oL(...t)):eL(t)?ky(e,t):X$(t)?Ep(e,t):R2 in t?P(t.runtimeEffect,n=>Ey(e,n)):Ey(e,t)),cL=Qu,aL=(function(){const e=Symbol.for("effect/Data/Error/plainArgs");return{BaseEffectError:class extends wp{constructor(n){super(n?.message,n?.cause?{cause:n.cause}:void 0),n&&(Object.assign(this,n),Object.defineProperty(this,e,{value:n,enumerable:!1}))}toJSON(){return{...this[e],...this}}}}.BaseEffectError})(),uL=e=>{const t={BaseEffectError:class extends aL{_tag=e}};return t.BaseEffectError.prototype.name=e,t.BaseEffectError},lL="effect/Schedule",ET=Symbol.for(lL),CT=e=>re(e,ET),fL="effect/ScheduleDriver",hL=Symbol.for(fL),Xh={start:0,now:0,input:void 0,output:void 0,elapsed:Co,elapsedSincePrevious:Co,recurrence:0},gu=Du()("effect/Schedule/CurrentIterationMetadata",{defaultValue:()=>Xh}),dL={_Out:e=>e,_In:e=>e,_R:e=>e},pL={_Out:e=>e,_In:e=>e,_R:e=>e};class mL{initial;step;[ET]=dL;constructor(t,n){this.initial=t,this.step=n}pipe(){return Y(this,arguments)}}const Cy=(e,t,n,r)=>ou(e,s=>s.recurrence===0?{now:t,input:n,output:r,recurrence:s.recurrence+1,elapsed:Co,elapsedSincePrevious:Co,start:t}:{now:t,input:n,output:r,recurrence:s.recurrence+1,elapsed:ae(t-s.start),elapsedSincePrevious:ae(t-s.now),start:s.start});class gL{schedule;ref;[hL]=pL;constructor(t,n){this.schedule=t,this.ref=n}get state(){return se(gn(this.ref),t=>t[1])}get last(){return P(gn(this.ref),([t,n])=>{switch(t._tag){case"None":return rl(()=>new vp);case"Some":return L(t.value)}})}iterationMeta=xp(Xh);get reset(){return mo(this.ref,[K(),this.schedule.initial]).pipe(ll(mo(this.iterationMeta,Xh)))}next(t){return p(se(gn(this.ref),n=>n[1]),P(n=>p(Mx,P(r=>p(le(()=>this.schedule.step(r,t,n)),P(([s,o,i])=>{const c=mo(this.ref,[U(o),s]);if(Cs(i))return c.pipe(gt(st(K())));const a=Gh(i.intervals)-r;if(a<=0)return c.pipe(gt(Cy(this.iterationMeta,r,t,o)),Yt(o));const u=ae(a);return p(c,gt(Cy(this.iterationMeta,r,t,o)),gt(pv(u)),Yt(o))}))))))}}const Bs=(e,t)=>new mL(e,t),IT=d(2,(e,t)=>yL(e,n=>M(()=>t(n)))),yL=d(2,(e,t)=>TL(e,(n,r)=>se(t(n),s=>EA(r,Jt(s))))),$T=d(2,(e,t)=>nm(e,(n,r)=>M(()=>t(n,r)))),nm=d(2,(e,t)=>Bs(e.initial,(n,r,s)=>P(e.step(n,r,s),([o,i,c])=>Cs(c)?L([o,i,Es]):se(t(r,i),a=>a?[o,i,c]:[o,i,Es])))),SL=d(2,(e,t)=>Bs([e.initial,t.initial],(n,r,s)=>P(e.step(n,r,s[0]),([o,i,c])=>se(t.step(n,i,s[1]),([a,u,l])=>Cs(c)?[[o,a],u,Es]:Cs(l)?[[o,a],u,Es]:[[o,a],u,lT(p(c.intervals,p2(l.intervals)))])))),bL=e=>IT(e,t=>t),rm=e=>p(su([K(),e.initial]),se(t=>new gL(e,t))),_L=(e,t=2)=>{const n=Jt(e);return bL(RT(Uc,r=>kA(n,Math.pow(t,r))))},AT=d(2,(e,t)=>wL(e,t,f2)),wL=d(3,(e,t,n)=>Bs([e.initial,t.initial],(r,s,o)=>p(kw(e.step(r,s,o[0]),t.step(r,s,o[1]),(i,c)=>[i,c]),P(([[i,c,a],[u,l,f]])=>wy(a)&&wy(f)?Zh(e,t,s,i,c,a.intervals,u,l,f.intervals,n):L([[i,u],[c,l],Es]))))),Zh=(e,t,n,r,s,o,i,c,a,u)=>{const l=u(o,a);return d2(l)?L([[r,i],[s,c],lT(l)]):p(o,h2(a))?P(e.step(Yh(o),n,r),([f,h,m])=>Cs(m)?L([[f,i],[h,c],Es]):Zh(e,t,n,f,h,m.intervals,i,c,a,u)):P(t.step(Yh(a),n,i),([f,h,m])=>Cs(m)?L([[r,f],[s,h],Es]):Zh(e,t,n,r,s,o,f,h,m.intervals,u))},RT=d(2,(e,t)=>vL(e,n=>M(()=>t(n)))),vL=d(2,(e,t)=>Bs(e.initial,(n,r,s)=>P(e.step(n,r,s),([o,i,c])=>se(t(i),a=>[o,a,c])))),TL=d(2,(e,t)=>Bs(e.initial,(n,r,s)=>P(e.step(n,r,s),([o,i,c])=>{if(Cs(c))return L([o,i,c]);const a=c.intervals,u=n2(by(n,Gh(a)));return se(t(i,u),l=>{const f=Jt(l),h=Gh(a),m=n+Gi(f),y=m-h,S=Math.max(0,Yh(a)+y),_=by(m,S);return[o,i,fT(_)]})}))),kL=e=>Bs(e.initial,(t,n,r)=>p(e.step(t,n,r),se(([s,o,i])=>[s,n,i]))),sm=e=>$L(Uc,t=>t<e),EL=e=>IT(Uc,()=>e),CL=(e,t)=>Bs(e,(n,r,s)=>M(()=>[t(s),s,fT(r2(n))])),OT=d(2,(e,t)=>nm(e,(n,r)=>_F(t(n)))),IL=d(2,(e,t)=>$T(e,(n,r)=>t(n))),PT=d(2,(e,t)=>nm(e,(n,r)=>t(n))),$L=d(2,(e,t)=>$T(e,(n,r)=>t(r))),ka=Symbol.for("effect/Schedule/ScheduleDefect");class AL{error;[ka];constructor(t){this.error=t,this[ka]=ka}}const RL=e=>re(e,ka),yu=e=>Mo(e,t=>Rr(new AL(t))),OL=e=>Fe(hp(e,t=>sw(t)&&RL(t.defect)?U(t.defect):K()),{onNone:()=>e,onSome:t=>Mr(t.error)}),xT=e=>yw(e,t=>ft(OL(t))),Iy=d(2,(e,t)=>xL(e,t,(n,r)=>st(n))),PL=d(2,(e,t)=>{if(CT(t))return Iy(e,t);const n=t.schedule??kL(Uc),r=t.while?PT(n,i=>{const c=t.while(i);return typeof c=="boolean"?L(c):yu(c)}):n,s=t.until?OT(r,i=>{const c=t.until(i);return typeof c=="boolean"?L(c):yu(c)}):r,o=t.times?AT(s,sm(t.times)).pipe(RT(i=>i[0])):s;return xT(Iy(e,o))}),xL=d(3,(e,t,n)=>P(rm(t),r=>Wn(e,{onFailure:s=>n(s,K()),onSuccess:s=>FT(iu(e,gu,gn(r.iterationMeta)),r,(o,i)=>iu(n(o,i),gu,gn(r.iterationMeta)),s)}))),FT=(e,t,n,r)=>Wn(t.next(r),{onFailure:()=>yp(t.last),onSuccess:s=>Wn(e,{onFailure:o=>n(o,U(s)),onSuccess:o=>FT(e,t,n,o)})}),$y=d(2,(e,t)=>BL(e,t,(n,r)=>st(n))),FL=d(2,(e,t)=>CT(t)?$y(e,t):xT($y(e,NL(t)))),NL=e=>{const t=e.schedule??Uc,n=e.while?PT(t,s=>{const o=e.while(s);return typeof o=="boolean"?L(o):yu(o)}):t,r=e.until?OT(n,s=>{const o=e.until(s);return typeof o=="boolean"?L(o):yu(o)}):n;return e.times!==void 0?AT(r,sm(e.times)):r},BL=d(3,(e,t,n)=>P(rm(t),r=>NT(iu(e,gu,gn(r.iterationMeta)),r,(s,o)=>iu(n(s,o),gu,gn(r.iterationMeta))))),NT=(e,t,n)=>Mo(e,r=>Wn(t.next(r),{onFailure:()=>p(t.last,yp,P(s=>n(r,s))),onSuccess:()=>NT(e,t,n)})),Uc=CL(0,e=>e+1),ui=vr,ze=Yp,En=jo,ML=kF,Ay=Ee,$t=st,mr=ft,LL=Sw,$=vw,W=vF,z=L,tt=le,Qe=M,ge=Ke,Ve=Mo,Dr=yw,bf=mF,HL=bF,na=FL,Ms=$F,js=Ct,tn=mp,Ci=xs,om=Cn,hs=Yt,Ae=an,j=se,DL=gp,Al=il,UL=pw,ro=ac,KL=Zv,ed=Xv,jL=Ic,it=Xp,jn=E2,zL=pv,td=iL,zs=Lo,St=Un,BT=OO,VL=RF,X=P,es=$c,_f=nT,qL=C2,MT=tT,Ie=cl,im=IF,WL=yF,Ry=PL,LT=dv,Su=_w,Fn=cn,JL=Wn,GL=yp,YL=j2,cm=k2,ss=V2,J=q2,QL=W2,nd=AM,Rl=RM,Ce=OM,Ol=Lc,XL="effect/QueueEnqueue",HT=Symbol.for(XL),ZL="effect/QueueDequeue",am=Symbol.for(ZL),eH="effect/QueueStrategy",DT=Symbol.for(eH),tH="effect/BackingQueue",nH=Symbol.for(tH),UT={_A:e=>e},rH={_A:e=>e},KT={_In:e=>e},um={_Out:e=>e};class sH extends ai{queue;takers;shutdownHook;shutdownFlag;strategy;[HT]=KT;[am]=um;constructor(t,n,r,s,o){super(),this.queue=t,this.takers=n,this.shutdownHook=r,this.shutdownFlag=s,this.strategy=o}pipe(){return Y(this,arguments)}commit(){return this.take}capacity(){return this.queue.capacity()}get size(){return le(()=>Mo(this.unsafeSize(),()=>Ct))}unsafeSize(){return _e(this.shutdownFlag)?K():U(this.queue.length()-Ap(this.takers)+this.strategy.surplusSize())}get isEmpty(){return se(this.size,t=>t<=0)}get isFull(){return se(this.size,t=>t>=this.capacity())}get shutdown(){return xs(Ee(t=>(p(this.shutdownFlag,Rs(!0)),p(Kn(yo(this.takers),n=>kp(n,t.id()),!1,!1),gt(this.strategy.shutdown),al(Fc(this.shutdownHook,void 0)),an))))}get isShutdown(){return M(()=>_e(this.shutdownFlag))}get awaitShutdown(){return Jn(this.shutdownHook)}isActive(){return!_e(this.shutdownFlag)}unsafeOffer(t){if(_e(this.shutdownFlag))return!1;let n;if(this.queue.length()===0){const s=p(this.takers,pr(ot));s!==ot?(ds(s,t),n=!0):n=!1}else n=!1;if(n)return!0;const r=this.queue.offer(t);return so(this.strategy,this.queue,this.takers),r}offer(t){return le(()=>{if(_e(this.shutdownFlag))return Ct;let n;if(this.queue.length()===0){const s=p(this.takers,pr(ot));s!==ot?(ds(s,t),n=!0):n=!1}else n=!1;if(n)return L(!0);const r=this.queue.offer(t);return so(this.strategy,this.queue,this.takers),r?L(!0):this.strategy.handleSurplus([t],this.queue,this.takers,this.shutdownFlag)})}offerAll(t){return le(()=>{if(_e(this.shutdownFlag))return Ct;const n=Ne(t),r=this.queue.length()===0?Ne(bH(this.takers,n.length)):gs,[s,o]=p(n,Tb(r.length));for(let c=0;c<r.length;c++){const a=r[c],u=s[c];ds(a,u)}if(o.length===0)return L(!0);const i=this.queue.offerAll(o);return so(this.strategy,this.queue,this.takers),Ku(i)?L(!0):this.strategy.handleSurplus(i,this.queue,this.takers,this.shutdownFlag)})}get take(){return Ee(t=>{if(_e(this.shutdownFlag))return Ct;const n=this.queue.poll(ot);if(n!==ot)return this.strategy.unsafeOnQueueEmptySpace(this.queue,this.takers),L(n);{const r=Pc(t.id());return p(le(()=>(p(this.takers,Do(r)),so(this.strategy,this.queue,this.takers),_e(this.shutdownFlag)?Ct:Jn(r))),Ac(()=>M(()=>_H(this.takers,r))))}})}get takeAll(){return le(()=>_e(this.shutdownFlag)?Ct:M(()=>{const t=this.queue.pollUpTo(Number.POSITIVE_INFINITY);return this.strategy.unsafeOnQueueEmptySpace(this.queue,this.takers),Wi(t)}))}takeUpTo(t){return le(()=>_e(this.shutdownFlag)?Ct:M(()=>{const n=this.queue.pollUpTo(t);return this.strategy.unsafeOnQueueEmptySpace(this.queue,this.takers),Wi(n)}))}takeBetween(t,n){return le(()=>jT(this,t,n,We()))}}const jT=(e,t,n,r)=>n<t?L(r):p(dH(e,n),P(s=>{const o=t-s.length;return o===1?p(rd(e),se(i=>p(r,bt(s),Eo(i)))):o>1?p(rd(e),P(i=>jT(e,o-1,n-s.length-1,p(r,bt(s),Eo(i))))):L(p(r,bt(s)))})),oH=e=>p(M(()=>BP(e)),P(t=>zT(VT(t),mH()))),iH=()=>p(M(()=>yl()),P(e=>zT(VT(e),gH()))),cH=(e,t,n,r,s)=>new sH(e,t,n,r,s),zT=(e,t)=>p(xc(),se(n=>cH(e,yl(),n,As(!1),t)));class aH{mutable;[nH]=rH;constructor(t){this.mutable=t}poll(t){return pr(this.mutable,t)}pollUpTo(t){return Sl(this.mutable,t)}offerAll(t){return Rp(this.mutable,t)}offer(t){return Do(this.mutable,t)}capacity(){return MP(this.mutable)}length(){return Ap(this.mutable)}}const VT=e=>new aH(e),uH=e=>e.size,lH=e=>e.isShutdown,fH=e=>e.shutdown,hH=d(2,(e,t)=>e.offer(t)),rd=e=>e.take,dH=d(2,(e,t)=>e.takeUpTo(t)),pH=d(3,(e,t,n)=>e.takeBetween(t,n)),mH=()=>new yH,gH=()=>new SH;class yH{[DT]=UT;putters=yl();surplusSize(){return Ap(this.putters)}onCompleteTakersWithEmptyQueue(t){for(;!fs(this.putters)&&!fs(t);){const n=pr(t,void 0),r=pr(this.putters,void 0);r[2]&&ds(r[1],!0),ds(n,r[0])}}get shutdown(){return p(sl,P(t=>p(M(()=>yo(this.putters)),P(n=>Kn(n,([r,s,o])=>o?p(kp(s,t),an):Ke,!1,!1)))))}handleSurplus(t,n,r,s){return Ee(o=>{const i=Pc(o.id());return p(le(()=>(this.unsafeOffer(t,i),this.unsafeOnQueueEmptySpace(n,r),so(this,n,r),_e(s)?Ct:Jn(i))),Ac(()=>M(()=>this.unsafeRemove(i))))})}unsafeOnQueueEmptySpace(t,n){let r=!0;for(;r&&(t.capacity()===Number.POSITIVE_INFINITY||t.length()<t.capacity());){const s=p(this.putters,pr(ot));if(s===ot)r=!1;else{const o=t.offer(s[0]);o&&s[2]?ds(s[1],!0):o||bu(this.putters,p(yo(this.putters),Bt(s))),so(this,t,n)}}}unsafeOffer(t,n){const r=Ne(t);for(let s=0;s<r.length;s++){const o=r[s];s===r.length-1?p(this.putters,Do([o,n,!0])):p(this.putters,Do([o,n,!1]))}}unsafeRemove(t){bu(this.putters,p(yo(this.putters),Uu(([,n])=>n!==t)))}}let SH=class{[DT]=UT;surplusSize(){return 0}get shutdown(){return Ke}onCompleteTakersWithEmptyQueue(){}handleSurplus(t,n,r,s){return L(!1)}unsafeOnQueueEmptySpace(t,n){}};const ds=(e,t)=>ml(e,L(t)),bu=(e,t)=>p(e,Rp(t)),yo=e=>p(e,Sl(Number.POSITIVE_INFINITY)),bH=(e,t)=>p(e,Sl(t)),_H=(e,t)=>{bu(e,p(yo(e),Uu(n=>t!==n)))},so=(e,t,n)=>{let r=!0;for(;r&&t.length()!==0;){const s=p(n,pr(ot));if(s!==ot){const o=t.poll(ot);o!==ot?(ds(s,o),e.unsafeOnQueueEmptySpace(t,n)):bu(n,p(yo(n),Bt(s))),r=!0}else r=!1}r&&t.length()===0&&!fs(n)&&e.onCompleteTakersWithEmptyQueue(n)},xn=Symbol.for("effect/PubSub/AbsentValue"),qT=(e,t)=>n=>{n.has(e)||n.set(e,new Set),n.get(e).add(t)},wH=(e,t)=>n=>{if(!n.has(e))return;const r=n.get(e);r.delete(t),r.size===0&&n.delete(e)},vH=e=>le(()=>{const t=CH(e);return xH(t,new DH)}),TH=e=>e.shutdown,kH=d(2,(e,t)=>e.publish(t)),EH=e=>e.subscribe,CH=e=>new AH(e?.replay?new jH(e.replay):void 0),IH=(e,t,n)=>se(xc(),r=>$H(e,t,e.subscribe(),yl(),r,As(!1),n)),$H=(e,t,n,r,s,o,i)=>new OH(e,t,n,r,s,o,i,e.replayWindow());class AH{replayBuffer;publisherHead={value:xn,subscribers:0,next:null};publisherTail=this.publisherHead;publisherIndex=0;subscribersIndex=0;capacity=Number.MAX_SAFE_INTEGER;constructor(t){this.replayBuffer=t}replayWindow(){return this.replayBuffer?new zH(this.replayBuffer):VH}isEmpty(){return this.publisherHead===this.publisherTail}isFull(){return!1}size(){return this.publisherIndex-this.subscribersIndex}publish(t){const n=this.publisherTail.subscribers;return n!==0&&(this.publisherTail.next={value:t,subscribers:n,next:null},this.publisherTail=this.publisherTail.next,this.publisherIndex+=1),this.replayBuffer&&this.replayBuffer.offer(t),!0}publishAll(t){if(this.publisherTail.subscribers!==0)for(const n of t)this.publish(n);else this.replayBuffer&&this.replayBuffer.offerAll(t);return We()}slide(){this.publisherHead!==this.publisherTail&&(this.publisherHead=this.publisherHead.next,this.publisherHead.value=xn,this.subscribersIndex+=1),this.replayBuffer&&this.replayBuffer.slide()}subscribe(){return this.publisherTail.subscribers+=1,new RH(this,this.publisherTail,this.publisherIndex,!1)}}class RH{self;subscriberHead;subscriberIndex;unsubscribed;constructor(t,n,r,s){this.self=t,this.subscriberHead=n,this.subscriberIndex=r,this.unsubscribed=s}isEmpty(){if(this.unsubscribed)return!0;let t=!0,n=!0;for(;n;)this.subscriberHead===this.self.publisherTail?n=!1:this.subscriberHead.next.value!==xn?(t=!1,n=!1):(this.subscriberHead=this.subscriberHead.next,this.subscriberIndex+=1);return t}size(){return this.unsubscribed?0:this.self.publisherIndex-Math.max(this.subscriberIndex,this.self.subscribersIndex)}poll(t){if(this.unsubscribed)return t;let n=!0,r=t;for(;n;)if(this.subscriberHead===this.self.publisherTail)n=!1;else{const s=this.subscriberHead.next.value;s!==xn&&(r=s,this.subscriberHead.subscribers-=1,this.subscriberHead.subscribers===0&&(this.self.publisherHead=this.self.publisherHead.next,this.self.publisherHead.value=xn,this.self.subscribersIndex+=1),n=!1),this.subscriberHead=this.subscriberHead.next,this.subscriberIndex+=1}return r}pollUpTo(t){const n=[],r=xn;let s=0;for(;s!==t;){const o=this.poll(r);o===r?s=t:(n.push(o),s+=1)}return Wi(n)}unsubscribe(){if(!this.unsubscribed)for(this.unsubscribed=!0,this.self.publisherTail.subscribers-=1;this.subscriberHead!==this.self.publisherTail;)this.subscriberHead.next.value!==xn&&(this.subscriberHead.subscribers-=1,this.subscriberHead.subscribers===0&&(this.self.publisherHead=this.self.publisherHead.next,this.self.publisherHead.value=xn,this.self.subscribersIndex+=1)),this.subscriberHead=this.subscriberHead.next}}class OH extends ai{pubsub;subscribers;subscription;pollers;shutdownHook;shutdownFlag;strategy;replayWindow;[am]=um;constructor(t,n,r,s,o,i,c,a){super(),this.pubsub=t,this.subscribers=n,this.subscription=r,this.pollers=s,this.shutdownHook=o,this.shutdownFlag=i,this.strategy=c,this.replayWindow=a}commit(){return this.take}pipe(){return Y(this,arguments)}capacity(){return this.pubsub.capacity}isActive(){return!_e(this.shutdownFlag)}get size(){return le(()=>_e(this.shutdownFlag)?Ct:L(this.subscription.size()+this.replayWindow.remaining))}unsafeSize(){return _e(this.shutdownFlag)?K():U(this.subscription.size()+this.replayWindow.remaining)}get isFull(){return le(()=>_e(this.shutdownFlag)?Ct:L(this.subscription.size()===this.capacity()))}get isEmpty(){return se(this.size,t=>t===0)}get shutdown(){return xs(Ee(t=>(Rs(this.shutdownFlag,!0),p(Qp(lm(this.pollers),n=>kp(n,t.id()),!1),gt(M(()=>{this.subscribers.delete(this.subscription),this.subscription.unsubscribe(),this.strategy.unsafeOnPubSubEmptySpace(this.pubsub,this.subscribers)})),al(Fc(this.shutdownHook,void 0)),an))))}get isShutdown(){return M(()=>_e(this.shutdownFlag))}get awaitShutdown(){return Jn(this.shutdownHook)}get take(){return Ee(t=>{if(_e(this.shutdownFlag))return Ct;if(this.replayWindow.remaining>0){const r=this.replayWindow.take();return L(r)}const n=fs(this.pollers)?this.subscription.poll(ot):ot;if(n===ot){const r=Pc(t.id());return p(le(()=>(p(this.pollers,Do(r)),p(this.subscribers,qT(this.subscription,this.pollers)),this.strategy.unsafeCompletePollers(this.pubsub,this.subscribers,this.subscription,this.pollers),_e(this.shutdownFlag)?Ct:Jn(r))),Ac(()=>M(()=>HH(this.pollers,r))))}else return this.strategy.unsafeOnPubSubEmptySpace(this.pubsub,this.subscribers),L(n)})}get takeAll(){return le(()=>{if(_e(this.shutdownFlag))return Ct;const t=fs(this.pollers)?BH(this.subscription):We();return this.strategy.unsafeOnPubSubEmptySpace(this.pubsub,this.subscribers),this.replayWindow.remaining>0?L(bt(this.replayWindow.takeAll(),t)):L(t)})}takeUpTo(t){return le(()=>{if(_e(this.shutdownFlag))return Ct;let n;if(this.replayWindow.remaining>=t){const s=this.replayWindow.takeN(t);return L(s)}else this.replayWindow.remaining>0&&(n=this.replayWindow.takeAll(),t=t-n.length);const r=fs(this.pollers)?MH(this.subscription,t):We();return this.strategy.unsafeOnPubSubEmptySpace(this.pubsub,this.subscribers),L(n?bt(n,r):r)})}takeBetween(t,n){return le(()=>WT(this,t,n,We()))}}const WT=(e,t,n,r)=>n<t?L(r):p(e.takeUpTo(n),P(s=>{const o=t-s.length;return o===1?p(e.take,se(i=>p(r,bt(s),Eo(i)))):o>1?p(e.take,P(i=>WT(e,o-1,n-s.length-1,p(r,bt(s),Eo(i))))):L(p(r,bt(s)))}));class PH{pubsub;subscribers;scope;shutdownHook;shutdownFlag;strategy;[HT]=KT;[am]=um;constructor(t,n,r,s,o,i){this.pubsub=t,this.subscribers=n,this.scope=r,this.shutdownHook=s,this.shutdownFlag=o,this.strategy=i}capacity(){return this.pubsub.capacity}get size(){return le(()=>_e(this.shutdownFlag)?Ct:M(()=>this.pubsub.size()))}unsafeSize(){return _e(this.shutdownFlag)?K():U(this.pubsub.size())}get isFull(){return se(this.size,t=>t===this.capacity())}get isEmpty(){return se(this.size,t=>t===0)}get awaitShutdown(){return Jn(this.shutdownHook)}get isShutdown(){return M(()=>_e(this.shutdownFlag))}get shutdown(){return xs(Ee(t=>(p(this.shutdownFlag,Rs(!0)),p(this.scope.close(Fw(t.id())),gt(this.strategy.shutdown),al(Fc(this.shutdownHook,void 0)),an))))}publish(t){return le(()=>_e(this.shutdownFlag)?Ct:this.pubsub.publish(t)?(this.strategy.unsafeCompleteSubscribers(this.pubsub,this.subscribers),L(!0)):this.strategy.handleSurplus(this.pubsub,this.subscribers,Be(t),this.shutdownFlag))}isActive(){return!_e(this.shutdownFlag)}unsafeOffer(t){return _e(this.shutdownFlag)?!1:this.pubsub.publish(t)?(this.strategy.unsafeCompleteSubscribers(this.pubsub,this.subscribers),!0):!1}publishAll(t){return le(()=>{if(_e(this.shutdownFlag))return Ct;const n=LH(this.pubsub,t);return this.strategy.unsafeCompleteSubscribers(this.pubsub,this.subscribers),Ku(n)?L(!0):this.strategy.handleSurplus(this.pubsub,this.subscribers,n,this.shutdownFlag)})}get subscribe(){const t=cl(Yp([this.scope.fork(xr),IH(this.pubsub,this.subscribers,this.strategy)]),n=>n[0].addFinalizer(()=>n[1].shutdown));return se(wM(t,(n,r)=>n[0].close(r)),n=>n[1])}offer(t){return this.publish(t)}offerAll(t){return this.publishAll(t)}pipe(){return Y(this,arguments)}}const xH=(e,t)=>P($l(),n=>se(xc(),r=>FH(e,new Map,n,r,As(!1),t))),FH=(e,t,n,r,s,o)=>new PH(e,t,n,r,s,o),NH=(e,t)=>{ml(e,L(t))},JT=(e,t)=>p(e,Rp(t)),lm=e=>p(e,Sl(Number.POSITIVE_INFINITY)),BH=e=>e.pollUpTo(Number.POSITIVE_INFINITY),MH=(e,t)=>e.pollUpTo(t),LH=(e,t)=>e.publishAll(t),HH=(e,t)=>{JT(e,p(lm(e),Uu(n=>n!==t)))};class DH{get shutdown(){return Ke}handleSurplus(t,n,r,s){return L(!1)}unsafeOnPubSubEmptySpace(t,n){}unsafeCompletePollers(t,n,r,s){return UH(this,t,n,r,s)}unsafeCompleteSubscribers(t,n){return KH(this,t,n)}}const UH=(e,t,n,r,s)=>{let o=!0;for(;o&&!r.isEmpty();){const i=p(s,pr(ot));if(i===ot)p(n,wH(r,s)),fs(s)?o=!1:p(n,qT(r,s));else{const c=r.poll(ot);c===ot?JT(s,p(lm(s),Bt(i))):(NH(i,c),e.unsafeOnPubSubEmptySpace(t,n))}}},KH=(e,t,n)=>{for(const[r,s]of n)for(const o of s)e.unsafeCompletePollers(t,n,r,o)};class jH{capacity;constructor(t){this.capacity=t}head={value:xn,next:null};tail=this.head;size=0;index=0;slide(){this.index++}offer(t){this.tail.value=t,this.tail.next={value:xn,next:null},this.tail=this.tail.next,this.size===this.capacity?this.head=this.head.next:this.size+=1}offerAll(t){for(const n of t)this.offer(n)}}class zH{buffer;head;index;remaining;constructor(t){this.buffer=t,this.index=t.index,this.remaining=t.size,this.head=t.head}fastForward(){for(;this.index<this.buffer.index;)this.head=this.head.next,this.index++}take(){if(this.remaining===0)return;this.index<this.buffer.index&&this.fastForward(),this.remaining--;const t=this.head.value;return this.head=this.head.next,t}takeN(t){if(this.remaining===0)return We();this.index<this.buffer.index&&this.fastForward();const n=Math.min(t,this.remaining),r=new Array(n);for(let s=0;s<n;s++){const o=this.head.value;this.head=this.head.next,r[s]=o}return this.remaining-=n,on(r)}takeAll(){return this.takeN(this.remaining)}}const VH={remaining:0,take:()=>{},takeN:()=>We(),takeAll:()=>We()},GT=vH,sd=TH,fm=kH,Oy=EH,hm=oH,YT=iH,qH=uH,WH=lH,fc=fH,jt=hH,od=rd,JH=pH,QT="Continue",GH="Close",YH="Yield",QH="effect/ChannelChildExecutorDecision",Py=Symbol.for(QH),XH={[Py]:Py},XT=e=>{const t=Object.create(XH);return t._tag=QT,t},Ea="ContinuationK",ZH="ContinuationFinalizer",ZT=Symbol.for("effect/ChannelContinuation"),ek={_Env:e=>e,_InErr:e=>e,_InElem:e=>e,_InDone:e=>e,_OutErr:e=>e,_OutDone:e=>e,_OutErr2:e=>e,_OutElem:e=>e,_OutDone2:e=>e};class tk{onSuccess;onHalt;_tag=Ea;[ZT]=ek;constructor(t,n){this.onSuccess=t,this.onHalt=n}onExit(t){return Mw(t)?this.onHalt(t.cause):this.onSuccess(t.value)}}class eD{finalizer;_tag=ZH;[ZT]=ek;constructor(t){this.finalizer=t}}const nk="PullAfterNext",tD="PullAfterAllEnqueued",nD="effect/ChannelUpstreamPullStrategy",rD=Symbol.for(nD),sD={_A:e=>e},oD={[rD]:sD},rk=e=>{const t=Object.create(oD);return t._tag=nk,t.emitSeparator=e,t},sk="BracketOut",ok="Bridge",dm="ConcatAll",ik="Emit",ck="Ensuring",ak="Fail",uk="Fold",lk="FromEffect",fk="PipeTo",iD="Provide",hk="Read",dk="Succeed",pk="SucceedNow",mk="Suspend",cD="effect/Channel",gk=Symbol.for(cD),aD={_Env:e=>e,_InErr:e=>e,_InElem:e=>e,_InDone:e=>e,_OutErr:e=>e,_OutElem:e=>e,_OutDone:e=>e},Xt={[gk]:aD,pipe(){return Y(this,arguments)}},yk=e=>re(e,gk)||ui(e),uD=d(2,(e,t)=>{const n=Object.create(Xt);return n._tag=sk,n.acquire=()=>e,n.finalizer=t,n}),Sk=(e,t,n)=>{const r=Object.create(Xt);return r._tag=dm,r.combineInners=t,r.combineAll=n,r.onPull=()=>rk(K()),r.onEmit=()=>XT,r.value=()=>e,r.k=ne,r},lD=d(4,(e,t,n,r)=>{const s=Object.create(Xt);return s._tag=dm,s.combineInners=n,s.combineAll=r,s.onPull=()=>rk(K()),s.onEmit=()=>XT,s.value=()=>e,s.k=t,s}),pm=d(2,(e,t)=>{const n=Object.create(Xt);return n._tag=ok,n.input=t,n.channel=e,n}),fD=d(2,(e,t)=>{const n=Object.create(Xt);return n._tag=ck,n.channel=e,n.finalizer=t,n}),Fr=e=>_t(LM(e)),_t=e=>hD(()=>e),hD=e=>{const t=Object.create(Xt);return t._tag=ak,t.error=e,t},ke=d(2,(e,t)=>{const n=Object.create(Xt);return n._tag=uk,n.channel=e,n.k=new tk(t,_t),n}),kt=e=>{const t=Object.create(Xt);return t._tag=lk,t.effect=()=>e,t},Nt=d(2,(e,t)=>{const n=Object.create(Xt);return n._tag=fk,n.left=()=>e,n.right=()=>t,n}),Kc=e=>Xn({onInput:e.onInput,onFailure:t=>zt(jM(t),{onLeft:e.onFailure,onRight:_t}),onDone:e.onDone}),Xn=e=>{const t=Object.create(Xt);return t._tag=hk,t.more=e.onInput,t.done=new tk(e.onDone,e.onFailure),t},mm=e=>bk(()=>e),Gn=e=>{const t=Object.create(Xt);return t._tag=pk,t.terminal=e,t},Pl=e=>{const t=Object.create(Xt);return t._tag=mk,t.channel=e,t},bk=e=>{const t=Object.create(Xt);return t._tag=dk,t.evaluate=e,t},Ht=Gn(void 0),Re=e=>{const t=Object.create(Xt);return t._tag=ik,t.out=e,t},jc="Done",zc="Emit",li="FromEffect",Vc="Read",dD=Symbol.for("effect/ChannelState"),pD={_E:e=>e,_R:e=>e},xl={[dD]:pD},Vs=()=>{const e=Object.create(xl);return e._tag=jc,e},wf=()=>{const e=Object.create(xl);return e._tag=zc,e},_i=e=>{const t=Object.create(xl);return t._tag=li,t.effect=e,t},vf=(e,t,n,r)=>{const s=Object.create(xl);return s._tag=Vc,s.upstream=e,s.onEffect=t,s.onEmit=n,s.onDone=r,s},_u=e=>e._tag===li,mD=e=>_u(e)?e.effect:ge,xy=e=>_u(e)?HL(e.effect):void 0,_k="PullFromChild",id="PullFromUpstream",cd="DrainChildExecutors",wk="Emit";class ra{childExecutor;parentSubexecutor;onEmit;_tag=_k;constructor(t,n,r){this.childExecutor=t,this.parentSubexecutor=n,this.onEmit=r}close(t){const n=this.childExecutor.close(t),r=this.parentSubexecutor.close(t);return n!==void 0&&r!==void 0?Ol(St(n),St(r),(s,o)=>p(s,rc(o))):n!==void 0?n:r!==void 0?r:void 0}enqueuePullFromChild(t){return this}}class ts{upstreamExecutor;createChild;lastDone;activeChildExecutors;combineChildResults;combineWithChildResult;onPull;onEmit;_tag=id;constructor(t,n,r,s,o,i,c,a){this.upstreamExecutor=t,this.createChild=n,this.lastDone=r,this.activeChildExecutors=s,this.combineChildResults=o,this.combineWithChildResult=i,this.onPull=c,this.onEmit=a}close(t){const n=this.upstreamExecutor.close(t),s=[...this.activeChildExecutors.map(o=>o!==void 0?o.childExecutor.close(t):void 0),n].reduce((o,i)=>o!==void 0&&i!==void 0?Ol(o,St(i),(c,a)=>rc(c,a)):o!==void 0?o:i!==void 0?St(i):void 0,void 0);return s}enqueuePullFromChild(t){return new ts(this.upstreamExecutor,this.createChild,this.lastDone,[...this.activeChildExecutors,t],this.combineChildResults,this.combineWithChildResult,this.onPull,this.onEmit)}}class oo{upstreamExecutor;lastDone;activeChildExecutors;upstreamDone;combineChildResults;combineWithChildResult;onPull;_tag=cd;constructor(t,n,r,s,o,i,c){this.upstreamExecutor=t,this.lastDone=n,this.activeChildExecutors=r,this.upstreamDone=s,this.combineChildResults=o,this.combineWithChildResult=i,this.onPull=c}close(t){const n=this.upstreamExecutor.close(t),s=[...this.activeChildExecutors.map(o=>o!==void 0?o.childExecutor.close(t):void 0),n].reduce((o,i)=>o!==void 0&&i!==void 0?Ol(o,St(i),(c,a)=>rc(c,a)):o!==void 0?o:i!==void 0?St(i):void 0,void 0);return s}enqueuePullFromChild(t){return new oo(this.upstreamExecutor,this.lastDone,[...this.activeChildExecutors,t],this.upstreamDone,this.combineChildResults,this.combineWithChildResult,this.onPull)}}class Tf{value;next;_tag=wk;constructor(t,n){this.value=t,this.next=n}close(t){const n=this.next.close(t);return n}enqueuePullFromChild(t){return this}}const gD="Pulled",yD="NoUpstream",SD="effect/ChannelUpstreamPullRequest",bD=Symbol.for(SD),_D={_A:e=>e},vk={[bD]:_D},Fy=e=>{const t=Object.create(vk);return t._tag=gD,t.value=e,t},wD=e=>{const t=Object.create(vk);return t._tag=yD,t.activeDownstreamCount=e,t};class os{_activeSubexecutor=void 0;_cancelled=void 0;_closeLastSubstream=void 0;_currentChannel;_done=void 0;_doneStack=[];_emitted=void 0;_executeCloseLastSubstream;_input=void 0;_inProgressFinalizer=void 0;_providedEnv;constructor(t,n,r){this._currentChannel=t,this._executeCloseLastSubstream=r,this._providedEnv=n}run(){let t;for(;t===void 0;)if(this._cancelled!==void 0)t=this.processCancellation();else if(this._activeSubexecutor!==void 0)t=this.runSubexecutor();else try{if(this._currentChannel===void 0)t=Vs();else switch(ui(this._currentChannel)&&(this._currentChannel=kt(this._currentChannel)),this._currentChannel._tag){case sk:{t=this.runBracketOut(this._currentChannel);break}case ok:{const n=this._currentChannel.input;if(this._currentChannel=this._currentChannel.channel,this._input!==void 0){const r=this._input;this._input=void 0;const s=()=>X(n.awaitRead(),()=>tt(()=>{const o=r.run();switch(o._tag){case jc:return Ln(r.getDone(),{onFailure:i=>n.error(i),onSuccess:i=>n.done(i)});case zc:return X(n.emit(r.getEmit()),()=>s());case li:return Fn(o.effect,{onFailure:i=>n.error(i),onSuccess:()=>s()});case Vc:return gm(o,()=>s(),i=>n.error(i))}}));t=_i(X(it(tn(s())),o=>Qe(()=>this.addFinalizer(i=>X(xe(o),()=>tt(()=>{const c=this.restorePipe(i,r);return c!==void 0?c:ge}))))))}break}case dm:{const n=new os(this._currentChannel.value(),this._providedEnv,s=>Qe(()=>{const o=this._closeLastSubstream===void 0?ge:this._closeLastSubstream;this._closeLastSubstream=p(o,Ce(s))}));n._input=this._input;const r=this._currentChannel;this._activeSubexecutor=new ts(n,s=>r.k(s),void 0,[],(s,o)=>r.combineInners(s,o),(s,o)=>r.combineAll(s,o),s=>r.onPull(s),s=>r.onEmit(s)),this._closeLastSubstream=void 0,this._currentChannel=void 0;break}case ik:{this._emitted=this._currentChannel.out,this._currentChannel=this._activeSubexecutor!==void 0?void 0:Ht,t=wf();break}case ck:{this.runEnsuring(this._currentChannel);break}case ak:{t=this.doneHalt(this._currentChannel.error());break}case uk:{this._doneStack.push(this._currentChannel.k),this._currentChannel=this._currentChannel.channel;break}case lk:{const n=this._providedEnv===void 0?this._currentChannel.effect():p(this._currentChannel.effect(),td(this._providedEnv));t=_i(Fn(n,{onFailure:r=>{const s=this.doneHalt(r);return s!==void 0&&_u(s)?s.effect:ge},onSuccess:r=>{const s=this.doneSucceed(r);return s!==void 0&&_u(s)?s.effect:ge}}));break}case fk:{const n=this._input,r=new os(this._currentChannel.left(),this._providedEnv,s=>this._executeCloseLastSubstream(s));r._input=n,this._input=r,this.addFinalizer(s=>{const o=this.restorePipe(s,n);return o!==void 0?o:ge}),this._currentChannel=this._currentChannel.right();break}case iD:{const n=this._providedEnv;this._providedEnv=this._currentChannel.context(),this._currentChannel=this._currentChannel.inner,this.addFinalizer(()=>Qe(()=>{this._providedEnv=n}));break}case hk:{const n=this._currentChannel;t=vf(this._input,ne,r=>{try{this._currentChannel=n.more(r)}catch(s){this._currentChannel=n.done.onExit(wP(s))}},r=>{const s=o=>n.done.onExit(o);this._currentChannel=s(r)});break}case dk:{t=this.doneSucceed(this._currentChannel.evaluate());break}case pk:{t=this.doneSucceed(this._currentChannel.terminal);break}case mk:{this._currentChannel=this._currentChannel.channel();break}}}catch(n){this._currentChannel=_t(Wh(n))}return t}getDone(){return this._done}getEmit(){return this._emitted}cancelWith(t){this._cancelled=t}clearInProgressFinalizer(){this._inProgressFinalizer=void 0}storeInProgressFinalizer(t){this._inProgressFinalizer=t}popAllFinalizers(t){const n=[];let r=this._doneStack.pop();for(;r;)r._tag==="ContinuationFinalizer"&&n.push(r.finalizer),r=this._doneStack.pop();const s=n.length===0?ge:Ef(n,t);return this.storeInProgressFinalizer(s),s}popNextFinalizers(){const t=[];for(;this._doneStack.length!==0;){const n=this._doneStack[this._doneStack.length-1];if(n._tag===Ea)return t;t.push(n),this._doneStack.pop()}return t}restorePipe(t,n){const r=this._input;return this._input=n,r!==void 0?r.close(t):ge}close(t){let n;const r=this._inProgressFinalizer;r!==void 0&&(n=p(r,ro(Qe(()=>this.clearInProgressFinalizer()))));let s;const o=this.popAllFinalizers(t);o!==void 0&&(s=p(o,ro(Qe(()=>this.clearInProgressFinalizer()))));const i=this._activeSubexecutor===void 0?void 0:this._activeSubexecutor.close(t);if(!(i===void 0&&n===void 0&&s===void 0))return p(St(kf(i)),nd(St(kf(n))),nd(St(kf(s))),j(([[c,a],u])=>p(c,rc(a),rc(u))),Ci,X(c=>tt(()=>c)))}doneSucceed(t){if(this._doneStack.length===0)return this._done=dn(t),this._currentChannel=void 0,Vs();const n=this._doneStack[this._doneStack.length-1];if(n._tag===Ea){this._doneStack.pop(),this._currentChannel=n.onSuccess(t);return}const r=this.popNextFinalizers();if(this._doneStack.length===0)return this._doneStack=r.reverse(),this._done=dn(t),this._currentChannel=void 0,Vs();const s=Ef(r.map(i=>i.finalizer),dn(t));this.storeInProgressFinalizer(s);const o=p(s,ro(Qe(()=>this.clearInProgressFinalizer())),Ci,X(()=>Qe(()=>this.doneSucceed(t))));return _i(o)}doneHalt(t){if(this._doneStack.length===0)return this._done=mn(t),this._currentChannel=void 0,Vs();const n=this._doneStack[this._doneStack.length-1];if(n._tag===Ea){this._doneStack.pop();try{this._currentChannel=n.onHalt(t)}catch(i){this._currentChannel=_t(Wh(i))}return}const r=this.popNextFinalizers();if(this._doneStack.length===0)return this._doneStack=r.reverse(),this._done=mn(t),this._currentChannel=void 0,Vs();const s=Ef(r.map(i=>i.finalizer),mn(t));this.storeInProgressFinalizer(s);const o=p(s,ro(Qe(()=>this.clearInProgressFinalizer())),Ci,X(()=>Qe(()=>this.doneHalt(t))));return _i(o)}processCancellation(){return this._currentChannel=void 0,this._done=this._cancelled,this._cancelled=void 0,Vs()}runBracketOut(t){const n=Ci(Fn(this.provide(t.acquire()),{onFailure:r=>Qe(()=>{this._currentChannel=_t(r)}),onSuccess:r=>Qe(()=>{this.addFinalizer(s=>this.provide(t.finalizer(r,s))),this._currentChannel=Re(r)})}));return _i(n)}provide(t){return this._providedEnv===void 0?t:p(t,td(this._providedEnv))}runEnsuring(t){this.addFinalizer(t.finalizer),this._currentChannel=t.channel}addFinalizer(t){this._doneStack.push(new eD(t))}runSubexecutor(){const t=this._activeSubexecutor;switch(t._tag){case _k:return this.pullFromChild(t.childExecutor,t.parentSubexecutor,t.onEmit,t);case id:return this.pullFromUpstream(t);case cd:return this.drainChildExecutors(t);case wk:return this._emitted=t.value,this._activeSubexecutor=t.next,wf()}}replaceSubexecutor(t){this._currentChannel=void 0,this._activeSubexecutor=t}finishWithExit(t){const n=Ln(t,{onFailure:r=>this.doneHalt(r),onSuccess:r=>this.doneSucceed(r)});return this._activeSubexecutor=void 0,n===void 0?ge:mD(n)}finishSubexecutorWithCloseEffect(t,...n){this.addFinalizer(()=>p(n,En(s=>p(Qe(()=>s(t)),X(o=>o!==void 0?o:ge)),{discard:!0})));const r=p(t,Ln({onFailure:s=>this.doneHalt(s),onSuccess:s=>this.doneSucceed(s)}));return this._activeSubexecutor=void 0,r}applyUpstreamPullStrategy(t,n,r){switch(r._tag){case nk:{const s=!t||n.some(o=>o!==void 0);return[r.emitSeparator,s?[void 0,...n]:n]}case tD:{const s=!t||n.some(o=>o!==void 0);return[r.emitSeparator,s?[...n,void 0]:n]}}}pullFromChild(t,n,r,s){return vf(t,ne,o=>{const i=r(o);switch(i._tag){case QT:break;case GH:{this.finishWithDoneValue(t,n,i.value);break}case YH:{const c=n.enqueuePullFromChild(s);this.replaceSubexecutor(c);break}}this._activeSubexecutor=new Tf(o,this._activeSubexecutor)},Ln({onFailure:o=>{const i=this.handleSubexecutorFailure(t,n,o);return i===void 0?void 0:xy(i)},onSuccess:o=>{this.finishWithDoneValue(t,n,o)}}))}finishWithDoneValue(t,n,r){const s=n;switch(s._tag){case id:{const o=new ts(s.upstreamExecutor,s.createChild,s.lastDone!==void 0?s.combineChildResults(s.lastDone,r):r,s.activeChildExecutors,s.combineChildResults,s.combineWithChildResult,s.onPull,s.onEmit);this._closeLastSubstream=t.close(dn(r)),this.replaceSubexecutor(o);break}case cd:{const o=new oo(s.upstreamExecutor,s.lastDone!==void 0?s.combineChildResults(s.lastDone,r):r,s.activeChildExecutors,s.upstreamDone,s.combineChildResults,s.combineWithChildResult,s.onPull);this._closeLastSubstream=t.close(dn(r)),this.replaceSubexecutor(o);break}}}handleSubexecutorFailure(t,n,r){return this.finishSubexecutorWithCloseEffect(mn(r),s=>n.close(s),s=>t.close(s))}pullFromUpstream(t){if(t.activeChildExecutors.length===0)return this.performPullFromUpstream(t);const n=t.activeChildExecutors[0],r=new ts(t.upstreamExecutor,t.createChild,t.lastDone,t.activeChildExecutors.slice(1),t.combineChildResults,t.combineWithChildResult,t.onPull,t.onEmit);if(n===void 0)return this.performPullFromUpstream(r);this.replaceSubexecutor(new ra(n.childExecutor,r,n.onEmit))}performPullFromUpstream(t){return vf(t.upstreamExecutor,n=>{const r=this._closeLastSubstream===void 0?ge:this._closeLastSubstream;return this._closeLastSubstream=void 0,p(this._executeCloseLastSubstream(r),Ce(n))},n=>{if(this._closeLastSubstream!==void 0){const i=this._closeLastSubstream;return this._closeLastSubstream=void 0,p(this._executeCloseLastSubstream(i),j(()=>{const c=new os(t.createChild(n),this._providedEnv,this._executeCloseLastSubstream);c._input=this._input;const[a,u]=this.applyUpstreamPullStrategy(!1,t.activeChildExecutors,t.onPull(Fy(n)));this._activeSubexecutor=new ra(c,new ts(t.upstreamExecutor,t.createChild,t.lastDone,u,t.combineChildResults,t.combineWithChildResult,t.onPull,t.onEmit),t.onEmit),$e(a)&&(this._activeSubexecutor=new Tf(a.value,this._activeSubexecutor))}))}const r=new os(t.createChild(n),this._providedEnv,this._executeCloseLastSubstream);r._input=this._input;const[s,o]=this.applyUpstreamPullStrategy(!1,t.activeChildExecutors,t.onPull(Fy(n)));this._activeSubexecutor=new ra(r,new ts(t.upstreamExecutor,t.createChild,t.lastDone,o,t.combineChildResults,t.combineWithChildResult,t.onPull,t.onEmit),t.onEmit),$e(s)&&(this._activeSubexecutor=new Tf(s.value,this._activeSubexecutor))},n=>{if(t.activeChildExecutors.some(o=>o!==void 0)){const o=new oo(t.upstreamExecutor,t.lastDone,[void 0,...t.activeChildExecutors],t.upstreamExecutor.getDone(),t.combineChildResults,t.combineWithChildResult,t.onPull);if(this._closeLastSubstream!==void 0){const i=this._closeLastSubstream;return this._closeLastSubstream=void 0,p(this._executeCloseLastSubstream(i),j(()=>this.replaceSubexecutor(o)))}this.replaceSubexecutor(o);return}const r=this._closeLastSubstream,s=this.finishSubexecutorWithCloseEffect(p(n,vP(o=>t.combineWithChildResult(t.lastDone,o))),()=>r,o=>t.upstreamExecutor.close(o));return s===void 0?void 0:xy(s)})}drainChildExecutors(t){if(t.activeChildExecutors.length===0){const o=this._closeLastSubstream;return o!==void 0&&this.addFinalizer(()=>z(o)),this.finishSubexecutorWithCloseEffect(t.upstreamDone,()=>o,i=>t.upstreamExecutor.close(i))}const n=t.activeChildExecutors[0],r=t.activeChildExecutors.slice(1);if(n===void 0){const[o,i]=this.applyUpstreamPullStrategy(!0,r,t.onPull(wD(r.reduce((c,a)=>a!==void 0?c+1:c,0))));return this.replaceSubexecutor(new oo(t.upstreamExecutor,t.lastDone,i,t.upstreamDone,t.combineChildResults,t.combineWithChildResult,t.onPull)),$e(o)?(this._emitted=o.value,wf()):void 0}const s=new oo(t.upstreamExecutor,t.lastDone,r,t.upstreamDone,t.combineChildResults,t.combineWithChildResult,t.onPull);this.replaceSubexecutor(new ra(n.childExecutor,s,n.onEmit))}}const kf=e=>e!==void 0?e:ge,Ef=(e,t)=>p(En(e,n=>St(n(t))),j(n=>p(_P(n),qe(()=>TP))),X(n=>tt(()=>n))),gm=(e,t,n)=>{const r=[e],s=()=>{const o=r.pop();if(o===void 0||o.upstream===void 0)return LL("Unexpected end of input for channel execution");const i=o.upstream.run();switch(i._tag){case zc:{const c=o.onEmit(o.upstream.getEmit());return r.length===0?c===void 0?tt(t):p(c,Fn({onFailure:n,onSuccess:t})):c===void 0?tt(()=>s()):p(c,Fn({onFailure:n,onSuccess:()=>s()}))}case jc:{const c=o.onDone(o.upstream.getDone());return r.length===0?c===void 0?tt(t):p(c,Fn({onFailure:n,onSuccess:t})):c===void 0?tt(()=>s()):p(c,Fn({onFailure:n,onSuccess:()=>s()}))}case li:return r.push(o),p(o.onEffect(i.effect),Dr(c=>tt(()=>{const a=o.onDone(mn(c));return a===void 0?ge:a})),Fn({onFailure:n,onSuccess:()=>s()}));case Vc:return r.push(o),r.push(i),tt(()=>s())}};return s()},Tk=d(2,(e,t)=>{const n=(r,s,o)=>UL(Qe(()=>new os(e,void 0,ne)),i=>tt(()=>Ca(i.run(),i).pipe(BT(r),Ce(It(r)),Rl(It(s)))),(i,c)=>{const a=i.close(c);return a===void 0?ge:im(a,u=>uc(o,mr(u)))});return om(r=>ze([hT(t,cu),pn(),pn()]).pipe(X(([s,o,i])=>r(n(o,i,s)).pipe(jn(t),X(c=>t.addFinalizer(a=>{const u=Mw(a)?KM(a.cause):void 0;return $h(o).pipe(X(l=>l?Mn(i,void 0).pipe(Ce(yT(c)),Ce(vy(c))):Mn(i,void 0).pipe(Ce(u&&cp(u)>0?x2(c,wR(u)):xe(c)),Ce(vy(c)))))}).pipe(Ce(r(It(o)))))))))}),Ca=(e,t)=>{const n=e;switch(n._tag){case li:return p(n.effect,X(()=>Ca(t.run(),t)));case zc:return Ca(t.run(),t);case jc:return tt(()=>t.getDone());case Vc:return gm(n,()=>Ca(t.run(),t),mr)}},kk="Done",vD="Await",TD="effect/ChannelMergeDecision",kD=Symbol.for(TD),Ek={[kD]:{_R:e=>e,_E0:e=>e,_Z0:e=>e,_E:e=>e,_Z:e=>e}},ED=e=>{const t=Object.create(Ek);return t._tag=kk,t.effect=e,t},ad=e=>{const t=Object.create(Ek);return t._tag=vD,t.f=e,t},Ck="BothRunning",Ik="LeftDone",$k="RightDone",CD="effect/ChannelMergeState",Ny=Symbol.for(CD),ym={[Ny]:Ny},Cf=(e,t)=>{const n=Object.create(ym);return n._tag=Ck,n.left=e,n.right=t,n},By=e=>{const t=Object.create(ym);return t._tag=Ik,t.f=e,t},My=e=>{const t=Object.create(ym);return t._tag=$k,t.f=e,t},Ak="BackPressure",Rk="BufferSliding",ID="effect/ChannelMergeStrategy",Ly=Symbol.for(ID),Ok={[Ly]:Ly},$D=e=>{const t=Object.create(Ok);return t._tag=Ak,t},AD=e=>{const t=Object.create(Ok);return t._tag=Rk,t},RD=d(2,(e,{onBackPressure:t,onBufferSliding:n})=>{switch(e._tag){case Ak:return t();case Rk:return n()}}),Xs="Empty",Ii="Emit",$i="Error",Ai="Done",Pk=e=>({_tag:Xs,notifyProducer:e}),If=e=>({_tag:Ii,notifyConsumers:e}),OD=e=>({_tag:$i,cause:e}),PD=e=>({_tag:Ai,done:e});class xD{ref;constructor(t){this.ref=t}awaitRead(){return es(yi(this.ref,t=>t._tag===Xs?[It(t.notifyProducer),t]:[ge,t]))}get close(){return jL(t=>this.error(HM(t)))}done(t){return es(yi(this.ref,n=>{switch(n._tag){case Xs:return[It(n.notifyProducer),n];case Ii:return[En(n.notifyConsumers,r=>Mn(r,oe(t)),{discard:!0}),PD(t)];case $i:return[js,n];case Ai:return[js,n]}}))}emit(t){return X(pn(),n=>es(yi(this.ref,r=>{switch(r._tag){case Xs:return[It(r.notifyProducer),r];case Ii:{const s=r.notifyConsumers[0],o=r.notifyConsumers.slice(1);if(s!==void 0)return[Mn(s,me(t)),o.length===0?Pk(n):If(o)];throw new Error("Bug: Channel.SingleProducerAsyncInput.emit - Queue was empty! please report an issue at https://github.com/Effect-TS/effect/issues")}case $i:return[js,r];case Ai:return[js,r]}})))}error(t){return es(yi(this.ref,n=>{switch(n._tag){case Xs:return[It(n.notifyProducer),n];case Ii:return[En(n.notifyConsumers,r=>Bw(r,t),{discard:!0}),OD(t)];case $i:return[js,n];case Ai:return[js,n]}}))}get take(){return this.takeWith(t=>mn(sT(t,oe)),t=>dn(t),t=>Lw(me(t)))}takeWith(t,n,r){return X(pn(),s=>es(yi(this.ref,o=>{switch(o._tag){case Xs:return[Ce(Mn(o.notifyProducer,void 0),Su(It(s),{onFailure:t,onSuccess:zt({onLeft:r,onRight:n})})),If([s])];case Ii:return[Su(It(s),{onFailure:t,onSuccess:zt({onLeft:r,onRight:n})}),If([...o.notifyConsumers,s])];case $i:return[z(t(o.cause)),o];case Ai:return[z(r(o.done)),o]}})))}}const Sm=()=>p(pn(),X(e=>Fp(Pk(e))),j(e=>new xD(e))),FD=d(2,(e,t)=>_m(e,()=>t)),wu=d(2,(e,t)=>lD(e,t,()=>{},()=>{})),bm=e=>{const t=Xn({onInput:()=>t,onFailure:_t,onDone:mm});return Nt(e,t)},xk=d(2,(e,t)=>fD(e,()=>t)),ND=e=>ke(e,ne),Fl=e=>sn(e.takeWith(_t,t=>ke(Re(t),()=>Fl(e)),mm)),Fk=()=>Kc({onInput:e=>ke(Re(e),()=>Fk()),onFailure:Fr,onDone:Gn}),_m=d(2,(e,t)=>ke(e,n=>bk(()=>t(n)))),Nl=d(2,(e,t)=>{const n=Kc({onInput:r=>ke(Re(t(r)),()=>n),onFailure:Fr,onDone:Gn});return Nt(e,n)}),BD=d(3,(e,t,n)=>wm(r=>$(function*(){const s=yield*Sm(),o=Fl(s),i=yield*hm(n);yield*uc(r,fc(i));const c=yield*pn(),a=n===Number.POSITIVE_INFINITY?f=>ne:(yield*cm(n)).withPermits;yield*(yield*o.pipe(Nt(e),So(r))).pipe(Fn({onFailure:f=>jt(i,mr(f)),onSuccess:zt({onLeft:f=>Ce(tn(a(n)(ge)),Ae(jt(i,z(oe(f))))),onRight:f=>$(function*(){const h=yield*pn(),m=yield*pn();yield*jt(i,j(It(h),me)),yield*Mn(m,void 0).pipe(Ce(om(y=>St(y(It(c))).pipe(qL(St(y(t(f)))),X(ne))).pipe(im(y=>Bw(c,y)),BT(h))),a(1),jn(r)),yield*It(m)})})}),WL,tn,jn(r));const l=sn(Su(es(od(i)),{onFailure:_t,onSuccess:zt({onLeft:Gn,onRight:f=>ke(Re(f),()=>l)})}));return pm(l,s)}))),MD=e=>t=>LD(e)(t,Ba),LD=({bufferSize:e=16,concurrency:t,mergeStrategy:n=$D()})=>(r,s)=>wm(o=>$(function*(){const i=t==="unbounded"?Number.MAX_SAFE_INTEGER:t,c=yield*Sm(),a=Fl(c),u=yield*hm(e);yield*uc(o,fc(u));const l=yield*YT();yield*uc(o,fc(l));const f=yield*Fp(K()),h=yield*pn(),m=(yield*cm(i)).withPermits,y=yield*So(Nt(a,r),o);function S(T){return T.pipe(X(zt({onLeft:C=>z(U(C)),onRight:C=>hs(jt(u,z(me(C))),K())})),Ry({until:C=>$e(C)}),X(C=>sv(f,Fe({onNone:()=>U(C.value),onSome:v=>U(s(v,C.value))}))),Dr(C=>rT(C)?mr(C):jt(u,mr(C)).pipe(Ce(Mn(h,void 0)),Ae)))}yield*y.pipe(Fn({onFailure:T=>jt(u,mr(T)).pipe(Ce(z(!1))),onSuccess:zt({onLeft:T=>MT(tn(It(h)),tn(m(i)(ge)),{onSelfDone:(C,v)=>hs(xe(v),!1),onOtherDone:(C,v)=>Ce(xe(v),Li(f).pipe(X(Fe({onNone:()=>jt(u,z(oe(T))),onSome:k=>jt(u,z(oe(s(k,T))))})),hs(!1)))}),onRight:T=>RD(n,{onBackPressure:()=>$(function*(){const C=yield*pn(),v=ed(R=>So(Nt(a,T),R).pipe(X(w=>_f(St(S(w)),St(tn(It(h))))),X(ne)));return yield*Mn(C,void 0).pipe(Ce(v),m(1),jn(o)),yield*It(C),!(yield*$h(h))}),onBufferSliding:()=>$(function*(){const C=yield*pn(),v=yield*pn(),k=yield*qH(l);yield*od(l).pipe(X(I=>Mn(I,void 0)),VL(()=>k>=i)),yield*jt(l,C);const R=ed(I=>So(Nt(a,T),I).pipe(X(O=>St(S(O)).pipe(_f(St(tn(It(h)))),_f(St(tn(It(C)))))),X(ne)));return yield*Mn(v,void 0).pipe(Ce(R),m(1),jn(o)),yield*It(v),!(yield*$h(h))})})})}),Ry({while:T=>T}),jn(o));const _=p(od(u),es,Su({onFailure:_t,onSuccess:zt({onLeft:Gn,onRight:T=>ke(Re(T),()=>_)})}),sn);return pm(_,c)})),Nk=d(3,(e,t,n)=>MD(n)(Nl(e,t))),Bk=d(2,(e,t)=>{function n(r){return $(function*(){const s=yield*Sm(),o=Fl(s),i=yield*So(Nt(o,e),r),c=yield*So(Nt(o,t.other),r);function a(l,f,h){return(m,y,S)=>{function _(T){const C=T;return C._tag===kk?z(kt(Ce(xe(f),C.effect))):j(yT(f),Ln({onFailure:v=>kt(C.f(mn(v))),onSuccess:zt({onLeft:v=>kt(C.f(dn(v))),onRight:v=>Ml(Re(v),u(S(C.f)))})}))}return Ln(l,{onFailure:T=>_(m(mn(T))),onSuccess:zt({onLeft:T=>_(m(dn(T))),onRight:T=>z(ke(Re(T),()=>ke(kt(jn(tn(h),r)),C=>u(y(C,f)))))})})}}function u(l){switch(l._tag){case Ck:{const f=tn(Ty(l.left)),h=tn(Ty(l.right));return sn(MT(f,h,{onSelfDone:(m,y)=>Ce(xe(y),a(m,l.right,i)(t.onSelfDone,Cf,S=>By(S))),onOtherDone:(m,y)=>Ce(xe(y),a(m,l.left,c)(t.onOtherDone,(S,_)=>Cf(_,S),S=>My(S)))}))}case Ik:return sn(j(St(c),Ln({onFailure:f=>kt(l.f(mn(f))),onSuccess:zt({onLeft:f=>kt(l.f(dn(f))),onRight:f=>ke(Re(f),()=>u(By(l.f)))})})));case $k:return sn(j(St(i),Ln({onFailure:f=>kt(l.f(mn(f))),onSuccess:zt({onLeft:f=>kt(l.f(dn(f))),onRight:f=>ke(Re(f),()=>u(My(l.f)))})})))}}return kt(Ay(l=>{const f=Ay(y=>(y.transferChildren(l.scope()),ge)),h=tn(i).pipe(ro(f),jn(r)),m=tn(c).pipe(ro(f),jn(r));return Ol(h,m,(y,S)=>Cf(y,S))})).pipe(ke(u),pm(s))})}return wm(n)}),Mk=d(2,(e,t)=>Pl(()=>{let n;const r=Kc({onInput:o=>ke(Re(o),()=>r),onFailure:o=>(n=jD(o),_t(Wh(n))),onDone:Gn}),s=Xn({onInput:o=>p(Re(o),ke(()=>s)),onFailure:o=>UM(o)&&zD(o.defect)&&ie(o.defect,n)?Fr(o.defect.error):_t(o),onDone:Gn});return Nt(Nt(Nt(e,r),t),s)})),HD=e=>ed(t=>Tk(e,t)),DD=e=>HD(bm(e)),Lk=e=>sn(om(t=>j(v2(),n=>uD(im(t(w2(e,n)),r=>Qh(n,mn(r))),(r,s)=>Qh(n,s))))),Hk=e=>UD(j(KL,t=>ke(kt(e(t)),Re))),So=d(2,(e,t)=>nd(Qe(()=>new os(e,void 0,ne)),YL()).pipe(Ie(([n,r])=>_2(t,s=>{const o=n.close(s);return o!==void 0?td(o,r):ge})),Ci,j(([n])=>tt(()=>ud(n.run(),n))))),ud=(e,t)=>{const n=e;switch(n._tag){case jc:return Ln(t.getDone(),{onFailure:mr,onSuccess:r=>z(oe(r))});case zc:return z(me(t.getEmit()));case li:return p(n.effect,X(()=>ud(t.run(),t)));case Vc:return gm(n,()=>ud(t.run(),t),r=>mr(r))}},sn=e=>ND(kt(e)),UD=e=>Sk(Lk(e),(t,n)=>t,(t,n)=>t),wm=e=>Sk(Hk(e),(t,n)=>t,(t,n)=>t),Bl=e=>Dk(0,e.length,e),Dk=(e,t,n)=>e===t?Ht:p(Re(p(n,hr(e))),ke(()=>Dk(e+1,t,n))),KD=d(e=>yk(e[1]),(e,t,n)=>n?.concurrent?Bk(e,{other:t,onSelfDone:r=>ad(s=>tt(()=>Hg(r,s))),onOtherDone:r=>ad(s=>tt(()=>Hg(s,r)))}):ke(e,r=>_m(t,s=>[r,s]))),Ml=d(e=>yk(e[1]),(e,t,n)=>n?.concurrent?_m(KD(e,t,{concurrent:!0}),r=>r[1]):ke(e,()=>t)),ld=Symbol.for("effect/Channel/ChannelException"),jD=e=>({_tag:"ChannelException",[ld]:ld,error:e}),zD=e=>re(e,ld),VD=Symbol.for("effect/Sink"),qD={_A:e=>e,_In:e=>e,_L:e=>e,_E:e=>e,_R:e=>e};class qc{channel;[VD]=qD;constructor(t){this.channel=t}pipe(){return Y(this,arguments)}}const WD=e=>new qc(Pl(()=>vm(e()))),JD=new qc(bm(Fk())),GD=(e,t,n)=>WD(()=>new qc(Uk(e,t,n))),Uk=(e,t,n)=>t(e)?Kc({onInput:r=>{const[s,o]=Kk(e,r,t,n,0,r.length);return Vn(o)?p(Re(o),FD(s)):Uk(s,t,n)},onFailure:Fr,onDone:()=>Gn(e)}):Gn(e),Kk=(e,t,n,r,s,o)=>{if(s===o)return[e,We()];const i=r(e,p(t,hr(s)));return n(i)?Kk(i,t,n,r,s+1,o):[i,p(t,Ji(s+1))]},YD=e=>{const t=Xn({onInput:n=>p(kt(En(n,r=>e(r),{discard:!0})),ke(()=>t)),onFailure:_t,onDone:()=>Ht});return new qc(t)},QD=e=>new qc(kt(e)),XD=()=>GD(K(),Ue,(e,t)=>Fe(e,{onNone:()=>U(t),onSome:()=>e})),vm=e=>ui(e)?vm(QD(e)):e.channel,ZD=ED,eU=ad,Tm=SL,tU=rm,jk=_L,km=sm,Em=EL,nU=IL,rU="Left",sU="Right",oU="Both",iU="Either",cU={_tag:rU},aU={_tag:sU},zk={_tag:oU},uU={_tag:iU},lU=e=>{switch(e){case"left":return cU;case"right":return aU;case"both":return zk;case"either":return uU;default:return e}},fU=zk,hU="effect/Take",dU=Symbol.for(hU),pU={_A:e=>e,_E:e=>e};class Ll{exit;[dU]=pU;constructor(t){this.exit=t}pipe(){return Y(this,arguments)}}const Hy=e=>new Ll(dn(e)),Dy=new Ll(Lw(K())),mU=e=>new Ll(mn(p(e,sT(U)))),gU=e=>new Ll(dn(Be(e))),yU=()=>$t(K()),SU=e=>Al(mr(e),U),bU="effect/Stream",Vk=Symbol.for(bU),_U={_R:e=>e,_E:e=>e,_A:e=>e};class Je{channel;[Vk]=_U;constructor(t){this.channel=t}pipe(){return Y(this,arguments)}}const Cm=e=>re(e,Vk)||ui(e),Im=4096,wU=e=>p(e,vU((t,n)=>ie(n)(t))),vU=d(2,(e,t)=>{const n=r=>Xn({onInput:s=>{const[o,i]=y_(s,[r,We()],([c,a],u)=>$e(c)&&t(c.value,u)?[U(u),a]:[U(u),p(a,Eo(u))]);return ke(Re(i),()=>n(o))},onFailure:_t,onDone:()=>Ht});return new Je(p(He(e),Nt(n(K()))))}),TU=d(2,(e,t)=>new Je(p(He(e),Ml(He(t))))),kU=new Je(Ht),fd=d(2,(e,t)=>new Je(p(He(e),xk(t)))),EU=e=>Wk($t(U(e))),CU=d(2,(e,t)=>Gk(e,Uu(t))),IU=d(2,(e,t)=>Gk(e,p_(t))),Hl=d(e=>Cm(e[0]),(e,t,n)=>{const r=n?.bufferSize??16;return n?.switch?hd(n?.concurrency,()=>Uy(e,1,r,t),s=>Uy(e,s,r,t)):hd(n?.concurrency,()=>new Je(wu(He(e),s=>p(s,g_(o=>He(t(o))),y_(Ht,(o,i)=>p(o,Ml(i)))))),s=>new Je(p(He(e),wu(Bl),Nk(o=>He(t(o)),n))))}),hd=(e,t,n)=>{switch(e){case void 0:return t();case"unbounded":return n(Number.MAX_SAFE_INTEGER);default:return e>1?n(e):t()}},Uy=d(4,(e,t,n,r)=>new Je(p(He(e),wu(Bl),Nk(s=>He(r(s)),{concurrency:t,mergeStrategy:AD(),bufferSize:n})))),$m=d(e=>Cm(e[0]),(e,t)=>Hl(e,ne,t)),$U=e=>{const t=Xn({onInput:n=>ke(Bl(n),()=>t),onFailure:_t,onDone:()=>Ht});return new Je(p(He(e),Nt(t)))},AU=e=>{const t=(r,s)=>{const[o,i]=p(r,lA(a=>!tu(a))),c=p(Yd(i),Fe({onNone:()=>s,onSome:Ln({onFailure:a=>Fe(zM(a),{onNone:()=>Ht,onSome:_t}),onSuccess:()=>Ht})}));return p(Re(p(o,p_(a=>tu(a)?U(a.value):K()))),ke(()=>c))},n=Xn({onInput:r=>t(r,n),onFailure:r=>_t(r),onDone:()=>Ht});return new Je(p(He(e),Nt(n)))},qk=e=>$U(AU(p(e,Tu(t=>t.exit)))),He=e=>{if("channel"in e)return e.channel;if(ui(e))return He(Dl(e));throw new TypeError("Expected a Stream.")},RU=e=>new Je(Ku(e)?Ht:Re(e)),Dl=e=>p(e,Al(U),Wk),Wk=e=>new Je(sn(LT(e,{onFailure:Fe({onNone:()=>Ht,onSome:Fr}),onSuccess:t=>Re(Be(t))}))),Jk=(e,t)=>{const n=t?.maxChunkSize??Im;if(t?.scoped){const s=j(Oy(e),o=>vu(o,{maxChunkSize:n,shutdown:!0}));return t.shutdown?j(s,fd(sd(e))):s}const r=Hl(Qk(Oy(e)),s=>vu(s,{maxChunkSize:n}));return t?.shutdown?fd(r,sd(e)):r},OU=e=>Rm(()=>Gd(e)?RU(e):PU(e[Symbol.iterator]())),PU=(e,t=Im)=>p(Qe(()=>{let n=[];const r=s=>p(Qe(()=>{let o=s.next();if(t===1)return o.done?Ht:p(Re(Be(o.value)),ke(()=>r(s)));n=[];let i=0;for(;o.done===!1&&(n.push(o.value),i=i+1,!(i>=t));)o=s.next();return i>0?p(Re(on(n)),ke(()=>r(s))):Ht}),sn);return new Je(r(e))}),GU),vu=(e,t)=>p(JH(e,1,t?.maxChunkSize??Im),Dr(n=>p(WH(e),X(r=>r&&rT(n)?yU():SU(n)))),Yk,t?.shutdown?fd(fc(e)):ne),xU=(...e)=>OU(e),Tu=d(2,(e,t)=>new Je(p(He(e),Nl(g_(t))))),FU=d(3,(e,t,n)=>Rm(()=>{const r=s=>Kc({onInput:o=>p(tt(()=>{const i=[],c=a=>Qe(()=>{i.push(a)});return p(o,ML(s,(a,u)=>p(n(a,u),X(([l,f])=>p(c(f),hs(l))))),LT({onFailure:a=>i.length!==0?Ml(Re(on(i)),Fr(a)):Fr(a),onSuccess:a=>ke(Re(on(i)),()=>r(a))}))}),sn),onFailure:Fr,onDone:()=>Ht});return new Je(p(He(e),Mk(r(t))))})),Gk=d(2,(e,t)=>new Je(p(He(e),Nl(t)))),dd=d(2,(e,t)=>{const n=r=>{const s=r.next();if(s.done)return Xn({onInput:o=>n(o[Symbol.iterator]()),onFailure:_t,onDone:mm});{const o=s.value;return sn(j(t(o),i=>ke(Re(Be(i)),()=>n(r))))}};return new Je(p(He(e),Nt(Pl(()=>n(We()[Symbol.iterator]())))))}),NU=d(3,(e,t,n)=>new Je(p(He(e),wu(Bl),BD(n,t),Nl(Be)))),BU=d(e=>Cm(e[1]),(e,t,n)=>MU(e,t,{onSelf:ne,onOther:ne,haltStrategy:n?.haltStrategy})),MU=d(3,(e,t,n)=>{const r=n.haltStrategy?lU(n.haltStrategy):fU,s=o=>i=>o||!tu(i)?ZD(tt(()=>i)):eU(c=>tt(()=>c));return new Je(Bk(He(Tu(e,n.onSelf)),{other:He(Tu(t,n.onOther)),onSelfDone:s(r._tag==="Either"||r._tag==="Left"),onOtherDone:s(r._tag==="Either"||r._tag==="Right")}))}),LU=e=>HU(p(e,Al(U))),Yk=e=>JU(e,t=>p(j(t,n=>U([n,t])),Ve(Fe({onNone:()=>z(K()),onSome:$t})))),HU=e=>Yk(p(e,j(Be))),Am=d(2,(e,t)=>He(e).pipe(Mk(vm(t)),DD)),DU=e=>Am(e,JD),UU=d(2,(e,t)=>Am(e,YD(t))),KU=e=>Am(e,XD()),jU=d(2,(e,t)=>IU(zU(e,t,{onElement:U,onSchedule:K}),ne)),zU=d(3,(e,t,n)=>{const r=(s,o)=>{const i=o.next();return i.done?Xn({onInput:c=>r(s,c[Symbol.iterator]()),onFailure:_t,onDone:Gn}):sn(JL(s.next(i.value),{onFailure:()=>p(s.last,GL,j(c=>p(Re(Sa(n.onElement(i.value),n.onSchedule(c))),ke(()=>r(s,o)))),Rl(s.reset)),onSuccess:()=>z(p(Re(Be(n.onElement(i.value))),ke(()=>r(s,o))))}))};return new Je(p(kt(tU(t)),ke(s=>p(He(e),Nt(r(s,We()[Symbol.iterator]()))))))}),VU=d(3,(e,t,n)=>new Je(p(Re(Be(t)),ke(()=>He(p(e,FU(t,(r,s)=>p(n(r,s),j(o=>[o,o]))))))))),Qk=e=>new Je(xk(Lk(p(e,j(Be))),ge)),qU=e=>new Je(Hk(t=>e(t).pipe(j(Be)))),Rm=e=>new Je(Pl(()=>He(e()))),WU=d(2,(e,t)=>dd(e,n=>hs(t(n),n))),JU=(e,t)=>Rm(()=>{const n=r=>sn(j(t(r),Fe({onNone:()=>Ht,onSome:([s,o])=>ke(Re(s),()=>n(o))})));return new Je(n(e))}),GU=e=>$m(Dl(e)),YU=e=>$m(Qk(e)),QU=e=>$m(qU(t=>e(t))),XU="effect/GroupBy",Xk=Symbol.for(XU),ZU={_R:e=>e,_E:e=>e,_K:e=>e,_V:e=>e},eK=e=>re(e,Xk),tK=d(e=>eK(e[0]),(e,t,n)=>Hl(e.grouped,([r,s])=>t(r,qk(vu(s,{shutdown:!0}))),{concurrency:"unbounded",bufferSize:n?.bufferSize??16})),nK=e=>({[Xk]:ZU,pipe(){return Y(this,arguments)},grouped:e}),rK=d(e=>typeof e[0]!="function",(e,t,n)=>n?.key?tK(sK(e,n.key,{bufferSize:n.bufferSize}),(r,s)=>dd(s,t)):hd(n?.concurrency,()=>dd(e,t),r=>n?.unordered?Hl(e,s=>Dl(t(s)),{concurrency:r}):NU(e,r,t))),sK=d(e=>typeof e[0]!="function",(e,t,n)=>{const r=(s,o)=>Xn({onInput:i=>ke(kt(En(oK(i,t),([c,a])=>{const u=s.get(c);return u===void 0?p(hm(n?.bufferSize??16),X(l=>p(Qe(()=>{s.set(c,l)}),Ce(jt(o,gU([c,l]))),Ce(p(jt(l,Hy(a)),bf(f=>gf(f)?U(ge):K())))))):bf(jt(u,Hy(a)),l=>gf(l)?U(ge):K())},{discard:!0})),()=>r(s,o)),onFailure:i=>kt(jt(o,mU(i))),onDone:()=>kt(p(En(s.entries(),([i,c])=>p(jt(c,Dy),bf(a=>gf(a)?U(ge):K())),{discard:!0}),Ce(jt(o,Dy))))});return nK(QU(s=>$(function*(){const o=new Map,i=yield*YT();return yield*uc(s,fc(i)),yield*He(e).pipe(Nt(r(o,i)),bm,Tk(s),jn(s),hs(qk(vu(i,{shutdown:!0}))))})))}),oK=d(2,(e,t)=>{const n=[],r=e[Symbol.iterator](),s=new Map;let o;for(;(o=r.next())&&!o.done;){const i=o.value,c=t(i);if(s.has(c))s.get(c).push(i);else{const a=[i];n.push([c,a]),s.set(c,a)}}return on(n.map(i=>[i[0],on(i[1])]))});class Mt{path;actual;issue;_tag="Pointer";constructor(t,n,r){this.path=t,this.actual=n,this.issue=r}}class Ky{actual;message;_tag="Unexpected";constructor(t,n){this.actual=t,this.message=n}}class wi{ast;message;_tag="Missing";actual=void 0;constructor(t,n){this.ast=t,this.message=n}}class rt{ast;actual;issues;output;_tag="Composite";constructor(t,n,r,s){this.ast=t,this.actual=n,this.issues=r,this.output=s}}class $f{ast;actual;kind;issue;_tag="Refinement";constructor(t,n,r,s){this.ast=t,this.actual=n,this.kind=r,this.issue=s}}class Af{ast;actual;kind;issue;_tag="Transformation";constructor(t,n,r,s){this.ast=t,this.actual=n,this.kind=r,this.issue=s}}class or{ast;actual;message;_tag="Type";constructor(t,n,r){this.ast=t,this.actual=n,this.message=r}}class jy{ast;actual;message;_tag="Forbidden";constructor(t,n,r){this.ast=t,this.actual=n,this.message=r}}const zy=Symbol.for("effect/Schema/ParseErrorTypeId");class iK extends uL("ParseError"){[zy]=zy;get message(){return this.toString()}toString(){return Ia.formatIssueSync(this.issue)}toJSON(){return{_id:"ParseError",message:this.toString()}}[Me](){return this.toJSON()}}const cK=e=>new iK({issue:e}),zo=me,Om=oe,Ut=QC,Or=d(2,(e,t)=>Ut(e)?zt(e,{onLeft:oe,onRight:t}):X(e,t)),en=d(2,(e,t)=>Ut(e)?eI(e,t):j(e,t)),Rf=d(2,(e,t)=>Ut(e)?ZC(e,t):Al(e,t)),aK=d(2,(e,t)=>Ut(e)?XC(e,{onLeft:t.onFailure,onRight:t.onSuccess}):DL(e,t)),Zk=d(2,(e,t)=>Ut(e)?zt(e,{onLeft:t,onRight:me}):Ve(e,t)),Ul=(e,t)=>t===void 0||yr(t)?e:e===void 0?t:{...e,...t},uK=(e,t,n)=>{const r=vt(e,t);return(s,o)=>r(s,Ul(n,o))},e0=(e,t,n)=>{const r=uK(e,t,n);return(s,o)=>mb(r(s,o),cK)},t0=(e,t,n)=>{const r=vt(e,t);return(s,o)=>r(s,{...Ul(n,o),isEffectAllowed:!0})},lK=(e,t)=>e0(e.ast,!0,t),fK=(e,t)=>t0(e.ast,!0,t),n0=(e,t)=>t0(e.ast,!1,t),r0=(e,t)=>e0(lt(e.ast),!0,t),hK=(e,t)=>{const n=vt(lt(e.ast),!0);return(r,s)=>Nn(n(r,{exact:!0,...Ul(t,s)}))},dK=be(Symbol.for("effect/ParseResult/decodeMemoMap"),()=>new WeakMap),pK=be(Symbol.for("effect/ParseResult/encodeMemoMap"),()=>new WeakMap),vt=(e,t)=>{const n=t?dK:pK,r=n.get(e);if(r)return r;const s=mK(e,t),o=XI(e),i=$e(o)?(u,l)=>s(u,Ul(l,o.value)):s,c=ZI(e),a=t&&$e(c)?(u,l)=>Oi(Zk(i(u,l),c.value),e,u,l):i;return n.set(e,a),a},Of=e=>Pn(GI(e)),Pf=e=>Pn(YI(e)),mK=(e,t)=>{switch(e._tag){case"Refinement":if(t){const n=vt(e.from,!0);return(r,s)=>{s=s??cf;const o=s?.errors==="all",i=Or(Zk(n(r,s),c=>{const a=new $f(e,r,"From",c);return o&&t$(e)&&c0(c)?Fe(e.filter(r,s,e),{onNone:()=>oe(a),onSome:u=>oe(new rt(e,r,[a,new $f(e,r,"Predicate",u)]))}):oe(a)}),c=>Fe(e.filter(c,s,e),{onNone:()=>me(c),onSome:a=>oe(new $f(e,r,"Predicate",a))}));return Oi(i,e,r,s)}}else{const n=vt(lt(e),!0),r=vt(s0(e.from),!1);return(s,o)=>Oi(Or(n(s,o),i=>r(i,o)),e,s,o)}case"Transformation":{const n=SK(e.transformation,t),r=t?vt(e.from,!0):vt(e.to,!1),s=t?vt(e.to,!0):vt(e.from,!1);return(o,i)=>Oi(Or(Rf(r(o,i),c=>new Af(e,o,t?"Encoded":"Type",c)),c=>Or(Rf(n(c,i??cf,e,o),a=>new Af(e,o,"Transformation",a)),a=>Rf(s(a,i),u=>new Af(e,o,t?"Type":"Encoded",u)))),e,o,i)}case"Declaration":{const n=t?e.decodeUnknown(...e.typeParameters):e.encodeUnknown(...e.typeParameters);return(r,s)=>Oi(n(r,s??cf,e),e,r,s)}case"Literal":return Zt(e,n=>n===e.literal);case"UniqueSymbol":return Zt(e,n=>n===e.symbol);case"UndefinedKeyword":return Zt(e,lC);case"NeverKeyword":return Zt(e,hC);case"UnknownKeyword":case"AnyKeyword":case"VoidKeyword":return me;case"StringKeyword":return Zt(e,yn);case"NumberKeyword":return Zt(e,yr);case"BooleanKeyword":return Zt(e,Vi);case"BigIntKeyword":return Zt(e,$u);case"SymbolKeyword":return Zt(e,Yf);case"ObjectKeyword":return Zt(e,_r);case"Enums":return Zt(e,n=>e.enums.some(([r,s])=>s===n));case"TemplateLiteral":{const n=O$(e);return Zt(e,r=>yn(r)&&n.test(r))}case"TupleType":{const n=e.elements.map(u=>vt(u.type,t)),r=e.rest.map(u=>vt(u.type,t));let s=e.elements.filter(u=>!u.isOptional);e.rest.length>0&&(s=s.concat(e.rest.slice(1)));const o=s.length,i=e.elements.length>0?e.elements.map((u,l)=>l).join(" | "):"never",c=Of(e),a=Pf(e);return(u,l)=>{if(!_I(u))return oe(new or(e,u));const f=l?.errors==="all",h=[];let m=0;const y=[],S=u.length;for(let v=S;v<=o-1;v++){const k=new Mt(v,u,new wi(s[v-S]));if(f){h.push([m++,k]);continue}else return oe(new rt(e,u,k,y))}if(e.rest.length===0)for(let v=e.elements.length;v<=S-1;v++){const k=new Mt(v,u,new Ky(u[v],`is unexpected, expected: ${i}`));if(f){h.push([m++,k]);continue}else return oe(new rt(e,u,k,y))}let _=0,T;for(;_<n.length;_++)if(S<_+1){if(e.elements[_].isOptional)continue}else{const v=n[_],k=v(u[_],l);if(Ut(k)){if(Tt(k)){const R=new Mt(_,u,k.left);if(f){h.push([m++,R]);continue}else return oe(new rt(e,u,R,Sn(y)))}y.push([m++,k.right])}else{const R=m++,w=_;T||(T=[]),T.push(({es:I,output:O})=>X(zs(k),H=>{if(Tt(H)){const x=new Mt(w,u,H.left);return f?(I.push([R,x]),ge):oe(new rt(e,u,x,Sn(O)))}return O.push([R,H.right]),ge}))}}if(wt(r)){const[v,...k]=r;for(;_<S-k.length;_++){const R=v(u[_],l);if(Ut(R))if(Tt(R)){const w=new Mt(_,u,R.left);if(f){h.push([m++,w]);continue}else return oe(new rt(e,u,w,Sn(y)))}else y.push([m++,R.right]);else{const w=m++,I=_;T||(T=[]),T.push(({es:O,output:H})=>X(zs(R),x=>{if(Tt(x)){const E=new Mt(I,u,x.left);return f?(O.push([w,E]),ge):oe(new rt(e,u,E,Sn(H)))}else return H.push([w,x.right]),ge}))}}for(let R=0;R<k.length;R++)if(_+=R,!(S<_+1)){const w=k[R](u[_],l);if(Ut(w)){if(Tt(w)){const I=new Mt(_,u,w.left);if(f){h.push([m++,I]);continue}else return oe(new rt(e,u,I,Sn(y)))}y.push([m++,w.right])}else{const I=m++,O=_;T||(T=[]),T.push(({es:H,output:x})=>X(zs(w),E=>{if(Tt(E)){const V=new Mt(O,u,E.left);return f?(H.push([I,V]),ge):oe(new rt(e,u,V,Sn(x)))}return x.push([I,E.right]),ge}))}}}const C=({es:v,output:k})=>ga(v)?oe(new rt(e,u,Sn(v),Sn(k))):me(Sn(k));if(T&&T.length>0){const v=T;return tt(()=>{const k={es:Ei(h),output:Ei(y)};return X(En(v,R=>R(k),{concurrency:c,batching:a,discard:!0}),()=>C(k))})}return C({output:y,es:h})}}case"TypeLiteral":{if(e.propertySignatures.length===0&&e.indexSignatures.length===0)return Zt(e,dC);const n=[],r={},s=[];for(const l of e.propertySignatures)n.push([vt(l.type,t),l]),r[l.name]=null,s.push(l.name);const o=e.indexSignatures.map(l=>[vt(l.parameter,t),vt(l.type,t),l.parameter]),i=_n.make(e.indexSignatures.map(l=>l.parameter).concat(s.map(l=>Yf(l)?new o$(l):new Wa(l)))),c=vt(i,t),a=Of(e),u=Pf(e);return(l,f)=>{if(!mC(l))return oe(new or(e,l));const h=f?.errors==="all",m=[];let y=0;const S=f?.onExcessProperty==="error",_=f?.onExcessProperty==="preserve",T={};let C;if(S||_){C=Reflect.ownKeys(l);for(const w of C){const I=c(w,f);if(Ut(I)&&Tt(I))if(S){const O=new Mt(w,l,new Ky(l[w],`is unexpected, expected: ${String(i)}`));if(h){m.push([y++,O]);continue}else return oe(new rt(e,l,O,T))}else T[w]=l[w]}}let v;const k=f?.exact===!0;for(let w=0;w<n.length;w++){const I=n[w][1],O=I.name,H=Object.prototype.hasOwnProperty.call(l,O);if(!H){if(I.isOptional)continue;if(k){const V=new Mt(O,l,new wi(I));if(h){m.push([y++,V]);continue}else return oe(new rt(e,l,V,T))}}const x=n[w][0],E=x(l[O],f);if(Ut(E)){if(Tt(E)){const V=new Mt(O,l,H?E.left:new wi(I));if(h){m.push([y++,V]);continue}else return oe(new rt(e,l,V,T))}T[O]=E.right}else{const V=y++,q=O;v||(v=[]),v.push(({es:D,output:B})=>X(zs(E),F=>{if(Tt(F)){const ue=new Mt(q,l,H?F.left:new wi(I));return h?(D.push([V,ue]),ge):oe(new rt(e,l,ue,B))}return B[q]=F.right,ge}))}}for(let w=0;w<o.length;w++){const I=o[w],O=I[0],H=I[1],x=Eb(l,I[2]);for(const E of x){const V=O(E,f);if(Ut(V)&&Nn(V)){const q=H(l[E],f);if(Ut(q))if(Tt(q)){const D=new Mt(E,l,q.left);if(h){m.push([y++,D]);continue}else return oe(new rt(e,l,D,T))}else Object.prototype.hasOwnProperty.call(r,E)||(T[E]=q.right);else{const D=y++,B=E;v||(v=[]),v.push(({es:F,output:ue})=>X(zs(q),je=>{if(Tt(je)){const Wt=new Mt(B,l,je.left);return h?(F.push([D,Wt]),ge):oe(new rt(e,l,Wt,ue))}else return Object.prototype.hasOwnProperty.call(r,E)||(ue[E]=je.right),ge}))}}}}const R=({es:w,output:I})=>{if(ga(w))return oe(new rt(e,l,Sn(w),I));if(f?.propertyOrder==="original"){const O=C||Reflect.ownKeys(l);for(const x of s)O.indexOf(x)===-1&&O.push(x);const H={};for(const x of O)Object.prototype.hasOwnProperty.call(I,x)&&(H[x]=I[x]);return me(H)}return me(I)};if(v&&v.length>0){const w=v;return tt(()=>{const I={es:Ei(m),output:Object.assign({},T)};return X(En(w,O=>O(I),{concurrency:a,batching:u,discard:!0}),()=>R(I))})}return R({es:m,output:T})}}case"Union":{const n=gK(e.types,t),r=Reflect.ownKeys(n.keys),s=r.length,o=e.types.length,i=new Map;for(let u=0;u<o;u++)i.set(e.types[u],vt(e.types[u],t));const c=Of(e)??1,a=Pf(e);return(u,l)=>{const f=[];let h=0,m=[];if(s>0)if(Id(u))for(let _=0;_<s;_++){const T=r[_],C=n.keys[T].buckets;if(Object.prototype.hasOwnProperty.call(u,T)){const v=String(u[T]);if(Object.prototype.hasOwnProperty.call(C,v))m=m.concat(C[v]);else{const{candidates:k,literals:R}=n.keys[T],w=_n.make(R),I=k.length===o?new Pr([new At(T,w,!1,!0)],[]):_n.make(k);f.push([h++,new rt(I,u,new Mt(T,u,new or(w,u[T])))])}}else{const{candidates:v,literals:k}=n.keys[T],R=new At(T,_n.make(k),!1,!0),w=v.length===o?new Pr([R],[]):_n.make(v);f.push([h++,new rt(w,u,new Mt(T,u,new wi(R)))])}}else{const _=n.candidates.length===o?e:_n.make(n.candidates);f.push([h++,new or(_,u)])}n.otherwise.length>0&&(m=m.concat(n.otherwise));let y;for(let _=0;_<m.length;_++){const T=m[_],C=i.get(T)(u,l);if(Ut(C)&&(!y||y.length===0)){if(Nn(C))return C;f.push([h++,C.left])}else{const v=h++;y||(y=[]),y.push(k=>tt(()=>"finalResult"in k?ge:X(zs(C),R=>(Nn(R)?k.finalResult=R:k.es.push([v,R.left]),ge))))}}const S=_=>ga(_)?_.length===1&&_[0][1]._tag==="Type"?oe(_[0][1]):oe(new rt(e,u,Sn(_))):oe(new or(e,u));if(y&&y.length>0){const _=y;return tt(()=>{const T={es:Ei(f)};return X(En(_,C=>C(T),{concurrency:c,batching:a,discard:!0}),()=>"finalResult"in T?T.finalResult:S(T.es))})}return S(f)}}case"Suspend":{const n=Cb(()=>vt(e.f(),t));return(r,s)=>n()(r,s)}}},Zt=(e,t)=>n=>t(n)?me(n):oe(new or(e,n)),Ri=(e,t)=>{switch(e._tag){case"Declaration":{const n=qb(e);if($e(n))return Ri(n.value,t);break}case"TypeLiteral":{const n=[];for(let r=0;r<e.propertySignatures.length;r++){const s=e.propertySignatures[r],o=t?oh(s.type):lt(s.type);Bi(o)&&!s.isOptional&&n.push([s.name,o])}return n}case"TupleType":{const n=[];for(let r=0;r<e.elements.length;r++){const s=e.elements[r],o=t?oh(s.type):lt(s.type);Bi(o)&&!s.isOptional&&n.push([r,o])}return n}case"Refinement":return Ri(e.from,t);case"Suspend":return Ri(e.f(),t);case"Transformation":return Ri(t?e.from:e.to,t)}return[]},gK=(e,t)=>{const n={},r=[],s=[];for(let o=0;o<e.length;o++){const i=e[o],c=Ri(i,t);if(c.length>0){s.push(i);for(let a=0;a<c.length;a++){const[u,l]=c[a],f=String(l.literal);n[u]=n[u]||{buckets:{},literals:[],candidates:[]};const h=n[u].buckets;if(Object.prototype.hasOwnProperty.call(h,f)){if(a<c.length-1)continue;h[f].push(i),n[u].literals.push(l),n[u].candidates.push(i)}else{h[f]=[i],n[u].literals.push(l),n[u].candidates.push(i);break}}}else r.push(i)}return{keys:n,otherwise:r,candidates:s}},s0=e=>lo(e)?s0(e.from):e,Oi=(e,t,n,r)=>{if(r?.isEffectAllowed===!0||Ut(e))return e;const s=new $v,o=ss(e,{scheduler:s});s.flush();const i=o.unsafePoll();if(i){if(tu(i))return me(i.value);const c=i.cause;return DM(c)?oe(c.error):oe(new jy(t,n,VM(c)))}return oe(new jy(t,n,"cannot be be resolved synchronously, this is caused by using runSync on an effect that performs async work"))},yK=([e],[t])=>e>t?1:e<t?-1:0;function Sn(e){return e.sort(yK).map(t=>t[1])}const SK=(e,t)=>{switch(e._tag){case"FinalTransformation":return t?e.decode:e.encode;case"ComposeTransformation":return me;case"TypeLiteralTransformation":return n=>{let r=me(n);for(const s of e.propertySignatureTransformations){const[o,i]=t?[s.from,s.to]:[s.to,s.from],c=t?s.decode:s.encode;r=en(r,u=>{const l=c(Object.prototype.hasOwnProperty.call(u,o)?U(u[o]):K());return delete u[o],$e(l)&&(u[i]=l.value),u})}return r}}},Dt=(e,t=[])=>({value:e,forest:t}),Ia={formatIssue:e=>en(Zs(e),bK),formatIssueSync:e=>{const t=Ia.formatIssue(e);return Ut(t)?nI(t):QL(t)},formatError:e=>Ia.formatIssue(e.issue),formatErrorSync:e=>Ia.formatIssueSync(e.issue)},bK=e=>e.value+o0(`
`,e.forest),o0=(e,t)=>{let n="";const r=t.length;let s;for(let o=0;o<r;o++){s=t[o];const i=o===r-1;n+=e+(i?"":"")+" "+s.value,n+=o0(e+(r>1&&!i?"  ":"   "),s.forest)}return n},_K=e=>{switch(e){case"Encoded":return"Encoded side transformation failure";case"Transformation":return"Transformation process failure";case"Type":return"Type side transformation failure"}},wK=e=>{switch(e){case"From":return"From side refinement failure";case"Predicate":return"Predicate refinement failure"}},i0=e=>"ast"in e?U(e.ast):K(),pd=me(void 0),vK=e=>i0(e).pipe(Xo(WI),Fe({onNone:()=>pd,onSome:t=>{const n=t(e);return yn(n)?me({message:n,override:!1}):ui(n)?j(n,r=>({message:r,override:!1})):yn(n.message)?me({message:n.message,override:n.override}):j(n.message,r=>({message:r,override:n.override}))}})),Pm=e=>t=>t._tag===e,c0=Pm("Composite"),Vy=Pm("Refinement"),qy=Pm("Transformation"),Di=e=>Or(vK(e),t=>t!==void 0?!t.override&&(c0(e)||Vy(e)&&e.kind==="From"||qy(e)&&e.kind!=="Transformation")?qy(e)||Vy(e)?Di(e.issue):pd:me(t.message):pd),a0=e=>i0(e).pipe(Xo(QI),aI(t=>t(e)),Pn);function TK(e){return Vb(e).pipe(lr(()=>jb(e)),lr(()=>zb(e)),lr(()=>Nu(e)),qe(()=>`{ ${e.from} | filter }`))}function kK(e){return e.message!==void 0?e.message:`Expected ${lo(e.ast)?TK(e.ast):String(e.ast)}, actual ${jr(e.actual)}`}const EK=e=>en(Di(e),t=>t??a0(e)??kK(e)),sa=e=>a0(e)??String(e.ast),CK=e=>e.message??"is forbidden",IK=e=>e.message??"is unexpected",$K=e=>{const t=JI(e.ast);if($e(t)){const n=t.value();return yn(n)?me(n):n}return me(e.message??"is missing")},Zs=e=>{switch(e._tag){case"Type":return en(EK(e),Dt);case"Forbidden":return me(Dt(sa(e),[Dt(CK(e))]));case"Unexpected":return me(Dt(IK(e)));case"Missing":return en($K(e),Dt);case"Transformation":return Or(Di(e),t=>t!==void 0?me(Dt(t)):en(Zs(e.issue),n=>Dt(sa(e),[Dt(_K(e.kind),[n])])));case"Refinement":return Or(Di(e),t=>t!==void 0?me(Dt(t)):en(Zs(e.issue),n=>Dt(sa(e),[Dt(wK(e.kind),[n])])));case"Pointer":return en(Zs(e.issue),t=>Dt($b(e.path),[t]));case"Composite":return Or(Di(e),t=>{if(t!==void 0)return me(Dt(t));const n=sa(e);return Ib(e.issues)?en(En(e.issues,Zs),r=>Dt(n,r)):en(Zs(e.issues),r=>Dt(n,[r]))})}},AK=d(e=>_r(e[0]),(e,...t)=>{const n={};for(const r of t)r in e&&(n[r]=e[r]);return n}),RK=d(e=>_r(e[0]),(e,...t)=>{const n={...e};for(const r of t)delete n[r];return n}),Vo=Symbol.for("effect/Schema");function ut(e){return class{[Vo]=md;static ast=e;static annotations(n){return ut(Tr(this.ast,n))}static pipe(){return Y(this,arguments)}static toString(){return String(e)}static Type;static Encoded;static Context;static[Vo]=md}}const md={_A:e=>e,_I:e=>e,_R:e=>e},Wy={typeConstructor:UI,schemaId:jI,message:Ob,missingMessage:Ud,identifier:Fu,title:Qn,description:ei,examples:Pb,default:xb,documentation:zI,jsonSchema:Fb,arbitrary:Nb,pretty:Bb,equivalence:Mb,concurrency:Lb,batching:Hb,parseIssueTitle:Db,parseOptions:Ub,decodingFallback:Kb},Wc=e=>{if(!e)return{};const t={...e};for(const n in Wy)if(n in e){const r=Wy[n];t[r]=e[n],delete t[n]}return t},Tr=(e,t)=>qd(e,Wc(t)),OK=e=>ut(oh(e.ast)),On=e=>ut(lt(e.ast)),br=e=>re(e,Vo)&&_r(e[Vo]);function PK(e){return zd(e)?_n.make(v$(e,t=>new Wa(t))):new Wa(e[0])}function u0(e,t=PK(e)){return class extends ut(t){static annotations(r){return u0(this.literals,Tr(this.ast,r))}static literals=[...e]}}function Jc(...e){return wt(e)?u0(e):d0}const xK=(e,t,n)=>xm(e,new Bu(e.map(r=>r.ast),(...r)=>t.decode(...r.map(ut)),(...r)=>t.encode(...r.map(ut)),Wc(n))),FK=(e,t)=>{const n=()=>(s,o,i)=>e(s)?zo(s):Om(new or(i,s)),r=n;return xm([],new Bu([],n,r,Wc(t)))};function xm(e,t){return class extends ut(t){static annotations(r){return xm(this.typeParameters,Tr(this.ast,r))}static typeParameters=[...e]}}const l0=function(){if(Array.isArray(arguments[0])){const n=arguments[0],r=arguments[1],s=arguments[2];return xK(n,r,s)}const e=arguments[0],t=arguments[1];return FK(e,t)};class f0 extends ut(Xf){}class h0 extends ut(s$){}class d0 extends ut(Kd){}class Kl extends ut(Jb){}class NK extends ut(m$){}class g extends ut(Zf){}class N extends ut(th){}class ve extends ut(nh){}const BK=e=>_n.make(e.map(t=>t.ast));function p0(e,t=BK(e)){return class extends ut(t){static annotations(r){return p0(this.members,Tr(this.ast,r))}static members=[...e]}}function De(...e){return zd(e)?p0(e):wt(e)?e[0]:d0}const we=e=>De(e,h0),Pi=e=>De(e,f0),xf=e=>De(e,h0,f0),MK=(e,t)=>new jd(e.map(n=>br(n)?new Is(n.ast,!1):n.ast),t.map(n=>br(n)?new Mu(n.ast):n.ast),!0);function m0(e,t,n=MK(e,t)){return class extends ut(n){static annotations(s){return m0(this.elements,this.rest,Tr(this.ast,s))}static elements=[...e];static rest=[...t]}}function g0(e,t){return class extends m0([],[e],t){static annotations(r){return g0(this.value,Tr(this.ast,r))}static value=e}}const fe=e=>g0(e),gd=e=>e?'"?:"':'":"';class hc extends Is{isReadonly;defaultValue;_tag="PropertySignatureDeclaration";constructor(t,n,r,s,o){super(t,n,s),this.isReadonly=r,this.defaultValue=o}toString(){const t=gd(this.isOptional),n=String(this.type);return`PropertySignature<${t}, ${n}, never, ${t}, ${n}>`}}class y0 extends Is{isReadonly;fromKey;constructor(t,n,r,s,o){super(t,n,s),this.isReadonly=r,this.fromKey=o}}class jl extends Is{isReadonly;defaultValue;constructor(t,n,r,s,o){super(t,n,s),this.isReadonly=r,this.defaultValue=o}}const LK=e=>e===void 0?"never":yn(e)?JSON.stringify(e):String(e);class zl{from;to;decode;encode;_tag="PropertySignatureTransformation";constructor(t,n,r,s){this.from=t,this.to=n,this.decode=r,this.encode=s}toString(){return`PropertySignature<${gd(this.to.isOptional)}, ${this.to.type}, ${LK(this.from.fromKey)}, ${gd(this.from.isOptional)}, ${this.from.type}>`}}const S0=(e,t)=>{switch(e._tag){case"PropertySignatureDeclaration":return new hc(e.type,e.isOptional,e.isReadonly,{...e.annotations,...t},e.defaultValue);case"PropertySignatureTransformation":return new zl(e.from,new jl(e.to.type,e.to.isOptional,e.to.isReadonly,{...e.to.annotations,...t},e.to.defaultValue),e.decode,e.encode)}},b0=Symbol.for("effect/PropertySignature"),Fm=e=>re(e,b0);class Vl{ast;[Vo];[b0]=null;_TypeToken;_Key;_EncodedToken;_HasDefault;constructor(t){this.ast=t}pipe(){return Y(this,arguments)}annotations(t){return new Vl(S0(this.ast,Wc(t)))}toString(){return String(this.ast)}}const ku=e=>new Vl(e);class ql extends Vl{from;constructor(t,n){super(t),this.from=n}annotations(t){return new ql(S0(this.ast,Wc(t)),this.from)}}const oa=d(2,(e,t)=>{const n=e.ast;switch(n._tag){case"PropertySignatureDeclaration":return ku(new hc(n.type,n.isOptional,n.isReadonly,n.annotations,t));case"PropertySignatureTransformation":return ku(new zl(n.from,new jl(n.to.type,n.to.isOptional,n.to.isReadonly,n.to.annotations,t),n.decode,n.encode))}}),Er=(e,t,n)=>ku(new zl(new y0(e.ast,!0,!0,{},void 0),new jl(t.ast,!1,!0,{},void 0),r=>U(n.decode(r)),Xo(n.encode))),Jy=(e,t,n)=>ku(new zl(new y0(e.ast,!0,!0,{},void 0),new jl(t.ast,!0,!0,{},void 0),n.decode,n.encode)),HK=(e,t)=>{const n=t?.exact,r=t?.default,s=t?.nullable,o=t?.as=="Option",i=t?.onNoneEncoding?lr(t.onNoneEncoding):ne;if(n){if(r)return s?oa(Er(we(e),On(e),{decode:Fe({onNone:r,onSome:c=>c===null?r():c}),encode:U}),r).ast:oa(Er(e,On(e),{decode:Fe({onNone:r,onSome:ne}),encode:U}),r).ast;if(o){const c=Qy(On(e));return s?Er(we(e),c,{decode:pi(nf),encode:i}).ast:Er(e,c,{decode:ne,encode:ne}).ast}else return s?Jy(we(e),On(e),{decode:pi(nf),encode:ne}).ast:new hc(e.ast,!0,!0,{},void 0)}else{if(r)return s?oa(Er(xf(e),On(e),{decode:Fe({onNone:r,onSome:c=>c??r()}),encode:U}),r).ast:oa(Er(Pi(e),On(e),{decode:Fe({onNone:r,onSome:c=>c===void 0?r():c}),encode:U}),r).ast;if(o){const c=Qy(On(e));return s?Er(xf(e),c,{decode:pi(a=>a!=null),encode:i}).ast:Er(Pi(e),c,{decode:pi(fC),encode:i}).ast}else return s?Jy(xf(e),Pi(On(e)),{decode:pi(nf),encode:ne}).ast:new hc(Pi(e).ast,!0,!0,{},void 0)}},b=e=>{const t=e.ast===Xf||e.ast===Kd?Xf:Pi(e).ast;return new ql(new hc(t,!0,!0,{},void 0),e)},_0=d(e=>br(e[0]),(e,t)=>new ql(HK(e,t),e)),DK=n_([Ud]),UK=(e,t)=>{const n=Reflect.ownKeys(e),r=[];if(n.length>0){const o=[],i=[],c=[];for(let a=0;a<n.length;a++){const u=n[a],l=e[u];if(Fm(l)){const f=l.ast;switch(f._tag){case"PropertySignatureDeclaration":{const h=f.type,m=f.isOptional,y=f.annotations;o.push(new At(u,h,m,!0,DK(f))),i.push(new At(u,lt(h),m,!0,y)),r.push(new At(u,h,m,!0,y));break}case"PropertySignatureTransformation":{const h=f.from.fromKey??u;o.push(new At(h,f.from.type,f.from.isOptional,!0,f.from.annotations)),i.push(new At(u,f.to.type,f.to.isOptional,!0,f.to.annotations)),c.push(new I$(h,u,f.decode,f.encode));break}}}else o.push(new At(u,l.ast,!1,!0)),i.push(new At(u,lt(l.ast),!1,!0)),r.push(new At(u,l.ast,!1,!0))}if(wt(c)){const a=[],u=[];for(const l of t){const{indexSignatures:f,propertySignatures:h}=mg(l.key.ast,l.value.ast);h.forEach(m=>{o.push(m),i.push(new At(m.name,lt(m.type),m.isOptional,m.isReadonly,m.annotations))}),f.forEach(m=>{a.push(m),u.push(new Lu(m.parameter,lt(m.type),m.isReadonly))})}return new to(new Pr(o,a,{[uo]:"Struct (Encoded side)"}),new Pr(i,u,{[uo]:"Struct (Type side)"}),new sh(c))}}const s=[];for(const o of t){const{indexSignatures:i,propertySignatures:c}=mg(o.key.ast,o.value.ast);c.forEach(a=>r.push(a)),i.forEach(a=>s.push(a))}return new Pr(r,s)},w0=(e,t)=>{const n=Reflect.ownKeys(e);for(const r of n){const s=e[r];if(t[r]===void 0&&Fm(s)){const o=s.ast,i=o._tag==="PropertySignatureDeclaration"?o.defaultValue:o.to.defaultValue;i!==void 0&&(t[r]=i())}}return t};function Nm(e,t,n=UK(e,t)){return class extends ut(n){static annotations(s){return Nm(this.fields,this.records,Tr(this.ast,s))}static fields={...e};static records=[...t];static make=(s,o)=>{const i=w0(e,{...s});return I0(o)?i:r0(this)(i)};static pick(...s){return A(AK(e,...s))}static omit(...s){return A(RK(e,...s))}}}function A(e,...t){return Nm(e,t)}function v0(e,t,n){return class extends Nm({},[{key:e,value:t}],n){static annotations(s){return v0(e,t,Tr(this.ast,s))}static key=e;static value=t}}const Gy=e=>v0(e.key,e.value),vi=(e,t,n)=>{if(dg(e)&&dg(t)){const r=[...e.propertySignatures];for(const s of t.propertySignatures){const o=s.name,i=r.findIndex(c=>c.name===o);if(i===-1)r.push(s);else{const{isOptional:c,type:a}=r[i];r[i]=new At(o,Eu(a,s.type,n.concat(o)),c,!0)}}return new Pr(r,e.indexSignatures.concat(t.indexSignatures))}throw new Error(Ab(e,t,n))},KK=P$([Fu]),Ti=(e,t)=>t.map(n=>new Xb(n,e.filter,KK(e))),Eu=(e,t,n)=>_n.make(tr([e],[t],n)),Gr=e=>Vd(e)?e.types:[e],tr=(e,t,n)=>za(e,r=>za(t,s=>{switch(s._tag){case"Literal":{if(yn(s.literal)&&eh(r)||yr(s.literal)&&lg(r)||Vi(s.literal)&&fg(r))return[s];break}case"StringKeyword":{if(s===Zf){if(eh(r)||Bi(r)&&yn(r.literal))return[r];if(lo(r))return Ti(r,tr(Gr(r.from),[s],n))}else if(r===Zf)return[s];break}case"NumberKeyword":{if(s===th){if(lg(r)||Bi(r)&&yr(r.literal))return[r];if(lo(r))return Ti(r,tr(Gr(r.from),[s],n))}else if(r===th)return[s];break}case"BooleanKeyword":{if(s===nh){if(fg(r)||Bi(r)&&Vi(r.literal))return[r];if(lo(r))return Ti(r,tr(Gr(r.from),[s],n))}else if(r===nh)return[s];break}case"Union":return tr(Gr(r),s.types,n);case"Suspend":return[new Ja(()=>Eu(r,s.f(),n))];case"Refinement":return Ti(s,tr(Gr(r),Gr(s.from),n));case"TypeLiteral":{switch(r._tag){case"Union":return tr(r.types,[s],n);case"Suspend":return[new Ja(()=>Eu(r.f(),s,n))];case"Refinement":return Ti(r,tr(Gr(r.from),[s],n));case"TypeLiteral":return[vi(r,s,n)];case"Transformation":{const o=r.transformation,i=vi(r.from,s,n),c=vi(r.to,lt(s),n);switch(o._tag){case"TypeLiteralTransformation":return[new to(i,c,new sh(o.propertySignatureTransformations))];case"ComposeTransformation":return[new to(i,c,C$)];case"FinalTransformation":return[new to(i,c,new Zb((a,u,l,f)=>en(o.decode(a,u,l,f),h=>({...a,...h})),(a,u,l,f)=>en(o.encode(a,u,l,f),h=>({...a,...h}))))]}}}break}case"Transformation":{if(T$(r)){if(pg(s.transformation)&&pg(r.transformation))return[new to(vi(r.from,s.from,n),vi(r.to,s.to,n),new sh(s.transformation.propertySignatureTransformations.concat(r.transformation.propertySignatureTransformations)))]}else return tr([s],[r],n);break}}throw new Error(Ab(r,s,n))})),jK=d(2,(e,t)=>ut(Eu(e.ast,t.ast,[]))),zK=Symbol.for("effect/SchemaId/Refine");function T0(e,t,n){return class extends ut(n){static annotations(s){return T0(this.from,this.to,Tr(this.ast,s))}static from=e;static to=t}}const yd=d(e=>br(e[0])&&br(e[1]),(e,t,n)=>T0(e,t,new to(e.ast,t.ast,new Zb(n.decode,n.encode)))),VK=d(e=>br(e[0])&&br(e[1]),(e,t,n)=>yd(e,t,{strict:!0,decode:(r,s,o,i)=>zo(n.decode(r,i)),encode:(r,s,o,i)=>zo(n.encode(r,i))})),qK=(e,t,n,r)=>aK(e,{onFailure:s=>new rt(n,r,s),onSuccess:t}),WK=e=>e._tag==="None"?K():U(e.value),JK=(e,t)=>n=>n.oneof(t,n.record({_tag:n.constant("None")}),n.record({_tag:n.constant("Some"),value:e(n)})).map(WK),GK=e=>Fe({onNone:()=>"none()",onSome:t=>`some(${e(t)})`}),Yy=e=>(t,n,r)=>oI(t)?Ue(t)?zo(K()):qK(e(t.value,n),U,r,t):Om(new or(r,t)),Qy=e=>l0([e],{decode:t=>Yy(fK(t)),encode:t=>Yy(n0(t))},{typeConstructor:{_tag:"effect/Option"},pretty:GK,arbitrary:JK,equivalence:lI}),YK=e=>br(e)||Fm(e),k0=e=>Reflect.ownKeys(e).every(t=>YK(e[t])),Bm=e=>"fields"in e?e.fields:Bm(e[zK]),E0=e=>k0(e)?A(e):br(e)?e:A(Bm(e)),C0=e=>k0(e)?e:Bm(e),$n=e=>(t,n)=>$a({kind:"Class",identifier:e,schema:E0(t),fields:C0(t),Base:cL,annotations:n}),Ff=(e,t)=>{const n={...e};for(const r of Reflect.ownKeys(t)){if(r in e)throw new Error(Rb(r));n[r]=t[r]}return n};function I0(e){return Vi(e)?e:e?.disableValidation??!1}const Xy=be("effect/Schema/astCache",()=>new WeakMap),QK=e=>e===void 0?[]:Array.isArray(e)?e:[e],$a=({Base:e,annotations:t,disableToString:n,fields:r,identifier:s,kind:o,schema:i})=>{const c=Symbol.for(`effect/Schema/${o}/${s}`),[a,u,l]=QK(t),f=On(i),h=f.annotations({identifier:s,...a}),m=f.annotations({[uo]:`${s} (Type side)`,...a}),y=i.annotations({[uo]:`${s} (Constructor)`,...a}),S=i.annotations({[uo]:`${s} (Encoded side)`,...l}),_=i.annotations({...l,...a,...u}),T=v=>re(v,c)&&hK(m)(v),C=class extends e{constructor(v={},k=!1){v={...v},v=w0(r,v),I0(k)||(v=r0(y)(v)),super(v,!0)}static[Vo]=md;static get ast(){let v=Xy.get(this);if(v)return v;const k=l0([i],{decode:()=>(R,w,I)=>R instanceof this||T(R)?zo(R):Om(new or(I,R)),encode:()=>(R,w)=>R instanceof this?zo(R):en(n0(m)(R,w),I=>new this(I,!0))},{identifier:s,pretty:R=>w=>`${s}(${R(w)})`,arbitrary:R=>w=>R(w).map(I=>new this(I)),equivalence:ne,[qa]:h.ast,...a});return v=VK(S,k,{strict:!0,decode:R=>new this(R,!0),encode:ne}).annotations({[qa]:_.ast,...u}).ast,Xy.set(this,v),v}static pipe(){return Y(this,arguments)}static annotations(v){return ut(this.ast).annotations(v)}static toString(){return`(${String(S)} <-> ${s})`}static make(...v){return new this(...v)}static fields={...r};static identifier=s;static extend(v){return(k,R)=>{const w=C0(k),I=E0(k),O=Ff(r,w);return $a({kind:o,identifier:v,schema:jK(i,I),fields:O,Base:this,annotations:R})}}static transformOrFail(v){return(k,R,w)=>{const I=Ff(r,k);return $a({kind:o,identifier:v,schema:yd(i,On(A(I)),R),fields:I,Base:this,annotations:w})}}static transformOrFailFrom(v){return(k,R,w)=>{const I=Ff(r,k);return $a({kind:o,identifier:v,schema:yd(OK(i),A(I),R),fields:I,Base:this,annotations:w})}}get[c](){return c}};return n!==!0&&Object.defineProperty(C.prototype,"toString",{value(){return`${s}({ ${Reflect.ownKeys(r).map(v=>`${Od(v)}: ${jr(this[v])}`).join(", ")} })`},configurable:!0,writable:!0}),C},XK=wU,Zy=kU,ZK=EU,qo=CU,ej=Dl,tj=Jk,nj=Tu,eS=rK,tS=BU,$0=LU,gr=DU,Yn=UU,rj=KU,sj=VU,A0=jU,ps=WU,nS=Symbol.for("effect/Subscribable"),oj=pT,ij="effect/SubscriptionRef",cj=Symbol.for(ij),aj={_A:e=>e};class uj extends ai{ref;pubsub;semaphore;[Uo]=Uo;[nS]=nS;[uF]=Pp;[oj]=mT;[cj]=aj;constructor(t,n,r){super(),this.ref=t,this.pubsub=n,this.semaphore=r,this.get=Li(this.ref)}commit(){return this.get}get;get changes(){return p(Li(this.ref),X(t=>j(Jk(this.pubsub,{scoped:!0}),n=>TU(xU(t),n))),this.semaphore.withPermits(1),YU)}modify(t){return this.modifyEffect(n=>z(t(n)))}modifyEffect(t){return p(Li(this.ref),X(t),X(([n,r])=>p(rv(this.ref,r),hs(n),Rl(fm(this.pubsub,r)))),this.semaphore.withPermits(1))}}const lj=e=>Li(e.ref),fj=e=>p(ze([GT(),Fp(e),cm(1)]),j(([t,n,r])=>new uj(n,t,r))),hj=d(2,(e,t)=>p(rv(e.ref,t),Rl(fm(e.pubsub,t)),e.semaphore.withPermits(1))),Lt=lj,Rt=fj,Pt=hj,nn=sv;function dj(){if(typeof globalThis>"u")return;const e=globalThis.localStorage;if(e)try{const t=e.getItem("__CHAIN_EFFECT_DEBUG__");if(t===null)return;const n=t.trim();return n.length===0?void 0:n==="true"||n==="1"?!0:n==="false"||n==="0"?!1:n}catch{return}}function pj(){if(typeof globalThis>"u")return;const t=globalThis.__CHAIN_EFFECT_DEBUG__;if(typeof t=="boolean")return t;if(typeof t=="string")return t.trim()===""?void 0:t}function mj(e){if(!e.startsWith("/"))return null;const t=e.lastIndexOf("/");if(t<=0)return null;const n=e.slice(1,t),r=e.slice(t+1);try{return new RegExp(n,r)}catch{return null}}function gj(e){const t=pj()??dj();if(t===!0)return!0;if(!t)return!1;const n=mj(t);return n?n.test(e):e.includes(t)}function yj(){if(typeof globalThis>"u")return null;const t=globalThis.__CHAIN_EFFECT_LOG__;return typeof t=="function"?t:null}function Hn(e){if(e instanceof Error)return e.message;if(typeof e=="string")return e;try{return JSON.stringify(e)}catch{return String(e)}}function pt(e,...t){if(!gj(e))return;const n=yj();n&&n("[chain-effect]",e,...t)}class Sj{constructor(){this.keyToValue=new Map,this.valueToKey=new Map}set(t,n){this.keyToValue.set(t,n),this.valueToKey.set(n,t)}getByKey(t){return this.keyToValue.get(t)}getByValue(t){return this.valueToKey.get(t)}clear(){this.keyToValue.clear(),this.valueToKey.clear()}}class R0{constructor(t){this.generateIdentifier=t,this.kv=new Sj}register(t,n){this.kv.getByValue(t)||(n||(n=this.generateIdentifier(t)),this.kv.set(n,t))}clear(){this.kv.clear()}getIdentifier(t){return this.kv.getByValue(t)}getValue(t){return this.kv.getByKey(t)}}class bj extends R0{constructor(){super(t=>t.name),this.classToAllowedProps=new Map}register(t,n){typeof n=="object"?(n.allowProps&&this.classToAllowedProps.set(t,n.allowProps),super.register(t,n.identifier)):super.register(t,n)}getAllowedProps(t){return this.classToAllowedProps.get(t)}}function _j(e){if("values"in Object)return Object.values(e);const t=[];for(const n in e)e.hasOwnProperty(n)&&t.push(e[n]);return t}function wj(e,t){const n=_j(e);if("find"in n)return n.find(t);const r=n;for(let s=0;s<r.length;s++){const o=r[s];if(t(o))return o}}function Wo(e,t){Object.entries(e).forEach(([n,r])=>t(r,n))}function Aa(e,t){return e.indexOf(t)!==-1}function rS(e,t){for(let n=0;n<e.length;n++){const r=e[n];if(t(r))return r}}class vj{constructor(){this.transfomers={}}register(t){this.transfomers[t.name]=t}findApplicable(t){return wj(this.transfomers,n=>n.isApplicable(t))}findByName(t){return this.transfomers[t]}}const Tj=e=>Object.prototype.toString.call(e).slice(8,-1),O0=e=>typeof e>"u",kj=e=>e===null,dc=e=>typeof e!="object"||e===null||e===Object.prototype?!1:Object.getPrototypeOf(e)===null?!0:Object.getPrototypeOf(e)===Object.prototype,Sd=e=>dc(e)&&Object.keys(e).length===0,Ur=e=>Array.isArray(e),Ej=e=>typeof e=="string",Cj=e=>typeof e=="number"&&!isNaN(e),Ij=e=>typeof e=="boolean",$j=e=>e instanceof RegExp,pc=e=>e instanceof Map,mc=e=>e instanceof Set,P0=e=>Tj(e)==="Symbol",Aj=e=>e instanceof Date&&!isNaN(e.valueOf()),x0=e=>e instanceof Error,sS=e=>typeof e=="number"&&isNaN(e),Rj=e=>Ij(e)||kj(e)||O0(e)||Cj(e)||Ej(e)||P0(e),Oj=e=>typeof e=="bigint",Pj=e=>e===1/0||e===-1/0,xj=e=>ArrayBuffer.isView(e)&&!(e instanceof DataView),Fj=e=>e instanceof URL,bd=e=>e.replace(/\\/g,"\\\\").replace(/\./g,"\\."),Nf=e=>e.map(String).map(bd).join("."),Ui=(e,t)=>{const n=[];let r="";for(let o=0;o<e.length;o++){let i=e.charAt(o);if(!t&&i==="\\"){const u=e.charAt(o+1);if(u==="\\"){r+="\\",o++;continue}else if(u!==".")throw Error("invalid path")}if(i==="\\"&&e.charAt(o+1)==="."){r+=".",o++;continue}if(i==="."){n.push(r),r="";continue}r+=i}const s=r;return n.push(s),n};function An(e,t,n,r){return{isApplicable:e,annotation:t,transform:n,untransform:r}}const F0=[An(O0,"undefined",()=>null,()=>{}),An(Oj,"bigint",e=>e.toString(),e=>typeof BigInt<"u"?BigInt(e):(console.error("Please add a BigInt polyfill."),e)),An(Aj,"Date",e=>e.toISOString(),e=>new Date(e)),An(x0,"Error",(e,t)=>{const n={name:e.name,message:e.message};return"cause"in e&&(n.cause=e.cause),t.allowedErrorProps.forEach(r=>{n[r]=e[r]}),n},(e,t)=>{const n=new Error(e.message,{cause:e.cause});return n.name=e.name,n.stack=e.stack,t.allowedErrorProps.forEach(r=>{n[r]=e[r]}),n}),An($j,"regexp",e=>""+e,e=>{const t=e.slice(1,e.lastIndexOf("/")),n=e.slice(e.lastIndexOf("/")+1);return new RegExp(t,n)}),An(mc,"set",e=>[...e.values()],e=>new Set(e)),An(pc,"map",e=>[...e.entries()],e=>new Map(e)),An(e=>sS(e)||Pj(e),"number",e=>sS(e)?"NaN":e>0?"Infinity":"-Infinity",Number),An(e=>e===0&&1/e===-1/0,"number",()=>"-0",Number),An(Fj,"URL",e=>e.toString(),e=>new URL(e))];function Wl(e,t,n,r){return{isApplicable:e,annotation:t,transform:n,untransform:r}}const N0=Wl((e,t)=>P0(e)?!!t.symbolRegistry.getIdentifier(e):!1,(e,t)=>["symbol",t.symbolRegistry.getIdentifier(e)],e=>e.description,(e,t,n)=>{const r=n.symbolRegistry.getValue(t[1]);if(!r)throw new Error("Trying to deserialize unknown symbol");return r}),Nj=[Int8Array,Uint8Array,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Float64Array,Uint8ClampedArray].reduce((e,t)=>(e[t.name]=t,e),{}),B0=Wl(xj,e=>["typed-array",e.constructor.name],e=>[...e],(e,t)=>{const n=Nj[t[1]];if(!n)throw new Error("Trying to deserialize unknown typed array");return new n(e)});function M0(e,t){return e?.constructor?!!t.classRegistry.getIdentifier(e.constructor):!1}const L0=Wl(M0,(e,t)=>["class",t.classRegistry.getIdentifier(e.constructor)],(e,t)=>{const n=t.classRegistry.getAllowedProps(e.constructor);if(!n)return{...e};const r={};return n.forEach(s=>{r[s]=e[s]}),r},(e,t,n)=>{const r=n.classRegistry.getValue(t[1]);if(!r)throw new Error(`Trying to deserialize unknown class '${t[1]}' - check https://github.com/blitz-js/superjson/issues/116#issuecomment-773996564`);return Object.assign(Object.create(r.prototype),e)}),H0=Wl((e,t)=>!!t.customTransformerRegistry.findApplicable(e),(e,t)=>["custom",t.customTransformerRegistry.findApplicable(e).name],(e,t)=>t.customTransformerRegistry.findApplicable(e).serialize(e),(e,t,n)=>{const r=n.customTransformerRegistry.findByName(t[1]);if(!r)throw new Error("Trying to deserialize unknown custom value");return r.deserialize(e)}),Bj=[L0,N0,H0,B0],oS=(e,t)=>{const n=rS(Bj,s=>s.isApplicable(e,t));if(n)return{value:n.transform(e,t),type:n.annotation(e,t)};const r=rS(F0,s=>s.isApplicable(e,t));if(r)return{value:r.transform(e,t),type:r.annotation}},D0={};F0.forEach(e=>{D0[e.annotation]=e});const Mj=(e,t,n)=>{if(Ur(t))switch(t[0]){case"symbol":return N0.untransform(e,t,n);case"class":return L0.untransform(e,t,n);case"custom":return H0.untransform(e,t,n);case"typed-array":return B0.untransform(e,t,n);default:throw new Error("Unknown transformation: "+t)}else{const r=D0[t];if(!r)throw new Error("Unknown transformation: "+t);return r.untransform(e,n)}},io=(e,t)=>{if(t>e.size)throw new Error("index out of bounds");const n=e.keys();for(;t>0;)n.next(),t--;return n.next().value};function U0(e){if(Aa(e,"__proto__"))throw new Error("__proto__ is not allowed as a property");if(Aa(e,"prototype"))throw new Error("prototype is not allowed as a property");if(Aa(e,"constructor"))throw new Error("constructor is not allowed as a property")}const Lj=(e,t)=>{U0(t);for(let n=0;n<t.length;n++){const r=t[n];if(mc(e))e=io(e,+r);else if(pc(e)){const s=+r,o=+t[++n]==0?"key":"value",i=io(e,s);switch(o){case"key":e=i;break;case"value":e=e.get(i);break}}else e=e[r]}return e},_d=(e,t,n)=>{if(U0(t),t.length===0)return n(e);let r=e;for(let o=0;o<t.length-1;o++){const i=t[o];if(Ur(r)){const c=+i;r=r[c]}else if(dc(r))r=r[i];else if(mc(r)){const c=+i;r=io(r,c)}else if(pc(r)){if(o===t.length-2)break;const a=+i,u=+t[++o]==0?"key":"value",l=io(r,a);switch(u){case"key":r=l;break;case"value":r=r.get(l);break}}}const s=t[t.length-1];if(Ur(r)?r[+s]=n(r[+s]):dc(r)&&(r[s]=n(r[s])),mc(r)){const o=io(r,+s),i=n(o);o!==i&&(r.delete(o),r.add(i))}if(pc(r)){const o=+t[t.length-2],i=io(r,o);switch(+s==0?"key":"value"){case"key":{const a=n(i);r.set(a,r.get(i)),a!==i&&r.delete(i);break}case"value":{r.set(i,n(r.get(i)));break}}}return e},K0=e=>e<1;function wd(e,t,n,r=[]){if(!e)return;const s=K0(n);if(!Ur(e)){Wo(e,(c,a)=>wd(c,t,n,[...r,...Ui(a,s)]));return}const[o,i]=e;i&&Wo(i,(c,a)=>{wd(c,t,n,[...r,...Ui(a,s)])}),t(o,r)}function Hj(e,t,n,r){return wd(t,(s,o)=>{e=_d(e,o,i=>Mj(i,s,r))},n),e}function Dj(e,t,n){const r=K0(n);function s(o,i){const c=Lj(e,Ui(i,r));o.map(a=>Ui(a,r)).forEach(a=>{e=_d(e,a,()=>c)})}if(Ur(t)){const[o,i]=t;o.forEach(c=>{e=_d(e,Ui(c,r),()=>e)}),i&&Wo(i,s)}else Wo(t,s);return e}const Uj=(e,t)=>dc(e)||Ur(e)||pc(e)||mc(e)||x0(e)||M0(e,t);function Kj(e,t,n){const r=n.get(e);r?r.push(t):n.set(e,[t])}function jj(e,t){const n={};let r;return e.forEach(s=>{if(s.length<=1)return;t||(s=s.map(c=>c.map(String)).sort((c,a)=>c.length-a.length));const[o,...i]=s;o.length===0?r=i.map(Nf):n[Nf(o)]=i.map(Nf)}),r?Sd(n)?[r]:[r,n]:Sd(n)?void 0:n}const j0=(e,t,n,r,s=[],o=[],i=new Map)=>{const c=Rj(e);if(!c){Kj(e,s,t);const m=i.get(e);if(m)return r?{transformedValue:null}:m}if(!Uj(e,n)){const m=oS(e,n),y=m?{transformedValue:m.value,annotations:[m.type]}:{transformedValue:e};return c||i.set(e,y),y}if(Aa(o,e))return{transformedValue:null};const a=oS(e,n),u=a?.value??e,l=Ur(u)?[]:{},f={};Wo(u,(m,y)=>{if(y==="__proto__"||y==="constructor"||y==="prototype")throw new Error(`Detected property ${y}. This is a prototype pollution risk, please remove it from your object.`);const S=j0(m,t,n,r,[...s,y],[...o,e],i);l[y]=S.transformedValue,Ur(S.annotations)?f[bd(y)]=S.annotations:dc(S.annotations)&&Wo(S.annotations,(_,T)=>{f[bd(y)+"."+T]=_})});const h=Sd(f)?{transformedValue:l,annotations:a?[a.type]:void 0}:{transformedValue:l,annotations:a?[a.type,f]:f};return c||i.set(e,h),h};function z0(e){return Object.prototype.toString.call(e).slice(8,-1)}function iS(e){return z0(e)==="Array"}function zj(e){if(z0(e)!=="Object")return!1;const t=Object.getPrototypeOf(e);return!!t&&t.constructor===Object&&t===Object.prototype}function Vj(e,t,n,r,s){const o={}.propertyIsEnumerable.call(r,t)?"enumerable":"nonenumerable";o==="enumerable"&&(e[t]=n),s&&o==="nonenumerable"&&Object.defineProperty(e,t,{value:n,enumerable:!1,writable:!0,configurable:!0})}function vd(e,t={}){if(iS(e))return e.map(s=>vd(s,t));if(!zj(e))return e;const n=Object.getOwnPropertyNames(e),r=Object.getOwnPropertySymbols(e);return[...n,...r].reduce((s,o)=>{if(o==="__proto__"||iS(t.props)&&!t.props.includes(o))return s;const i=e[o],c=vd(i,t);return Vj(s,o,c,e,t.nonenumerable),s},{})}class Pe{constructor({dedupe:t=!1}={}){this.classRegistry=new bj,this.symbolRegistry=new R0(n=>n.description??""),this.customTransformerRegistry=new vj,this.allowedErrorProps=[],this.dedupe=t}serialize(t){const n=new Map,r=j0(t,n,this,this.dedupe),s={json:r.transformedValue};r.annotations&&(s.meta={...s.meta,values:r.annotations});const o=jj(n,this.dedupe);return o&&(s.meta={...s.meta,referentialEqualities:o}),s.meta&&(s.meta.v=1),s}deserialize(t,n){const{json:r,meta:s}=t;let o=n?.inPlace?r:vd(r);return s?.values&&(o=Hj(o,s.values,s.v??0,this)),s?.referentialEqualities&&(o=Dj(o,s.referentialEqualities,s.v??0)),o}stringify(t){return JSON.stringify(this.serialize(t))}parse(t){return this.deserialize(JSON.parse(t),{inPlace:!0})}registerClass(t,n){this.classRegistry.register(t,n)}registerSymbol(t,n){this.symbolRegistry.register(t,n)}registerCustom(t,n){this.customTransformerRegistry.register({name:n,...t})}allowErrorProps(...t){this.allowedErrorProps.push(...t)}}Pe.defaultInstance=new Pe;Pe.serialize=Pe.defaultInstance.serialize.bind(Pe.defaultInstance);Pe.deserialize=Pe.defaultInstance.deserialize.bind(Pe.defaultInstance);Pe.stringify=Pe.defaultInstance.stringify.bind(Pe.defaultInstance);Pe.parse=Pe.defaultInstance.parse.bind(Pe.defaultInstance);Pe.registerClass=Pe.defaultInstance.registerClass.bind(Pe.defaultInstance);Pe.registerSymbol=Pe.defaultInstance.registerSymbol.bind(Pe.defaultInstance);Pe.registerCustom=Pe.defaultInstance.registerCustom.bind(Pe.defaultInstance);Pe.allowErrorProps=Pe.defaultInstance.allowErrorProps.bind(Pe.defaultInstance);const V0=new Pe({dedupe:!0});class q0 extends $n("AmountValue")({raw:g,decimals:N,symbol:g,formatted:b(g)}){}class TW extends $n("AddressParams")({address:g}){}class kW extends $n("TxHistoryParams")({address:g,limit:_0(N,{default:()=>20}),page:b(N)}){}class EW extends $n("TransactionParams")({txHash:g}){}class CW extends $n("BalanceOutput")({amount:q0,symbol:g}){}class qj extends $n("TokenMetadata")({possibleSpam:b(ve),securityScore:b(we(N)),verified:b(ve),totalSupply:b(g)}){}class Wj extends $n("TokenBalance")({symbol:g,name:g,amount:q0,isNative:ve,decimals:N,icon:b(g),contractAddress:b(g),metadata:b(qj)}){}fe(Wj);const Jj=Jc("native","token","nft"),Gj=Jc("in","out","self"),Yj=Jc("transfer","approve","swap","stake","unstake","claim","bridge","contract","mint","burn","gift","grab","trust","signFor","emigrate","immigrate","issueAsset","increaseAsset","destroyAsset","issueEntity","destroyEntity","locationName","dapp","certificate","mark","signature","unknown"),W0=Jc("pending","confirming","confirmed","failed");class Qj extends $n("Asset")({assetType:Jj,value:g,symbol:g,decimals:N,contractAddress:b(g),name:b(g),logoUrl:b(g),tokenId:b(g)}){}class Xj extends $n("FeeInfo")({value:g,symbol:g,decimals:N}){}class J0 extends $n("Transaction")({hash:g,from:g,to:g,timestamp:N,status:W0,blockNumber:b(NK),action:Yj,direction:Gj,assets:fe(Qj),fee:b(Xj),nonce:b(N),fromEntity:b(g),toEntity:b(g),summary:b(g)}){}fe(J0);we(J0);class IW extends $n("TransactionStatusOutput")({status:W0,confirmations:N,requiredConfirmations:N}){}const Mm="chain-effect-http-cache";function Zj(e){return typeof e=="object"&&e!==null}function Ra(e){if(typeof e=="bigint")return e.toString();if(!Zj(e))return Array.isArray(e)?e.map(Ra):e;if(Array.isArray(e))return e.map(Ra);const t={};for(const n of Object.keys(e).slice().sort())t[n]=Ra(e[n]);return t}function ez(e){return JSON.stringify(Ra(e))}function Lm(e,t){if(!t)return e;const n=btoa(ez(t)).replace(/[+/=]/g,r=>r==="+"?"-":r==="/"?"_":"");return`${e}?__body=${n}`}function Hm(e){return new Request(e,{method:"GET"})}const tz=(e,t,n)=>Ms({try:async()=>{const r=Mm,s=await caches.open(r),o=Lm(e,t),i=Hm(o),c=await s.match(i);if(!c)return K();const a=await c.json();return U({data:a.data,timestamp:a.timestamp,fromCache:!0})},catch:()=>new Error("Cache read failed")}).pipe(Ve(()=>z(K()))),Bf=(e,t,n,r)=>Ms({try:async()=>{const s=Mm,o=await caches.open(s),i=Lm(e,t),c=Hm(i),a={data:n,timestamp:Date.now()},u=new Response(JSON.stringify(a),{headers:{"Content-Type":"application/json","X-Cache-Timestamp":String(a.timestamp)}});await o.put(c,u)},catch:()=>new Error("Cache write failed")}).pipe(Ve(()=>ge)),nz=(e,t,n)=>Ms({try:async()=>{const r=Mm,s=await caches.open(r),o=Lm(e,t),i=Hm(o);return s.delete(i)},catch:()=>new Error("Cache delete failed")}).pipe(Ve(()=>z(!1)));class ct{constructor(t,n,r){this.message=t,this.status=n,this.body=r}_tag="HttpError"}class cS{constructor(t,n){this.message=t,this.retryAfter=n}_tag="RateLimitError"}class rz{constructor(t,n){this.message=t,this.errors=n}_tag="SchemaError"}class $W extends Error{_tag="NoSupportError";constructor(t="This feature is not supported by the provider"){super(t),this.name="NoSupportError"}}class AW extends Error{constructor(t="This service is limited",n){super(t),this.reason=n,this.name="ServiceLimitedError"}_tag="ServiceLimitedError"}function sz(e,t){if(!t)return e;let n=e;for(const[r,s]of Object.entries(t))n=n.replace(`:${r}`,encodeURIComponent(String(s)));return n}function oz(e,t){if(!t)return e;const n=new URL(e);for(const[r,s]of Object.entries(t))s!==void 0&&n.searchParams.set(r,String(s));return n.toString()}function vn(e){const{url:t,method:n="GET",pathParams:r,searchParams:s,headers:o={},body:i,schema:c,timeout:a=3e4,cache:u}=e;let l=sz(t,r);return l=oz(l,s),Ms({try:async()=>{const f=new AbortController,h=setTimeout(()=>f.abort(),a);try{const m={method:n,headers:{"Content-Type":"application/json",...o},signal:f.signal,cache:u};n==="POST"&&i!==void 0&&(m.body=G0(i));const y=await fetch(l,m);if(clearTimeout(h),y.status===429){const _=y.headers.get("retry-after");throw new cS("Rate limit exceeded",_?parseInt(_,10):void 0)}if(!y.ok){const _=await y.text().catch(()=>"");throw new ct(`HTTP ${y.status}: ${y.statusText}`,y.status,_.slice(0,500))}const S=await y.json();return c?lK(c)(S):S}finally{clearTimeout(h)}},catch:f=>f instanceof cS||f instanceof ct||f instanceof rz?f:f instanceof Error&&f.name==="AbortError"?new ct(`Request timeout after ${a}ms`):new ct(f instanceof Error?f.message:String(f))})}jk(ae(1e3),2).pipe(Tm(km(3)));Em(Qd(5)).pipe(Tm(km(3)));const Mf=new Map;function iz(e){return typeof e=="object"&&e!==null}function Oa(e){if(typeof e=="bigint")return e.toString();if(!iz(e))return Array.isArray(e)?e.map(Oa):e;if(Array.isArray(e))return e.map(Oa);const t={};for(const n of Object.keys(e).slice().sort())t[n]=Oa(e[n]);return t}function G0(e){return JSON.stringify(Oa(e))}function cz(e,t){if(!t)return e;const n=btoa(G0(t)).replace(/[+/=]/g,r=>r==="+"?"-":r==="/"?"_":"");return`${e}?__body=${n}`}function te(e){const{cacheStrategy:t="ttl",cacheTtl:n=5e3,canCache:r,...s}=e,o=cz(e.url,e.body);return W(async()=>{const i=Mf.get(o);if(i)return pt("httpFetchCached pending",e.url),i;const c=async u=>{if(!r)return!0;try{return await r(u)}catch(l){return pt("httpFetchCached can-cache error",e.url,Hn(l)),!1}},a=(async()=>{const u=await J(tz(e.url,e.body)),l=$e(u)?u.value.data:null,f=$e(u)?await c(u.value.data):!1;if($e(u)&&!f&&await J(nz(e.url,e.body)),t==="cache-first"){if($e(u)&&f&&l!==null)return pt("httpFetchCached cache-first hit",e.url),l;pt("httpFetchCached cache-first miss",e.url);try{const h=await J(vn(s));return await c(h)&&await J(Bf(e.url,e.body,h)),h}catch(h){throw pt("httpFetchCached cache-first fetch error",e.url,Hn(h)),h}}if(t==="network-first")try{pt("httpFetchCached network-first fetch",e.url);const h=await J(vn(s));return await c(h)&&await J(Bf(e.url,e.body,h)),h}catch(h){if(pt("httpFetchCached network-first fetch error",e.url,Hn(h)),$e(u)&&f&&l!==null)return pt("httpFetchCached network-first fallback",e.url),l;throw h}if($e(u)&&f){const h=Date.now()-u.value.timestamp;if(h<n)return pt("httpFetchCached ttl hit",e.url,`age=${h}ms`,`ttl=${n}ms`),l;pt("httpFetchCached ttl expired",e.url,`age=${h}ms`,`ttl=${n}ms`)}else pt("httpFetchCached ttl miss",e.url);try{const h=await J(vn(s));return await c(h)&&await J(Bf(e.url,e.body,h)),h}catch(h){throw pt("httpFetchCached ttl fetch error",e.url,Hn(h)),h}})();Mf.set(o,a);try{return await a}finally{Mf.delete(o)}})}function az(e){return typeof e=="object"&&e!==null}function Ki(e){return Array.isArray(e)?`array(len=${e.length})`:az(e)?"hash"in e?`object(hash=${String(e.hash)})`:"symbol"in e?`object(symbol=${String(e.symbol)})`:"object":String(e)}function nr(e,...t){pt(e,...t)}const Te=e=>$(function*(){const{fetch:t,interval:n,events:r,walletEvents:s,immediate:o=!0}=e,i=yield*Rt(null),c=$0(t).pipe(A0(Em(n))),a=r?r.pipe(eS(()=>t)):Zy,u=s?s.eventBus.forWalletEvents(s.chainId,s.address,s.types).pipe(eS(()=>t)):Zy,h=yield*tS(tS(c,a),u).pipe(XK).pipe(Yn(m=>$(function*(){nr(`${e.name} poll`,Ki(m)),yield*Pt(i,m)})),it);if(o){const m=yield*Ve(t,()=>z(null));m!==null&&(nr(`${e.name} initial`,Ki(m)),yield*Pt(i,m))}return{ref:i,fiber:h,get:Lt(i),changes:i.changes.pipe(qo(m=>m!==null)),refresh:$(function*(){const m=yield*t;return yield*Pt(i,m),m}),stop:xe(h).pipe(Ae)}}),Le=e=>$(function*(){const{name:t,dependsOn:n,hasChanged:r,fetch:s}=e,o=yield*Rt(null),i=yield*Lt(n),c=n.changes.pipe(qo(u=>u!==null),sj({prev:i},(u,l)=>$(function*(){if(nr(`${t} dep`,Ki(l)),r(u.prev,l)){const h=u.prev!==null;nr(`${t} fetch`,h?"force":"cache");const m=yield*Ve(s(l,h),y=>(nr(`${t} fetch error`,Hn(y)),z(null)));m!==null&&(nr(`${t} set`,Ki(m)),yield*Pt(o,m))}else nr(`${t} skip`,"unchanged");return{prev:l}})),gr),a=yield*it(c);if(i!==null){const u=yield*Ve(s(i,!1),l=>(nr(`${t} initial fetch error`,Hn(l)),z(null)));u!==null&&(nr(`${t} initial`,Ki(u)),yield*Pt(o,u))}return{ref:o,fiber:a,get:Lt(o),changes:o.changes.pipe(qo(u=>u!==null)),refresh:$(function*(){const u=yield*Lt(n);if(u===null)return yield*$t(new Error("Dependency not available"));const l=yield*s(u,!0);return yield*Pt(o,l),l}),stop:xe(a).pipe(Ae)}}),uz=$(function*(){const e=yield*GT(),t=tj(e);return{emit:n=>fm(e,n),stream:t,forWallet:(n,r)=>t.pipe(qo(s=>s.chainId===n&&s.address.toLowerCase()===r.toLowerCase())),forWalletEvents:(n,r,s)=>t.pipe(qo(o=>o.chainId===n&&o.address.toLowerCase()===r.toLowerCase()&&s.includes(o.type))),shutdown:sd(e)}}),lz=(e,t,n)=>({type:"tx:confirmed",chainId:e,address:t,txHash:n,timestamp:Date.now()}),fz="chain-effect-snapshots",hz=1,Kr="snapshots",Y0=3,Dm=new Map;let ia=null;function Jl(){return typeof indexedDB<"u"}function Um(){return Jl()?ia||(ia=new Promise((e,t)=>{const n=indexedDB.open(fz,hz);n.addEventListener("error",()=>t(n.error)),n.addEventListener("success",()=>e(n.result)),n.onupgradeneeded=r=>{const s=r.target.result;s.objectStoreNames.contains(Kr)||s.createObjectStore(Kr,{keyPath:"key"})}}),ia):Promise.reject(new Error("IndexedDB is not available"))}function Km(e){const t=Dm.get(e);return t||null}function dz(e){Dm.set(e.key,e)}function jm(e){Dm.delete(e)}async function zm(e){if(!Jl())return Km(e);try{const t=await Um(),n=await new Promise((s,o)=>{const a=t.transaction(Kr,"readonly").objectStore(Kr).get(e);a.addEventListener("error",()=>o(a.error)),a.addEventListener("success",()=>s(a.result??null))});if(!n)return null;if(n.serializerVersion!==Y0)return await Gl(e),null;const r=V0.parse(n.payload);return{key:n.key,data:r,timestamp:n.timestamp}}catch{return null}}async function Jo(e){if(dz(e),!!Jl())try{const t=await Um();await new Promise((n,r)=>{const i=t.transaction(Kr,"readwrite").objectStore(Kr).put({key:e.key,payload:V0.stringify(e.data),timestamp:e.timestamp,serializerVersion:Y0});i.addEventListener("error",()=>r(i.error)),i.addEventListener("success",()=>n())})}catch{}}async function Gl(e){if(jm(e),!!Jl())try{const t=await Um();await new Promise((n,r)=>{const i=t.transaction(Kr,"readwrite").objectStore(Kr).delete(e);i.addEventListener("error",()=>r(i.error)),i.addEventListener("success",()=>n())})}catch{}}function Td(e){return typeof e=="object"&&e!==null}function Pa(e){if(typeof e=="bigint")return e.toString();if(!Td(e))return Array.isArray(e)?e.map(Pa):e;if(Array.isArray(e))return e.map(Pa);const t={};for(const n of Object.keys(e).slice().sort())t[n]=Pa(e[n]);return t}function Q0(e){return JSON.stringify(Pa(e))}function aS(e){if(Array.isArray(e)){const t=e[0];if(Td(t)&&"hash"in t){const n=typeof t.hash=="string"?t.hash:String(t.hash);return`array(len=${e.length}, firstHash=${n})`}return`array(len=${e.length})`}return Td(e)?"hash"in e?`object(hash=${typeof e.hash=="string"?e.hash:String(e.hash)})`:"symbol"in e?`object(symbol=${typeof e.symbol=="string"?e.symbol:String(e.symbol)})`:"object":String(e)}function Cr(e,...t){pt(e,...t)}const pz="chain-effect:snapshot";function X0(e,t){return`${pz}:${e}:${t}`}function Vm(e,t){return Number.isFinite(t)?Date.now()-e>t:!1}function Z0(e,t){const n=Km(e);return n?Vm(n.timestamp,t)?(jm(e),null):n:null}function Se(e,t){const n=new Map,r=i=>i==null?"__empty__":Q0(i),s=async i=>{const c=r(i),a=n.get(c);if(a)return a.refCount++,Cr(`${e} reuse source`,c,`refs=${a.refCount}`),a.source;Cr(`${e} create source`,c);const u=await J(t(i));return n.set(c,{source:u,refCount:1}),u},o=i=>{const c=r(i),a=n.get(c);a&&(a.refCount--,a.refCount<=0&&(ss(a.source.stop),n.delete(c)))};return{name:e,async fetch(i){const c=await s(i);try{const a=await J(c.get);return a===null?J(c.refresh):a}finally{o(i)}},subscribe(i,c,a){let u=!1,l=null;return Cr(`${e} subscribe`,r(i)),s(i).then(f=>{if(u){o(i);return}let h=!0;const m=Yn(f.changes,S=>Qe(()=>{u||(Cr(`${e} emit`,h?"initial":"update",aS(S)),c(S,h?"initial":"update"),h=!1)})).pipe(Dr(S=>Qe(()=>{u||(Cr(`${e} changes stream failed`,Hn(S)),a?.(S))}))),y=ss(m);l=()=>{ss(xe(y)),o(i)}}).catch(f=>{Cr(`${e} getOrCreateSource failed`,Hn(f)),a?.(f)}),()=>{u=!0,l?.()}},useState(i,c){const a=c?.enabled!==!1,u=c?.useSnapshot!==!1,l=c?.snapshotMaxAgeMs??Number.POSITIVE_INFINITY,f=G.useMemo(()=>r(i),[i]),h=G.useMemo(()=>X0(e,f),[f]),m=G.useMemo(()=>u?Z0(h,l):null,[h,l,u]),[y,S]=G.useState(()=>a?!m:!1),[_,T]=G.useState(!1),[C,v]=G.useState(void 0),k=G.useRef(i);k.current=i;const R=G.useRef(this),w=G.useRef(m?.data),I=G.useRef(m?{key:h,timestamp:m.timestamp}:null),O=G.useRef(null),H=G.useRef(h);H.current!==h&&(H.current=h,m?(w.current=m.data,I.current={key:h,timestamp:m.timestamp}):(w.current=void 0,I.current=null)),G.useEffect(()=>{if(!a||!u)return;let D=!0;return(async()=>{const B=await zm(h);if(!D||!B)return;if(Vm(B.timestamp,l)){await Gl(h);return}const F=I.current;F&&F.key===h&&F.timestamp>=B.timestamp||(w.current=B.data,I.current={key:h,timestamp:B.timestamp},S(!1),O.current?.())})(),()=>{D=!1}},[a,h,l,u]);const x=G.useCallback(D=>{if(O.current=D,!a)return w.current=void 0,()=>{};const B=w.current!==void 0;S(!B),T(!0),v(void 0),Cr(`${e} subscribe`,f);const F=R.current.subscribe(k.current,ue=>{const je=Date.now();w.current=ue,I.current={key:h,timestamp:je},u&&Jo({key:h,data:ue,timestamp:je}),S(!1),T(!1),v(void 0),Cr(`${e} storeChange`,aS(ue)),D()});return()=>{O.current=null,F()}},[a,f,h,u]),E=G.useCallback(()=>w.current,[]),V=G.useSyncExternalStore(x,E,E),q=G.useCallback(async()=>{if(a){T(!0),v(void 0);try{const D=await s(k.current),B=await J(D.refresh),F=Date.now();w.current=B,I.current={key:h,timestamp:F},u&&Jo({key:h,data:B,timestamp:F})}catch(D){v(D instanceof Error?D:new Error(String(D)))}finally{T(!1),S(!1)}}},[a,h,u]);return G.useEffect(()=>{a||(w.current=void 0,S(!1),T(!1),v(void 0))},[a]),G.useEffect(()=>{!a||!u||S(!m)},[a,m,u]),{data:V,isLoading:y,isFetching:_,error:C,refetch:q}},invalidate(){for(const[i,c]of n)ss(c.source.stop);n.clear()}}}function eE(e,t,n){const r=new Map,s=3e4,o=i=>i==null?"__empty__":Q0(i);return{name:e,async fetch(i){const c=o(i),a=r.get(c),u=Date.now();if(a&&u-a.timestamp<s)return a.value;const l=t(i),f=await J(rj(l).pipe(X(h=>h._tag==="Some"?z(h.value):$t(new Error("No data")))));return r.set(c,{value:f,timestamp:u}),f},subscribe(i,c){let a=!0,u=!1;const l=t(i),f=Yn(l,m=>Qe(()=>{if(u)return;const y=o(i);r.set(y,{value:m,timestamp:Date.now()}),c(m,a?"initial":"update"),a=!1})),h=ss(f);return()=>{u=!0,ss(xe(h))}},useState(i,c){const a=c?.enabled!==!1,u=c?.useSnapshot!==!1,l=c?.snapshotMaxAgeMs??Number.POSITIVE_INFINITY,f=G.useMemo(()=>o(i),[i]),h=G.useMemo(()=>X0(e,f),[f]),m=G.useMemo(()=>{const F=r.get(f);return!F||Date.now()-F.timestamp>=s?null:{key:h,data:F.value,timestamp:F.timestamp}},[f,h]),y=G.useMemo(()=>u?Z0(h,l):null,[h,l,u]),S=G.useMemo(()=>u?m?y?m.timestamp>=y.timestamp?m:y:m:y:m,[m,y,u]),[_,T]=G.useState(()=>a?!S:!1),[C,v]=G.useState(!1),[k,R]=G.useState(void 0),w=G.useRef(i);w.current=i;const I=G.useRef(this),O=G.useRef(S?.data),H=G.useRef(S?{key:h,timestamp:S.timestamp}:null),x=G.useRef(null),E=G.useRef(h);E.current!==h&&(E.current=h,S?(O.current=S.data,H.current={key:h,timestamp:S.timestamp}):(O.current=void 0,H.current=null)),G.useEffect(()=>{if(!a||!u)return;let F=!0;return(async()=>{const ue=await zm(h);if(!F||!ue)return;if(Vm(ue.timestamp,l)){await Gl(h);return}const je=H.current;je&&je.key===h&&je.timestamp>=ue.timestamp||(O.current=ue.data,H.current={key:h,timestamp:ue.timestamp},T(!1),x.current?.())})(),()=>{F=!1}},[a,h,l,u]);const V=G.useCallback(F=>{if(x.current=F,!a)return O.current=void 0,()=>{};const ue=O.current!==void 0;T(!ue),v(!0),R(void 0);const je=I.current.subscribe(w.current,Wt=>{const Hs=Date.now();O.current=Wt,H.current={key:h,timestamp:Hs},u&&Jo({key:h,data:Wt,timestamp:Hs}),T(!1),v(!1),R(void 0),F()});return()=>{x.current=null,je()}},[a,h,u]),q=G.useCallback(()=>O.current,[]),D=G.useSyncExternalStore(V,q,q),B=G.useCallback(async()=>{if(a){v(!0),R(void 0);try{r.delete(o(w.current));const F=await I.current.fetch(w.current),ue=Date.now();O.current=F,H.current={key:h,timestamp:ue},u&&Jo({key:h,data:F,timestamp:ue})}catch(F){R(F instanceof Error?F:new Error(String(F)))}finally{v(!1),T(!1)}}},[a,h,u]);return G.useEffect(()=>{a||(O.current=void 0,T(!1),v(!1),R(void 0))},[a]),G.useEffect(()=>{!a||!u||T(!S)},[a,S,u]),{data:D,isLoading:_,isFetching:C,error:k,refetch:B}},invalidate(){r.clear()}}}const mz="chain-effect-poll-meta",gz=1,Go="poll-meta";let ca=null;function tE(){return ca||(ca=new Promise((e,t)=>{const n=indexedDB.open(mz,gz);n.addEventListener("error",()=>t(n.error)),n.addEventListener("success",()=>e(n.result)),n.onupgradeneeded=r=>{const s=r.target.result;s.objectStoreNames.contains(Go)||s.createObjectStore(Go,{keyPath:"key"})}}),ca)}const yz=e=>Ms({try:async()=>{const t=await tE();return new Promise((n,r)=>{const i=t.transaction(Go,"readonly").objectStore(Go).get(e);i.addEventListener("error",()=>r(i.error)),i.addEventListener("success",()=>n(i.result??null))})},catch:t=>new Error(`Failed to get poll meta: ${t}`)}).pipe(Ve(()=>z(null))),Sz=e=>Ms({try:async()=>{const t=await tE();return new Promise((n,r)=>{const i=t.transaction(Go,"readwrite").objectStore(Go).put(e);i.addEventListener("error",()=>r(i.error)),i.addEventListener("success",()=>n())})},catch:t=>new Error(`Failed to set poll meta: ${t}`)}).pipe(Ve(()=>ge)),Lf=(e,t)=>$(function*(){const n=Date.now(),r={key:e,nextPollTime:n+t,lastSuccessTime:n,interval:t};yield*Sz(r)}),bz=(e,t)=>$(function*(){const n=yield*yz(e);if(!n)return 0;const r=Date.now(),s=n.nextPollTime-r,o=t??n.interval;return s>o?0:Math.max(0,s)}),bo=new Map,Hf=new Map;function Yl(e,t,n){return`${e}:${t.toLowerCase()}:${n}`}function Ql(e,t){return W(async()=>{const n=bo.get(e);if(n)if(n.pollFiber){const o=await J(F2(n.pollFiber));if(!Sv(o))return n.refCount++,n.source;bo.delete(e)}else return n.refCount++,n.source;const r=Hf.get(e);if(r){const o=await r,i=bo.get(e);return i&&i.refCount++,o}const s=_z(e,t);Hf.set(e,s);try{return await s}finally{Hf.delete(e)}})}async function _z(e,t){return J($(function*(){const n=yield*Rt(null),r=Gi(Jt(t.interval)),s=e,o=$(function*(){const l=yield*bz(s,r);pt(`${s} poll fiber started`,`delay=${l}ms`,`interval=${r}ms`),l>0&&(yield*zL(ae(l))),yield*$0($(function*(){pt(`${s} polling`);const f=yield*Ve(t.fetch,h=>(pt(`${s} poll error`,Hn(h)),z(null)));return f!==null&&(pt(`${s} poll success`,"update ref"),yield*Pt(n,f),yield*Lf(s,r)),f})).pipe(A0(Em(t.interval)),gr)}),i=yield*it(o),c=yield*Ve(t.fetch,l=>(pt(`${e} immediate fetch error`,Hn(l)),z(null)));c!==null&&(yield*Pt(n,c),yield*Lf(s,r));const a={ref:n,fiber:i,get:Lt(n),changes:n.changes.pipe(qo(l=>l!==null)),refresh:$(function*(){const l=yield*t.fetch;return yield*Pt(n,l),yield*Lf(s,r),l}),stop:wz(e)},u={source:a,refCount:1,pollFiber:i};return bo.set(e,u),a}))}function wz(e){return $(function*(){const t=bo.get(e);t&&(t.refCount--,t.refCount<=0&&(t.pollFiber&&(yield*xe(t.pollFiber)),bo.delete(e)))})}function vz(){if(typeof globalThis>"u")return;const e=globalThis.localStorage;if(e)try{const t=e.getItem("__CHAIN_EFFECT_DEBUG__");if(t===null)return;const n=t.trim();return n.length===0?void 0:n==="true"||n==="1"?!0:n==="false"||n==="0"?!1:n}catch{return}}function Tz(){if(typeof globalThis>"u")return;const t=globalThis.__CHAIN_EFFECT_DEBUG__;if(typeof t=="boolean")return t;if(typeof t=="string")return t.trim()===""?void 0:t}function kz(){if(typeof globalThis>"u")return;const t=globalThis.__CHAIN_EFFECT_LOG__;if(typeof t=="function")return t}function Ez(e){if(!e.startsWith("/"))return null;const t=e.lastIndexOf("/");if(t<=0)return null;const n=e.slice(1,t),r=e.slice(t+1);try{return new RegExp(n,r)}catch{return null}}function nE(e){const t=Tz()??vz();if(t===!0)return!0;if(!t)return!1;const n=Ez(t);return n?n.test(e):e.includes(t)}function RW(e,t){if(!nE(e))return;const n=kz();n&&n(e,t)}const OW=Cd({chainId:_o(),data:XE(),signature:_o()});class Z extends Error{code;details;constructor(t,n,r,s){super(n,{cause:s}),this.name="ChainServiceError",this.code=t,this.details=r}}const ce={CHAIN_NOT_SUPPORTED:"CHAIN_NOT_SUPPORTED",NOT_SUPPORTED:"NOT_SUPPORTED",NETWORK_ERROR:"NETWORK_ERROR",INSUFFICIENT_BALANCE:"INSUFFICIENT_BALANCE",INSUFFICIENT_FEE:"INSUFFICIENT_FEE",INVALID_ADDRESS:"INVALID_ADDRESS",TRANSACTION_REJECTED:"TRANSACTION_REJECTED",TRANSACTION_TIMEOUT:"TRANSACTION_TIMEOUT",TX_BUILD_FAILED:"TX_BUILD_FAILED",TX_BROADCAST_FAILED:"TX_BROADCAST_FAILED",SIGNATURE_FAILED:"SIGNATURE_FAILED",ADDRESS_FROZEN:"ADDRESS_FROZEN",PAYSECRET_REQUIRED:"PAYSECRET_REQUIRED",ADDRESS_NOT_ACTIVATED:"ADDRESS_NOT_ACTIVATED",ENERGY_INSUFFICIENT:"ENERGY_INSUFFICIENT",NONCE_TOO_LOW:"NONCE_TOO_LOW",GAS_TOO_LOW:"GAS_TOO_LOW",UTXO_INSUFFICIENT:"UTXO_INSUFFICIENT"},Cz=new Set(["isValidAddress","normalizeAddress"]);function kd(e){return typeof e=="object"&&e!==null}function xa(e){if(typeof e=="bigint")return e.toString();if(!kd(e))return Array.isArray(e)?e.map(xa):e;if(Array.isArray(e))return e.map(xa);const t={};for(const n of Object.keys(e).sort())t[n]=xa(e[n]);return t}function uS(e){return JSON.stringify(xa(e))}const Iz="chain-effect:snapshot";function $z(e,t){return`${Iz}:${e}:${t}`}function rE(e,t){return Number.isFinite(t)?Date.now()-e>t:!1}function Az(e,t){const n=Km(e);return n?rE(n.timestamp,t)?(jm(e),null):n:null}function Yr(...e){const t=`[chain-provider] ${e.join(" ")}`;nE(t)&&console.log("[chain-provider]",...e)}function lS(e){if(Array.isArray(e)){const t=e[0];return kd(t)&&"hash"in t?`array(len=${e.length}, firstHash=${String(t.hash)})`:`array(len=${e.length})`}return kd(e)?"hash"in e?`object(hash=${String(e.hash)})`:"symbol"in e?`object(symbol=${String(e.symbol)})`:"object":String(e)}function Qr(e,t){if(t.length===0)return eE(e,()=>ZK({_tag:"HttpError",message:"No providers available"}));if(t.length===1)return t[0];Yr(`${e} fallback`,`sources=${t.map(o=>o.name).join(",")}`);let n=null;const r=async o=>{for(const i of t)try{const c=await i.fetch(o);return n=i,c}catch{}throw new Error("All providers failed")},s=(o,i,c)=>{let a=!1,u=null;const l=o==null?"__empty__":uS(o);Yr(`${e} subscribe`,l);const f=m=>{if(a)return;if(m>=t.length){c?.(new Error(`[${e}] all providers failed`));return}const y=t[m];Yr(`${e} probe`,y.name);let S=!1;u=y.subscribe(o,(_,T)=>{a||(S||(S=!0,n=y,Yr(`${e} resolved`,y.name)),Yr(`${e} emit`,T,lS(_)),i(_,T))},_=>{a||S||(Yr(`${e} error`,y.name,String(_)),u?.(),u=null,f(m+1))})},h=n?t.indexOf(n):-1;return f(h>=0?h:0),()=>{a=!0,u?.()}};return{name:e,fetch:r,subscribe:s,useState(o,i){const c=i?.enabled!==!1,a=i?.useSnapshot!==!1,u=i?.snapshotMaxAgeMs??Number.POSITIVE_INFINITY,l=q=>q==null?"__empty__":uS(q),f=G.useMemo(()=>l(o),[o]),h=G.useMemo(()=>$z(e,f),[f]),m=G.useMemo(()=>a?Az(h,u):null,[h,u,a]),[y,S]=G.useState(()=>c?!m:!1),[_,T]=G.useState(!1),[C,v]=G.useState(void 0),k=G.useRef(o);k.current=o;const R=G.useRef(m?.data),w=G.useRef(m?{key:h,timestamp:m.timestamp}:null),I=G.useRef(null),O=G.useRef(h);O.current!==h&&(O.current=h,m?(R.current=m.data,w.current={key:h,timestamp:m.timestamp}):(R.current=void 0,w.current=null)),G.useEffect(()=>{if(!c||!a)return;let q=!0;return(async()=>{const D=await zm(h);if(!q||!D)return;if(rE(D.timestamp,u)){await Gl(h);return}const B=w.current;B&&B.key===h&&B.timestamp>=D.timestamp||(R.current=D.data,w.current={key:h,timestamp:D.timestamp},S(!1),I.current?.())})(),()=>{q=!1}},[c,h,u,a]);const H=G.useCallback(q=>{if(I.current=q,!c)return R.current=void 0,()=>{};const D=R.current!==void 0;S(!D),T(!0),v(void 0);const B=s(k.current,F=>{const ue=Date.now();R.current=F,w.current={key:h,timestamp:ue},a&&Jo({key:h,data:F,timestamp:ue}),S(!1),T(!1),v(void 0),Yr(`${e} storeChange`,lS(F)),q()},F=>{v(F instanceof Error?F:new Error(String(F))),T(!1),S(!1)});return()=>{I.current=null,B()}},[c,f,h,a]),x=G.useCallback(()=>R.current,[]),E=G.useSyncExternalStore(H,x,x),V=G.useCallback(async()=>{if(c){T(!0),v(void 0);try{const q=await r(k.current),D=Date.now();R.current=q,w.current={key:h,timestamp:D},a&&Jo({key:h,data:q,timestamp:D})}catch(q){v(q instanceof Error?q:new Error(String(q)))}finally{T(!1),S(!1)}}},[c,h,a]);return G.useEffect(()=>{c||(R.current=void 0,S(!1),T(!1),v(void 0))},[c]),G.useEffect(()=>{!c||!a||S(!m)},[c,m,a]),{data:E,isLoading:y,isFetching:_,error:C,refetch:V}},invalidate(){n=null;for(const o of t)o.invalidate()}}}class sE{chainId;providers;_nativeBalance;_tokenBalances;_transactionHistory;_transaction;_transactionStatus;_blockHeight;_allBalances;constructor(t,n){this.chainId=t,this.providers=n}supports(t){return t==="nativeBalance"?this.providers.some(n=>n.nativeBalance!==void 0):t==="tokenBalances"?this.providers.some(n=>n.tokenBalances!==void 0):t==="transactionHistory"?this.providers.some(n=>n.transactionHistory!==void 0):t==="blockHeight"?this.providers.some(n=>n.blockHeight!==void 0):t==="transactionStatus"?this.providers.some(n=>n.transactionStatus!==void 0):this.providers.some(n=>typeof n[t]=="function")}getMethod(t){const n=this.providers.filter(i=>typeof i[t]=="function");if(n.length===0)return;const r=n[0],s=r[t];return typeof s!="function"?void 0:Cz.has(t)?s.bind(r):(async(...i)=>{let c=null,a=null;for(const u of n){const l=u[t];if(typeof l=="function")try{return await l.apply(u,i)}catch(f){if(c=f,f instanceof Z&&f.code===ce.NOT_SUPPORTED)continue;a||(a=f instanceof Error?f:new Error(String(f)))}}throw a||(c instanceof Error?c:new Error("All providers failed"))})}get supportsNativeBalance(){return this.supports("nativeBalance")}get supportsTokenBalances(){return this.supports("tokenBalances")}get supportsTransactionHistory(){return this.supports("transactionHistory")}get supportsBlockHeight(){return this.supports("blockHeight")}get supportsFeeEstimate(){return this.supports("estimateFee")}get supportsBuildTransaction(){return this.supports("buildTransaction")}get supportsSignTransaction(){return this.supports("signTransaction")}get supportsBroadcast(){return this.supports("broadcastTransaction")}get supportsFullTransaction(){return this.supportsBuildTransaction&&this.supportsSignTransaction&&this.supportsBroadcast}get supportsDeriveAddress(){return this.supports("deriveAddress")}get supportsAddressValidation(){return this.supports("isValidAddress")}get nativeBalance(){if(!this._nativeBalance){const t=this.providers.map(n=>n.nativeBalance).filter(n=>n!==void 0);this._nativeBalance=Qr(`${this.chainId}.nativeBalance`,t)}return this._nativeBalance}get tokenBalances(){if(!this._tokenBalances){const t=this.providers.map(n=>n.tokenBalances).filter(n=>n!==void 0);this._tokenBalances=Qr(`${this.chainId}.tokenBalances`,t)}return this._tokenBalances}get allBalances(){if(!this._allBalances){const t=this.supportsTokenBalances,n=this.supportsNativeBalance;if(t)this._allBalances=this.tokenBalances;else if(n){const{chainId:r}=this,s=he.getSymbol(r),o=he.getDecimals(r);this._allBalances=eE(`${r}.allBalances`,i=>{const c=this.nativeBalance;return ej(Ms({try:()=>c.fetch(i),catch:a=>({_tag:"HttpError",message:String(a)})})).pipe(nj(a=>a?[{symbol:a.symbol||s,name:a.symbol||s,amount:a.amount,isNative:!0,decimals:o}]:[]))})}else this._allBalances=Qr(`${this.chainId}.allBalances`,[])}return this._allBalances}get transactionHistory(){if(!this._transactionHistory){const t=this.providers.map(n=>n.transactionHistory).filter(n=>n!==void 0);this._transactionHistory=Qr(`${this.chainId}.transactionHistory`,t)}return this._transactionHistory}get transaction(){if(!this._transaction){const t=this.providers.map(n=>n.transaction).filter(n=>n!==void 0);this._transaction=Qr(`${this.chainId}.transaction`,t)}return this._transaction}get transactionStatus(){if(!this._transactionStatus){const t=this.providers.map(n=>n.transactionStatus).filter(n=>n!==void 0);this._transactionStatus=Qr(`${this.chainId}.transactionStatus`,t)}return this._transactionStatus}get blockHeight(){if(!this._blockHeight){const t=this.providers.map(n=>n.blockHeight).filter(n=>n!==void 0);this._blockHeight=Qr(`${this.chainId}.blockHeight`,t)}return this._blockHeight}get buildTransaction(){return this.getMethod("buildTransaction")}get estimateFee(){return this.getMethod("estimateFee")}get signTransaction(){return this.getMethod("signTransaction")}get broadcastTransaction(){return this.getMethod("broadcastTransaction")}get deriveAddress(){return this.getMethod("deriveAddress")}get deriveAddresses(){return this.getMethod("deriveAddresses")}get isValidAddress(){return this.getMethod("isValidAddress")}get normalizeAddress(){return this.getMethod("normalizeAddress")}get bioGetAccountInfo(){return this.getMethod("bioGetAccountInfo")}get bioVerifyPayPassword(){return this.getMethod("bioVerifyPayPassword")}get bioGetAssetDetail(){return this.getMethod("bioGetAssetDetail")}get supportsBioAccountInfo(){return this.supports("bioGetAccountInfo")}getProviders(){return this.providers}getProviderByType(t){return this.providers.find(n=>n.type===t)}}function fi(e){return class extends e{async deriveAddress(n,r=0){const s=new TextDecoder().decode(n);return Na(s,"ethereum",r).address}async deriveAddresses(n,r,s){const o=new TextDecoder().decode(n),i=[];for(let c=0;c<s;c++){const a=Na(o,"ethereum",r+c);i.push(a.address)}return i}isValidAddress(n){return eC(n,"ethereum")}normalizeAddress(n){return tC(n)}async signMessage(n,r){throw new Error("Not implemented")}async verifyMessage(n,r,s){throw new Error("Not implemented")}}}const Rz={ethereum:1,"ethereum-sepolia":11155111,binance:56,"bsc-testnet":97},Oz=ur(co(new TextEncoder().encode("transfer(address,uint256)"))).slice(0,8);function hi(e){return class extends e{#e=null;get#n(){return he.getRpcUrl(this.chainId)}get#t(){return he.getDecimals(this.chainId)}get#r(){return he.getSymbol(this.chainId)}async#o(){if(this.#e!==null)return this.#e;try{const n=await this.#s("eth_chainId"),r=parseInt(n,16);if(Number.isFinite(r))return this.#e=r,r}catch{}return this.#e=Rz[this.chainId]??1,this.#e}async#s(n,r=[]){const s=await fetch(this.#n,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({jsonrpc:"2.0",id:Date.now(),method:n,params:r})});if(!s.ok)throw new Z(ce.NETWORK_ERROR,`HTTP ${s.status}: ${s.statusText}`);const o=await s.json();if(o.error)throw new Z(ce.NETWORK_ERROR,o.error.message,{code:o.error.code});return o.result}async buildTransaction(n){if(n.type!=="transfer")throw new Z(ce.NOT_SUPPORTED,`Transaction type not supported: ${n.type}`);const r=n,s=await this.#s("eth_getTransactionCount",[r.from,"pending"]),o=parseInt(s,16),i=await this.#s("eth_gasPrice"),c=await this.#o(),a=r.tokenAddress?.toLowerCase(),u=!!a;let l=r.to,f="0x"+r.amount.raw.toString(16),h="0x",m="0x5208";return u&&a&&(h=this.#u(r.to,r.amount.raw),l=a,f="0x",m=await this.#f({from:r.from,to:l,data:h,value:f})),{chainId:this.chainId,intentType:"transfer",data:{nonce:o,gasPrice:i,gasLimit:m,to:l,value:f,data:h,chainId:c}}}async estimateFee(n){const r=await this.#s("eth_gasPrice"),i=21000n*BigInt(r),c=ee.fromRaw((i*80n/100n).toString(),this.#t,this.#r),a=ee.fromRaw(i.toString(),this.#t,this.#r),u=ee.fromRaw((i*120n/100n).toString(),this.#t,this.#r);return{slow:{amount:c,estimatedTime:60},standard:{amount:a,estimatedTime:15},fast:{amount:u,estimatedTime:5}}}async signTransaction(n,r){if(!r.privateKey)throw new Z(ce.SIGNATURE_FAILED,"privateKey is required for EVM signing");const s=n.data,o=await this.#l(s.chainId),i=this.#c([this.#i(s.nonce),s.gasPrice,s.gasLimit,s.to.toLowerCase(),s.value,s.data,this.#i(o),"0x","0x"]),c=co(Dn(i.slice(2))),a=wo.sign(c,r.privateKey,{prehash:!1,format:"recovered"}),u=a[0],l=BigInt("0x"+ur(a.slice(1,33))),f=BigInt("0x"+ur(a.slice(33,65))),h=o*2+35+u,m=l.toString(16).padStart(64,"0"),y=f.toString(16).padStart(64,"0"),S=this.#c([this.#i(s.nonce),s.gasPrice,s.gasLimit,s.to.toLowerCase(),s.value,s.data,this.#i(h),"0x"+m,"0x"+y]);return{chainId:this.chainId,data:S,signature:"0x"+m+y}}async broadcastTransaction(n){const r=n.data;return await this.#s("eth_sendRawTransaction",[r])}#i(n){return n===0?"0x":"0x"+n.toString(16)}#c(n){const r=n.map(a=>{if(a==="0x"||a==="")return new Uint8Array([128]);let u=a.startsWith("0x")?a.slice(2):a;u.length%2===1&&(u="0"+u);const l=Dn(u);if(l.length===1&&l[0]<128)return l;if(l.length<=55)return new Uint8Array([128+l.length,...l]);const f=this.#a(l.length);return new Uint8Array([183+f.length,...f,...l])}),s=r.reduce((a,u)=>a+u.length,0);let o;if(s<=55)o=new Uint8Array([192+s]);else{const a=this.#a(s);o=new Uint8Array([247+a.length,...a])}const i=new Uint8Array(o.length+s);i.set(o);let c=o.length;for(const a of r)i.set(a,c),c+=a.length;return"0x"+ur(i)}#u(n,r){const s=n.toLowerCase().replace(/^0x/,"").padStart(64,"0"),o=r.toString(16).padStart(64,"0");return`0x${Oz}${s}${o}`}async#l(n){if(typeof n=="number"&&Number.isFinite(n))return n;if(typeof n=="string"){const r=n.trim();if(r){const s=r.startsWith("0x")?parseInt(r,16):parseInt(r,10);if(Number.isFinite(s))return s}}return this.#o()}async#f(n){try{return await this.#s("eth_estimateGas",[n])}catch{return"0x186a0"}}#a(n){const r=n.toString(16),s=r.length%2?"0"+r:r;return Dn(s)}}}const Df=new Map;function Pz(e,t){if(!e||e.trim()==="")return;if(Df.has(t))return Df.get(t);const n=e.split(",").map(s=>s.trim()).filter(s=>s.length>0);if(n.length===0)return;const r=n[Math.floor(Math.random()*n.length)];return Df.set(t,r),r}function Xl(e,t){if(!e)return;const n=globalThis.__API_KEYS__;return Pz(n?.[e],t)}let Uf=null;const In=()=>Uf?z(Uf):uz.pipe(Ie(e=>Qe(()=>{Uf=e}))),fS=A({status:g,message:g,result:Kl}),xz=A({hash:g,from:g,to:g,value:g,timeStamp:g,isError:g,blockNumber:g,input:b(g),methodId:b(g),functionName:b(g)});function Fz(e,t,n){const r=e.toLowerCase(),s=t.toLowerCase();return r===n&&s===n?"self":r===n?"out":"in"}function Nz(e){try{const{Schema:t}=require("effect");return t.decodeUnknownSync(xz)(e)}catch{return null}}function Bz(e,t){return!e||e.length!==t.length?!0:e.length===0&&t.length===0?!1:e[0]?.hash!==t[0]?.hash}class Mz{chainId;type;endpoint;config;constructor(t,n){this.type=t.type,this.endpoint=t.endpoint,this.config=t.config,this.chainId=n}}class oE extends fi(hi(Mz)){symbol;decimals;baseUrl;apiKey;pollingInterval=3e4;_eventBus=null;_txHistorySources=new Map;_txHistoryCreations=new Map;_balanceSources=new Map;_balanceCreations=new Map;nativeBalance;transactionHistory;constructor(t,n){super(t,n),this.symbol=he.getSymbol(n),this.decimals=he.getDecimals(n),this.baseUrl=this.endpoint,this.apiKey=Xl(this.config?.apiKeyEnv,`etherscan-${n}`);const r=this;this.transactionHistory=Se(`etherscan.${n}.transactionHistory`,s=>r.createTransactionHistorySource(s)),this.nativeBalance=Se(`etherscan.${n}.nativeBalance`,s=>r.createBalanceSource(s))}buildUrl(t){const n=new URL(this.baseUrl);for(const[r,s]of Object.entries(t))n.searchParams.set(r,s);return this.apiKey&&n.searchParams.set("apikey",this.apiKey),n.toString()}createTransactionHistorySource(t){return this.getSharedTxHistorySource(t.address)}createBalanceSource(t){return this.getSharedBalanceSource(t.address)}getSharedTxHistorySource(t){const n=this,r=t.toLowerCase(),s=r,o=this.symbol,i=this.decimals,c=l=>({...l,stop:n.releaseSharedTxHistorySource(s)}),a=n._txHistorySources.get(s);if(a)return a.refCount+=1,z(c(a.source));const u=n._txHistoryCreations.get(s);return W(u?async()=>{const l=await u,f=n._txHistorySources.get(s);return f&&(f.refCount+=1),c(l)}:async()=>{const l=J($(function*(){n._eventBus||(n._eventBus=yield*In());const f=n._eventBus,h=n.fetchTransactionHistory({address:t,limit:50},!0).pipe(j(S=>{if(S.status==="0"||!Array.isArray(S.result))throw new ct("API rate limited",429);return S.result.map(Nz).filter(_=>_!==null).map(_=>({hash:_.hash,from:_.from,to:_.to,timestamp:parseInt(_.timeStamp,10)*1e3,status:_.isError==="0"?"confirmed":"failed",blockNumber:BigInt(_.blockNumber),action:"transfer",direction:Fz(_.from,_.to,r),assets:[{assetType:"native",value:_.value,symbol:o,decimals:i}]}))})),m=yield*Te({name:`etherscan.${n.chainId}.txHistory.${s}`,fetch:h,interval:ae(n.pollingInterval),walletEvents:{eventBus:f,chainId:n.chainId,address:t,types:["tx:confirmed","tx:sent"]}}),y=m.stop;return n._txHistorySources.set(s,{source:m,refCount:1,stopAll:y}),m}));n._txHistoryCreations.set(s,l);try{const f=await l;return c(f)}finally{n._txHistoryCreations.delete(s)}})}releaseSharedTxHistorySource(t){const n=this;return $(function*(){const r=n._txHistorySources.get(t);r&&(r.refCount-=1,r.refCount<=0&&(yield*r.stopAll,n._txHistorySources.delete(t)))})}getSharedBalanceSource(t){const n=this,r=t.toLowerCase(),s=this.symbol,o=this.decimals,i=u=>({...u,stop:n.releaseSharedBalanceSource(r)}),c=n._balanceSources.get(r);if(c)return c.refCount+=1,z(i(c.source));const a=n._balanceCreations.get(r);return W(a?async()=>{const u=await a,l=n._balanceSources.get(r);return l&&(l.refCount+=1),i(u)}:async()=>{const u=J($(function*(){const l=yield*n.getSharedTxHistorySource(t),f=yield*Le({name:`etherscan.${n.chainId}.balance`,dependsOn:l.ref,hasChanged:Bz,fetch:(m,y)=>n.fetchBalance(t,y).pipe(j(S=>{if(S.status==="0"||typeof S.result!="string")throw new ct("API rate limited",429);return{amount:ee.fromRaw(S.result,o,s),symbol:s}}))}),h=ze([f.stop,l.stop]).pipe(Ae);return n._balanceSources.set(r,{source:f,refCount:1,stopAll:h}),f}));n._balanceCreations.set(r,u);try{const l=await u;return i(l)}finally{n._balanceCreations.delete(r)}})}releaseSharedBalanceSource(t){const n=this;return $(function*(){const r=n._balanceSources.get(t);r&&(r.refCount-=1,r.refCount<=0&&(yield*r.stopAll,n._balanceSources.delete(t)))})}fetchBalance(t,n=!1){return te({url:this.buildUrl({module:"account",action:"balance",address:t,tag:"latest"}),schema:fS,cacheStrategy:n?"network-first":"cache-first"})}fetchTransactionHistory(t,n=!1){return te({url:this.buildUrl({module:"account",action:"txlist",address:t.address,page:"1",offset:String(t.limit??20),sort:"desc"}),schema:fS,cacheStrategy:n?"network-first":"cache-first"})}}function iE(e,t){return e.type==="etherscan-v1"||e.type.includes("blockscout")?new oE(e,t):null}const hS=A({status:g,message:g,result:Kl}),Lz=A({hash:g,from:g,to:g,value:g,timeStamp:g,isError:g,blockNumber:g,input:b(g),methodId:b(g),functionName:b(g)});function Hz(e,t,n){const r=e.toLowerCase(),s=t.toLowerCase();return r===n&&s===n?"self":r===n?"out":"in"}function Dz(e){try{const{Schema:t}=require("effect");return t.decodeUnknownSync(Lz)(e)}catch{return null}}function Uz(e,t){return!e||e.length!==t.length?!0:e.length===0&&t.length===0?!1:e[0]?.hash!==t[0]?.hash}class Kz{chainId;type;endpoint;config;constructor(t,n){this.type=t.type,this.endpoint=t.endpoint,this.config=t.config,this.chainId=n}}class cE extends fi(hi(Kz)){symbol;decimals;baseUrl;apiKey;evmChainId;pollingInterval=3e4;_eventBus=null;_txHistorySources=new Map;_txHistoryCreations=new Map;_balanceSources=new Map;_balanceCreations=new Map;nativeBalance;transactionHistory;constructor(t,n){super(t,n),this.symbol=he.getSymbol(n),this.decimals=he.getDecimals(n),this.baseUrl=this.endpoint,this.apiKey=Xl(this.config?.apiKeyEnv,`etherscan-${n}`);const r=this.config?.evmChainId;if(!r)throw new Error(`[EtherscanV2Provider] evmChainId is required for chain ${n}`);this.evmChainId=r;const s=this;this.transactionHistory=Se(`etherscan-v2.${n}.transactionHistory`,o=>s.createTransactionHistorySource(o)),this.nativeBalance=Se(`etherscan-v2.${n}.nativeBalance`,o=>s.createBalanceSource(o))}buildUrl(t){const n=new URL(this.baseUrl);n.searchParams.set("chainid",this.evmChainId.toString());for(const[r,s]of Object.entries(t))n.searchParams.set(r,s);return this.apiKey&&n.searchParams.set("apikey",this.apiKey),n.toString()}createTransactionHistorySource(t){return this.getSharedTxHistorySource(t.address)}createBalanceSource(t){return this.getSharedBalanceSource(t.address)}getSharedTxHistorySource(t){const n=this,r=t.toLowerCase(),s=r,o=this.symbol,i=this.decimals,c=l=>({...l,stop:n.releaseSharedTxHistorySource(s)}),a=n._txHistorySources.get(s);if(a)return a.refCount+=1,z(c(a.source));const u=n._txHistoryCreations.get(s);return W(u?async()=>{const l=await u,f=n._txHistorySources.get(s);return f&&(f.refCount+=1),c(l)}:async()=>{const l=J($(function*(){n._eventBus||(n._eventBus=yield*In());const f=n._eventBus,h=n.fetchTransactionHistory({address:t,limit:50},!0).pipe(j(S=>{if(S.status==="0"||!Array.isArray(S.result))throw new ct("API rate limited",429);return S.result.map(Dz).filter(_=>_!==null).map(_=>({hash:_.hash,from:_.from,to:_.to,timestamp:parseInt(_.timeStamp,10)*1e3,status:_.isError==="0"?"confirmed":"failed",blockNumber:BigInt(_.blockNumber),action:"transfer",direction:Hz(_.from,_.to,r),assets:[{assetType:"native",value:_.value,symbol:o,decimals:i}]}))})),m=yield*Te({name:`etherscan-v2.${n.chainId}.txHistory.${s}`,fetch:h,interval:ae(n.pollingInterval),walletEvents:{eventBus:f,chainId:n.chainId,address:t,types:["tx:confirmed","tx:sent"]}}),y=m.stop;return n._txHistorySources.set(s,{source:m,refCount:1,stopAll:y}),m}));n._txHistoryCreations.set(s,l);try{const f=await l;return c(f)}finally{n._txHistoryCreations.delete(s)}})}releaseSharedTxHistorySource(t){const n=this;return $(function*(){const r=n._txHistorySources.get(t);r&&(r.refCount-=1,r.refCount<=0&&(yield*r.stopAll,n._txHistorySources.delete(t)))})}getSharedBalanceSource(t){const n=this,r=t.toLowerCase(),s=this.symbol,o=this.decimals,i=u=>({...u,stop:n.releaseSharedBalanceSource(r)}),c=n._balanceSources.get(r);if(c)return c.refCount+=1,z(i(c.source));const a=n._balanceCreations.get(r);return W(a?async()=>{const u=await a,l=n._balanceSources.get(r);return l&&(l.refCount+=1),i(u)}:async()=>{const u=J($(function*(){const l=yield*n.getSharedTxHistorySource(t),f=yield*Le({name:`etherscan-v2.${n.chainId}.balance`,dependsOn:l.ref,hasChanged:Uz,fetch:(m,y)=>n.fetchBalance(t,y).pipe(j(S=>{if(S.status==="0"||typeof S.result!="string")throw new ct("API rate limited",429);const _=S.result.startsWith("0x")?BigInt(S.result).toString():S.result;return{amount:ee.fromRaw(_,o,s),symbol:s}}))}),h=ze([f.stop,l.stop]).pipe(Ae);return n._balanceSources.set(r,{source:f,refCount:1,stopAll:h}),f}));n._balanceCreations.set(r,u);try{const l=await u;return i(l)}finally{n._balanceCreations.delete(r)}})}releaseSharedBalanceSource(t){const n=this;return $(function*(){const r=n._balanceSources.get(t);r&&(r.refCount-=1,r.refCount<=0&&(yield*r.stopAll,n._balanceSources.delete(t)))})}fetchBalance(t,n=!1){return te({url:this.buildUrl({module:"account",action:"balance",address:t,tag:"latest"}),schema:hS,cacheStrategy:n?"network-first":"cache-first"})}fetchTransactionHistory(t,n=!1){return te({url:this.buildUrl({module:"account",action:"txlist",address:t.address,page:"1",offset:String(t.limit??20),sort:"desc"}),schema:hS,cacheStrategy:n?"network-first":"cache-first"})}}function aE(e,t){return e.type==="etherscan-v2"?new cE(e,t):null}const dS=A({jsonrpc:g,id:N,result:g}),jz=A({hash:g,from:g,to:we(g),value:g,blockNumber:we(g),input:g}),zz=A({jsonrpc:g,id:N,result:we(jz)}),Vz=A({status:g,blockNumber:g,transactionHash:g}),qz=A({jsonrpc:g,id:N,result:we(Vz)});function pS(e,t){return e===null?!0:e!==t}class Wz{chainId;type;endpoint;config;constructor(t,n){this.type=t.type,this.endpoint=t.endpoint,this.config=t.config,this.chainId=n}}class uE extends fi(hi(Wz)){symbol;decimals;pollingInterval=3e4;_balanceSources=new Map;_balanceCreations=new Map;_transactionSources=new Map;_transactionCreations=new Map;nativeBalance;blockHeight;transaction;constructor(t,n){super(t,n),this.symbol=he.getSymbol(n),this.decimals=he.getDecimals(n);const r=this;this.blockHeight=Se(`evm-rpc.${n}.blockHeight`,()=>r.createBlockHeightSource()),this.nativeBalance=Se(`evm-rpc.${n}.nativeBalance`,s=>r.createBalanceSource(s)),this.transaction=Se(`evm-rpc.${n}.transaction`,s=>r.createTransactionSource(s))}createBlockHeightSource(){return this.getSharedBlockHeightSource()}getSharedBlockHeightSource(){const t=this,n=Yl(this.chainId,"global","blockHeight"),r=t.fetchBlockNumber(!0).pipe(j(s=>BigInt(s.result)));return Ql(n,{fetch:r,interval:ae(t.pollingInterval)})}createBalanceSource(t){return this.getSharedBalanceSource(t.address)}createTransactionSource(t){return this.getSharedTransactionSource(t)}getSharedBalanceSource(t){const n=this,r=t.toLowerCase(),s=this.symbol,o=this.decimals,i=u=>({...u,stop:n.releaseSharedBalanceSource(r)}),c=n._balanceSources.get(r);if(c)return c.refCount+=1,z(i(c.source));const a=n._balanceCreations.get(r);return W(a?async()=>{const u=await a,l=n._balanceSources.get(r);return l&&(l.refCount+=1),i(u)}:async()=>{const u=J($(function*(){const l=yield*n.getSharedBlockHeightSource(),f=yield*Le({name:`evm-rpc.${n.chainId}.balance`,dependsOn:l.ref,hasChanged:pS,fetch:(m,y)=>n.fetchBalance(t,y).pipe(j(S=>{const _=BigInt(S.result).toString();return{amount:ee.fromRaw(_,o,s),symbol:s}}))}),h=ze([f.stop,l.stop]).pipe(Ae);return n._balanceSources.set(r,{source:f,refCount:1,stopAll:h}),f}));n._balanceCreations.set(r,u);try{const l=await u;return i(l)}finally{n._balanceCreations.delete(r)}})}releaseSharedBalanceSource(t){const n=this;return $(function*(){const r=n._balanceSources.get(t);r&&(r.refCount-=1,r.refCount<=0&&(yield*r.stopAll,n._balanceSources.delete(t)))})}getSharedTransactionSource(t){const n=this,r=t.txHash,s=this.symbol,o=this.decimals,i=u=>({...u,stop:n.releaseSharedTransactionSource(r)}),c=n._transactionSources.get(r);if(c)return c.refCount+=1,z(i(c.source));const a=n._transactionCreations.get(r);return W(a?async()=>{const u=await a,l=n._transactionSources.get(r);return l&&(l.refCount+=1),i(u)}:async()=>{const u=J($(function*(){const l=yield*n.getSharedBlockHeightSource(),f=$(function*(){const[y,S]=yield*ze([n.fetchTransaction(t.txHash,!0),n.fetchTransactionReceipt(t.txHash,!0)]),_=y.result,T=S.result;if(!_)return null;let C;T?C=T.status==="0x1"?"confirmed":"failed":C="pending";const v=BigInt(_.value||"0x0").toString(),k=T?.blockNumber?BigInt(T.blockNumber):void 0,R={hash:_.hash,from:_.from,to:_.to??"",timestamp:Date.now(),status:C,action:_.to?"transfer":"contract",direction:"out",assets:[{assetType:"native",value:v,symbol:s,decimals:o}]};return k===void 0?R:{...R,blockNumber:k}}),h=yield*Le({name:`evm-rpc.${n.chainId}.transaction`,dependsOn:l.ref,hasChanged:pS,fetch:()=>f}),m=ze([h.stop,l.stop]).pipe(Ae);return n._transactionSources.set(r,{source:h,refCount:1,stopAll:m}),h}));n._transactionCreations.set(r,u);try{const l=await u;return i(l)}finally{n._transactionCreations.delete(r)}})}releaseSharedTransactionSource(t){const n=this;return $(function*(){const r=n._transactionSources.get(t);r&&(r.refCount-=1,r.refCount<=0&&(yield*r.stopAll,n._transactionSources.delete(t)))})}fetchBlockNumber(t=!1){return te({url:this.endpoint,method:"POST",body:{jsonrpc:"2.0",id:1,method:"eth_blockNumber",params:[]},schema:dS,cacheStrategy:t?"network-first":"cache-first"})}fetchBalance(t,n=!1){return te({url:this.endpoint,method:"POST",body:{jsonrpc:"2.0",id:1,method:"eth_getBalance",params:[t,"latest"]},schema:dS,cacheStrategy:n?"network-first":"cache-first"})}fetchTransaction(t,n=!1){return te({url:this.endpoint,method:"POST",body:{jsonrpc:"2.0",id:1,method:"eth_getTransactionByHash",params:[t]},schema:zz,cacheStrategy:n?"network-first":"cache-first"})}fetchTransactionReceipt(t,n=!1){return te({url:this.endpoint,method:"POST",body:{jsonrpc:"2.0",id:1,method:"eth_getTransactionReceipt",params:[t]},schema:qz,cacheStrategy:n?"network-first":"cache-first"})}}function lE(e,t){return e.type.endsWith("-rpc")&&(e.type.includes("ethereum")||e.type.includes("bsc"))?new uE(e,t):null}A({success:ve,result:A({height:N,timestamp:N,signature:b(g)})});A({success:ve,result:b(A({assets:b(fe(A({symbol:g,balance:g})))}))});A({success:ve,result:b(A({trs:b(fe(A({height:N,signature:g,tIndex:N,transaction:A({signature:g,senderId:g,recipientId:b(g),fee:g,timestamp:N,type:b(g),asset:b(A({transferAsset:b(A({amount:g,assetType:b(g)}))}))})}))),count:b(N)}))});A({genesisBlock:A({forgeInterval:N,beginEpochTime:b(N)})});const fE=new Map,Jz=15e3;function Gz(e,t){fE.set(e,t)}function FW(e){return fE.get(e)??Jz}function Yz(e){return Array.from(e).map(t=>t.toString(16).padStart(2,"0")).join("")}function Qz(e){return class extends e{#e=null;#n(){if(!this.#e){const n=he.getConfig(this.chainId);this.#e=n?.prefix??"b"}return this.#e}async deriveAddress(n,r=0){const s=new TextDecoder().decode(n),o=nC(s);return rC(o.publicKey,this.#n())}async deriveAddresses(n,r,s){const o=await this.deriveAddress(n,r);return Array(s).fill(o)}isValidAddress(n){return sC(n)}normalizeAddress(n){return n}async signMessage(n,r){const s=oC(n,r);return Yz(s)}async verifyMessage(n,r,s){return!1}}}class eo extends Error{constructor(t,n,r){super(t),this.status=n,this.response=r,this.name="ApiError"}}class Xz{baseUrl;timeout;fetchFn;constructor(t){this.baseUrl=t.baseUrl.replace(/\/$/,""),this.timeout=t.timeout??3e4,this.fetchFn=t.fetch??((n,r)=>fetch(n,r))}async request(t,n,r){const s=`${this.baseUrl}${n}`,o=new AbortController,i=setTimeout(()=>o.abort(),this.timeout);try{const c={method:t,signal:o.signal};r&&(c.headers={"Content-Type":"application/json"},c.body=JSON.stringify(r));const a=await this.fetchFn(s,c),u=await a.json();if(!a.ok)throw new eo(u.message??`Request failed: ${a.status}`,a.status,u);if(!u.success)throw new eo(u.message??"Request failed",a.status,u);return u.result}catch(c){throw c instanceof eo?c:c instanceof Error&&c.name==="AbortError"?new eo("Request timeout",void 0,void 0):new eo(c instanceof Error?c.message:"Unknown error",void 0,void 0)}finally{clearTimeout(i)}}async get(t){return this.request("GET",t)}async post(t,n){return this.request("POST",t,n)}}const Zz="https://walletapi.bfmeta.info";class e3{client;chainPath;constructor(t){this.chainPath=t.chainPath;const n={baseUrl:t.baseUrl??Zz};t.timeout!==void 0&&(n.timeout=t.timeout),t.fetch!==void 0&&(n.fetch=t.fetch),this.client=new Xz(n)}path(t){return`/wallet/${this.chainPath}${t}`}async getLastBlock(){return this.client.get(this.path("/lastblock"))}async getBlockByHeight(t){return this.client.post(this.path("/block/query"),{height:t})}async getBalance(t){return this.client.post(this.path("/address/balance"),t)}async getAddressInfo(t){return this.client.post(this.path("/address/info"),{address:t})}async getAddressAssets(t){return this.client.post(this.path("/address/asset"),{address:t})}async getBlockAverageFee(){return this.client.get(this.path("/blockAveFee"))}async broadcastTransaction(t){return this.client.post(this.path("/transactions/broadcast"),t)}async queryTransactions(t){return this.client.post(this.path("/transactions/query"),t)}async queryPendingTransactions(t){return this.client.post(this.path("/pendingTr"),t)}async queryTokenList(t){return this.client.post(this.path("/assets"),t)}async queryTokenDetail(t){return this.client.post(this.path("/asset/details"),t)}}const t3=Cd({code:_o(),message:_o()}),mS=Cd({success:ZE(),minFee:_o().optional(),message:_o().optional(),error:t3.optional()});class aa extends Error{constructor(t,n,r){super(n),this.code=t,this.minFee=r,this.name="BroadcastError",this.isRetryable=n3(t,n)}isRetryable}function n3(e,t){if(e&&["001-11028","001-11029","002-41011","001-00034"].includes(e))return!1;const r=t.toLowerCase();return["timeout","timed out","network","connection","econnrefused","enotfound","socket","fetch failed","failed to fetch"].some(i=>r.includes(i))?!0:["insufficient","not enough","rejected","invalid","expired"].some(i=>r.includes(i))?!1:e===void 0}const gS=new Map;function r3(e){const t=e.match(/^(https?:\/\/[^/]+)\/wallet\/([^/]+)\/?$/);if(t)return{baseUrl:t[1],chainPath:t[2]};throw new Error(`Invalid wallet API URL format: ${e}. Expected format: https://host/wallet/chainPath`)}function Zl(e){let t=gS.get(e);if(!t){const{baseUrl:n,chainPath:r}=r3(e);t=new e3({baseUrl:n,chainPath:r}),gS.set(e,t)}return t}const yS=new Map,SS=new Map;let ua=null,la=null;async function qm(e,t){const n=t,r=yS.get(n);if(r)return r;let s;typeof document<"u"?s=new URL(`./configs/${t.replace(/^\.\//,"")}`,document.baseURI).href:s=`./configs/${t.replace(/^\.\//,"")}`;let o;if(s.startsWith("http://")||s.startsWith("https://")){const i=await fetch(s);if(!i.ok)throw new Error(`Failed to fetch genesis block for ${e}: ${i.status}`);o=await i.json()}else o=(await import(s)).default;return yS.set(n,o),o}async function s3(){const{sha256:e}=await is(async()=>{const{sha256:o}=await import("./derivation-BZaKSuyr.js").then(i=>i.O);return{sha256:o}},__vite__mapDeps([0,1,2,3]),import.meta.url),{md5:t,ripemd160:n}=await is(async()=>{const{md5:o,ripemd160:i}=await import("./derivation-BZaKSuyr.js").then(c=>c.P);return{md5:o,ripemd160:i}},__vite__mapDeps([0,1,2,3]),import.meta.url),r=o=>{const i=[];return{update(c){const a=typeof c=="string"?new TextEncoder().encode(c):c;return i.push(a),this},async digest(){const c=i.reduce((l,f)=>l+f.length,0),a=new Uint8Array(c);let u=0;for(const l of i)a.set(l,u),u+=l.length;return Buffer.from(o(a))}}};return{sha256(o){if(!o)return r(c=>e(c));const i=typeof o=="string"?new TextEncoder().encode(o):o;return Promise.resolve(Buffer.from(e(i)))},md5(o){if(!o)return r(c=>t(c));const i=typeof o=="string"?new TextEncoder().encode(o):o;return Promise.resolve(Buffer.from(t(i)))},ripemd160(o){if(!o)return r(c=>n(c));const i=typeof o=="string"?new TextEncoder().encode(o):o;return Promise.resolve(Buffer.from(n(i)))}}}async function o3(){return ua||la||(la=(async()=>(ua={setup:(await is(()=>import("./bioforest-chain-bundle-DDhYlOk5.js"),[],import.meta.url)).setup},ua))(),la)}async function Wr(e){const{chainConfigService:t}=await is(async()=>{const{chainConfigService:u}=await import("./service--Mqh_DSQ.js").then(l=>l.s);return{chainConfigService:u}},__vite__mapDeps([4,1,2,3,5,6,0]),import.meta.url),n=t.getBiowalletGenesisBlock(e);if(!n)throw new Error(`Genesis block path not configured for chain: ${e}`);const r=await qm(e,n),s=r.magic,o=SS.get(s);if(o)return o;const i=await o3(),c=await s3(),a=await i.setup(r,c,{n:"KeyApp",m:"true",a:"web"});return SS.set(s,a),a}async function Ls(e){const n=await Zl(e).getLastBlock();return{height:n.height,timestamp:n.timestamp}}async function ef(e,t){const n=Zl(e);try{return await n.getAddressInfo(t)??{address:t}}catch{return{address:t}}}async function hE(e){const t=await Wr(e.chainId),n=await Ls(e.baseUrl),r=n.height,s=n.timestamp;let o=e.fee;o||(o=await t.transactionController.getTransferTransactionMinFee({transaction:{applyBlockHeight:r,timestamp:s,remark:e.remark??{}},assetInfo:{sourceChainName:await t.getChainName(),sourceChainMagic:await t.getMagic(),assetType:e.assetType,amount:e.amount}}));let i=!1;if(e.paySecret){const u=await ef(e.baseUrl,e.from);u.secondPublicKey&&(i=await Wm(e.chainId,e.mainSecret,e.paySecret,u.secondPublicKey)==="v1")}const c={mainSecret:e.mainSecret,...e.paySecret?{paySecret:e.paySecret,usePaySecretV1:i}:{}},a={sourceChainName:await t.getChainName(),sourceChainMagic:await t.getMagic(),assetType:e.assetType,amount:e.amount};return t.transactionController.createTransferTransactionJSON({secrets:c,transaction:{fee:o,recipientId:e.to,applyBlockHeight:r,timestamp:s,remark:e.remark??{},effectiveBlockHeight:r+100},assetInfo:a})}async function dE(e,t){const{nonce:n,...r}=t,s=Zl(e);try{const o=await s.broadcastTransaction(r);if(o&&typeof o=="object"&&"signature"in o)return{txHash:t.signature,alreadyExists:!1};const i=mS.safeParse(o);if(i.success){const c=i.data;if(!c.success){const a=c.error?.code,u=c.error?.message??c.message??"Transaction rejected";if(a==="001-00034")return{txHash:t.signature,alreadyExists:!0};throw new aa(a,u,c.minFee)}return{txHash:t.signature,alreadyExists:!1}}return{txHash:t.signature,alreadyExists:!1}}catch(o){if(o instanceof aa)throw o;if(o instanceof eo&&o.response){const i=mS.safeParse(o.response);if(i.success){const c=i.data,a=c.error?.code,u=c.error?.message??c.message??"Transaction rejected";if(a==="001-00034")return{txHash:t.signature,alreadyExists:!0};throw new aa(a,u,c.minFee)}}throw new aa(void 0,o instanceof Error?o.message:"Transaction rejected")}}async function Wm(e,t,n,r){const o=(await Wr(e)).accountBaseHelper();try{if((await o.createSecondSecretKeypairV2(t,n)).publicKey.toString("hex")===r)return"v2"}catch{}try{if((await o.createSecondSecretKeypair(t,n)).publicKey.toString("hex")===r)return"v1"}catch{}return!1}async function pE(e){const{baseUrl:t,chainId:n,intent:r,fromAddress:s}=e,o=await Wr(n),i=await Ls(t),c=i.height,a=i.timestamp;switch(r.type){case"transfer":{let u=!1;if(s)try{u=!!(await ef(t,s)).secondPublicKey}catch{}const l=r.amount||"99999999999999999";let f=await o.transactionController.getTransferTransactionMinFee({transaction:{applyBlockHeight:c,timestamp:a,remark:r.remark??{}},assetInfo:{sourceChainName:await o.getChainName(),sourceChainMagic:await o.getMagic(),assetType:await o.getAssetType(),amount:l}});return u&&(f=String(BigInt(f)*BigInt(105)/BigInt(100))),f}case"setPayPassword":return o.transactionController.getSignatureTransactionMinFee({newPaySecret:`${Date.now()}getSignatureTransactionMinFee`,applyBlockHeight:c,timestamp:a});default:throw new Error(`Unknown fee intent type: ${r.type}`)}}async function mE(e,t,n,r,s){return pE({baseUrl:e,chainId:t,intent:{type:"transfer",amount:r??"0",remark:s},fromAddress:n})}async function gE(e,t){const n=await Wr(t),r=await Ls(e),s=r.height,o=r.timestamp;return n.transactionController.getSignatureTransactionMinFee({newPaySecret:`${Date.now()}getSignatureTransactionMinFee`,applyBlockHeight:s,timestamp:o})}async function yE(e){const t=await Wr(e.chainId),n=await Ls(e.baseUrl),r=n.height,s=n.timestamp;let o=e.fee;return o||(o=await t.transactionController.getSignatureTransactionMinFee({newPaySecret:e.newPaySecret,applyBlockHeight:r,timestamp:s})),t.transactionController.createSignatureTransactionJSON({mainSecret:e.mainSecret},{newPaySecret:e.newPaySecret,fee:o,applyBlockHeight:r,timestamp:s,effectiveBlockHeight:r+100})}async function Jm(e,t,n,r){const s=await Wr(t),o=await Ls(e),i=o.height,c=o.timestamp;return s.transactionController.getDestoryAssetTransactionMinFee({transaction:{applyBlockHeight:i,timestamp:c,remark:{}},assetInfo:{sourceChainName:await s.getChainName(),sourceChainMagic:await s.getMagic(),assetType:n,amount:r}})}async function SE(e){const t=await Wr(e.chainId),n=await Ls(e.baseUrl),r=n.height,s=n.timestamp;let o=e.fee;o||(o=await Jm(e.baseUrl,e.chainId,e.assetType,e.amount));let i=!1;if(e.paySecret){const l=await ef(e.baseUrl,e.from);l.secondPublicKey&&(i=await Wm(e.chainId,e.mainSecret,e.paySecret,l.secondPublicKey)==="v1")}const c={mainSecret:e.mainSecret,...e.paySecret?{paySecret:e.paySecret,usePaySecretV1:i}:{}},a={sourceChainName:await t.getChainName(),sourceChainMagic:await t.getMagic(),assetType:e.assetType,amount:e.amount};return t.transactionController.createDestoryAssetTransactionJSON({secrets:c,transaction:{fee:o,recipientId:e.recipientId,applyBlockHeight:r,timestamp:s,remark:e.remark??{},effectiveBlockHeight:r+100},assetInfo:a})}async function i3(e,t,n){const r=Zl(e);try{const s=await r.queryTokenDetail({assetType:t,address:n});return s?.applyAddress?{applyAddress:s.applyAddress,assetType:s.assetType}:null}catch{return null}}const Kf=Object.freeze(Object.defineProperty({__proto__:null,broadcastTransaction:dE,createDestroyTransaction:SE,createSignatureTransaction:yE,createTransferTransaction:hE,fetchGenesisBlock:qm,getAddressInfo:ef,getAssetDetail:i3,getBioforestCore:Wr,getDestroyTransactionMinFee:Jm,getLastBlock:Ls,getMinFee:pE,getSignatureTransactionMinFee:gE,getTransferMinFee:mE,verifyTwoStepSecret:Wm},Symbol.toStringTag,{value:"Module"}));function c3(e){return class extends e{#e=null;get#n(){return he.getConfig(this.chainId)}get#t(){return this.#e||(this.#e=he.getBiowalletApi(this.chainId)??""),this.#e}async buildTransaction(n){switch(n.type){case"transfer":return this.#r(n);case"destroy":return this.#o(n);case"setPayPassword":return this.#s(n);default:throw new Z(ce.NOT_SUPPORTED,`Transaction type not supported: ${n.type}`)}}async#r(n){const r=this.#n;if(!n.from||!n.to)throw new Z(ce.INVALID_ADDRESS,"Invalid address");return{chainId:r.id,intentType:"transfer",data:{from:n.from,to:n.to,amount:n.amount.toRawString(),assetType:n.bioAssetType??r.symbol,memo:n.memo,remark:n.remark},estimatedFee:n.fee}}async#o(n){const r=this.#n;if(!n.from||!n.recipientId)throw new Z(ce.INVALID_ADDRESS,"Invalid address");return{chainId:r.id,intentType:"destroy",data:{from:n.from,recipientId:n.recipientId,amount:n.amount.toRawString(),assetType:n.bioAssetType,...n.remark?{remark:n.remark}:{}},estimatedFee:n.fee}}async#s(n){const r=this.#n;if(!n.from)throw new Z(ce.INVALID_ADDRESS,"Invalid address");return{chainId:r.id,intentType:"setPayPassword",data:{from:n.from},estimatedFee:n.fee}}async estimateFee(n){const r=this.#n,{decimals:s,symbol:o}=r,i=(c,a)=>({amount:c,estimatedTime:a});if(!this.#t)throw new Z(ce.NETWORK_ERROR,"RPC URL not configured for BioForest chain");try{let c;switch(n.intentType){case"transfer":{const u=n.data;c=await mE(this.#t,r.id,u.from,u.amount,void 0);break}case"destroy":{const u=n.data;c=await Jm(this.#t,r.id,u.assetType,u.amount);break}case"setPayPassword":{c=await gE(this.#t,r.id);break}default:throw new Z(ce.NOT_SUPPORTED,`Fee estimation not supported for: ${n.intentType}`)}const a=ee.fromRaw(c,s,o);return{slow:i(a,30),standard:i(a,15),fast:i(a.mul(2),5)}}catch(c){throw c instanceof Z?c:new Z(ce.NETWORK_ERROR,"Failed to calculate minimum fee from SDK",void 0,c instanceof Error?c:void 0)}}async signTransaction(n,r){if(!r.bioSecret)throw new Z(ce.SIGNATURE_FAILED,"bioSecret is required for BioChain signing");if(!this.#t)throw new Z(ce.NETWORK_ERROR,"RPC URL not configured");const s=this.#n;try{switch(n.intentType){case"transfer":{const o=n.data,i=n.estimatedFee?n.estimatedFee.toRawString():(await this.estimateFee(n)).standard.amount.toRawString(),c=o.remark??(o.memo?{memo:o.memo}:void 0),a=await hE({baseUrl:this.#t,chainId:s.id,mainSecret:r.bioSecret,paySecret:r.bioPaySecret,from:o.from,to:o.to,amount:o.amount,assetType:o.assetType,fee:i,remark:c});return{chainId:n.chainId,data:a,signature:a.signature}}case"destroy":{const o=n.data,i=n.estimatedFee?n.estimatedFee.toRawString():(await this.estimateFee(n)).standard.amount.toRawString(),c=await SE({baseUrl:this.#t,chainId:s.id,mainSecret:r.bioSecret,paySecret:r.bioPaySecret,from:o.from,recipientId:o.recipientId,assetType:o.assetType,amount:o.amount,fee:i,remark:o.remark});return{chainId:n.chainId,data:c,signature:c.signature}}case"setPayPassword":{if(!r.bioNewPaySecret)throw new Z(ce.SIGNATURE_FAILED,"bioNewPaySecret is required for setPayPassword");const o=await yE({baseUrl:this.#t,chainId:s.id,mainSecret:r.bioSecret,newPaySecret:r.bioNewPaySecret});return{chainId:n.chainId,data:o,signature:o.signature}}default:throw new Z(ce.NOT_SUPPORTED,`Signing not supported for: ${n.intentType}`)}}catch(o){throw o instanceof Z?o:new Z(ce.SIGNATURE_FAILED,"Failed to sign transaction",void 0,o instanceof Error?o:void 0)}}async broadcastTransaction(n){if(!this.#t)throw new Z(ce.NETWORK_ERROR,"RPC URL not configured");try{return(await dE(this.#t,n.data)).txHash}catch(r){throw r instanceof Z?r:new Z(ce.TX_BROADCAST_FAILED,"Failed to broadcast transaction",void 0,r instanceof Error?r:void 0)}}}}function a3(e){return class extends e{async bioGetAccountInfo(t){const{getAddressInfo:n}=await is(async()=>{const{getAddressInfo:r}=await Promise.resolve().then(()=>Kf);return{getAddressInfo:r}},void 0,import.meta.url);try{const r=await n(this.endpoint,t);return{address:t,secondPublicKey:r?.secondPublicKey??null}}catch{return{address:t,secondPublicKey:null}}}async bioVerifyPayPassword(t){const{getBioforestCore:n}=await is(async()=>{const{getBioforestCore:o}=await Promise.resolve().then(()=>Kf);return{getBioforestCore:o}},void 0,import.meta.url),s=(await n(this.chainId)).accountBaseHelper();try{if((await s.createSecondSecretKeypairV2(t.mainSecret,t.paySecret)).publicKey.toString("hex")===t.publicKey)return!0}catch{}try{if((await s.createSecondSecretKeypair(t.mainSecret,t.paySecret)).publicKey.toString("hex")===t.publicKey)return!0}catch{}return!1}async bioGetAssetDetail(t,n){const{getAssetDetail:r}=await is(async()=>{const{getAssetDetail:s}=await Promise.resolve().then(()=>Kf);return{getAssetDetail:s}},void 0,import.meta.url);try{const s=await r(this.endpoint,t,n);return s?.applyAddress?{assetType:s.assetType,applyAddress:s.applyAddress}:null}catch{return null}}}}const u3=A({assetNumber:g,assetType:g}),l3=A({address:g,assets:Gy({key:g,value:Gy({key:g,value:u3})})}),f3=A({success:ve,result:b(we(l3))}),h3=A({assetType:g,amount:g}),d3=A({totalAmount:g,assetType:g}),p3=A({transactionSignature:g}),m3=A({trustees:fe(g),numberOfSignFor:N,assetType:g,amount:g}),g3=A({publicKey:b(g)}),y3=A({assetType:g,amount:g}),S3=A({entityId:b(g)}),b3=A({factoryId:b(g)}),_3=A({transferAsset:b(h3),giftAsset:b(d3),grabAsset:b(p3),trustAsset:b(m3),signature:b(g3),destroyAsset:b(y3),issueEntity:b(S3),issueEntityFactory:b(b3)}),bE=A({type:g,senderId:g,recipientId:_0(g,{default:()=>""}),timestamp:N,signature:g,asset:b(_3)}),w3=A({height:N,signature:g,transaction:bE}),v3=A({trs:fe(w3),count:b(N)}),bS=A({success:ve,result:b(v3)}),T3=A({height:N}),k3=A({success:ve,result:b(T3)}),E3=A({state:N,trJson:bE,signature:b(g),createdTime:g}),C3=A({success:ve,result:b(fe(E3))});function _E(e,t,n){const r=e.toLowerCase(),s=t.toLowerCase(),o=n.toLowerCase();return s&&r===o&&s===o?"self":r===o?"out":"in"}const I3=0;function wE(e){const t={"AST-01":"transfer","AST-02":"transfer","AST-03":"destroyAsset","BSE-01":"signature","ETY-01":"issueEntity","ETY-02":"issueEntity","GFT-01":"gift","GFT-02":"gift","GRB-01":"grab","GRB-02":"grab","TRS-01":"trust","TRS-02":"trust","SGN-01":"signFor","SGN-02":"signFor","EMI-01":"emigrate","EMI-02":"emigrate","IMI-01":"immigrate","IMI-02":"immigrate","ISA-01":"issueAsset","ICA-01":"increaseAsset","DSA-01":"destroyAsset","ISE-01":"issueEntity","DSE-01":"destroyEntity","LNS-01":"locationName","DAP-01":"dapp","CRT-01":"certificate","MRK-01":"mark"},n=e.split("-");if(n.length>=4){const r=`${n[n.length-2]}-${n[n.length-1]}`;return t[r]??"unknown"}return"unknown"}function vE(e,t){return e?e.transferAsset?{value:e.transferAsset.amount,assetType:e.transferAsset.assetType}:e.giftAsset?{value:e.giftAsset.totalAmount,assetType:e.giftAsset.assetType}:e.trustAsset?{value:e.trustAsset.amount,assetType:e.trustAsset.assetType}:e.grabAsset?{value:"0",assetType:t}:e.destroyAsset?{value:e.destroyAsset.amount,assetType:e.destroyAsset.assetType}:e.issueEntity||e.issueEntityFactory?{value:"0",assetType:t}:e.signature?{value:"0",assetType:t}:{value:null,assetType:t}:{value:null,assetType:t}}function _S(e,t){const{signature:n,height:r,status:s,createdTime:o,address:i="",epochMs:c}=t,{value:a,assetType:u}=vE(e.asset,"BFM"),l=o?new Date(o).getTime():c+e.timestamp*1e3,f=i?_E(e.senderId,e.recipientId??"",i):"out";return{hash:n,from:e.senderId,to:e.recipientId??"",timestamp:l,status:s,blockNumber:r!==void 0?BigInt(r):void 0,action:wE(e.type),direction:f,assets:[{assetType:"native",value:a??"0",symbol:u,decimals:8}]}}class $3{chainId;type;endpoint;config;constructor(t,n){this.type=t.type,this.endpoint=t.endpoint,this.config=t.config,this.chainId=n}}class TE extends a3(Qz(c3($3))){symbol;decimals;baseUrl;forgeInterval=15e3;epochMs=I3;get pendingTxCacheTtl(){return Math.max(1e3,Math.floor(this.forgeInterval/4))}_eventBus=null;_txHistorySources=new Map;_txHistoryCreations=new Map;_balanceSources=new Map;_balanceCreations=new Map;_tokenBalanceSources=new Map;_tokenBalanceCreations=new Map;nativeBalance;tokenBalances;transactionHistory;blockHeight;transaction;constructor(t,n){super(t,n),this.symbol=he.getSymbol(n),this.decimals=he.getDecimals(n),this.baseUrl=this.endpoint;const r=he.getBiowalletGenesisBlock(n);r&&qm(n,r).then(c=>{const a=c.asset.genesisAsset.forgeInterval;typeof a=="number"&&(this.forgeInterval=a*1e3,Gz(n,this.forgeInterval));const u=c.asset.genesisAsset.beginEpochTime;typeof u=="number"&&(this.epochMs=u)}).catch(c=>{console.warn("Failed to fetch genesis block:",c)});const s=this.symbol,o=this.decimals,i=this;this.transactionHistory=Se(`biowallet.${n}.transactionHistory`,c=>i.createTransactionHistorySource(c,s,o)),this.nativeBalance=Se(`biowallet.${n}.nativeBalance`,c=>i.createBalanceSource(c,s,o)),this.tokenBalances=Se(`biowallet.${n}.tokenBalances`,c=>i.createTokenBalancesSource(c,s,o)),this.blockHeight=Se(`biowallet.${n}.blockHeight`,()=>i.createBlockHeightSource()),this.transaction=Se(`biowallet.${n}.transaction`,c=>i.createTransactionSource(c))}getSharedBlockHeightSource(){const t=this,n=Yl(this.chainId,"global","blockHeight"),r=t.fetchBlockHeight().pipe(j(s=>s.result?.height?BigInt(s.result.height):BigInt(0)));return Ql(n,{fetch:r,interval:ae(this.forgeInterval)})}getSharedTxHistorySource(t,n,r){const s=this,o=t.toLowerCase(),i=o,c=l=>({...l,stop:s.releaseSharedTxHistorySource(i)}),a=s._txHistorySources.get(i);if(a)return a.refCount+=1,z(c(a.source));const u=s._txHistoryCreations.get(i);return W(u?async()=>{const l=await u,f=s._txHistorySources.get(i);return f&&(f.refCount+=1),c(l)}:async()=>{const l=J($(function*(){const f=yield*s.getSharedBlockHeightSource(),h=yield*Le({name:`biowallet.${s.chainId}.txHistory.${o}`,dependsOn:f.ref,hasChanged:()=>!0,fetch:(_,T)=>s.fetchTransactionList({address:t,limit:50},!0).pipe(j(C=>C.result?.trs?C.result.trs.map(v=>{const k=v.transaction,R=wE(k.type),w=_E(k.senderId,k.recipientId??"",o),{value:I,assetType:O}=vE(k.asset,n);return I===null?null:{hash:k.signature??v.signature,from:k.senderId,to:k.recipientId??"",timestamp:s.epochMs+k.timestamp*1e3,status:"confirmed",blockNumber:BigInt(v.height),action:R,direction:w,assets:[{assetType:"native",value:I,symbol:O,decimals:r}]}}).filter(v=>v!==null).sort((v,k)=>k.timestamp-v.timestamp):[]))});s._eventBus||(s._eventBus=yield*In());const y=yield*s._eventBus.forWalletEvents(s.chainId,o,["tx:confirmed"]).pipe(Yn(()=>Ve(h.refresh,()=>ge)),it),S=ze([h.stop,xe(y)]).pipe(Ae);return s._txHistorySources.set(i,{source:h,refCount:1,stopAll:S}),h}));s._txHistoryCreations.set(i,l);try{const f=await l;return c(f)}finally{s._txHistoryCreations.delete(i)}})}releaseSharedTxHistorySource(t){const n=this;return $(function*(){const r=n._txHistorySources.get(t);r&&(r.refCount-=1,r.refCount<=0&&(yield*r.stopAll,n._txHistorySources.delete(t)))})}getSharedBalanceSource(t,n,r){const s=this,i=t.toLowerCase(),c=l=>({...l,stop:s.releaseSharedBalanceSource(i)}),a=s._balanceSources.get(i);if(a)return a.refCount+=1,z(c(a.source));const u=s._balanceCreations.get(i);return W(u?async()=>{const l=await u,f=s._balanceSources.get(i);return f&&(f.refCount+=1),c(l)}:async()=>{const l=J($(function*(){const f=yield*s.getSharedTxHistorySource(t,n,r),h=yield*Le({name:`biowallet.${s.chainId}.balance`,dependsOn:f.ref,hasChanged:()=>!0,fetch:(y,S)=>s.fetchAddressAsset(t,S??!1).pipe(j(_=>{if(!_.result?.assets)return{amount:ee.zero(r,n),symbol:n};for(const T of Object.values(_.result.assets))for(const C of Object.values(T))if(C.assetType===n)return{amount:ee.fromRaw(C.assetNumber,r,n),symbol:n};return{amount:ee.zero(r,n),symbol:n}}))}),m=ze([h.stop,f.stop]).pipe(Ae);return s._balanceSources.set(i,{source:h,refCount:1,stopAll:m}),h}));s._balanceCreations.set(i,l);try{const f=await l;return c(f)}finally{s._balanceCreations.delete(i)}})}releaseSharedBalanceSource(t){const n=this;return $(function*(){const r=n._balanceSources.get(t);r&&(r.refCount-=1,r.refCount<=0&&(yield*r.stopAll,n._balanceSources.delete(t)))})}getSharedTokenBalancesSource(t,n,r){const s=this,i=t.toLowerCase(),c=l=>({...l,stop:s.releaseSharedTokenBalancesSource(i)}),a=s._tokenBalanceSources.get(i);if(a)return a.refCount+=1,z(c(a.source));const u=s._tokenBalanceCreations.get(i);return W(u?async()=>{const l=await u,f=s._tokenBalanceSources.get(i);return f&&(f.refCount+=1),c(l)}:async()=>{const l=J($(function*(){const f=yield*s.getSharedTxHistorySource(t,n,r),h=yield*Le({name:`biowallet.${s.chainId}.tokenBalances`,dependsOn:f.ref,hasChanged:()=>!0,fetch:(y,S)=>s.fetchAddressAsset(t,S??!1).pipe(j(_=>{if(!_.result?.assets)return[];const T=[];for(const C of Object.values(_.result.assets))for(const v of Object.values(C)){const k=v.assetType===n;T.push({symbol:v.assetType,name:v.assetType,amount:ee.fromRaw(v.assetNumber,r,v.assetType),isNative:k,decimals:r})}return T.sort((C,v)=>C.isNative&&!v.isNative?-1:!C.isNative&&v.isNative?1:v.amount.toNumber()-C.amount.toNumber()),T}))}),m=ze([h.stop,f.stop]).pipe(Ae);return s._tokenBalanceSources.set(i,{source:h,refCount:1,stopAll:m}),h}));s._tokenBalanceCreations.set(i,l);try{const f=await l;return c(f)}finally{s._tokenBalanceCreations.delete(i)}})}releaseSharedTokenBalancesSource(t){const n=this;return $(function*(){const r=n._tokenBalanceSources.get(t);r&&(r.refCount-=1,r.refCount<=0&&(yield*r.stopAll,n._tokenBalanceSources.delete(t)))})}createTransactionHistorySource(t,n,r){return this.getSharedTxHistorySource(t.address,n,r)}createBalanceSource(t,n,r){return this.getSharedBalanceSource(t.address,n,r)}createTokenBalancesSource(t,n,r){return this.getSharedTokenBalancesSource(t.address,n,r)}createBlockHeightSource(){return this.getSharedBlockHeightSource()}createTransactionSource(t){const n=this;return $(function*(){const r=ze({pending:n.fetchPendingTransactions(t.senderId??""),confirmed:n.fetchSingleTransaction(t.txHash)}).pipe(j(({pending:o,confirmed:i})=>{if(i.result?.trs?.length){const c=i.result.trs[0];return _S(c.transaction,{signature:c.transaction.signature??c.signature,height:c.height,status:"confirmed",epochMs:n.epochMs})}if(o.result&&o.result.length>0){const c=o.result.find(a=>a.signature===t.txHash);if(c)return _S(c.trJson,{signature:c.trJson.signature??c.signature??"",status:"pending",createdTime:c.createdTime,epochMs:n.epochMs})}return null}));return yield*Te({name:`biowallet.${n.chainId}.transaction`,fetch:r,interval:ae(n.forgeInterval)})})}fetchBlockHeight(){return te({url:`${this.baseUrl}/lastblock`,schema:k3,cacheStrategy:"network-first",cache:"no-store",headers:{"Cache-Control":"no-cache"}})}fetchAddressAsset(t,n=!1){return te({url:`${this.baseUrl}/address/asset`,method:"POST",body:{address:t},schema:f3,cacheStrategy:n?"network-first":"cache-first"})}fetchTransactionList(t,n=!1){return te({url:`${this.baseUrl}/transactions/query`,method:"POST",body:{address:t.address,page:t.page??1,pageSize:t.limit??50,sort:-1},schema:bS,cacheStrategy:n?"network-first":"cache-first"})}fetchSingleTransaction(t){return te({url:`${this.baseUrl}/transactions/query`,method:"POST",body:{signature:t},schema:bS,cacheStrategy:"ttl",cacheTtl:this.pendingTxCacheTtl})}fetchPendingTransactions(t){return te({url:`${this.baseUrl}/pendingTr`,method:"POST",body:{senderId:t,sort:-1},schema:C3,cacheStrategy:"ttl",cacheTtl:this.pendingTxCacheTtl})}}function kE(e,t){return e.type==="biowallet-v1"?new TE(e,t):null}const A3=A({success:ve,result:b(we(De(g,N)))}),R3=De(A3,g,N),O3=A({blockNumber:b(g),timeStamp:g,hash:g,from:g,to:g,value:g,isError:b(g),txreceipt_status:b(g)}),P3=A({blockNumber:b(g),timeStamp:g,hash:g,from:g,to:g,value:g,tokenSymbol:b(g),tokenName:b(g),tokenDecimal:b(g),contractAddress:b(g)}),x3=A({status:b(g),message:b(g),result:fe(O3)}),F3=A({status:b(g),message:b(g),result:fe(P3)}),N3=A({success:ve,result:b(x3)}),B3=A({success:ve,result:b(F3)}),EE=A({amount:we(De(g,N)),contractAddress:b(we(g)),decimals:b(we(N)),icon:b(we(g)),symbol:b(we(g)),name:b(we(g))}),M3=fe(EE),L3=A({success:ve,result:b(we(fe(EE)))}),wS=De(M3,L3),H3=A({chain:b(g),address:g,name:g,icon:b(g),symbol:g,decimals:N}),D3=A({data:fe(H3),page:N,pageSize:N,total:N,pages:b(N)}),U3=A({success:ve,result:b(D3)});function vS(e,t,n){const r=e.toLowerCase(),s=t.toLowerCase();return r===n&&s===n?"self":r===n?"out":"in"}function ji(e){return e==null?"0":String(e)}function Et(e){return typeof e=="object"&&e!==null}function Ir(e){if(typeof e=="bigint")return e;if(typeof e=="number"&&Number.isFinite(e))return BigInt(Math.trunc(e));if(typeof e=="string"){const t=e.trim();if(t.length===0)return null;try{if(t.startsWith("0x")||t.startsWith("0X")||/^-?\d+$/.test(t))return BigInt(t)}catch{return null}}return null}function jf(e){return e===0n?"0x0":`0x${e.toString(16)}`}function TS(e){if(!Et(e)||!Et(e.txData)||!Et(e.detail))return null;const t=e.txData,n=e.detail;return typeof t.nonce!="number"||typeof t.gasPrice!="string"||typeof t.gasLimit!="string"||typeof t.to!="string"||typeof t.value!="string"||typeof t.data!="string"||typeof t.chainId!="number"||typeof n.from!="string"||typeof n.to!="string"||typeof n.amount!="string"||typeof n.fee!="string"||typeof n.assetSymbol!="string"?null:e}function K3(e){if(typeof e=="string")return{rawTx:e,detail:{from:"",to:"",amount:"0",fee:"0",assetSymbol:"BNB"}};if(!Et(e)||typeof e.rawTx!="string"||!Et(e.detail))throw new Z(ce.TX_BROADCAST_FAILED,"Invalid signed transaction payload",{provider:"bscwallet-v1"});const t=e.detail;if(typeof t.from!="string"||typeof t.to!="string"||typeof t.amount!="string"||typeof t.fee!="string"||typeof t.assetSymbol!="string")throw new Z(ce.TX_BROADCAST_FAILED,"Invalid broadcast detail payload",{provider:"bscwallet-v1"});return e}function qs(e){const t=e.trim();if(!t)return t;const n=t.startsWith("0x")?t.slice(2):t;if(!/^[0-9a-fA-F]+$/.test(n)||n.length%2!==0)return t;try{return new TextDecoder().decode(Dn(n)).trim()||t}catch{return t}}function Fa(e){if(!e)return"Unknown error";if(typeof e=="string")return qs(e);if(e instanceof Error)return qs(e.message);if(!Et(e))return String(e);if(Et(e.error)){const t=Fa(e.error);if(t)return t}return typeof e.message=="string"&&e.message.trim()?qs(e.message):typeof e.info=="string"&&e.info.trim()?qs(e.info):typeof e.reason=="string"&&e.reason.trim()?qs(e.reason):typeof e.code=="string"&&e.code.trim()?qs(e.code):"Unknown error"}function j3(e){return!!(e===!0||Et(e)&&(e.success===!0||e.result===!0||e.status==="success"||typeof e.txHash=="string"&&e.txHash.length>0||typeof e.hash=="string"&&e.hash.length>0||typeof e.txid=="string"&&e.txid.length>0))}function z3(e){return Et(e)?typeof e.txHash=="string"&&e.txHash.length>0?e.txHash:typeof e.hash=="string"&&e.hash.length>0?e.hash:typeof e.txid=="string"&&e.txid.length>0?e.txid:Et(e.result)&&typeof e.result.txHash=="string"&&e.result.txHash.length>0?e.result.txHash:null:null}function V3(e){const t=e.startsWith("0x")?e.slice(2):e;return`0x${ur(co(Dn(t)))}`}function q3(e){return e instanceof Error?/timeout|timed out|etimedout|aborterror|aborted/i.test(e.message):!1}function Ws(e){return typeof e=="string"||typeof e=="number"?{success:!0,amount:ji(e)}:{success:e.success,amount:ji(e.result)}}function W3(e){return Promise.resolve(e.success)}function Gc(e){if(!e)return!1;const t=e.status?.toUpperCase(),n=e.message?.toUpperCase();return n==="NO TRANSACTIONS FOUND"?!0:!(t==="0"||n==="NOTOK")}function kS(e){return e.success?Promise.resolve(Gc(e.result)):Promise.resolve(!1)}function J3(e){return typeof e=="string"||typeof e=="number"?Promise.resolve(!0):Promise.resolve(e.success)}function ES(e){return Array.isArray(e)?Promise.resolve(!0):Promise.resolve(e.success)}function CS(e){return Array.isArray(e)?e:e.result??[]}function G3(e){return!e||!e.success?!1:Gc(e.result)}function Js(e,t){t.success}function Y3(e){if(typeof e=="number")return e;if(typeof e=="string"){const t=Number.parseInt(e,10);return Number.isNaN(t)?0:t}return 0}function IS(e,t){return!e||e.length!==t.length?!0:e.length===0&&t.length===0?!1:e[0]?.hash!==t[0]?.hash}function Q3(e,t){const n=new Map;for(const r of e)n.set(r.hash,r);for(const r of t){const s=n.get(r.hash);if(s){s.assets=[...s.assets,...r.assets],n.set(r.hash,s);continue}n.set(r.hash,r)}return Array.from(n.values()).sort((r,s)=>s.timestamp-r.timestamp)}function X3(e){const t=new Set;for(const n of e)for(const r of n.assets)r.assetType==="token"&&r.contractAddress&&t.add(r.contractAddress);return[...t].sort()}function $S(e){return!e.success||!e.result?[]:e.result.data.map(t=>t.address).filter(t=>t.length>0).map(t=>t.toLowerCase()).sort()}function Z3(e){return e.success&&e.result?e:{success:!0,result:{data:[],page:1,pageSize:0,total:0}}}function eV(e,t){return t.success&&Gc(t.result)?z(t):$t(new ct(`[bscwallet] ${e} NOTOK`))}function tV(e,t){return t.success&&Gc(t.result)?z(t):$t(new ct(`[bscwallet] ${e} NOTOK`))}class nV{chainId;type;endpoint;config;constructor(t,n){this.type=t.type,this.endpoint=t.endpoint,this.config=t.config,this.chainId=n}}class CE extends fi(hi(nV)){symbol;decimals;baseUrl;pollingInterval=3e4;balanceCacheTtlMs=5e3;tokenListCacheTtl=600*1e3;txTimeoutMs=3e4;defaultGasPrice=3000000000n;_normalHistoryDisabled=!1;_eventBus=null;_txHistorySources=new Map;_txHistoryCreations=new Map;_balanceSources=new Map;_balanceCreations=new Map;_tokenBalanceSources=new Map;_tokenBalanceCreations=new Map;_tokenListSource=null;_tokenListCreation=null;nativeBalance;tokenBalances;transactionHistory;constructor(t,n){super(t,n),this.symbol=he.getSymbol(n),this.decimals=he.getDecimals(n),this.baseUrl=this.endpoint;const r=this;this.transactionHistory=Se(`bscwallet.${n}.transactionHistory`,s=>r.createTransactionHistorySource(s)),this.nativeBalance=Se(`bscwallet.${n}.nativeBalance`,s=>r.createBalanceSource(s)),this.tokenBalances=Se(`bscwallet.${n}.tokenBalances`,s=>r.createTokenBalancesSource(s))}async buildTransaction(t){if(t.type!=="transfer")throw new Z(ce.NOT_SUPPORTED,`Transaction type not supported: ${t.type}`,{provider:this.type});const n=t,r=typeof n.tokenAddress=="string"&&n.tokenAddress.trim().length>0,s=n.tokenAddress?.trim().toLowerCase();try{const o=await this.fetchPrepInfo({from:n.from,to:n.to,amount:n.amount.toRawString(),isTokenTransfer:r,tokenAddress:s}),i=o.txCount??await this.fetchNonce(n.from),c=o.gasPrice??await this.fetchGasPrice(),a=o.gasLimit,u=this.resolveChainId();if(!Number.isSafeInteger(i)||i<0)throw new Error(`Invalid nonce from walletapi: ${i}`);let l=n.to,f=jf(n.amount.raw),h="0x";if(r&&s){const _=await this.fetchContractTransferData({from:n.from,to:n.to,amount:n.amount.toRawString(),contractAddress:s});l=s,f="0x0",h=_}const m={nonce:i,gasPrice:jf(c),gasLimit:jf(a),to:l,value:f,data:h,chainId:u},y=(c*a).toString(),S={from:n.from,to:n.to,amount:n.amount.toRawString(),fee:y,assetSymbol:n.amount.symbol||this.symbol};return{chainId:this.chainId,intentType:"transfer",data:{txData:m,detail:S}}}catch(o){if(o instanceof Z)throw o;const i=Fa(o);throw new Z(ce.TX_BUILD_FAILED,`BSC transaction build failed: ${i}`,{provider:this.type,reason:i},o instanceof Error?o:void 0)}}async estimateFee(t){const n=TS(t.data);if(!n)return super.estimateFee(t);const r=Ir(n.detail.fee);if(r===null||r<0n)throw new Z(ce.TX_BUILD_FAILED,"Invalid fee in BSC transaction payload",{provider:this.type,fee:n.detail.fee});const s=ee.fromRaw((r*80n/100n).toString(),this.decimals,this.symbol),o=ee.fromRaw(r.toString(),this.decimals,this.symbol),i=ee.fromRaw((r*120n/100n).toString(),this.decimals,this.symbol);return{slow:{amount:s,estimatedTime:30},standard:{amount:o,estimatedTime:12},fast:{amount:i,estimatedTime:6}}}async signTransaction(t,n){const r=TS(t.data);if(!r)return super.signTransaction(t,n);const s=await super.signTransaction({...t,data:r.txData},n);if(typeof s.data!="string")throw new Z(ce.SIGNATURE_FAILED,"Invalid signed payload for BSC transaction",{provider:this.type});return{chainId:s.chainId,data:{rawTx:s.data,detail:r.detail},signature:s.signature}}async broadcastTransaction(t){if(typeof t.data=="string")return super.broadcastTransaction(t);const n=K3(t.data);try{const r=await this.runWithTimeout(J(vn({url:`${this.baseUrl}/trans/send`,method:"POST",body:{signTransData:n.rawTx,detail:n.detail}})),this.txTimeoutMs);if(!j3(r)){const s=Fa(r);throw new Z(ce.TX_BROADCAST_FAILED,`Broadcast failed: ${s}`,Et(r)?{provider:this.type,reason:s,response:r}:{provider:this.type,reason:s})}return z3(r)??V3(n.rawTx)}catch(r){if(r instanceof Z)throw r;if(q3(r))throw new Z(ce.TRANSACTION_TIMEOUT,"BSC transaction broadcast timeout",{provider:this.type},r instanceof Error?r:void 0);const s=Fa(r);throw new Z(ce.TX_BROADCAST_FAILED,`Broadcast failed: ${s}`,{provider:this.type,reason:s},r instanceof Error?r:void 0)}}resolveChainId(){const t=Ir(this.config&&Et(this.config)?this.config.chainId??this.config.evmChainId:void 0);return t!==null&&t>0n&&t<=BigInt(Number.MAX_SAFE_INTEGER)?Number(t):56}async fetchPrepInfo(t){const n=await J(vn({url:`${this.baseUrl}/trans/prep`,method:"POST",body:{from:t.from,to:t.to,amount:t.amount,type:t.isTokenTransfer?2:1,...t.tokenAddress?{contractAddress:t.tokenAddress}:{}}})),r=Et(n)&&Et(n.result)?n.result:n;if(!Et(r))throw new Error("Invalid prep response");const s=Ir(r.txCount),o=Ir(r.gasPrice),i=Ir(r.contractGas),c=Ir(r.generalGas),a=t.isTokenTransfer?i??150000n:c??21000n;return{txCount:s===null?null:Number(s),gasPrice:o,gasLimit:a}}async fetchNonce(t){const n=await J(vn({url:`${this.baseUrl}/trans/count?address=${encodeURIComponent(t)}`})),r=Et(n)&&n.result!==void 0?n.result:n,s=Ir(r);if(s===null||s<0n||s>BigInt(Number.MAX_SAFE_INTEGER))throw new Error(`Invalid nonce response: ${String(r)}`);return Number(s)}async fetchGasPrice(){try{const t=await J(vn({url:`${this.baseUrl}/gasPrice`})),n=Et(t)&&t.result!==void 0?t.result:t,r=Ir(n);if(r!==null&&r>0n)return r}catch{}return this.defaultGasPrice}async fetchContractTransferData(t){const n=await J(vn({url:`${this.baseUrl}/trans/bep20/data`,method:"POST",body:{from:t.from,to:t.to,amount:t.amount,contractAddress:t.contractAddress}})),r=Et(n)&&n.result!==void 0?n.result:n;if(typeof r!="string"||r.trim().length===0)throw new Error(`Invalid bep20 transaction data: ${String(r)}`);const s=r.trim();return s.startsWith("0x")?s:`0x${s}`}async runWithTimeout(t,n){return await new Promise((r,s)=>{const o=setTimeout(()=>{s(new Error("Request timeout"))},n);t.then(i=>{clearTimeout(o),r(i)},i=>{clearTimeout(o),s(i)})})}createTransactionHistorySource(t){return this.getSharedTxHistorySource(t.address)}createBalanceSource(t){return this.getSharedBalanceSource(t.address).pipe(Dr(n=>this.createBalanceFallbackSource(t.address)))}createTokenBalancesSource(t){return this.getSharedTokenBalanceSource(t.address).pipe(Dr(n=>this.createTokenBalancesFallbackSource(t.address)))}createBalanceFallbackSource(t){const n=this.symbol,r=this.decimals;return Te({name:`bscwallet.${this.chainId}.balance.fallback`,interval:ae(this.pollingInterval),immediate:!0,fetch:this.fetchBalance(t,!0).pipe(j(s=>{const o=Ws(s);return{amount:ee.fromRaw(o.amount,r,n),symbol:n}}))})}createTokenBalancesFallbackSource(t){const n=this.symbol,r=this.decimals;return Te({name:`bscwallet.${this.chainId}.tokenBalances.fallback`,interval:ae(this.pollingInterval),immediate:!0,fetch:this.fetchTokenBalances(t,[],!0).pipe(j(s=>{const o=[],i=Ws(s.native);o.push({symbol:n,name:n,amount:ee.fromRaw(i.amount,r,n),isNative:!0,decimals:r});for(const c of s.tokens){const a=c.symbol??"BEP20",u=c.decimals??0;o.push({symbol:a,name:c.name??a,amount:ee.fromRaw(ji(c.amount),u,a),isNative:!1,decimals:u,icon:c.icon,contractAddress:c.contractAddress})}return o}))})}getSharedTxHistorySource(t){const n=this,r=t.toLowerCase(),s=r,o=this.symbol,i=this.decimals,c=l=>({...l,stop:n.releaseSharedTxHistorySource(s)}),a=n._txHistorySources.get(s);if(a)return a.refCount+=1,z(c(a.source));const u=n._txHistoryCreations.get(s);return W(u?async()=>{const l=await u,f=n._txHistorySources.get(s);return f&&(f.refCount+=1),c(l)}:async()=>{const l=J($(function*(){n._eventBus||(n._eventBus=yield*In());const f=n._eventBus,h=yield*Te({name:`bscwallet.${n.chainId}.txHistory.native.${s}`,fetch:n.fetchNativeHistory({address:t,limit:50},!0),interval:ae(n.pollingInterval),walletEvents:{eventBus:f,chainId:n.chainId,address:t,types:["tx:confirmed","tx:sent"]}}),m=yield*h.get;if(!G3(m))return yield*h.stop,yield*$t(new ct("[bscwallet] trans/normal/history NOTOK"));const y=yield*n.getSharedTokenListSource(),S=yield*Rt(0),_=nn(S,E=>E+1).pipe(Ae),T=yield*Rt(new Map),C=[],v=E=>it(E.pipe(ps(()=>_),gr));C.push(yield*v(h.changes));const k=new Map,R=new Map,w=E=>$(function*(){if(k.has(E))return;const V=yield*Te({name:`bscwallet.${n.chainId}.txHistory.bep20.${s}.${E}`,fetch:n.fetchTokenHistory({address:t,limit:50,contractAddress:E},!0),interval:ae(n.pollingInterval),immediate:!1,walletEvents:{eventBus:f,chainId:n.chainId,address:t,types:["tx:confirmed","tx:sent"]}});k.set(E,V);const q=yield*it(V.changes.pipe(Yn(D=>nn(T,B=>{const F=new Map(B);return F.set(E,D),F}).pipe(Ce(_)))));R.set(E,q),yield*it(V.refresh.pipe(Ae))}),I=E=>$(function*(){const V=k.get(E);V&&(yield*V.stop,k.delete(E));const q=R.get(E);q&&(yield*xe(q),R.delete(E)),yield*nn(T,D=>{const B=new Map(D);return B.delete(E),B}).pipe(Ce(_))}),O=E=>$(function*(){const V=E?$S(E):[],q=new Set(V);for(const D of k.keys())q.has(D)||(yield*I(D));for(const D of q)k.has(D)||(yield*w(D))});yield*O(yield*y.get),C.push(yield*it(y.changes.pipe(Yn(E=>O(E).pipe(Ce(_))))));const H=yield*Le({name:`bscwallet.${n.chainId}.txHistory.${s}`,dependsOn:S,hasChanged:(E,V)=>E!==V,fetch:()=>$(function*(){const V=((yield*h.get)?.result?.result??[]).map(B=>{const F=B.isError==="1"||B.txreceipt_status==="0"?"failed":"confirmed";return{hash:B.hash,from:B.from,to:B.to,timestamp:parseInt(B.timeStamp,10)*1e3,status:F,blockNumber:B.blockNumber?BigInt(B.blockNumber):void 0,action:"transfer",direction:vS(B.from,B.to,r),assets:[{assetType:"native",value:B.value,symbol:o,decimals:i}]}}),D=[...(yield*Lt(T)).values()].flatMap(B=>(B?.result?.result??[]).map(F=>{const ue=F.tokenSymbol??"BEP20",je=Y3(F.tokenDecimal),Wt=F.contractAddress?.toLowerCase();return{hash:F.hash,from:F.from,to:F.to,timestamp:parseInt(F.timeStamp,10)*1e3,status:"confirmed",blockNumber:F.blockNumber?BigInt(F.blockNumber):void 0,action:"transfer",direction:vS(F.from,F.to,r),assets:[{assetType:"token",value:F.value,symbol:ue,decimals:je,contractAddress:Wt,name:F.tokenName}]}}));return Q3(V,D)})}),x=$(function*(){for(const E of C)yield*xe(E);for(const E of k.values())yield*E.stop;for(const E of R.values())yield*xe(E);yield*H.stop,yield*h.stop,yield*n.releaseSharedTokenListSource()});return n._txHistorySources.set(s,{source:H,refCount:1,stopAll:x}),H}));n._txHistoryCreations.set(s,l);try{const f=await l;return c(f)}finally{n._txHistoryCreations.delete(s)}})}releaseSharedTxHistorySource(t){const n=this;return $(function*(){const r=n._txHistorySources.get(t);r&&(r.refCount-=1,r.refCount<=0&&(yield*r.stopAll,n._txHistorySources.delete(t)))})}getSharedBalanceSource(t){const n=this,r=t.toLowerCase(),s=this.symbol,o=this.decimals,i=u=>({...u,stop:n.releaseSharedBalanceSource(r)}),c=n._balanceSources.get(r);if(c)return c.refCount+=1,z(i(c.source));const a=n._balanceCreations.get(r);return W(a?async()=>{const u=await a,l=n._balanceSources.get(r);return l&&(l.refCount+=1),i(u)}:async()=>{const u=J($(function*(){const l=yield*Ve(n.getSharedTxHistorySource(t),w=>$(function*(){return null}));if(l===null){const w=yield*Te({name:`bscwallet.${n.chainId}.balance.poll`,interval:ae(n.pollingInterval),immediate:!0,fetch:n.fetchBalance(t,!0).pipe(j(I=>{const O=Ws(I);return{amount:ee.fromRaw(O.amount,o,s),symbol:s}}))});return n._balanceSources.set(r,{source:w,refCount:1,stopAll:w.stop}),w}const f=yield*Rt(null),h=yield*Rt(0),m=nn(h,w=>w+1).pipe(Ae),y=w=>{const I=Ws(w);return{amount:ee.fromRaw(I.amount,o,s),symbol:s}},S=yield*Le({name:`bscwallet.${n.chainId}.balance.dep`,dependsOn:l.ref,hasChanged:IS,fetch:(w,I)=>n.fetchBalance(t,I).pipe(j(y),Ie(O=>Pt(f,O)))}),_=(yield*l.get)===null,T=yield*Te({name:`bscwallet.${n.chainId}.balance.poll`,interval:ae(n.pollingInterval),immediate:_,fetch:$(function*(){const w=yield*l.get,I=yield*Lt(f);if(w!==null&&I!==null)return I;const O=yield*n.fetchBalance(t,!0),H=y(O);return yield*Pt(f,H),H})}),C=[],v=w=>it(w.pipe(ps(()=>m),gr));C.push(yield*v(S.changes)),C.push(yield*v(T.changes));const k=yield*Le({name:`bscwallet.${n.chainId}.balance`,dependsOn:h,hasChanged:(w,I)=>w!==I,fetch:()=>$(function*(){const w=yield*Lt(f);return w||(yield*$t(new ct("[bscwallet] balance cache empty")))})}),R=$(function*(){for(const w of C)yield*xe(w);yield*S.stop,yield*T.stop,yield*k.stop,yield*l.stop});return n._balanceSources.set(r,{source:k,refCount:1,stopAll:R}),k}));n._balanceCreations.set(r,u);try{const l=await u;return i(l)}finally{n._balanceCreations.delete(r)}})}releaseSharedBalanceSource(t){const n=this;return $(function*(){const r=n._balanceSources.get(t);r&&(r.refCount-=1,r.refCount<=0&&(yield*r.stopAll,n._balanceSources.delete(t)))})}getSharedTokenBalanceSource(t){const n=this,r=t.toLowerCase(),s=this.symbol,o=this.decimals,i=u=>({...u,stop:n.releaseSharedTokenBalanceSource(r)}),c=n._tokenBalanceSources.get(r);if(c)return c.refCount+=1,z(i(c.source));const a=n._tokenBalanceCreations.get(r);return W(a?async()=>{const u=await a,l=n._tokenBalanceSources.get(r);return l&&(l.refCount+=1),i(u)}:async()=>{const u=J($(function*(){const l=yield*Ve(n.getSharedTxHistorySource(t),w=>$(function*(){return null}));if(l===null){const w=yield*Te({name:`bscwallet.${n.chainId}.tokenBalances.poll`,interval:ae(n.pollingInterval),immediate:!0,fetch:n.fetchTokenBalances(t,[],!0).pipe(j(I=>{const O=[],H=Ws(I.native);O.push({symbol:s,name:s,amount:ee.fromRaw(H.amount,o,s),isNative:!0,decimals:o});for(const x of I.tokens){const E=x.symbol??"BEP20",V=x.decimals??0;O.push({symbol:E,name:x.name??E,amount:ee.fromRaw(ji(x.amount),V,E),isNative:!1,decimals:V,icon:x.icon,contractAddress:x.contractAddress})}return O}))});return n._tokenBalanceSources.set(r,{source:w,refCount:1,stopAll:w.stop}),w}const f=yield*Rt(null),h=yield*Rt(0),m=nn(h,w=>w+1).pipe(Ae),y=w=>{const I=[],O=Ws(w.native);I.push({symbol:s,name:s,amount:ee.fromRaw(O.amount,o,s),isNative:!0,decimals:o});for(const H of w.tokens){const x=H.symbol??"BEP20",E=H.decimals??0;I.push({symbol:x,name:H.name??x,amount:ee.fromRaw(ji(H.amount),E,x),isNative:!1,decimals:E,icon:H.icon,contractAddress:H.contractAddress})}return I},S=yield*Le({name:`bscwallet.${n.chainId}.tokenBalances.dep`,dependsOn:l.ref,hasChanged:IS,fetch:(w,I)=>n.fetchTokenBalances(t,X3(w),I).pipe(j(y),Ie(O=>Pt(f,O)))}),_=(yield*l.get)===null,T=yield*Te({name:`bscwallet.${n.chainId}.tokenBalances.poll`,interval:ae(n.pollingInterval),immediate:_,fetch:$(function*(){const w=yield*l.get,I=yield*Lt(f);if(w!==null&&I!==null)return I;const O=yield*n.fetchTokenBalances(t,[],!0),H=y(O);return yield*Pt(f,H),H})}),C=[],v=w=>it(w.pipe(ps(()=>m),gr));C.push(yield*v(S.changes)),C.push(yield*v(T.changes));const k=yield*Le({name:`bscwallet.${n.chainId}.tokenBalances`,dependsOn:h,hasChanged:(w,I)=>w!==I,fetch:()=>$(function*(){const w=yield*Lt(f);return w||(yield*$t(new ct("[bscwallet] tokenBalances cache empty")))})}),R=$(function*(){for(const w of C)yield*xe(w);yield*S.stop,yield*T.stop,yield*k.stop,yield*l.stop});return n._tokenBalanceSources.set(r,{source:k,refCount:1,stopAll:R}),k}));n._tokenBalanceCreations.set(r,u);try{const l=await u;return i(l)}finally{n._tokenBalanceCreations.delete(r)}})}releaseSharedTokenBalanceSource(t){const n=this;return $(function*(){const r=n._tokenBalanceSources.get(t);r&&(r.refCount-=1,r.refCount<=0&&(yield*r.stopAll,n._tokenBalanceSources.delete(t)))})}getSharedTokenListSource(){const t=this;return t._tokenListSource?(t._tokenListSource.refCount+=1,z(t._tokenListSource.source)):t._tokenListCreation?W(async()=>{const n=await t._tokenListCreation;return t._tokenListSource&&(t._tokenListSource.refCount+=1),n}):W(async()=>{const n=J($(function*(){const r=yield*Te({name:`bscwallet.${t.chainId}.tokenList`,fetch:t.fetchTokenList(!1),interval:ae(t.tokenListCacheTtl),immediate:!0});return t._tokenListSource={source:r,refCount:1,stopAll:r.stop},r}));t._tokenListCreation=n;try{return await n}finally{t._tokenListCreation=null}})}releaseSharedTokenListSource(){const t=this;return $(function*(){const n=t._tokenListSource;n&&(n.refCount-=1,n.refCount<=0&&(yield*n.stopAll,t._tokenListSource=null))})}fetchBalance(t,n=!1){return te({url:`${this.baseUrl}/balance?address=${t}`,schema:R3,cacheStrategy:n?"ttl":"cache-first",cacheTtl:this.balanceCacheTtlMs,canCache:J3}).pipe(Ie(r=>{typeof r=="object"&&r!==null&&"success"in r&&Js("balance",r)}))}fetchNativeHistory(t,n=!1){return this._normalHistoryDisabled?$t(new ct("[bscwallet] trans/normal/history disabled")):te({url:`${this.baseUrl}/trans/normal/history`,method:"POST",body:{address:t.address,page:1,offset:t.limit??50},schema:N3,cacheStrategy:n?"ttl":"cache-first",cacheTtl:this.balanceCacheTtlMs,canCache:kS}).pipe(Ie(r=>Js("trans/normal/history",r)),X(r=>(r.success&&r.result&&!Gc(r.result)&&(this._normalHistoryDisabled=!0),eV("trans/normal/history",r))))}fetchTokenHistory(t,n=!1){return t.contractAddress?te({url:`${this.baseUrl}/trans/bep20/history`,method:"POST",body:{address:t.address,contractaddress:t.contractAddress,page:1,offset:t.limit??50},schema:B3,cacheStrategy:n?"ttl":"cache-first",cacheTtl:this.balanceCacheTtlMs,canCache:kS}).pipe(Ie(r=>Js("trans/bep20/history",r)),X(r=>tV("trans/bep20/history",r))):z({success:!0,result:{result:[]}})}fetchTokenBalances(t,n,r=!1){const s=[...n].sort();if(s.length===0){const o=this;return $(function*(){const i=yield*o.fetchTokenList(!1),c=$S(i),a=yield*o.fetchBalance(t,r);if(c.length===0)return{native:a,tokens:[]};const u=yield*te({url:`${o.baseUrl}/account/balance/v2`,method:"POST",body:{address:t,contracts:c},schema:wS,cacheStrategy:r?"ttl":"cache-first",cacheTtl:o.balanceCacheTtlMs,canCache:ES}).pipe(Ie(l=>{Array.isArray(l)||Js("account/balance/v2",l)}),j(CS),Ve(()=>z([])));return{native:a,tokens:u}})}return ze({native:this.fetchBalance(t,r),tokens:te({url:`${this.baseUrl}/account/balance/v2`,method:"POST",body:{address:t,contracts:s},schema:wS,cacheStrategy:r?"ttl":"cache-first",cacheTtl:this.balanceCacheTtlMs,canCache:ES}).pipe(Ie(o=>{Array.isArray(o)||Js("account/balance/v2",o)}),j(CS),Ve(()=>z([])))})}fetchTokenList(t=!1){return te({url:`${this.baseUrl}/contract/tokens`,method:"POST",body:{page:1,pageSize:50,chain:"BSC"},schema:U3,cacheStrategy:t?"network-first":"ttl",cacheTtl:this.tokenListCacheTtl,canCache:W3}).pipe(Ie(n=>Js("contract/tokens",n)),j(Z3))}}function IE(e,t){return e.type==="bscwallet-v1"?new CE(e,t):null}const fa="123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz";function $E(e){return class extends e{async deriveAddress(n,r=0){const s=new TextDecoder().decode(n);return Na(s,"tron",r).address}async deriveAddresses(n,r,s){const o=new TextDecoder().decode(n),i=[];for(let c=0;c<s;c++){const a=Na(o,"tron",r+c);i.push(a.address)}return i}isValidAddress(n){if(!n.startsWith("T")||n.length!==34)return!1;for(const r of n)if(!fa.includes(r))return!1;try{const r=this.#e(n);if(r.length!==25)return!1;const s=r.slice(0,21),o=r.slice(21),i=Ar(Ar(s));return o.every((c,a)=>c===i[a])}catch{return!1}}#e(n){let r=BigInt(0);for(const i of n){const c=fa.indexOf(i);if(c===-1)throw new Error(`Invalid base58 character: ${i}`);r=r*58n+BigInt(c)}const s=r.toString(16).padStart(50,"0"),o=new Uint8Array(25);for(let i=0;i<25;i++)o[i]=parseInt(s.slice(i*2,i*2+2),16);return o}normalizeAddress(n){return n}async signMessage(n,r){const s=typeof n=="string"?new TextEncoder().encode(n):n,o=new TextEncoder().encode(`TRON Signed Message:
`+s.length),i=co(new Uint8Array([...o,...s])),c=wo.sign(i,r,{prehash:!1,format:"recovered"});return ur(c)}async verifyMessage(n,r,s){try{const o=typeof n=="string"?new TextEncoder().encode(n):n,i=new TextEncoder().encode(`TRON Signed Message:
`+o.length),c=co(new Uint8Array([...i,...o])),a=Dn(r),u=wo.recoverPublicKey(c,a);if(!u)return!1;const f=co(u.slice(1)).slice(-20),h=new Uint8Array([65,...f]),m=Ar(Ar(h)).slice(0,4),y=new Uint8Array([...h,...m]);return this.#n(y)===s}catch{return!1}}#n(n){let r=BigInt(0);for(const o of n)r=r*256n+BigInt(o);let s="";for(;r>0n;){const o=Number(r%58n);r=r/58n,s=fa[o]+s}for(const o of n)if(o===0)s=fa[0]+s;else break;return s}}}const rV="https://api.trongrid.io";function Yo(e){return typeof e=="object"&&e!==null}function sV(e,t){const n=Dn(e),r=wo.sign(n,t,{prehash:!1,format:"recovered"}),s=r[0],o=r.subarray(1),i=(s+27).toString(16).padStart(2,"0");return`${ur(o)}${i}`}function oV(e){if(typeof e!="string")return null;const t=e.trim();if(!t)return null;const n=t.startsWith("0x")?t.slice(2):t;if(!/^[0-9a-fA-F]+$/.test(n)||n.length%2!==0)return t;try{return new TextDecoder().decode(Dn(n)).trim()||t}catch{return t}}function iV(e){if(!Yo(e))return"Unknown error";const t=[e.message,e.code,e.error];Yo(e.result)&&t.push(e.result.message,e.result.code,e.result.error);for(const n of t){const r=oV(n);if(r)return r}return"Unknown error"}function cV(e){return Yo(e)?typeof e.result=="boolean"?e.result:typeof e.success=="boolean"?e.success:!1:!1}function aV(e){const t=e.data;return Yo(t)&&Yo(t.signedTx)?t.signedTx:t}function AE(e){return class extends e{#e=null;#n="";#t(){if(!this.#e){const n=he.getConfig(this.chainId);if(!n)throw new Z(ce.CHAIN_NOT_SUPPORTED,`Chain config not found: ${this.chainId}`);this.#e=n,this.#n=he.getRpcUrl(this.chainId)||rV}return this.#e}async#r(n,r){const s=`${this.#n}${n}`,o=r?{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(r)}:{method:"GET"},i=await fetch(s,o);if(!i.ok)throw new Z(ce.NETWORK_ERROR,`Tron API error: ${i.status} ${i.statusText}`);return i.json()}#o(n){const r="123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz";let s=BigInt(0);for(const i of n){const c=r.indexOf(i);if(c===-1)throw new Error(`Invalid base58 character: ${i}`);s=s*58n+BigInt(c)}return s.toString(16).padStart(50,"0").slice(0,42)}async buildTransaction(n){if(n.type!=="transfer")throw new Z(ce.NOT_SUPPORTED,`Transaction type not supported: ${n.type}`);const r=n;if(r.tokenAddress)throw new Z(ce.NOT_SUPPORTED,"TRC20 transaction builder not available");const s=this.#t(),o=this.#o(r.from),i=this.#o(r.to),c=await this.#r("/wallet/createtransaction",{owner_address:o,to_address:i,amount:Number(r.amount.raw),visible:!1});if(!c.txID)throw new Z(ce.TX_BUILD_FAILED,"Failed to create Tron transaction");return{chainId:s.id,intentType:"transfer",data:c}}async estimateFee(n){const r=this.#t(),o={amount:ee.fromRaw("0",r.decimals,r.symbol),estimatedTime:3};return{slow:o,standard:o,fast:o}}async signTransaction(n,r){if(!r.privateKey)throw new Z(ce.SIGNATURE_FAILED,"privateKey is required for Tron signing");const s=n.data,o=sV(s.txID,r.privateKey),i={...s,signature:[o]};return{chainId:n.chainId,data:i,signature:o}}async broadcastTransaction(n){const r=aV(n),s=await this.#r("/wallet/broadcasttransaction",r);if(!cV(s)){const o=iV(s);throw new Z(ce.TX_BROADCAST_FAILED,`Broadcast failed: ${o}`,{reason:o,response:Yo(s)?s:void 0})}return typeof s.txid=="string"&&s.txid.length>0?s.txid:r.txID}}}const RE=GS(Ar);function Gm(e){return e.startsWith("0x")||e.startsWith("0X")?e.slice(2):e}function Ym(e){return/^[0-9a-fA-F]+$/.test(e)}function uV(e){const t=Gm(e);if(t.length%2!==0||!Ym(t))throw new Error(`Invalid hex: ${e}`);const n=new Uint8Array(t.length/2);for(let r=0;r<n.length;r++)n[r]=parseInt(t.slice(r*2,r*2+2),16);return n}function lV(e){return Array.from(e,t=>t.toString(16).padStart(2,"0")).join("")}function rr(e){const t=e.trim(),n=Gm(t);if(n.length===42&&Ym(n)&&n.startsWith("41"))return n;if(!t.startsWith("T"))throw new Error(`Invalid Tron address: ${e}`);const r=RE.decode(t);if(r.length!==21)throw new Error(`Invalid Tron address length: ${e}`);return lV(r)}function fV(e){const t=Gm(e).toLowerCase();if(!Ym(t))throw new Error(`Invalid Tron hex address: ${e}`);const n=t.length===40?`41${t}`:t;if(n.length!==42)throw new Error(`Invalid Tron hex length: ${e}`);const r=uV(n);return RE.encode(r)}function mt(e){const t=e.trim();return t.startsWith("T")?t:fV(t)}function ir(e){return rr(e).toLowerCase()}const hV=A({balance:b(N),address:b(g)}),dV=A({block_header:b(A({raw_data:b(A({number:b(N)}))}))}),pV=A({amount:b(N),owner_address:b(g),to_address:b(g)}),mV=A({parameter:b(A({value:b(pV)})),type:b(g)}),OE=A({txID:g,block_timestamp:b(N),raw_data:b(A({contract:b(fe(mV)),timestamp:b(N)})),ret:b(fe(A({contractRet:b(g)})))}),gV=A({success:ve,data:b(fe(OE))});function zf(e){try{return ir(e)}catch{return e.toLowerCase()}}function AS(e,t,n){const r=zf(e),s=zf(t),o=zf(n);return r===o&&s===o?"self":r===o?"out":"in"}function yV(e,t){return!e||e.length!==t.length?!0:e.length===0&&t.length===0?!1:e[0]?.hash!==t[0]?.hash}class SV{chainId;type;endpoint;config;constructor(t,n){this.type=t.type,this.endpoint=t.endpoint,this.config=t.config,this.chainId=n}}class PE extends $E(AE(SV)){symbol;decimals;baseUrl;headers;pollingInterval=3e4;_eventBus=null;_txHistorySources=new Map;_txHistoryCreations=new Map;_balanceSources=new Map;_balanceCreations=new Map;nativeBalance;transactionHistory;transaction;blockHeight;constructor(t,n){super(t,n),this.symbol=he.getSymbol(n),this.decimals=he.getDecimals(n),this.baseUrl=this.endpoint;const r=Xl(this.config?.apiKeyEnv,`trongrid-${n}`);this.headers=r?{"TRON-PRO-API-KEY":r}:{};const s=this;this.blockHeight=Se(`tron-rpc.${n}.blockHeight`,()=>s.createBlockHeightSource()),this.transactionHistory=Se(`tron-rpc.${n}.transactionHistory`,o=>s.createTransactionHistorySource(o)),this.nativeBalance=Se(`tron-rpc.${n}.nativeBalance`,o=>s.createBalanceSource(o)),this.transaction=Se(`tron-rpc.${n}.transaction`,o=>s.createTransactionSource(o))}createBlockHeightSource(){return this.getSharedBlockHeightSource()}getSharedBlockHeightSource(){const t=this,n=Yl(this.chainId,"global","blockHeight"),r=t.fetchNowBlock(!0).pipe(j(s=>BigInt(s.block_header?.raw_data?.number??0)));return Ql(n,{fetch:r,interval:ae(t.pollingInterval)})}createTransactionHistorySource(t){return this.getSharedTxHistorySource(t.address)}createBalanceSource(t){return this.getSharedBalanceSource(t.address)}getSharedTxHistorySource(t){const n=this,r=mt(t),s=ir(t),o=this.symbol,i=this.decimals,c=l=>({...l,stop:n.releaseSharedTxHistorySource(s)}),a=n._txHistorySources.get(s);if(a)return a.refCount+=1,z(c(a.source));const u=n._txHistoryCreations.get(s);return W(u?async()=>{const l=await u,f=n._txHistorySources.get(s);return f&&(f.refCount+=1),c(l)}:async()=>{const l=J($(function*(){n._eventBus||(n._eventBus=yield*In());const f=n._eventBus,h=n.fetchTransactionList(r,!0).pipe(j(S=>!S.success||!S.data?[]:S.data.map(_=>{const C=_.raw_data?.contract?.[0]?.parameter?.value,v=C?.owner_address??"",k=C?.to_address??"",R=mt(v),w=mt(k),I=_.ret?.[0]?.contractRet==="SUCCESS"?"confirmed":"failed";return{hash:_.txID,from:R,to:w,timestamp:_.block_timestamp??_.raw_data?.timestamp??0,status:I,action:"transfer",direction:AS(v,k,r),assets:[{assetType:"native",value:(C?.amount??0).toString(),symbol:o,decimals:i}]}}))),m=yield*Te({name:`tron-rpc.${n.chainId}.txHistory.${s}`,fetch:h,interval:ae(n.pollingInterval),walletEvents:{eventBus:f,chainId:n.chainId,address:r,types:["tx:confirmed","tx:sent"]}}),y=m.stop;return n._txHistorySources.set(s,{source:m,refCount:1,stopAll:y}),m}));n._txHistoryCreations.set(s,l);try{const f=await l;return c(f)}finally{n._txHistoryCreations.delete(s)}})}releaseSharedTxHistorySource(t){const n=this;return $(function*(){const r=n._txHistorySources.get(t);r&&(r.refCount-=1,r.refCount<=0&&(yield*r.stopAll,n._txHistorySources.delete(t)))})}getSharedBalanceSource(t){const n=this,r=ir(t),s=this.symbol,o=this.decimals,i=u=>({...u,stop:n.releaseSharedBalanceSource(r)}),c=n._balanceSources.get(r);if(c)return c.refCount+=1,z(i(c.source));const a=n._balanceCreations.get(r);return W(a?async()=>{const u=await a,l=n._balanceSources.get(r);return l&&(l.refCount+=1),i(u)}:async()=>{const u=J($(function*(){const l=yield*n.getSharedTxHistorySource(t),f=yield*Le({name:`tron-rpc.${n.chainId}.balance`,dependsOn:l.ref,hasChanged:yV,fetch:(m,y)=>n.fetchAccount(t,y).pipe(j(S=>({amount:ee.fromRaw((S.balance??0).toString(),o,s),symbol:s})))}),h=ze([f.stop,l.stop]).pipe(Ae);return n._balanceSources.set(r,{source:f,refCount:1,stopAll:h}),f}));n._balanceCreations.set(r,u);try{const l=await u;return i(l)}finally{n._balanceCreations.delete(r)}})}releaseSharedBalanceSource(t){const n=this;return $(function*(){const r=n._balanceSources.get(t);r&&(r.refCount-=1,r.refCount<=0&&(yield*r.stopAll,n._balanceSources.delete(t)))})}createTransactionSource(t){const n=this,r=this.symbol,s=this.decimals;return $(function*(){const o=n.fetchTransactionById(t.txHash).pipe(j(c=>{if(!c.txID)return null;const u=c.raw_data?.contract?.[0]?.parameter?.value,l=u?.owner_address??"",f=u?.to_address??"",h=mt(l),m=mt(f);let y;!c.ret||c.ret.length===0?y="pending":y=c.ret[0]?.contractRet==="SUCCESS"?"confirmed":"failed";const S=t.senderId??h;return{hash:c.txID,from:h,to:m,timestamp:c.block_timestamp??c.raw_data?.timestamp??0,status:y,action:"transfer",direction:AS(l,f,S),assets:[{assetType:"native",value:(u?.amount??0).toString(),symbol:r,decimals:s}]}}));return yield*Te({name:`tron-rpc.${n.chainId}.transaction`,fetch:o,interval:ae(3e3)})})}fetchNowBlock(t=!1){return te({url:`${this.baseUrl}/wallet/getnowblock`,method:"POST",headers:this.headers,schema:dV,cacheStrategy:t?"network-first":"cache-first",cache:"no-store"})}fetchAccount(t,n=!1){return te({url:`${this.baseUrl}/wallet/getaccount`,method:"POST",headers:this.headers,body:{address:rr(t)},schema:hV,cacheStrategy:n?"network-first":"cache-first"})}fetchTransactionList(t,n=!1){const r=mt(t);return te({url:`${this.baseUrl}/v1/accounts/${r}/transactions`,headers:this.headers,schema:gV,cacheStrategy:n?"network-first":"cache-first"})}fetchTransactionById(t){return te({url:`${this.baseUrl}/wallet/gettransactionbyid`,method:"POST",headers:this.headers,body:{value:t},schema:OE,cacheStrategy:"ttl",cacheTtl:Math.max(1e3,Math.floor(this.pollingInterval/4))})}}function xE(e,t){return e.type==="tron-rpc"||e.type==="tron-rpc-pro"?new PE(e,t):null}function FE(e){return class extends e{async deriveAddress(n,r=0){const s=new TextDecoder().decode(n);return Qm(s,84,r).address}async deriveAddresses(n,r,s){const o=new TextDecoder().decode(n),i=[];for(let c=0;c<s;c++){const a=Qm(o,84,r+c);i.push(a.address)}return i}isValidAddress(n){try{if(n.startsWith("1")||n.startsWith("3"))return GS(Ar).decode(n).length===21;if(n.toLowerCase().startsWith("bc1q")){const r=n.toLowerCase(),s=Xm.decode(r),o=Xm.fromWords(s.words.slice(1));return s.prefix==="bc"&&s.words[0]===0&&o.length===20}if(n.toLowerCase().startsWith("bc1p")){const r=n.toLowerCase(),s=Zm.decode(r),o=Zm.fromWords(s.words.slice(1));return s.prefix==="bc"&&s.words[0]===1&&o.length===32}return!1}catch{return!1}}normalizeAddress(n){return n.startsWith("bc1")||n.startsWith("BC1")?n.toLowerCase():n}async signMessage(n,r){const s=typeof n=="string"?new TextEncoder().encode(n):n,o=new TextEncoder().encode(`Bitcoin Signed Message:
`),i=new Uint8Array([s.length]),c=new Uint8Array([...o,...i,...s]),a=Ar(Ar(c)),u=wo.sign(a,r,{prehash:!1,format:"recovered"});return ur(u)}async verifyMessage(n,r,s){return!1}}}const bV="https://mempool.space/api";function NE(e){return class extends e{#e=null;get#n(){return this.#e||(this.#e=he.getMempoolApi(this.chainId)??bV),this.#e}get#t(){return he.getConfig(this.chainId)}async#r(n,r){const s=`${this.#n}${n}`,o=await fetch(s,r);if(!o.ok)throw new Z(ce.NETWORK_ERROR,`Bitcoin API error: ${o.status}`);const i=await o.text();try{return JSON.parse(i)}catch{return i}}async buildTransaction(n){if(n.type!=="transfer")throw new Z(ce.NOT_SUPPORTED,`Transaction type not supported: ${n.type}`);const r=n,s=await this.#r(`/address/${r.from}/utxo`);if(s.length===0)throw new Z(ce.INSUFFICIENT_BALANCE,"No UTXOs available");const i=(await this.#r("/v1/fees/recommended")).halfHourFee,c=s.reduce((y,S)=>y+S.value,0),a=Number(r.amount.raw),u=10+s.length*68+62,l=i*u;if(c<a+l)throw new Z(ce.INSUFFICIENT_BALANCE,`Insufficient balance: need ${a+l}, have ${c}`);const f=c-a-l,h=this.#t,m={inputs:s.map(y=>({txid:y.txid,vout:y.vout,value:y.value,scriptPubKey:""})),outputs:[{address:r.to,value:a}],fee:l,changeAddress:r.from};return f>546&&m.outputs.push({address:r.from,value:f}),{chainId:h.id,intentType:"transfer",data:m}}async estimateFee(n){try{const r=await this.#r("/v1/fees/recommended"),s=140,o=this.#t,i={amount:ee.fromRaw((r.hourFee*s).toString(),o.decimals,o.symbol),estimatedTime:3600},c={amount:ee.fromRaw((r.halfHourFee*s).toString(),o.decimals,o.symbol),estimatedTime:1800},a={amount:ee.fromRaw((r.fastestFee*s).toString(),o.decimals,o.symbol),estimatedTime:600};return{slow:i,standard:c,fast:a}}catch{const r=this.#t,s={amount:ee.fromRaw("2000",r.decimals,r.symbol),estimatedTime:1800};return{slow:s,standard:s,fast:s}}}async signTransaction(n,r){throw new Z(ce.CHAIN_NOT_SUPPORTED,"Bitcoin transaction signing requires specialized library (bitcoinjs-lib or similar)")}async broadcastTransaction(n){const r=n.data;return await this.#r("/tx",{method:"POST",body:r})}}}const _V=A({chain_stats:A({funded_txo_sum:N,spent_txo_sum:N})}),wV=A({txid:g,vin:fe(A({prevout:b(A({scriptpubkey_address:b(g)}))})),vout:fe(A({scriptpubkey_address:b(g),value:b(N)})),status:A({confirmed:ve,block_time:b(N)})}),vV=fe(wV);function TV(e,t,n){const r=e?.some(o=>o.prevout?.scriptpubkey_address===n),s=t?.some(o=>o.scriptpubkey_address===n);return r&&s?"self":r?"out":"in"}function kV(e,t){return!e||e.length!==t.length?!0:e.length===0&&t.length===0?!1:e[0]?.hash!==t[0]?.hash}class EV{chainId;type;endpoint;config;constructor(t,n){this.type=t.type,this.endpoint=t.endpoint,this.config=t.config,this.chainId=n}}class BE extends FE(NE(EV)){symbol;decimals;baseUrl;pollingInterval=6e4;_eventBus=null;_txHistorySources=new Map;_txHistoryCreations=new Map;_balanceSources=new Map;_balanceCreations=new Map;nativeBalance;transactionHistory;blockHeight;constructor(t,n){super(t,n),this.symbol=he.getSymbol(n),this.decimals=he.getDecimals(n),this.baseUrl=this.endpoint;const r=this;this.blockHeight=Se(`mempool.${n}.blockHeight`,()=>r.createBlockHeightSource()),this.transactionHistory=Se(`mempool.${n}.transactionHistory`,s=>r.createTransactionHistorySource(s)),this.nativeBalance=Se(`mempool.${n}.nativeBalance`,s=>r.createBalanceSource(s))}createBlockHeightSource(){return this.getSharedBlockHeightSource()}getSharedBlockHeightSource(){const t=this,n=Yl(this.chainId,"global","blockHeight"),r=t.fetchBlockHeight(!0).pipe(j(s=>BigInt(s)));return Ql(n,{fetch:r,interval:ae(t.pollingInterval)})}createTransactionHistorySource(t){return this.getSharedTxHistorySource(t.address)}createBalanceSource(t){return this.getSharedBalanceSource(t.address)}getSharedTxHistorySource(t){const n=this,r=t,s=this.symbol,o=this.decimals,i=u=>({...u,stop:n.releaseSharedTxHistorySource(r)}),c=n._txHistorySources.get(r);if(c)return c.refCount+=1,z(i(c.source));const a=n._txHistoryCreations.get(r);return W(a?async()=>{const u=await a,l=n._txHistorySources.get(r);return l&&(l.refCount+=1),i(u)}:async()=>{const u=J($(function*(){n._eventBus||(n._eventBus=yield*In());const l=n._eventBus,f=n.fetchTransactionHistory(t,!0).pipe(j(y=>y.map(S=>({hash:S.txid,from:S.vin[0]?.prevout?.scriptpubkey_address??"",to:S.vout[0]?.scriptpubkey_address??"",timestamp:(S.status.block_time??0)*1e3,status:S.status.confirmed?"confirmed":"pending",action:"transfer",direction:TV(S.vin,S.vout,t),assets:[{assetType:"native",value:(S.vout[0]?.value??0).toString(),symbol:s,decimals:o}]})))),h=yield*Te({name:`mempool.${n.chainId}.txHistory.${r}`,fetch:f,interval:ae(n.pollingInterval),walletEvents:{eventBus:l,chainId:n.chainId,address:t,types:["tx:confirmed","tx:sent"]}}),m=h.stop;return n._txHistorySources.set(r,{source:h,refCount:1,stopAll:m}),h}));n._txHistoryCreations.set(r,u);try{const l=await u;return i(l)}finally{n._txHistoryCreations.delete(r)}})}releaseSharedTxHistorySource(t){const n=this;return $(function*(){const r=n._txHistorySources.get(t);r&&(r.refCount-=1,r.refCount<=0&&(yield*r.stopAll,n._txHistorySources.delete(t)))})}getSharedBalanceSource(t){const n=this,r=t,s=this.symbol,o=this.decimals,i=u=>({...u,stop:n.releaseSharedBalanceSource(r)}),c=n._balanceSources.get(r);if(c)return c.refCount+=1,z(i(c.source));const a=n._balanceCreations.get(r);return W(a?async()=>{const u=await a,l=n._balanceSources.get(r);return l&&(l.refCount+=1),i(u)}:async()=>{const u=J($(function*(){const l=yield*n.getSharedTxHistorySource(t),f=yield*Le({name:`mempool.${n.chainId}.balance`,dependsOn:l.ref,hasChanged:kV,fetch:(m,y)=>n.fetchAddressInfo(t,y).pipe(j(S=>{const _=S.chain_stats.funded_txo_sum-S.chain_stats.spent_txo_sum;return{amount:ee.fromRaw(_.toString(),o,s),symbol:s}}))}),h=ze([f.stop,l.stop]).pipe(Ae);return n._balanceSources.set(r,{source:f,refCount:1,stopAll:h}),f}));n._balanceCreations.set(r,u);try{const l=await u;return i(l)}finally{n._balanceCreations.delete(r)}})}releaseSharedBalanceSource(t){const n=this;return $(function*(){const r=n._balanceSources.get(t);r&&(r.refCount-=1,r.refCount<=0&&(yield*r.stopAll,n._balanceSources.delete(t)))})}fetchBlockHeight(t=!1){return te({url:`${this.baseUrl}/blocks/tip/height`,cacheStrategy:t?"network-first":"cache-first"})}fetchAddressInfo(t,n=!1){return te({url:`${this.baseUrl}/address/${t}`,schema:_V,cacheStrategy:n?"network-first":"cache-first"})}fetchTransactionHistory(t,n=!1){return te({url:`${this.baseUrl}/address/${t}/txs`,schema:vV,cacheStrategy:n?"network-first":"cache-first"})}}function ME(e,t){return e.type.startsWith("mempool-")?new BE(e,t):null}const CV=A({success:ve,result:b(De(g,N))}),IV=De(CV,g,N),$V=A({blockNumber:b(g),timeStamp:g,hash:g,from:g,to:g,value:g,isError:b(g),txreceipt_status:b(g),input:b(g),methodId:b(g),functionName:b(g)}),AV=A({blockNumber:b(g),timeStamp:g,hash:g,from:g,to:g,value:g,tokenSymbol:b(g),tokenName:b(g),tokenDecimal:b(g),contractAddress:b(g)}),RV=A({status:b(g),message:b(g),result:fe($V)}),OV=A({status:b(g),message:b(g),result:fe(AV)}),PV=A({success:ve,result:b(RV)}),xV=A({success:ve,result:b(OV)}),LE=A({amount:De(g,N),contractAddress:b(g),decimals:b(N),icon:b(g),symbol:b(g),name:b(g)}),FV=fe(LE),NV=A({success:ve,result:b(fe(LE))}),RS=De(FV,NV),BV=A({chain:b(g),address:g,name:g,icon:b(g),symbol:g,decimals:N}),MV=A({data:fe(BV),page:N,pageSize:N,total:N,pages:b(N)}),LV=A({success:ve,result:b(MV)});function OS(e,t,n){const r=e.toLowerCase(),s=t.toLowerCase();return r===n&&s===n?"self":r===n?"out":"in"}function HV(e){return e.value&&e.value!=="0"?"transfer":"contract"}function zi(e){return e==null?"0":String(e)}function Gs(e){return typeof e=="string"||typeof e=="number"?{success:!0,amount:zi(e)}:{success:e.success,amount:zi(e.result)}}function DV(e){return Promise.resolve(e.success)}function tf(e){if(!e)return!1;const t=e.status?.toUpperCase(),n=e.message?.toUpperCase();return n==="NO TRANSACTIONS FOUND"?!0:!(t==="0"||n==="NOTOK")}function PS(e){return e.success?Promise.resolve(tf(e.result)):Promise.resolve(!1)}function UV(e){return typeof e=="string"||typeof e=="number"?Promise.resolve(!0):Promise.resolve(e.success)}function xS(e){return Array.isArray(e)?Promise.resolve(!0):Promise.resolve(e.success)}function FS(e){return Array.isArray(e)?e:e.result??[]}function KV(e){return!e||!e.success?!1:tf(e.result)}function Ys(e,t){t.success}function jV(e){if(typeof e=="number")return e;if(typeof e=="string"){const t=Number.parseInt(e,10);return Number.isNaN(t)?0:t}return 0}function NS(e,t){return!e||e.length!==t.length?!0:e.length===0&&t.length===0?!1:e[0]?.hash!==t[0]?.hash}function zV(e,t){const n=new Map;for(const r of e)n.set(r.hash,r);for(const r of t){const s=n.get(r.hash);if(s){s.assets=[...s.assets,...r.assets],n.set(r.hash,s);continue}n.set(r.hash,r)}return Array.from(n.values()).sort((r,s)=>s.timestamp-r.timestamp)}function VV(e){const t=new Set;for(const n of e)for(const r of n.assets)r.assetType==="token"&&r.contractAddress&&t.add(r.contractAddress);return[...t].sort()}function BS(e){return!e.success||!e.result?[]:e.result.data.map(t=>t.address).filter(t=>t.length>0).map(t=>t.toLowerCase()).sort()}function qV(e){return e.success&&e.result?e:{success:!0,result:{data:[],page:1,pageSize:0,total:0}}}function WV(e,t){return t.success&&tf(t.result)?z(t):$t(new ct(`[ethwallet] ${e} NOTOK`))}function JV(e,t){return t.success&&tf(t.result)?z(t):$t(new ct(`[ethwallet] ${e} NOTOK`))}class GV{chainId;type;endpoint;config;constructor(t,n){this.type=t.type,this.endpoint=t.endpoint,this.config=t.config,this.chainId=n}}class HE extends fi(hi(GV)){symbol;decimals;baseUrl;pollingInterval=3e4;balanceCacheTtlMs=5e3;tokenListCacheTtl=600*1e3;_eventBus=null;_txHistorySources=new Map;_txHistoryCreations=new Map;_balanceSources=new Map;_balanceCreations=new Map;_tokenBalanceSources=new Map;_tokenBalanceCreations=new Map;_tokenListSource=null;_tokenListCreation=null;nativeBalance;tokenBalances;transactionHistory;constructor(t,n){super(t,n),this.symbol=he.getSymbol(n),this.decimals=he.getDecimals(n),this.baseUrl=this.endpoint;const r=this;this.transactionHistory=Se(`ethwallet.${n}.transactionHistory`,s=>r.createTransactionHistorySource(s)),this.nativeBalance=Se(`ethwallet.${n}.nativeBalance`,s=>r.createBalanceSource(s)),this.tokenBalances=Se(`ethwallet.${n}.tokenBalances`,s=>r.createTokenBalancesSource(s))}createTransactionHistorySource(t){return this.getSharedTxHistorySource(t.address)}createBalanceSource(t){return this.getSharedBalanceSource(t.address).pipe(Dr(n=>this.createBalanceFallbackSource(t.address)))}createTokenBalancesSource(t){return this.getSharedTokenBalanceSource(t.address).pipe(Dr(n=>this.createTokenBalancesFallbackSource(t.address)))}createBalanceFallbackSource(t){const n=this.symbol,r=this.decimals;return Te({name:`ethwallet.${this.chainId}.balance.fallback`,interval:ae(this.pollingInterval),immediate:!0,fetch:this.fetchBalance(t,!0).pipe(j(s=>{const o=Gs(s);return{amount:ee.fromRaw(o.amount,r,n),symbol:n}}))})}createTokenBalancesFallbackSource(t){const n=this.symbol,r=this.decimals;return Te({name:`ethwallet.${this.chainId}.tokenBalances.fallback`,interval:ae(this.pollingInterval),immediate:!0,fetch:this.fetchTokenBalances(t,[],!0).pipe(j(s=>{const o=[],i=Gs(s.native);o.push({symbol:n,name:n,amount:ee.fromRaw(i.amount,r,n),isNative:!0,decimals:r});for(const c of s.tokens){const a=c.symbol??"ERC20",u=c.decimals??0;o.push({symbol:a,name:c.name??a,amount:ee.fromRaw(zi(c.amount),u,a),isNative:!1,decimals:u,icon:c.icon,contractAddress:c.contractAddress})}return o}))})}getSharedTxHistorySource(t){const n=this,r=t.toLowerCase(),s=r,o=this.symbol,i=this.decimals,c=l=>({...l,stop:n.releaseSharedTxHistorySource(s)}),a=n._txHistorySources.get(s);if(a)return a.refCount+=1,z(c(a.source));const u=n._txHistoryCreations.get(s);return W(u?async()=>{const l=await u,f=n._txHistorySources.get(s);return f&&(f.refCount+=1),c(l)}:async()=>{const l=J($(function*(){n._eventBus||(n._eventBus=yield*In());const f=n._eventBus,h=yield*Te({name:`ethwallet.${n.chainId}.txHistory.native.${s}`,fetch:n.fetchNativeHistory({address:t,limit:50},!0),interval:ae(n.pollingInterval),walletEvents:{eventBus:f,chainId:n.chainId,address:t,types:["tx:confirmed","tx:sent"]}}),m=yield*h.get;if(!KV(m))return yield*h.stop,yield*$t(new ct("[ethwallet] trans/normal/history NOTOK"));const y=yield*n.getSharedTokenListSource(),S=yield*Rt(0),_=nn(S,E=>E+1).pipe(Ae),T=yield*Rt(new Map),C=[],v=E=>it(E.pipe(ps(()=>_),gr));C.push(yield*v(h.changes));const k=new Map,R=new Map,w=E=>$(function*(){if(k.has(E))return;const V=yield*Te({name:`ethwallet.${n.chainId}.txHistory.erc20.${s}.${E}`,fetch:n.fetchTokenHistory({address:t,limit:50,contractAddress:E},!0),interval:ae(n.pollingInterval),immediate:!1,walletEvents:{eventBus:f,chainId:n.chainId,address:t,types:["tx:confirmed","tx:sent"]}});k.set(E,V);const q=yield*it(V.changes.pipe(Yn(D=>nn(T,B=>{const F=new Map(B);return F.set(E,D),F}).pipe(Ce(_)))));R.set(E,q),yield*it(V.refresh.pipe(Ae))}),I=E=>$(function*(){const V=k.get(E);V&&(yield*V.stop,k.delete(E));const q=R.get(E);q&&(yield*xe(q),R.delete(E)),yield*nn(T,D=>{const B=new Map(D);return B.delete(E),B}).pipe(Ce(_))}),O=E=>$(function*(){const V=E?BS(E):[],q=new Set(V);for(const D of k.keys())q.has(D)||(yield*I(D));for(const D of q)k.has(D)||(yield*w(D))});yield*O(yield*y.get),C.push(yield*it(y.changes.pipe(Yn(E=>O(E).pipe(Ce(_))))));const H=yield*Le({name:`ethwallet.${n.chainId}.txHistory.${s}`,dependsOn:S,hasChanged:(E,V)=>E!==V,fetch:()=>$(function*(){const V=((yield*h.get)?.result?.result??[]).map(B=>{const F=B.isError==="1"||B.txreceipt_status==="0"?"failed":"confirmed";return{hash:B.hash,from:B.from,to:B.to,timestamp:parseInt(B.timeStamp,10)*1e3,status:F,blockNumber:B.blockNumber?BigInt(B.blockNumber):void 0,action:HV(B),direction:OS(B.from,B.to,r),assets:[{assetType:"native",value:B.value,symbol:o,decimals:i}]}}),D=[...(yield*Lt(T)).values()].flatMap(B=>(B?.result?.result??[]).map(F=>{const ue=F.tokenSymbol??"ERC20",je=jV(F.tokenDecimal),Wt=F.contractAddress?.toLowerCase();return{hash:F.hash,from:F.from,to:F.to,timestamp:parseInt(F.timeStamp,10)*1e3,status:"confirmed",blockNumber:F.blockNumber?BigInt(F.blockNumber):void 0,action:"transfer",direction:OS(F.from,F.to,r),assets:[{assetType:"token",value:F.value,symbol:ue,decimals:je,contractAddress:Wt,name:F.tokenName}]}}));return zV(V,D)})}),x=$(function*(){for(const E of C)yield*xe(E);for(const E of k.values())yield*E.stop;for(const E of R.values())yield*xe(E);yield*H.stop,yield*h.stop,yield*n.releaseSharedTokenListSource()});return n._txHistorySources.set(s,{source:H,refCount:1,stopAll:x}),H}));n._txHistoryCreations.set(s,l);try{const f=await l;return c(f)}finally{n._txHistoryCreations.delete(s)}})}releaseSharedTxHistorySource(t){const n=this;return $(function*(){const r=n._txHistorySources.get(t);r&&(r.refCount-=1,r.refCount<=0&&(yield*r.stopAll,n._txHistorySources.delete(t)))})}getSharedBalanceSource(t){const n=this,r=t.toLowerCase(),s=this.symbol,o=this.decimals,i=u=>({...u,stop:n.releaseSharedBalanceSource(r)}),c=n._balanceSources.get(r);if(c)return c.refCount+=1,z(i(c.source));const a=n._balanceCreations.get(r);return W(a?async()=>{const u=await a,l=n._balanceSources.get(r);return l&&(l.refCount+=1),i(u)}:async()=>{const u=J($(function*(){const l=yield*Ve(n.getSharedTxHistorySource(t),w=>$(function*(){return null}));if(l===null){const w=yield*Te({name:`ethwallet.${n.chainId}.balance.poll`,interval:ae(n.pollingInterval),immediate:!0,fetch:n.fetchBalance(t,!0).pipe(j(I=>{const O=Gs(I);return{amount:ee.fromRaw(O.amount,o,s),symbol:s}}))});return n._balanceSources.set(r,{source:w,refCount:1,stopAll:w.stop}),w}const f=yield*Rt(null),h=yield*Rt(0),m=nn(h,w=>w+1).pipe(Ae),y=w=>{const I=Gs(w);return{amount:ee.fromRaw(I.amount,o,s),symbol:s}},S=yield*Le({name:`ethwallet.${n.chainId}.balance.dep`,dependsOn:l.ref,hasChanged:NS,fetch:(w,I)=>n.fetchBalance(t,I).pipe(j(y),Ie(O=>Pt(f,O)))}),_=(yield*l.get)===null,T=yield*Te({name:`ethwallet.${n.chainId}.balance.poll`,interval:ae(n.pollingInterval),immediate:_,fetch:$(function*(){const w=yield*l.get,I=yield*Lt(f);if(w!==null&&I!==null)return I;const O=yield*n.fetchBalance(t,!0),H=y(O);return yield*Pt(f,H),H})}),C=[],v=w=>it(w.pipe(ps(()=>m),gr));C.push(yield*v(S.changes)),C.push(yield*v(T.changes));const k=yield*Le({name:`ethwallet.${n.chainId}.balance`,dependsOn:h,hasChanged:(w,I)=>w!==I,fetch:()=>$(function*(){const w=yield*Lt(f);return w||(yield*$t(new ct("[ethwallet] balance cache empty")))})}),R=$(function*(){for(const w of C)yield*xe(w);yield*S.stop,yield*T.stop,yield*k.stop,yield*l.stop});return n._balanceSources.set(r,{source:k,refCount:1,stopAll:R}),k}));n._balanceCreations.set(r,u);try{const l=await u;return i(l)}finally{n._balanceCreations.delete(r)}})}releaseSharedBalanceSource(t){const n=this;return $(function*(){const r=n._balanceSources.get(t);r&&(r.refCount-=1,r.refCount<=0&&(yield*r.stopAll,n._balanceSources.delete(t)))})}getSharedTokenBalanceSource(t){const n=this,r=t.toLowerCase(),s=this.symbol,o=this.decimals,i=u=>({...u,stop:n.releaseSharedTokenBalanceSource(r)}),c=n._tokenBalanceSources.get(r);if(c)return c.refCount+=1,z(i(c.source));const a=n._tokenBalanceCreations.get(r);return W(a?async()=>{const u=await a,l=n._tokenBalanceSources.get(r);return l&&(l.refCount+=1),i(u)}:async()=>{const u=J($(function*(){const l=yield*Ve(n.getSharedTxHistorySource(t),w=>$(function*(){return null}));if(l===null){const w=yield*Te({name:`ethwallet.${n.chainId}.tokenBalances.poll`,interval:ae(n.pollingInterval),immediate:!0,fetch:n.fetchTokenBalances(t,[],!0).pipe(j(I=>{const O=[],H=Gs(I.native);O.push({symbol:s,name:s,amount:ee.fromRaw(H.amount,o,s),isNative:!0,decimals:o});for(const x of I.tokens){const E=x.symbol??"ERC20",V=x.decimals??0;O.push({symbol:E,name:x.name??E,amount:ee.fromRaw(zi(x.amount),V,E),isNative:!1,decimals:V,icon:x.icon,contractAddress:x.contractAddress})}return O}))});return n._tokenBalanceSources.set(r,{source:w,refCount:1,stopAll:w.stop}),w}const f=yield*Rt(null),h=yield*Rt(0),m=nn(h,w=>w+1).pipe(Ae),y=w=>{const I=[],O=Gs(w.native);I.push({symbol:s,name:s,amount:ee.fromRaw(O.amount,o,s),isNative:!0,decimals:o});for(const H of w.tokens){const x=H.symbol??"ERC20",E=H.decimals??0;I.push({symbol:x,name:H.name??x,amount:ee.fromRaw(zi(H.amount),E,x),isNative:!1,decimals:E,icon:H.icon,contractAddress:H.contractAddress})}return I},S=yield*Le({name:`ethwallet.${n.chainId}.tokenBalances.dep`,dependsOn:l.ref,hasChanged:NS,fetch:(w,I)=>n.fetchTokenBalances(t,VV(w),I).pipe(j(y),Ie(O=>Pt(f,O)))}),_=(yield*l.get)===null,T=yield*Te({name:`ethwallet.${n.chainId}.tokenBalances.poll`,interval:ae(n.pollingInterval),immediate:_,fetch:$(function*(){const w=yield*l.get,I=yield*Lt(f);if(w!==null&&I!==null)return I;const O=yield*n.fetchTokenBalances(t,[],!0),H=y(O);return yield*Pt(f,H),H})}),C=[],v=w=>it(w.pipe(ps(()=>m),gr));C.push(yield*v(S.changes)),C.push(yield*v(T.changes));const k=yield*Le({name:`ethwallet.${n.chainId}.tokenBalances`,dependsOn:h,hasChanged:(w,I)=>w!==I,fetch:()=>$(function*(){const w=yield*Lt(f);return w||(yield*$t(new ct("[ethwallet] tokenBalances cache empty")))})}),R=$(function*(){for(const w of C)yield*xe(w);yield*S.stop,yield*T.stop,yield*k.stop,yield*l.stop});return n._tokenBalanceSources.set(r,{source:k,refCount:1,stopAll:R}),k}));n._tokenBalanceCreations.set(r,u);try{const l=await u;return i(l)}finally{n._tokenBalanceCreations.delete(r)}})}releaseSharedTokenBalanceSource(t){const n=this;return $(function*(){const r=n._tokenBalanceSources.get(t);r&&(r.refCount-=1,r.refCount<=0&&(yield*r.stopAll,n._tokenBalanceSources.delete(t)))})}getSharedTokenListSource(){const t=this;return t._tokenListSource?(t._tokenListSource.refCount+=1,z(t._tokenListSource.source)):t._tokenListCreation?W(async()=>{const n=await t._tokenListCreation;return t._tokenListSource&&(t._tokenListSource.refCount+=1),n}):W(async()=>{const n=J($(function*(){const r=yield*Te({name:`ethwallet.${t.chainId}.tokenList`,fetch:t.fetchTokenList(!1),interval:ae(t.tokenListCacheTtl),immediate:!0});return t._tokenListSource={source:r,refCount:1,stopAll:r.stop},r}));t._tokenListCreation=n;try{return await n}finally{t._tokenListCreation=null}})}releaseSharedTokenListSource(){const t=this;return $(function*(){const n=t._tokenListSource;n&&(n.refCount-=1,n.refCount<=0&&(yield*n.stopAll,t._tokenListSource=null))})}fetchBalance(t,n=!1){return te({url:`${this.baseUrl}/balance?address=${t}`,schema:IV,cacheStrategy:n?"ttl":"cache-first",cacheTtl:this.balanceCacheTtlMs,canCache:UV}).pipe(Ie(r=>{typeof r=="object"&&r!==null&&"success"in r&&Ys("balance",r)}))}fetchNativeHistory(t,n=!1){return te({url:`${this.baseUrl}/trans/normal/history`,method:"POST",body:{address:t.address,page:1,offset:t.limit??50},schema:PV,cacheStrategy:n?"ttl":"cache-first",cacheTtl:this.balanceCacheTtlMs,canCache:PS}).pipe(Ie(r=>Ys("trans/normal/history",r)),X(r=>WV("trans/normal/history",r)))}fetchTokenHistory(t,n=!1){return t.contractAddress?te({url:`${this.baseUrl}/trans/erc20/history`,method:"POST",body:{address:t.address,contractaddress:t.contractAddress,page:1,offset:t.limit??50},schema:xV,cacheStrategy:n?"ttl":"cache-first",cacheTtl:this.balanceCacheTtlMs,canCache:PS}).pipe(Ie(r=>Ys("trans/erc20/history",r)),X(r=>JV("trans/erc20/history",r))):z({success:!0,result:{result:[]}})}fetchTokenBalances(t,n,r=!1){const s=[...n].sort();if(s.length===0){const o=this;return $(function*(){const i=yield*o.fetchTokenList(!1),c=BS(i),a=yield*o.fetchBalance(t,r);if(c.length===0)return{native:a,tokens:[]};const u=yield*te({url:`${o.baseUrl}/account/balance/v2`,method:"POST",body:{address:t,contracts:c},schema:RS,cacheStrategy:r?"ttl":"cache-first",cacheTtl:o.balanceCacheTtlMs,canCache:xS}).pipe(Ie(l=>{Array.isArray(l)||Ys("account/balance/v2",l)}),j(FS),Ve(()=>z([])));return{native:a,tokens:u}})}return ze({native:this.fetchBalance(t,r),tokens:te({url:`${this.baseUrl}/account/balance/v2`,method:"POST",body:{address:t,contracts:s},schema:RS,cacheStrategy:r?"ttl":"cache-first",cacheTtl:this.balanceCacheTtlMs,canCache:xS}).pipe(Ie(o=>{Array.isArray(o)||Ys("account/balance/v2",o)}),j(FS),Ve(()=>z([])))})}fetchTokenList(t=!1){return te({url:`${this.baseUrl}/contract/tokens`,method:"POST",body:{page:1,pageSize:50,chain:"ETH"},schema:LV,cacheStrategy:t?"network-first":"ttl",cacheTtl:this.tokenListCacheTtl,canCache:DV}).pipe(Ie(n=>Ys("contract/tokens",n)),j(qV))}}function DE(e,t){return e.type==="ethwallet-v1"?new HE(e,t):null}const YV=A({success:ve,result:b(De(g,N))}),QV=De(YV,g,N),XV=A({txID:g,from:g,to:g,amount:De(g,N),timestamp:N,contractRet:b(g),blockNumber:b(De(g,N)),fee:b(De(g,N))}),ZV=A({txID:g,from:g,to:g,value:De(g,N),timestamp:N,tokenSymbol:b(g),token_symbol:b(g),tokenName:b(g),token_name:b(g),tokenDecimal:b(N),token_decimals:b(N),contractAddress:b(g),token_address:b(g),contractRet:b(g)}),eq=A({success:ve,data:b(fe(XV)),fingerprint:b(g),pageSize:b(N)}),tq=A({success:ve,data:b(fe(ZV)),fingerprint:b(g),pageSize:b(N)}),UE=A({amount:De(g,N),contractAddress:b(g),decimals:b(N),icon:b(g),symbol:b(g),name:b(g)}),nq=fe(UE),rq=A({success:ve,result:b(fe(UE))}),MS=De(nq,rq),sq=A({chain:b(g),address:g,name:g,icon:b(g),symbol:g,decimals:N}),oq=A({data:fe(sq),page:N,pageSize:N,total:N,pages:b(N)}),iq=A({success:ve,result:oq}),cq=A({from:g,to:g,state:b(De(g,N)),createdTime:De(g,N),txHash:g,value:De(g,N),assetSymbol:b(g),fee:b(De(g,N)),extra:b(Kl)}),aq=fe(cq),uq=Kl;function nt(e){return typeof e=="object"&&e!==null}function lq(e,t){const n=Dn(e),r=wo.sign(n,t,{prehash:!1,format:"recovered"}),s=r[0],o=r.subarray(1),i=(s+27).toString(16).padStart(2,"0");return`${ur(o)}${i}`}function ns(e){return e==null?"0":String(e)}function Vf(e){try{return ir(e)}catch{return e.toLowerCase()}}function qf(e,t,n){const r=Vf(e),s=Vf(t),o=Vf(n);return r===o&&s===o?"self":r===o?"out":"in"}function fq(e){if(typeof e=="string"){const t=e.toLowerCase();return t.includes("success")||t.includes("confirm")?"confirmed":t.includes("fail")?"failed":"pending"}return typeof e=="number"&&e>=2?"confirmed":"pending"}function hq(e,t){const n=new Map;for(const r of e)n.set(r.hash,r);for(const r of t){const s=n.get(r.hash);if(s){s.assets=[...s.assets,...r.assets],n.set(r.hash,s);continue}n.set(r.hash,r)}return Array.from(n.values()).sort((r,s)=>s.timestamp-r.timestamp)}function KE(e){if(typeof e!="string")return null;const t=e.trim();if(!t)return null;const n=t.startsWith("0x")?t.slice(2):t;if(!/^[0-9a-fA-F]+$/.test(n)||n.length%2!==0)return t;try{return new TextDecoder().decode(Dn(n)).trim()||t}catch{return t}}function dq(e){if(!nt(e))return"Unknown error";const t=[e.message,e.code,e.error];nt(e.result)&&t.push(e.result.message,e.result.code,e.result.error);for(const n of t){const r=KE(n);if(r)return r}return"Unknown error"}function LS(e){if(!nt(e))return"Unknown error";const t=nt(e.error)?e.error:null,n=nt(e.result)?e.result:null,r=n&&nt(n.error)?n.error:null,s=nt(e.data)?e.data:null,o=s&&nt(s.error)?s.error:null,i=[t?.message,t?.info,t?.code,e.message,e.code,n?.message,n?.code,r?.message,r?.info,r?.code,s?.message,s?.code,o?.message,o?.info,o?.code];for(const c of i){const a=KE(c);if(a)return a}return"Unknown error"}function pq(e){return nt(e)?typeof e.result=="boolean"?e.result:typeof e.success=="boolean"?e.success:!1:!1}function mq(e){return nt(e)&&nt(e.signedTx)?e:{signedTx:e,detail:{from:"",to:"",amount:"0",fee:"0",assetSymbol:""},isToken:!1}}function HS(e){if(!nt(e))return null;if(typeof e.txID=="string")return e;if(nt(e.transaction)&&typeof e.transaction.txID=="string")return e.transaction;if(nt(e.result)){if(typeof e.result.txID=="string")return e.result;if(nt(e.result.transaction)&&typeof e.result.transaction.txID=="string")return e.result.transaction}if(nt(e.data)){if(typeof e.data.txID=="string")return e.data;if(nt(e.data.transaction)&&typeof e.data.transaction.txID=="string")return e.data.transaction}return null}function gq(e){return nt(e)?Object.keys(e).length>0:!1}function Wf(e){return Promise.resolve(e.success)}function yq(e){return typeof e=="string"||typeof e=="number"?Promise.resolve(!0):Promise.resolve(e.success)}function DS(e){return typeof e=="string"||typeof e=="number"?{success:!0,amount:ns(e)}:{success:e.success,amount:ns(e.result)}}function US(e){return Array.isArray(e)?Promise.resolve(!0):Promise.resolve(e.success)}function KS(e){return Array.isArray(e)?e:e.result??[]}function Qs(e,t){t.success}function Sq(e){const t=new Set;for(const n of e)for(const r of n.assets)r.assetType==="token"&&r.contractAddress&&t.add(r.contractAddress);return[...t].sort()}function jS(e,t){return!e||e.length!==t.length?!0:e.length===0&&t.length===0?!1:e[0]?.hash!==t[0]?.hash}function zS(e){return e.success?e.result.data.map(t=>t.address).filter(t=>t.length>0).map(t=>mt(t)).sort():[]}class bq{chainId;type;endpoint;config;constructor(t,n){this.type=t.type,this.endpoint=t.endpoint,this.config=t.config,this.chainId=n}}function VS(e,t){const n=Math.max(e.length,0);return(BigInt(Math.floor(n/2)+68)*1000n+(t?10000000n:0n)).toString()}class jE extends $E(AE(bq)){symbol;decimals;baseUrl;pollingInterval=3e4;tokenListCacheTtl=600*1e3;_eventBus=null;_txHistorySources=new Map;_txHistoryCreations=new Map;_balanceSources=new Map;_balanceCreations=new Map;_tokenBalanceSources=new Map;_tokenBalanceCreations=new Map;_tokenListSource=null;_tokenListCreation=null;get pendingTxCacheTtl(){return Math.max(1e3,Math.floor(this.pollingInterval/4))}nativeBalance;tokenBalances;transactionHistory;transaction;constructor(t,n){super(t,n),this.symbol=he.getSymbol(n),this.decimals=he.getDecimals(n),this.baseUrl=this.endpoint;const r=this;this.transactionHistory=Se(`tronwallet.${n}.transactionHistory`,s=>r.createTransactionHistorySource(s)),this.nativeBalance=Se(`tronwallet.${n}.nativeBalance`,s=>r.createBalanceSource(s)),this.tokenBalances=Se(`tronwallet.${n}.tokenBalances`,s=>r.createTokenBalancesSource(s)),this.transaction=Se(`tronwallet.${n}.transaction`,s=>r.createTransactionSource(s))}createTransactionHistorySource(t){return this.getSharedTxHistorySource(t.address)}createBalanceSource(t){return this.getSharedBalanceSource(t.address)}createTokenBalancesSource(t){return this.getSharedTokenBalanceSource(t.address)}createTransactionSource(t){const n=this,r=this.symbol,s=this.decimals;return $(function*(){const o=$(function*(){const[c,a]=yield*ze([n.fetchTransactionReceipt(t.txHash),t.senderId?n.fetchPendingTransactions(t.senderId):z([])]),u=a.find(f=>f.txHash===t.txHash),l=gq(c);if(u){const f=mt(u.from),h=mt(u.to);return{hash:u.txHash,from:f,to:h,timestamp:Number(u.createdTime)||Date.now(),status:l?"confirmed":fq(u.state),action:"transfer",direction:qf(u.from,u.to,t.senderId??f),assets:[{assetType:"native",value:ns(u.value),symbol:r,decimals:s}]}}if(l){const f=t.senderId?mt(t.senderId):"";return{hash:t.txHash,from:f,to:"",timestamp:Date.now(),status:"confirmed",action:"transfer",direction:f?"out":"in",assets:[{assetType:"native",value:"0",symbol:r,decimals:s}]}}return null});return yield*Te({name:`tronwallet.${n.chainId}.transaction`,fetch:o,interval:ae(3e3)})})}async buildTransaction(t){if(t.type!=="transfer")throw new Z(ce.NOT_SUPPORTED,`Transaction type not supported: ${t.type}`);const n=t,r=rr(n.from),s=rr(n.to),o=!!n.fee,i=n.fee?.toRawString()??"0",c=n.tokenAddress?.trim(),a=!!c;let u=this.symbol;if(c)try{u=await this.resolveTokenSymbol(c)}catch(y){console.warn("[tronwallet] resolveTokenSymbol failed",y),u=c}if(a&&c){const y=rr(c),S=o&&Number.isFinite(Number(i))?Number(i):1e8,_=await J(vn({url:`${this.baseUrl}/trans/contract`,method:"POST",body:{owner_address:r,contract_address:y,function_selector:"transfer(address,uint256)",input:[{type:"address",value:s},{type:"uint256",value:n.amount.toRawString()}],fee_limit:S,call_value:0}})),T=this.extractTrc20Transaction(_),C=o?i:VS(T.raw_data_hex??"",!0),v={from:r,to:s,amount:n.amount.toRawString(),fee:C,assetSymbol:u};return{chainId:this.chainId,intentType:"transfer",data:{rawTx:T,detail:v,isToken:!0}}}const l=await J(vn({url:`${this.baseUrl}/trans/create`,method:"POST",body:{owner_address:r,to_address:s,amount:Number(n.amount.raw),extra_data:n.memo}})),f=this.extractNativeTransaction(l),h=o?i:VS(f.raw_data_hex??"",!1),m={from:r,to:s,amount:n.amount.toRawString(),fee:h,assetSymbol:u};return{chainId:this.chainId,intentType:"transfer",data:{rawTx:f,detail:m,isToken:!1}}}async signTransaction(t,n){if(!n.privateKey)throw new Z(ce.SIGNATURE_FAILED,"privateKey is required for Tron signing");const r=t.data,s=lq(r.rawTx.txID,n.privateKey),o={...r.rawTx,signature:[s]};return{chainId:t.chainId,data:{signedTx:o,detail:r.detail,isToken:r.isToken},signature:s}}async broadcastTransaction(t){const n=mq(t.data),r=n.isToken?`${this.baseUrl}/trans/trc20/broadcast`:`${this.baseUrl}/trans/broadcast`,s=n.detail.assetSymbol?{...n.signedTx,detail:n.detail}:n.signedTx,o=await J(vn({url:r,method:"POST",body:s}));if(!pq(o)){const i=dq(o);throw new Z(ce.TX_BROADCAST_FAILED,`Broadcast failed: ${i}`,nt(o)?{provider:this.type,response:o,reason:i}:{provider:this.type,reason:i})}return nt(o)&&typeof o.txid=="string"&&o.txid.length>0?o.txid:n.signedTx.txID}getSharedTxHistorySource(t){const n=this,r=mt(t),s=ir(t),o=this.symbol,i=this.decimals,c=l=>({...l,stop:n.releaseSharedTxHistorySource(s)}),a=n._txHistorySources.get(s);if(a)return a.refCount+=1,z(c(a.source));const u=n._txHistoryCreations.get(s);return W(u?async()=>{const l=await u,f=n._txHistorySources.get(s);return f&&(f.refCount+=1),c(l)}:async()=>{const l=J($(function*(){n._eventBus||(n._eventBus=yield*In());const f=n._eventBus,h=yield*Te({name:`tronwallet.${n.chainId}.txHistory.native.${s}`,fetch:n.fetchNativeHistory({address:r,limit:50},!0),interval:ae(n.pollingInterval),walletEvents:{eventBus:f,chainId:n.chainId,address:r,types:["tx:confirmed","tx:sent"]}}),m=yield*n.getSharedTokenListSource(),y=yield*Rt(0),S=nn(y,x=>x+1).pipe(Ae),_=yield*Rt(new Map),T=[],C=x=>it(x.pipe(ps(()=>S),gr));T.push(yield*C(h.changes));const v=new Map,k=new Map,R=x=>$(function*(){if(v.has(x))return;const E=yield*Te({name:`tronwallet.${n.chainId}.txHistory.trc20.${s}.${x}`,fetch:n.fetchTrc20History({address:r,limit:50,contractAddress:x},!0),interval:ae(n.pollingInterval),immediate:!1,walletEvents:{eventBus:f,chainId:n.chainId,address:r,types:["tx:confirmed","tx:sent"]}});v.set(x,E);const V=yield*it(E.changes.pipe(Yn(q=>nn(_,D=>{const B=new Map(D);return B.set(x,q),B}).pipe(Ce(S)))));k.set(x,V),yield*it(E.refresh.pipe(Ae))}),w=x=>$(function*(){const E=v.get(x);E&&(yield*E.stop,v.delete(x));const V=k.get(x);V&&(yield*xe(V),k.delete(x)),yield*nn(_,q=>{const D=new Map(q);return D.delete(x),D}).pipe(Ce(S))}),I=x=>$(function*(){const E=x?zS(x):[],V=new Set(E);for(const q of v.keys())V.has(q)||(yield*w(q));for(const q of V)v.has(q)||(yield*R(q))});yield*I(yield*m.get),T.push(yield*it(m.changes.pipe(Yn(x=>I(x).pipe(Ce(S))))));const O=yield*Le({name:`tronwallet.${n.chainId}.txHistory.${s}`,dependsOn:y,hasChanged:(x,E)=>x!==E,fetch:()=>$(function*(){const E=((yield*h.get)?.data??[]).map(D=>{const B=mt(D.from),F=mt(D.to),ue=D.contractRet==="SUCCESS"?"confirmed":"failed";return{hash:D.txID,from:B,to:F,timestamp:D.timestamp,status:ue,blockNumber:D.blockNumber?BigInt(String(D.blockNumber)):void 0,action:"transfer",direction:qf(D.from,D.to,r),assets:[{assetType:"native",value:ns(D.amount),symbol:o,decimals:i}],fee:D.fee!==void 0?{value:ns(D.fee),symbol:o,decimals:i}:void 0}}),q=[...(yield*Lt(_)).values()].flatMap(D=>(D?.data??[]).map(B=>{const F=mt(B.from),ue=mt(B.to),je=B.contractRet?B.contractRet==="SUCCESS"?"confirmed":"failed":"confirmed",Wt=B.tokenSymbol??B.token_symbol??"TRC20",Hs=B.tokenDecimal??B.token_decimals??0,kr=B.contractAddress??B.token_address,YE=kr?mt(kr):"";return{hash:B.txID,from:F,to:ue,timestamp:B.timestamp,status:je,action:"transfer",direction:qf(B.from,B.to,r),assets:[{assetType:"token",value:ns(B.value),symbol:Wt,decimals:Hs,contractAddress:YE,name:B.tokenName??B.token_name}]}}));return hq(E,q)})}),H=$(function*(){for(const x of T)yield*xe(x);for(const x of v.values())yield*x.stop;for(const x of k.values())yield*xe(x);yield*O.stop,yield*h.stop,yield*n.releaseSharedTokenListSource()});return n._txHistorySources.set(s,{source:O,refCount:1,stopAll:H}),O}));n._txHistoryCreations.set(s,l);try{const f=await l;return c(f)}finally{n._txHistoryCreations.delete(s)}})}releaseSharedTxHistorySource(t){const n=this;return $(function*(){const r=n._txHistorySources.get(t);r&&(r.refCount-=1,r.refCount<=0&&(yield*r.stopAll,n._txHistorySources.delete(t)))})}getSharedBalanceSource(t){const n=this,r=ir(t),s=this.symbol,o=this.decimals,i=u=>({...u,stop:n.releaseSharedBalanceSource(r)}),c=n._balanceSources.get(r);if(c)return c.refCount+=1,z(i(c.source));const a=n._balanceCreations.get(r);return W(a?async()=>{const u=await a,l=n._balanceSources.get(r);return l&&(l.refCount+=1),i(u)}:async()=>{const u=J($(function*(){const l=yield*n.getSharedTxHistorySource(t),f=yield*Le({name:`tronwallet.${n.chainId}.balance`,dependsOn:l.ref,hasChanged:jS,fetch:(m,y)=>n.fetchBalance(t,y).pipe(j(S=>{const _=DS(S);return{amount:ee.fromRaw(_.amount,o,s),symbol:s}}))}),h=ze([f.stop,l.stop]).pipe(Ae);return n._balanceSources.set(r,{source:f,refCount:1,stopAll:h}),f}));n._balanceCreations.set(r,u);try{const l=await u;return i(l)}finally{n._balanceCreations.delete(r)}})}releaseSharedBalanceSource(t){const n=this;return $(function*(){const r=n._balanceSources.get(t);r&&(r.refCount-=1,r.refCount<=0&&(yield*r.stopAll,n._balanceSources.delete(t)))})}getSharedTokenBalanceSource(t){const n=this,r=ir(t),s=this.symbol,o=this.decimals,i=u=>({...u,stop:n.releaseSharedTokenBalanceSource(r)}),c=n._tokenBalanceSources.get(r);if(c)return c.refCount+=1,z(i(c.source));const a=n._tokenBalanceCreations.get(r);return W(a?async()=>{const u=await a,l=n._tokenBalanceSources.get(r);return l&&(l.refCount+=1),i(u)}:async()=>{const u=J($(function*(){const l=yield*n.getSharedTxHistorySource(t),f=yield*Le({name:`tronwallet.${n.chainId}.tokenBalances`,dependsOn:l.ref,hasChanged:jS,fetch:(m,y)=>n.fetchTokenBalances(t,Sq(m),y).pipe(j(S=>{const _=[],T=DS(S.native);_.push({symbol:s,name:s,amount:ee.fromRaw(T.amount,o,s),isNative:!0,decimals:o});for(const C of S.tokens){const v=C.symbol??"TRC20",k=C.decimals??0,R=C.contractAddress?mt(C.contractAddress):void 0;_.push({symbol:v,name:C.name??v,amount:ee.fromRaw(ns(C.amount),k,v),isNative:!1,decimals:k,icon:C.icon,contractAddress:R})}return _}))}),h=ze([f.stop,l.stop]).pipe(Ae);return n._tokenBalanceSources.set(r,{source:f,refCount:1,stopAll:h}),f}));n._tokenBalanceCreations.set(r,u);try{const l=await u;return i(l)}finally{n._tokenBalanceCreations.delete(r)}})}releaseSharedTokenBalanceSource(t){const n=this;return $(function*(){const r=n._tokenBalanceSources.get(t);r&&(r.refCount-=1,r.refCount<=0&&(yield*r.stopAll,n._tokenBalanceSources.delete(t)))})}getSharedTokenListSource(){const t=this;return t._tokenListSource?(t._tokenListSource.refCount+=1,z(t._tokenListSource.source)):t._tokenListCreation?W(async()=>{const n=await t._tokenListCreation;return t._tokenListSource&&(t._tokenListSource.refCount+=1),n}):W(async()=>{const n=J($(function*(){const r=yield*Te({name:`tronwallet.${t.chainId}.tokenList`,fetch:t.fetchTokenList(!1),interval:ae(t.tokenListCacheTtl),immediate:!0});return t._tokenListSource={source:r,refCount:1,stopAll:r.stop},r}));t._tokenListCreation=n;try{return await n}finally{t._tokenListCreation=null}})}releaseSharedTokenListSource(){const t=this;return $(function*(){const n=t._tokenListSource;n&&(n.refCount-=1,n.refCount<=0&&(yield*n.stopAll,t._tokenListSource=null))})}fetchBalance(t,n=!1){return te({url:`${this.baseUrl}/balance`,method:"GET",searchParams:{address:rr(t)},schema:QV,cacheStrategy:n?"network-first":"cache-first",canCache:yq}).pipe(Ie(r=>{typeof r=="object"&&r!==null&&"success"in r&&Qs("balance",r)}))}fetchNativeHistory(t,n=!1){return te({url:`${this.baseUrl}/trans/common/history`,method:"POST",body:{address:rr(t.address),limit:t.limit??50},schema:eq,cacheStrategy:n?"network-first":"cache-first",canCache:Wf}).pipe(Ie(r=>Qs("trans/common/history",r)))}fetchTrc20History(t,n=!1){return t.contractAddress?te({url:`${this.baseUrl}/trans/trc20/history`,method:"POST",body:{address:rr(t.address),limit:t.limit??50,contract_address:mt(t.contractAddress)},schema:tq,cacheStrategy:n?"network-first":"cache-first",canCache:Wf}).pipe(Ie(r=>Qs("trans/trc20/history",r))):z({success:!0,data:[],fingerprint:"",pageSize:0})}fetchTransactions(t,n=!1){return ze({native:this.fetchNativeHistory(t,n),trc20:this.fetchTrc20History(t,n).pipe(Ve(()=>z({success:!1,data:[]})))})}fetchTokenBalances(t,n,r=!1){const s=mt(t),o=[...n].sort();if(o.length===0){const i=this;return $(function*(){const c=yield*i.fetchTokenList(!1),a=zS(c),u=yield*i.fetchBalance(t,r);if(a.length===0)return{native:u,tokens:[]};const l=yield*te({url:`${i.baseUrl}/account/balance/v2`,method:"POST",body:{address:s,contracts:a},schema:MS,cacheStrategy:r?"network-first":"cache-first",canCache:US}).pipe(Ie(f=>{Array.isArray(f)||Qs("account/balance/v2",f)}),j(KS),Ve(()=>z([])));return{native:u,tokens:l}})}return ze({native:this.fetchBalance(t,r),tokens:te({url:`${this.baseUrl}/account/balance/v2`,method:"POST",body:{address:s,contracts:o},schema:MS,cacheStrategy:r?"network-first":"cache-first",canCache:US}).pipe(Ie(i=>{Array.isArray(i)||Qs("account/balance/v2",i)}),j(KS),Ve(()=>z([])))})}fetchTokenList(t=!1){return te({url:`${this.baseUrl}/contract/tokens`,method:"POST",body:{page:1,pageSize:50,chain:"TRON"},schema:iq,cacheStrategy:t?"network-first":"ttl",cacheTtl:this.tokenListCacheTtl,canCache:Wf}).pipe(Ie(n=>Qs("contract/tokens",n)))}async resolveTokenSymbol(t){const n=t.trim();if(!n)return t;const r=ir(n);return(await J(this.fetchTokenList(!1))).result.data.find(i=>i.address&&ir(i.address)===r)?.symbol??t}extractTrc20Transaction(t){const n=HS(t);if(n)return n;const r=LS(t);throw new Z(ce.TX_BUILD_FAILED,`TRC20 transaction build failed: ${r}`,nt(t)?{provider:this.type,response:t,reason:r}:{provider:this.type,reason:r})}extractNativeTransaction(t){const n=HS(t);if(n)return n;const r=LS(t);throw new Z(ce.TX_BUILD_FAILED,`Failed to create Tron transaction: ${r}`,nt(t)?{provider:this.type,response:t,reason:r}:{provider:this.type,reason:r})}fetchPendingTransactions(t){return te({url:`${this.baseUrl}/trans/pending`,method:"POST",body:{address:rr(t),assetSymbol:this.symbol},schema:aq,cacheStrategy:"ttl",cacheTtl:this.pendingTxCacheTtl})}fetchTransactionReceipt(t){return te({url:`${this.baseUrl}/trans/receipt`,method:"POST",body:{txId:t},schema:uq,cacheStrategy:"ttl",cacheTtl:this.pendingTxCacheTtl})}}function zE(e,t){return e.type==="tronwallet-v1"?new jE(e,t):null}const _q=A({txid:g,vin:b(fe(A({addresses:b(fe(g))}))),vout:b(fe(A({addresses:b(fe(g)),value:b(g)}))),blockTime:b(N),confirmations:b(N)}),wq=A({balance:g,txs:b(N),transactions:b(fe(_q))}),vq=A({success:ve,result:b(wq)}),Tq=A({txid:g,vin:b(fe(A({addresses:b(fe(g))}))),vout:b(fe(A({addresses:b(fe(g)),value:b(g)}))),blockTime:b(N),confirmations:b(N),blockHeight:b(N)}),kq=A({success:ve,result:b(Tq)}),Eq=A({txid:g,vout:N,value:De(g,N),scriptPubKey:b(g)}),Cq=A({success:ve,result:b(fe(Eq))}),Iq=A({success:ve,result:b(De(g,N))}),$q=A({success:ve,result:b(g)});function qS(e,t,n){const r=e?.some(o=>o.addresses?.includes(n)),s=t?.some(o=>o.addresses?.includes(n));return r&&s?"self":r?"out":"in"}function Aq(e,t){return!e||e.length!==t.length?!0:e.length===0&&t.length===0?!1:e[0]?.hash!==t[0]?.hash}function Rq(e){return e.result??{balance:"0",transactions:[]}}function ha(e){return Promise.resolve(e.success)}function Jf(e,t){return t.success&&t.result!==void 0?z(t.result):$t(new ct(`[btcwallet] ${e} failed`))}function Oq(e,t){return t.success?z(t.result??null):$t(new ct(`[btcwallet] ${e} failed`))}function ki(e,t){t.success}class Pq{chainId;type;endpoint;config;constructor(t,n){this.type=t.type,this.endpoint=t.endpoint,this.config=t.config,this.chainId=n}}class VE extends FE(NE(Pq)){symbol;decimals;baseUrl;pollingInterval=6e4;_eventBus=null;_txHistorySources=new Map;_txHistoryCreations=new Map;_balanceSources=new Map;_balanceCreations=new Map;_transactionSources=new Map;_transactionCreations=new Map;nativeBalance;transactionHistory;transaction;constructor(t,n){super(t,n),this.symbol=he.getSymbol(n),this.decimals=he.getDecimals(n),this.baseUrl=this.endpoint;const r=this;this.transactionHistory=Se(`btcwallet.${n}.transactionHistory`,s=>r.createTransactionHistorySource(s)),this.nativeBalance=Se(`btcwallet.${n}.nativeBalance`,s=>r.createBalanceSource(s)),this.transaction=Se(`btcwallet.${n}.transaction`,s=>r.createTransactionSource(s))}createTransactionHistorySource(t){return this.getSharedTxHistorySource(t.address)}createBalanceSource(t){return this.getSharedBalanceSource(t.address)}createTransactionSource(t){return this.getSharedTransactionSource(t.txHash,t.senderId)}getSharedTxHistorySource(t){const n=this,r=t,s=this.symbol,o=this.decimals,i=u=>({...u,stop:n.releaseSharedTxHistorySource(r)}),c=n._txHistorySources.get(r);if(c)return c.refCount+=1,z(i(c.source));const a=n._txHistoryCreations.get(r);return W(a?async()=>{const u=await a,l=n._txHistorySources.get(r);return l&&(l.refCount+=1),i(u)}:async()=>{const u=J($(function*(){n._eventBus||(n._eventBus=yield*In());const l=n._eventBus,f=n.fetchAddressInfo(t,!0).pipe(j(y=>(y.transactions??[]).map(S=>({hash:S.txid,from:S.vin?.[0]?.addresses?.[0]??"",to:S.vout?.[0]?.addresses?.[0]??"",timestamp:(S.blockTime??0)*1e3,status:(S.confirmations??0)>0?"confirmed":"pending",action:"transfer",direction:qS(S.vin,S.vout,t),assets:[{assetType:"native",value:S.vout?.[0]?.value??"0",symbol:s,decimals:o}]})))),h=yield*Te({name:`btcwallet.${n.chainId}.txHistory.${r}`,fetch:f,interval:ae(n.pollingInterval),walletEvents:{eventBus:l,chainId:n.chainId,address:t,types:["tx:confirmed","tx:sent"]}}),m=h.stop;return n._txHistorySources.set(r,{source:h,refCount:1,stopAll:m}),h}));n._txHistoryCreations.set(r,u);try{const l=await u;return i(l)}finally{n._txHistoryCreations.delete(r)}})}releaseSharedTxHistorySource(t){const n=this;return $(function*(){const r=n._txHistorySources.get(t);r&&(r.refCount-=1,r.refCount<=0&&(yield*r.stopAll,n._txHistorySources.delete(t)))})}getSharedBalanceSource(t){const n=this,r=t,s=this.symbol,o=this.decimals,i=u=>({...u,stop:n.releaseSharedBalanceSource(r)}),c=n._balanceSources.get(r);if(c)return c.refCount+=1,z(i(c.source));const a=n._balanceCreations.get(r);return W(a?async()=>{const u=await a,l=n._balanceSources.get(r);return l&&(l.refCount+=1),i(u)}:async()=>{const u=J($(function*(){const l=yield*n.getSharedTxHistorySource(t),f=yield*Le({name:`btcwallet.${n.chainId}.balance`,dependsOn:l.ref,hasChanged:Aq,fetch:(m,y)=>n.fetchAddressInfo(t,y).pipe(j(S=>({amount:ee.fromRaw(S.balance,o,s),symbol:s})))}),h=ze([f.stop,l.stop]).pipe(Ae);return n._balanceSources.set(r,{source:f,refCount:1,stopAll:h}),f}));n._balanceCreations.set(r,u);try{const l=await u;return i(l)}finally{n._balanceCreations.delete(r)}})}releaseSharedBalanceSource(t){const n=this;return $(function*(){const r=n._balanceSources.get(t);r&&(r.refCount-=1,r.refCount<=0&&(yield*r.stopAll,n._balanceSources.delete(t)))})}getSharedTransactionSource(t,n){const r=this,s=n?`${t}:${n}`:t,o=this.symbol,i=this.decimals,c=l=>({...l,stop:r.releaseSharedTransactionSource(s)}),a=r._transactionSources.get(s);if(a)return a.refCount+=1,z(c(a.source));const u=r._transactionCreations.get(s);return W(u?async()=>{const l=await u,f=r._transactionSources.get(s);return f&&(f.refCount+=1),c(l)}:async()=>{const l=J($(function*(){const f=r.fetchTransactionDetail(t,!0).pipe(j(y=>{if(!y)return null;const S=n?qS(y.vin,y.vout,n):"self";return{hash:y.txid,from:y.vin?.[0]?.addresses?.[0]??"",to:y.vout?.[0]?.addresses?.[0]??"",timestamp:(y.blockTime??0)*1e3,status:(y.confirmations??0)>0?"confirmed":"pending",action:"transfer",direction:S,assets:[{assetType:"native",value:y.vout?.[0]?.value??"0",symbol:o,decimals:i}]}})),h=yield*Te({name:`btcwallet.${r.chainId}.transaction.${s}`,fetch:f,interval:ae(r.pollingInterval)}),m=h.stop;return r._transactionSources.set(s,{source:h,refCount:1,stopAll:m}),h}));r._transactionCreations.set(s,l);try{const f=await l;return c(f)}finally{r._transactionCreations.delete(s)}})}releaseSharedTransactionSource(t){const n=this;return $(function*(){const r=n._transactionSources.get(t);r&&(r.refCount-=1,r.refCount<=0&&(yield*r.stopAll,n._transactionSources.delete(t)))})}fetchAddressInfo(t,n=!1){const r=`/api/v2/address/${t}?page=1&pageSize=50&details=txs`;return te({url:this.baseUrl,method:"POST",body:{url:r,method:"GET"},schema:vq,cacheStrategy:n?"ttl":"cache-first",cacheTtl:5e3,canCache:ha}).pipe(Ie(s=>ki("blockbook/address",s)),j(Rq))}fetchTransactionDetail(t,n=!1){const r=`/api/v2/tx/${t}`;return te({url:this.baseUrl,method:"POST",body:{url:r,method:"GET"},schema:kq,cacheStrategy:n?"ttl":"cache-first",cacheTtl:5e3,canCache:ha}).pipe(Ie(s=>ki("blockbook/tx",s)),X(s=>Oq("blockbook/tx",s)))}fetchUtxos(t,n=!1){const r=`/api/v2/utxo/${t}`;return te({url:this.baseUrl,method:"POST",body:{url:r,method:"GET"},schema:Cq,cacheStrategy:n?"ttl":"cache-first",cacheTtl:15e3,canCache:ha}).pipe(Ie(s=>ki("blockbook/utxo",s)),X(s=>Jf("blockbook/utxo",s)))}fetchFeeRate(t=6,n=!1){const r=`/api/v2/estimatefee/${t}`;return te({url:this.baseUrl,method:"POST",body:{url:r,method:"GET"},schema:Iq,cacheStrategy:n?"ttl":"cache-first",cacheTtl:3e4,canCache:ha}).pipe(Ie(s=>ki("blockbook/estimatefee",s)),X(s=>Jf("blockbook/estimatefee",s)),j(s=>String(s)))}broadcastRawTransaction(t){const n=`/api/v2/sendtx/${t}`;return te({url:this.baseUrl,method:"POST",body:{url:n,method:"GET"},schema:$q,cacheStrategy:"network-first",cacheTtl:0,canCache:async()=>!1}).pipe(Ie(r=>ki("blockbook/sendtx",r)),X(r=>Jf("blockbook/sendtx",r)))}async buildTransaction(t){if(t.type!=="transfer")throw new Error(`Transaction type not supported: ${t.type}`);const n=t,r=await J(this.fetchUtxos(n.from,!0));if(r.length===0)throw new Error("No UTXOs available");const s=await J(this.fetchFeeRate(6,!0)),o=Number(s),i=Number.isFinite(o)?o*1e8:0,c=i>0?Math.ceil(i/1e3):1,a=r.reduce((y,S)=>y+Number(S.value),0),u=Number(n.amount.raw),l=10+r.length*68+62,f=c*l;if(a<u+f)throw new Error(`Insufficient balance: need ${u+f}, have ${a}`);const h=a-u-f,m={inputs:r.map(y=>({txid:y.txid,vout:y.vout,value:Number(y.value),scriptPubKey:y.scriptPubKey??""})),outputs:[{address:n.to,value:u}],fee:f,changeAddress:n.from};return h>546&&m.outputs.push({address:n.from,value:h}),{chainId:this.chainId,intentType:"transfer",data:m}}async estimateFee(t){const n=await J(this.fetchFeeRate(6,!0)),r=Number(n),s=Number.isFinite(r)?r*1e8:0,o=s>0?Math.ceil(s/1e3):1,i=he.getConfig(this.chainId),a=BigInt(o*140),u={amount:ee.fromRaw((a*80n/100n).toString(),i.decimals,i.symbol),estimatedTime:3600},l={amount:ee.fromRaw(a.toString(),i.decimals,i.symbol),estimatedTime:1800},f={amount:ee.fromRaw((a*120n/100n).toString(),i.decimals,i.symbol),estimatedTime:600};return{slow:u,standard:l,fast:f}}async broadcastTransaction(t){const n=t.data;return J(this.broadcastRawTransaction(n))}}function qE(e,t){return e.type==="btcwallet-v1"?new VE(e,t):null}const xq={ethereum:"eth",binance:"bsc",polygon:"polygon",avalanche:"avalanche",fantom:"fantom",arbitrum:"arbitrum",optimism:"optimism",base:"base"},Fq=A({balance:g}),Nq=A({transactionHash:g,blockNumber:g,status:b(g)}),Bq=A({jsonrpc:g,id:N,result:we(Nq)}),Mq=A({token_address:g,symbol:g,name:g,decimals:N,balance:g,logo:b(we(g)),thumbnail:b(we(g)),possible_spam:b(ve),verified_contract:b(ve),total_supply:b(we(g)),security_score:b(we(N))}),Lq=fe(Mq),Hq=A({from_address:g,to_address:g,value:g,value_formatted:b(we(g)),direction:b(Jc("send","receive")),token_symbol:b(we(g)),token_logo:b(we(g))}),Dq=A({from_address:g,to_address:g,value:g,value_formatted:b(we(g)),token_name:b(we(g)),token_symbol:b(we(g)),token_decimals:b(we(g)),token_logo:b(we(g)),address:g}),Uq=A({hash:g,from_address:g,to_address:we(g),value:g,block_timestamp:g,block_number:g,receipt_status:b(g),transaction_fee:b(g),category:b(g),summary:b(g),possible_spam:b(ve),from_address_entity:b(we(g)),to_address_entity:b(we(g)),native_transfers:b(fe(Hq)),erc20_transfers:b(fe(Dq))}),Kq=A({result:fe(Uq),cursor:b(we(g)),page:b(N),page_size:b(N)});function jq(e,t,n){const r=e.toLowerCase(),s=t.toLowerCase(),o=n.toLowerCase();return r===o&&s===o?"self":r===o?"out":"in"}function zq(e){switch(e){case"send":case"receive":return"transfer";case"token send":case"token receive":return"transfer";case"nft send":case"nft receive":return"transfer";case"approve":return"approve";case"contract interaction":return"contract";default:return"transfer"}}function WS(e,t){return!e||e.length!==t.length?!0:e.length===0&&t.length===0?!1:e[0]?.hash!==t[0]?.hash}const da=jk(Qd(5),2).pipe(Tm(km(3)),nU(e=>e._tag==="RateLimitError"||e._tag==="HttpError"&&(e.status===429||e.status===401)));class Vq{chainId;type;endpoint;config;constructor(t,n){this.type=t.type,this.endpoint=t.endpoint,this.config=t.config,this.chainId=n}}class WE extends fi(hi(Vq)){symbol;decimals;moralisChain;apiKey;baseUrl;txStatusInterval;erc20Interval;rpcUrl;_eventBus=null;_txHistorySources=new Map;_txHistoryCreations=new Map;_balanceSources=new Map;_balanceCreations=new Map;_tokenBalanceSources=new Map;_tokenBalanceCreations=new Map;nativeBalance;tokenBalances;transactionHistory;transactionStatus;constructor(t,n){if(super(t,n),this.symbol=he.getSymbol(n),this.decimals=he.getDecimals(n),this.moralisChain=xq[n],!this.moralisChain)throw new Error(`[MoralisProviderEffect] Unsupported chain: ${n}`);this.baseUrl=this.endpoint;const r=Xl("MORALIS_API_KEY",`moralis-${n}`);if(!r)throw new Error("[MoralisProviderEffect] MORALIS_API_KEY is required");this.apiKey=r,this.txStatusInterval=this.config?.txStatusInterval??3e3,this.erc20Interval=this.config?.erc20Interval??12e4,this.rpcUrl=he.getRpcUrl(n);const s=this;this.transactionHistory=Se(`moralis.${n}.transactionHistory`,o=>s.createTransactionHistorySource(o)),this.nativeBalance=Se(`moralis.${n}.nativeBalance`,o=>s.createBalanceSource(o)),this.tokenBalances=Se(`moralis.${n}.tokenBalances`,o=>s.createTokenBalancesSource(o)),this.transactionStatus=Se(`moralis.${n}.transactionStatus`,o=>s.createTransactionStatusSource(o))}createTransactionHistorySource(t){return this.getSharedTxHistorySource(t.address)}createBalanceSource(t){return this.getSharedBalanceSource(t.address)}createTokenBalancesSource(t){return this.getSharedTokenBalanceSource(t.address)}getSharedTxHistorySource(t){const n=this,r=t.toLowerCase(),s=r,o=this.symbol,i=this.decimals,c=l=>({...l,stop:n.releaseSharedTxHistorySource(s)}),a=n._txHistorySources.get(s);if(a)return a.refCount+=1,z(c(a.source));const u=n._txHistoryCreations.get(s);return W(u?async()=>{const l=await u,f=n._txHistorySources.get(s);return f&&(f.refCount+=1),c(l)}:async()=>{const l=J($(function*(){n._eventBus||(n._eventBus=yield*In());const f=n._eventBus,h=n.fetchWalletHistory({address:t,limit:50},!0).pipe(na(da),j(S=>S.result.filter(_=>!_.possible_spam).map(_=>{const T=jq(_.from_address,_.to_address??"",r),C=zq(_.category),v=_.erc20_transfers&&_.erc20_transfers.length>0,k=_.native_transfers&&_.native_transfers.length>0,R=[];if(v)for(const w of _.erc20_transfers)R.push({assetType:"token",value:w.value,symbol:w.token_symbol??"Unknown",decimals:parseInt(w.token_decimals??"18",10),contractAddress:w.address,name:w.token_name,logoUrl:w.token_logo??void 0});if(k||R.length===0){const w=k?_.native_transfers[0].value:_.value;R.unshift({assetType:"native",value:w,symbol:o,decimals:i})}return{hash:_.hash,from:_.from_address,to:_.to_address??"",timestamp:new Date(_.block_timestamp).getTime(),status:_.receipt_status==="1"?"confirmed":"failed",blockNumber:BigInt(_.block_number),action:C,direction:T,assets:R,fee:_.transaction_fee?{value:_.transaction_fee,symbol:o,decimals:i}:void 0,fromEntity:_.from_address_entity??void 0,toEntity:_.to_address_entity??void 0,summary:_.summary}}))),m=yield*Te({name:`moralis.${n.chainId}.txHistory.${s}`,fetch:h,interval:ae(n.erc20Interval),walletEvents:{eventBus:f,chainId:n.chainId,address:t,types:["tx:confirmed","tx:sent"]}}),y=m.stop;return n._txHistorySources.set(s,{source:m,refCount:1,stopAll:y}),m}));n._txHistoryCreations.set(s,l);try{const f=await l;return c(f)}finally{n._txHistoryCreations.delete(s)}})}releaseSharedTxHistorySource(t){const n=this;return $(function*(){const r=n._txHistorySources.get(t);r&&(r.refCount-=1,r.refCount<=0&&(yield*r.stopAll,n._txHistorySources.delete(t)))})}getSharedBalanceSource(t){const n=this,r=t.toLowerCase(),s=this.symbol,o=this.decimals,i=u=>({...u,stop:n.releaseSharedBalanceSource(r)}),c=n._balanceSources.get(r);if(c)return c.refCount+=1,z(i(c.source));const a=n._balanceCreations.get(r);return W(a?async()=>{const u=await a,l=n._balanceSources.get(r);return l&&(l.refCount+=1),i(u)}:async()=>{const u=J($(function*(){const l=yield*n.getSharedTxHistorySource(t),f=yield*Le({name:`moralis.${n.chainId}.balance`,dependsOn:l.ref,hasChanged:WS,fetch:(m,y)=>n.fetchNativeBalance(t,y).pipe(na(da),j(S=>({amount:ee.fromRaw(S.balance,o,s),symbol:s})))}),h=ze([f.stop,l.stop]).pipe(Ae);return n._balanceSources.set(r,{source:f,refCount:1,stopAll:h}),f}));n._balanceCreations.set(r,u);try{const l=await u;return i(l)}finally{n._balanceCreations.delete(r)}})}releaseSharedBalanceSource(t){const n=this;return $(function*(){const r=n._balanceSources.get(t);r&&(r.refCount-=1,r.refCount<=0&&(yield*r.stopAll,n._balanceSources.delete(t)))})}getSharedTokenBalanceSource(t){const n=this,r=t.toLowerCase(),s=this.symbol,o=this.decimals,i=this.chainId,c=l=>({...l,stop:n.releaseSharedTokenBalanceSource(r)}),a=n._tokenBalanceSources.get(r);if(a)return a.refCount+=1,z(c(a.source));const u=n._tokenBalanceCreations.get(r);return W(u?async()=>{const l=await u,f=n._tokenBalanceSources.get(r);return f&&(f.refCount+=1),c(l)}:async()=>{const l=J($(function*(){const f=yield*n.getSharedTxHistorySource(t),h=ze({native:n.fetchNativeBalance(t),tokens:n.fetchTokenBalances(t)}).pipe(na(da),j(({native:S,tokens:_})=>{const T=[];T.push({symbol:s,name:s,amount:ee.fromRaw(S.balance,o,s),isNative:!0,decimals:o});const C=_.filter(v=>!v.possible_spam);for(const v of C){const k=v.logo??v.thumbnail??he.getTokenIconByContract(i,v.token_address)??void 0;T.push({symbol:v.symbol,name:v.name,amount:ee.fromRaw(v.balance,v.decimals,v.symbol),isNative:!1,decimals:v.decimals,icon:k,contractAddress:v.token_address,metadata:{possibleSpam:v.possible_spam,securityScore:v.security_score??void 0,verified:v.verified_contract,totalSupply:v.total_supply??void 0}})}return T})),m=yield*Le({name:`moralis.${n.chainId}.tokenBalances`,dependsOn:f.ref,hasChanged:WS,fetch:()=>h}),y=ze([m.stop,f.stop]).pipe(Ae);return n._tokenBalanceSources.set(r,{source:m,refCount:1,stopAll:y}),m}));n._tokenBalanceCreations.set(r,l);try{const f=await l;return c(f)}finally{n._tokenBalanceCreations.delete(r)}})}releaseSharedTokenBalanceSource(t){const n=this;return $(function*(){const r=n._tokenBalanceSources.get(t);r&&(r.refCount-=1,r.refCount<=0&&(yield*r.stopAll,n._tokenBalanceSources.delete(t)))})}createTransactionStatusSource(t){const n=this,r=this.chainId;return $(function*(){n._eventBus||(n._eventBus=yield*In());const s=n._eventBus,o=n.fetchTransactionReceipt(t.txHash).pipe(na(da),X(c=>$(function*(){const a=c.result;return!a?.blockNumber?{status:"pending",confirmations:0,requiredConfirmations:1}:(t.address&&(yield*s.emit(lz(r,t.address,t.txHash))),{status:a.status==="0x1"||a.status===void 0?"confirmed":"failed",confirmations:1,requiredConfirmations:1})})));return yield*Te({name:`moralis.${n.chainId}.txStatus`,fetch:o,interval:ae(n.txStatusInterval)})})}fetchNativeBalance(t,n=!1){return te({url:`${this.baseUrl}/${t}/balance`,searchParams:{chain:this.moralisChain},headers:{"X-API-Key":this.apiKey,accept:"application/json"},schema:Fq,cacheStrategy:n?"network-first":"cache-first"})}fetchTokenBalances(t,n=!1){return te({url:`${this.baseUrl}/${t}/erc20`,searchParams:{chain:this.moralisChain},headers:{"X-API-Key":this.apiKey,accept:"application/json"},schema:Lq,cacheStrategy:n?"network-first":"cache-first"}).pipe(j(r=>r.slice()))}fetchWalletHistory(t,n=!1){return te({url:`${this.baseUrl}/wallets/${t.address}/history`,searchParams:{chain:this.moralisChain,limit:String(t.limit??20)},headers:{"X-API-Key":this.apiKey,accept:"application/json"},schema:Kq,cacheStrategy:n?"network-first":"cache-first"})}fetchTransactionReceipt(t,n=!1){return te({url:this.rpcUrl,method:"POST",body:{jsonrpc:"2.0",id:1,method:"eth_getTransactionReceipt",params:[t]},schema:Bq,cacheStrategy:n?"network-first":"cache-first"})}}function JE(e,t){if(e.type==="moralis")try{return new WE(e,t)}catch(n){return console.warn(`[MoralisProviderEffect] Failed to create provider for ${t}:`,n),null}return null}const qq=[JE,kE,IE,aE,iE,lE,xE,ME,DE,zE,qE];function GE(e){const t=e.trim();if(t.length===0)return t;const n=he.getConfig(t);return n?n.id:t.toLowerCase()}function Wq(e,t){for(const n of qq){const r=n(e,t);if(r)return r}return null}function Ed(e){const t=GE(e),n=he.getApi(t),r=[];for(const s of n){const o=Wq(s,t);o&&r.push(o)}return new sE(t,r)}const JS=new Map;function Jq(e){return e.map(t=>{const n=t.config?JSON.stringify(t.config):"";return`${t.type}|${t.endpoint}|${n}`}).join(",")}function Gq(e){const t=GE(e);if(!QE.state.snapshot)return Ed(t);const n=he.getApi(t),r=Jq(n),s=JS.get(t);if(s&&s.apiKey===r)return s.provider;const o=Ed(t);return JS.set(t,{provider:o,apiKey:r}),o}const UW=Object.freeze(Object.defineProperty({__proto__:null,BiowalletProviderEffect:TE,BscWalletProviderEffect:CE,BtcWalletProviderEffect:VE,ChainProvider:sE,EthWalletProviderEffect:HE,EtherscanV1ProviderEffect:oE,EtherscanV2ProviderEffect:cE,EvmRpcProviderEffect:uE,InvalidDataError:iC,MempoolProviderEffect:BE,MoralisProviderEffect:WE,TronRpcProviderEffect:PE,TronWalletProviderEffect:jE,createBiowalletProviderEffect:kE,createBscWalletProviderEffect:IE,createBtcwalletProviderEffect:qE,createChainProvider:Ed,createEtherscanV1ProviderEffect:iE,createEtherscanV2ProviderEffect:aE,createEthwalletProviderEffect:DE,createEvmRpcProviderEffect:lE,createMempoolProviderEffect:ME,createMoralisProviderEffect:JE,createTronRpcProviderEffect:xE,createTronwalletProviderEffect:zE,getChainProvider:Gq},Symbol.toStringTag,{value:"Module"}));export{Z as C,ct as H,iC as I,$W as N,OW as S,$ as a,FW as b,Te as c,In as d,lz as e,ss as f,Gq as g,Yn as h,nE as i,xe as j,Ed as k,RW as l,ae as m,mt as n,AW as o,W as p,V0 as q,J as r,z as s,Ms as t,mE as u,ce as v,sE as w,UW as x};
