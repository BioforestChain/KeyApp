const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./web-CBGOEIbz.js","./user-profile-BqvL_q7a.js","./preload-helper-PPVm8Dsz.js","./index-D0E7N0oa.js","./derivation-_Vf8-vI5.js","./iframe-w903NJLm.js","./iframe-BOQhExOT.css","./schemas-CO8_C8zP.js","./avatar-codec-DkFCca-a.js","./service-YX1D6WHD.js","./bioforest-DqPXeYrP.js","./breakpoint-DQ_qwb34.js","./nacl-fast-B91P72J3.js","./nacl-fast-DYM6gd4g.js","./ed2curve-Cu2-8CT-.js"])))=>i.map(i=>d[i]);
import{W as At,I as St,c as Et}from"./wujie-container-CirwaSjl.js";import{t as yt}from"./web-CBGOEIbz.js";import{S as Te,q as D,r as Ie}from"./iframe-w903NJLm.js";import{_}from"./preload-helper-PPVm8Dsz.js";import{g as X,k as _t,n as fe}from"./index-CZmD6q_r.js";import{w as De,o as bt,e as Rt}from"./user-profile-BqvL_q7a.js";import{A as Tt}from"./amount-BQsqQYGO.js";import{e as L,f as It,a as Dt}from"./service-YX1D6WHD.js";import{D as he,j as me,x as Ot,B as kt}from"./derivation-_Vf8-vI5.js";import"./index-D0E7N0oa.js";import{c as Oe,p as ke,h as vt,b as N,s as Nt}from"./bioforest-DqPXeYrP.js";import{p as Pt,g as Mt,t as Ct,E as jt}from"./index-DRQXAVdd.js";const ve={motion:{timeScale:1,layoutDuration:.45,uiFastDuration:.15,layoutEase:[.4,0,.1,1],spring:{stiffness:220,damping:28,mass:.85}},css:{}};function Y(e){return!Number.isFinite(e)||e<=0?1:e}function P(e,t){const n=Y(t);return e/n}function we(e,t,n){const s=Y(t);return e*Math.pow(s,n)}function Ut(e,t){return t?{motion:{...e.motion,...t.motion,spring:{...e.motion.spring,...t.motion?.spring}},css:{...e.css,...t.css}}:e}const Ae=new WeakMap,Se=new WeakMap;function Or(e){const t=Ae.get(e);if(t)return t;const{motion:n}=e,s={type:"spring",stiffness:we(n.spring.stiffness,n.timeScale,2),damping:we(n.spring.damping,n.timeScale,1),mass:n.spring.mass},i={layout:{duration:P(n.layoutDuration,n.timeScale),ease:n.layoutEase}},c={duration:P(n.uiFastDuration,n.timeScale),ease:"easeOut"},o={motionConfig:s,sharedLayout:i,uiFast:c};return Ae.set(e,o),o}function kr(e){const t=Se.get(e);if(t)return t;const{motion:n}=e,s={"--miniapp-motion-time-scale":String(Y(n.timeScale)),"--miniapp-motion-layout-duration":`${P(n.layoutDuration,n.timeScale)}s`,"--miniapp-motion-ui-fast-duration":`${P(n.uiFastDuration,n.timeScale)}s`,"--miniapp-motion-layout-ease":`cubic-bezier(${n.layoutEase.join(",")})`};return Se.set(e,s),s}const Lt={iframe:new St,wujie:new At};function xt(e){return Lt[e]}async function Ht(e,t){return xt(e).create(t)}const vr={bio_requestAccounts:{risk:"low"},bio_selectAccount:{risk:"low"},bio_pickWallet:{risk:"low"},bio_createTransaction:{risk:"low"},bio_signMessage:{risk:"medium"},bio_signTypedData:{risk:"medium"},bio_signTransaction:{risk:"high"},bio_sendTransaction:{risk:"high"},bio_destroyAsset:{risk:"high"},bio_requestCryptoToken:{risk:"high"},bio_cryptoExecute:{risk:"low"},bio_getCryptoTokenInfo:{risk:"low"},bio_accounts:{risk:"low"},bio_chainId:{risk:"low"},bio_getBalance:{risk:"low"}},a={USER_REJECTED:4001,UNAUTHORIZED:4100,UNSUPPORTED_METHOD:4200,INTERNAL_ERROR:-32603,INVALID_PARAMS:-32602,METHOD_NOT_FOUND:-32601};function Ee(e,t,n,s){return{type:"bio_response",id:e,success:!1,error:{code:t,message:n,data:s}}}const Ne="ecosystem_my_apps",Bt={teleport:"xin.dweb.teleport",forge:"xin.dweb.forge"};function I(e){return Bt[e]??e}function ye(){try{const e=localStorage.getItem(Ne),t=e?JSON.parse(e):[],n=t.map(s=>({...s,appId:I(s.appId)}));return JSON.stringify(t)!==JSON.stringify(n)&&Pe(n),n}catch{return[]}}function Pe(e){localStorage.setItem(Ne,JSON.stringify(e))}const B=["discover","mine"],Me="ecosystem_store",Ce=()=>D.t("ecosystem:sources.defaultName");function Kt(e,t){return e.length===t.length&&e.every((n,s)=>n===t[s])}function je(){return[{url:"./miniapps/ecosystem.json",name:Ce(),lastUpdated:new Date().toISOString(),enabled:!0,status:"idle"}]}function _e(e){const t=je(),n=[...e];for(const s of t)n.some(r=>r.url===s.url)||n.push(s);return n}function Vt(e){if(!Array.isArray(e))return[];const t=new Date().toISOString();return e.map(n=>{if(typeof n=="string")return{url:n,name:"Bio 官方生态",lastUpdated:t,enabled:!0,status:"idle"};if(!n||typeof n!="object")return null;const s=n;return typeof s.url!="string"||s.url.length===0?null:{url:s.url,name:typeof s.name=="string"&&s.name.length>0?s.name:Ce(),lastUpdated:typeof s.lastUpdated=="string"&&s.lastUpdated.length>0?s.lastUpdated:t,enabled:typeof s.enabled=="boolean"?s.enabled:!0,status:s.status??"idle",errorMessage:s.errorMessage,icon:s.icon}}).filter(n=>n!==null)}function zt(){try{const e=localStorage.getItem(Me);if(e){const t=JSON.parse(e),n=Array.isArray(t.availableSubPages)&&t.availableSubPages.length>0?t.availableSubPages:B,s=t.activeSubPage??"discover",r=n.includes(s)?n:[...n,s],i=Vt(t.sources),c=_e(i);return{permissions:t.permissions??[],sources:c.length>0?c:je(),myApps:ye(),availableSubPages:r,activeSubPage:s,swiperProgress:0,syncSource:null}}}catch{}return{permissions:[],sources:_e([]),myApps:ye(),availableSubPages:B,activeSubPage:"discover",swiperProgress:0,syncSource:null}}function qt(e){try{localStorage.setItem(Me,JSON.stringify({permissions:e.permissions,sources:e.sources,availableSubPages:e.availableSubPages,activeSubPage:e.activeSubPage})),Pe(e.myApps)}catch{}}const f=new Te(zt());f.subscribe(()=>{qt(f.state)});const Ue={getGrantedPermissions:(e,t)=>e.permissions.find(n=>n.appId===t)?.granted??[],hasPermission:(e,t,n)=>Ue.getGrantedPermissions(e,t).includes(n),getEnabledSources:e=>e.sources.filter(t=>t.enabled),isAppInstalled:(e,t)=>{const n=I(t);return e.myApps.some(s=>s.appId===n)}},Wt={installApp:e=>{f.setState(t=>{const n=I(e);return t.myApps.some(s=>s.appId===n)?t:{...t,myApps:[{appId:n,installedAt:Date.now(),lastUsedAt:Date.now()},...t.myApps]}})},uninstallApp:e=>{f.setState(t=>{const n=I(e);return{...t,myApps:t.myApps.filter(s=>s.appId!==n)}})},updateAppLastUsed:e=>{f.setState(t=>{const n=I(e);return t.myApps.find(r=>r.appId===n)?{...t,myApps:t.myApps.map(r=>r.appId===n?{...r,lastUsedAt:Date.now()}:r)}:t})},grantPermissions:(e,t)=>{f.setState(n=>{const s=n.permissions.find(r=>r.appId===e);if(s){const r=[...new Set([...s.granted,...t])];return{...n,permissions:n.permissions.map(i=>i.appId===e?{...i,granted:r,grantedAt:Date.now()}:i)}}else return{...n,permissions:[...n.permissions,{appId:e,granted:t,grantedAt:Date.now()}]}})},revokePermissions:(e,t)=>{f.setState(n=>t?{...n,permissions:n.permissions.map(s=>s.appId===e?{...s,granted:s.granted.filter(r=>!t.includes(r))}:s)}:{...n,permissions:n.permissions.filter(s=>s.appId!==e)})},addSource:(e,t)=>{f.setState(n=>n.sources.some(s=>s.url===e)?n:{...n,sources:[...n.sources,{url:e,name:t,lastUpdated:new Date().toISOString(),enabled:!0,status:"idle"}]})},removeSource:e=>{f.setState(t=>({...t,sources:t.sources.filter(n=>n.url!==e)}))},toggleSource:e=>{f.setState(t=>({...t,sources:t.sources.map(n=>n.url===e?{...n,enabled:!n.enabled}:n)}))},updateSourceTimestamp:e=>{f.setState(t=>({...t,sources:t.sources.map(n=>n.url===e?{...n,lastUpdated:new Date().toISOString()}:n)}))},updateSourceStatus:(e,t,n)=>{f.setState(s=>({...s,sources:s.sources.map(r=>r.url===e?{...r,status:t,errorMessage:t==="error"?n:void 0,...t==="success"?{lastUpdated:new Date().toISOString()}:{}}:r)}))},setActiveSubPage:e=>{f.setState(t=>({...t,activeSubPage:e}))},setAvailableSubPages:e=>{f.setState(t=>{const n=e.length>0?e:B;if(Kt(t.availableSubPages,n))return t;const s=n.includes(t.activeSubPage)?t.activeSubPage:n[0]??"mine";return{...t,availableSubPages:n,activeSubPage:s}})},setSwiperProgress:e=>{f.setState(t=>({...t,swiperProgress:e}))},setSyncSource:e=>{f.setState(t=>({...t,syncSource:e}))}},$t=["bio_requestAccounts","bio_signMessage","bio_signTypedData","bio_signTransaction","bio_sendTransaction"];function Z(e){return $t.includes(e)}function Ft(e,t){return Z(t)?Ue.hasPermission(f.state,e,t):!0}function Jt(e,t){Wt.grantPermissions(e,t)}function Nr(e){const t=D.t.bind(D),s=["bio_requestAccounts","bio_accounts","bio_selectAccount","bio_pickWallet","bio_chainId","bio_getBalance","bio_createTransaction","bio_signMessage","bio_signTypedData","bio_signTransaction","bio_sendTransaction","bio_destroyAsset","bio_requestCryptoToken","bio_cryptoExecute","bio_getCryptoTokenInfo"].includes(e);return{label:s?t(`ecosystem:permissions.${e}.name`):e,description:t(s?`ecosystem:permissions.${e}.description`:"ecosystem:permissions.defaultDescription"),sensitive:Z(e)}}class Gt{handlers=new Map;iframe=null;appId="";appName="";origin="*";manifestPermissions=[];messageHandler=null;permissionRequestCallback=null;registerHandler(t,n){this.handlers.set(t,n)}setPermissionRequestCallback(t){this.permissionRequestCallback=t}attach(t,n,s,r=[]){this.detach(),this.iframe=t,this.appId=n,this.appName=s,this.manifestPermissions=r;try{const i=new URL(t.src,window.location.origin);this.origin=i.origin}catch{this.origin="*"}this.messageHandler=this.handleMessage.bind(this),window.addEventListener("message",this.messageHandler)}detach(){this.messageHandler&&(window.removeEventListener("message",this.messageHandler),this.messageHandler=null),this.iframe=null,this.appId="",this.appName="",this.manifestPermissions=[]}emit(t,...n){this.emitTo("bio",t,...n)}emitEth(t,...n){this.emitTo("eth",t,...n)}emitTron(t,...n){this.emitTo("tron",t,...n)}emitTo(t,n,...s){if(!this.iframe?.contentWindow)return;const r={type:`${t}_event`,event:n,args:s};this.iframe.contentWindow.postMessage(r,this.origin)}handleMessage(t){const n=t.data;if(!n||typeof n!="object"||!("type"in n)||!(n.type==="bio_request"||n.type==="eth_request"||n.type==="tron_request"))return;console.log("[BioBridge] Received bio message:",{origin:t.origin,expectedOrigin:this.origin,type:n.type,method:n.method});const r=this.origin.includes("localhost")&&t.origin.includes("localhost");if(!(this.origin==="*"||t.origin===this.origin||r)){console.warn("[BioBridge] Origin mismatch, ignoring message");return}if(!(t.source===this.iframe?.contentWindow||r&&t.source instanceof Window)){console.warn("[BioBridge] Source mismatch, ignoring message");return}console.log("[BioBridge] Processing message:",n.type),n.type==="bio_request"?this.processRequest(n,"bio"):n.type==="eth_request"?this.processRequest(n,"eth"):n.type==="tron_request"&&this.processRequest(n,"tron")}async processRequest(t,n){const{id:s,method:r,params:i}=t,c=this.handlers.get(r);if(!c){this.sendResponse(n,{type:`${n}_response`,id:s,success:!1,error:{code:a.METHOD_NOT_FOUND,message:`Method not found: ${r}`}});return}if(!(n!=="bio"||["bio_connect","bio_closeSplashScreen"].includes(r))){const p=["bio_accounts","bio_selectAccount","bio_pickWallet"].includes(r)&&this.manifestPermissions.includes("bio_requestAccounts"),d=p?"bio_requestAccounts":r;if(!(this.manifestPermissions.includes(r)||r==="bio_requestAccounts"||p)){this.sendResponse(n,Ee(s,a.UNAUTHORIZED,`Permission not declared in manifest: ${r}`));return}if(Z(d)&&!Ft(this.appId,d)&&!await this.requestPermission([d])){this.sendResponse(n,Ee(s,a.USER_REJECTED,"Permission denied by user"));return}}try{const p=l.state.apps.get(this.appId)?.manifest;let d=p?.icon;if(d&&!d.startsWith("http")&&!d.startsWith("data:"))try{const w=new URL(p?.url??"",window.location.origin);d=new URL(d,w).href}catch{}const h={appId:this.appId,appName:this.appName,appIcon:d,origin:this.origin,permissions:this.manifestPermissions},A=await c(i?.[0],h);this.sendResponse(n,{type:`${n}_response`,id:s,success:!0,result:A})}catch(u){const p=u instanceof Error?u.message:"Unknown error",d=u.code??a.INTERNAL_ERROR;this.sendResponse(n,{type:`${n}_response`,id:s,success:!1,error:{code:d,message:p}})}}async requestPermission(t){if(!this.permissionRequestCallback)return!1;try{const n=await this.permissionRequestCallback(this.appId,this.appName,t);return n&&Jt(this.appId,t),n}catch{return!1}}sendResponse(t,n){this.iframe?.contentWindow&&this.iframe.contentWindow.postMessage(n,this.origin)}}const g=new Gt,b=new Map,m={register(e,t){b.set(e,t)},unregister(e){b.delete(e)},get(e){return b.get(e)},has(e){return b.has(e)},getRegisteredApps(){return Array.from(b.keys())},clear(){b.clear()}},Xt=async(e,t)=>{ht(t.appId)};let Le=null,xe=null;function Pr(e){Le=e}function Mr(e){xe=e}function Q(e){return m.get(e)?.showWalletPicker??Le}function Yt(e){return m.get(e)?.getConnectedAccounts??xe}const Zt=async(e,t)=>({connected:!0}),Qt=async(e,t)=>{const n=Q(t.appId);if(!n)throw Object.assign(new Error("Wallet picker not available"),{code:a.INTERNAL_ERROR});const r=await n({chain:e?.chain,app:{name:t.appName,icon:t.appIcon}});if(!r)throw Object.assign(new Error("User rejected"),{code:a.USER_REJECTED});return[r]},en=async(e,t)=>{const n=Yt(t.appId);return n?n():[]},tn=async(e,t)=>{const n=Q(t.appId);if(!n)throw Object.assign(new Error("Wallet picker not available"),{code:a.INTERNAL_ERROR});const r=await n({...e,app:{name:t.appName,icon:t.appIcon}});if(!r)throw Object.assign(new Error("User rejected"),{code:a.USER_REJECTED});return r},nn=async(e,t)=>{const n=Q(t.appId);if(!n)throw Object.assign(new Error("Wallet picker not available"),{code:a.INTERNAL_ERROR});const r=await n({...e,app:{name:t.appName,icon:t.appIcon}});if(!r)throw Object.assign(new Error("User rejected"),{code:a.USER_REJECTED});return r},sn=async(e,t)=>De.state.selectedChain,rn=async(e,t)=>{const n=e;if(!n?.address||!n?.chain)throw Object.assign(new Error("Missing address or chain"),{code:a.INVALID_PARAMS});const s=X(n.chain);try{return(await s.nativeBalance.fetch({address:n.address}))?.amount.toRawString()??"0"}catch{return"0"}};let He=null;function Cr(e){He=e}function Be(e){return m.get(e)?.showSigningDialog??He}const an=async(e,t)=>{const n=e;if(!n?.message||!n?.address)throw Object.assign(new Error("Missing message or address"),{code:a.INVALID_PARAMS});const s=Be(t.appId);if(!s)throw Object.assign(new Error("Signing dialog not available"),{code:a.INTERNAL_ERROR});const r=await s({message:n.message,address:n.address,app:{name:t.appName}});if(!r)throw Object.assign(new Error("User rejected"),{code:a.USER_REJECTED});return r},on=async(e,t)=>{const n=e;if(!n?.data||!n?.address)throw Object.assign(new Error("Missing data or address"),{code:a.INVALID_PARAMS});const s=Be(t.appId);if(!s)throw Object.assign(new Error("Signing dialog not available"),{code:a.INTERNAL_ERROR});const r=JSON.stringify(n.data,null,2),i=await s({message:r,address:n.address,app:{name:t.appName}});if(!i)throw Object.assign(new Error("User rejected"),{code:a.USER_REJECTED});return i};let Ke=null;function jr(e){Ke=e}function cn(e){return m.get(e)?.showTransferDialog??Ke}const ln=async(e,t)=>{const n=e;if(!n?.from||!n?.to||!n?.amount||!n?.chain)throw Object.assign(new Error("Missing required parameters: from, to, amount, chain"),{code:a.INVALID_PARAMS});const s=cn(t.appId);if(!s)throw Object.assign(new Error("Transfer dialog not available"),{code:a.INTERNAL_ERROR});const r={from:n.from,to:n.to,amount:n.amount,chain:n.chain,app:{name:t.appName}};n.asset&&(r.asset=n.asset),n.tokenAddress&&(r.tokenAddress=n.tokenAddress);const i=await s(r);if(!i)throw Object.assign(new Error("User rejected"),{code:a.USER_REJECTED});return i};let dn=null;function un(e){return m.get(e)?.showDestroyDialog??dn}const pn=async(e,t)=>{const n=e;if(!n?.from||!n?.amount||!n?.chain||!n?.asset)throw Object.assign(new Error("Missing required parameters: from, amount, chain, asset"),{code:a.INVALID_PARAMS});const s=un(t.appId);if(!s)throw Object.assign(new Error("Destroy dialog not available"),{code:a.INTERNAL_ERROR});const r={from:n.from,amount:n.amount,chain:n.chain,asset:n.asset,app:{name:t.appName}},i=await s(r);if(!i)throw Object.assign(new Error("User rejected"),{code:a.USER_REJECTED});return i};function gn(e,t){const n=De.state.wallets,s=t.startsWith("0x"),r=s?t.toLowerCase():t;for(const i of n)if(i.chainAddresses.find(o=>o.chain!==e?!1:s||o.address.startsWith("0x")?o.address.toLowerCase()===r:o.address===r))return i.id;return null}async function Ve(e){if(L.state.snapshot||await It.initialize(),!L.state.snapshot)throw Object.assign(new Error("Chain configs not initialized"),{code:a.INTERNAL_ERROR});const n=Dt.getChainById(L.state,e);if(!n)throw Object.assign(new Error(`Unsupported chain: ${e}`),{code:a.INVALID_PARAMS});return n}const fn=async(e,t)=>{const n=e;if(!n?.from||!n?.to||!n?.amount||!n?.chain)throw Object.assign(new Error("Missing required parameters: from, to, amount, chain"),{code:a.INVALID_PARAMS});if(!gn(n.chain,n.from))throw Object.assign(new Error("From address is not owned by current user"),{code:a.UNAUTHORIZED});const r=await Ve(n.chain),i=n.tokenAddress?.trim()||void 0,c=n.asset??r.symbol,o=i&&typeof n.assetDecimals=="number"?n.assetDecimals:r.decimals,u=Tt.parse(n.amount,o,c),p=i&&r.chainKind==="tron"?_t(r.id):X(r.id),d=p.buildTransaction;if(!p.supportsBuildTransaction||!d)throw Object.assign(new Error(`Chain ${r.id} does not support transaction building`),{code:a.UNSUPPORTED_METHOD});const h=await d({type:"transfer",from:n.from,to:n.to,amount:u,tokenAddress:i,...n.asset?{bioAssetType:n.asset}:{},...n.remark?{remark:n.remark}:{}});if(i&&r.chainKind==="tron"){const w=h.data;if(!w||typeof w!="object"||!("rawTx"in w))throw Object.assign(new Error("TRC20 transaction builder not available"),{code:a.UNSUPPORTED_METHOD})}return{chainId:h.chainId,intentType:h.intentType,data:h.data}};let ze=null;function Ur(e){ze=e}function hn(e){return m.get(e)?.showSignTransactionDialog??ze}const mn=async(e,t)=>{const n=e;if(!n?.from||!n?.chain||!n?.unsignedTx)throw Object.assign(new Error("Missing required parameters: from, chain, unsignedTx"),{code:a.INVALID_PARAMS});const s=hn(t.appId);if(!s)throw Object.assign(new Error("SignTransaction dialog not available"),{code:a.INTERNAL_ERROR});const r=await s({from:n.from,chain:n.chain,unsignedTx:n.unsignedTx,app:{name:t.appName}});if(!r)throw Object.assign(new Error("User rejected"),{code:a.USER_REJECTED});return r};async function Lr(e){const t=await Ve(e.chainId),n=X(t.id),s=n.signTransaction;if(!n.supportsSignTransaction||!s)throw Object.assign(new Error(`Chain ${t.id} does not support transaction signing`),{code:a.UNSUPPORTED_METHOD});const r=await(await _(async()=>{const{walletStorageService:o}=await import("./web-CBGOEIbz.js").then(u=>u.i);return{walletStorageService:o}},__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11]),import.meta.url)).walletStorageService.getMnemonic(e.walletId,e.password);let i;if(t.chainKind==="evm"){const o=he(r,"ethereum",0,0);if(o.address.toLowerCase()!==e.from.toLowerCase())throw Object.assign(new Error("Signing address mismatch"),{code:a.INVALID_PARAMS});i=me(o.privateKey)}else if(t.chainKind==="bioforest"){const o=Oe(r);if(ke(o.publicKey,t.prefix??"b")!==e.from)throw Object.assign(new Error("Signing address mismatch"),{code:a.INVALID_PARAMS});i=o.secretKey}else if(t.chainKind==="tron"){const o=he(r,"tron",0,0),u=fe(e.from),p=fe(o.address);if(u!==p)throw Object.assign(new Error("Signing address mismatch"),{code:a.INVALID_PARAMS});i=me(o.privateKey)}else throw Object.assign(new Error(`Unsupported chain kind: ${t.chainKind}`),{code:a.UNSUPPORTED_METHOD});const c=await s({chainId:e.unsignedTx.chainId,intentType:e.unsignedTx.intentType??"transfer",data:e.unsignedTx.data},t.chainKind==="bioforest"?{bioSecret:r,privateKey:i}:{privateKey:i});return{chainId:c.chainId,data:c.data,signature:c.signature}}const qe=new Map,We=new Map;let $e=null,K=null,Fe=null,Je=null;function xr(e){$e=e}function Hr(e){K=e}function Br(e){Fe=e}function Kr(e){Je=e}function wn(e){return m.get(e)?.showEvmWalletPicker??$e}function Ge(e){return m.get(e)?.showEvmSigningDialog??Fe}function An(e){return m.get(e)?.showEvmTransactionDialog??Je}function v(e){return qe.get(e)??Ct(jt.binance)}function Sn(e,t){qe.set(e,t)}function En(e){return We.get(e)??[]}function yn(e,t){We.set(e,t)}const _n=async(e,t)=>v(t.appId),bn=async(e,t)=>{const n=wn(t.appId);if(!n)throw Object.assign(new Error("Wallet picker not available"),{code:a.INTERNAL_ERROR});const s=v(t.appId),r=await n({chainId:s,app:{name:t.appName,icon:t.appIcon}});if(!r)throw Object.assign(new Error("User rejected"),{code:a.USER_REJECTED});const i=[r.address];return yn(t.appId,i),i},Rn=async(e,t)=>En(t.appId),Tn=async(e,t)=>{const n=e;if(!n?.chainId)throw Object.assign(new Error("Missing chainId"),{code:a.INVALID_PARAMS});const s=n.chainId;if(!Mt(s))throw Object.assign(new Error(`Chain ${s} not supported`),{code:4902});const i=v(t.appId);if(i===s)return null;if(K&&!await K({fromChainId:i,toChainId:s,appName:t.appName,appIcon:t.appIcon}))throw Object.assign(new Error("User rejected"),{code:a.USER_REJECTED});return Sn(t.appId,s),null},In=async(e,t)=>{throw Object.assign(new Error("Adding custom chains is not supported"),{code:a.UNSUPPORTED_METHOD})},Xe=async(e,t)=>{const[n,s]=e;if(!n||!s)throw Object.assign(new Error("Missing message or address"),{code:a.INVALID_PARAMS});const r=Ge(t.appId);if(!r)throw Object.assign(new Error("Signing dialog not available"),{code:a.INTERNAL_ERROR});const i=await r({message:n,address:s,appName:t.appName});if(!i)throw Object.assign(new Error("User rejected"),{code:a.USER_REJECTED});return i.signature},Dn=async(e,t)=>{const[n,s]=e;return Xe([s,n],t)},On=async(e,t)=>{const[n,s]=e;if(!n||!s)throw Object.assign(new Error("Missing address or typedData"),{code:a.INVALID_PARAMS});const r=typeof s=="string"?JSON.parse(s):s,i=Ge(t.appId);if(!i)throw Object.assign(new Error("Signing dialog not available"),{code:a.INTERNAL_ERROR});const c=JSON.stringify(r,null,2),o=await i({message:c,address:n,appName:t.appName});if(!o)throw Object.assign(new Error("User rejected"),{code:a.USER_REJECTED});return o.signature},kn=async(e,t)=>{const n=e;if(!n?.from)throw Object.assign(new Error("Missing transaction data"),{code:a.INVALID_PARAMS});const s=An(t.appId);if(!s)throw Object.assign(new Error("Transaction dialog not available"),{code:a.INTERNAL_ERROR});n.chainId||(n.chainId=v(t.appId));const r=await s({tx:n,appName:t.appName});if(!r)throw Object.assign(new Error("User rejected"),{code:a.USER_REJECTED});return r.txHash},vn=async(e,t)=>{throw e?.from?Object.assign(new Error("eth_signTransaction not yet supported, use eth_sendTransaction"),{code:a.UNSUPPORTED_METHOD}):Object.assign(new Error("Missing transaction data"),{code:a.INVALID_PARAMS})},Nn=async(e,t)=>{const[n]=e;if(!n)throw Object.assign(new Error("Missing address"),{code:a.INVALID_PARAMS});return"0x0"},Pn=async(e,t)=>{const n=v(t.appId),s=Pt(n);return String(s)},Mn=async(e,t)=>"0x0",Cn=async(e,t)=>"KeyApp/1.0.0",jn={eth_chainId:_n,eth_requestAccounts:bn,eth_accounts:Rn,wallet_switchEthereumChain:Tn,wallet_addEthereumChain:In,personal_sign:Xe,eth_sign:Dn,eth_signTypedData_v4:On,eth_sendTransaction:kn,eth_signTransaction:vn,eth_getBalance:Nn,net_version:Pn,eth_blockNumber:Mn,web3_clientVersion:Cn};function Un(e){for(const[t,n]of Object.entries(jn))e(t,n)}const Ye=new Map;let Ze=null,Ln=null;function Vr(e){Ze=e}function xn(e){return m.get(e)?.showTronWalletPicker??Ze}function Hn(e){return m.get(e)?.showTronSigningDialog??Ln}function Qe(e){return Ye.get(e)??null}function Bn(e,t){Ye.set(e,t)}function Kn(e){return{base58:e.address,hex:e.address}}const Vn=async(e,t)=>{const n=xn(t.appId);if(!n)throw Object.assign(new Error("Wallet picker not available"),{code:a.INTERNAL_ERROR});const s=await n({app:{name:t.appName,icon:t.appIcon}});if(!s)throw Object.assign(new Error("User rejected"),{code:a.USER_REJECTED});const r=Kn(s);return Bn(t.appId,r),{code:200,message:"ok",data:r}},zn=async(e,t)=>{const n=Qe(t.appId);return n?{code:200,message:"ok",data:n}:{code:4e3,message:"Not connected",data:null}},qn=async(e,t)=>Qe(t.appId),Wn=async(e,t)=>{const n=e;if(!n?.txID)throw Object.assign(new Error("Invalid transaction"),{code:a.INVALID_PARAMS});const s=Hn(t.appId);if(!s)throw Object.assign(new Error("Signing dialog not available"),{code:a.INTERNAL_ERROR});const r=await s({transaction:n,appName:t.appName});if(!r)throw Object.assign(new Error("User rejected"),{code:a.USER_REJECTED});return r.signedTransaction},$n=async(e,t)=>{const n=e;if(!n?.txID||!n.signature)throw Object.assign(new Error("Invalid signed transaction"),{code:a.INVALID_PARAMS});return{result:!0,txid:n.txID}},Fn=async(e,t)=>{if(!e)throw Object.assign(new Error("Missing address"),{code:a.INVALID_PARAMS});return 0},Jn=async(e,t)=>{const n=e;if(!n)throw Object.assign(new Error("Missing address"),{code:a.INVALID_PARAMS});return{address:n,balance:0}},Gn={tron_requestAccounts:Vn,tron_accounts:zn,tron_getDefaultAddress:qn,tron_signTransaction:Wn,tron_sendRawTransaction:$n,tron_getBalance:Fn,tron_getAccount:Jn};function Xn(e){for(const[t,n]of Object.entries(Gn))e(t,n)}const Yn="crypto-box-db",Zn=2,S="tokens";class Qn{db=null;initialized=!1;async initialize(){this.initialized||(this.db=await bt(Yn,Zn,{upgrade(t,n){t.objectStoreNames.contains(S)&&t.deleteObjectStore(S);const s=t.createObjectStore(S,{keyPath:"tokenId"});s.createIndex("by-miniapp","miniappId"),s.createIndex("by-wallet","walletId"),s.createIndex("by-expires","expiresAt")}}),this.initialized=!0,await this.cleanupExpired())}ensureInitialized(){if(!this.initialized||!this.db)throw new Error("TokenStore not initialized")}generateTokenId(){return crypto.randomUUID()}async sha256(t){const s=new TextEncoder().encode(t),r=await crypto.subtle.digest("SHA-256",s);return Array.from(new Uint8Array(r)).map(c=>c.toString(16).padStart(2,"0")).join("")}async deriveSessionSecret(t,n,s,r){return this.sha256(`${t}:${n}:${s}:${r}`)}async createToken(t){this.ensureInitialized();const{TOKEN_DURATION_MS:n}=await _(async()=>{const{TOKEN_DURATION_MS:A}=await Promise.resolve().then(()=>V);return{TOKEN_DURATION_MS:A}},void 0,import.meta.url),s=Date.now(),r=this.generateTokenId(),i=s+n[t.duration],c=await this.deriveSessionSecret(t.walletId,t.patternKey,t.miniappId,r),o={patternKey:t.patternKey,miniappId:t.miniappId,walletId:t.walletId,address:t.address,actions:t.actions,expiresAt:i},u=JSON.stringify(await Ot(JSON.stringify(o),c)),p={tokenId:r,miniappId:t.miniappId,walletId:t.walletId,address:t.address,actions:t.actions,expiresAt:i,createdAt:s,encryptedPayload:u};await this.db.put(S,p);const{encryptedPayload:d,...h}=p;return{token:h,sessionSecret:c}}async decryptPayload(t,n){try{const s=JSON.parse(t.encryptedPayload),r=await kt(s,n);return JSON.parse(r)}catch{return null}}async getToken(t){return this.ensureInitialized(),await this.db.get(S,t)??null}async deleteToken(t){this.ensureInitialized(),await this.db.delete(S,t)}async validateToken(t,n,s,r){this.ensureInitialized();const i=await this.getToken(t);if(!i)return{valid:!1,error:"TOKEN_NOT_FOUND"};const c=await this.decryptPayload(i,n);return c?c.miniappId!==s?{valid:!1,error:"MINIAPP_MISMATCH"}:Date.now()>c.expiresAt?(await this.deleteToken(t),{valid:!1,error:"TOKEN_EXPIRED"}):c.actions.includes(r)?{valid:!0,token:i,payload:c}:{valid:!1,error:"ACTION_NOT_PERMITTED"}:{valid:!1,error:"INVALID_SESSION_SECRET"}}async getTokenInfo(t,n,s){this.ensureInitialized();const r=await this.getToken(t);if(!r)return{valid:!1,address:"",expiresAt:0,actions:[],invalidReason:"TOKEN_NOT_FOUND"};const i=await this.decryptPayload(r,n);return i?i.miniappId!==s?{valid:!1,address:"",expiresAt:0,actions:[],invalidReason:"MINIAPP_MISMATCH"}:Date.now()>i.expiresAt?(await this.deleteToken(t),{valid:!1,address:i.address,expiresAt:i.expiresAt,actions:i.actions,invalidReason:"TOKEN_EXPIRED"}):{valid:!0,address:i.address,expiresAt:i.expiresAt,actions:i.actions}:{valid:!1,address:"",expiresAt:0,actions:[],invalidReason:"INVALID_SESSION_SECRET"}}async cleanupExpired(){this.ensureInitialized();const t=Date.now(),n=this.db.transaction(S,"readwrite"),s=n.store.index("by-expires");let r=0,i=await s.openCursor(IDBKeyRange.upperBound(t));for(;i;)await i.delete(),r++,i=await i.continue();return await n.done,r}async getTokensByMiniapp(t){this.ensureInitialized();const n=Date.now();return(await this.db.getAllFromIndex(S,"by-miniapp",t)).filter(r=>r.expiresAt>n).map(({encryptedPayload:r,...i})=>i)}close(){this.db&&(this.db.close(),this.db=null,this.initialized=!1)}}const T=new Qn;class es{async execute(t,n){const s=await T.validateToken(t.tokenId,t.sessionSecret,n,t.action);if(!s.valid){const{CryptoBoxErrorCodes:o}=await _(async()=>{const{CryptoBoxErrorCodes:p}=await Promise.resolve().then(()=>V);return{CryptoBoxErrorCodes:p}},void 0,import.meta.url),u={TOKEN_NOT_FOUND:o.TOKEN_NOT_FOUND,MINIAPP_MISMATCH:o.MINIAPP_MISMATCH,TOKEN_EXPIRED:o.TOKEN_EXPIRED,ACTION_NOT_PERMITTED:o.ACTION_NOT_PERMITTED,INVALID_SESSION_SECRET:o.INVALID_SESSION_SECRET,ADDRESS_MISMATCH:o.ADDRESS_MISMATCH};throw Object.assign(new Error(`Token validation failed: ${s.error}`),{code:u[s.error]})}const{payload:r}=s;if(t.address&&t.address!==r.address){const{CryptoBoxErrorCodes:o}=await _(async()=>{const{CryptoBoxErrorCodes:u}=await Promise.resolve().then(()=>V);return{CryptoBoxErrorCodes:u}},void 0,import.meta.url);throw Object.assign(new Error(`Address mismatch: requested ${t.address} but token is for ${r.address}`),{code:o.ADDRESS_MISMATCH})}const i=await this.getKeypairForWallet(r.walletId,r.address,r.patternKey);let c;switch(t.action){case"asymmetricEncrypt":c=await this.executeAsymmetricEncrypt(t.params,i);break;case"sign":c=await this.executeSign(t.params,i);break;default:throw new Error(`Unknown action: ${t.action}`)}return{...c,address:r.address}}async getKeypairForWallet(t,n,s){try{const r=await Rt.getMnemonic(t,s),i=Oe(r),c=n.charAt(0);if(ke(i.publicKey,c)!==n)throw new Error(`Address mismatch: token address ${n} does not match wallet`);return i}catch(r){throw r instanceof Error&&r.message.includes("Address mismatch")?r:new Error(`Failed to get keypair for wallet ${t}: invalid patternKey or wallet not found`)}}normalizePublicKey(t){if(typeof t=="string")return t;if(t&&typeof t=="object"&&"type"in t&&"data"in t){const n=t;if(n.type==="Buffer"&&Array.isArray(n.data))return n.data.map(s=>s.toString(16).padStart(2,"0")).join("")}if(Array.isArray(t)||t instanceof Uint8Array)return Array.from(t).map(n=>n.toString(16).padStart(2,"0")).join("");throw new Error(`Invalid publicKey format: ${typeof t}`)}async executeAsymmetricEncrypt(t,n){const s=vt(this.normalizePublicKey(t.recipientPublicKey)),r=new TextEncoder().encode(t.data),i=await _(()=>import("./nacl-fast-B91P72J3.js").then(h=>h.n),__vite__mapDeps([12,5,2,6,13]),import.meta.url),c=await _(()=>import("./ed2curve-Cu2-8CT-.js").then(h=>h.e),__vite__mapDeps([14,5,2,6,13]),import.meta.url),o=c.convertPublicKey(s),u=c.convertSecretKey(n.secretKey);if(!o||!u)throw new Error("Failed to convert Ed25519 keys to X25519");const p=new Uint8Array(24),d=i.box(r,p,o,u);return{result:N(d),publicKey:N(n.publicKey)}}async executeSign(t,n){const s=new TextEncoder().encode(t.data),r=Nt(s,n.secretKey);return{result:N(r),publicKey:N(n.publicKey)}}}const ts=new es,ns={"5min":300*1e3,"30min":1800*1e3,"2hour":7200*1e3,"1day":1440*60*1e3},ss=["5min","30min","2hour","1day"],E={TOKEN_NOT_FOUND:4100,MINIAPP_MISMATCH:4101,TOKEN_EXPIRED:4102,ACTION_NOT_PERMITTED:4103,INVALID_SESSION_SECRET:4104,ADDRESS_MISMATCH:4105,USER_REJECTED:4001,INTERNAL_ERROR:-32603},rs={asymmetricEncrypt:{name:"非对称加密",description:"使用您的私钥进行非对称加密"},sign:{name:"数据签名",description:"使用您的私钥进行签名"}},is={"5min":"5 分钟","30min":"30 分钟","2hour":"2 小时","1day":"1 天"},V=Object.freeze(Object.defineProperty({__proto__:null,CRYPTO_ACTION_LABELS:rs,CryptoBoxErrorCodes:E,TOKEN_DURATION_LABELS:is,TOKEN_DURATION_MS:ns,TOKEN_DURATION_OPTIONS:ss},Symbol.toStringTag,{value:"Module"}));let z=null;function zr(e){z=e}const as=async(e,t)=>{const n=e;if(!n?.actions||!n?.duration||!n?.address)throw Object.assign(new Error("Missing required parameters: actions, duration, address"),{code:E.INTERNAL_ERROR});const s=["asymmetricEncrypt","sign"];for(const d of n.actions)if(!s.includes(d))throw Object.assign(new Error(`Invalid action: ${d}`),{code:E.INTERNAL_ERROR});if(!z)throw Object.assign(new Error("Crypto authorize dialog not available"),{code:E.INTERNAL_ERROR});const r=z(t.appId);if(!r)throw Object.assign(new Error("Crypto authorize dialog not available"),{code:E.INTERNAL_ERROR});const i=await r({actions:n.actions,duration:n.duration,address:n.address,chainId:n.chainId,app:{name:t.appName,icon:t.appIcon}});if(!i.approved||!i.patternKey||!i.walletId)throw Object.assign(new Error("User rejected"),{code:E.USER_REJECTED});const c=i.selectedDuration||n.duration;await T.initialize();const{token:o,sessionSecret:u}=await T.createToken({miniappId:t.appId,walletId:i.walletId,address:n.address,actions:n.actions,duration:c,patternKey:i.patternKey});return{tokenId:o.tokenId,sessionSecret:u,expiresAt:o.expiresAt,grantedActions:o.actions,address:o.address}},os=async(e,t)=>{const n=e;if(!n?.tokenId||!n?.sessionSecret||!n?.action||!n?.params)throw Object.assign(new Error("Missing required parameters: tokenId, sessionSecret, action, params"),{code:E.INTERNAL_ERROR});return await T.initialize(),await ts.execute(n,t.appId)},cs=async(e,t)=>{const n=e;if(!n?.tokenId||!n?.sessionSecret)throw Object.assign(new Error("Missing required parameters: tokenId, sessionSecret"),{code:E.INTERNAL_ERROR});await T.initialize();const s=await T.getTokenInfo(n.tokenId,n.sessionSecret,t.appId);return{valid:s.valid,address:s.address,expiresAt:s.expiresAt,actions:s.actions,invalidReason:s.invalidReason}};let be=!1;function ls(){be||(be=!0,g.registerHandler("bio_connect",Zt),g.registerHandler("bio_closeSplashScreen",Xt),g.registerHandler("bio_requestAccounts",Qt),g.registerHandler("bio_accounts",en),g.registerHandler("bio_selectAccount",tn),g.registerHandler("bio_pickWallet",nn),g.registerHandler("bio_chainId",sn),g.registerHandler("bio_getBalance",rn),g.registerHandler("bio_signMessage",an),g.registerHandler("bio_signTypedData",on),g.registerHandler("bio_createTransaction",fn),g.registerHandler("bio_signTransaction",mn),g.registerHandler("bio_sendTransaction",ln),g.registerHandler("bio_destroyAsset",pn),g.registerHandler("bio_requestCryptoToken",as),g.registerHandler("bio_cryptoExecute",os),g.registerHandler("bio_getCryptoTokenInfo",cs),Un((e,t)=>g.registerHandler(e,t)),Xn((e,t)=>g.registerHandler(e,t)))}ls();function ee(){return g}const te=new Map,q=new Set;function W(e,t){const n=`${e}:${t}`;return te.get(n)??null}function et(e){return q.add(e),()=>q.delete(e)}function tt(){q.forEach(e=>e())}const ne=new Map,se=new Map,re=new Map,ie=new Map;let nt=null,st=null;const ae=new Map,oe=new Map,O=new Map;function ds(e,t){ne.set(e,t)}function us(e,t){se.set(e,t)}function ps(e){ne.delete(e),se.delete(e)}function ce(e){return ne.get(e)??null}function gs(e){return se.get(e)??null}function fs(e,t){re.set(e,t)}function hs(e){re.delete(e)}function ms(e){return re.get(e)??null}function ws(e,t){ie.set(e,t)}function As(e){ie.delete(e)}function Ss(e){return ie.get(e)??null}function Es(e){nt=e}function ys(){return nt}function _s(e){st=e}function bs(){return st}function rt(e,t){ae.set(e,t)}function it(e){ae.delete(e)}function le(e){return ae.get(e)??null}function at(e){const t=le(e);if(!t)return null;const n=t.closest(".swiper-slide");if(n&&!n.classList.contains("swiper-slide-active"))return null;const s=t.getBoundingClientRect();return s.width<=0||s.height<=0?null:s}function Rs(e,t){oe.set(e,t)}function Ts(e){oe.delete(e)}function Is(e){return oe.get(e)??null}function Ds(e,t,n){const s=O.get(e)??new Map;s.set(t,n),O.set(e,s);const r=`${e}:${t}`;te.set(r,"ready"),tt()}function Os(e,t){const n=O.get(e);if(!n)return;n.delete(t),n.size===0&&O.delete(e);const s=`${e}:${t}`;te.set(s,"lost"),tt()}function ot(e,t){return O.get(e)?.get(t)??null}function ct(e,t){const n=ot(e,t);if(!n)return null;const s=n.closest(".swiper-slide");if(s&&!s.classList.contains("swiper-slide-active"))return null;const r=n.getBoundingClientRect();return r.width<=0||r.height<=0?null:r}function ks(e){rt("stack",e)}function vs(){it("stack")}function Ns(){return le("stack")}function Ps(){return at("stack")}async function Ms(){return _(()=>Promise.resolve().then(()=>hr),void 0,import.meta.url)}function Cs(){Ie.useEffect(()=>{Ms().then(({miniappRuntimeStore:e,activateApp:t})=>{const{activeAppId:n}=e.state;n&&t(n)})})}function js(e,t){return Ie.useSyncExternalStore(et,()=>W(e,t),()=>W(e,t))}const x=D.t.bind(D),Us={apps:new Map,visualConfig:ve,activeAppId:null,focusedAppId:null,presentations:new Map,zOrderSeed:1,isStackViewOpen:!1,maxBackgroundApps:4};function lt(e){const t=l.state.apps.get(e);if(!t)return;const n=t.containerHandle?.getIframe()??t.iframeRef;n&&ee().attach(n,e,t.manifest.name,t.manifest.permissions??[])}function Ls(e,t,n){const s=t.getIframe();s&&(ee().attach(s,e,n.name,n.permissions??[]),Hs(s))}function xs(){const e=document.createElement("div");e.style.cssText="position:fixed;top:env(safe-area-inset-top,0px);visibility:hidden;",document.body.appendChild(e);const t=e.offsetTop;return document.body.removeChild(e),Math.max(t,8)+32+8}function Hs(e){const t=xs(),s={type:"keyapp:context-update",payload:{theme:{colorMode:document.documentElement.classList.contains("dark")?"dark":"light"},env:{platform:"web",safeAreaInsets:{top:t,bottom:0,left:0,right:0}}}};e.contentWindow?.postMessage(s,"*")}const l=new Te(Us);function dt(e){l.setState(t=>({...t,visualConfig:Ut(t.visualConfig,e)}))}function Bs(e){dt({motion:{timeScale:e}})}function Ks(){l.setState(e=>({...e,visualConfig:ve}))}const $=new Set;function y(e){$.forEach(t=>t(e))}let Re=0;function ut(e,t){return Re+=1,{id:`${e}:${t}:${Date.now()}:${Re}`,kind:e,status:"requested",startedAt:Date.now()}}function Vs(e){const t=e.splashScreen;return t?typeof t=="object"&&typeof t.timeout=="number"?t.timeout:5e3:null}function zs(e,t){if(!e||e==="preparing"){if(t==="launching")return"opening";if(t==="splash")return"splash";if(t==="active")return"opened"}return e==="launching"&&t==="splash"?"splash":(e==="launching"||e==="splash")&&t==="active"?"opened":e==="active"&&t==="background"?"backgrounding":e==="background"&&t==="active"?"foregrounding":t==="closing"?"closing":t==="preparing"?"closed":t==="launching"?"opening":t==="splash"?"splash":t==="active"?"opened":t==="background"?"backgrounded":"closed"}function k(e,t){l.setState(n=>{const s=n.apps.get(e);if(!s)return n;const r=zs(s.state,t),i=new Map(n.apps);return i.set(e,{...s,state:t,flow:r}),{...n,apps:i}}),y({type:"app:state-change",appId:e,state:t})}function qs(e,t){l.setState(n=>{const s=n.apps.get(e);if(!s||s.processStatus===t)return n;const r=new Map(n.apps);return r.set(e,{...s,processStatus:t}),{...n,apps:r}})}function Ws(e,t){l.setState(n=>{const s=n.apps.get(e);if(!s||s.readiness===t)return n;const r=new Map(n.apps);return r.set(e,{...s,readiness:t}),{...n,apps:r}})}function pt(e){Ws(e,"ready");const t=l.state.apps.get(e);t&&!t.manifest.splashScreen&&(t.state==="launching"||t.state==="splash")&&U(e)}function $s(e){switch(e){case"opening":return"opened";case"backgrounding":return"backgrounded";case"foregrounding":return"opened";default:return e}}function Fs(e){l.setState(t=>{const n=t.apps.get(e);if(!n)return t;const s=$s(n.flow);if(s===n.flow)return t;const r=new Map(t.apps);return r.set(e,{...n,flow:s}),{...t,apps:r}})}const Js={launchToSplash:100},M=new Map,F=new Map,J=new Map,Gs=3e4,Xs=2500,G=new Map;function R(e){const t=G.get(e);t&&(t.cancelled=!0,t.rafId!==null&&cancelAnimationFrame(t.rafId),G.delete(e))}function Ys(e){if(!e)return!1;const t=e.getBoundingClientRect();return t.width>0&&t.height>0}function Zs(e){return e.containerHandle?.isConnected()??!1}function C(e){const t=F.get(e);t&&(clearTimeout(t),F.delete(e))}function de(e,t,n){l.setState(s=>{const i=s.presentations.get(e)??{appId:e,desktop:t,state:"hidden",zOrder:s.zOrderSeed,transitionId:null,transitionKind:null},c={...i,...n,appId:e,desktop:n.desktop??i.desktop},o=new Map(s.presentations);return o.set(e,c),{...s,presentations:o}})}function gt(e){l.setState(t=>{const n=t.presentations.get(e),s=t.zOrderSeed+1,r=new Map(t.presentations);return n&&r.set(e,{...n,zOrder:s}),{...t,activeAppId:e,focusedAppId:e,presentations:r,zOrderSeed:s}})}function Qs(e,t){const n=l.state.presentations.get(e);n&&(n.transitionKind!=="present"||n.transitionId!==t||de(e,n.desktop,{state:"presented",transitionId:null,transitionKind:null}))}function er(e,t){const n=l.state.presentations.get(e);n&&(n.transitionKind!=="dismiss"||n.transitionId!==t||j(e))}function ue(e){C(e),pt(e),U(e)}function H(e,t){R(e);const n=l.state.apps.get(e);n?.containerHandle&&n.containerHandle.destroy(),l.setState(s=>{const r=new Map(s.apps);r.delete(e);const i=new Map(s.presentations);return i.delete(e),{...s,apps:r,presentations:i,activeAppId:s.activeAppId===e?null:s.activeAppId,focusedAppId:s.focusedAppId===e?null:s.focusedAppId}}),yt.show({message:t,duration:2e3})}function tr(e,t){if(k(e,"launching"),pe(e),t){const n=setTimeout(()=>{const s=l.state.apps.get(e);if(!s||s.state!=="launching")return;k(e,"splash"),C(e);const r=Vs(s.manifest);r!==null&&F.set(e,setTimeout(()=>{const i=l.state.apps.get(e);i&&i.state==="splash"&&ue(e)},r))},Js.launchToSplash);M.set(e,[n]);return}M.set(e,[])}function nr(e,t,n){R(e);const s={cancelled:!1,rafId:null};G.set(e,s);const r=performance.now(),i=()=>{if(s.cancelled)return;const c=l.state.apps.get(e);if(!c||c.state!=="preparing"){R(e);return}const o=Ys(ce(e)),u=!!ct(t,e),p=Zs(c);if(o&&u&&p){R(e),tr(e,n);return}if(performance.now()-r>Xs){u?o?H(e,x("error:miniapp.launchFailed.containerNotReady")):H(e,x("error:miniapp.launchFailed.iconNotReady")):H(e,x("error:miniapp.launchFailed.stayOnDesktop"));return}s.rafId=requestAnimationFrame(i)};s.rafId=requestAnimationFrame(i)}function pe(e){const t=M.get(e);t&&(t.forEach(n=>clearTimeout(n)),M.delete(e))}function ft(e){const t=J.get(e);t&&(clearTimeout(t),J.delete(e))}function j(e){pe(e),ft(e),C(e),R(e),l.setState(t=>{const n=t.apps.get(e);if(!n)return t;n.containerHandle&&n.containerHandle.destroy();const s=new Map(t.apps);s.delete(e);const r=new Map(t.presentations);return r.delete(e),{...t,apps:s,presentations:r,activeAppId:t.activeAppId===e?null:t.activeAppId,focusedAppId:t.focusedAppId===e?null:t.focusedAppId}}),l.state.apps.size===0&&ee().detach()}function ht(e){ue(e)}function mt(e,t,n){const r=l.state.apps.get(e);if(r){lt(e);const d=r.manifest.targetDesktop??"stack";return de(e,d,{state:"presented",transitionId:null,transitionKind:null}),gt(e),U(e),r}const i=!!t.splashScreen,c=t.runtime??"iframe",o={appId:e,manifest:t,state:"preparing",flow:"closed",ctx:{capsuleTheme:t.capsuleTheme??"auto"},processStatus:"loading",readiness:"notReady",launchedAt:Date.now(),lastActiveAt:Date.now(),containerType:c,containerHandle:null,iframeRef:null,iconRef:ce(e)};Ht(c,{appId:e,url:t.url,mountTarget:document.body,contextParams:n,wujieConfig:t.wujieConfig,onLoad:()=>{qs(e,"loaded"),t.splashScreen||pt(e)}}).then(d=>{o.containerHandle=d,d.type==="iframe"&&(o.iframeRef=d.element),Ls(e,d,t)});const u=t.targetDesktop??"stack",p=ut("present",e);return l.setState(d=>{const h=d.zOrderSeed+1,A=new Map(d.apps);A.set(e,o);const w=new Map(d.presentations);return w.set(e,{appId:e,desktop:u,state:"presenting",zOrder:h,transitionId:p.id,transitionKind:"present"}),{...d,apps:A,presentations:w,activeAppId:e,focusedAppId:e,zOrderSeed:h}}),y({type:"app:launch",appId:e,manifest:t}),nr(e,u,i),o}function sr(e,t,n){return mt(e,t,n)}function U(e){const t=l.state,n=t.apps.get(e);n&&n.state!=="preparing"&&(t.activeAppId&&t.activeAppId!==e&&wt(t.activeAppId),n.containerHandle&&n.state==="background"&&n.containerHandle.moveToForeground(),k(e,"active"),lt(e),l.setState(s=>{const r=new Map(s.apps),i=r.get(e);return i&&r.set(e,{...i,lastActiveAt:Date.now()}),{...s,apps:r,activeAppId:e,focusedAppId:e}}),y({type:"app:activate",appId:e}))}function wt(e){const t=l.state,n=t.apps.get(e);n&&n.state!=="preparing"&&(n.containerHandle&&n.containerHandle.moveToBackground(),k(e,"background"),rr(t.maxBackgroundApps),y({type:"app:deactivate",appId:e}))}function rr(e){const t=l.state,n=Array.from(t.apps.values()).filter(s=>s.appId!==t.activeAppId&&s.state==="background").toSorted((s,r)=>s.lastActiveAt-r.lastActiveAt);for(;n.length>e;){const s=n.shift();s?.containerHandle&&(s.containerHandle.destroy(),s.containerHandle=null)}}function ge(e){const n=l.state.apps.get(e);if(!n)return;pe(e),ft(e),R(e),k(e,"closing"),C(e);const s=n.manifest.targetDesktop??"stack",r=ut("dismiss",e);de(e,s,{state:"dismissing",transitionId:r.id,transitionKind:"dismiss"}),J.set(e,setTimeout(()=>{const i=l.state.presentations.get(e);i&&(i.transitionKind!=="dismiss"||i.transitionId!==r.id||j(e))},Gs)),y({type:"app:close",appId:e})}function ir(e){ge(e)}function ar(e,t){const s=l.state.apps.get(e);if(!s)return;const r={...s.ctx,...t};l.setState(i=>{const c=new Map(i.apps),o=c.get(e);return o&&c.set(e,{...o,ctx:r}),{...i,apps:c}}),y({type:"app:ctx-change",appId:e,ctx:r})}function or(){l.state.apps.forEach((t,n)=>{ge(n),j(n)}),Et()}function cr(){l.setState(e=>({...e,isStackViewOpen:!0})),y({type:"stack-view:open"})}function lr(){l.setState(e=>({...e,isStackViewOpen:!1})),y({type:"stack-view:close"})}function dr(e){return $.add(e),()=>$.delete(e)}function ur(){return Array.from(l.state.apps.values())}function pr(){const e=l.state;return e.activeAppId?e.apps.get(e.activeAppId)??null:null}function gr(){return l.state.apps.size>0}const fr={getApps:e=>Array.from(e.apps.values()),getVisualConfig:e=>e.visualConfig,getActiveApp:e=>e.activeAppId?e.apps.get(e.activeAppId)??null:null,getFocusedAppId:e=>e.focusedAppId??e.activeAppId,getFocusedApp:e=>{const t=e.focusedAppId??e.activeAppId;return t?e.apps.get(t)??null:null},getPresentations:e=>Array.from(e.presentations.values()).sort((t,n)=>t.zOrder-n.zOrder),getPresentation:(e,t)=>e.presentations.get(t)??null,hasPresentations:e=>e.presentations.size>0,hasRunningApps:e=>e.apps.size>0,hasRunningStackApps:e=>Array.from(e.apps.values()).some(t=>(t.manifest.targetDesktop??"stack")==="stack"),isStackViewOpen:e=>e.isStackViewOpen,getBackgroundApps:e=>Array.from(e.apps.values()).filter(t=>t.state==="background"),isLaunchOverlayVisible:e=>{const t=e.focusedAppId??e.activeAppId?e.apps.get(e.focusedAppId??e.activeAppId):null;return t?.state==="launching"||t?.state==="splash"},isShowingSplash:e=>(e.focusedAppId??e.activeAppId?e.apps.get(e.focusedAppId??e.activeAppId):null)?.state==="splash",isAnimating:e=>{const t=e.focusedAppId??e.activeAppId?e.apps.get(e.focusedAppId??e.activeAppId):null;return t?.state==="launching"||t?.state==="splash"||t?.state==="closing"}},hr=Object.freeze(Object.defineProperty({__proto__:null,activateApp:U,closeAllApps:or,closeApp:ge,closeStackView:lr,deactivateApp:wt,didDismiss:er,didPresent:Qs,dismissSplash:ht,finalizeCloseApp:j,getActiveApp:pr,getDesktopAppSlotRect:ct,getDesktopAppSlotRef:ot,getDesktopContainerRef:le,getDesktopGridHostRef:Is,getDesktopRect:at,getIconInnerRef:gs,getIconRef:ce,getRunningApps:ur,getSlotStatus:W,getSplashBgRef:ms,getSplashIconRef:Ss,getStackContainerRef:Ns,getStackRect:Ps,getWindowInnerRef:bs,getWindowRef:ys,hasRunningApps:gr,launchApp:mt,miniappRuntimeSelectors:fr,miniappRuntimeStore:l,openStackView:cr,registerDesktopAppSlotRef:Ds,registerDesktopContainerRef:rt,registerDesktopGridHostRef:Rs,registerIconInnerRef:us,registerIconRef:ds,registerSplashBgRef:fs,registerSplashIconRef:ws,registerStackContainerRef:ks,registerWindowInnerRef:_s,registerWindowRef:Es,requestDismiss:ir,requestDismissSplash:ue,requestFocus:gt,requestPresent:sr,resetMiniappVisualConfig:Ks,setMiniappMotionTimeScale:Bs,setMiniappVisualConfig:dt,settleFlow:Fs,subscribe:dr,subscribeSlotStatus:et,unregisterDesktopAppSlotRef:Os,unregisterDesktopContainerRef:it,unregisterDesktopGridHostRef:Ts,unregisterIconRef:ps,unregisterSplashBgRef:hs,unregisterSplashIconRef:As,unregisterStackContainerRef:vs,updateAppContext:ar,useMiniappVisibilityRestore:Cs,useSlotStatus:js},Symbol.toStringTag,{value:"Module"}));export{Nr as $,ue as A,er as B,Rs as C,ve as D,Ts as E,Ds as F,Os as G,Wt as H,Ue as I,Lr as J,rs as K,is as L,ls as M,ee as N,Pr as O,Mr as P,Cr as Q,jr as R,Ur as S,ss as T,xr as U,Br as V,Kr as W,Vr as X,Hr as Y,zr as Z,vr as _,kr as a,fr as b,or as c,l as d,f as e,rt as f,Or as g,it as h,ds as i,us as j,ps as k,mt as l,Ut as m,ks as n,cr as o,vs as p,js as q,Ks as r,Bs as s,ot as t,Cs as u,Qs as v,Fs as w,Es as x,_s as y,ir as z};
