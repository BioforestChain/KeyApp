import{r as p,j as N}from"./iframe-CLYHcCRY.js";class V{pool=[];maxSize;constructor(e=4){this.maxSize=e}acquire(e){const a=this.pool.pop();return a?((a.width!==e||a.height!==e)&&(a.width=e,a.height=e),a):new OffscreenCanvas(e,e)}release(e){this.pool.length<this.maxSize&&this.pool.push(e)}clear(){this.pool=[]}get size(){return this.pool.length}}const T=new V,I=new Map,j=50,C=new Map,H=new Set,K=6e4;function J(t){let e=5381;for(let a=0;a<t.length;a++)e=(e<<5)+e^t.charCodeAt(a);return(e>>>0).toString(36)}function G(t){if(!t||t.length===0)return"";const e=JSON.stringify(t.map(a=>({code:a.code,args:a.args})));return J(e)}function U(t,e,a,n,c,i,h){const r=G(c),s=i?":clip":"",o=h!==void 0?`:tb${h}`:"";return`${t}:${e}:${a}:${n}${r?`:${r}`:""}${s}${o}`}function Z(){if(I.size<j)return;let t=null,e=1/0;for(const[a,n]of I)n.timestamp<e&&(e=n.timestamp,t=a);t&&I.delete(t)}function Q(t){return new Promise((e,a)=>{const n=new Image;n.crossOrigin="anonymous",n.onload=()=>e(n),n.onerror=()=>a(new Error(`Failed to load image: ${t}`)),n.src=t})}function z(t){return new Function("ctx","imageData","size","args",t)}const B=new Map;function ee(t){let e=B.get(t);return e||(e=z(t),B.set(t,e)),e}function te(t,e,a,n=10){let c=e,i=a,h=0,r=0,s=!1;for(let o=0;o<a;o++)for(let u=0;u<e;u++){const m=(o*e+u)*4;t[m+3]>=n&&(s=!0,c=Math.min(c,u),i=Math.min(i,o),h=Math.max(h,u),r=Math.max(r,o))}return s?{minX:c,minY:i,maxX:h,maxY:r}:null}function F(t,e,a){let n=1,c=0;for(let r=0;r<t.length;r+=4){if(t[r+3]<10)continue;const o=t[r],u=t[r+1],m=t[r+2],l=(.299*o+.587*u+.114*m)/255;n=Math.min(n,l),c=Math.max(c,l)}const i=c-n,h=i>.01;for(let r=0;r<t.length;r+=4){const s=t[r],o=t[r+1],u=t[r+2],m=t[r+3];let l=(.299*s+.587*o+.114*u)/255;h&&(l=(l-n)/i),l=(l-.5)*e+.5,l=Math.max(0,Math.min(1,l)),a&&(l=1-l),t[r]=255,t[r+1]=255,t[r+2]=255,t[r+3]=l*(m/255)*255}}function ae(t,e,a,n,c,i,h){const r=T.acquire(e),s=r.getContext("2d");if(!s)throw T.release(r),new Error("Failed to get 2d context");s.clearRect(0,0,e,e);const o=Math.min(e/t.width,e/t.height)*.85,u=t.width*o,m=t.height*o,l=(e-u)/2,g=(e-m)/2;s.drawImage(t,l,g,u,m);let w=s.getImageData(0,0,e,e),M=w.data;if(F(M,n,a),i){const f=te(M,e,e,20);if(f){const y=Math.max(0,f.minX-1),v=Math.max(0,f.minY-1),b=Math.min(e-y,f.maxX-f.minX+1+2),S=Math.min(e-v,f.maxY-f.minY+1+2),P=(y-l)/o,X=(v-g)/o,L=b/o,$=S/o,A=Math.max(b,S),q=e/A*.95,D=b*q,W=S*q,Y=(e-D)/2,_=(e-W)/2;s.clearRect(0,0,e,e),s.drawImage(t,P,X,L,$,Y,_,D,W),w=s.getImageData(0,0,e,e),M=w.data,F(M,n,a)}}if(h!==void 0){let f=0,k=0;for(let y=0;y<M.length;y+=4){const v=M[y+3];v>=10&&(f+=v/255,k++)}if(k>0){const y=f/k;if(y>.01){const v=h/y;for(let b=0;b<M.length;b+=4){const S=M[b+3];S>=1&&(M[b+3]=Math.min(255,Math.max(0,S*v)))}}}}if(s.putImageData(w,0,0),c&&c.length>0)for(const f of c)try{const k=ee(f.code);w=s.getImageData(0,0,e,e),k(s,w,e,f.args)}catch(k){console.error("[monochrome-mask] Pipeline hook error:",k)}const R=document.createElement("canvas");R.width=e,R.height=e;const x=R.getContext("2d");x&&x.drawImage(r,0,0);const d=R.toDataURL("image/png");return T.release(r),d}async function ne(t,e={}){const{size:a=64,invert:n=!1,contrast:c=1.5,pipeline:i,clip:h=!0,targetBrightness:r}=e,s=U(t,a,n,c,i,h,r),o=I.get(s);if(o)return o.timestamp=Date.now(),o.url;const u=C.get(s);if(u)return u;if(H.has(t))return null;const m=(async()=>{try{const l=await Q(t),g=ae(l,a,n,c,i,h,r);return Z(),I.set(s,{url:g,timestamp:Date.now()}),g}catch{return H.add(t),setTimeout(()=>H.delete(t),K),null}finally{C.delete(s)}})();return C.set(s,m),m}const re={code:`
    var data = imageData.data;
    var cx = size / 2;
    var cy = size / 2;
    var opacity = (args && args.opacity) || 1;
    
    for (var i = 0; i < data.length; i += 4) {
      var a = data[i + 3];
      if (a < 10) continue;
      
      var px = (i / 4) % size;
      var py = Math.floor((i / 4) / size);
      
      // 计算角度 (0-360)，从顶部开始顺时针
      var angle = Math.atan2(px - cx, cy - py) * 180 / Math.PI + 180;
      
      // HSV to RGB (H = angle, S = 1, V = 1) - 纯正彩虹色
      var h = (angle % 360) / 60;
      var hi = Math.floor(h) % 6;
      var f = h - Math.floor(h);
      var r, g, b;
      
      // 纯彩虹色：S=1, V=1
      switch (hi) {
        case 0: r = 255; g = Math.round(f * 255); b = 0; break;
        case 1: r = Math.round((1 - f) * 255); g = 255; b = 0; break;
        case 2: r = 0; g = 255; b = Math.round(f * 255); break;
        case 3: r = 0; g = Math.round((1 - f) * 255); b = 255; break;
        case 4: r = Math.round(f * 255); g = 0; b = 255; break;
        default: r = 255; g = 0; b = Math.round((1 - f) * 255); break;
      }
      
      data[i] = r;
      data[i + 1] = g;
      data[i + 2] = b;
      data[i + 3] = Math.round(a * opacity);
    }
    
    ctx.putImageData(imageData, 0, 0);
  `,args:{opacity:1}};function ce(t=1){return{...re,args:{opacity:t}}}function le(t,e={}){const{size:a=64,invert:n=!1,contrast:c=1.5,pipeline:i,clip:h,targetBrightness:r}=e,[s,o]=p.useState(null),u=p.useMemo(()=>i?JSON.stringify(i):"",[i]);return p.useEffect(()=>{if(!t){o(null);return}let m=!1;const l=u?JSON.parse(u):void 0,g={size:a,invert:n,contrast:c};return l&&(g.pipeline=l),h&&(g.clip=h),r!==void 0&&(g.targetBrightness=r),ne(t,g).then(w=>{m||o(w)}),()=>{m=!0}},[t,a,n,c,u,h,r]),s}class se{worker=null;ready=!1;pendingRegistrations=[];states=new Map;loadedWatermarks=new Set;rafId=null;triangleMaskBitmap=null;triangleMaskSent=!1;paused=!1;constructor(){typeof window<"u"&&(this.initWorker(),this.loadTriangleMask(),this.initVisibilityListener())}initVisibilityListener(){document.addEventListener("visibilitychange",()=>{document.hidden?this.pause():this.resume()})}pause(){this.paused=!0,this.rafId!==null&&(cancelAnimationFrame(this.rafId),this.rafId=null)}resume(){this.paused=!1,this.states.size>0&&this.scheduleFlush()}async loadTriangleMask(){try{const e=Math.min(3,window.devicePixelRatio||1),n=Math.round(24*e),c=document.createElement("canvas");c.width=n,c.height=n;const i=c.getContext("2d");if(!i)return;i.fillStyle="black",i.beginPath(),i.moveTo(0,n),i.lineTo(n,n),i.lineTo(n,0),i.closePath(),i.fill(),this.triangleMaskBitmap=await createImageBitmap(c),this.sendTriangleMaskIfReady()}catch(e){console.error("[HologramScheduler] Failed to load triangle mask:",e)}}sendTriangleMaskIfReady(){this.ready&&this.worker&&this.triangleMaskBitmap&&!this.triangleMaskSent&&(this.triangleMaskSent=!0,this.worker.postMessage({type:"setTriangleMask",bitmap:this.triangleMaskBitmap},[this.triangleMaskBitmap]))}initWorker(){try{this.worker=new Worker(new URL(""+new URL("worker-CSIBj7FT.js",import.meta.url).href,import.meta.url),{type:"module"}),this.worker.onmessage=this.handleMessage,this.worker.onerror=e=>{console.error("[HologramScheduler] Worker error:",e)}}catch(e){console.error("[HologramScheduler] Failed to create worker:",e)}}handleMessage=e=>{if(e.data.type==="ready"){this.ready=!0;for(const a of this.pendingRegistrations)this.worker.postMessage({type:"register",...a},[a.canvas]);this.pendingRegistrations=[],this.sendTriangleMaskIfReady(),this.scheduleFlush()}};register(e,a){if(!this.worker)return()=>{};const n=a.transferControlToOffscreen();return this.ready?this.worker.postMessage({type:"register",cardId:e,canvas:n},[n]):this.pendingRegistrations.push({cardId:e,canvas:n}),()=>this.unregister(e)}unregister(e){this.states.delete(e),this.worker?.postMessage({type:"unregister",cardId:e})}update(e){this.states.set(e.cardId,e),this.scheduleFlush()}loadWatermark(e,a){this.loadedWatermarks.has(e)||(this.loadedWatermarks.add(e),this.worker?.postMessage({type:"loadWatermark",key:e,url:a}))}scheduleFlush(){this.rafId!==null||this.paused||(this.rafId=requestAnimationFrame(()=>{this.rafId=null,this.flush()}))}flush(){!this.ready||this.states.size===0||!this.worker||this.worker.postMessage({type:"update",states:[...this.states.values()]})}}const E=new se,O=(t,e,a)=>Math.max(e,Math.min(a,t));function ie({priority:t="high",enabledPattern:e,enabledWatermark:a,mode:n="dynamic",pointerX:c,pointerY:i,active:h,themeHue:r,watermarkMaskUrl:s,watermarkCellSize:o,watermarkIconSize:u}){const m=p.useId(),l=p.useRef(null),g=p.useRef({width:0,height:0,dpr:1}),w=p.useRef(!1),M=p.useRef(!1),R=p.useRef({priority:t,mode:n,pointerX:c,pointerY:i,active:h,themeHue:r,enabledPattern:e,enabledWatermark:a,watermarkMaskUrl:s,watermarkCellSize:o,watermarkIconSize:u});R.current={priority:t,mode:n,pointerX:c,pointerY:i,active:h,themeHue:r,enabledPattern:e,enabledWatermark:a,watermarkMaskUrl:s,watermarkCellSize:o,watermarkIconSize:u};const x=p.useCallback(()=>{queueMicrotask(()=>{if(!M.current)return;const d=R.current,f=d.mode==="static"?{x:0,y:0}:{x:O(d.pointerX,-1,1),y:O(d.pointerY,-1,1)};E.update({cardId:m,priority:d.priority,mode:d.mode,...g.current,pointer:f,active:d.mode==="static"?!1:d.active,themeHue:d.themeHue,enabledPattern:d.enabledPattern,enabledWatermark:d.enabledWatermark,watermarkMaskUrl:d.watermarkMaskUrl,watermarkCellSize:d.watermarkCellSize,watermarkIconSize:d.watermarkIconSize})})},[m]);return p.useEffect(()=>{const d=l.current;!d||w.current||(w.current=!0,M.current=!0,E.register(m,d))},[m]),p.useEffect(()=>{const d=l.current?.parentElement;if(!d)return;const f=()=>{const y=d.getBoundingClientRect(),v=Math.min(3,window.devicePixelRatio||1);g.current={width:Math.max(1,Math.round(y.width)),height:Math.max(1,Math.round(y.height)),dpr:v}},k=new ResizeObserver(()=>{f(),x()});return k.observe(d),f(),x(),()=>k.disconnect()},[x]),p.useEffect(()=>{s&&E.loadWatermark(s,s)},[s]),p.useEffect(()=>{x()},[x,t,n,c,i,h,r,e,a,s,o,u]),N.jsx("canvas",{ref:l,className:"pointer-events-none absolute inset-0 size-full","data-testid":"wallet-card-hologram-canvas","data-pattern-enabled":e?"true":"false","data-watermark-enabled":a?"true":"false","data-mode":n,"data-priority":t})}ie.__docgenInfo={description:"",methods:[],displayName:"HologramCanvas",props:{priority:{required:!1,tsType:{name:"union",raw:"'high' | 'medium' | 'low'",elements:[{name:"literal",value:"'high'"},{name:"literal",value:"'medium'"},{name:"literal",value:"'low'"}]},description:"",defaultValue:{value:"'high'",computed:!1}},enabledPattern:{required:!0,tsType:{name:"boolean"},description:""},enabledWatermark:{required:!0,tsType:{name:"boolean"},description:""},mode:{required:!1,tsType:{name:"union",raw:"'dynamic' | 'static'",elements:[{name:"literal",value:"'dynamic'"},{name:"literal",value:"'static'"}]},description:"",defaultValue:{value:"'dynamic'",computed:!1}},pointerX:{required:!0,tsType:{name:"number"},description:""},pointerY:{required:!0,tsType:{name:"number"},description:""},active:{required:!0,tsType:{name:"boolean"},description:""},themeHue:{required:!0,tsType:{name:"number"},description:""},watermarkMaskUrl:{required:!1,tsType:{name:"union",raw:"string | null",elements:[{name:"string"},{name:"null"}]},description:""},watermarkCellSize:{required:!1,tsType:{name:"number"},description:""},watermarkIconSize:{required:!1,tsType:{name:"number"},description:""}}};export{ie as H,ce as c,le as u};
