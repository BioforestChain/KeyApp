const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./web-DpenQz7b.js","./user-profile-BcdT9kbr.js","./preload-helper-PPVm8Dsz.js","./index-D0E7N0oa.js","./bioforest-B8KXXzKH.js","./schemas-B18CumQY.js","./iframe-DP2WwkEK.js","./iframe-DNonhquR.css","./avatar-codec-sXKPhKHq.js","./breakpoint-C1BNOfKS.js","./nacl-fast-BaZN-Nr_.js","./nacl-fast-B_Uw-Sa_.js","./ed2curve-DxcYn_mt.js"])))=>i.map(i=>d[i]);
import{t as ht}from"./web-DpenQz7b.js";import{_ as y}from"./preload-helper-PPVm8Dsz.js";import{S as Re,q as he,r as be}from"./iframe-DP2WwkEK.js";import{g as F}from"./index-BgynVEcu.js";import{w as Ie,f as mt,o as wt,g as At,h as Et,b as St}from"./user-profile-BcdT9kbr.js";import{A as yt}from"./amount-BQsqQYGO.js";import{e as j,f as _t,b as Rt}from"./index-C9Fec6lp.js";import{l as bt,V as Te,W as Oe,X as It,Y as k,Z as Tt}from"./bioforest-B8KXXzKH.js";import"./index-D0E7N0oa.js";import{p as Ot,g as Dt,t as kt,E as vt}from"./index-DRQXAVdd.js";const De={motion:{timeScale:1,layoutDuration:.45,uiFastDuration:.15,layoutEase:[.4,0,.1,1],spring:{stiffness:220,damping:28,mass:.85}},css:{}};function J(e){return!Number.isFinite(e)||e<=0?1:e}function v(e,t){const n=J(t);return e/n}function me(e,t,n){const s=J(t);return e*Math.pow(s,n)}function Nt(e,t){return t?{motion:{...e.motion,...t.motion,spring:{...e.motion.spring,...t.motion?.spring}},css:{...e.css,...t.css}}:e}const we=new WeakMap,Ae=new WeakMap;function yi(e){const t=we.get(e);if(t)return t;const{motion:n}=e,s={type:"spring",stiffness:me(n.spring.stiffness,n.timeScale,2),damping:me(n.spring.damping,n.timeScale,1),mass:n.spring.mass},r={layout:{duration:v(n.layoutDuration,n.timeScale),ease:n.layoutEase}},a={duration:v(n.uiFastDuration,n.timeScale),ease:"easeOut"},c={motionConfig:s,sharedLayout:r,uiFast:a};return we.set(e,c),c}function _i(e){const t=Ae.get(e);if(t)return t;const{motion:n}=e,s={"--miniapp-motion-time-scale":String(J(n.timeScale)),"--miniapp-motion-layout-duration":`${v(n.layoutDuration,n.timeScale)}s`,"--miniapp-motion-ui-fast-duration":`${v(n.uiFastDuration,n.timeScale)}s`,"--miniapp-motion-layout-ease":`cubic-bezier(${n.layoutEase.join(",")})`};return Ae.set(e,s),s}const Pt=4,G="miniapp-iframe-container",ke="miniapp-hidden-container";function X(e,t){let n=document.getElementById(e);return n||(n=document.createElement("div"),n.id=e,t&&(n.style.cssText=`
        position: fixed;
        top: -9999px;
        left: -9999px;
        width: 1px;
        height: 1px;
        overflow: hidden;
        visibility: hidden;
        pointer-events: none;
      `),document.body.appendChild(n)),n}function Mt(e,t,n){const s=document.createElement("iframe");s.id=`miniapp-iframe-${e}`,s.dataset.appId=e;const i=new URL(t,window.location.origin);return n&&Object.entries(n).forEach(([r,a])=>{i.searchParams.set(r,a)}),s.src=i.toString(),s.sandbox.add("allow-scripts","allow-forms","allow-same-origin"),s.style.cssText=`
    width: 100%;
    height: 100%;
    border: none;
    background: transparent;
  `,s}function Ct(e){X(G,!1).appendChild(e)}function jt(e){X(ke,!0).appendChild(e)}function Ut(e){X(G,!1).appendChild(e)}function Y(e){e.src="about:blank",e.remove()}function Lt(e,t,n=Pt){const s=[],i=Array.from(e.values()).filter(r=>r.appId!==t&&r.state==="background").toSorted((r,a)=>r.lastActiveAt-a.lastActiveAt);for(;i.length>n;){const r=i.shift();r?.iframeRef&&(Y(r.iframeRef),r.iframeRef=null,s.push(r.appId))}return s}function xt(){const e=document.getElementById(G),t=document.getElementById(ke);e&&(e.innerHTML="",e.remove()),t&&(t.innerHTML="",t.remove())}const Ri={bio_requestAccounts:{risk:"low"},bio_selectAccount:{risk:"low"},bio_pickWallet:{risk:"low"},bio_createTransaction:{risk:"low"},bio_signMessage:{risk:"medium"},bio_signTypedData:{risk:"medium"},bio_signTransaction:{risk:"high"},bio_sendTransaction:{risk:"high"},bio_destroyAsset:{risk:"high"},bio_requestCryptoToken:{risk:"high"},bio_cryptoExecute:{risk:"low"},bio_getCryptoTokenInfo:{risk:"low"},bio_accounts:{risk:"low"},bio_chainId:{risk:"low"},bio_getBalance:{risk:"low"}},o={USER_REJECTED:4001,UNAUTHORIZED:4100,UNSUPPORTED_METHOD:4200,INTERNAL_ERROR:-32603,INVALID_PARAMS:-32602,METHOD_NOT_FOUND:-32601};function Ee(e,t,n,s){return{type:"bio_response",id:e,success:!1,error:{code:t,message:n,data:s}}}const ve="ecosystem_my_apps",Bt={teleport:"xin.dweb.teleport",forge:"xin.dweb.forge"};function I(e){return Bt[e]??e}function Se(){try{const e=localStorage.getItem(ve),t=e?JSON.parse(e):[],n=t.map(s=>({...s,appId:I(s.appId)}));return JSON.stringify(t)!==JSON.stringify(n)&&Ne(n),n}catch{return[]}}function Ne(e){localStorage.setItem(ve,JSON.stringify(e))}const L=["discover","mine"],Pe="ecosystem_store";function Ht(e,t){return e.length===t.length&&e.every((n,s)=>n===t[s])}function Kt(){try{const e=localStorage.getItem(Pe);if(e){const t=JSON.parse(e),n=Array.isArray(t.availableSubPages)&&t.availableSubPages.length>0?t.availableSubPages:L,s=t.activeSubPage??"discover",i=n.includes(s)?n:[...n,s];return{permissions:t.permissions??[],sources:t.sources??[{url:"./miniapps/ecosystem.json",name:"Bio 官方生态",lastUpdated:new Date().toISOString(),enabled:!0}],myApps:Se(),availableSubPages:i,activeSubPage:s,swiperProgress:0,syncSource:null}}}catch{}return{permissions:[],sources:[{url:"./miniapps/ecosystem.json",name:"Bio 官方生态",lastUpdated:new Date().toISOString(),enabled:!0}],myApps:Se(),availableSubPages:L,activeSubPage:"discover",swiperProgress:0,syncSource:null}}function Vt(e){try{localStorage.setItem(Pe,JSON.stringify({permissions:e.permissions,sources:e.sources,availableSubPages:e.availableSubPages,activeSubPage:e.activeSubPage})),Ne(e.myApps)}catch{}}const f=new Re(Kt());f.subscribe(()=>{Vt(f.state)});const Me={getGrantedPermissions:(e,t)=>e.permissions.find(n=>n.appId===t)?.granted??[],hasPermission:(e,t,n)=>Me.getGrantedPermissions(e,t).includes(n),getEnabledSources:e=>e.sources.filter(t=>t.enabled),isAppInstalled:(e,t)=>{const n=I(t);return e.myApps.some(s=>s.appId===n)}},qt={installApp:e=>{f.setState(t=>{const n=I(e);return t.myApps.some(s=>s.appId===n)?t:{...t,myApps:[{appId:n,installedAt:Date.now(),lastUsedAt:Date.now()},...t.myApps]}})},uninstallApp:e=>{f.setState(t=>{const n=I(e);return{...t,myApps:t.myApps.filter(s=>s.appId!==n)}})},updateAppLastUsed:e=>{f.setState(t=>{const n=I(e);return t.myApps.find(i=>i.appId===n)?{...t,myApps:t.myApps.map(i=>i.appId===n?{...i,lastUsedAt:Date.now()}:i)}:t})},grantPermissions:(e,t)=>{f.setState(n=>{const s=n.permissions.find(i=>i.appId===e);if(s){const i=[...new Set([...s.granted,...t])];return{...n,permissions:n.permissions.map(r=>r.appId===e?{...r,granted:i,grantedAt:Date.now()}:r)}}else return{...n,permissions:[...n.permissions,{appId:e,granted:t,grantedAt:Date.now()}]}})},revokePermissions:(e,t)=>{f.setState(n=>t?{...n,permissions:n.permissions.map(s=>s.appId===e?{...s,granted:s.granted.filter(i=>!t.includes(i))}:s)}:{...n,permissions:n.permissions.filter(s=>s.appId!==e)})},addSource:(e,t)=>{f.setState(n=>n.sources.some(s=>s.url===e)?n:{...n,sources:[...n.sources,{url:e,name:t,lastUpdated:new Date().toISOString(),enabled:!0}]})},removeSource:e=>{f.setState(t=>({...t,sources:t.sources.filter(n=>n.url!==e)}))},toggleSource:e=>{f.setState(t=>({...t,sources:t.sources.map(n=>n.url===e?{...n,enabled:!n.enabled}:n)}))},updateSourceTimestamp:e=>{f.setState(t=>({...t,sources:t.sources.map(n=>n.url===e?{...n,lastUpdated:new Date().toISOString()}:n)}))},setActiveSubPage:e=>{f.setState(t=>({...t,activeSubPage:e}))},setAvailableSubPages:e=>{f.setState(t=>{const n=e.length>0?e:L;return Ht(t.availableSubPages,n)?t:{...t,availableSubPages:n}})},setSwiperProgress:e=>{f.setState(t=>({...t,swiperProgress:e}))},setSyncSource:e=>{f.setState(t=>({...t,syncSource:e}))}},zt=["bio_requestAccounts","bio_signMessage","bio_signTypedData","bio_signTransaction","bio_sendTransaction"];function Z(e){return zt.includes(e)}function Wt(e,t){return Z(t)?Me.hasPermission(f.state,e,t):!0}function $t(e,t){qt.grantPermissions(e,t)}function bi(e){const t=he.t.bind(he),s=["bio_requestAccounts","bio_accounts","bio_selectAccount","bio_pickWallet","bio_chainId","bio_getBalance","bio_createTransaction","bio_signMessage","bio_signTypedData","bio_signTransaction","bio_sendTransaction","bio_destroyAsset","bio_requestCryptoToken","bio_cryptoExecute","bio_getCryptoTokenInfo"].includes(e);return{label:s?t(`ecosystem:permissions.${e}.name`):e,description:t(s?`ecosystem:permissions.${e}.description`:"ecosystem:permissions.defaultDescription"),sensitive:Z(e)}}class Ft{handlers=new Map;iframe=null;appId="";appName="";origin="*";manifestPermissions=[];messageHandler=null;permissionRequestCallback=null;registerHandler(t,n){this.handlers.set(t,n)}setPermissionRequestCallback(t){this.permissionRequestCallback=t}attach(t,n,s,i=[]){this.detach(),this.iframe=t,this.appId=n,this.appName=s,this.manifestPermissions=i;try{const r=new URL(t.src,window.location.origin);this.origin=r.origin}catch{this.origin="*"}this.messageHandler=this.handleMessage.bind(this),window.addEventListener("message",this.messageHandler)}detach(){this.messageHandler&&(window.removeEventListener("message",this.messageHandler),this.messageHandler=null),this.iframe=null,this.appId="",this.appName="",this.manifestPermissions=[]}emit(t,...n){this.emitTo("bio",t,...n)}emitEth(t,...n){this.emitTo("eth",t,...n)}emitTron(t,...n){this.emitTo("tron",t,...n)}emitTo(t,n,...s){if(!this.iframe?.contentWindow)return;const i={type:`${t}_event`,event:n,args:s};this.iframe.contentWindow.postMessage(i,this.origin)}handleMessage(t){const n=t.data;if(!n||typeof n!="object"||!("type"in n)||!(n.type==="bio_request"||n.type==="eth_request"||n.type==="tron_request"))return;console.log("[BioBridge] Received bio message:",{origin:t.origin,expectedOrigin:this.origin,type:n.type,method:n.method});const i=this.origin.includes("localhost")&&t.origin.includes("localhost");if(!(this.origin==="*"||t.origin===this.origin||i)){console.warn("[BioBridge] Origin mismatch, ignoring message");return}if(!(t.source===this.iframe?.contentWindow||i&&t.source instanceof Window)){console.warn("[BioBridge] Source mismatch, ignoring message");return}console.log("[BioBridge] Processing message:",n.type),n.type==="bio_request"?this.processRequest(n,"bio"):n.type==="eth_request"?this.processRequest(n,"eth"):n.type==="tron_request"&&this.processRequest(n,"tron")}async processRequest(t,n){const{id:s,method:i,params:r}=t,a=this.handlers.get(i);if(!a){this.sendResponse(n,{type:`${n}_response`,id:s,success:!1,error:{code:o.METHOD_NOT_FOUND,message:`Method not found: ${i}`}});return}if(!(n!=="bio"||["bio_connect","bio_closeSplashScreen"].includes(i))){const d=["bio_accounts","bio_selectAccount","bio_pickWallet"].includes(i)&&this.manifestPermissions.includes("bio_requestAccounts"),p=d?"bio_requestAccounts":i;if(!(this.manifestPermissions.includes(i)||i==="bio_requestAccounts"||d)){this.sendResponse(n,Ee(s,o.UNAUTHORIZED,`Permission not declared in manifest: ${i}`));return}if(Z(p)&&!Wt(this.appId,p)&&!await this.requestPermission([p])){this.sendResponse(n,Ee(s,o.USER_REJECTED,"Permission denied by user"));return}}try{const d=l.state.apps.get(this.appId)?.manifest;let p=d?.icon;if(p&&!p.startsWith("http")&&!p.startsWith("data:"))try{const fe=new URL(d?.url??"",window.location.origin);p=new URL(p,fe).href}catch{}const h={appId:this.appId,appName:this.appName,appIcon:p,origin:this.origin,permissions:this.manifestPermissions},S=await a(r?.[0],h);this.sendResponse(n,{type:`${n}_response`,id:s,success:!0,result:S})}catch(u){const d=u instanceof Error?u.message:"Unknown error",p=u.code??o.INTERNAL_ERROR;this.sendResponse(n,{type:`${n}_response`,id:s,success:!1,error:{code:p,message:d}})}}async requestPermission(t){if(!this.permissionRequestCallback)return!1;try{const n=await this.permissionRequestCallback(this.appId,this.appName,t);return n&&$t(this.appId,t),n}catch{return!1}}sendResponse(t,n){this.iframe?.contentWindow&&this.iframe.contentWindow.postMessage(n,this.origin)}}const g=new Ft,_=new Map,m={register(e,t){_.set(e,t)},unregister(e){_.delete(e)},get(e){return _.get(e)},has(e){return _.has(e)},getRegisteredApps(){return Array.from(_.keys())},clear(){_.clear()}},Jt=async(e,t)=>{pt(t.appId)};let Ce=null,je=null;function Ii(e){Ce=e}function Ti(e){je=e}function Q(e){return m.get(e)?.showWalletPicker??Ce}function Gt(e){return m.get(e)?.getConnectedAccounts??je}const Xt=async(e,t)=>({connected:!0}),Yt=async(e,t)=>{const n=Q(t.appId);if(!n)throw Object.assign(new Error("Wallet picker not available"),{code:o.INTERNAL_ERROR});const i=await n({chain:e?.chain,app:{name:t.appName,icon:t.appIcon}});if(!i)throw Object.assign(new Error("User rejected"),{code:o.USER_REJECTED});return[i]},Zt=async(e,t)=>{const n=Gt(t.appId);return n?n():[]},Qt=async(e,t)=>{const n=Q(t.appId);if(!n)throw Object.assign(new Error("Wallet picker not available"),{code:o.INTERNAL_ERROR});const i=await n({...e,app:{name:t.appName,icon:t.appIcon}});if(!i)throw Object.assign(new Error("User rejected"),{code:o.USER_REJECTED});return i},en=async(e,t)=>{const n=Q(t.appId);if(!n)throw Object.assign(new Error("Wallet picker not available"),{code:o.INTERNAL_ERROR});const i=await n({...e,app:{name:t.appName,icon:t.appIcon}});if(!i)throw Object.assign(new Error("User rejected"),{code:o.USER_REJECTED});return i},tn=async(e,t)=>Ie.state.selectedChain,nn=async(e,t)=>{const n=e;if(!n?.address||!n?.chain)throw Object.assign(new Error("Missing address or chain"),{code:o.INVALID_PARAMS});const s=F(n.chain);try{return(await s.nativeBalance.fetch({address:n.address}))?.amount.toRawString()??"0"}catch{return"0"}};let Ue=null;function Oi(e){Ue=e}function Le(e){return m.get(e)?.showSigningDialog??Ue}const sn=async(e,t)=>{const n=e;if(!n?.message||!n?.address)throw Object.assign(new Error("Missing message or address"),{code:o.INVALID_PARAMS});const s=Le(t.appId);if(!s)throw Object.assign(new Error("Signing dialog not available"),{code:o.INTERNAL_ERROR});const i=await s({message:n.message,address:n.address,app:{name:t.appName}});if(!i)throw Object.assign(new Error("User rejected"),{code:o.USER_REJECTED});return i},rn=async(e,t)=>{const n=e;if(!n?.data||!n?.address)throw Object.assign(new Error("Missing data or address"),{code:o.INVALID_PARAMS});const s=Le(t.appId);if(!s)throw Object.assign(new Error("Signing dialog not available"),{code:o.INTERNAL_ERROR});const i=JSON.stringify(n.data,null,2),r=await s({message:i,address:n.address,app:{name:t.appName}});if(!r)throw Object.assign(new Error("User rejected"),{code:o.USER_REJECTED});return r};let xe=null;function Di(e){xe=e}function an(e){return m.get(e)?.showTransferDialog??xe}const on=async(e,t)=>{const n=e;if(!n?.from||!n?.to||!n?.amount||!n?.chain)throw Object.assign(new Error("Missing required parameters: from, to, amount, chain"),{code:o.INVALID_PARAMS});const s=an(t.appId);if(!s)throw Object.assign(new Error("Transfer dialog not available"),{code:o.INTERNAL_ERROR});const i={from:n.from,to:n.to,amount:n.amount,chain:n.chain,app:{name:t.appName}};n.asset&&(i.asset=n.asset);const r=await s(i);if(!r)throw Object.assign(new Error("User rejected"),{code:o.USER_REJECTED});return r};let cn=null;function ln(e){return m.get(e)?.showDestroyDialog??cn}const dn=async(e,t)=>{const n=e;if(!n?.from||!n?.amount||!n?.chain||!n?.asset)throw Object.assign(new Error("Missing required parameters: from, amount, chain, asset"),{code:o.INVALID_PARAMS});const s=ln(t.appId);if(!s)throw Object.assign(new Error("Destroy dialog not available"),{code:o.INTERNAL_ERROR});const i={from:n.from,amount:n.amount,chain:n.chain,asset:n.asset,app:{name:t.appName}},r=await s(i);if(!r)throw Object.assign(new Error("User rejected"),{code:o.USER_REJECTED});return r};function un(e,t){const n=Ie.state.wallets,s=t.startsWith("0x"),i=s?t.toLowerCase():t;for(const r of n)if(r.chainAddresses.find(c=>c.chain!==e?!1:s||c.address.startsWith("0x")?c.address.toLowerCase()===i:c.address===i))return r.id;return null}async function Be(e){if(j.state.snapshot||await _t.initialize(),!j.state.snapshot)throw Object.assign(new Error("Chain configs not initialized"),{code:o.INTERNAL_ERROR});const n=Rt.getChainById(j.state,e);if(!n)throw Object.assign(new Error(`Unsupported chain: ${e}`),{code:o.INVALID_PARAMS});return n}const pn=async(e,t)=>{const n=e;if(!n?.from||!n?.to||!n?.amount||!n?.chain)throw Object.assign(new Error("Missing required parameters: from, to, amount, chain"),{code:o.INVALID_PARAMS});if(!un(n.chain,n.from))throw Object.assign(new Error("From address is not owned by current user"),{code:o.UNAUTHORIZED});const i=await Be(n.chain),r=yt.parse(n.amount,i.decimals,i.symbol),a=F(i.id);if(!a.supportsBuildTransaction)throw Object.assign(new Error(`Chain ${i.id} does not support transaction building`),{code:o.UNSUPPORTED_METHOD});const c=await a.buildTransaction({type:"transfer",from:n.from,to:n.to,amount:r});return{chainId:c.chainId,intentType:c.intentType,data:c.data}};let He=null;function ki(e){He=e}function gn(e){return m.get(e)?.showSignTransactionDialog??He}const fn=async(e,t)=>{const n=e;if(!n?.from||!n?.chain||!n?.unsignedTx)throw Object.assign(new Error("Missing required parameters: from, chain, unsignedTx"),{code:o.INVALID_PARAMS});const s=gn(t.appId);if(!s)throw Object.assign(new Error("SignTransaction dialog not available"),{code:o.INTERNAL_ERROR});const i=await s({from:n.from,chain:n.chain,unsignedTx:n.unsignedTx,app:{name:t.appName}});if(!i)throw Object.assign(new Error("User rejected"),{code:o.USER_REJECTED});return i};async function vi(e){const t=await Be(e.chainId),n=F(t.id);if(!n.supportsSignTransaction)throw Object.assign(new Error(`Chain ${t.id} does not support transaction signing`),{code:o.UNSUPPORTED_METHOD});const s=await(await y(async()=>{const{walletStorageService:a}=await import("./web-DpenQz7b.js").then(c=>c.i);return{walletStorageService:a}},__vite__mapDeps([0,1,2,3,4,5,6,7,8,9]),import.meta.url)).walletStorageService.getMnemonic(e.walletId,e.password);let i;if(t.chainKind==="evm"){const a=mt(s,"ethereum",0,0);if(a.address.toLowerCase()!==e.from.toLowerCase())throw Object.assign(new Error("Signing address mismatch"),{code:o.INVALID_PARAMS});i=bt(a.privateKey)}else if(t.chainKind==="bioforest"){const a=Te(s);if(Oe(a.publicKey,t.prefix??"b")!==e.from)throw Object.assign(new Error("Signing address mismatch"),{code:o.INVALID_PARAMS});i=a.secretKey}else throw Object.assign(new Error(`Unsupported chain kind: ${t.chainKind}`),{code:o.UNSUPPORTED_METHOD});const r=await n.signTransaction({chainId:e.unsignedTx.chainId,intentType:e.unsignedTx.intentType??"transfer",data:e.unsignedTx.data},t.chainKind==="bioforest"?{bioSecret:s,privateKey:i}:{privateKey:i});return{chainId:r.chainId,data:r.data,signature:r.signature}}const Ke=new Map,Ve=new Map;let qe=null,x=null,ze=null,We=null;function Ni(e){qe=e}function Pi(e){x=e}function Mi(e){ze=e}function Ci(e){We=e}function hn(e){return m.get(e)?.showEvmWalletPicker??qe}function $e(e){return m.get(e)?.showEvmSigningDialog??ze}function mn(e){return m.get(e)?.showEvmTransactionDialog??We}function D(e){return Ke.get(e)??kt(vt.binance)}function wn(e,t){Ke.set(e,t)}function An(e){return Ve.get(e)??[]}function En(e,t){Ve.set(e,t)}const Sn=async(e,t)=>D(t.appId),yn=async(e,t)=>{const n=hn(t.appId);if(!n)throw Object.assign(new Error("Wallet picker not available"),{code:o.INTERNAL_ERROR});const s=D(t.appId),i=await n({chainId:s,app:{name:t.appName,icon:t.appIcon}});if(!i)throw Object.assign(new Error("User rejected"),{code:o.USER_REJECTED});const r=[i.address];return En(t.appId,r),r},_n=async(e,t)=>An(t.appId),Rn=async(e,t)=>{const n=e;if(!n?.chainId)throw Object.assign(new Error("Missing chainId"),{code:o.INVALID_PARAMS});const s=n.chainId;if(!Dt(s))throw Object.assign(new Error(`Chain ${s} not supported`),{code:4902});const r=D(t.appId);if(r===s)return null;if(x&&!await x({fromChainId:r,toChainId:s,appName:t.appName,appIcon:t.appIcon}))throw Object.assign(new Error("User rejected"),{code:o.USER_REJECTED});return wn(t.appId,s),null},bn=async(e,t)=>{throw Object.assign(new Error("Adding custom chains is not supported"),{code:o.UNSUPPORTED_METHOD})},Fe=async(e,t)=>{const[n,s]=e;if(!n||!s)throw Object.assign(new Error("Missing message or address"),{code:o.INVALID_PARAMS});const i=$e(t.appId);if(!i)throw Object.assign(new Error("Signing dialog not available"),{code:o.INTERNAL_ERROR});const r=await i({message:n,address:s,appName:t.appName});if(!r)throw Object.assign(new Error("User rejected"),{code:o.USER_REJECTED});return r.signature},In=async(e,t)=>{const[n,s]=e;return Fe([s,n],t)},Tn=async(e,t)=>{const[n,s]=e;if(!n||!s)throw Object.assign(new Error("Missing address or typedData"),{code:o.INVALID_PARAMS});const i=typeof s=="string"?JSON.parse(s):s,r=$e(t.appId);if(!r)throw Object.assign(new Error("Signing dialog not available"),{code:o.INTERNAL_ERROR});const a=JSON.stringify(i,null,2),c=await r({message:a,address:n,appName:t.appName});if(!c)throw Object.assign(new Error("User rejected"),{code:o.USER_REJECTED});return c.signature},On=async(e,t)=>{const n=e;if(!n?.from)throw Object.assign(new Error("Missing transaction data"),{code:o.INVALID_PARAMS});const s=mn(t.appId);if(!s)throw Object.assign(new Error("Transaction dialog not available"),{code:o.INTERNAL_ERROR});n.chainId||(n.chainId=D(t.appId));const i=await s({tx:n,appName:t.appName});if(!i)throw Object.assign(new Error("User rejected"),{code:o.USER_REJECTED});return i.txHash},Dn=async(e,t)=>{throw e?.from?Object.assign(new Error("eth_signTransaction not yet supported, use eth_sendTransaction"),{code:o.UNSUPPORTED_METHOD}):Object.assign(new Error("Missing transaction data"),{code:o.INVALID_PARAMS})},kn=async(e,t)=>{const[n]=e;if(!n)throw Object.assign(new Error("Missing address"),{code:o.INVALID_PARAMS});return"0x0"},vn=async(e,t)=>{const n=D(t.appId),s=Ot(n);return String(s)},Nn=async(e,t)=>"0x0",Pn=async(e,t)=>"KeyApp/1.0.0",Mn={eth_chainId:Sn,eth_requestAccounts:yn,eth_accounts:_n,wallet_switchEthereumChain:Rn,wallet_addEthereumChain:bn,personal_sign:Fe,eth_sign:In,eth_signTypedData_v4:Tn,eth_sendTransaction:On,eth_signTransaction:Dn,eth_getBalance:kn,net_version:vn,eth_blockNumber:Nn,web3_clientVersion:Pn};function Cn(e){for(const[t,n]of Object.entries(Mn))e(t,n)}const Je=new Map;let Ge=null,jn=null;function ji(e){Ge=e}function Un(e){return m.get(e)?.showTronWalletPicker??Ge}function Ln(e){return m.get(e)?.showTronSigningDialog??jn}function Xe(e){return Je.get(e)??null}function xn(e,t){Je.set(e,t)}function Bn(e){return{base58:e.address,hex:e.address}}const Hn=async(e,t)=>{const n=Un(t.appId);if(!n)throw Object.assign(new Error("Wallet picker not available"),{code:o.INTERNAL_ERROR});const s=await n({app:{name:t.appName,icon:t.appIcon}});if(!s)throw Object.assign(new Error("User rejected"),{code:o.USER_REJECTED});const i=Bn(s);return xn(t.appId,i),{code:200,message:"ok",data:i}},Kn=async(e,t)=>{const n=Xe(t.appId);return n?{code:200,message:"ok",data:n}:{code:4e3,message:"Not connected",data:null}},Vn=async(e,t)=>Xe(t.appId),qn=async(e,t)=>{const n=e;if(!n?.txID)throw Object.assign(new Error("Invalid transaction"),{code:o.INVALID_PARAMS});const s=Ln(t.appId);if(!s)throw Object.assign(new Error("Signing dialog not available"),{code:o.INTERNAL_ERROR});const i=await s({transaction:n,appName:t.appName});if(!i)throw Object.assign(new Error("User rejected"),{code:o.USER_REJECTED});return i.signedTransaction},zn=async(e,t)=>{const n=e;if(!n?.txID||!n.signature)throw Object.assign(new Error("Invalid signed transaction"),{code:o.INVALID_PARAMS});return{result:!0,txid:n.txID}},Wn=async(e,t)=>{if(!e)throw Object.assign(new Error("Missing address"),{code:o.INVALID_PARAMS});return 0},$n=async(e,t)=>{const n=e;if(!n)throw Object.assign(new Error("Missing address"),{code:o.INVALID_PARAMS});return{address:n,balance:0}},Fn={tron_requestAccounts:Hn,tron_accounts:Kn,tron_getDefaultAddress:Vn,tron_signTransaction:qn,tron_sendRawTransaction:zn,tron_getBalance:Wn,tron_getAccount:$n};function Jn(e){for(const[t,n]of Object.entries(Fn))e(t,n)}const Gn="crypto-box-db",Xn=2,w="tokens";class Yn{db=null;initialized=!1;async initialize(){this.initialized||(this.db=await wt(Gn,Xn,{upgrade(t,n){t.objectStoreNames.contains(w)&&t.deleteObjectStore(w);const s=t.createObjectStore(w,{keyPath:"tokenId"});s.createIndex("by-miniapp","miniappId"),s.createIndex("by-wallet","walletId"),s.createIndex("by-expires","expiresAt")}}),this.initialized=!0,await this.cleanupExpired())}ensureInitialized(){if(!this.initialized||!this.db)throw new Error("TokenStore not initialized")}generateTokenId(){return crypto.randomUUID()}async sha256(t){const s=new TextEncoder().encode(t),i=await crypto.subtle.digest("SHA-256",s);return Array.from(new Uint8Array(i)).map(a=>a.toString(16).padStart(2,"0")).join("")}async deriveSessionSecret(t,n,s,i){return this.sha256(`${t}:${n}:${s}:${i}`)}async createToken(t){this.ensureInitialized();const{TOKEN_DURATION_MS:n}=await y(async()=>{const{TOKEN_DURATION_MS:S}=await Promise.resolve().then(()=>B);return{TOKEN_DURATION_MS:S}},void 0,import.meta.url),s=Date.now(),i=this.generateTokenId(),r=s+n[t.duration],a=await this.deriveSessionSecret(t.walletId,t.patternKey,t.miniappId,i),c={patternKey:t.patternKey,miniappId:t.miniappId,walletId:t.walletId,address:t.address,actions:t.actions,expiresAt:r},u=JSON.stringify(await At(JSON.stringify(c),a)),d={tokenId:i,miniappId:t.miniappId,walletId:t.walletId,address:t.address,actions:t.actions,expiresAt:r,createdAt:s,encryptedPayload:u};await this.db.put(w,d);const{encryptedPayload:p,...h}=d;return{token:h,sessionSecret:a}}async decryptPayload(t,n){try{const s=JSON.parse(t.encryptedPayload),i=await Et(s,n);return JSON.parse(i)}catch{return null}}async getToken(t){return this.ensureInitialized(),await this.db.get(w,t)??null}async deleteToken(t){this.ensureInitialized(),await this.db.delete(w,t)}async validateToken(t,n,s,i){this.ensureInitialized();const r=await this.getToken(t);if(!r)return{valid:!1,error:"TOKEN_NOT_FOUND"};const a=await this.decryptPayload(r,n);return a?a.miniappId!==s?{valid:!1,error:"MINIAPP_MISMATCH"}:Date.now()>a.expiresAt?(await this.deleteToken(t),{valid:!1,error:"TOKEN_EXPIRED"}):a.actions.includes(i)?{valid:!0,token:r,payload:a}:{valid:!1,error:"ACTION_NOT_PERMITTED"}:{valid:!1,error:"INVALID_SESSION_SECRET"}}async getTokenInfo(t,n,s){this.ensureInitialized();const i=await this.getToken(t);if(!i)return{valid:!1,address:"",expiresAt:0,actions:[],invalidReason:"TOKEN_NOT_FOUND"};const r=await this.decryptPayload(i,n);return r?r.miniappId!==s?{valid:!1,address:"",expiresAt:0,actions:[],invalidReason:"MINIAPP_MISMATCH"}:Date.now()>r.expiresAt?(await this.deleteToken(t),{valid:!1,address:r.address,expiresAt:r.expiresAt,actions:r.actions,invalidReason:"TOKEN_EXPIRED"}):{valid:!0,address:r.address,expiresAt:r.expiresAt,actions:r.actions}:{valid:!1,address:"",expiresAt:0,actions:[],invalidReason:"INVALID_SESSION_SECRET"}}async cleanupExpired(){this.ensureInitialized();const t=Date.now(),n=this.db.transaction(w,"readwrite"),s=n.store.index("by-expires");let i=0,r=await s.openCursor(IDBKeyRange.upperBound(t));for(;r;)await r.delete(),i++,r=await r.continue();return await n.done,i}async getTokensByMiniapp(t){this.ensureInitialized();const n=Date.now();return(await this.db.getAllFromIndex(w,"by-miniapp",t)).filter(i=>i.expiresAt>n).map(({encryptedPayload:i,...r})=>r)}close(){this.db&&(this.db.close(),this.db=null,this.initialized=!1)}}const b=new Yn;class Zn{async execute(t,n){const s=await b.validateToken(t.tokenId,t.sessionSecret,n,t.action);if(!s.valid){const{CryptoBoxErrorCodes:c}=await y(async()=>{const{CryptoBoxErrorCodes:d}=await Promise.resolve().then(()=>B);return{CryptoBoxErrorCodes:d}},void 0,import.meta.url),u={TOKEN_NOT_FOUND:c.TOKEN_NOT_FOUND,MINIAPP_MISMATCH:c.MINIAPP_MISMATCH,TOKEN_EXPIRED:c.TOKEN_EXPIRED,ACTION_NOT_PERMITTED:c.ACTION_NOT_PERMITTED,INVALID_SESSION_SECRET:c.INVALID_SESSION_SECRET,ADDRESS_MISMATCH:c.ADDRESS_MISMATCH};throw Object.assign(new Error(`Token validation failed: ${s.error}`),{code:u[s.error]})}const{payload:i}=s;if(t.address&&t.address!==i.address){const{CryptoBoxErrorCodes:c}=await y(async()=>{const{CryptoBoxErrorCodes:u}=await Promise.resolve().then(()=>B);return{CryptoBoxErrorCodes:u}},void 0,import.meta.url);throw Object.assign(new Error(`Address mismatch: requested ${t.address} but token is for ${i.address}`),{code:c.ADDRESS_MISMATCH})}const r=await this.getKeypairForWallet(i.walletId,i.address,i.patternKey);let a;switch(t.action){case"asymmetricEncrypt":a=await this.executeAsymmetricEncrypt(t.params,r);break;case"sign":a=await this.executeSign(t.params,r);break;default:throw new Error(`Unknown action: ${t.action}`)}return{...a,address:i.address}}async getKeypairForWallet(t,n,s){try{const i=await St.getMnemonic(t,s),r=Te(i),a=n.charAt(0);if(Oe(r.publicKey,a)!==n)throw new Error(`Address mismatch: token address ${n} does not match wallet`);return r}catch(i){throw i instanceof Error&&i.message.includes("Address mismatch")?i:new Error(`Failed to get keypair for wallet ${t}: invalid patternKey or wallet not found`)}}normalizePublicKey(t){if(typeof t=="string")return t;if(t&&typeof t=="object"&&"type"in t&&"data"in t){const n=t;if(n.type==="Buffer"&&Array.isArray(n.data))return n.data.map(s=>s.toString(16).padStart(2,"0")).join("")}if(Array.isArray(t)||t instanceof Uint8Array)return Array.from(t).map(n=>n.toString(16).padStart(2,"0")).join("");throw new Error(`Invalid publicKey format: ${typeof t}`)}async executeAsymmetricEncrypt(t,n){const s=It(this.normalizePublicKey(t.recipientPublicKey)),i=new TextEncoder().encode(t.data),r=await y(()=>import("./nacl-fast-BaZN-Nr_.js").then(h=>h.n),__vite__mapDeps([10,6,2,7,11]),import.meta.url),a=await y(()=>import("./ed2curve-DxcYn_mt.js").then(h=>h.e),__vite__mapDeps([12,6,2,7,11]),import.meta.url),c=a.convertPublicKey(s),u=a.convertSecretKey(n.secretKey);if(!c||!u)throw new Error("Failed to convert Ed25519 keys to X25519");const d=new Uint8Array(24),p=r.box(i,d,c,u);return{result:k(p),publicKey:k(n.publicKey)}}async executeSign(t,n){const s=new TextEncoder().encode(t.data),i=Tt(s,n.secretKey);return{result:k(i),publicKey:k(n.publicKey)}}}const Qn=new Zn,es={"5min":300*1e3,"30min":1800*1e3,"2hour":7200*1e3,"1day":1440*60*1e3},ts=["5min","30min","2hour","1day"],A={TOKEN_NOT_FOUND:4100,MINIAPP_MISMATCH:4101,TOKEN_EXPIRED:4102,ACTION_NOT_PERMITTED:4103,INVALID_SESSION_SECRET:4104,ADDRESS_MISMATCH:4105,USER_REJECTED:4001,INTERNAL_ERROR:-32603},ns={asymmetricEncrypt:{name:"非对称加密",description:"使用您的私钥进行非对称加密"},sign:{name:"数据签名",description:"使用您的私钥进行签名"}},ss={"5min":"5 分钟","30min":"30 分钟","2hour":"2 小时","1day":"1 天"},B=Object.freeze(Object.defineProperty({__proto__:null,CRYPTO_ACTION_LABELS:ns,CryptoBoxErrorCodes:A,TOKEN_DURATION_LABELS:ss,TOKEN_DURATION_MS:es,TOKEN_DURATION_OPTIONS:ts},Symbol.toStringTag,{value:"Module"}));let H=null;function Ui(e){H=e}const is=async(e,t)=>{const n=e;if(!n?.actions||!n?.duration||!n?.address)throw Object.assign(new Error("Missing required parameters: actions, duration, address"),{code:A.INTERNAL_ERROR});const s=["asymmetricEncrypt","sign"];for(const p of n.actions)if(!s.includes(p))throw Object.assign(new Error(`Invalid action: ${p}`),{code:A.INTERNAL_ERROR});if(!H)throw Object.assign(new Error("Crypto authorize dialog not available"),{code:A.INTERNAL_ERROR});const i=H(t.appId);if(!i)throw Object.assign(new Error("Crypto authorize dialog not available"),{code:A.INTERNAL_ERROR});const r=await i({actions:n.actions,duration:n.duration,address:n.address,chainId:n.chainId,app:{name:t.appName,icon:t.appIcon}});if(!r.approved||!r.patternKey||!r.walletId)throw Object.assign(new Error("User rejected"),{code:A.USER_REJECTED});const a=r.selectedDuration||n.duration;await b.initialize();const{token:c,sessionSecret:u}=await b.createToken({miniappId:t.appId,walletId:r.walletId,address:n.address,actions:n.actions,duration:a,patternKey:r.patternKey});return{tokenId:c.tokenId,sessionSecret:u,expiresAt:c.expiresAt,grantedActions:c.actions,address:c.address}},rs=async(e,t)=>{const n=e;if(!n?.tokenId||!n?.sessionSecret||!n?.action||!n?.params)throw Object.assign(new Error("Missing required parameters: tokenId, sessionSecret, action, params"),{code:A.INTERNAL_ERROR});return await b.initialize(),await Qn.execute(n,t.appId)},as=async(e,t)=>{const n=e;if(!n?.tokenId||!n?.sessionSecret)throw Object.assign(new Error("Missing required parameters: tokenId, sessionSecret"),{code:A.INTERNAL_ERROR});await b.initialize();const s=await b.getTokenInfo(n.tokenId,n.sessionSecret,t.appId);return{valid:s.valid,address:s.address,expiresAt:s.expiresAt,actions:s.actions,invalidReason:s.invalidReason}};let ye=!1;function os(){ye||(ye=!0,g.registerHandler("bio_connect",Xt),g.registerHandler("bio_closeSplashScreen",Jt),g.registerHandler("bio_requestAccounts",Yt),g.registerHandler("bio_accounts",Zt),g.registerHandler("bio_selectAccount",Qt),g.registerHandler("bio_pickWallet",en),g.registerHandler("bio_chainId",tn),g.registerHandler("bio_getBalance",nn),g.registerHandler("bio_signMessage",sn),g.registerHandler("bio_signTypedData",rn),g.registerHandler("bio_createTransaction",pn),g.registerHandler("bio_signTransaction",fn),g.registerHandler("bio_sendTransaction",on),g.registerHandler("bio_destroyAsset",dn),g.registerHandler("bio_requestCryptoToken",is),g.registerHandler("bio_cryptoExecute",rs),g.registerHandler("bio_getCryptoTokenInfo",as),Cn((e,t)=>g.registerHandler(e,t)),Jn((e,t)=>g.registerHandler(e,t)))}os();function ee(){return g}const te=new Map,K=new Set;function V(e,t){const n=`${e}:${t}`;return te.get(n)??null}function Ye(e){return K.add(e),()=>K.delete(e)}function Ze(){K.forEach(e=>e())}const ne=new Map,se=new Map,ie=new Map,re=new Map;let Qe=null,et=null;const ae=new Map,oe=new Map,T=new Map;function cs(e,t){ne.set(e,t)}function ls(e,t){se.set(e,t)}function ds(e){ne.delete(e),se.delete(e)}function ce(e){return ne.get(e)??null}function us(e){return se.get(e)??null}function ps(e,t){ie.set(e,t)}function gs(e){ie.delete(e)}function fs(e){return ie.get(e)??null}function hs(e,t){re.set(e,t)}function ms(e){re.delete(e)}function ws(e){return re.get(e)??null}function As(e){Qe=e}function Es(){return Qe}function Ss(e){et=e}function ys(){return et}function tt(e,t){ae.set(e,t)}function nt(e){ae.delete(e)}function le(e){return ae.get(e)??null}function st(e){const t=le(e);if(!t)return null;const n=t.closest(".swiper-slide");if(n&&!n.classList.contains("swiper-slide-active"))return null;const s=t.getBoundingClientRect();return s.width<=0||s.height<=0?null:s}function _s(e,t){oe.set(e,t)}function Rs(e){oe.delete(e)}function bs(e){return oe.get(e)??null}function Is(e,t,n){const s=T.get(e)??new Map;s.set(t,n),T.set(e,s);const i=`${e}:${t}`;te.set(i,"ready"),Ze()}function Ts(e,t){const n=T.get(e);if(!n)return;n.delete(t),n.size===0&&T.delete(e);const s=`${e}:${t}`;te.set(s,"lost"),Ze()}function it(e,t){return T.get(e)?.get(t)??null}function rt(e,t){const n=it(e,t);if(!n)return null;const s=n.closest(".swiper-slide");if(s&&!s.classList.contains("swiper-slide-active"))return null;const i=n.getBoundingClientRect();return i.width<=0||i.height<=0?null:i}function Os(e){tt("stack",e)}function Ds(){nt("stack")}function ks(){return le("stack")}function vs(){return st("stack")}async function Ns(){return y(()=>Promise.resolve().then(()=>di),void 0,import.meta.url)}function Ps(){be.useEffect(()=>{Ns().then(({miniappRuntimeStore:e,activateApp:t})=>{const{activeAppId:n}=e.state;n&&t(n)})})}function Ms(e,t){return be.useSyncExternalStore(Ye,()=>V(e,t),()=>V(e,t))}const Cs={apps:new Map,visualConfig:De,activeAppId:null,focusedAppId:null,presentations:new Map,zOrderSeed:1,isStackViewOpen:!1,maxBackgroundApps:4};function at(e){const t=l.state.apps.get(e),n=t?.iframeRef;!t||!n||ee().attach(n,e,t.manifest.name,t.manifest.permissions??[])}function js(e,t,n){ee().attach(t,e,n.name,n.permissions??[])}const l=new Re(Cs);function ot(e){l.setState(t=>({...t,visualConfig:Nt(t.visualConfig,e)}))}function Us(e){ot({motion:{timeScale:e}})}function Ls(){l.setState(e=>({...e,visualConfig:De}))}const q=new Set;function E(e){q.forEach(t=>t(e))}let _e=0;function ct(e,t){return _e+=1,{id:`${e}:${t}:${Date.now()}:${_e}`,kind:e,status:"requested",startedAt:Date.now()}}function xs(e){const t=e.splashScreen;return t?typeof t=="object"&&typeof t.timeout=="number"?t.timeout:5e3:null}function Bs(e,t){if(!e||e==="preparing"){if(t==="launching")return"opening";if(t==="splash")return"splash";if(t==="active")return"opened"}return e==="launching"&&t==="splash"?"splash":(e==="launching"||e==="splash")&&t==="active"?"opened":e==="active"&&t==="background"?"backgrounding":e==="background"&&t==="active"?"foregrounding":t==="closing"?"closing":t==="preparing"?"closed":t==="launching"?"opening":t==="splash"?"splash":t==="active"?"opened":t==="background"?"backgrounded":"closed"}function O(e,t){l.setState(n=>{const s=n.apps.get(e);if(!s)return n;const i=Bs(s.state,t),r=new Map(n.apps);return r.set(e,{...s,state:t,flow:i}),{...n,apps:r}}),E({type:"app:state-change",appId:e,state:t})}function Hs(e,t){l.setState(n=>{const s=n.apps.get(e);if(!s||s.processStatus===t)return n;const i=new Map(n.apps);return i.set(e,{...s,processStatus:t}),{...n,apps:i}})}function Ks(e,t){l.setState(n=>{const s=n.apps.get(e);if(!s||s.readiness===t)return n;const i=new Map(n.apps);return i.set(e,{...s,readiness:t}),{...n,apps:i}})}function lt(e){Ks(e,"ready");const t=l.state.apps.get(e);t&&!t.manifest.splashScreen&&(t.state==="launching"||t.state==="splash")&&C(e)}function Vs(e){switch(e){case"opening":return"opened";case"backgrounding":return"backgrounded";case"foregrounding":return"opened";default:return e}}function qs(e){l.setState(t=>{const n=t.apps.get(e);if(!n)return t;const s=Vs(n.flow);if(s===n.flow)return t;const i=new Map(t.apps);return i.set(e,{...n,flow:s}),{...t,apps:i}})}const zs={launchToSplash:100},N=new Map,z=new Map,W=new Map,Ws=3e4,$s=2500,$=new Map;function R(e){const t=$.get(e);t&&(t.cancelled=!0,t.rafId!==null&&cancelAnimationFrame(t.rafId),$.delete(e))}function Fs(e){if(!e)return!1;const t=e.getBoundingClientRect();return t.width>0&&t.height>0}function Js(e){return!!e&&e.isConnected}function P(e){const t=z.get(e);t&&(clearTimeout(t),z.delete(e))}function de(e,t,n){l.setState(s=>{const r=s.presentations.get(e)??{appId:e,desktop:t,state:"hidden",zOrder:s.zOrderSeed,transitionId:null,transitionKind:null},a={...r,...n,appId:e,desktop:n.desktop??r.desktop},c=new Map(s.presentations);return c.set(e,a),{...s,presentations:c}})}function dt(e){l.setState(t=>{const n=t.presentations.get(e),s=t.zOrderSeed+1,i=new Map(t.presentations);return n&&i.set(e,{...n,zOrder:s}),{...t,activeAppId:e,focusedAppId:e,presentations:i,zOrderSeed:s}})}function Gs(e,t){const n=l.state.presentations.get(e);n&&(n.transitionKind!=="present"||n.transitionId!==t||de(e,n.desktop,{state:"presented",transitionId:null,transitionKind:null}))}function Xs(e,t){const n=l.state.presentations.get(e);n&&(n.transitionKind!=="dismiss"||n.transitionId!==t||M(e))}function ue(e){P(e),lt(e),C(e)}function U(e,t){R(e);const n=l.state.apps.get(e);n?.iframeRef&&Y(n.iframeRef),l.setState(s=>{const i=new Map(s.apps);i.delete(e);const r=new Map(s.presentations);return r.delete(e),{...s,apps:i,presentations:r,activeAppId:s.activeAppId===e?null:s.activeAppId,focusedAppId:s.focusedAppId===e?null:s.focusedAppId}}),ht.show({message:t,duration:2e3})}function Ys(e,t){if(O(e,"launching"),pe(e),t){const n=setTimeout(()=>{const s=l.state.apps.get(e);if(!s||s.state!=="launching")return;O(e,"splash"),P(e);const i=xs(s.manifest);i!==null&&z.set(e,setTimeout(()=>{const r=l.state.apps.get(e);r&&r.state==="splash"&&ue(e)},i))},zs.launchToSplash);N.set(e,[n]);return}N.set(e,[])}function Zs(e,t,n){R(e);const s={cancelled:!1,rafId:null};$.set(e,s);const i=performance.now(),r=()=>{if(s.cancelled)return;const a=l.state.apps.get(e);if(!a||a.state!=="preparing"){R(e);return}const c=Fs(ce(e)),u=!!rt(t,e),d=Js(a.iframeRef);if(c&&u&&d){R(e),Ys(e,n);return}if(performance.now()-i>$s){u?c?U(e,"启动失败：加载容器未就绪，请重试"):U(e,"启动失败：图标未就绪，请返回桌面重试"):U(e,"启动失败：请停留在目标桌面页后重试");return}s.rafId=requestAnimationFrame(r)};s.rafId=requestAnimationFrame(r)}function pe(e){const t=N.get(e);t&&(t.forEach(n=>clearTimeout(n)),N.delete(e))}function ut(e){const t=W.get(e);t&&(clearTimeout(t),W.delete(e))}function M(e){pe(e),ut(e),P(e),R(e),l.setState(t=>{const n=t.apps.get(e);if(!n)return t;n.iframeRef&&Y(n.iframeRef);const s=new Map(t.apps);s.delete(e);const i=new Map(t.presentations);return i.delete(e),{...t,apps:s,presentations:i,activeAppId:t.activeAppId===e?null:t.activeAppId,focusedAppId:t.focusedAppId===e?null:t.focusedAppId}}),l.state.apps.size===0&&ee().detach()}function pt(e){ue(e)}function gt(e,t,n){const i=l.state.apps.get(e);if(i){at(e);const d=i.manifest.targetDesktop??"stack";return de(e,d,{state:"presented",transitionId:null,transitionKind:null}),dt(e),C(e),i}const r=!!t.splashScreen,a={appId:e,manifest:t,state:"preparing",flow:"closed",ctx:{capsuleTheme:t.capsuleTheme??"auto"},processStatus:"loading",readiness:"notReady",launchedAt:Date.now(),lastActiveAt:Date.now(),iframeRef:null,iconRef:ce(e)};a.iframeRef=Mt(e,t.url,n),js(e,a.iframeRef,t),a.iframeRef.addEventListener("load",()=>{Hs(e,"loaded"),t.splashScreen||lt(e)}),Ct(a.iframeRef);const c=t.targetDesktop??"stack",u=ct("present",e);return l.setState(d=>{const p=d.zOrderSeed+1,h=new Map(d.apps);h.set(e,a);const S=new Map(d.presentations);return S.set(e,{appId:e,desktop:c,state:"presenting",zOrder:p,transitionId:u.id,transitionKind:"present"}),{...d,apps:h,presentations:S,activeAppId:e,focusedAppId:e,zOrderSeed:p}}),E({type:"app:launch",appId:e,manifest:t}),Zs(e,c,r),a}function Qs(e,t,n){return gt(e,t,n)}function C(e){const t=l.state,n=t.apps.get(e);n&&n.state!=="preparing"&&(t.activeAppId&&t.activeAppId!==e&&ft(t.activeAppId),n.iframeRef&&n.state==="background"&&Ut(n.iframeRef),O(e,"active"),at(e),l.setState(s=>{const i=new Map(s.apps),r=i.get(e);return r&&i.set(e,{...r,lastActiveAt:Date.now()}),{...s,apps:i,activeAppId:e,focusedAppId:e}}),E({type:"app:activate",appId:e}))}function ft(e){const t=l.state,n=t.apps.get(e);n&&n.state!=="preparing"&&(n.iframeRef&&jt(n.iframeRef),O(e,"background"),Lt(l.state.apps,l.state.activeAppId,t.maxBackgroundApps),E({type:"app:deactivate",appId:e}))}function ge(e){const n=l.state.apps.get(e);if(!n)return;pe(e),ut(e),R(e),O(e,"closing"),P(e);const s=n.manifest.targetDesktop??"stack",i=ct("dismiss",e);de(e,s,{state:"dismissing",transitionId:i.id,transitionKind:"dismiss"}),W.set(e,setTimeout(()=>{const r=l.state.presentations.get(e);r&&(r.transitionKind!=="dismiss"||r.transitionId!==i.id||M(e))},Ws)),E({type:"app:close",appId:e})}function ei(e){ge(e)}function ti(e,t){const s=l.state.apps.get(e);if(!s)return;const i={...s.ctx,...t};l.setState(r=>{const a=new Map(r.apps),c=a.get(e);return c&&a.set(e,{...c,ctx:i}),{...r,apps:a}}),E({type:"app:ctx-change",appId:e,ctx:i})}function ni(){l.state.apps.forEach((t,n)=>{ge(n),M(n)}),xt()}function si(){l.setState(e=>({...e,isStackViewOpen:!0})),E({type:"stack-view:open"})}function ii(){l.setState(e=>({...e,isStackViewOpen:!1})),E({type:"stack-view:close"})}function ri(e){return q.add(e),()=>q.delete(e)}function ai(){return Array.from(l.state.apps.values())}function oi(){const e=l.state;return e.activeAppId?e.apps.get(e.activeAppId)??null:null}function ci(){return l.state.apps.size>0}const li={getApps:e=>Array.from(e.apps.values()),getVisualConfig:e=>e.visualConfig,getActiveApp:e=>e.activeAppId?e.apps.get(e.activeAppId)??null:null,getFocusedAppId:e=>e.focusedAppId??e.activeAppId,getFocusedApp:e=>{const t=e.focusedAppId??e.activeAppId;return t?e.apps.get(t)??null:null},getPresentations:e=>Array.from(e.presentations.values()).sort((t,n)=>t.zOrder-n.zOrder),getPresentation:(e,t)=>e.presentations.get(t)??null,hasPresentations:e=>e.presentations.size>0,hasRunningApps:e=>e.apps.size>0,hasRunningStackApps:e=>Array.from(e.apps.values()).some(t=>(t.manifest.targetDesktop??"stack")==="stack"),isStackViewOpen:e=>e.isStackViewOpen,getBackgroundApps:e=>Array.from(e.apps.values()).filter(t=>t.state==="background"),isLaunchOverlayVisible:e=>{const t=e.focusedAppId??e.activeAppId?e.apps.get(e.focusedAppId??e.activeAppId):null;return t?.state==="launching"||t?.state==="splash"},isShowingSplash:e=>(e.focusedAppId??e.activeAppId?e.apps.get(e.focusedAppId??e.activeAppId):null)?.state==="splash",isAnimating:e=>{const t=e.focusedAppId??e.activeAppId?e.apps.get(e.focusedAppId??e.activeAppId):null;return t?.state==="launching"||t?.state==="splash"||t?.state==="closing"}},di=Object.freeze(Object.defineProperty({__proto__:null,activateApp:C,closeAllApps:ni,closeApp:ge,closeStackView:ii,deactivateApp:ft,didDismiss:Xs,didPresent:Gs,dismissSplash:pt,finalizeCloseApp:M,getActiveApp:oi,getDesktopAppSlotRect:rt,getDesktopAppSlotRef:it,getDesktopContainerRef:le,getDesktopGridHostRef:bs,getDesktopRect:st,getIconInnerRef:us,getIconRef:ce,getRunningApps:ai,getSlotStatus:V,getSplashBgRef:fs,getSplashIconRef:ws,getStackContainerRef:ks,getStackRect:vs,getWindowInnerRef:ys,getWindowRef:Es,hasRunningApps:ci,launchApp:gt,miniappRuntimeSelectors:li,miniappRuntimeStore:l,openStackView:si,registerDesktopAppSlotRef:Is,registerDesktopContainerRef:tt,registerDesktopGridHostRef:_s,registerIconInnerRef:ls,registerIconRef:cs,registerSplashBgRef:ps,registerSplashIconRef:hs,registerStackContainerRef:Os,registerWindowInnerRef:Ss,registerWindowRef:As,requestDismiss:ei,requestDismissSplash:ue,requestFocus:dt,requestPresent:Qs,resetMiniappVisualConfig:Ls,setMiniappMotionTimeScale:Us,setMiniappVisualConfig:ot,settleFlow:qs,subscribe:ri,subscribeSlotStatus:Ye,unregisterDesktopAppSlotRef:Ts,unregisterDesktopContainerRef:nt,unregisterDesktopGridHostRef:Rs,unregisterIconRef:ds,unregisterSplashBgRef:gs,unregisterSplashIconRef:ms,unregisterStackContainerRef:Ds,updateAppContext:ti,useMiniappVisibilityRestore:Ps,useSlotStatus:Ms},Symbol.toStringTag,{value:"Module"}));export{bi as $,ue as A,Xs as B,_s as C,De as D,Rs as E,Is as F,Ts as G,qt as H,Me as I,vi as J,ns as K,ss as L,os as M,ee as N,Ii as O,Ti as P,Oi as Q,Di as R,ki as S,ts as T,Ni as U,Mi as V,Ci as W,ji as X,Pi as Y,Ui as Z,Ri as _,_i as a,li as b,ni as c,l as d,f as e,tt as f,yi as g,nt as h,cs as i,ls as j,ds as k,gt as l,Nt as m,Os as n,si as o,Ds as p,Ms as q,Ls as r,Us as s,it as t,Ps as u,Gs as v,qs as w,As as x,Ss as y,ei as z};
