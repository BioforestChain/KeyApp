const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./web-D5lGaPXc.js","./chain-config-BqHvYoiy.js","./preload-helper-PPVm8Dsz.js","./index-D0E7N0oa.js","./bioforest-D91I-84E.js","./schemas-BX8BzOgD.js","./iframe-13xkpxxJ.js","./iframe-COlAjlj5.css","./address-format-Bt4Tl7ZW.js","./breakpoint-wIg8UP9C.js"])))=>i.map(i=>d[i]);
import{t as st}from"./web-D5lGaPXc.js";import{_ as de}from"./preload-helper-PPVm8Dsz.js";import{S as pe,r as ge}from"./iframe-13xkpxxJ.js";import{A as it}from"./amount-BQsqQYGO.js";import{g as rt,d as O,c as at,h as ot,w as ct}from"./chain-config-BqHvYoiy.js";import{g as fe}from"./index-CzZ58Kr6.js";import{h as lt,c as ut,p as dt}from"./bioforest-D91I-84E.js";import"./index-D0E7N0oa.js";import{p as pt,g as gt,t as ft,E as ht}from"./index-Ddwf1R_9.js";const he={motion:{timeScale:1,layoutDuration:.45,uiFastDuration:.15,layoutEase:[.4,0,.1,1],spring:{stiffness:220,damping:28,mass:.85}},css:{}};function B(e){return!Number.isFinite(e)||e<=0?1:e}function _(e,t){const n=B(t);return e/n}function re(e,t,n){const s=B(t);return e*Math.pow(s,n)}function mt(e,t){return t?{motion:{...e.motion,...t.motion,spring:{...e.motion.spring,...t.motion?.spring}},css:{...e.css,...t.css}}:e}const ae=new WeakMap,oe=new WeakMap;function Js(e){const t=ae.get(e);if(t)return t;const{motion:n}=e,s={type:"spring",stiffness:re(n.spring.stiffness,n.timeScale,2),damping:re(n.spring.damping,n.timeScale,1),mass:n.spring.mass},r={layout:{duration:_(n.layoutDuration,n.timeScale),ease:n.layoutEase}},o={duration:_(n.uiFastDuration,n.timeScale),ease:"easeOut"},l={motionConfig:s,sharedLayout:r,uiFast:o};return ae.set(e,l),l}function Ks(e){const t=oe.get(e);if(t)return t;const{motion:n}=e,s={"--miniapp-motion-time-scale":String(B(n.timeScale)),"--miniapp-motion-layout-duration":`${_(n.layoutDuration,n.timeScale)}s`,"--miniapp-motion-ui-fast-duration":`${_(n.uiFastDuration,n.timeScale)}s`,"--miniapp-motion-layout-ease":`cubic-bezier(${n.layoutEase.join(",")})`};return oe.set(e,s),s}const wt=4,V="miniapp-iframe-container",me="miniapp-hidden-container";function W(e,t){let n=document.getElementById(e);return n||(n=document.createElement("div"),n.id=e,t&&(n.style.cssText=`
        position: fixed;
        top: -9999px;
        left: -9999px;
        width: 1px;
        height: 1px;
        overflow: hidden;
        visibility: hidden;
        pointer-events: none;
      `),document.body.appendChild(n)),n}function At(e,t,n){const s=document.createElement("iframe");s.id=`miniapp-iframe-${e}`,s.dataset.appId=e;const i=new URL(t,window.location.origin);return n&&Object.entries(n).forEach(([r,o])=>{i.searchParams.set(r,o)}),s.src=i.toString(),s.sandbox.add("allow-scripts","allow-forms","allow-same-origin"),s.style.cssText=`
    width: 100%;
    height: 100%;
    border: none;
    background: transparent;
  `,s}function St(e){W(V,!1).appendChild(e)}function bt(e){W(me,!0).appendChild(e)}function Rt(e){W(V,!1).appendChild(e)}function x(e){e.src="about:blank",e.remove()}function Et(e,t,n=wt){const s=[],i=Array.from(e.values()).filter(r=>r.appId!==t&&r.state==="background").toSorted((r,o)=>r.lastActiveAt-o.lastActiveAt);for(;i.length>n;){const r=i.shift();r?.iframeRef&&(x(r.iframeRef),r.iframeRef=null,s.push(r.appId))}return s}function _t(){const e=document.getElementById(V),t=document.getElementById(me);e&&(e.innerHTML="",e.remove()),t&&(t.innerHTML="",t.remove())}const Fs={bio_requestAccounts:{id:"bio_requestAccounts",name:"请求账户",description:"获取您的钱包地址列表",risk:"low"},bio_selectAccount:{id:"bio_selectAccount",name:"选择账户",description:"让您选择一个账户",risk:"low"},bio_pickWallet:{id:"bio_pickWallet",name:"选择钱包",description:"让您选择一个钱包",risk:"low"},bio_createTransaction:{id:"bio_createTransaction",name:"创建交易",description:"构造未签名交易（不做签名/不做广播）",risk:"low"},bio_signMessage:{id:"bio_signMessage",name:"签名消息",description:"使用您的私钥签名消息（需要您确认）",risk:"medium"},bio_signTypedData:{id:"bio_signTypedData",name:"签名数据",description:"签名结构化数据（需要您确认）",risk:"medium"},bio_signTransaction:{id:"bio_signTransaction",name:"签名交易",description:"对未签名交易进行签名（需要您确认）",risk:"high"},bio_sendTransaction:{id:"bio_sendTransaction",name:"发送交易",description:"请求发送转账（需要您确认）",risk:"high"},bio_destroyAsset:{id:"bio_destroyAsset",name:"销毁资产",description:"请求销毁资产（需要您确认，不可撤销）",risk:"high"}},a={USER_REJECTED:4001,UNAUTHORIZED:4100,UNSUPPORTED_METHOD:4200,INTERNAL_ERROR:-32603,INVALID_PARAMS:-32602,METHOD_NOT_FOUND:-32601};function ce(e,t,n,s){return{type:"bio_response",id:e,success:!1,error:{code:t,message:n,data:s}}}const we="ecosystem_my_apps",yt={teleport:"xin.dweb.teleport",forge:"xin.dweb.forge"};function S(e){return yt[e]??e}function le(){try{const e=localStorage.getItem(we),t=e?JSON.parse(e):[],n=t.map(s=>({...s,appId:S(s.appId)}));return JSON.stringify(t)!==JSON.stringify(n)&&Ae(n),n}catch{return[]}}function Ae(e){localStorage.setItem(we,JSON.stringify(e))}const M=["discover","mine"],Se="ecosystem_store";function Tt(){try{const e=localStorage.getItem(Se);if(e){const t=JSON.parse(e),n=Array.isArray(t.availableSubPages)&&t.availableSubPages.length>0?t.availableSubPages:M,s=t.activeSubPage??"discover",i=n.includes(s)?n:[...n,s];return{permissions:t.permissions??[],sources:t.sources??[{url:"./miniapps/ecosystem.json",name:"Bio 官方生态",lastUpdated:new Date().toISOString(),enabled:!0}],myApps:le(),availableSubPages:i,activeSubPage:s,swiperProgress:0,syncSource:null}}}catch{}return{permissions:[],sources:[{url:"./miniapps/ecosystem.json",name:"Bio 官方生态",lastUpdated:new Date().toISOString(),enabled:!0}],myApps:le(),availableSubPages:M,activeSubPage:"discover",swiperProgress:0,syncSource:null}}function It(e){try{localStorage.setItem(Se,JSON.stringify({permissions:e.permissions,sources:e.sources,availableSubPages:e.availableSubPages,activeSubPage:e.activeSubPage})),Ae(e.myApps)}catch{}}const d=new pe(Tt());d.subscribe(()=>{It(d.state)});const be={getGrantedPermissions:(e,t)=>e.permissions.find(n=>n.appId===t)?.granted??[],hasPermission:(e,t,n)=>be.getGrantedPermissions(e,t).includes(n),getEnabledSources:e=>e.sources.filter(t=>t.enabled),isAppInstalled:(e,t)=>{const n=S(t);return e.myApps.some(s=>s.appId===n)}},Dt={installApp:e=>{d.setState(t=>{const n=S(e);return t.myApps.some(s=>s.appId===n)?t:{...t,myApps:[{appId:n,installedAt:Date.now(),lastUsedAt:Date.now()},...t.myApps]}})},uninstallApp:e=>{d.setState(t=>{const n=S(e);return{...t,myApps:t.myApps.filter(s=>s.appId!==n)}})},updateAppLastUsed:e=>{d.setState(t=>{const n=S(e);return t.myApps.find(i=>i.appId===n)?{...t,myApps:t.myApps.map(i=>i.appId===n?{...i,lastUsedAt:Date.now()}:i)}:t})},grantPermissions:(e,t)=>{d.setState(n=>{const s=n.permissions.find(i=>i.appId===e);if(s){const i=[...new Set([...s.granted,...t])];return{...n,permissions:n.permissions.map(r=>r.appId===e?{...r,granted:i,grantedAt:Date.now()}:r)}}else return{...n,permissions:[...n.permissions,{appId:e,granted:t,grantedAt:Date.now()}]}})},revokePermissions:(e,t)=>{d.setState(n=>t?{...n,permissions:n.permissions.map(s=>s.appId===e?{...s,granted:s.granted.filter(i=>!t.includes(i))}:s)}:{...n,permissions:n.permissions.filter(s=>s.appId!==e)})},addSource:(e,t)=>{d.setState(n=>n.sources.some(s=>s.url===e)?n:{...n,sources:[...n.sources,{url:e,name:t,lastUpdated:new Date().toISOString(),enabled:!0}]})},removeSource:e=>{d.setState(t=>({...t,sources:t.sources.filter(n=>n.url!==e)}))},toggleSource:e=>{d.setState(t=>({...t,sources:t.sources.map(n=>n.url===e?{...n,enabled:!n.enabled}:n)}))},updateSourceTimestamp:e=>{d.setState(t=>({...t,sources:t.sources.map(n=>n.url===e?{...n,lastUpdated:new Date().toISOString()}:n)}))},setActiveSubPage:e=>{d.setState(t=>({...t,activeSubPage:e}))},setAvailableSubPages:e=>{d.setState(t=>{const n=e.length>0?e:M,s=n.includes(t.activeSubPage)?t.activeSubPage:n[0]??"mine";return{...t,availableSubPages:n,activeSubPage:s}})},setSwiperProgress:e=>{d.setState(t=>({...t,swiperProgress:e}))},setSyncSource:e=>{d.setState(t=>({...t,syncSource:e}))}},vt=["bio_requestAccounts","bio_signMessage","bio_signTypedData","bio_signTransaction","bio_sendTransaction"];function Re(e){return vt.includes(e)}function kt(e,t){return Re(t)?be.hasPermission(d.state,e,t):!0}function Ot(e,t){Dt.grantPermissions(e,t)}class Pt{handlers=new Map;iframe=null;appId="";appName="";origin="*";manifestPermissions=[];messageHandler=null;permissionRequestCallback=null;registerHandler(t,n){this.handlers.set(t,n)}setPermissionRequestCallback(t){this.permissionRequestCallback=t}attach(t,n,s,i=[]){this.detach(),this.iframe=t,this.appId=n,this.appName=s,this.manifestPermissions=i;try{const r=new URL(t.src,window.location.origin);this.origin=r.origin}catch{this.origin="*"}this.messageHandler=this.handleMessage.bind(this),window.addEventListener("message",this.messageHandler),console.log("[BioProvider] Attached to iframe:",n)}detach(){this.messageHandler&&(window.removeEventListener("message",this.messageHandler),this.messageHandler=null),this.iframe=null,this.appId="",this.appName="",this.manifestPermissions=[]}emit(t,...n){this.emitTo("bio",t,...n)}emitEth(t,...n){this.emitTo("eth",t,...n)}emitTron(t,...n){this.emitTo("tron",t,...n)}emitTo(t,n,...s){if(!this.iframe?.contentWindow)return;const i={type:`${t}_event`,event:n,args:s};this.iframe.contentWindow.postMessage(i,this.origin)}handleMessage(t){if(this.origin!=="*"&&t.origin!==this.origin||t.source!==this.iframe?.contentWindow)return;const n=t.data;!n||typeof n!="object"||!("type"in n)||(n.type==="bio_request"?this.processRequest(n,"bio"):n.type==="eth_request"?this.processRequest(n,"eth"):n.type==="tron_request"&&this.processRequest(n,"tron"))}async processRequest(t,n){const{id:s,method:i,params:r}=t;console.log(`[BioProvider] ${n.toUpperCase()} Request:`,i,r);const o=this.handlers.get(i);if(!o){this.sendResponse(n,{type:`${n}_response`,id:s,success:!1,error:{code:a.METHOD_NOT_FOUND,message:`Method not found: ${i}`}});return}if(!(n!=="bio"||["bio_connect","bio_closeSplashScreen"].includes(i))){const p=["bio_accounts","bio_selectAccount","bio_pickWallet"].includes(i)&&this.manifestPermissions.includes("bio_requestAccounts"),h=p?"bio_requestAccounts":i;if(!(this.manifestPermissions.includes(i)||i==="bio_requestAccounts"||p)){this.sendResponse(n,ce(s,a.UNAUTHORIZED,`Permission not declared in manifest: ${i}`));return}if(Re(h)&&!kt(this.appId,h)&&!await this.requestPermission([h])){this.sendResponse(n,ce(s,a.USER_REJECTED,"Permission denied by user"));return}}try{const g=c.state.apps.get(this.appId)?.manifest.icon,p={appId:this.appId,appName:this.appName,appIcon:g,origin:this.origin,permissions:this.manifestPermissions},h=await o(r?.[0],p);this.sendResponse(n,{type:`${n}_response`,id:s,success:!0,result:h})}catch(g){const p=g instanceof Error?g.message:"Unknown error",h=g.code??a.INTERNAL_ERROR;this.sendResponse(n,{type:`${n}_response`,id:s,success:!1,error:{code:h,message:p}})}}async requestPermission(t){if(!this.permissionRequestCallback)return console.warn("[BioProvider] No permission request callback set"),!1;try{const n=await this.permissionRequestCallback(this.appId,this.appName,t);return n&&Ot(this.appId,t),n}catch(n){return console.error("[BioProvider] Permission request failed:",n),!1}}sendResponse(t,n){this.iframe?.contentWindow&&(console.log(`[BioProvider] ${t.toUpperCase()} Response:`,n),this.iframe.contentWindow.postMessage(n,this.origin))}}const u=new Pt,w=new Map,f={register(e,t){w.set(e,t),console.log("[HandlerContext] Registered callbacks for:",e)},unregister(e){w.delete(e),console.log("[HandlerContext] Unregistered callbacks for:",e)},get(e){return w.get(e)},has(e){return w.has(e)},getRegisteredApps(){return Array.from(w.keys())},clear(){w.clear()}},Mt=async(e,t)=>{et(t.appId)};let Ee=null,_e=null;function Gs(e){Ee=e}function Ys(e){_e=e}function $(e){return f.get(e)?.showWalletPicker??Ee}function Ct(e){return f.get(e)?.getConnectedAccounts??_e}const Nt=async(e,t)=>({connected:!0}),jt=async(e,t)=>{const n=$(t.appId);if(!n)throw Object.assign(new Error("Wallet picker not available"),{code:a.INTERNAL_ERROR});const s=await n();if(!s)throw Object.assign(new Error("User rejected"),{code:a.USER_REJECTED});return[s]},Ut=async(e,t)=>{const n=Ct(t.appId);return n?n():[]},Lt=async(e,t)=>{const n=$(t.appId);if(!n)throw Object.assign(new Error("Wallet picker not available"),{code:a.INTERNAL_ERROR});const i=await n(e);if(!i)throw Object.assign(new Error("User rejected"),{code:a.USER_REJECTED});return i},Ht=async(e,t)=>{const n=$(t.appId);if(!n)throw Object.assign(new Error("Wallet picker not available"),{code:a.INTERNAL_ERROR});const i=await n(e);if(!i)throw Object.assign(new Error("User rejected"),{code:a.USER_REJECTED});return i},qt=async(e,t)=>"bfmeta",Bt=async(e,t)=>{const n=e;if(!n?.address||!n?.chain)throw Object.assign(new Error("Missing address or chain"),{code:a.INVALID_PARAMS});return"0"};let ye=null;function Zs(e){ye=e}function Te(e){return f.get(e)?.showSigningDialog??ye}const Vt=async(e,t)=>{const n=e;if(!n?.message||!n?.address)throw Object.assign(new Error("Missing message or address"),{code:a.INVALID_PARAMS});const s=Te(t.appId);if(!s)throw Object.assign(new Error("Signing dialog not available"),{code:a.INTERNAL_ERROR});const i=await s({message:n.message,address:n.address,app:{name:t.appName}});if(!i)throw Object.assign(new Error("User rejected"),{code:a.USER_REJECTED});return i},Wt=async(e,t)=>{const n=e;if(!n?.data||!n?.address)throw Object.assign(new Error("Missing data or address"),{code:a.INVALID_PARAMS});const s=Te(t.appId);if(!s)throw Object.assign(new Error("Signing dialog not available"),{code:a.INTERNAL_ERROR});const i=JSON.stringify(n.data,null,2),r=await s({message:i,address:n.address,app:{name:t.appName}});if(!r)throw Object.assign(new Error("User rejected"),{code:a.USER_REJECTED});return r};let Ie=null;function Qs(e){Ie=e}function xt(e){return f.get(e)?.showTransferDialog??Ie}const $t=async(e,t)=>{const n=e;if(!n?.from||!n?.to||!n?.amount||!n?.chain)throw Object.assign(new Error("Missing required parameters: from, to, amount, chain"),{code:a.INVALID_PARAMS});const s=xt(t.appId);if(!s)throw Object.assign(new Error("Transfer dialog not available"),{code:a.INTERNAL_ERROR});const i={from:n.from,to:n.to,amount:n.amount,chain:n.chain,app:{name:t.appName}};n.asset&&(i.asset=n.asset);const r=await s(i);if(!r)throw Object.assign(new Error("User rejected"),{code:a.USER_REJECTED});return r};let zt=null;function Jt(e){return f.get(e)?.showDestroyDialog??zt}const Kt=async(e,t)=>{const n=e;if(!n?.from||!n?.amount||!n?.chain||!n?.asset)throw Object.assign(new Error("Missing required parameters: from, amount, chain, asset"),{code:a.INVALID_PARAMS});const s=Jt(t.appId);if(!s)throw Object.assign(new Error("Destroy dialog not available"),{code:a.INTERNAL_ERROR});const i={from:n.from,amount:n.amount,chain:n.chain,asset:n.asset,app:{name:t.appName}},r=await s(i);if(!r)throw Object.assign(new Error("User rejected"),{code:a.USER_REJECTED});return r};function Ft(e,t){const n=ct.state.wallets,s=t.startsWith("0x"),i=s?t.toLowerCase():t;for(const r of n)if(r.chainAddresses.find(l=>l.chain!==e?!1:s||l.address.startsWith("0x")?l.address.toLowerCase()===i:l.address===i))return r.id;return null}async function De(e){if(O.state.snapshot||await at.initialize(),!O.state.snapshot)throw Object.assign(new Error("Chain configs not initialized"),{code:a.INTERNAL_ERROR});const n=ot.getChainById(O.state,e);if(!n)throw Object.assign(new Error(`Unsupported chain: ${e}`),{code:a.INVALID_PARAMS});return n}const Gt=async(e,t)=>{const n=e;if(!n?.from||!n?.to||!n?.amount||!n?.chain)throw Object.assign(new Error("Missing required parameters: from, to, amount, chain"),{code:a.INVALID_PARAMS});if(!Ft(n.chain,n.from))throw Object.assign(new Error("From address is not owned by current user"),{code:a.UNAUTHORIZED});const i=await De(n.chain),r=it.parse(n.amount,i.decimals,i.symbol),o=fe(i.id);if(!o.supportsBuildTransaction)throw Object.assign(new Error(`Chain ${i.id} does not support transaction building`),{code:a.UNSUPPORTED_METHOD});const l=await o.buildTransaction({from:n.from,to:n.to,amount:r});return{chainId:l.chainId,data:l.data}};let ve=null;function Xs(e){ve=e}function Yt(e){return f.get(e)?.showSignTransactionDialog??ve}const Zt=async(e,t)=>{const n=e;if(!n?.from||!n?.chain||!n?.unsignedTx)throw Object.assign(new Error("Missing required parameters: from, chain, unsignedTx"),{code:a.INVALID_PARAMS});const s=Yt(t.appId);if(!s)throw Object.assign(new Error("SignTransaction dialog not available"),{code:a.INTERNAL_ERROR});const i=await s({from:n.from,chain:n.chain,unsignedTx:n.unsignedTx,app:{name:t.appName}});if(!i)throw Object.assign(new Error("User rejected"),{code:a.USER_REJECTED});return i};async function ei(e){const t=await De(e.chainId),n=fe(t.id);if(!n.supportsSignTransaction)throw Object.assign(new Error(`Chain ${t.id} does not support transaction signing`),{code:a.UNSUPPORTED_METHOD});const s=await(await de(async()=>{const{walletStorageService:o}=await import("./web-D5lGaPXc.js").then(l=>l.i);return{walletStorageService:o}},__vite__mapDeps([0,1,2,3,4,5,6,7,8,9]),import.meta.url)).walletStorageService.getMnemonic(e.walletId,e.password);let i;if(t.chainKind==="evm"){const o=rt(s,"ethereum",0,0);if(o.address.toLowerCase()!==e.from.toLowerCase())throw Object.assign(new Error("Signing address mismatch"),{code:a.INVALID_PARAMS});i=lt(o.privateKey)}else if(t.chainKind==="bioforest"){const o=ut(s);if(dt(o.publicKey,t.prefix??"b")!==e.from)throw Object.assign(new Error("Signing address mismatch"),{code:a.INVALID_PARAMS});i=o.secretKey}else throw Object.assign(new Error(`Unsupported chain kind: ${t.chainKind}`),{code:a.UNSUPPORTED_METHOD});const r=await n.signTransaction({chainId:e.unsignedTx.chainId,data:e.unsignedTx.data},i);return{chainId:r.chainId,data:r.data,signature:r.signature}}const ke=new Map,Oe=new Map;let Pe=null,C=null,Me=null,Ce=null;function ti(e){Pe=e}function ni(e){C=e}function si(e){Me=e}function ii(e){Ce=e}function Qt(e){return f.get(e)?.showEvmWalletPicker??Pe}function Ne(e){return f.get(e)?.showEvmSigningDialog??Me}function Xt(e){return f.get(e)?.showEvmTransactionDialog??Ce}function E(e){return ke.get(e)??ft(ht.binance)}function en(e,t){ke.set(e,t)}function tn(e){return Oe.get(e)??[]}function nn(e,t){Oe.set(e,t)}const sn=async(e,t)=>E(t.appId),rn=async(e,t)=>{const n=Qt(t.appId);if(!n)throw Object.assign(new Error("Wallet picker not available"),{code:a.INTERNAL_ERROR});const s=E(t.appId),i=await n({chainId:s,app:{name:t.appName,icon:t.appIcon}});if(!i)throw Object.assign(new Error("User rejected"),{code:a.USER_REJECTED});const r=[i.address];return nn(t.appId,r),r},an=async(e,t)=>tn(t.appId),on=async(e,t)=>{const n=e;if(!n?.chainId)throw Object.assign(new Error("Missing chainId"),{code:a.INVALID_PARAMS});const s=n.chainId;if(!gt(s))throw Object.assign(new Error(`Chain ${s} not supported`),{code:4902});const r=E(t.appId);if(r===s)return null;if(C&&!await C({fromChainId:r,toChainId:s,appName:t.appName,appIcon:t.appIcon}))throw Object.assign(new Error("User rejected"),{code:a.USER_REJECTED});return en(t.appId,s),null},cn=async(e,t)=>{throw Object.assign(new Error("Adding custom chains is not supported"),{code:a.UNSUPPORTED_METHOD})},je=async(e,t)=>{const[n,s]=e;if(!n||!s)throw Object.assign(new Error("Missing message or address"),{code:a.INVALID_PARAMS});const i=Ne(t.appId);if(!i)throw Object.assign(new Error("Signing dialog not available"),{code:a.INTERNAL_ERROR});const r=await i({message:n,address:s,appName:t.appName});if(!r)throw Object.assign(new Error("User rejected"),{code:a.USER_REJECTED});return r.signature},ln=async(e,t)=>{const[n,s]=e;return je([s,n],t)},un=async(e,t)=>{const[n,s]=e;if(!n||!s)throw Object.assign(new Error("Missing address or typedData"),{code:a.INVALID_PARAMS});const i=typeof s=="string"?JSON.parse(s):s,r=Ne(t.appId);if(!r)throw Object.assign(new Error("Signing dialog not available"),{code:a.INTERNAL_ERROR});const o=JSON.stringify(i,null,2),l=await r({message:o,address:n,appName:t.appName});if(!l)throw Object.assign(new Error("User rejected"),{code:a.USER_REJECTED});return l.signature},dn=async(e,t)=>{const n=e;if(!n?.from)throw Object.assign(new Error("Missing transaction data"),{code:a.INVALID_PARAMS});const s=Xt(t.appId);if(!s)throw Object.assign(new Error("Transaction dialog not available"),{code:a.INTERNAL_ERROR});n.chainId||(n.chainId=E(t.appId));const i=await s({tx:n,appName:t.appName});if(!i)throw Object.assign(new Error("User rejected"),{code:a.USER_REJECTED});return i.txHash},pn=async(e,t)=>{throw e?.from?Object.assign(new Error("eth_signTransaction not yet supported, use eth_sendTransaction"),{code:a.UNSUPPORTED_METHOD}):Object.assign(new Error("Missing transaction data"),{code:a.INVALID_PARAMS})},gn=async(e,t)=>{const[n,s]=e;if(!n)throw Object.assign(new Error("Missing address"),{code:a.INVALID_PARAMS});return"0x0"},fn=async(e,t)=>{const n=E(t.appId),s=pt(n);return String(s)},hn=async(e,t)=>"0x0",mn=async(e,t)=>"KeyApp/1.0.0",wn={eth_chainId:sn,eth_requestAccounts:rn,eth_accounts:an,wallet_switchEthereumChain:on,wallet_addEthereumChain:cn,personal_sign:je,eth_sign:ln,eth_signTypedData_v4:un,eth_sendTransaction:dn,eth_signTransaction:pn,eth_getBalance:gn,net_version:fn,eth_blockNumber:hn,web3_clientVersion:mn};function An(e){for(const[t,n]of Object.entries(wn))e(t,n)}const Ue=new Map;let Le=null,Sn=null;function ri(e){Le=e}function bn(e){return f.get(e)?.showTronWalletPicker??Le}function Rn(e){return f.get(e)?.showTronSigningDialog??Sn}function He(e){return Ue.get(e)??null}function En(e,t){Ue.set(e,t)}function _n(e){return{base58:e.address,hex:e.address}}const yn=async(e,t)=>{const n=bn(t.appId);if(!n)throw Object.assign(new Error("Wallet picker not available"),{code:a.INTERNAL_ERROR});const s=await n({app:{name:t.appName,icon:t.appIcon}});if(!s)throw Object.assign(new Error("User rejected"),{code:a.USER_REJECTED});const i=_n(s);return En(t.appId,i),{code:200,message:"ok",data:i}},Tn=async(e,t)=>{const n=He(t.appId);return n?{code:200,message:"ok",data:n}:{code:4e3,message:"Not connected",data:null}},In=async(e,t)=>He(t.appId),Dn=async(e,t)=>{const n=e;if(!n?.txID)throw Object.assign(new Error("Invalid transaction"),{code:a.INVALID_PARAMS});const s=Rn(t.appId);if(!s)throw Object.assign(new Error("Signing dialog not available"),{code:a.INTERNAL_ERROR});const i=await s({transaction:n,appName:t.appName});if(!i)throw Object.assign(new Error("User rejected"),{code:a.USER_REJECTED});return i.signedTransaction},vn=async(e,t)=>{const n=e;if(!n?.txID||!n.signature)throw Object.assign(new Error("Invalid signed transaction"),{code:a.INVALID_PARAMS});return{result:!0,txid:n.txID}},kn=async(e,t)=>{if(!e)throw Object.assign(new Error("Missing address"),{code:a.INVALID_PARAMS});return 0},On=async(e,t)=>{const n=e;if(!n)throw Object.assign(new Error("Missing address"),{code:a.INVALID_PARAMS});return{address:n,balance:0}},Pn={tron_requestAccounts:yn,tron_accounts:Tn,tron_getDefaultAddress:In,tron_signTransaction:Dn,tron_sendRawTransaction:vn,tron_getBalance:kn,tron_getAccount:On};function Mn(e){for(const[t,n]of Object.entries(Pn))e(t,n)}function ai(){u.registerHandler("bio_connect",Nt),u.registerHandler("bio_closeSplashScreen",Mt),u.registerHandler("bio_requestAccounts",jt),u.registerHandler("bio_accounts",Ut),u.registerHandler("bio_selectAccount",Lt),u.registerHandler("bio_pickWallet",Ht),u.registerHandler("bio_chainId",qt),u.registerHandler("bio_getBalance",Bt),u.registerHandler("bio_signMessage",Vt),u.registerHandler("bio_signTypedData",Wt),u.registerHandler("bio_createTransaction",Gt),u.registerHandler("bio_signTransaction",Zt),u.registerHandler("bio_sendTransaction",$t),u.registerHandler("bio_destroyAsset",Kt),An((e,t)=>u.registerHandler(e,t)),Mn((e,t)=>u.registerHandler(e,t)),console.log("[BioProvider] Initialized with handlers:",{bio:["bio_connect","bio_closeSplashScreen","bio_requestAccounts","bio_accounts","bio_selectAccount","bio_pickWallet","bio_chainId","bio_getBalance","bio_signMessage","bio_signTypedData","bio_createTransaction","bio_signTransaction","bio_sendTransaction","bio_destroyAsset"],evm:["eth_chainId","eth_requestAccounts","eth_accounts","wallet_switchEthereumChain","personal_sign","eth_sendTransaction"],tron:["tron_requestAccounts","tron_accounts","tron_signTransaction"]})}function z(){return u}const J=new Map,N=new Set;function j(e,t){const n=`${e}:${t}`;return J.get(n)??null}function qe(e){return N.add(e),()=>N.delete(e)}function Be(){N.forEach(e=>e())}const K=new Map,F=new Map,G=new Map,Y=new Map;let Ve=null,We=null;const Z=new Map,Q=new Map,b=new Map;function Cn(e,t){K.set(e,t)}function Nn(e,t){F.set(e,t)}function jn(e){K.delete(e),F.delete(e)}function X(e){return K.get(e)??null}function Un(e){return F.get(e)??null}function Ln(e,t){G.set(e,t)}function Hn(e){G.delete(e)}function qn(e){return G.get(e)??null}function Bn(e,t){Y.set(e,t)}function Vn(e){Y.delete(e)}function Wn(e){return Y.get(e)??null}function xn(e){Ve=e}function $n(){return Ve}function zn(e){We=e}function Jn(){return We}function xe(e,t){Z.set(e,t)}function $e(e){Z.delete(e)}function ee(e){return Z.get(e)??null}function ze(e){const t=ee(e);if(!t)return null;const n=t.closest(".swiper-slide");if(n&&!n.classList.contains("swiper-slide-active"))return null;const s=t.getBoundingClientRect();return s.width<=0||s.height<=0?null:s}function Kn(e,t){Q.set(e,t)}function Fn(e){Q.delete(e)}function Gn(e){return Q.get(e)??null}function Yn(e,t,n){const s=b.get(e)??new Map;s.set(t,n),b.set(e,s);const i=`${e}:${t}`;J.set(i,"ready"),Be()}function Zn(e,t){const n=b.get(e);if(!n)return;n.delete(t),n.size===0&&b.delete(e);const s=`${e}:${t}`;J.set(s,"lost"),Be()}function Je(e,t){return b.get(e)?.get(t)??null}function Ke(e,t){const n=Je(e,t);if(!n)return null;const s=n.closest(".swiper-slide");if(s&&!s.classList.contains("swiper-slide-active"))return null;const i=n.getBoundingClientRect();return i.width<=0||i.height<=0?null:i}function Qn(e){xe("stack",e)}function Xn(){$e("stack")}function es(){return ee("stack")}function ts(){return ze("stack")}async function ns(){return de(()=>Promise.resolve().then(()=>js),void 0,import.meta.url)}function ss(){ge.useEffect(()=>{ns().then(({miniappRuntimeStore:e,activateApp:t})=>{const{activeAppId:n}=e.state;n&&t(n)})})}function is(e,t){return ge.useSyncExternalStore(qe,()=>j(e,t),()=>j(e,t))}const rs={apps:new Map,visualConfig:he,activeAppId:null,focusedAppId:null,presentations:new Map,zOrderSeed:1,isStackViewOpen:!1,maxBackgroundApps:4};function Fe(e){const t=c.state.apps.get(e),n=t?.iframeRef;!t||!n||z().attach(n,e,t.manifest.name,t.manifest.permissions??[])}function as(e,t,n){z().attach(t,e,n.name,n.permissions??[])}const c=new pe(rs);function Ge(e){c.setState(t=>({...t,visualConfig:mt(t.visualConfig,e)}))}function os(e){Ge({motion:{timeScale:e}})}function cs(){c.setState(e=>({...e,visualConfig:he}))}const U=new Set;function m(e){U.forEach(t=>t(e))}let ue=0;function Ye(e,t){return ue+=1,{id:`${e}:${t}:${Date.now()}:${ue}`,kind:e,status:"requested",startedAt:Date.now()}}function ls(e){const t=e.splashScreen;return t?typeof t=="object"&&typeof t.timeout=="number"?t.timeout:5e3:null}function us(e,t){if(!e||e==="preparing"){if(t==="launching")return"opening";if(t==="splash")return"splash";if(t==="active")return"opened"}return e==="launching"&&t==="splash"?"splash":(e==="launching"||e==="splash")&&t==="active"?"opened":e==="active"&&t==="background"?"backgrounding":e==="background"&&t==="active"?"foregrounding":t==="closing"?"closing":t==="preparing"?"closed":t==="launching"?"opening":t==="splash"?"splash":t==="active"?"opened":t==="background"?"backgrounded":"closed"}function R(e,t){c.setState(n=>{const s=n.apps.get(e);if(!s)return n;const i=us(s.state,t),r=new Map(n.apps);return r.set(e,{...s,state:t,flow:i}),{...n,apps:r}}),m({type:"app:state-change",appId:e,state:t})}function ds(e,t){c.setState(n=>{const s=n.apps.get(e);if(!s||s.processStatus===t)return n;const i=new Map(n.apps);return i.set(e,{...s,processStatus:t}),{...n,apps:i}})}function ps(e,t){c.setState(n=>{const s=n.apps.get(e);if(!s||s.readiness===t)return n;const i=new Map(n.apps);return i.set(e,{...s,readiness:t}),{...n,apps:i}})}function Ze(e){ps(e,"ready");const t=c.state.apps.get(e);t&&!t.manifest.splashScreen&&(t.state==="launching"||t.state==="splash")&&D(e)}function gs(e){switch(e){case"opening":return"opened";case"backgrounding":return"backgrounded";case"foregrounding":return"opened";default:return e}}function fs(e){c.setState(t=>{const n=t.apps.get(e);if(!n)return t;const s=gs(n.flow);if(s===n.flow)return t;const i=new Map(t.apps);return i.set(e,{...n,flow:s}),{...t,apps:i}})}const hs={launchToSplash:100},y=new Map,L=new Map,H=new Map,ms=3e4,ws=2500,q=new Map;function A(e){const t=q.get(e);t&&(t.cancelled=!0,t.rafId!==null&&cancelAnimationFrame(t.rafId),q.delete(e))}function As(e){if(!e)return!1;const t=e.getBoundingClientRect();return t.width>0&&t.height>0}function Ss(e){return!!e&&e.isConnected}function T(e){const t=L.get(e);t&&(clearTimeout(t),L.delete(e))}function te(e,t,n){c.setState(s=>{const r=s.presentations.get(e)??{appId:e,desktop:t,state:"hidden",zOrder:s.zOrderSeed,transitionId:null,transitionKind:null},o={...r,...n,appId:e,desktop:n.desktop??r.desktop},l=new Map(s.presentations);return l.set(e,o),{...s,presentations:l}})}function Qe(e){c.setState(t=>{const n=t.presentations.get(e),s=t.zOrderSeed+1,i=new Map(t.presentations);return n&&i.set(e,{...n,zOrder:s}),{...t,activeAppId:e,focusedAppId:e,presentations:i,zOrderSeed:s}})}function bs(e,t){const n=c.state.presentations.get(e);n&&(n.transitionKind!=="present"||n.transitionId!==t||te(e,n.desktop,{state:"presented",transitionId:null,transitionKind:null}))}function Rs(e,t){const n=c.state.presentations.get(e);n&&(n.transitionKind!=="dismiss"||n.transitionId!==t||I(e))}function ne(e){T(e),Ze(e),D(e)}function P(e,t){A(e);const n=c.state.apps.get(e);n?.iframeRef&&x(n.iframeRef),c.setState(s=>{const i=new Map(s.apps);i.delete(e);const r=new Map(s.presentations);return r.delete(e),{...s,apps:i,presentations:r,activeAppId:s.activeAppId===e?null:s.activeAppId,focusedAppId:s.focusedAppId===e?null:s.focusedAppId}}),st.show({message:t,duration:2e3})}function Es(e,t){if(R(e,"launching"),se(e),t){const n=setTimeout(()=>{const s=c.state.apps.get(e);if(!s||s.state!=="launching")return;R(e,"splash"),T(e);const i=ls(s.manifest);i!==null&&L.set(e,setTimeout(()=>{const r=c.state.apps.get(e);r&&r.state==="splash"&&ne(e)},i))},hs.launchToSplash);y.set(e,[n]);return}y.set(e,[])}function _s(e,t,n){A(e);const s={cancelled:!1,rafId:null};q.set(e,s);const i=performance.now(),r=()=>{if(s.cancelled)return;const o=c.state.apps.get(e);if(!o||o.state!=="preparing"){A(e);return}const l=As(X(e)),g=!!Ke(t,e),p=Ss(o.iframeRef);if(l&&g&&p){A(e),Es(e,n);return}if(performance.now()-i>ws){g?l?P(e,"启动失败：加载容器未就绪，请重试"):P(e,"启动失败：图标未就绪，请返回桌面重试"):P(e,"启动失败：请停留在目标桌面页后重试");return}s.rafId=requestAnimationFrame(r)};s.rafId=requestAnimationFrame(r)}function se(e){const t=y.get(e);t&&(t.forEach(n=>clearTimeout(n)),y.delete(e))}function Xe(e){const t=H.get(e);t&&(clearTimeout(t),H.delete(e))}function I(e){se(e),Xe(e),T(e),A(e),c.setState(t=>{const n=t.apps.get(e);if(!n)return t;n.iframeRef&&x(n.iframeRef);const s=new Map(t.apps);s.delete(e);const i=new Map(t.presentations);return i.delete(e),{...t,apps:s,presentations:i,activeAppId:t.activeAppId===e?null:t.activeAppId,focusedAppId:t.focusedAppId===e?null:t.focusedAppId}}),c.state.apps.size===0&&z().detach()}function et(e){ne(e)}function tt(e,t,n){const i=c.state.apps.get(e);if(i){Fe(e);const p=i.manifest.targetDesktop??"stack";return te(e,p,{state:"presented",transitionId:null,transitionKind:null}),Qe(e),D(e),i}const r=!!t.splashScreen,o={appId:e,manifest:t,state:"preparing",flow:"closed",ctx:{capsuleTheme:t.capsuleTheme??"auto"},processStatus:"loading",readiness:"notReady",launchedAt:Date.now(),lastActiveAt:Date.now(),iframeRef:null,iconRef:X(e)};o.iframeRef=At(e,t.url,n),as(e,o.iframeRef,t),o.iframeRef.addEventListener("load",()=>{ds(e,"loaded"),t.splashScreen||Ze(e)}),St(o.iframeRef);const l=t.targetDesktop??"stack",g=Ye("present",e);return c.setState(p=>{const h=p.zOrderSeed+1,v=new Map(p.apps);v.set(e,o);const k=new Map(p.presentations);return k.set(e,{appId:e,desktop:l,state:"presenting",zOrder:h,transitionId:g.id,transitionKind:"present"}),{...p,apps:v,presentations:k,activeAppId:e,focusedAppId:e,zOrderSeed:h}}),m({type:"app:launch",appId:e,manifest:t}),_s(e,l,r),o}function ys(e,t,n){return tt(e,t,n)}function D(e){const t=c.state,n=t.apps.get(e);n&&n.state!=="preparing"&&(t.activeAppId&&t.activeAppId!==e&&nt(t.activeAppId),n.iframeRef&&n.state==="background"&&Rt(n.iframeRef),R(e,"active"),Fe(e),c.setState(s=>{const i=new Map(s.apps),r=i.get(e);return r&&i.set(e,{...r,lastActiveAt:Date.now()}),{...s,apps:i,activeAppId:e,focusedAppId:e}}),m({type:"app:activate",appId:e}))}function nt(e){const t=c.state,n=t.apps.get(e);n&&n.state!=="preparing"&&(n.iframeRef&&bt(n.iframeRef),R(e,"background"),Et(c.state.apps,c.state.activeAppId,t.maxBackgroundApps),m({type:"app:deactivate",appId:e}))}function ie(e){const n=c.state.apps.get(e);if(!n)return;se(e),Xe(e),A(e),R(e,"closing"),T(e);const s=n.manifest.targetDesktop??"stack",i=Ye("dismiss",e);te(e,s,{state:"dismissing",transitionId:i.id,transitionKind:"dismiss"}),H.set(e,setTimeout(()=>{const r=c.state.presentations.get(e);r&&(r.transitionKind!=="dismiss"||r.transitionId!==i.id||I(e))},ms)),m({type:"app:close",appId:e})}function Ts(e){ie(e)}function Is(e,t){const s=c.state.apps.get(e);if(!s)return;const i={...s.ctx,...t};c.setState(r=>{const o=new Map(r.apps),l=o.get(e);return l&&o.set(e,{...l,ctx:i}),{...r,apps:o}}),m({type:"app:ctx-change",appId:e,ctx:i})}function Ds(){c.state.apps.forEach((t,n)=>{ie(n),I(n)}),_t()}function vs(){c.setState(e=>({...e,isStackViewOpen:!0})),m({type:"stack-view:open"})}function ks(){c.setState(e=>({...e,isStackViewOpen:!1})),m({type:"stack-view:close"})}function Os(e){return U.add(e),()=>U.delete(e)}function Ps(){return Array.from(c.state.apps.values())}function Ms(){const e=c.state;return e.activeAppId?e.apps.get(e.activeAppId)??null:null}function Cs(){return c.state.apps.size>0}const Ns={getApps:e=>Array.from(e.apps.values()),getVisualConfig:e=>e.visualConfig,getActiveApp:e=>e.activeAppId?e.apps.get(e.activeAppId)??null:null,getFocusedAppId:e=>e.focusedAppId??e.activeAppId,getFocusedApp:e=>{const t=e.focusedAppId??e.activeAppId;return t?e.apps.get(t)??null:null},getPresentations:e=>Array.from(e.presentations.values()).sort((t,n)=>t.zOrder-n.zOrder),getPresentation:(e,t)=>e.presentations.get(t)??null,hasPresentations:e=>e.presentations.size>0,hasRunningApps:e=>e.apps.size>0,hasRunningStackApps:e=>Array.from(e.apps.values()).some(t=>(t.manifest.targetDesktop??"stack")==="stack"),isStackViewOpen:e=>e.isStackViewOpen,getBackgroundApps:e=>Array.from(e.apps.values()).filter(t=>t.state==="background"),isLaunchOverlayVisible:e=>{const t=e.focusedAppId??e.activeAppId?e.apps.get(e.focusedAppId??e.activeAppId):null;return t?.state==="launching"||t?.state==="splash"},isShowingSplash:e=>(e.focusedAppId??e.activeAppId?e.apps.get(e.focusedAppId??e.activeAppId):null)?.state==="splash",isAnimating:e=>{const t=e.focusedAppId??e.activeAppId?e.apps.get(e.focusedAppId??e.activeAppId):null;return t?.state==="launching"||t?.state==="splash"||t?.state==="closing"}},js=Object.freeze(Object.defineProperty({__proto__:null,activateApp:D,closeAllApps:Ds,closeApp:ie,closeStackView:ks,deactivateApp:nt,didDismiss:Rs,didPresent:bs,dismissSplash:et,finalizeCloseApp:I,getActiveApp:Ms,getDesktopAppSlotRect:Ke,getDesktopAppSlotRef:Je,getDesktopContainerRef:ee,getDesktopGridHostRef:Gn,getDesktopRect:ze,getIconInnerRef:Un,getIconRef:X,getRunningApps:Ps,getSlotStatus:j,getSplashBgRef:qn,getSplashIconRef:Wn,getStackContainerRef:es,getStackRect:ts,getWindowInnerRef:Jn,getWindowRef:$n,hasRunningApps:Cs,launchApp:tt,miniappRuntimeSelectors:Ns,miniappRuntimeStore:c,openStackView:vs,registerDesktopAppSlotRef:Yn,registerDesktopContainerRef:xe,registerDesktopGridHostRef:Kn,registerIconInnerRef:Nn,registerIconRef:Cn,registerSplashBgRef:Ln,registerSplashIconRef:Bn,registerStackContainerRef:Qn,registerWindowInnerRef:zn,registerWindowRef:xn,requestDismiss:Ts,requestDismissSplash:ne,requestFocus:Qe,requestPresent:ys,resetMiniappVisualConfig:cs,setMiniappMotionTimeScale:os,setMiniappVisualConfig:Ge,settleFlow:fs,subscribe:Os,subscribeSlotStatus:qe,unregisterDesktopAppSlotRef:Zn,unregisterDesktopContainerRef:$e,unregisterDesktopGridHostRef:Fn,unregisterIconRef:jn,unregisterSplashBgRef:Hn,unregisterSplashIconRef:Vn,unregisterStackContainerRef:Xn,updateAppContext:Is,useMiniappVisibilityRestore:ss,useSlotStatus:is},Symbol.toStringTag,{value:"Module"}));export{ne as A,Rs as B,Kn as C,he as D,Fn as E,Yn as F,Zn as G,Dt as H,be as I,ei as J,ai as K,z as L,Gs as M,Ys as N,Zs as O,Qs as P,Xs as Q,ti as R,ni as S,si as T,ii as U,ri as V,Fs as W,Ks as a,Ns as b,Ds as c,c as d,d as e,xe as f,Js as g,$e as h,Cn as i,Nn as j,jn as k,tt as l,mt as m,Qn as n,vs as o,Xn as p,is as q,cs as r,os as s,Je as t,ss as u,bs as v,fs as w,xn as x,zn as y,Ts as z};
