const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./web-NCSswCd6.js","./user-profile-rIN_GxQp.js","./preload-helper-PPVm8Dsz.js","./index-D0E7N0oa.js","./derivation-CmJNFLfN.js","./iframe-CMX6GvDx.js","./iframe-BOQhExOT.css","./schemas-CO8_C8zP.js","./avatar-codec-D7rhyY6J.js","./service-qx9PzakR.js","./bioforest-COUrd5ZY.js","./breakpoint-DQ_qwb34.js","./nacl-fast-BTo29pIj.js","./nacl-fast-CvPgBZCv.js","./ed2curve-BZxqY6ge.js"])))=>i.map(i=>d[i]);
import{W as St,I as Et,c as yt}from"./wujie-container-uTIfNoAS.js";import{t as _t}from"./web-NCSswCd6.js";import{S as Ie,q as O,r as Oe}from"./iframe-CMX6GvDx.js";import{_}from"./preload-helper-PPVm8Dsz.js";import{g as Y,k as bt,n as fe}from"./index-BKxvte0Y.js";import{w as De,o as Rt,e as Tt}from"./user-profile-rIN_GxQp.js";import{A as It}from"./amount-BQsqQYGO.js";import{e as L,f as Ot,a as Dt}from"./service-qx9PzakR.js";import{D as he,j as me,x as kt,B as vt}from"./derivation-CmJNFLfN.js";import"./index-D0E7N0oa.js";import{c as ke,p as ve,h as Nt,b as N,s as Pt}from"./bioforest-COUrd5ZY.js";import{p as Mt,g as Ct,t as jt,E as Ut}from"./index-DRQXAVdd.js";const Ne={motion:{timeScale:1,layoutDuration:.45,uiFastDuration:.15,layoutEase:[.4,0,.1,1],spring:{stiffness:220,damping:28,mass:.85}},css:{}};function X(e){return!Number.isFinite(e)||e<=0?1:e}function P(e,t){const n=X(t);return e/n}function we(e,t,n){const s=X(t);return e*Math.pow(s,n)}function Lt(e,t){return t?{motion:{...e.motion,...t.motion,spring:{...e.motion.spring,...t.motion?.spring}},css:{...e.css,...t.css}}:e}const Ae=new WeakMap,Se=new WeakMap;function vr(e){const t=Ae.get(e);if(t)return t;const{motion:n}=e,s={type:"spring",stiffness:we(n.spring.stiffness,n.timeScale,2),damping:we(n.spring.damping,n.timeScale,1),mass:n.spring.mass},a={layout:{duration:P(n.layoutDuration,n.timeScale),ease:n.layoutEase}},c={duration:P(n.uiFastDuration,n.timeScale),ease:"easeOut"},o={motionConfig:s,sharedLayout:a,uiFast:c};return Ae.set(e,o),o}function Nr(e){const t=Se.get(e);if(t)return t;const{motion:n}=e,s={"--miniapp-motion-time-scale":String(X(n.timeScale)),"--miniapp-motion-layout-duration":`${P(n.layoutDuration,n.timeScale)}s`,"--miniapp-motion-ui-fast-duration":`${P(n.uiFastDuration,n.timeScale)}s`,"--miniapp-motion-layout-ease":`cubic-bezier(${n.layoutEase.join(",")})`};return Se.set(e,s),s}const xt={iframe:new Et,wujie:new St};function Ht(e){return xt[e]}async function Bt(e,t){return Ht(e).create(t)}const Pr={bio_requestAccounts:{risk:"low"},bio_selectAccount:{risk:"low"},bio_pickWallet:{risk:"low"},bio_createTransaction:{risk:"low"},bio_signMessage:{risk:"medium"},bio_signTypedData:{risk:"medium"},bio_signTransaction:{risk:"high"},bio_sendTransaction:{risk:"high"},bio_destroyAsset:{risk:"high"},bio_requestCryptoToken:{risk:"high"},bio_cryptoExecute:{risk:"low"},bio_getCryptoTokenInfo:{risk:"low"},bio_accounts:{risk:"low"},bio_chainId:{risk:"low"},bio_getBalance:{risk:"low"}},i={USER_REJECTED:4001,UNAUTHORIZED:4100,UNSUPPORTED_METHOD:4200,INTERNAL_ERROR:-32603,INVALID_PARAMS:-32602,METHOD_NOT_FOUND:-32601};function Ee(e,t,n,s){return{type:"bio_response",id:e,success:!1,error:{code:t,message:n,data:s}}}const Pe="ecosystem_my_apps",Kt={teleport:"xin.dweb.teleport",forge:"xin.dweb.forge"};function I(e){return Kt[e]??e}function ye(){try{const e=localStorage.getItem(Pe),t=e?JSON.parse(e):[],n=t.map(s=>({...s,appId:I(s.appId)}));return JSON.stringify(t)!==JSON.stringify(n)&&Me(n),n}catch{return[]}}function Me(e){localStorage.setItem(Pe,JSON.stringify(e))}var _e=[{name:"RWA",url:"https://iweb.xin/rwahub.bfmeta.com.miniapp/source.json"}];const B=["discover","mine"],Ce="ecosystem_store",je=()=>O.t("ecosystem:sources.defaultName");function Vt(){if(!Array.isArray(_e))return[];const e=new Date().toISOString();return _e.filter(t=>!!(t?.url&&t?.name)).map(t=>({url:t.url,name:t.name,lastUpdated:e,enabled:!0,status:"idle",icon:t.icon}))}function zt(e,t){return e.length===t.length&&e.every((n,s)=>n===t[s])}function Ue(){const t=[{url:"./miniapps/ecosystem.json",name:je(),lastUpdated:new Date().toISOString(),enabled:!0,status:"idle"}];for(const n of Vt())t.some(s=>s.url===n.url)||t.push(n);return t}function be(e){const t=Ue(),n=[...e];for(const s of t)n.some(r=>r.url===s.url)||n.push(s);return n}function qt(e){if(!Array.isArray(e))return[];const t=new Date().toISOString();return e.map(n=>{if(typeof n=="string")return{url:n,name:"Bio 官方生态",lastUpdated:t,enabled:!0,status:"idle"};if(!n||typeof n!="object")return null;const s=n;return typeof s.url!="string"||s.url.length===0?null:{url:s.url,name:typeof s.name=="string"&&s.name.length>0?s.name:je(),lastUpdated:typeof s.lastUpdated=="string"&&s.lastUpdated.length>0?s.lastUpdated:t,enabled:typeof s.enabled=="boolean"?s.enabled:!0,status:s.status??"idle",errorMessage:s.errorMessage,icon:s.icon}}).filter(n=>n!==null)}function Wt(){try{const e=localStorage.getItem(Ce);if(e){const t=JSON.parse(e),n=Array.isArray(t.availableSubPages)&&t.availableSubPages.length>0?t.availableSubPages:B,s=t.activeSubPage??"discover",r=n.includes(s)?n:[...n,s],a=qt(t.sources),c=be(a);return{permissions:t.permissions??[],sources:c.length>0?c:Ue(),myApps:ye(),availableSubPages:r,activeSubPage:s,swiperProgress:0,syncSource:null}}}catch{}return{permissions:[],sources:be([]),myApps:ye(),availableSubPages:B,activeSubPage:"discover",swiperProgress:0,syncSource:null}}function $t(e){try{localStorage.setItem(Ce,JSON.stringify({permissions:e.permissions,sources:e.sources,availableSubPages:e.availableSubPages,activeSubPage:e.activeSubPage})),Me(e.myApps)}catch{}}const f=new Ie(Wt());f.subscribe(()=>{$t(f.state)});const Le={getGrantedPermissions:(e,t)=>e.permissions.find(n=>n.appId===t)?.granted??[],hasPermission:(e,t,n)=>Le.getGrantedPermissions(e,t).includes(n),getEnabledSources:e=>e.sources.filter(t=>t.enabled),isAppInstalled:(e,t)=>{const n=I(t);return e.myApps.some(s=>s.appId===n)}},Ft={installApp:e=>{f.setState(t=>{const n=I(e);return t.myApps.some(s=>s.appId===n)?t:{...t,myApps:[{appId:n,installedAt:Date.now(),lastUsedAt:Date.now()},...t.myApps]}})},uninstallApp:e=>{f.setState(t=>{const n=I(e);return{...t,myApps:t.myApps.filter(s=>s.appId!==n)}})},updateAppLastUsed:e=>{f.setState(t=>{const n=I(e);return t.myApps.find(r=>r.appId===n)?{...t,myApps:t.myApps.map(r=>r.appId===n?{...r,lastUsedAt:Date.now()}:r)}:t})},grantPermissions:(e,t)=>{f.setState(n=>{const s=n.permissions.find(r=>r.appId===e);if(s){const r=[...new Set([...s.granted,...t])];return{...n,permissions:n.permissions.map(a=>a.appId===e?{...a,granted:r,grantedAt:Date.now()}:a)}}else return{...n,permissions:[...n.permissions,{appId:e,granted:t,grantedAt:Date.now()}]}})},revokePermissions:(e,t)=>{f.setState(n=>t?{...n,permissions:n.permissions.map(s=>s.appId===e?{...s,granted:s.granted.filter(r=>!t.includes(r))}:s)}:{...n,permissions:n.permissions.filter(s=>s.appId!==e)})},addSource:(e,t)=>{f.setState(n=>n.sources.some(s=>s.url===e)?n:{...n,sources:[...n.sources,{url:e,name:t,lastUpdated:new Date().toISOString(),enabled:!0,status:"idle"}]})},removeSource:e=>{f.setState(t=>({...t,sources:t.sources.filter(n=>n.url!==e)}))},toggleSource:e=>{f.setState(t=>({...t,sources:t.sources.map(n=>n.url===e?{...n,enabled:!n.enabled}:n)}))},updateSourceTimestamp:e=>{f.setState(t=>({...t,sources:t.sources.map(n=>n.url===e?{...n,lastUpdated:new Date().toISOString()}:n)}))},updateSourceStatus:(e,t,n)=>{f.setState(s=>({...s,sources:s.sources.map(r=>r.url===e?{...r,status:t,errorMessage:t==="error"?n:void 0,...t==="success"?{lastUpdated:new Date().toISOString()}:{}}:r)}))},setActiveSubPage:e=>{f.setState(t=>({...t,activeSubPage:e}))},setAvailableSubPages:e=>{f.setState(t=>{const n=e.length>0?e:B;if(zt(t.availableSubPages,n))return t;const s=n.includes(t.activeSubPage)?t.activeSubPage:n[0]??"mine";return{...t,availableSubPages:n,activeSubPage:s}})},setSwiperProgress:e=>{f.setState(t=>({...t,swiperProgress:e}))},setSyncSource:e=>{f.setState(t=>({...t,syncSource:e}))}},Jt=["bio_requestAccounts","bio_signMessage","bio_signTypedData","bio_signTransaction","bio_sendTransaction"];function Z(e){return Jt.includes(e)}function Gt(e,t){return Z(t)?Le.hasPermission(f.state,e,t):!0}function Yt(e,t){Ft.grantPermissions(e,t)}function Mr(e){const t=O.t.bind(O),s=["bio_requestAccounts","bio_accounts","bio_selectAccount","bio_pickWallet","bio_chainId","bio_getBalance","bio_createTransaction","bio_signMessage","bio_signTypedData","bio_signTransaction","bio_sendTransaction","bio_destroyAsset","bio_requestCryptoToken","bio_cryptoExecute","bio_getCryptoTokenInfo"].includes(e);return{label:s?t(`ecosystem:permissions.${e}.name`):e,description:t(s?`ecosystem:permissions.${e}.description`:"ecosystem:permissions.defaultDescription"),sensitive:Z(e)}}class Xt{handlers=new Map;iframe=null;appId="";appName="";origin="*";manifestPermissions=[];messageHandler=null;permissionRequestCallback=null;registerHandler(t,n){this.handlers.set(t,n)}setPermissionRequestCallback(t){this.permissionRequestCallback=t}attach(t,n,s,r=[]){this.detach(),this.iframe=t,this.appId=n,this.appName=s,this.manifestPermissions=r;try{const a=new URL(t.src,window.location.origin);this.origin=a.origin}catch{this.origin="*"}this.messageHandler=this.handleMessage.bind(this),window.addEventListener("message",this.messageHandler)}detach(){this.messageHandler&&(window.removeEventListener("message",this.messageHandler),this.messageHandler=null),this.iframe=null,this.appId="",this.appName="",this.manifestPermissions=[]}emit(t,...n){this.emitTo("bio",t,...n)}emitEth(t,...n){this.emitTo("eth",t,...n)}emitTron(t,...n){this.emitTo("tron",t,...n)}emitTo(t,n,...s){if(!this.iframe?.contentWindow)return;const r={type:`${t}_event`,event:n,args:s};this.iframe.contentWindow.postMessage(r,this.origin)}handleMessage(t){const n=t.data;if(!n||typeof n!="object"||!("type"in n)||!(n.type==="bio_request"||n.type==="eth_request"||n.type==="tron_request"))return;console.log("[BioBridge] Received bio message:",{origin:t.origin,expectedOrigin:this.origin,type:n.type,method:n.method});const r=this.origin.includes("localhost")&&t.origin.includes("localhost");if(!(this.origin==="*"||t.origin===this.origin||r)){console.warn("[BioBridge] Origin mismatch, ignoring message");return}if(!(t.source===this.iframe?.contentWindow||r&&t.source instanceof Window)){console.warn("[BioBridge] Source mismatch, ignoring message");return}console.log("[BioBridge] Processing message:",n.type),n.type==="bio_request"?this.processRequest(n,"bio"):n.type==="eth_request"?this.processRequest(n,"eth"):n.type==="tron_request"&&this.processRequest(n,"tron")}async processRequest(t,n){const{id:s,method:r,params:a}=t,c=this.handlers.get(r);if(!c){this.sendResponse(n,{type:`${n}_response`,id:s,success:!1,error:{code:i.METHOD_NOT_FOUND,message:`Method not found: ${r}`}});return}if(!(n!=="bio"||["bio_connect","bio_closeSplashScreen"].includes(r))){const p=["bio_accounts","bio_selectAccount","bio_pickWallet"].includes(r)&&this.manifestPermissions.includes("bio_requestAccounts"),d=p?"bio_requestAccounts":r;if(!(this.manifestPermissions.includes(r)||r==="bio_requestAccounts"||p)){this.sendResponse(n,Ee(s,i.UNAUTHORIZED,`Permission not declared in manifest: ${r}`));return}if(Z(d)&&!Gt(this.appId,d)&&!await this.requestPermission([d])){this.sendResponse(n,Ee(s,i.USER_REJECTED,"Permission denied by user"));return}}try{const p=l.state.apps.get(this.appId)?.manifest;let d=p?.icon;if(d&&!d.startsWith("http")&&!d.startsWith("data:"))try{const w=new URL(p?.url??"",window.location.origin);d=new URL(d,w).href}catch{}const h={appId:this.appId,appName:this.appName,appIcon:d,origin:this.origin,permissions:this.manifestPermissions},A=await c(a?.[0],h);this.sendResponse(n,{type:`${n}_response`,id:s,success:!0,result:A})}catch(u){const p=u instanceof Error?u.message:"Unknown error",d=u.code??i.INTERNAL_ERROR;this.sendResponse(n,{type:`${n}_response`,id:s,success:!1,error:{code:d,message:p}})}}async requestPermission(t){if(!this.permissionRequestCallback)return!1;try{const n=await this.permissionRequestCallback(this.appId,this.appName,t);return n&&Yt(this.appId,t),n}catch{return!1}}sendResponse(t,n){this.iframe?.contentWindow&&this.iframe.contentWindow.postMessage(n,this.origin)}}const g=new Xt,b=new Map,m={register(e,t){b.set(e,t)},unregister(e){b.delete(e)},get(e){return b.get(e)},has(e){return b.has(e)},getRegisteredApps(){return Array.from(b.keys())},clear(){b.clear()}},Zt=async(e,t)=>{mt(t.appId)};let xe=null,He=null;function Cr(e){xe=e}function jr(e){He=e}function Q(e){return m.get(e)?.showWalletPicker??xe}function Qt(e){return m.get(e)?.getConnectedAccounts??He}const en=async(e,t)=>({connected:!0}),tn=async(e,t)=>{const n=Q(t.appId);if(!n)throw Object.assign(new Error("Wallet picker not available"),{code:i.INTERNAL_ERROR});const r=await n({chain:e?.chain,app:{name:t.appName,icon:t.appIcon}});if(!r)throw Object.assign(new Error("User rejected"),{code:i.USER_REJECTED});return[r]},nn=async(e,t)=>{const n=Qt(t.appId);return n?n():[]},sn=async(e,t)=>{const n=Q(t.appId);if(!n)throw Object.assign(new Error("Wallet picker not available"),{code:i.INTERNAL_ERROR});const r=await n({...e,app:{name:t.appName,icon:t.appIcon}});if(!r)throw Object.assign(new Error("User rejected"),{code:i.USER_REJECTED});return r},rn=async(e,t)=>{const n=Q(t.appId);if(!n)throw Object.assign(new Error("Wallet picker not available"),{code:i.INTERNAL_ERROR});const r=await n({...e,app:{name:t.appName,icon:t.appIcon}});if(!r)throw Object.assign(new Error("User rejected"),{code:i.USER_REJECTED});return r},an=async(e,t)=>De.state.selectedChain,on=async(e,t)=>{const n=e;if(!n?.address||!n?.chain)throw Object.assign(new Error("Missing address or chain"),{code:i.INVALID_PARAMS});const s=Y(n.chain);try{return(await s.nativeBalance.fetch({address:n.address}))?.amount.toRawString()??"0"}catch{return"0"}};let Be=null;function Ur(e){Be=e}function Ke(e){return m.get(e)?.showSigningDialog??Be}const cn=async(e,t)=>{const n=e;if(!n?.message||!n?.address)throw Object.assign(new Error("Missing message or address"),{code:i.INVALID_PARAMS});const s=Ke(t.appId);if(!s)throw Object.assign(new Error("Signing dialog not available"),{code:i.INTERNAL_ERROR});const r=await s({message:n.message,address:n.address,app:{name:t.appName}});if(!r)throw Object.assign(new Error("User rejected"),{code:i.USER_REJECTED});return r},ln=async(e,t)=>{const n=e;if(!n?.data||!n?.address)throw Object.assign(new Error("Missing data or address"),{code:i.INVALID_PARAMS});const s=Ke(t.appId);if(!s)throw Object.assign(new Error("Signing dialog not available"),{code:i.INTERNAL_ERROR});const r=JSON.stringify(n.data,null,2),a=await s({message:r,address:n.address,app:{name:t.appName}});if(!a)throw Object.assign(new Error("User rejected"),{code:i.USER_REJECTED});return a};let Ve=null;function Lr(e){Ve=e}function dn(e){return m.get(e)?.showTransferDialog??Ve}const un=async(e,t)=>{const n=e;if(!n?.from||!n?.to||!n?.amount||!n?.chain)throw Object.assign(new Error("Missing required parameters: from, to, amount, chain"),{code:i.INVALID_PARAMS});const s=dn(t.appId);if(!s)throw Object.assign(new Error("Transfer dialog not available"),{code:i.INTERNAL_ERROR});const r={from:n.from,to:n.to,amount:n.amount,chain:n.chain,app:{name:t.appName}};n.asset&&(r.asset=n.asset),n.tokenAddress&&(r.tokenAddress=n.tokenAddress);const a=await s(r);if(!a)throw Object.assign(new Error("User rejected"),{code:i.USER_REJECTED});return a};let pn=null;function gn(e){return m.get(e)?.showDestroyDialog??pn}const fn=async(e,t)=>{const n=e;if(!n?.from||!n?.amount||!n?.chain||!n?.asset)throw Object.assign(new Error("Missing required parameters: from, amount, chain, asset"),{code:i.INVALID_PARAMS});const s=gn(t.appId);if(!s)throw Object.assign(new Error("Destroy dialog not available"),{code:i.INTERNAL_ERROR});const r={from:n.from,amount:n.amount,chain:n.chain,asset:n.asset,app:{name:t.appName}},a=await s(r);if(!a)throw Object.assign(new Error("User rejected"),{code:i.USER_REJECTED});return a};function hn(e,t){const n=De.state.wallets,s=t.startsWith("0x"),r=s?t.toLowerCase():t;for(const a of n)if(a.chainAddresses.find(o=>o.chain!==e?!1:s||o.address.startsWith("0x")?o.address.toLowerCase()===r:o.address===r))return a.id;return null}async function ze(e){if(L.state.snapshot||await Ot.initialize(),!L.state.snapshot)throw Object.assign(new Error("Chain configs not initialized"),{code:i.INTERNAL_ERROR});const n=Dt.getChainById(L.state,e);if(!n)throw Object.assign(new Error(`Unsupported chain: ${e}`),{code:i.INVALID_PARAMS});return n}const mn=async(e,t)=>{const n=e;if(!n?.from||!n?.to||!n?.amount||!n?.chain)throw Object.assign(new Error("Missing required parameters: from, to, amount, chain"),{code:i.INVALID_PARAMS});if(!hn(n.chain,n.from))throw Object.assign(new Error("From address is not owned by current user"),{code:i.UNAUTHORIZED});const r=await ze(n.chain),a=n.tokenAddress?.trim()||void 0,c=n.asset??r.symbol,o=a&&typeof n.assetDecimals=="number"?n.assetDecimals:r.decimals,u=It.parse(n.amount,o,c),p=a&&r.chainKind==="tron"?bt(r.id):Y(r.id),d=p.buildTransaction;if(!p.supportsBuildTransaction||!d)throw Object.assign(new Error(`Chain ${r.id} does not support transaction building`),{code:i.UNSUPPORTED_METHOD});const h=await d({type:"transfer",from:n.from,to:n.to,amount:u,tokenAddress:a,...n.asset?{bioAssetType:n.asset}:{},...n.remark?{remark:n.remark}:{}});if(a&&r.chainKind==="tron"){const w=h.data;if(!w||typeof w!="object"||!("rawTx"in w))throw Object.assign(new Error("TRC20 transaction builder not available"),{code:i.UNSUPPORTED_METHOD})}return{chainId:h.chainId,intentType:h.intentType,data:h.data}};let qe=null;function xr(e){qe=e}function wn(e){return m.get(e)?.showSignTransactionDialog??qe}const An=async(e,t)=>{const n=e;if(!n?.from||!n?.chain||!n?.unsignedTx)throw Object.assign(new Error("Missing required parameters: from, chain, unsignedTx"),{code:i.INVALID_PARAMS});const s=wn(t.appId);if(!s)throw Object.assign(new Error("SignTransaction dialog not available"),{code:i.INTERNAL_ERROR});const r=await s({from:n.from,chain:n.chain,unsignedTx:n.unsignedTx,app:{name:t.appName}});if(!r)throw Object.assign(new Error("User rejected"),{code:i.USER_REJECTED});return r};async function Hr(e){const t=await ze(e.chainId),n=Y(t.id),s=n.signTransaction;if(!n.supportsSignTransaction||!s)throw Object.assign(new Error(`Chain ${t.id} does not support transaction signing`),{code:i.UNSUPPORTED_METHOD});const r=await(await _(async()=>{const{walletStorageService:o}=await import("./web-NCSswCd6.js").then(u=>u.i);return{walletStorageService:o}},__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11]),import.meta.url)).walletStorageService.getMnemonic(e.walletId,e.password);let a;if(t.chainKind==="evm"){const o=he(r,"ethereum",0,0);if(o.address.toLowerCase()!==e.from.toLowerCase())throw Object.assign(new Error("Signing address mismatch"),{code:i.INVALID_PARAMS});a=me(o.privateKey)}else if(t.chainKind==="bioforest"){const o=ke(r);if(ve(o.publicKey,t.prefix??"b")!==e.from)throw Object.assign(new Error("Signing address mismatch"),{code:i.INVALID_PARAMS});a=o.secretKey}else if(t.chainKind==="tron"){const o=he(r,"tron",0,0),u=fe(e.from),p=fe(o.address);if(u!==p)throw Object.assign(new Error("Signing address mismatch"),{code:i.INVALID_PARAMS});a=me(o.privateKey)}else throw Object.assign(new Error(`Unsupported chain kind: ${t.chainKind}`),{code:i.UNSUPPORTED_METHOD});const c=await s({chainId:e.unsignedTx.chainId,intentType:e.unsignedTx.intentType??"transfer",data:e.unsignedTx.data},t.chainKind==="bioforest"?{bioSecret:r,privateKey:a}:{privateKey:a});return{chainId:c.chainId,data:c.data,signature:c.signature}}const We=new Map,$e=new Map;let Fe=null,K=null,Je=null,Ge=null;function Br(e){Fe=e}function Kr(e){K=e}function Vr(e){Je=e}function zr(e){Ge=e}function Sn(e){return m.get(e)?.showEvmWalletPicker??Fe}function Ye(e){return m.get(e)?.showEvmSigningDialog??Je}function En(e){return m.get(e)?.showEvmTransactionDialog??Ge}function v(e){return We.get(e)??jt(Ut.binance)}function yn(e,t){We.set(e,t)}function _n(e){return $e.get(e)??[]}function bn(e,t){$e.set(e,t)}const Rn=async(e,t)=>v(t.appId),Tn=async(e,t)=>{const n=Sn(t.appId);if(!n)throw Object.assign(new Error("Wallet picker not available"),{code:i.INTERNAL_ERROR});const s=v(t.appId),r=await n({chainId:s,app:{name:t.appName,icon:t.appIcon}});if(!r)throw Object.assign(new Error("User rejected"),{code:i.USER_REJECTED});const a=[r.address];return bn(t.appId,a),a},In=async(e,t)=>_n(t.appId),On=async(e,t)=>{const n=e;if(!n?.chainId)throw Object.assign(new Error("Missing chainId"),{code:i.INVALID_PARAMS});const s=n.chainId;if(!Ct(s))throw Object.assign(new Error(`Chain ${s} not supported`),{code:4902});const a=v(t.appId);if(a===s)return null;if(K&&!await K({fromChainId:a,toChainId:s,appName:t.appName,appIcon:t.appIcon}))throw Object.assign(new Error("User rejected"),{code:i.USER_REJECTED});return yn(t.appId,s),null},Dn=async(e,t)=>{throw Object.assign(new Error("Adding custom chains is not supported"),{code:i.UNSUPPORTED_METHOD})},Xe=async(e,t)=>{const[n,s]=e;if(!n||!s)throw Object.assign(new Error("Missing message or address"),{code:i.INVALID_PARAMS});const r=Ye(t.appId);if(!r)throw Object.assign(new Error("Signing dialog not available"),{code:i.INTERNAL_ERROR});const a=await r({message:n,address:s,appName:t.appName});if(!a)throw Object.assign(new Error("User rejected"),{code:i.USER_REJECTED});return a.signature},kn=async(e,t)=>{const[n,s]=e;return Xe([s,n],t)},vn=async(e,t)=>{const[n,s]=e;if(!n||!s)throw Object.assign(new Error("Missing address or typedData"),{code:i.INVALID_PARAMS});const r=typeof s=="string"?JSON.parse(s):s,a=Ye(t.appId);if(!a)throw Object.assign(new Error("Signing dialog not available"),{code:i.INTERNAL_ERROR});const c=JSON.stringify(r,null,2),o=await a({message:c,address:n,appName:t.appName});if(!o)throw Object.assign(new Error("User rejected"),{code:i.USER_REJECTED});return o.signature},Nn=async(e,t)=>{const n=e;if(!n?.from)throw Object.assign(new Error("Missing transaction data"),{code:i.INVALID_PARAMS});const s=En(t.appId);if(!s)throw Object.assign(new Error("Transaction dialog not available"),{code:i.INTERNAL_ERROR});n.chainId||(n.chainId=v(t.appId));const r=await s({tx:n,appName:t.appName});if(!r)throw Object.assign(new Error("User rejected"),{code:i.USER_REJECTED});return r.txHash},Pn=async(e,t)=>{throw e?.from?Object.assign(new Error("eth_signTransaction not yet supported, use eth_sendTransaction"),{code:i.UNSUPPORTED_METHOD}):Object.assign(new Error("Missing transaction data"),{code:i.INVALID_PARAMS})},Mn=async(e,t)=>{const[n]=e;if(!n)throw Object.assign(new Error("Missing address"),{code:i.INVALID_PARAMS});return"0x0"},Cn=async(e,t)=>{const n=v(t.appId),s=Mt(n);return String(s)},jn=async(e,t)=>"0x0",Un=async(e,t)=>"KeyApp/1.0.0",Ln={eth_chainId:Rn,eth_requestAccounts:Tn,eth_accounts:In,wallet_switchEthereumChain:On,wallet_addEthereumChain:Dn,personal_sign:Xe,eth_sign:kn,eth_signTypedData_v4:vn,eth_sendTransaction:Nn,eth_signTransaction:Pn,eth_getBalance:Mn,net_version:Cn,eth_blockNumber:jn,web3_clientVersion:Un};function xn(e){for(const[t,n]of Object.entries(Ln))e(t,n)}const Ze=new Map;let Qe=null,Hn=null;function qr(e){Qe=e}function Bn(e){return m.get(e)?.showTronWalletPicker??Qe}function Kn(e){return m.get(e)?.showTronSigningDialog??Hn}function et(e){return Ze.get(e)??null}function Vn(e,t){Ze.set(e,t)}function zn(e){return{base58:e.address,hex:e.address}}const qn=async(e,t)=>{const n=Bn(t.appId);if(!n)throw Object.assign(new Error("Wallet picker not available"),{code:i.INTERNAL_ERROR});const s=await n({app:{name:t.appName,icon:t.appIcon}});if(!s)throw Object.assign(new Error("User rejected"),{code:i.USER_REJECTED});const r=zn(s);return Vn(t.appId,r),{code:200,message:"ok",data:r}},Wn=async(e,t)=>{const n=et(t.appId);return n?{code:200,message:"ok",data:n}:{code:4e3,message:"Not connected",data:null}},$n=async(e,t)=>et(t.appId),Fn=async(e,t)=>{const n=e;if(!n?.txID)throw Object.assign(new Error("Invalid transaction"),{code:i.INVALID_PARAMS});const s=Kn(t.appId);if(!s)throw Object.assign(new Error("Signing dialog not available"),{code:i.INTERNAL_ERROR});const r=await s({transaction:n,appName:t.appName});if(!r)throw Object.assign(new Error("User rejected"),{code:i.USER_REJECTED});return r.signedTransaction},Jn=async(e,t)=>{const n=e;if(!n?.txID||!n.signature)throw Object.assign(new Error("Invalid signed transaction"),{code:i.INVALID_PARAMS});return{result:!0,txid:n.txID}},Gn=async(e,t)=>{if(!e)throw Object.assign(new Error("Missing address"),{code:i.INVALID_PARAMS});return 0},Yn=async(e,t)=>{const n=e;if(!n)throw Object.assign(new Error("Missing address"),{code:i.INVALID_PARAMS});return{address:n,balance:0}},Xn={tron_requestAccounts:qn,tron_accounts:Wn,tron_getDefaultAddress:$n,tron_signTransaction:Fn,tron_sendRawTransaction:Jn,tron_getBalance:Gn,tron_getAccount:Yn};function Zn(e){for(const[t,n]of Object.entries(Xn))e(t,n)}const Qn="crypto-box-db",es=2,S="tokens";class ts{db=null;initialized=!1;async initialize(){this.initialized||(this.db=await Rt(Qn,es,{upgrade(t,n){t.objectStoreNames.contains(S)&&t.deleteObjectStore(S);const s=t.createObjectStore(S,{keyPath:"tokenId"});s.createIndex("by-miniapp","miniappId"),s.createIndex("by-wallet","walletId"),s.createIndex("by-expires","expiresAt")}}),this.initialized=!0,await this.cleanupExpired())}ensureInitialized(){if(!this.initialized||!this.db)throw new Error("TokenStore not initialized")}generateTokenId(){return crypto.randomUUID()}async sha256(t){const s=new TextEncoder().encode(t),r=await crypto.subtle.digest("SHA-256",s);return Array.from(new Uint8Array(r)).map(c=>c.toString(16).padStart(2,"0")).join("")}async deriveSessionSecret(t,n,s,r){return this.sha256(`${t}:${n}:${s}:${r}`)}async createToken(t){this.ensureInitialized();const{TOKEN_DURATION_MS:n}=await _(async()=>{const{TOKEN_DURATION_MS:A}=await Promise.resolve().then(()=>V);return{TOKEN_DURATION_MS:A}},void 0,import.meta.url),s=Date.now(),r=this.generateTokenId(),a=s+n[t.duration],c=await this.deriveSessionSecret(t.walletId,t.patternKey,t.miniappId,r),o={patternKey:t.patternKey,miniappId:t.miniappId,walletId:t.walletId,address:t.address,actions:t.actions,expiresAt:a},u=JSON.stringify(await kt(JSON.stringify(o),c)),p={tokenId:r,miniappId:t.miniappId,walletId:t.walletId,address:t.address,actions:t.actions,expiresAt:a,createdAt:s,encryptedPayload:u};await this.db.put(S,p);const{encryptedPayload:d,...h}=p;return{token:h,sessionSecret:c}}async decryptPayload(t,n){try{const s=JSON.parse(t.encryptedPayload),r=await vt(s,n);return JSON.parse(r)}catch{return null}}async getToken(t){return this.ensureInitialized(),await this.db.get(S,t)??null}async deleteToken(t){this.ensureInitialized(),await this.db.delete(S,t)}async validateToken(t,n,s,r){this.ensureInitialized();const a=await this.getToken(t);if(!a)return{valid:!1,error:"TOKEN_NOT_FOUND"};const c=await this.decryptPayload(a,n);return c?c.miniappId!==s?{valid:!1,error:"MINIAPP_MISMATCH"}:Date.now()>c.expiresAt?(await this.deleteToken(t),{valid:!1,error:"TOKEN_EXPIRED"}):c.actions.includes(r)?{valid:!0,token:a,payload:c}:{valid:!1,error:"ACTION_NOT_PERMITTED"}:{valid:!1,error:"INVALID_SESSION_SECRET"}}async getTokenInfo(t,n,s){this.ensureInitialized();const r=await this.getToken(t);if(!r)return{valid:!1,address:"",expiresAt:0,actions:[],invalidReason:"TOKEN_NOT_FOUND"};const a=await this.decryptPayload(r,n);return a?a.miniappId!==s?{valid:!1,address:"",expiresAt:0,actions:[],invalidReason:"MINIAPP_MISMATCH"}:Date.now()>a.expiresAt?(await this.deleteToken(t),{valid:!1,address:a.address,expiresAt:a.expiresAt,actions:a.actions,invalidReason:"TOKEN_EXPIRED"}):{valid:!0,address:a.address,expiresAt:a.expiresAt,actions:a.actions}:{valid:!1,address:"",expiresAt:0,actions:[],invalidReason:"INVALID_SESSION_SECRET"}}async cleanupExpired(){this.ensureInitialized();const t=Date.now(),n=this.db.transaction(S,"readwrite"),s=n.store.index("by-expires");let r=0,a=await s.openCursor(IDBKeyRange.upperBound(t));for(;a;)await a.delete(),r++,a=await a.continue();return await n.done,r}async getTokensByMiniapp(t){this.ensureInitialized();const n=Date.now();return(await this.db.getAllFromIndex(S,"by-miniapp",t)).filter(r=>r.expiresAt>n).map(({encryptedPayload:r,...a})=>a)}close(){this.db&&(this.db.close(),this.db=null,this.initialized=!1)}}const T=new ts;class ns{async execute(t,n){const s=await T.validateToken(t.tokenId,t.sessionSecret,n,t.action);if(!s.valid){const{CryptoBoxErrorCodes:o}=await _(async()=>{const{CryptoBoxErrorCodes:p}=await Promise.resolve().then(()=>V);return{CryptoBoxErrorCodes:p}},void 0,import.meta.url),u={TOKEN_NOT_FOUND:o.TOKEN_NOT_FOUND,MINIAPP_MISMATCH:o.MINIAPP_MISMATCH,TOKEN_EXPIRED:o.TOKEN_EXPIRED,ACTION_NOT_PERMITTED:o.ACTION_NOT_PERMITTED,INVALID_SESSION_SECRET:o.INVALID_SESSION_SECRET,ADDRESS_MISMATCH:o.ADDRESS_MISMATCH};throw Object.assign(new Error(`Token validation failed: ${s.error}`),{code:u[s.error]})}const{payload:r}=s;if(t.address&&t.address!==r.address){const{CryptoBoxErrorCodes:o}=await _(async()=>{const{CryptoBoxErrorCodes:u}=await Promise.resolve().then(()=>V);return{CryptoBoxErrorCodes:u}},void 0,import.meta.url);throw Object.assign(new Error(`Address mismatch: requested ${t.address} but token is for ${r.address}`),{code:o.ADDRESS_MISMATCH})}const a=await this.getKeypairForWallet(r.walletId,r.address,r.patternKey);let c;switch(t.action){case"asymmetricEncrypt":c=await this.executeAsymmetricEncrypt(t.params,a);break;case"sign":c=await this.executeSign(t.params,a);break;default:throw new Error(`Unknown action: ${t.action}`)}return{...c,address:r.address}}async getKeypairForWallet(t,n,s){try{const r=await Tt.getMnemonic(t,s),a=ke(r),c=n.charAt(0);if(ve(a.publicKey,c)!==n)throw new Error(`Address mismatch: token address ${n} does not match wallet`);return a}catch(r){throw r instanceof Error&&r.message.includes("Address mismatch")?r:new Error(`Failed to get keypair for wallet ${t}: invalid patternKey or wallet not found`)}}normalizePublicKey(t){if(typeof t=="string")return t;if(t&&typeof t=="object"&&"type"in t&&"data"in t){const n=t;if(n.type==="Buffer"&&Array.isArray(n.data))return n.data.map(s=>s.toString(16).padStart(2,"0")).join("")}if(Array.isArray(t)||t instanceof Uint8Array)return Array.from(t).map(n=>n.toString(16).padStart(2,"0")).join("");throw new Error(`Invalid publicKey format: ${typeof t}`)}async executeAsymmetricEncrypt(t,n){const s=Nt(this.normalizePublicKey(t.recipientPublicKey)),r=new TextEncoder().encode(t.data),a=await _(()=>import("./nacl-fast-BTo29pIj.js").then(h=>h.n),__vite__mapDeps([12,5,2,6,13]),import.meta.url),c=await _(()=>import("./ed2curve-BZxqY6ge.js").then(h=>h.e),__vite__mapDeps([14,5,2,6,13]),import.meta.url),o=c.convertPublicKey(s),u=c.convertSecretKey(n.secretKey);if(!o||!u)throw new Error("Failed to convert Ed25519 keys to X25519");const p=new Uint8Array(24),d=a.box(r,p,o,u);return{result:N(d),publicKey:N(n.publicKey)}}async executeSign(t,n){const s=new TextEncoder().encode(t.data),r=Pt(s,n.secretKey);return{result:N(r),publicKey:N(n.publicKey)}}}const ss=new ns,rs={"5min":300*1e3,"30min":1800*1e3,"2hour":7200*1e3,"1day":1440*60*1e3},as=["5min","30min","2hour","1day"],E={TOKEN_NOT_FOUND:4100,MINIAPP_MISMATCH:4101,TOKEN_EXPIRED:4102,ACTION_NOT_PERMITTED:4103,INVALID_SESSION_SECRET:4104,ADDRESS_MISMATCH:4105,USER_REJECTED:4001,INTERNAL_ERROR:-32603},is={asymmetricEncrypt:{name:"非对称加密",description:"使用您的私钥进行非对称加密"},sign:{name:"数据签名",description:"使用您的私钥进行签名"}},os={"5min":"5 分钟","30min":"30 分钟","2hour":"2 小时","1day":"1 天"},V=Object.freeze(Object.defineProperty({__proto__:null,CRYPTO_ACTION_LABELS:is,CryptoBoxErrorCodes:E,TOKEN_DURATION_LABELS:os,TOKEN_DURATION_MS:rs,TOKEN_DURATION_OPTIONS:as},Symbol.toStringTag,{value:"Module"}));let z=null;function Wr(e){z=e}const cs=async(e,t)=>{const n=e;if(!n?.actions||!n?.duration||!n?.address)throw Object.assign(new Error("Missing required parameters: actions, duration, address"),{code:E.INTERNAL_ERROR});const s=["asymmetricEncrypt","sign"];for(const d of n.actions)if(!s.includes(d))throw Object.assign(new Error(`Invalid action: ${d}`),{code:E.INTERNAL_ERROR});if(!z)throw Object.assign(new Error("Crypto authorize dialog not available"),{code:E.INTERNAL_ERROR});const r=z(t.appId);if(!r)throw Object.assign(new Error("Crypto authorize dialog not available"),{code:E.INTERNAL_ERROR});const a=await r({actions:n.actions,duration:n.duration,address:n.address,chainId:n.chainId,app:{name:t.appName,icon:t.appIcon}});if(!a.approved||!a.patternKey||!a.walletId)throw Object.assign(new Error("User rejected"),{code:E.USER_REJECTED});const c=a.selectedDuration||n.duration;await T.initialize();const{token:o,sessionSecret:u}=await T.createToken({miniappId:t.appId,walletId:a.walletId,address:n.address,actions:n.actions,duration:c,patternKey:a.patternKey});return{tokenId:o.tokenId,sessionSecret:u,expiresAt:o.expiresAt,grantedActions:o.actions,address:o.address}},ls=async(e,t)=>{const n=e;if(!n?.tokenId||!n?.sessionSecret||!n?.action||!n?.params)throw Object.assign(new Error("Missing required parameters: tokenId, sessionSecret, action, params"),{code:E.INTERNAL_ERROR});return await T.initialize(),await ss.execute(n,t.appId)},ds=async(e,t)=>{const n=e;if(!n?.tokenId||!n?.sessionSecret)throw Object.assign(new Error("Missing required parameters: tokenId, sessionSecret"),{code:E.INTERNAL_ERROR});await T.initialize();const s=await T.getTokenInfo(n.tokenId,n.sessionSecret,t.appId);return{valid:s.valid,address:s.address,expiresAt:s.expiresAt,actions:s.actions,invalidReason:s.invalidReason}};let Re=!1;function us(){Re||(Re=!0,g.registerHandler("bio_connect",en),g.registerHandler("bio_closeSplashScreen",Zt),g.registerHandler("bio_requestAccounts",tn),g.registerHandler("bio_accounts",nn),g.registerHandler("bio_selectAccount",sn),g.registerHandler("bio_pickWallet",rn),g.registerHandler("bio_chainId",an),g.registerHandler("bio_getBalance",on),g.registerHandler("bio_signMessage",cn),g.registerHandler("bio_signTypedData",ln),g.registerHandler("bio_createTransaction",mn),g.registerHandler("bio_signTransaction",An),g.registerHandler("bio_sendTransaction",un),g.registerHandler("bio_destroyAsset",fn),g.registerHandler("bio_requestCryptoToken",cs),g.registerHandler("bio_cryptoExecute",ls),g.registerHandler("bio_getCryptoTokenInfo",ds),xn((e,t)=>g.registerHandler(e,t)),Zn((e,t)=>g.registerHandler(e,t)))}us();function ee(){return g}const te=new Map,q=new Set;function W(e,t){const n=`${e}:${t}`;return te.get(n)??null}function tt(e){return q.add(e),()=>q.delete(e)}function nt(){q.forEach(e=>e())}const ne=new Map,se=new Map,re=new Map,ae=new Map;let st=null,rt=null;const ie=new Map,oe=new Map,D=new Map;function ps(e,t){ne.set(e,t)}function gs(e,t){se.set(e,t)}function fs(e){ne.delete(e),se.delete(e)}function ce(e){return ne.get(e)??null}function hs(e){return se.get(e)??null}function ms(e,t){re.set(e,t)}function ws(e){re.delete(e)}function As(e){return re.get(e)??null}function Ss(e,t){ae.set(e,t)}function Es(e){ae.delete(e)}function ys(e){return ae.get(e)??null}function _s(e){st=e}function bs(){return st}function Rs(e){rt=e}function Ts(){return rt}function at(e,t){ie.set(e,t)}function it(e){ie.delete(e)}function le(e){return ie.get(e)??null}function ot(e){const t=le(e);if(!t)return null;const n=t.closest(".swiper-slide");if(n&&!n.classList.contains("swiper-slide-active"))return null;const s=t.getBoundingClientRect();return s.width<=0||s.height<=0?null:s}function Is(e,t){oe.set(e,t)}function Os(e){oe.delete(e)}function Ds(e){return oe.get(e)??null}function ks(e,t,n){const s=D.get(e)??new Map;s.set(t,n),D.set(e,s);const r=`${e}:${t}`;te.set(r,"ready"),nt()}function vs(e,t){const n=D.get(e);if(!n)return;n.delete(t),n.size===0&&D.delete(e);const s=`${e}:${t}`;te.set(s,"lost"),nt()}function ct(e,t){return D.get(e)?.get(t)??null}function lt(e,t){const n=ct(e,t);if(!n)return null;const s=n.closest(".swiper-slide");if(s&&!s.classList.contains("swiper-slide-active"))return null;const r=n.getBoundingClientRect();return r.width<=0||r.height<=0?null:r}function Ns(e){at("stack",e)}function Ps(){it("stack")}function Ms(){return le("stack")}function Cs(){return ot("stack")}async function js(){return _(()=>Promise.resolve().then(()=>wr),void 0,import.meta.url)}function Us(){Oe.useEffect(()=>{js().then(({miniappRuntimeStore:e,activateApp:t})=>{const{activeAppId:n}=e.state;n&&t(n)})})}function Ls(e,t){return Oe.useSyncExternalStore(tt,()=>W(e,t),()=>W(e,t))}const x=O.t.bind(O),xs={apps:new Map,visualConfig:Ne,activeAppId:null,focusedAppId:null,presentations:new Map,zOrderSeed:1,isStackViewOpen:!1,maxBackgroundApps:4};function dt(e){const t=l.state.apps.get(e);if(!t)return;const n=t.containerHandle?.getIframe()??t.iframeRef;n&&ee().attach(n,e,t.manifest.name,t.manifest.permissions??[])}function Hs(e,t,n){const s=t.getIframe();s&&(ee().attach(s,e,n.name,n.permissions??[]),Ks(s))}function Bs(){const e=document.createElement("div");e.style.cssText="position:fixed;top:env(safe-area-inset-top,0px);visibility:hidden;",document.body.appendChild(e);const t=e.offsetTop;return document.body.removeChild(e),Math.max(t,8)+32+8}function Ks(e){const t=Bs(),s={type:"keyapp:context-update",payload:{theme:{colorMode:document.documentElement.classList.contains("dark")?"dark":"light"},env:{platform:"web",safeAreaInsets:{top:t,bottom:0,left:0,right:0}}}};e.contentWindow?.postMessage(s,"*")}const l=new Ie(xs);function ut(e){l.setState(t=>({...t,visualConfig:Lt(t.visualConfig,e)}))}function Vs(e){ut({motion:{timeScale:e}})}function zs(){l.setState(e=>({...e,visualConfig:Ne}))}const $=new Set;function y(e){$.forEach(t=>t(e))}let Te=0;function pt(e,t){return Te+=1,{id:`${e}:${t}:${Date.now()}:${Te}`,kind:e,status:"requested",startedAt:Date.now()}}function qs(e){const t=e.splashScreen;return t?typeof t=="object"&&typeof t.timeout=="number"?t.timeout:5e3:null}function Ws(e,t){if(!e||e==="preparing"){if(t==="launching")return"opening";if(t==="splash")return"splash";if(t==="active")return"opened"}return e==="launching"&&t==="splash"?"splash":(e==="launching"||e==="splash")&&t==="active"?"opened":e==="active"&&t==="background"?"backgrounding":e==="background"&&t==="active"?"foregrounding":t==="closing"?"closing":t==="preparing"?"closed":t==="launching"?"opening":t==="splash"?"splash":t==="active"?"opened":t==="background"?"backgrounded":"closed"}function k(e,t){l.setState(n=>{const s=n.apps.get(e);if(!s)return n;const r=Ws(s.state,t),a=new Map(n.apps);return a.set(e,{...s,state:t,flow:r}),{...n,apps:a}}),y({type:"app:state-change",appId:e,state:t})}function $s(e,t){l.setState(n=>{const s=n.apps.get(e);if(!s||s.processStatus===t)return n;const r=new Map(n.apps);return r.set(e,{...s,processStatus:t}),{...n,apps:r}})}function Fs(e,t){l.setState(n=>{const s=n.apps.get(e);if(!s||s.readiness===t)return n;const r=new Map(n.apps);return r.set(e,{...s,readiness:t}),{...n,apps:r}})}function gt(e){Fs(e,"ready");const t=l.state.apps.get(e);t&&!t.manifest.splashScreen&&(t.state==="launching"||t.state==="splash")&&U(e)}function Js(e){switch(e){case"opening":return"opened";case"backgrounding":return"backgrounded";case"foregrounding":return"opened";default:return e}}function Gs(e){l.setState(t=>{const n=t.apps.get(e);if(!n)return t;const s=Js(n.flow);if(s===n.flow)return t;const r=new Map(t.apps);return r.set(e,{...n,flow:s}),{...t,apps:r}})}const Ys={launchToSplash:100},M=new Map,F=new Map,J=new Map,Xs=3e4,Zs=2500,G=new Map;function R(e){const t=G.get(e);t&&(t.cancelled=!0,t.rafId!==null&&cancelAnimationFrame(t.rafId),G.delete(e))}function Qs(e){if(!e)return!1;const t=e.getBoundingClientRect();return t.width>0&&t.height>0}function er(e){return e.containerHandle?.isConnected()??!1}function C(e){const t=F.get(e);t&&(clearTimeout(t),F.delete(e))}function de(e,t,n){l.setState(s=>{const a=s.presentations.get(e)??{appId:e,desktop:t,state:"hidden",zOrder:s.zOrderSeed,transitionId:null,transitionKind:null},c={...a,...n,appId:e,desktop:n.desktop??a.desktop},o=new Map(s.presentations);return o.set(e,c),{...s,presentations:o}})}function ft(e){l.setState(t=>{const n=t.presentations.get(e),s=t.zOrderSeed+1,r=new Map(t.presentations);return n&&r.set(e,{...n,zOrder:s}),{...t,activeAppId:e,focusedAppId:e,presentations:r,zOrderSeed:s}})}function tr(e,t){const n=l.state.presentations.get(e);n&&(n.transitionKind!=="present"||n.transitionId!==t||de(e,n.desktop,{state:"presented",transitionId:null,transitionKind:null}))}function nr(e,t){const n=l.state.presentations.get(e);n&&(n.transitionKind!=="dismiss"||n.transitionId!==t||j(e))}function ue(e){C(e),gt(e),U(e)}function H(e,t){R(e);const n=l.state.apps.get(e);n?.containerHandle&&n.containerHandle.destroy(),l.setState(s=>{const r=new Map(s.apps);r.delete(e);const a=new Map(s.presentations);return a.delete(e),{...s,apps:r,presentations:a,activeAppId:s.activeAppId===e?null:s.activeAppId,focusedAppId:s.focusedAppId===e?null:s.focusedAppId}}),_t.show({message:t,duration:2e3})}function sr(e,t){if(k(e,"launching"),pe(e),t){const n=setTimeout(()=>{const s=l.state.apps.get(e);if(!s||s.state!=="launching")return;k(e,"splash"),C(e);const r=qs(s.manifest);r!==null&&F.set(e,setTimeout(()=>{const a=l.state.apps.get(e);a&&a.state==="splash"&&ue(e)},r))},Ys.launchToSplash);M.set(e,[n]);return}M.set(e,[])}function rr(e,t,n){R(e);const s={cancelled:!1,rafId:null};G.set(e,s);const r=performance.now(),a=()=>{if(s.cancelled)return;const c=l.state.apps.get(e);if(!c||c.state!=="preparing"){R(e);return}const o=Qs(ce(e)),u=!!lt(t,e),p=er(c);if(o&&u&&p){R(e),sr(e,n);return}if(performance.now()-r>Zs){u?o?H(e,x("error:miniapp.launchFailed.containerNotReady")):H(e,x("error:miniapp.launchFailed.iconNotReady")):H(e,x("error:miniapp.launchFailed.stayOnDesktop"));return}s.rafId=requestAnimationFrame(a)};s.rafId=requestAnimationFrame(a)}function pe(e){const t=M.get(e);t&&(t.forEach(n=>clearTimeout(n)),M.delete(e))}function ht(e){const t=J.get(e);t&&(clearTimeout(t),J.delete(e))}function j(e){pe(e),ht(e),C(e),R(e),l.setState(t=>{const n=t.apps.get(e);if(!n)return t;n.containerHandle&&n.containerHandle.destroy();const s=new Map(t.apps);s.delete(e);const r=new Map(t.presentations);return r.delete(e),{...t,apps:s,presentations:r,activeAppId:t.activeAppId===e?null:t.activeAppId,focusedAppId:t.focusedAppId===e?null:t.focusedAppId}}),l.state.apps.size===0&&ee().detach()}function mt(e){ue(e)}function wt(e,t,n){const r=l.state.apps.get(e);if(r){dt(e);const d=r.manifest.targetDesktop??"stack";return de(e,d,{state:"presented",transitionId:null,transitionKind:null}),ft(e),U(e),r}const a=!!t.splashScreen,c=t.runtime??"iframe",o={appId:e,manifest:t,state:"preparing",flow:"closed",ctx:{capsuleTheme:t.capsuleTheme??"auto"},processStatus:"loading",readiness:"notReady",launchedAt:Date.now(),lastActiveAt:Date.now(),containerType:c,containerHandle:null,iframeRef:null,iconRef:ce(e)};Bt(c,{appId:e,url:t.url,mountTarget:document.body,contextParams:n,wujieConfig:t.wujieConfig,onLoad:()=>{$s(e,"loaded"),t.splashScreen||gt(e)}}).then(d=>{o.containerHandle=d,d.type==="iframe"&&(o.iframeRef=d.element),Hs(e,d,t)});const u=t.targetDesktop??"stack",p=pt("present",e);return l.setState(d=>{const h=d.zOrderSeed+1,A=new Map(d.apps);A.set(e,o);const w=new Map(d.presentations);return w.set(e,{appId:e,desktop:u,state:"presenting",zOrder:h,transitionId:p.id,transitionKind:"present"}),{...d,apps:A,presentations:w,activeAppId:e,focusedAppId:e,zOrderSeed:h}}),y({type:"app:launch",appId:e,manifest:t}),rr(e,u,a),o}function ar(e,t,n){return wt(e,t,n)}function U(e){const t=l.state,n=t.apps.get(e);n&&n.state!=="preparing"&&(t.activeAppId&&t.activeAppId!==e&&At(t.activeAppId),n.containerHandle&&n.state==="background"&&n.containerHandle.moveToForeground(),k(e,"active"),dt(e),l.setState(s=>{const r=new Map(s.apps),a=r.get(e);return a&&r.set(e,{...a,lastActiveAt:Date.now()}),{...s,apps:r,activeAppId:e,focusedAppId:e}}),y({type:"app:activate",appId:e}))}function At(e){const t=l.state,n=t.apps.get(e);n&&n.state!=="preparing"&&(n.containerHandle&&n.containerHandle.moveToBackground(),k(e,"background"),ir(t.maxBackgroundApps),y({type:"app:deactivate",appId:e}))}function ir(e){const t=l.state,n=Array.from(t.apps.values()).filter(s=>s.appId!==t.activeAppId&&s.state==="background").toSorted((s,r)=>s.lastActiveAt-r.lastActiveAt);for(;n.length>e;){const s=n.shift();s?.containerHandle&&(s.containerHandle.destroy(),s.containerHandle=null)}}function ge(e){const n=l.state.apps.get(e);if(!n)return;pe(e),ht(e),R(e),k(e,"closing"),C(e);const s=n.manifest.targetDesktop??"stack",r=pt("dismiss",e);de(e,s,{state:"dismissing",transitionId:r.id,transitionKind:"dismiss"}),J.set(e,setTimeout(()=>{const a=l.state.presentations.get(e);a&&(a.transitionKind!=="dismiss"||a.transitionId!==r.id||j(e))},Xs)),y({type:"app:close",appId:e})}function or(e){ge(e)}function cr(e,t){const s=l.state.apps.get(e);if(!s)return;const r={...s.ctx,...t};l.setState(a=>{const c=new Map(a.apps),o=c.get(e);return o&&c.set(e,{...o,ctx:r}),{...a,apps:c}}),y({type:"app:ctx-change",appId:e,ctx:r})}function lr(){l.state.apps.forEach((t,n)=>{ge(n),j(n)}),yt()}function dr(){l.setState(e=>({...e,isStackViewOpen:!0})),y({type:"stack-view:open"})}function ur(){l.setState(e=>({...e,isStackViewOpen:!1})),y({type:"stack-view:close"})}function pr(e){return $.add(e),()=>$.delete(e)}function gr(){return Array.from(l.state.apps.values())}function fr(){const e=l.state;return e.activeAppId?e.apps.get(e.activeAppId)??null:null}function hr(){return l.state.apps.size>0}const mr={getApps:e=>Array.from(e.apps.values()),getVisualConfig:e=>e.visualConfig,getActiveApp:e=>e.activeAppId?e.apps.get(e.activeAppId)??null:null,getFocusedAppId:e=>e.focusedAppId??e.activeAppId,getFocusedApp:e=>{const t=e.focusedAppId??e.activeAppId;return t?e.apps.get(t)??null:null},getPresentations:e=>Array.from(e.presentations.values()).sort((t,n)=>t.zOrder-n.zOrder),getPresentation:(e,t)=>e.presentations.get(t)??null,hasPresentations:e=>e.presentations.size>0,hasRunningApps:e=>e.apps.size>0,hasRunningStackApps:e=>Array.from(e.apps.values()).some(t=>(t.manifest.targetDesktop??"stack")==="stack"),isStackViewOpen:e=>e.isStackViewOpen,getBackgroundApps:e=>Array.from(e.apps.values()).filter(t=>t.state==="background"),isLaunchOverlayVisible:e=>{const t=e.focusedAppId??e.activeAppId?e.apps.get(e.focusedAppId??e.activeAppId):null;return t?.state==="launching"||t?.state==="splash"},isShowingSplash:e=>(e.focusedAppId??e.activeAppId?e.apps.get(e.focusedAppId??e.activeAppId):null)?.state==="splash",isAnimating:e=>{const t=e.focusedAppId??e.activeAppId?e.apps.get(e.focusedAppId??e.activeAppId):null;return t?.state==="launching"||t?.state==="splash"||t?.state==="closing"}},wr=Object.freeze(Object.defineProperty({__proto__:null,activateApp:U,closeAllApps:lr,closeApp:ge,closeStackView:ur,deactivateApp:At,didDismiss:nr,didPresent:tr,dismissSplash:mt,finalizeCloseApp:j,getActiveApp:fr,getDesktopAppSlotRect:lt,getDesktopAppSlotRef:ct,getDesktopContainerRef:le,getDesktopGridHostRef:Ds,getDesktopRect:ot,getIconInnerRef:hs,getIconRef:ce,getRunningApps:gr,getSlotStatus:W,getSplashBgRef:As,getSplashIconRef:ys,getStackContainerRef:Ms,getStackRect:Cs,getWindowInnerRef:Ts,getWindowRef:bs,hasRunningApps:hr,launchApp:wt,miniappRuntimeSelectors:mr,miniappRuntimeStore:l,openStackView:dr,registerDesktopAppSlotRef:ks,registerDesktopContainerRef:at,registerDesktopGridHostRef:Is,registerIconInnerRef:gs,registerIconRef:ps,registerSplashBgRef:ms,registerSplashIconRef:Ss,registerStackContainerRef:Ns,registerWindowInnerRef:Rs,registerWindowRef:_s,requestDismiss:or,requestDismissSplash:ue,requestFocus:ft,requestPresent:ar,resetMiniappVisualConfig:zs,setMiniappMotionTimeScale:Vs,setMiniappVisualConfig:ut,settleFlow:Gs,subscribe:pr,subscribeSlotStatus:tt,unregisterDesktopAppSlotRef:vs,unregisterDesktopContainerRef:it,unregisterDesktopGridHostRef:Os,unregisterIconRef:fs,unregisterSplashBgRef:ws,unregisterSplashIconRef:Es,unregisterStackContainerRef:Ps,updateAppContext:cr,useMiniappVisibilityRestore:Us,useSlotStatus:Ls},Symbol.toStringTag,{value:"Module"}));export{Mr as $,ue as A,nr as B,Is as C,Ne as D,Os as E,ks as F,vs as G,Ft as H,Le as I,Hr as J,is as K,os as L,us as M,ee as N,Cr as O,jr as P,Ur as Q,Lr as R,xr as S,as as T,Br as U,Vr as V,zr as W,qr as X,Kr as Y,Wr as Z,Pr as _,Nr as a,mr as b,lr as c,l as d,f as e,at as f,vr as g,it as h,ps as i,gs as j,fs as k,wt as l,Lt as m,Ns as n,dr as o,Ps as p,Ls as q,zs as r,Vs as s,ct as t,Us as u,tr as v,Gs as w,_s as x,Rs as y,or as z};
