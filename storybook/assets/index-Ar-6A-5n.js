import{g as Zt,Z as Qt,o as N,c as k,a as G,n as w,s as c,l as at,h as te,i as m,u as Y,r as V,b as _,j as vt}from"./schemas-BX8BzOgD.js";import{g as ee,f as se,e as q,l as ne,t as ae,m as W,s as M,n as it,o as oe,p as ct,q as lt}from"./chain-config-DqVXGLIz.js";import{A as p}from"./amount-BQsqQYGO.js";import{o as $,h as x,G as B,c as re,p as ie,a as ce,X as It,Y as ut}from"./bioforest-uXX5qE5N.js";import"./index-D0E7N0oa.js";import{_ as Q}from"./preload-helper-PPVm8Dsz.js";function le(r){return Zt(Qt,r)}class ue{getConfig(t){return ee.getChainById(se.state,t)}getApi(t){return this.getConfig(t)?.apis??[]}getApiByType(t,e){return this.getApi(t).find(n=>n.type===e)??null}getApiByPattern(t,e){const s=this.getApi(t),n=new RegExp("^"+e.replace("*",".*")+"$");return s.find(a=>n.test(a.type))??null}getRpcUrl(t){return this.getApiByPattern(t,"*-rpc")?.endpoint??""}getBiowalletApi(t){const e=this.getApiByPattern(t,"biowallet-*");if(!e)return null;const s=e.config?.path??t;return{endpoint:e.endpoint,path:s}}getEtherscanApi(t){return(this.getApiByPattern(t,"etherscan-*")??this.getApiByPattern(t,"*scan-*"))?.endpoint??null}getMempoolApi(t){return this.getApiByPattern(t,"mempool-*")?.endpoint??null}getDecimals(t){return this.getConfig(t)?.decimals??18}getSymbol(t){return this.getConfig(t)?.symbol??""}getExplorerUrl(t){return this.getConfig(t)?.explorer?.url??null}getTxQueryUrl(t,e){const n=this.getConfig(t)?.explorer?.queryTx;return n?n.replace(":hash",e).replace(":signature",e):null}getAddressQueryUrl(t,e){const n=this.getConfig(t)?.explorer?.queryAddress;return n?n.replace(":address",e):null}}const y=new ue;G(["native","token","nft"]);const St=G(["transfer","swap","exchange","approve","revoke","signature","stake","unstake","claim","mint","burn","gift","grab","trust","signFor","emigrate","immigrate","issueAsset","increaseAsset","destroyAsset","issueEntity","destroyEntity","locationName","dapp","certificate","mark","contract","unknown"]),At=G(["in","out","self"]),he=G(["pending","confirmed","failed"]),de=N({assetType:at("native"),value:c(),symbol:c(),decimals:w()}),me=N({assetType:at("token"),value:c(),symbol:c(),decimals:w(),contractAddress:c(),name:c().optional(),logoUrl:c().optional()}),fe=N({assetType:at("nft"),tokenId:c(),contractAddress:c(),name:c().optional(),imageUrl:c().optional(),collection:c().optional()}),kt=te("assetType",[de,me,fe]),pe=N({value:c(),symbol:c(),decimals:w()}),ge=N({address:c(),method:c().optional(),methodId:c().optional()}),tt=N({hash:c(),from:c(),to:c(),timestamp:w(),status:he,blockNumber:le().optional(),action:St,direction:At,assets:k(kt).min(1),fee:pe.optional(),contract:ge.optional()});class Nt extends Error{source;chainId;method;issues;constructor(t){super(`[InvalidData] ${t.source}:${t.chainId}:${t.method}`,{cause:t.cause instanceof Error?t.cause:void 0}),this.name="InvalidDataError",this.source=t.source,this.chainId=t.chainId,this.method=t.method,this.issues=t.issues??[]}}const ye=new Set(["isValidAddress","normalizeAddress"]),we=new Set(["getNativeBalance","getTokenBalances","getTransactionHistory","getTransaction","getTransactionStatus","getBlockHeight"]);class _t{chainId;providers;constructor(t,e){this.chainId=t,this.providers=e}supports(t){return this.providers.some(e=>typeof e[t]=="function")}getMethod(t){const e=this.providers.filter(o=>typeof o[t]=="function");if(e.length===0)return;const s=e[0],n=s[t];return typeof n!="function"?void 0:ye.has(t)?n.bind(s):(async(...o)=>{let i=null;for(const l of e){const u=l[t];if(typeof u=="function")try{return await u.apply(l,o)}catch(h){i=h}}if(we.has(t))return this.getReadDefault(t);throw i instanceof Error?i:new Error("All providers failed")})}getReadDefault(t){switch(t){case"getNativeBalance":{const e=y.getDecimals(this.chainId),s=y.getSymbol(this.chainId);return{amount:p.zero(e,s),symbol:s}}case"getTokenBalances":return[];case"getTransactionHistory":return[];case"getTransaction":return null;case"getTransactionStatus":return{status:"pending",confirmations:0,requiredConfirmations:1};case"getBlockHeight":return 0n;default:return null}}get supportsNativeBalance(){return this.supports("getNativeBalance")}get supportsTokenBalances(){return this.supports("getTokenBalances")}get supportsTransactionHistory(){return this.supports("getTransactionHistory")}get supportsTransaction(){return this.supports("getTransaction")}get supportsBlockHeight(){return this.supports("getBlockHeight")}get supportsFeeEstimate(){return this.supports("estimateFee")}get supportsBuildTransaction(){return this.supports("buildTransaction")}get supportsSignTransaction(){return this.supports("signTransaction")}get supportsBroadcast(){return this.supports("broadcastTransaction")}get supportsFullTransaction(){return this.supportsBuildTransaction&&this.supportsSignTransaction&&this.supportsBroadcast}get supportsDeriveAddress(){return this.supports("deriveAddress")}get supportsAddressValidation(){return this.supports("isValidAddress")}get getNativeBalance(){return this.getMethod("getNativeBalance")}get getTokenBalances(){return this.getMethod("getTokenBalances")}get getTransactionHistory(){const t=this.getMethod("getTransactionHistory");if(t)return async(e,s)=>{const n=await t(e,s);if(!Array.isArray(n))return console.warn("[ChainProvider] Invalid transaction history payload (not array)",{chainId:this.chainId,method:"getTransactionHistory"}),[];const a=[];let o=0,i=null;for(const l of n){const u=tt.safeParse(l);u.success?a.push(u.data):(o+=1,i||(i=u.error.issues[0]))}return o>0&&console.warn("[ChainProvider] Dropped invalid transactions from history",{chainId:this.chainId,method:"getTransactionHistory",invalidCount:o,totalCount:n.length,firstIssue:i}),a}}get getTransaction(){const t=this.getMethod("getTransaction");if(t)return async e=>{const s=await t(e);if(s==null)return null;const n=tt.safeParse(s);if(!n.success)throw new Nt({source:"provider",chainId:this.chainId,method:"getTransaction",issues:n.error.issues});return n.data}}get getTransactionStatus(){return this.getMethod("getTransactionStatus")}get getBlockHeight(){return this.getMethod("getBlockHeight")}get estimateFee(){return this.getMethod("estimateFee")}get buildTransaction(){return this.getMethod("buildTransaction")}get signTransaction(){return this.getMethod("signTransaction")}get broadcastTransaction(){return this.getMethod("broadcastTransaction")}get deriveAddress(){return this.getMethod("deriveAddress")}get deriveAddresses(){return this.getMethod("deriveAddresses")}get isValidAddress(){return this.getMethod("isValidAddress")}get normalizeAddress(){return this.getMethod("normalizeAddress")}getProviders(){return this.providers}getProviderByType(t){return this.providers.find(e=>e.type===t)}}const z=new Map,et=new Map,J=new Map,ht=new Map;function be(r,t){const e=(t?.method??"GET").toUpperCase(),s=typeof t?.body=="string"?t.body:"";return`${e}:${r}:${s}`}function Te(r,t){for(const e of t){const s=J.get(e)??new Set;s.add(r),J.set(e,s)}}function ve(r){for(const t of r){const e=J.get(t);if(e){for(const s of e)et.delete(s);J.delete(t)}}}function C(r){const t=ht.get(r.key);ht.set(r.key,r.value),t!==void 0&&t!==r.value&&ve(r.invalidateTags)}async function A(r,t,e){const s=e?.ttlMs??0,n=e?.cacheKey??be(r,t);if(s>0){const i=et.get(n);if(i&&i.expiresAt>Date.now())return i.value}const a=z.get(n);if(a)return await a;const o=(async()=>{const i=await fetch(r,t);if(!i.ok)throw new Error(`HTTP ${i.status}`);return await i.json()})();z.set(n,o);try{const i=await o;return s>0&&(et.set(n,{value:i,expiresAt:Date.now()+s}),e?.tags?.length&&Te(n,e.tags)),i}finally{z.delete(n)}}const Ie={ethereum:1,binance:56,"ethereum-sepolia":11155111,"bsc-testnet":97},Se=m({hash:c(),from:c(),to:c(),value:c(),timeStamp:c(),isError:c(),blockNumber:c(),input:c().optional(),methodId:c().optional(),functionName:c().optional()}),Ae=m({hash:c(),from:c(),to:c(),value:c(),timeStamp:c(),blockNumber:c(),tokenSymbol:c(),tokenName:c(),tokenDecimal:c(),contractAddress:c()}),ke=m({status:c(),message:c(),result:Y()}),Ne=5;class Bt{type;endpoint;config;chainId;evmChainId;symbol;decimals;constructor(t,e){this.type=t.type,this.endpoint=t.endpoint,this.config=t.config,this.chainId=e,this.evmChainId=Ie[e]??1,this.symbol=y.getSymbol(e),this.decimals=y.getDecimals(e)}get supportsTransactionHistory(){return!0}async getTransactionHistory(t,e=20){const s=e*Ne,[n,a]=await Promise.all([this.fetchNativeTransactions(t,s),this.fetchTokenTransactions(t,s)]),o=t.toLowerCase();return this.aggregateByHash(n,a,o).sort((l,u)=>u.timestamp-l.timestamp).slice(0,e)}aggregateByHash(t,e,s){const n=new Map;for(const i of e){const l=i.hash.toLowerCase(),u=n.get(l)??[];u.push(i),n.set(l,u)}const a=[],o=new Set;for(const i of t){const l=i.hash.toLowerCase();if(o.has(l))continue;o.add(l);const u=n.get(l)??[],h=this.buildAggregatedTransaction(i,u,s);a.push(h)}for(const[i,l]of n){if(o.has(i))continue;o.add(i);const u=this.buildOrphanTokenTransaction(l,s);a.push(u)}return a}buildOrphanTokenTransaction(t,e){const s=this.selectPrimaryToken(t,e),n=this.getDirection(s.from,s.to,e),a=t.slice(0,3).map(o=>({assetType:"token",value:o.value,symbol:o.tokenSymbol,decimals:parseInt(o.tokenDecimal,10),contractAddress:o.contractAddress,name:o.tokenName}));return{hash:s.hash,from:s.from,to:s.to,timestamp:parseInt(s.timeStamp,10)*1e3,status:"confirmed",blockNumber:BigInt(s.blockNumber),action:"transfer",direction:n,assets:a}}buildAggregatedTransaction(t,e,s){const n=e.length>0,a=this.isContractCall(t),o=a?this.getMethodId(t):null;let i=this.detectAction(t);i==="contract"&&n&&(i="transfer");const l=this.selectPrimaryToken(e,s);let u,h;l?(u=l.from,h=l.to):(u=t.from,h=t.to);const d=this.getDirection(u,h,s),f=[];for(const g of e.slice(0,3))f.push({assetType:"token",value:g.value,symbol:g.tokenSymbol,decimals:parseInt(g.tokenDecimal,10),contractAddress:g.contractAddress,name:g.tokenName});return(t.value!=="0"||f.length===0)&&f.push({assetType:"native",value:t.value,symbol:this.symbol,decimals:this.decimals}),i==="swap"&&f.length>1&&f.sort((g,b)=>g.assetType==="token"&&b.assetType!=="token"?-1:g.assetType!=="token"&&b.assetType==="token"?1:0),{hash:t.hash,from:u,to:h,timestamp:parseInt(t.timeStamp,10)*1e3,status:t.isError==="0"?"confirmed":"failed",blockNumber:BigInt(t.blockNumber),action:i,direction:d,assets:f,contract:a?{address:t.to,method:t.functionName??void 0,methodId:o??void 0}:void 0}}selectPrimaryToken(t,e){if(t.length===0)return null;if(t.length===1)return t[0];const s=t.filter(a=>a.from.toLowerCase()===e||a.to.toLowerCase()===e);return(s.length>0?s:t).reduce((a,o)=>{const i=BigInt(a.value);return BigInt(o.value)>i?o:a})}async fetchNativeTransactions(t,e){const s=this.buildParams("txlist",t,e);return(await this.fetchApi(s,`etherscan:${this.type}:txlist:${t}:${e}`)).map(a=>Se.safeParse(a)).filter(a=>a.success).map(a=>a.data)}async fetchTokenTransactions(t,e){const s=this.buildParams("tokentx",t,e);return(await this.fetchApi(s,`etherscan:${this.type}:tokentx:${t}:${e}`)).map(a=>Ae.safeParse(a)).filter(a=>a.success).map(a=>a.data)}buildParams(t,e,s){const n=this.config?.apiKey??"",a=new URLSearchParams({module:"account",action:t,address:e,startblock:"0",endblock:"99999999",page:"1",offset:s.toString(),sort:"desc"});return this.endpoint.includes("etherscan.io/v2")&&a.set("chainid",this.evmChainId.toString()),n&&a.set("apikey",n),a}async fetchApi(t,e){const s=`${this.endpoint}?${t.toString()}`,n=t.get("address")??"",a=await A(s,void 0,{cacheKey:e,ttlMs:5*6e4,tags:n?[`txhistory:${this.chainId}:${n}`]:void 0}),o=ke.safeParse(a);if(!o.success)throw new Error("Invalid API response");const i=o.data.status,l=o.data.message.toLowerCase();if(i==="0"&&l.includes("no transactions"))return[];if(i!=="1")throw new Error("Upstream API error");const u=o.data.result;if(!Array.isArray(u))throw new Error("Invalid API result");return u}getDirection(t,e,s){const n=t.toLowerCase(),a=e.toLowerCase();return n===s&&a===s?"self":n===s?"out":"in"}detectAction(t){if(this.isContractCall(t)){const e=this.getMethodId(t);return e?{"0xa9059cbb":"transfer","0x095ea7b3":"approve","0x23b872dd":"transfer","0x38ed1739":"swap","0x7ff36ab5":"swap","0x18cbafe5":"swap","0xa694fc3a":"stake","0x2e1a7d4d":"unstake","0x3ccfd60b":"claim","0x4e71d92d":"claim","0x40c10f19":"mint","0x42966c68":"burn"}[e]??"contract":"contract"}return"transfer"}isContractCall(t){const e=t.input??"";return e!=="0x"&&e!=="0x0"&&e!=="0x00"&&e.length>2}getMethodId(t){const e=(t.methodId??"").toLowerCase();if(e&&e!=="0x"&&e!=="0x0"&&e!=="0x00"){if(e.startsWith("0x")&&e.length===10)return e;if(!e.startsWith("0x")&&e.length===8)return`0x${e}`}const s=(t.input??"").toLowerCase();return s.startsWith("0x")&&s.length>=10?s.slice(0,10):!s.startsWith("0x")&&s.length>=8?`0x${s.slice(0,8)}`:null}}function Et(r,t){return r.type.includes("etherscan")||r.type.includes("blockscout")||r.type.includes("scan")?new Bt(r,t):null}const _e=m({result:Y().optional(),error:m({message:c()}).optional()});class Ct{type;endpoint;config;chainId;symbol;decimals;constructor(t,e){this.type=t.type,this.endpoint=t.endpoint,this.config=t.config,this.chainId=e,this.symbol=y.getSymbol(e),this.decimals=y.getDecimals(e)}async rpc(t,e,s=[]){const n=JSON.stringify({jsonrpc:"2.0",id:1,method:t,params:s}),a=t==="eth_getBalance"||t==="eth_blockNumber",o=await A(this.endpoint,{method:"POST",headers:{"Content-Type":"application/json"},body:n},{cacheKey:`evm-rpc:${this.endpoint}:${t}:${JSON.stringify(s)}`,ttlMs:a?1e4:0}),i=_e.safeParse(o);if(!i.success)throw new Error("Invalid JSON-RPC response");if(i.data.error)throw new Error(i.data.error.message);const l=e.safeParse(i.data.result);if(!l.success)throw new Error("Invalid JSON-RPC result");return l.data}async getNativeBalance(t){const e=await this.rpc("eth_getBalance",c(),[t,"latest"]),s=BigInt(e);return{amount:p.fromRaw(s.toString(),this.decimals,this.symbol),symbol:this.symbol}}async getBlockHeight(){const t=await this.rpc("eth_blockNumber",c());return BigInt(t)}}function Rt(r,t){return r.type.endsWith("-rpc")&&(r.type.includes("ethereum")||r.type.includes("bsc"))?new Ct(r,t):null}const Be=m({assetNumber:c(),assetType:c()}),dt=m({success:_(),result:m({address:c(),assets:V(c(),V(c(),Be))}).optional()}),Ee=m({height:w(),signature:c(),transaction:m({type:c(),senderId:c(),recipientId:c().optional().default(""),timestamp:w(),asset:m({transferAsset:m({assetType:c(),amount:c()}).optional(),giftAsset:m({totalAmount:c(),assetType:c()}).optional(),grabAsset:m({transactionSignature:c()}).optional(),trustAsset:m({trustees:k(c()),numberOfSignFor:w(),assetType:c(),amount:c()}).optional(),signature:m({publicKey:c().optional()}).optional(),destroyAsset:m({assetType:c(),amount:c()}).optional(),issueEntity:m({entityId:c().optional()}).optional(),issueEntityFactory:m({factoryId:c().optional()}).optional()}).optional()})}),Ce=m({success:_(),result:m({trs:k(Ee),count:w()}).optional()}),mt=m({success:_(),result:m({height:w()}).optional()});class $t{type;endpoint;config;chainId;path;symbol;decimals;constructor(t,e){this.type=t.type,this.endpoint=t.endpoint,this.config=t.config,this.chainId=e,this.path=t.config?.path??e,this.symbol=y.getSymbol(e),this.decimals=y.getDecimals(e)}get baseUrl(){return`${this.endpoint}/wallet/${this.path}`}async getNativeBalance(t){const e=`${this.baseUrl}/address/asset`,s=await A(e,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({address:t})},{cacheKey:`biowallet:${this.path}:assets:${t}`,ttlMs:6e4,tags:[`balance:${this.chainId}:${t}`]}),n=dt.safeParse(s);if(!n.success||!n.data.success||!n.data.result)throw new Error("Upstream API error");for(const a of Object.values(n.data.result.assets))for(const o of Object.values(a))if(o.assetType===this.symbol)return C({key:`balance:${this.chainId}:${t}`,value:o.assetNumber,invalidateTags:[`txhistory:${this.chainId}:${t}`]}),{amount:p.fromRaw(o.assetNumber,this.decimals,this.symbol),symbol:this.symbol};return C({key:`balance:${this.chainId}:${t}`,value:"0",invalidateTags:[`txhistory:${this.chainId}:${t}`]}),{amount:p.zero(this.decimals,this.symbol),symbol:this.symbol}}async getTokenBalances(t){const e=`${this.baseUrl}/address/asset`,s=await A(e,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({address:t})},{cacheKey:`biowallet:${this.path}:assets:${t}`,ttlMs:6e4,tags:[`balance:${this.chainId}:${t}`]}),n=dt.safeParse(s);if(!n.success||!n.data.success||!n.data.result)throw new Error("Upstream API error");const a=[];for(const o of Object.values(n.data.result.assets))for(const i of Object.values(o)){const l=i.assetType===this.symbol;a.push({symbol:i.assetType,name:i.assetType,amount:p.fromRaw(i.assetNumber,this.decimals,i.assetType),isNative:l})}return a.sort((o,i)=>o.isNative&&!i.isNative?-1:!o.isNative&&i.isNative?1:i.amount.toNumber()-o.amount.toNumber()),a}async getTransactionHistory(t,e=20){const s=await A(`${this.baseUrl}/lastblock`,void 0,{cacheKey:`biowallet:${this.path}:lastblock`,ttlMs:1e4}),n=mt.safeParse(s);if(!n.success||!n.data.success||!n.data.result)throw new Error("Upstream API error");const a=n.data.result.height,o=await A(`${this.baseUrl}/transactions/query`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({maxHeight:a,address:t,limit:e})},{cacheKey:`biowallet:${this.path}:txs:${t}:${e}:${a}`,ttlMs:5*6e4,tags:[`txhistory:${this.chainId}:${t}`]}),i=Ce.safeParse(o);if(!i.success||!i.data.success||!i.data.result?.trs)throw new Error("Upstream API error");const l=t.toLowerCase();return i.data.result.trs.map(u=>{const h=u.transaction,d=this.detectAction(h.type),f=this.getDirection(h.senderId,h.recipientId,l),{value:g,assetType:b}=this.extractAssetInfo(h);return g===null?null:{hash:u.signature,from:h.senderId,to:h.recipientId,timestamp:h.timestamp*1e3,status:"confirmed",blockNumber:BigInt(u.height),action:d,direction:f,assets:[{assetType:"native",value:g,symbol:b,decimals:this.decimals}]}}).filter(u=>u!==null)}detectAction(t){const e={"AST-01":"transfer","AST-02":"transfer","AST-03":"destroyAsset","BSE-01":"signature","ETY-01":"issueEntity","ETY-02":"issueEntity","GFT-01":"gift","GFT-02":"gift","GRB-01":"grab","GRB-02":"grab","TRS-01":"trust","TRS-02":"trust","SGN-01":"signFor","SGN-02":"signFor","EMI-01":"emigrate","EMI-02":"emigrate","IMI-01":"immigrate","IMI-02":"immigrate","ISA-01":"issueAsset","ICA-01":"increaseAsset","DSA-01":"destroyAsset","ISE-01":"issueEntity","DSE-01":"destroyEntity","LNS-01":"locationName","DAP-01":"dapp","CRT-01":"certificate","MRK-01":"mark"},s=t.split("-");if(s.length>=4){const n=`${s[s.length-2]}-${s[s.length-1]}`;return e[n]??"unknown"}return"unknown"}getDirection(t,e,s){const n=t.toLowerCase(),a=e.toLowerCase();return a&&n===s&&a===s?"self":n===s?"out":"in"}extractAssetInfo(t){const e=t.asset;return e?.transferAsset?{value:e.transferAsset.amount,assetType:e.transferAsset.assetType}:e?.giftAsset?{value:e.giftAsset.totalAmount,assetType:e.giftAsset.assetType}:e?.trustAsset?{value:e.trustAsset.amount,assetType:e.trustAsset.assetType}:e?.grabAsset?{value:"0",assetType:this.symbol}:e?.destroyAsset?{value:e.destroyAsset.amount,assetType:e.destroyAsset.assetType}:e?.issueEntity||e?.issueEntityFactory?{value:"0",assetType:this.symbol}:e?.signature?{value:"0",assetType:this.symbol}:e?.destroyAsset?{value:e.destroyAsset.amount,assetType:e.destroyAsset.assetType}:e?.issueEntity||e?.issueEntityFactory?{value:"0",assetType:this.symbol}:e?.signature?{value:"0",assetType:this.symbol}:{value:null,assetType:this.symbol}}async getBlockHeight(){const t=await A(`${this.baseUrl}/lastblock`,void 0,{cacheKey:`biowallet:${this.path}:lastblock`,ttlMs:1e4}),e=mt.safeParse(t);if(!e.success||!e.data.success||!e.data.result)throw new Error("Upstream API error");return BigInt(e.data.result.height)}}function Pt(r,t){return r.type.startsWith("biowallet-")?new $t(r,t):null}const Re=m({success:_(),result:c()}),$e=m({hash:c(),from:c(),to:c(),value:c(),timeStamp:c(),blockNumber:c(),isError:c().optional()}),Pe=m({success:_(),result:m({status:c(),result:k($e)})});class xt{type;endpoint;decimals;symbol;chainId;constructor(t,e,s,n){this.type=t.type,this.endpoint=t.endpoint.replace(/\/$/,""),this.chainId=e,this.decimals=s,this.symbol=n}get supportsNativeBalance(){return!0}get supportsTransactionHistory(){return!0}async getNativeBalance(t){const e=`${this.endpoint}/balance?address=${t}`,s=await A(e,void 0,{cacheKey:`bscwallet:balance:${t}`,ttlMs:6e4,tags:[`balance:${this.chainId}:${t}`]}),n=Re.safeParse(s);if(!n.success||!n.data.success)throw new Error("Upstream API error");return C({key:`balance:${this.chainId}:${t}`,value:n.data.result,invalidateTags:[`txhistory:${this.chainId}:${t}`]}),{amount:p.fromRaw(n.data.result,this.decimals,this.symbol),symbol:this.symbol}}async getTransactionHistory(t,e=20){const s=`${this.endpoint}/trans/normal/history`,n=await A(s,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({address:t,page:1,offset:e})},{cacheKey:`bscwallet:txs:${t}:${e}`,ttlMs:5*6e4,tags:[`txhistory:${this.chainId}:${t}`]}),a=Pe.safeParse(n);if(!a.success||!a.data.success)throw new Error("Upstream API error");if(a.data.result.status!=="1")return[];const o=t.toLowerCase();return a.data.result.result.map(i=>{const l=i.from,u=i.to,h=this.getDirection(l,u,o);return{hash:i.hash,from:l,to:u,timestamp:Number(i.timeStamp)*1e3,status:i.isError==="1"?"failed":"confirmed",blockNumber:BigInt(i.blockNumber),action:"transfer",direction:h,assets:[{assetType:"native",value:i.value,symbol:this.symbol,decimals:this.decimals}]}})}getDirection(t,e,s){const n=t.toLowerCase(),a=e.toLowerCase();return n===s&&a===s?"self":n===s?"out":"in"}}function Ot(r,t){if(r.type!=="bscwallet-v1")return null;const e=y.getDecimals(t),s=y.getSymbol(t);return new xt(r,t,e,s)}const xe={BASE_URL:"./",DEV:!1,MODE:"production",PROD:!0,SSR:!1,STORYBOOK:"true"};var Oe={};function Ue(r){try{const t=xe?.[r];if(typeof t=="string"&&t.length>0)return t}catch{}try{const t=Oe?.[r];if(typeof t=="string"&&t.length>0)return t}catch{}}const De=m({balance:w().optional(),address:c().optional()}),Le=m({block_header:m({raw_data:m({number:w().optional()}).optional()}).optional()}),Me=m({txID:c(),raw_data:m({contract:k(m({parameter:m({value:m({amount:w().optional(),owner_address:c().optional(),to_address:c().optional()}).optional()}).optional(),type:c().optional()})).optional(),timestamp:w().optional()}).optional(),ret:k(m({contractRet:c().optional()})).optional()}),He=m({success:_(),data:k(Me).optional()}),Fe=m({transaction_id:c(),token_info:m({symbol:c(),address:c(),decimals:w(),name:c().optional()}),block_timestamp:w(),from:c(),to:c(),type:c(),value:c()}),Ke=m({success:_(),data:k(Fe).optional()}),je=5;class Ut{type;endpoint;config;chainId;symbol;decimals;constructor(t,e){this.type=t.type,this.endpoint=t.endpoint,this.config=t.config,this.chainId=e,this.symbol=y.getSymbol(e),this.decimals=y.getDecimals(e)}async api(t,e,s,n){const a=`${this.endpoint}${t}`,o={};s!==void 0&&(o["Content-Type"]="application/json");const i=this.config?.apiKeyEnv;if(typeof i=="string"&&i.length>0){const d=Ue(i);d&&(o["TRON-PRO-API-KEY"]=d)}const l=s!==void 0?{method:"POST",headers:o,body:JSON.stringify(s)}:{method:"GET",headers:o},u=await A(a,l,{cacheKey:`tron:${this.type}:${a}:${typeof l.body=="string"?l.body:""}`,ttlMs:n?.ttlMs??0,tags:n?.ttlMs?n?.tags:void 0}),h=e.safeParse(u);if(!h.success)throw new Error("Invalid API response");return h.data}async getNativeBalance(t){const s=(await this.api("/wallet/getaccount",De,{address:t,visible:!0},{ttlMs:6e4,tags:[`balance:${this.chainId}:${t}`]})).balance??0;return C({key:`balance:${this.chainId}:${t}`,value:s.toString(),invalidateTags:[`txhistory:${this.chainId}:${t}`]}),{amount:p.fromRaw(s.toString(),this.decimals,this.symbol),symbol:this.symbol}}async getBlockHeight(){const e=(await this.api("/wallet/getnowblock",Le,void 0,{ttlMs:1e4})).block_header?.raw_data?.number??0;return BigInt(e)}async getTransactionHistory(t,e=20){const s=e*je,[n,a]=await Promise.all([this.fetchNativeTransactions(t,s),this.fetchTrc20Transactions(t,s)]),o=t.toLowerCase();return this.aggregateByTxId(n,a,o).sort((l,u)=>u.timestamp-l.timestamp).slice(0,e)}aggregateByTxId(t,e,s){const n=new Map;for(const i of e){const l=i.transaction_id.toLowerCase(),u=n.get(l)??[];u.push(i),n.set(l,u)}const a=[],o=new Set;for(const i of t){const l=i.txID.toLowerCase();if(o.has(l))continue;o.add(l);const u=n.get(l)??[],h=this.buildAggregatedTransaction(i,u,s);h&&a.push(h)}for(const[i,l]of n){if(o.has(i))continue;o.add(i);const u=this.buildOrphanTrc20Transaction(l,s);a.push(u)}return a}shouldFilterTransaction(t,e){const s=t.raw_data?.contract?.[0],n=s?.type??"",a=s?.parameter?.value?.amount??0,o=t.ret?.[0]?.contractRet;return["TransferContract","TransferAssetContract","FreezeBalanceContract","FreezeBalanceV2Contract","UnfreezeBalanceContract","UnfreezeBalanceV2Contract","VoteWitnessContract","AccountCreateContract","WithdrawBalanceContract","WithdrawExpireUnfreezeContract"].includes(n)||e||a>0||o!=="SUCCESS"||this.isApproveTransaction(t)?!1:n==="TriggerSmartContract"}isApproveTransaction(t){const e=t.raw_data?.contract?.[0];if(e?.type!=="TriggerSmartContract")return!1;const s=e?.parameter?.value?.data;return!s||typeof s!="string"?!1:s.toLowerCase().startsWith("095ea7b3")}buildAggregatedTransaction(t,e,s){const n=t.raw_data?.contract?.[0],a=n?.type??"",o=n?.parameter?.value,i=t.ret?.[0]?.contractRet==="SUCCESS"?"confirmed":"failed",l=e.length>0;if(this.shouldFilterTransaction(t,l))return null;let u=this.detectAction(a);u==="contract"&&l&&(u="transfer"),u==="contract"&&this.isApproveTransaction(t)&&(u="approve");const h=this.selectPrimaryToken(e,s);let d,f;h?(d=h.from,f=h.to):(d=o?.owner_address??"",f=o?.to_address??"");const g=this.getDirection(d,f,s),b=[];for(const I of e.slice(0,3))b.push({assetType:"token",value:I.value,symbol:I.token_info.symbol,decimals:I.token_info.decimals,contractAddress:I.token_info.address,name:I.token_info.name});const S=o?.amount??0;return(S>0||b.length===0)&&b.push({assetType:"native",value:S.toString(),symbol:this.symbol,decimals:this.decimals}),{hash:t.txID,from:d,to:f,timestamp:t.raw_data?.timestamp??0,status:i,action:u,direction:g,assets:b}}buildOrphanTrc20Transaction(t,e){const s=this.selectPrimaryToken(t,e),n=this.getDirection(s.from,s.to,e),a=t.slice(0,3).map(o=>({assetType:"token",value:o.value,symbol:o.token_info.symbol,decimals:o.token_info.decimals,contractAddress:o.token_info.address,name:o.token_info.name}));return{hash:s.transaction_id,from:s.from,to:s.to,timestamp:s.block_timestamp,status:"confirmed",action:"transfer",direction:n,assets:a}}selectPrimaryToken(t,e){if(t.length===0)return null;if(t.length===1)return t[0];const s=t.filter(a=>a.from.toLowerCase()===e||a.to.toLowerCase()===e);return(s.length>0?s:t).reduce((a,o)=>{const i=BigInt(a.value);return BigInt(o.value)>i?o:a})}detectAction(t){switch(t){case"TransferContract":case"TransferAssetContract":return"transfer";case"TriggerSmartContract":return"contract";case"FreezeBalanceContract":case"FreezeBalanceV2Contract":case"VoteWitnessContract":return"stake";case"UnfreezeBalanceContract":case"UnfreezeBalanceV2Contract":return"unstake";case"WithdrawExpireUnfreezeContract":return"claim";default:return"transfer"}}async fetchNativeTransactions(t,e){const s=await this.api(`/v1/accounts/${t}/transactions?limit=${e}`,He,void 0,{ttlMs:3e5,tags:[`txhistory:${this.chainId}:${t}`]});if(!s.success)throw new Error("Tron API error");return s.data??[]}async fetchTrc20Transactions(t,e){const s=await this.api(`/v1/accounts/${t}/transactions/trc20?limit=${e}`,Ke,void 0,{ttlMs:3e5,tags:[`txhistory:${this.chainId}:${t}`]});if(!s.success)throw new Error("Tron API error");return s.data??[]}getDirection(t,e,s){const n=t.toLowerCase(),a=e.toLowerCase();return n===s&&a===s?"self":n===s?"out":"in"}}function Dt(r,t){return r.type==="tron-rpc"||r.type==="tron-rpc-pro"?new Ut(r,t):null}const We=m({address:c().optional(),chain_stats:m({funded_txo_sum:w(),spent_txo_sum:w()}),mempool_stats:m({funded_txo_sum:w(),spent_txo_sum:w()})}),Ve=m({txid:c(),status:m({confirmed:_(),block_height:w().optional(),block_time:w().optional()}),vin:k(m({prevout:m({scriptpubkey_address:c().optional(),value:w()}).optional()})),vout:k(m({scriptpubkey_address:c().optional(),value:w()}))});class Lt{type;endpoint;config;chainId;symbol;decimals;constructor(t,e){this.type=t.type,this.endpoint=t.endpoint,this.config=t.config,this.chainId=e,this.symbol=y.getSymbol(e),this.decimals=y.getDecimals(e)}async api(t,e){const s=`${this.endpoint}${t}`,n=await A(s,void 0,{cacheKey:`mempool:${s}`,ttlMs:3e4}),a=e.safeParse(n);if(!a.success)throw new Error("Invalid API response");return a.data}async getNativeBalance(t){const e=`${this.endpoint}/address/${t}`,s=await A(e,void 0,{cacheKey:`mempool:balance:${t}`,ttlMs:6e4,tags:[`balance:${this.chainId}:${t}`]}).then(i=>{const l=We.safeParse(i);if(!l.success)throw new Error("Invalid API response");return l.data}),n=s.chain_stats.funded_txo_sum-s.chain_stats.spent_txo_sum,a=s.mempool_stats.funded_txo_sum-s.mempool_stats.spent_txo_sum,o=n+a;return C({key:`balance:${this.chainId}:${t}`,value:o.toString(),invalidateTags:[`txhistory:${this.chainId}:${t}`]}),{amount:p.fromRaw(o.toString(),this.decimals,this.symbol),symbol:this.symbol}}async getTransactionHistory(t,e=20){const s=`${this.endpoint}/address/${t}/txs`;return(await A(s,void 0,{cacheKey:`mempool:txs:${t}`,ttlMs:5*6e4,tags:[`txhistory:${this.chainId}:${t}`]}).then(a=>{const o=k(Ve).safeParse(a);if(!o.success)throw new Error("Invalid API response");return o.data})).slice(0,e).map(a=>{const o=a.vin.some(f=>f.prevout?.scriptpubkey_address===t);let i=0n;if(o)for(const f of a.vout)f.scriptpubkey_address&&f.scriptpubkey_address!==t&&(i+=BigInt(f.value));else for(const f of a.vout)f.scriptpubkey_address===t&&(i+=BigInt(f.value));const l=o?a.vout.find(f=>f.scriptpubkey_address!==t)?.scriptpubkey_address??"":a.vin[0]?.prevout?.scriptpubkey_address??"",u=o?t:l,h=o?l:t,d=o?"out":"in";return{hash:a.txid,from:u,to:h,timestamp:(a.status.block_time??Math.floor(Date.now()/1e3))*1e3,status:a.status.confirmed?"confirmed":"pending",blockNumber:a.status.block_height?BigInt(a.status.block_height):void 0,action:"transfer",direction:d,assets:[{assetType:"native",value:i.toString(),symbol:this.symbol,decimals:this.decimals}]}})}async getBlockHeight(){const t=await this.api("/blocks/tip/height",w());return BigInt(t)}}function Mt(r,t){return r.type.startsWith("mempool-")?new Lt(r,t):null}const qe=vt([c(),w().transform(r=>String(r))]),Je=m({status:c().optional(),result:k(Y())}),Ge=m({blockNumber:c(),timeStamp:c(),hash:c(),from:c(),to:c(),value:c(),isError:c().optional(),input:c().optional(),methodId:c().optional(),functionName:c().optional()}),Ye=m({blockNumber:c(),timeStamp:c(),hash:c(),from:c(),to:c(),value:c(),tokenName:c(),tokenSymbol:c(),tokenDecimal:c(),contractAddress:c()}),ze=5;function X(r,t,e){const s=r.toLowerCase(),n=t.toLowerCase();return s===e&&n===e?"self":s===e?"out":"in"}function Xe(r){const t=r.value;return t&&t!=="0"?"transfer":"contract"}function Ze(r,t){if(r.length===0)return null;if(r.length===1)return r[0];const e=r.filter(n=>n.from.toLowerCase()===t||n.to.toLowerCase()===t);return(e.length>0?e:r).reduce((n,a)=>{const o=BigInt(n.value);return BigInt(a.value)>o?a:n})}class Ht{type;endpoint;config;chainId;symbol;decimals;constructor(t,e){this.type=t.type,this.endpoint=t.endpoint,this.config=t.config,this.chainId=e,this.symbol=y.getSymbol(e),this.decimals=y.getDecimals(e)}get supportsNativeBalance(){return!0}get supportsTransactionHistory(){return!0}async getNativeBalance(t){const e=new URL(`${this.endpoint}/balance`);e.searchParams.set("address",t);const s=await A(e.toString(),void 0,{cacheKey:`ethwallet:${this.chainId}:balance:${t}`,ttlMs:6e4,tags:[`balance:${this.chainId}:${t}`]}),n=qe.safeParse(s);if(!n.success)throw new Error("Invalid API response");return C({key:`balance:${this.chainId}:${t}`,value:n.data,invalidateTags:[`txhistory:${this.chainId}:${t}`]}),{amount:p.fromRaw(n.data,this.decimals,this.symbol),symbol:this.symbol}}async getTransactionHistory(t,e=20){const s=e*ze,[n,a]=await Promise.all([this.fetchHistory(`${this.endpoint}/trans/normal/history`,t,s,Ge,"normal"),this.fetchHistory(`${this.endpoint}/trans/erc20/history`,t,s,Ye,"erc20")]),o=t.toLowerCase(),i=new Map;for(const h of a){const d=h.hash.toLowerCase(),f=i.get(d)??[];f.push(h),i.set(d,f)}const l=[],u=new Set;for(const h of n){const d=h.hash.toLowerCase();if(u.has(d))continue;u.add(d);const f=i.get(d)??[],g=Ze(f,o);if(g){l.push({hash:g.hash,from:g.from,to:g.to,timestamp:Number(g.timeStamp)*1e3,status:"confirmed",blockNumber:BigInt(g.blockNumber),action:"transfer",direction:X(g.from,g.to,o),assets:[{assetType:"token",value:g.value,symbol:g.tokenSymbol,decimals:parseInt(g.tokenDecimal,10),contractAddress:g.contractAddress,name:g.tokenName}],contract:{address:h.to,method:h.functionName??void 0,methodId:h.methodId??void 0}});continue}l.push({hash:h.hash,from:h.from,to:h.to,timestamp:Number(h.timeStamp)*1e3,status:h.isError==="1"?"failed":"confirmed",blockNumber:BigInt(h.blockNumber),action:Xe(h),direction:X(h.from,h.to,o),assets:[{assetType:"native",value:h.value,symbol:this.symbol,decimals:this.decimals}],contract:h.value==="0"?{address:h.to,method:h.functionName??void 0,methodId:h.methodId??void 0}:void 0})}for(const h of a){const d=h.hash.toLowerCase();u.has(d)||(u.add(d),l.push({hash:h.hash,from:h.from,to:h.to,timestamp:Number(h.timeStamp)*1e3,status:"confirmed",blockNumber:BigInt(h.blockNumber),action:"transfer",direction:X(h.from,h.to,o),assets:[{assetType:"token",value:h.value,symbol:h.tokenSymbol,decimals:parseInt(h.tokenDecimal,10),contractAddress:h.contractAddress,name:h.tokenName}]}))}return l.sort((h,d)=>d.timestamp-h.timestamp).slice(0,e)}async fetchHistory(t,e,s,n,a){const o=await A(t,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({address:e,page:1,offset:s})},{cacheKey:`ethwallet:${this.chainId}:${a}:${e}:${s}`,ttlMs:3e5,tags:[`txhistory:${this.chainId}:${e}`]}),i=Je.safeParse(o);if(!i.success)throw new Error("Invalid API response");return i.data.result.map(l=>n.safeParse(l)).filter(l=>l.success).map(l=>l.data)}}function Ft(r,t){return r.type==="ethwallet-v1"?new Ht(r,t):null}const st="123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz",Qe=vt([c(),w().transform(r=>String(r))]),ts=m({data:k(Y()),success:_(),fingerprint:c().optional()}),es=m({contractRet:c().optional(),txID:c(),blockNumber:w().optional(),from:c(),to:c(),amount:w(),timestamp:w()}),ss=m({txID:c(),from:c(),to:c(),value:c(),token_symbol:c(),token_address:c(),token_name:c(),token_decimals:w(),timestamp:w()}),ns=5;function as(r){let t=BigInt(0);for(const n of r){const a=st.indexOf(n);if(a===-1)throw new Error("Invalid base58");t=t*58n+BigInt(a)}const e=t.toString(16).padStart(50,"0"),s=new Uint8Array(25);for(let n=0;n<25;n++)s[n]=parseInt(e.slice(n*2,n*2+2),16);return s}function os(r){let t=BigInt(0);for(const s of r)t=t*256n+BigInt(s);let e="";for(;t>0n;){const s=Number(t%58n);t=t/58n,e=st[s]+e}for(const s of r)if(s===0)e=st[0]+e;else break;return e}function ft(r){const e=as(r).slice(0,21);return $(e)}function rs(r){const t=r.startsWith("0x")?r.slice(2):r,e=x(t),s=B(B(e)).slice(0,4),n=new Uint8Array([...e,...s]);return os(n)}function E(r){return r.startsWith("T")?r:rs(r)}function Z(r,t,e){const s=r.toLowerCase(),n=t.toLowerCase();return s===e&&n===e?"self":s===e?"out":"in"}class Kt{type;endpoint;config;chainId;symbol;decimals;constructor(t,e){this.type=t.type,this.endpoint=t.endpoint,this.config=t.config,this.chainId=e,this.symbol=y.getSymbol(e),this.decimals=y.getDecimals(e)}get supportsNativeBalance(){return!0}get supportsTransactionHistory(){return!0}async getNativeBalance(t){const e=t.startsWith("T")?ft(t):t,s=new URL(`${this.endpoint}/balance`);s.searchParams.set("address",e);const n=await A(s.toString(),void 0,{cacheKey:`tronwallet:${this.chainId}:balance:${t}`,ttlMs:6e4,tags:[`balance:${this.chainId}:${t}`]}),a=Qe.safeParse(n);if(!a.success)throw new Error("Invalid API response");return C({key:`balance:${this.chainId}:${t}`,value:a.data,invalidateTags:[`txhistory:${this.chainId}:${t}`]}),{amount:p.fromRaw(a.data,this.decimals,this.symbol),symbol:this.symbol}}async getTransactionHistory(t,e=20){const s=e*ns,n=t.startsWith("T")?ft(t):t,[a,o]=await Promise.all([this.fetchHistory(`${this.endpoint}/trans/common/history`,n,t,s,es,"common"),this.fetchHistory(`${this.endpoint}/trans/trc20/history`,n,t,s,ss,"trc20")]),i=t.toLowerCase(),l=new Map;for(const d of o){const f=d.txID.toLowerCase(),g=l.get(f)??[];g.push(d),l.set(f,g)}const u=[],h=new Set;for(const d of a){const f=d.txID.toLowerCase();if(h.has(f))continue;h.add(f);const g=l.get(f)??[];if(g.length>0){const I=g[0],R=E(I.from),P=E(I.to);u.push({hash:I.txID,from:R,to:P,timestamp:I.timestamp,status:"confirmed",blockNumber:d.blockNumber!==void 0?BigInt(d.blockNumber):void 0,action:"transfer",direction:Z(R,P,i),assets:[{assetType:"token",value:I.value,symbol:I.token_symbol,decimals:I.token_decimals,contractAddress:E(I.token_address),name:I.token_name}]});continue}const b=E(d.from),S=E(d.to);u.push({hash:d.txID,from:b,to:S,timestamp:d.timestamp,status:"confirmed",blockNumber:d.blockNumber!==void 0?BigInt(d.blockNumber):void 0,action:"transfer",direction:Z(b,S,i),assets:[{assetType:"native",value:String(d.amount),symbol:this.symbol,decimals:this.decimals}]})}for(const d of o){const f=d.txID.toLowerCase();if(h.has(f))continue;h.add(f);const g=E(d.from),b=E(d.to);u.push({hash:d.txID,from:g,to:b,timestamp:d.timestamp,status:"confirmed",action:"transfer",direction:Z(g,b,i),assets:[{assetType:"token",value:d.value,symbol:d.token_symbol,decimals:d.token_decimals,contractAddress:E(d.token_address),name:d.token_name}]})}return u.sort((d,f)=>f.timestamp-d.timestamp).slice(0,e)}async fetchHistory(t,e,s,n,a,o){const i=await A(t,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({address:e,limit:n})},{cacheKey:`tronwallet:${this.chainId}:${o}:${e}:${n}`,ttlMs:3e5,tags:[`txhistory:${this.chainId}:${s}`]}),l=ts.safeParse(i);if(!l.success||!l.data.success)throw new Error("Upstream API error");return l.data.data.map(u=>a.safeParse(u)).filter(u=>u.success).map(u=>u.data)}}function jt(r,t){return r.type==="tronwallet-v1"?new Kt(r,t):null}const is=m({error:c()}),cs=m({addresses:k(c()),value:c()}),ls=m({addresses:k(c()),value:c()}),us=m({txid:c(),blockHeight:w(),confirmations:w(),blockTime:w(),vin:k(cs),vout:k(ls),fees:c().optional()}),pt=m({address:c().optional(),balance:c(),unconfirmedBalance:c().optional(),txs:w().optional(),transactions:k(us).optional()});function gt(r,t){let e=0n;for(const s of r)s.addresses.some(n=>n===t)&&(e+=BigInt(s.value));return e}function hs(r){return r>0n?"in":r<0n?"out":"self"}class Wt{type;endpoint;config;chainId;symbol;decimals;constructor(t,e){this.type=t.type,this.endpoint=t.endpoint,this.config=t.config,this.chainId=e,this.symbol=y.getSymbol(e),this.decimals=y.getDecimals(e)}get supportsNativeBalance(){return!0}get supportsTransactionHistory(){return!0}async getNativeBalance(t){const e=await this.proxyGet(`/api/v2/address/${t}`,pt,{cacheKey:`btcwallet:${this.chainId}:address:${t}`,ttlMs:6e4,tags:[`balance:${this.chainId}:${t}`]}),s=BigInt(e.balance),n=BigInt(e.unconfirmedBalance??"0"),a=s+n;return C({key:`balance:${this.chainId}:${t}`,value:a.toString(),invalidateTags:[`txhistory:${this.chainId}:${t}`]}),{amount:p.fromRaw(a.toString(),this.decimals,this.symbol),symbol:this.symbol}}async getTransactionHistory(t,e=20){return((await this.proxyGet(`/api/v2/address/${t}?details=txs&page=1&pageSize=${e}`,pt,{cacheKey:`btcwallet:${this.chainId}:txs:${t}:${e}`,ttlMs:3e5,tags:[`txhistory:${this.chainId}:${t}`]})).transactions??[]).map(o=>{const i=gt(o.vin,t),u=gt(o.vout,t)-i,h=hs(u),d=u<0n?(-u).toString():u.toString(),f=h==="in"?o.vin[0]?.addresses?.[0]??"":t,g=o.vout.flatMap(S=>S.addresses).find(S=>S!==t),b=h==="out"?g??t:t;return{hash:o.txid,from:f,to:b,timestamp:o.blockTime*1e3,status:o.confirmations>0?"confirmed":"pending",blockNumber:o.blockHeight>0?BigInt(o.blockHeight):void 0,action:"transfer",direction:h,assets:[{assetType:"native",value:d,symbol:this.symbol,decimals:this.decimals}]}}).sort((o,i)=>i.timestamp-o.timestamp)}async proxyGet(t,e,s){const n=await A(this.endpoint,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({url:t,method:"GET"})},{cacheKey:s?.cacheKey,ttlMs:s?.ttlMs,tags:s?.tags}),a=is.safeParse(n);if(a.success&&a.data.error)throw new Error(a.data.error);const o=e.safeParse(n);if(!o.success)throw new Error("Invalid API response");return o.data}}function Vt(r,t){return r.type==="btcwallet-v1"?new Wt(r,t):null}class D{constructor(t,e,s){this.transactionService=e,this.assetService=s,this.type=t}type;endpoint="";async getNativeBalance(t){return this.assetService.getNativeBalance(t)}async getTransactionHistory(t,e){return(await this.transactionService.getTransactionHistory(t,e)).map(n=>this.convertTransaction(n,t))}async getTransaction(t){const e=await this.transactionService.getTransaction(t);return e?this.convertTransaction(e):null}async getTransactionStatus(t){const e=await this.transactionService.getTransactionStatus(t);return this.convertTransactionStatus(e)}async estimateFee(t){const e=await this.transactionService.estimateFee(t);return this.convertFeeEstimate(e)}async buildTransaction(t){return this.transactionService.buildTransaction(t)}async signTransaction(t,e){const s=await this.transactionService.signTransaction(t,e);return{chainId:s.chainId,data:s.data,signature:typeof s.signature=="string"?s.signature:""}}async broadcastTransaction(t){return this.transactionService.broadcastTransaction(t)}convertTransaction(t,e){const s=e?t.from.toLowerCase()===e.toLowerCase()?"out":t.to.toLowerCase()===e.toLowerCase()?"in":"self":"self",n=this.deriveAction(t);return{hash:t.hash,from:t.from,to:t.to,timestamp:t.timestamp,status:t.status.status==="confirmed"?"confirmed":t.status.status==="failed"?"failed":"pending",blockNumber:t.blockNumber,action:n,direction:s,assets:[{assetType:"native",value:t.amount.toRawString(),symbol:t.amount.symbol??"",decimals:t.amount.decimals}],contract:t.type==="contract-call"||n==="contract"?{address:t.to}:void 0,fee:{value:t.fee.toRawString(),symbol:t.fee.symbol??"",decimals:t.fee.decimals}}}deriveAction(t){const e=t.rawType;if(e){if(e.includes("BSE-01"))return"signature";if(e.includes("AST-02"))return"transfer";if(e.includes("AST-03"))return"destroyAsset";if(e.includes("AST-04"))return"gift";if(e.includes("AST-05"))return"grab";if(e.includes("AST-06"))return"trust";if(e.includes("AST-07"))return"signFor";if(e.includes("AST-08"))return"emigrate";if(e.includes("AST-09"))return"immigrate";if(e.includes("AST-10")||e.includes("AST-11"))return"exchange";if(e.includes("AST-12"))return"stake";if(e.includes("AST-13"))return"unstake";if(e.includes("AST-00"))return"issueAsset";if(e.includes("AST-01"))return"increaseAsset";if(e.includes("ETY-02")||e.includes("ETY-04"))return"issueEntity";if(e.includes("ETY-03"))return"destroyEntity";if(e.includes("ETY-00")||e.includes("ETY-01"))return"issueAsset";if(e.includes("ANY-00"))return"transfer";if(e.includes("ANY-01"))return"gift";if(e.includes("ANY-02"))return"grab";if(e.includes("ANY-03")||e.includes("ANY-04")||e.includes("ANY-05")||e.includes("ANY-06")||e.includes("ANY-07")||e.includes("ANY-08"))return"exchange";if(e.includes("LNS-"))return"locationName";if(e.includes("WOD-"))return"dapp";if(e.includes("CRT-"))return"certificate";if(e.includes("EXT-00"))return"mark"}return t.type==="stake"?"stake":t.type==="unstake"?"unstake":t.type==="contract-call"?"contract":"transfer"}convertTransactionStatus(t){let e;switch(t.status){case"pending":e="pending";break;case"confirmed":e="confirmed";break;case"failed":e="failed";break;default:e="pending"}return{status:e,confirmations:t.confirmations,requiredConfirmations:t.requiredConfirmations}}convertFeeEstimate(t){const e=(s,n)=>({amount:s.amount,estimatedTime:n});return{slow:e(t.slow,600),standard:e(t.standard,180),fast:e(t.fast,30)}}}class L{constructor(t,e){this.identityService=e,this.type=t}type;endpoint="";async deriveAddress(t,e=0){return this.identityService.deriveAddress(t,e)}async deriveAddresses(t,e,s){return this.identityService.deriveAddresses(t,e,s)}isValidAddress(t){return this.identityService.isValidAddress(t)}normalizeAddress(t){return this.identityService.normalizeAddress(t)}}class ds{chainId;constructor(t){this.chainId=t}async deriveAddress(t,e=0){const s=new TextDecoder().decode(t);return q(s,"ethereum",e).address}async deriveAddresses(t,e,s){const n=new TextDecoder().decode(t),a=[];for(let o=0;o<s;o++){const i=q(n,"ethereum",e+o);a.push(i.address)}return a}isValidAddress(t){return ne(t,"ethereum")}normalizeAddress(t){return ae(t)}async signMessage(t,e){throw new Error("Not implemented")}async verifyMessage(t,e,s){throw new Error("Not implemented")}}class T extends Error{code;details;constructor(t,e,s,n){super(e,{cause:n}),this.name="ChainServiceError",this.code=t,this.details=s}}const v={CHAIN_NOT_SUPPORTED:"CHAIN_NOT_SUPPORTED",NETWORK_ERROR:"NETWORK_ERROR",INSUFFICIENT_BALANCE:"INSUFFICIENT_BALANCE",INSUFFICIENT_FEE:"INSUFFICIENT_FEE",INVALID_ADDRESS:"INVALID_ADDRESS",TRANSACTION_REJECTED:"TRANSACTION_REJECTED",TRANSACTION_TIMEOUT:"TRANSACTION_TIMEOUT",TX_BUILD_FAILED:"TX_BUILD_FAILED",TX_BROADCAST_FAILED:"TX_BROADCAST_FAILED",SIGNATURE_FAILED:"SIGNATURE_FAILED",ADDRESS_FROZEN:"ADDRESS_FROZEN",PAYSECRET_REQUIRED:"PAYSECRET_REQUIRED",ADDRESS_NOT_ACTIVATED:"ADDRESS_NOT_ACTIVATED",ENERGY_INSUFFICIENT:"ENERGY_INSUFFICIENT",NONCE_TOO_LOW:"NONCE_TOO_LOW",GAS_TOO_LOW:"GAS_TOO_LOW",UTXO_INSUFFICIENT:"UTXO_INSUFFICIENT"};class ms{chainId;constructor(t){this.chainId=t}get rpcUrl(){return y.getRpcUrl(this.chainId)}get decimals(){return y.getDecimals(this.chainId)}get symbol(){return y.getSymbol(this.chainId)}async rpc(t,e){const s=await fetch(this.rpcUrl,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({jsonrpc:"2.0",method:t,params:e,id:1})});if(!s.ok)throw new T(v.NETWORK_ERROR,`HTTP ${s.status}: ${s.statusText}`);const n=await s.json();if(n.error)throw new T(v.NETWORK_ERROR,n.error.message);return n.result}async getNativeBalance(t){try{const e=await this.rpc("eth_getBalance",[t,"latest"]),s=BigInt(e).toString();return{amount:p.fromRaw(s,this.decimals,this.symbol),symbol:this.symbol}}catch{return{amount:p.fromRaw("0",this.decimals,this.symbol),symbol:this.symbol}}}async getTokenBalance(t,e){try{const s=`0x70a08231000000000000000000000000${t.slice(2).toLowerCase()}`,n=await this.rpc("eth_call",[{to:e,data:s},"latest"]),a=BigInt(n).toString();return{amount:p.fromRaw(a,18,"TOKEN"),symbol:"TOKEN"}}catch{return{amount:p.fromRaw("0",18,"UNKNOWN"),symbol:"UNKNOWN"}}}async getTokenBalances(t){return[await this.getNativeBalance(t)]}async getTokenMetadata(t){return{address:t,name:"Unknown Token",symbol:"UNKNOWN",decimals:18}}}const fs={ethereum:1,"ethereum-sepolia":11155111,binance:56,"bsc-testnet":97};class ps{chainId;evmChainId;constructor(t){this.chainId=t,this.evmChainId=fs[t]??1}get rpcUrl(){return y.getRpcUrl(this.chainId)}get decimals(){return y.getDecimals(this.chainId)}get symbol(){return y.getSymbol(this.chainId)}async rpc(t,e=[]){const s=await fetch(this.rpcUrl,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({jsonrpc:"2.0",id:Date.now(),method:t,params:e})});if(!s.ok)throw new T(v.NETWORK_ERROR,`HTTP ${s.status}: ${s.statusText}`);const n=await s.json();if(n.error)throw new T(v.NETWORK_ERROR,n.error.message,{code:n.error.code});return n.result}async estimateFee(t){const e=await this.rpc("eth_gasPrice"),a=21000n*BigInt(e),o=p.fromRaw((a*80n/100n).toString(),this.decimals,this.symbol),i=p.fromRaw(a.toString(),this.decimals,this.symbol),l=p.fromRaw((a*120n/100n).toString(),this.decimals,this.symbol);return{slow:{amount:o,estimatedTime:60},standard:{amount:i,estimatedTime:15},fast:{amount:l,estimatedTime:5}}}async buildTransaction(t){const e=await this.rpc("eth_getTransactionCount",[t.from,"pending"]),s=parseInt(e,16),n=await this.rpc("eth_gasPrice");return{chainId:this.chainId,data:{nonce:s,gasPrice:n,gasLimit:"0x5208",to:t.to,value:"0x"+t.amount.raw.toString(16),data:"0x",chainId:this.evmChainId}}}async signTransaction(t,e){const s=t.data,n=this.rlpEncode([this.toRlpHex(s.nonce),s.gasPrice,s.gasLimit,s.to.toLowerCase(),s.value,s.data,this.toRlpHex(s.chainId),"0x","0x"]),a=W(x(n.slice(2))),o=M.sign(a,e,{prehash:!1,format:"recovered"}),i=BigInt("0x"+$(o.slice(0,32))),l=BigInt("0x"+$(o.slice(32,64))),u=o[64],h=s.chainId*2+35+u,d=i.toString(16).padStart(64,"0"),f=l.toString(16).padStart(64,"0"),g=this.rlpEncode([this.toRlpHex(s.nonce),s.gasPrice,s.gasLimit,s.to.toLowerCase(),s.value,s.data,this.toRlpHex(h),"0x"+d,"0x"+f]);return{chainId:this.chainId,data:g,signature:"0x"+d+f}}async broadcastTransaction(t){const e=t.data;return await this.rpc("eth_sendRawTransaction",[e])}toRlpHex(t){return t===0?"0x":"0x"+t.toString(16)}rlpEncode(t){const e=t.map(i=>{if(i==="0x"||i==="")return new Uint8Array([128]);const l=x(i.startsWith("0x")?i.slice(2):i);if(l.length===1&&l[0]<128)return l;if(l.length<=55)return new Uint8Array([128+l.length,...l]);const u=this.numberToBytes(l.length);return new Uint8Array([183+u.length,...u,...l])}),s=e.reduce((i,l)=>i+l.length,0);let n;if(s<=55)n=new Uint8Array([192+s]);else{const i=this.numberToBytes(s);n=new Uint8Array([247+i.length,...i])}const a=new Uint8Array(n.length+s);a.set(n);let o=n.length;for(const i of e)a.set(i,o),o+=i.length;return"0x"+$(a)}numberToBytes(t){const e=t.toString(16),s=e.length%2?"0"+e:e;return x(s)}async getTransactionStatus(t){try{const e=await this.rpc("eth_getTransactionReceipt",[t]);if(!e)return{status:"pending",confirmations:0,requiredConfirmations:12};const s=await this.rpc("eth_blockNumber"),n=parseInt(s,16)-parseInt(e.blockNumber,16);return{status:n>=12?"confirmed":"confirming",confirmations:Math.max(0,n),requiredConfirmations:12}}catch{return{status:"pending",confirmations:0,requiredConfirmations:12}}}async getTransaction(t){try{const[e,s]=await Promise.all([this.rpc("eth_getTransactionByHash",[t]),this.rpc("eth_getTransactionReceipt",[t])]);if(!e)return null;const n=e.blockNumber?await this.rpc("eth_getBlockByNumber",[e.blockNumber,!1]):null;return{hash:e.hash,from:e.from,to:e.to??"",amount:p.fromRaw(BigInt(e.value).toString(),this.decimals,this.symbol),fee:s?p.fromRaw((BigInt(s.gasUsed)*BigInt(e.gasPrice)).toString(),this.decimals,this.symbol):p.fromRaw("0",this.decimals,this.symbol),status:{status:s?.status==="0x1"?"confirmed":s?"failed":"pending",confirmations:s?12:0,requiredConfirmations:12},timestamp:n?parseInt(n.timestamp,16)*1e3:Date.now(),blockNumber:e.blockNumber?BigInt(e.blockNumber):void 0,type:"transfer"}}catch{return null}}async getTransactionHistory(t,e=20){return[]}}const F="123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz";class gs{constructor(t){}async deriveAddress(t,e=0){const s=new TextDecoder().decode(t);return q(s,"tron",e).address}async deriveAddresses(t,e,s){const n=new TextDecoder().decode(t),a=[];for(let o=0;o<s;o++){const i=q(n,"tron",e+o);a.push(i.address)}return a}isValidAddress(t){if(!t.startsWith("T")||t.length!==34)return!1;for(const e of t)if(!F.includes(e))return!1;try{const e=this.decodeBase58(t);if(e.length!==25)return!1;const s=e.slice(0,21),n=e.slice(21),a=B(B(s));return n.every((o,i)=>o===a[i])}catch{return!1}}decodeBase58(t){let e=BigInt(0);for(const a of t){const o=F.indexOf(a);if(o===-1)throw new Error(`Invalid base58 character: ${a}`);e=e*58n+BigInt(o)}const s=e.toString(16).padStart(50,"0"),n=new Uint8Array(25);for(let a=0;a<25;a++)n[a]=parseInt(s.slice(a*2,a*2+2),16);return n}normalizeAddress(t){return t}async signMessage(t,e){const s=typeof t=="string"?new TextEncoder().encode(t):t,n=new TextEncoder().encode(`TRON Signed Message:
`+s.length),a=W(new Uint8Array([...n,...s])),o=M.sign(a,e,{prehash:!1,format:"recovered"});return $(o)}async verifyMessage(t,e,s){try{const n=typeof t=="string"?new TextEncoder().encode(t):t,a=new TextEncoder().encode(`TRON Signed Message:
`+n.length),o=W(new Uint8Array([...a,...n])),i=x(e),l=M.recoverPublicKey(o,i);if(!l)return!1;const h=W(l.slice(1)).slice(-20),d=new Uint8Array([65,...h]),f=B(B(d)).slice(0,4),g=new Uint8Array([...d,...f]);return this.encodeBase58(g)===s}catch{return!1}}encodeBase58(t){let e=BigInt(0);for(const n of t)e=e*256n+BigInt(n);let s="";for(;e>0n;){const n=Number(e%58n);e=e/58n,s=F[n]+s}for(const n of t)if(n===0)s=F[0]+s;else break;return s}}class ys{chainId;constructor(t){this.chainId=t}get rpcUrl(){return y.getRpcUrl(this.chainId)}get decimals(){return y.getDecimals(this.chainId)}get symbol(){return y.getSymbol(this.chainId)}async api(t,e){const s=`${this.rpcUrl}${t}`,n=e?{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)}:{method:"GET"},a=await fetch(s,n);if(!a.ok)throw new T(v.NETWORK_ERROR,`Tron API error: ${a.status}`);return a.json()}async getNativeBalance(t){try{const e=await this.api("/wallet/getaccount",{address:t,visible:!0});return!e||!("balance"in e)?{amount:p.fromRaw("0",this.decimals,this.symbol),symbol:this.symbol}:{amount:p.fromRaw(e.balance.toString(),this.decimals,this.symbol),symbol:this.symbol}}catch{return{amount:p.fromRaw("0",this.decimals,this.symbol),symbol:this.symbol}}}async getTokenBalance(t,e){try{const s=await this.api("/wallet/getaccount",{address:t,visible:!0});if(s?.trc20){for(const n of s.trc20)if(n[e])return{amount:p.fromRaw(n[e],18,"TOKEN"),symbol:"TOKEN"}}return{amount:p.fromRaw("0",18,"TOKEN"),symbol:"TOKEN"}}catch{return{amount:p.fromRaw("0",18,"TOKEN"),symbol:"TOKEN"}}}async getTokenBalances(t){return[await this.getNativeBalance(t)]}async getTokenMetadata(t){return{address:t,name:"TRC20 Token",symbol:"TOKEN",decimals:18}}}const ws="https://api.trongrid.io";class bs{chainId;config=null;rpcUrl="";constructor(t){this.chainId=t}getConfig(){if(!this.config){const t=y.getConfig(this.chainId);if(!t)throw new T(v.CHAIN_NOT_FOUND,`Chain config not found: ${this.chainId}`);this.config=t,this.rpcUrl=y.getRpcUrl(t.id)||ws}return this.config}async api(t,e){const s=`${this.rpcUrl}${t}`,n=e?{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)}:{method:"GET"},a=await fetch(s,n);if(!a.ok)throw new T(v.NETWORK_ERROR,`Tron API error: ${a.status} ${a.statusText}`);return a.json()}base58ToHex(t){const e="123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz";let s=BigInt(0);for(const a of t){const o=e.indexOf(a);if(o===-1)throw new Error(`Invalid base58 character: ${a}`);s=s*58n+BigInt(o)}return s.toString(16).padStart(50,"0").slice(0,42)}async estimateFee(t){const e=this.getConfig(),n={amount:p.fromRaw("0",e.decimals,e.symbol),estimatedTime:3};return{slow:n,standard:n,fast:n}}async buildTransaction(t){const e=this.getConfig(),s=this.base58ToHex(t.from),n=this.base58ToHex(t.to),a=await this.api("/wallet/createtransaction",{owner_address:s,to_address:n,amount:Number(t.amount.raw),visible:!1});if(!a.txID)throw new T(v.TX_BUILD_FAILED,"Failed to create Tron transaction");return{chainId:e.id,data:a}}async signTransaction(t,e){const s=t.data,n=x(s.txID),a=M.sign(n,e,{prehash:!1,format:"recovered"}),o=$(a),i={...s,signature:[o]};return{chainId:t.chainId,data:i,signature:o}}async broadcastTransaction(t){const e=t.data,s=await this.api("/wallet/broadcasttransaction",e);if(!s.result){const n=s.message?Buffer.from(s.message,"hex").toString("utf8"):s.code??"Unknown error";throw new T(v.TX_BROADCAST_FAILED,`Broadcast failed: ${n}`)}return e.txID}async getTransactionStatus(t){try{const e=await this.api("/wallet/gettransactioninfobyid",{value:t});if(!e||!("blockNumber"in e))return{status:"pending",confirmations:0,requiredConfirmations:19};const a=(await this.api("/wallet/getnowblock")).block_header.raw_data.number-e.blockNumber;return{status:a>=19?"confirmed":"confirming",confirmations:Math.max(0,a),requiredConfirmations:19}}catch{return{status:"pending",confirmations:0,requiredConfirmations:19}}}async getTransaction(t){try{const[e,s]=await Promise.all([this.api("/wallet/gettransactionbyid",{value:t}),this.api("/wallet/gettransactioninfobyid",{value:t})]);if(!e||!("txID"in e))return null;const n=e.raw_data.contract[0];if(!n||n.type!=="TransferContract")return null;const{amount:a,owner_address:o,to_address:i}=n.parameter.value,l="blockNumber"in s,u=this.getConfig();return{hash:e.txID,from:o,to:i,amount:p.fromRaw(a.toString(),u.decimals,u.symbol),fee:p.fromRaw((s.receipt?.net_usage??0).toString(),u.decimals,u.symbol),status:{status:l?"confirmed":"pending",confirmations:l?19:0,requiredConfirmations:19},timestamp:e.raw_data.timestamp,blockNumber:l?BigInt(s.blockNumber):void 0,type:"transfer"}}catch{return null}}async getTransactionHistory(t,e=20){return[]}}class Ts{constructor(t){}async deriveAddress(t,e=0){const s=new TextDecoder().decode(t);return it(s,84,e).address}async deriveAddresses(t,e,s){const n=new TextDecoder().decode(t),a=[];for(let o=0;o<s;o++){const i=it(n,84,e+o);a.push(i.address)}return a}isValidAddress(t){try{if(t.startsWith("1")||t.startsWith("3"))return oe(B).decode(t).length===21;if(t.toLowerCase().startsWith("bc1q")){const e=t.toLowerCase(),s=ct.decode(e),n=ct.fromWords(s.words.slice(1));return s.prefix==="bc"&&s.words[0]===0&&n.length===20}if(t.toLowerCase().startsWith("bc1p")){const e=t.toLowerCase(),s=lt.decode(e),n=lt.fromWords(s.words.slice(1));return s.prefix==="bc"&&s.words[0]===1&&n.length===32}return!1}catch{return!1}}normalizeAddress(t){return t.startsWith("bc1")||t.startsWith("BC1")?t.toLowerCase():t}async signMessage(t,e){const s=typeof t=="string"?new TextEncoder().encode(t):t,n=new TextEncoder().encode(`Bitcoin Signed Message:
`),a=new Uint8Array([s.length]),o=new Uint8Array([...n,...a,...s]),i=B(B(o)),l=M.sign(i,e,{prehash:!1,format:"recovered"});return $(l)}async verifyMessage(t,e,s){return!1}}const yt={bitcoin:"https://mempool.space/api","bitcoin-testnet":"https://mempool.space/testnet/api","bitcoin-signet":"https://mempool.space/signet/api"};class vs{config;apiUrl;constructor(t){this.config=t,this.apiUrl=yt[t.id]??yt.bitcoin}async api(t){const e=`${this.apiUrl}${t}`,s=await fetch(e);if(!s.ok)throw new T(v.NETWORK_ERROR,`Bitcoin API error: ${s.status}`);return s.json()}async getNativeBalance(t){try{const e=await this.api(`/address/${t}`),s=e.chain_stats.funded_txo_sum-e.chain_stats.spent_txo_sum,n=e.mempool_stats.funded_txo_sum-e.mempool_stats.spent_txo_sum,a=s+n;return{amount:p.fromRaw(a.toString(),this.config.decimals,this.config.symbol),symbol:this.config.symbol}}catch{return{amount:p.fromRaw("0",this.config.decimals,this.config.symbol),symbol:this.config.symbol}}}async getTokenBalance(t,e){return{amount:p.fromRaw("0",8,"TOKEN"),symbol:"TOKEN"}}async getTokenBalances(t){return[]}async getTokenMetadata(t){return{address:t,name:"Unknown",symbol:"UNKNOWN",decimals:8}}async getUtxos(t){return this.api(`/address/${t}/utxo`)}}const Is="https://mempool.space/api";class Ss{config;apiUrl;constructor(t){this.config=t,this.apiUrl=y.getMempoolApi(t.id)??Is}async api(t,e){const s=`${this.apiUrl}${t}`,n=await fetch(s,e);if(!n.ok)throw new T(v.NETWORK_ERROR,`Bitcoin API error: ${n.status}`);const a=await n.text();try{return JSON.parse(a)}catch{return a}}async estimateFee(t){try{const e=await this.api("/v1/fees/recommended"),s=140,n={amount:p.fromRaw((e.hourFee*s).toString(),this.config.decimals,this.config.symbol),estimatedTime:3600},a={amount:p.fromRaw((e.halfHourFee*s).toString(),this.config.decimals,this.config.symbol),estimatedTime:1800},o={amount:p.fromRaw((e.fastestFee*s).toString(),this.config.decimals,this.config.symbol),estimatedTime:600};return{slow:n,standard:a,fast:o}}catch{const e={amount:p.fromRaw("2000",this.config.decimals,this.config.symbol),estimatedTime:1800};return{slow:e,standard:e,fast:e}}}async buildTransaction(t){const e=await this.api(`/address/${t.from}/utxo`);if(e.length===0)throw new T(v.INSUFFICIENT_BALANCE,"No UTXOs available");const n=(await this.api("/v1/fees/recommended")).halfHourFee,a=e.reduce((d,f)=>d+f.value,0),o=Number(t.amount.raw),i=10+e.length*68+62,l=n*i;if(a<o+l)throw new T(v.INSUFFICIENT_BALANCE,`Insufficient balance: need ${o+l}, have ${a}`);const u=a-o-l,h={inputs:e.map(d=>({txid:d.txid,vout:d.vout,value:d.value,scriptPubKey:""})),outputs:[{address:t.to,value:o}],fee:l,changeAddress:t.from};return u>546&&h.outputs.push({address:t.from,value:u}),{chainId:this.config.id,data:h}}async signTransaction(t,e){throw new T(v.CHAIN_NOT_SUPPORTED,"Bitcoin transaction signing requires specialized library (bitcoinjs-lib or similar)")}async broadcastTransaction(t){const e=t.data;return await this.api("/tx",{method:"POST",body:e})}async getTransactionStatus(t){try{const e=await this.api(`/tx/${t}`);if(!e.status.confirmed)return{status:"pending",confirmations:0,requiredConfirmations:6};const s=await this.api("/blocks/tip/height"),n=s-(e.status.block_height??s)+1;return{status:n>=6?"confirmed":"confirming",confirmations:Math.max(0,n),requiredConfirmations:6}}catch{return{status:"pending",confirmations:0,requiredConfirmations:6}}}async getTransaction(t){try{const e=await this.api(`/tx/${t}`),s=e.vin[0]?.prevout?.scriptpubkey_address??"",n=e.vout[0]?.scriptpubkey_address??"",a=e.vout[0]?.value??0;return{hash:e.txid,from:s,to:n,amount:p.fromRaw(a.toString(),this.config.decimals,this.config.symbol),fee:p.fromRaw(e.fee.toString(),this.config.decimals,this.config.symbol),status:{status:e.status.confirmed?"confirmed":"pending",confirmations:e.status.confirmed?6:0,requiredConfirmations:6},timestamp:(e.status.block_time??Math.floor(Date.now()/1e3))*1e3,blockNumber:e.status.block_height?BigInt(e.status.block_height):void 0,type:"transfer"}}catch{return null}}async getTransactionHistory(t,e=20){try{return(await this.api(`/address/${t}/txs`)).slice(0,e).map(n=>{const a=n.vin.some(u=>u.prevout?.scriptpubkey_address===t),o=a?t:n.vin[0]?.prevout?.scriptpubkey_address??"",i=a?n.vout.find(u=>u.scriptpubkey_address!==t)?.scriptpubkey_address??"":t,l=a?n.vout.filter(u=>u.scriptpubkey_address!==t).reduce((u,h)=>u+h.value,0):n.vout.filter(u=>u.scriptpubkey_address===t).reduce((u,h)=>u+h.value,0);return{hash:n.txid,from:o,to:i,amount:p.fromRaw(l.toString(),this.config.decimals,this.config.symbol),fee:p.fromRaw(n.fee.toString(),this.config.decimals,this.config.symbol),status:{status:n.status.confirmed?"confirmed":"pending",confirmations:n.status.confirmed?6:0,requiredConfirmations:6},timestamp:(n.status.block_time??Math.floor(Date.now()/1e3))*1e3,blockNumber:n.status.block_height?BigInt(n.status.block_height):void 0,type:"transfer"}})}catch{return[]}}}function As(r){return Array.from(r).map(t=>t.toString(16).padStart(2,"0")).join("")}class ks{chainId;prefix=null;constructor(t){this.chainId=t}getPrefix(){if(!this.prefix){const t=y.getConfig(this.chainId);this.prefix=t?.prefix??"b"}return this.prefix}async deriveAddress(t,e=0){const s=new TextDecoder().decode(t),n=re(s);return ie(n.publicKey,this.getPrefix())}async deriveAddresses(t,e,s){const n=await this.deriveAddress(t,e);return Array(s).fill(n)}isValidAddress(t){return ce(t)}normalizeAddress(t){return t}async signMessage(t,e){const s=It(t,e);return As(s)}async verifyMessage(t,e,s){return!1}}const Ns=N({assetNumber:c(),assetType:c().min(1),sourceChainMagic:c(),sourceChainName:c(),iconUrl:c().optional()}),_s=N({success:_(),result:N({address:c(),assets:V(c(),V(c(),Ns)),forgingRewards:c().optional()}).nullish(),error:N({code:w(),message:c(),info:c().optional()}).nullish()});class Bs{chainId;config=null;constructor(t){this.chainId=t}getConfig(){if(!this.config){const t=y.getConfig(this.chainId);if(!t)throw new T(v.CHAIN_NOT_FOUND,`Chain config not found: ${this.chainId}`);this.config=t}return this.config}getEmptyNativeBalance(){const t=this.getConfig();return{amount:p.zero(t.decimals,t.symbol),symbol:t.symbol}}async getNativeBalance(t){const e=await this.getTokenBalances(t),s=this.getConfig();return e.find(a=>a.symbol===s.symbol)??this.getEmptyNativeBalance()}async getTokenBalance(t,e){const s=e,a=(await this.getTokenBalances(t)).find(i=>i.symbol===s);if(a)return a;const o=this.getConfig();return{amount:p.zero(o.decimals,s),symbol:s}}async getTokenBalances(t){const e=this.getConfig(),s=y.getBiowalletApi(e.id);if(!s)return[this.getEmptyNativeBalance()];const{endpoint:n,path:a}=s;try{const o=await fetch(`${n}/wallet/${a}/address/asset`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify({address:t})});if(!o.ok)throw new T(v.NETWORK_ERROR,`Failed to fetch balances: ${o.status}`);const i=await o.json(),l=_s.safeParse(i);if(!l.success)return console.warn("[BioforestAssetService] Invalid API response:",l.error.message),[this.getEmptyNativeBalance()];const{success:u,result:h}=l.data;if(!u||!h)return[this.getEmptyNativeBalance()];const d=[],{assets:f}=h;for(const g of Object.keys(f)){const b=f[g];if(b)for(const S of Object.keys(b)){const I=b[S];if(!I)continue;const R=e.decimals,P=p.fromRaw(I.assetNumber,R,I.assetType);d.push({amount:P,symbol:I.assetType})}}return d.length>0?d:[this.getEmptyNativeBalance()]}catch(o){throw o instanceof T?o:new T(v.NETWORK_ERROR,"Failed to fetch balances",void 0,o instanceof Error?o:void 0)}}async getTokenMetadata(t){const e=this.getConfig();return{address:null,name:t,symbol:t,decimals:e.decimals}}}class U extends Error{constructor(t,e,s){super(t),this.status=e,this.response=s,this.name="ApiError"}}class Es{baseUrl;timeout;fetchFn;constructor(t){this.baseUrl=t.baseUrl.replace(/\/$/,""),this.timeout=t.timeout??3e4,this.fetchFn=t.fetch??((e,s)=>fetch(e,s))}async request(t,e,s){const n=`${this.baseUrl}${e}`,a=new AbortController,o=setTimeout(()=>a.abort(),this.timeout);try{const i={method:t,signal:a.signal};s&&(i.headers={"Content-Type":"application/json"},i.body=JSON.stringify(s));const l=await this.fetchFn(n,i),u=await l.json();if(!l.ok)throw new U(u.message??`Request failed: ${l.status}`,l.status,u);if(!u.success)throw new U(u.message??"Request failed",l.status,u);return u.result}catch(i){throw i instanceof U?i:i instanceof Error&&i.name==="AbortError"?new U("Request timeout",void 0,void 0):new U(i instanceof Error?i.message:"Unknown error",void 0,void 0)}finally{clearTimeout(o)}}async get(t){return this.request("GET",t)}async post(t,e){return this.request("POST",t,e)}}const Cs="https://walletapi.bfmeta.info";class Rs{client;chainPath;constructor(t){this.chainPath=t.chainPath;const e={baseUrl:t.baseUrl??Cs};t.timeout!==void 0&&(e.timeout=t.timeout),t.fetch!==void 0&&(e.fetch=t.fetch),this.client=new Es(e)}path(t){return`/wallet/${this.chainPath}${t}`}async getLastBlock(){return this.client.get(this.path("/lastblock"))}async getBlockByHeight(t){return this.client.post(this.path("/block/query"),{height:t})}async getBalance(t){return this.client.post(this.path("/address/balance"),t)}async getAddressInfo(t){return this.client.post(this.path("/address/info"),{address:t})}async getAddressAssets(t){return this.client.post(this.path("/address/asset"),{address:t})}async getBlockAverageFee(){return this.client.get(this.path("/blockAveFee"))}async broadcastTransaction(t){return this.client.post(this.path("/transactions/broadcast"),t)}async queryTransactions(t){return this.client.post(this.path("/transactions/query"),t)}async queryPendingTransactions(t){return this.client.post(this.path("/pendingTr"),t)}async queryTokenList(t){return this.client.post(this.path("/assets"),t)}async queryTokenDetail(t){return this.client.post(this.path("/asset/details"),t)}}const wt=new Map;function ot(r,t){const e=`${r}|${t}`;let s=wt.get(e);return s||(s=new Rs({baseUrl:r,chainPath:t}),wt.set(e,s)),s}const bt=new Map,Tt=new Map;let K=null,j=null;function rt(r,t){return t||(r==="bfmeta"?"bfm":r)}function $s(){return typeof document<"u"?new URL("/configs/genesis",document.baseURI).href:"/configs/genesis"}async function Ps(r){const t=bt.get(r);if(t)return t;const e=`${$s()}/${r}.json`;let s;if(e.startsWith("http://")||e.startsWith("https://")){const n=await fetch(e);if(!n.ok)throw new Error(`Failed to fetch genesis block: ${n.status}`);s=await n.json()}else s=(await import(e)).default;return bt.set(r,s),s}async function xs(){const{sha256:r}=await Q(async()=>{const{sha256:a}=await import("./bioforest-uXX5qE5N.js").then(o=>o.Z);return{sha256:a}},[],import.meta.url),{md5:t,ripemd160:e}=await Q(async()=>{const{md5:a,ripemd160:o}=await import("./bioforest-uXX5qE5N.js").then(i=>i._);return{md5:a,ripemd160:o}},[],import.meta.url),s=a=>{const o=[];return{update(i){const l=typeof i=="string"?new TextEncoder().encode(i):i;return o.push(l),this},async digest(){const i=o.reduce((h,d)=>h+d.length,0),l=new Uint8Array(i);let u=0;for(const h of o)l.set(h,u),u+=h.length;return Buffer.from(a(l))}}};return{sha256(a){if(!a)return s(i=>r(i));const o=typeof a=="string"?new TextEncoder().encode(a):a;return Promise.resolve(Buffer.from(r(o)))},md5(a){if(!a)return s(i=>t(i));const o=typeof a=="string"?new TextEncoder().encode(a):a;return Promise.resolve(Buffer.from(t(o)))},ripemd160(a){if(!a)return s(i=>e(i));const o=typeof a=="string"?new TextEncoder().encode(a):a;return Promise.resolve(Buffer.from(e(o)))}}}async function Os(){return K||j||(j=(async()=>(K={setup:(await Q(()=>import("./bioforest-chain-bundle-CsZkxsox.js"),[],import.meta.url)).setup},K))(),j)}async function O(r){const t=await Ps(r),e=t.magic,s=Tt.get(e);if(s)return s;const n=await Os(),a=await xs(),o=await n.setup(t,a,{n:"KeyApp",m:"true",a:"web"});return Tt.set(e,o),o}async function H(r,t){const s=await ot(r,t).getLastBlock();return{height:s.height,timestamp:s.timestamp}}async function qt(r,t,e){const s=ot(r,t);try{return await s.getAddressInfo(e)??{address:e}}catch{return{address:e}}}async function Us(r){const t=await O(r.chainId),e=rt(r.chainId,r.apiPath),s=await H(r.rpcUrl,e),n=s.height,a=s.timestamp;let o=r.fee;o||(o=await t.transactionController.getTransferTransactionMinFee({transaction:{applyBlockHeight:n,timestamp:a,remark:r.remark??{}},assetInfo:{sourceChainName:await t.getChainName(),sourceChainMagic:await t.getMagic(),assetType:r.assetType,amount:r.amount}}));let i=!1;if(r.paySecret){const h=await qt(r.rpcUrl,e,r.from);h.secondPublicKey&&(i=await Gt(r.chainId,r.mainSecret,r.paySecret,h.secondPublicKey)==="v1")}const l={mainSecret:r.mainSecret,...r.paySecret?{paySecret:r.paySecret,usePaySecretV1:i}:{}},u={sourceChainName:await t.getChainName(),sourceChainMagic:await t.getMagic(),assetType:r.assetType,amount:r.amount};return t.transactionController.createTransferTransactionJSON({secrets:l,transaction:{fee:o,recipientId:r.to,applyBlockHeight:n,timestamp:a,remark:r.remark??{},effectiveBlockHeight:n+100},assetInfo:u})}async function Jt(r,t,e){const{nonce:s,...n}=e,o=await ot(r,t).broadcastTransaction(n);if(!o.success){const i=o.message??"Transaction rejected",l=o.minFee;throw new Error(l?`${i} (minFee: ${l})`:i)}return e.signature}async function Gt(r,t,e,s){const a=(await O(r)).accountBaseHelper();try{if((await a.createSecondSecretKeypairV2(t,e)).publicKey.toString("hex")===s)return"v2"}catch{}try{if((await a.createSecondSecretKeypair(t,e)).publicKey.toString("hex")===s)return"v1"}catch{}return!1}async function Ds(r,t,e){const s=await O(e),n=await H(r,t),a=n.height,o=n.timestamp;return s.transactionController.getSignatureTransactionMinFee({newPaySecret:`${Date.now()}getSignatureTransactionMinFee`,applyBlockHeight:a,timestamp:o})}async function Yt(r){const t=await O(r.chainId),e=rt(r.chainId,r.apiPath),s=await H(r.rpcUrl,e),n=s.height,a=s.timestamp;let o=r.fee;return o||(o=await t.transactionController.getSignatureTransactionMinFee({newPaySecret:r.newPaySecret,applyBlockHeight:n,timestamp:a})),t.transactionController.createSignatureTransactionJSON({mainSecret:r.mainSecret},{newPaySecret:r.newPaySecret,fee:o,applyBlockHeight:n,timestamp:a,effectiveBlockHeight:n+100})}async function Ls(r){const t=rt(r.chainId,r.apiPath),e=await Yt({rpcUrl:r.rpcUrl,chainId:r.chainId,apiPath:t,mainSecret:r.mainSecret,newPaySecret:r.newPaySecret});return await Jt(r.rpcUrl,t,e).catch(()=>{}),{txHash:e.signature,success:!0}}const Zs=Object.freeze(Object.defineProperty({__proto__:null,broadcastTransaction:Jt,createSignatureTransaction:Yt,createTransferTransaction:Us,getAddressInfo:qt,getBioforestCore:O,getLastBlock:H,getSignatureTransactionMinFee:Ds,setTwoStepSecret:Ls,verifyTwoStepSecret:Gt},Symbol.toStringTag,{value:"Module"}));class Ms{chainId;config=null;apiUrl="";apiPath="";constructor(t){this.chainId=t}getConfig(){if(!this.config){const t=y.getConfig(this.chainId);if(!t)throw new T(v.CHAIN_NOT_FOUND,`Chain config not found: ${this.chainId}`);this.config=t;const e=y.getBiowalletApi(t.id);this.apiUrl=e?.endpoint??"",this.apiPath=e?.path??t.id}return this.config}async estimateFee(t){const e=this.getConfig(),{decimals:s,symbol:n}=e,a=(o,i)=>({amount:o,estimatedTime:i});try{if(!this.apiUrl)throw new Error("No RPC URL configured");const o=await O(e.id),i=await H(this.apiUrl,this.apiPath),l=await o.transactionController.getTransferTransactionMinFee({transaction:{applyBlockHeight:i.height,timestamp:i.timestamp,remark:{}},assetInfo:{sourceChainName:await o.getChainName(),sourceChainMagic:await o.getMagic(),assetType:t.amount?.symbol??n,amount:t.amount?.toRawString()??"0"}}),u=p.fromRaw(l,s,n);return{slow:a(u,30),standard:a(u,15),fast:a(u.mul(2),5)}}catch(o){console.warn("[TransactionService] Failed to get min fee from SDK, using default:",o);const i=p.fromRaw("1000",s,n);return{slow:a(i,30),standard:a(i,15),fast:a(i.mul(2),5)}}}async buildTransaction(t){const e=this.getConfig();if(!t.from||!t.to)throw new T(v.INVALID_ADDRESS,"Invalid address");const s=await this.estimateFee(t);return{chainId:e.id,data:{type:"transfer",from:t.from,to:t.to,amount:t.amount.toRawString(),assetType:e.symbol,fee:s.standard.amount.toRawString(),memo:t.memo,timestamp:Date.now()}}}async signTransaction(t,e){const s=t.data,n=JSON.stringify({type:s.type,from:s.from,to:s.to,amount:s.amount,assetType:s.assetType,fee:s.fee,timestamp:s.timestamp,memo:s.memo??""}),a=It(n,e),o=ut(a);return{chainId:t.chainId,data:{...s,signature:o,publicKey:ut(e.slice(32,64))},signature:o}}async broadcastTransaction(t){if(this.getConfig(),!this.apiUrl)throw new T(v.NETWORK_ERROR,"RPC URL not configured");try{const e=await fetch(`${this.apiUrl}/wallet/${this.apiPath}/transactions/broadcast`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({transaction:t.data})});if(!e.ok){const n=await e.json().catch(()=>({}));throw new T(v.TRANSACTION_REJECTED,n.message??`Broadcast failed: ${e.status}`)}const s=await e.json();if(!s.success)throw new T(v.TRANSACTION_REJECTED,s.error?.message??"Broadcast failed");return t.signature}catch(e){throw e instanceof T?e:new T(v.NETWORK_ERROR,"Failed to broadcast transaction",void 0,e instanceof Error?e:void 0)}}async getTransactionStatus(t){if(this.getConfig(),!this.apiUrl)return{status:"pending",confirmations:0,requiredConfirmations:1};try{const e=await fetch(`${this.apiUrl}/wallet/${this.apiPath}/transactions/query`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({signature:t})});if(!e.ok)return{status:"pending",confirmations:0,requiredConfirmations:1};const s=await e.json();return s.success&&s.result?.trs?.[0]?.height?{status:"confirmed",confirmations:1,requiredConfirmations:1}:{status:"pending",confirmations:0,requiredConfirmations:1}}catch{return{status:"pending",confirmations:0,requiredConfirmations:1}}}async getTransaction(t){if(this.getConfig(),!this.apiUrl)return null;try{const e=await fetch(`${this.apiUrl}/wallet/${this.apiPath}/transactions/query`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({signature:t})});if(!e.ok)return null;const s=await e.json();if(!s.success||!s.result?.trs?.[0])return null;const n=s.result.trs[0],a=n.transaction,{decimals:o,symbol:i}=this.config,l=a.asset?.transferAsset?.amount??"0";return{hash:a.signature,from:a.senderId,to:a.recipientId??"",amount:p.fromRaw(l,o,i),fee:p.fromRaw(a.fee,o,i),status:{status:"confirmed",confirmations:1,requiredConfirmations:1},timestamp:a.timestamp*1e3,blockNumber:BigInt(n.height),type:"transfer"}}catch{return null}}async getTransactionHistory(t,e=20){const s=this.getConfig();if(!this.apiUrl)return console.warn("[TransactionService] No baseUrl configured for chain:",s.id),[];try{const n=`${this.apiUrl}/wallet/${this.apiPath}/lastblock`,a=await fetch(n);if(!a.ok)return console.warn("[TransactionService] Failed to get lastblock:",a.status),[];const o=await a.json();if(!o.success)return console.warn("[TransactionService] lastblock API returned success=false"),[];const i=o.result.height,l=`${this.apiUrl}/wallet/${this.apiPath}/transactions/query`,u=await fetch(l,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({maxHeight:i,address:t,page:1,pageSize:e,sort:-1})});if(!u.ok)return console.warn("[TransactionService] API error:",u.status,u.statusText,"for",l),[];const h=await u.json();if(!h.success)return console.warn("[TransactionService] API returned success=false"),[];const d=h.result?.trs??[];if(d.length===0)return console.debug("[TransactionService] No transactions found for",t,"on",s.id),[];const{decimals:f,symbol:g}=s;return d.map(b=>{const S=b.transaction,I=S.type,R=S.asset?.transferAsset,P=R?.amount??S.fee??"0",Xt=R?.assetType??g;return{hash:S.signature||`${b.signature}:${b.tIndex}`,from:S.senderId,to:S.recipientId??"",amount:p.fromRaw(P,f,Xt),fee:p.fromRaw(S.fee,f,g),status:{status:"confirmed",confirmations:1,requiredConfirmations:1},timestamp:S.timestamp*1e3,blockNumber:BigInt(b.height),type:"transfer",rawType:I}})}catch(n){return console.error("[TransactionService] Failed to fetch history:",n),[]}}}const Hs=[Pt,Ot,Et,Rt,Dt,Mt,Ft,jt,Vt];function Fs(r,t){for(const e of Hs){const s=e(r,t);if(s)return s}return null}function Ks(r){const t=[];switch(r.chainKind){case"evm":{const e=new ds(r.id),s=new ms(r.id),n=new ps(r.id);t.push(new D("wrapped-evm-tx",n,s),new L("wrapped-evm-identity",e));break}case"tron":{const e=new gs(r.id),s=new ys(r.id),n=new bs(r.id);t.push(new D("wrapped-tron-tx",n,s),new L("wrapped-tron-identity",e));break}case"bitcoin":{const e=new Ts(r.id),s=new vs(r.id),n=new Ss(r.id);t.push(new D("wrapped-bitcoin-tx",n,s),new L("wrapped-bitcoin-identity",e));break}case"bioforest":{const e=new ks(r.id),s=new Bs(r.id),n=new Ms(r.id);t.push(new D("wrapped-bioforest-tx",n,s),new L("wrapped-bioforest-identity",e));break}}return t}function zt(r){const t=y.getApi(r),e=y.getConfig(r),s=[];for(const n of t){const a=Fs(n,r);a&&s.push(a)}if(e){const n=Ks(e);s.push(...n)}return new _t(r,s)}const nt=new Map;function js(r){let t=nt.get(r);return t||(t=zt(r),nt.set(r,t)),t}function Ws(){nt.clear()}const Qs=Object.freeze(Object.defineProperty({__proto__:null,ActionSchema:St,AssetSchema:kt,BiowalletProvider:$t,BscWalletProvider:xt,BtcWalletProvider:Wt,ChainProvider:_t,DirectionSchema:At,EthWalletProvider:Ht,EtherscanProvider:Bt,EvmRpcProvider:Ct,InvalidDataError:Nt,MempoolProvider:Lt,TransactionSchema:tt,TronRpcProvider:Ut,TronWalletProvider:Kt,WrappedIdentityProvider:L,WrappedTransactionProvider:D,clearProviderCache:Ws,createBiowalletProvider:Pt,createBscWalletProvider:Ot,createBtcwalletProvider:Vt,createChainProvider:zt,createEtherscanProvider:Et,createEthwalletProvider:Ft,createEvmRpcProvider:Rt,createMempoolProvider:Mt,createTronRpcProvider:Dt,createTronwalletProvider:jt,getChainProvider:js},Symbol.toStringTag,{value:"Module"}));export{St as A,ks as B,ge as C,At as D,Nt as I,zt as a,y as b,Ws as c,kt as d,T as e,v as f,js as g,Bs as h,Ms as i,_t as j,qt as k,Ds as l,Us as m,Jt as n,Zs as o,Qs as p,Ls as s,Gt as v};
