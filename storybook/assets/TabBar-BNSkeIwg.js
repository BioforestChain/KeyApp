import{u as C,q as I,r as l,j as w}from"./iframe-d96jbflr.js";import{c as k}from"./utils-4perknFd.js";import{S as K,a as X}from"./swiper-CyzHqR6f.js";import{u as J,C as Q}from"./swiper-sync-context-Br2eLka3.js";import{e as O,b as H,d as D,o as Z}from"./index-D6n9pWCr.js";import{p as h,n as ee,g as te,b as se}from"./notification-DTrTLJtC.js";import{g as ae,C as F,r as V,l as ne,a as W,b as ie,p as re,i as oe}from"./index-BZA3ElqL.js";import{d as L,w as R}from"./user-profile-D9guGjlg.js";import{a as ce,u as le}from"./service-C5fu61FZ.js";import{u as de}from"./useTranslation-ClTwWhs-.js";import{c as ue}from"./createReactComponent-B3jwCrnC.js";import{I as U}from"./ecosystem-desktop-CbVyb8qy.js";import{I as $}from"./IconApps-Bo03Qv8L.js";import{I as fe}from"./IconWallet-D4Lz9xsA.js";import{I as me}from"./IconSettings-C3i80Qi8.js";const pe=[["path",{d:"M19 4a3 3 0 0 1 3 3v10a3 3 0 0 1 -3 3h-14a3 3 0 0 1 -3 -3v-10a3 3 0 0 1 3 -3zm-12.99 3l-.127 .007a1 1 0 0 0 .117 1.993l.127 -.007a1 1 0 0 0 -.117 -1.993zm3 0l-.127 .007a1 1 0 0 0 .117 1.993l.127 -.007a1 1 0 0 0 -.117 -1.993z",key:"svg-0"}]],q=ue("filled","app-window-filled","AppWindowFilled",pe);function Ye(){return C(R,a=>a.wallets)}function ge(){return C(R,a=>L.getCurrentWallet(a))}function he(){return C(R,a=>a.selectedChain)}function Oe(){return C(R,a=>a.chainPreferences)}function ye(){return C(R,a=>L.getCurrentChainAddress(a))}function Le(){return C(R,a=>L.hasWallet(a))}function He(){return C(R,a=>a.isInitialized)}const B={MAX_AUTO_RETRY:3,RETRY_INTERVAL:5e3,SYNC_INTERVAL:15e3,CONFIRM_TIMEOUT:300*1e3,CLEANUP_MAX_AGE:1440*60*1e3};class be{state={isRunning:!1,syncTimer:null,subscribers:new Set};start(){this.state.isRunning||(this.state.isRunning=!0,this.state.syncTimer=setInterval(()=>{this.syncAllPendingTransactions()},B.SYNC_INTERVAL),this.syncAllPendingTransactions())}stop(){this.state.isRunning&&(this.state.isRunning=!1,this.state.syncTimer&&(clearInterval(this.state.syncTimer),this.state.syncTimer=null))}subscribe(e){return this.state.subscribers.add(e),()=>{this.state.subscribers.delete(e)}}notifySubscribers(e){this.state.subscribers.forEach(d=>{try{d(e)}catch{}})}async syncAllPendingTransactions(){}async syncWalletPendingTransactions(e,d){try{await h.deleteExpired({walletId:e,maxAge:B.CLEANUP_MAX_AGE})>0;const u=await h.getPending({walletId:e});for(const s of u)await this.processPendingTransaction(s,d)}catch{}}async processPendingTransaction(e,d){switch(e.status){case"created":await this.tryBroadcast(e,d);break;case"failed":e.retryCount<B.MAX_AUTO_RETRY&&await this.tryBroadcast(e,d);break;case"broadcasted":break;case"broadcasting":if(Date.now()-e.updatedAt>3e4){const u=await h.updateStatus({id:e.id,status:"failed",errorMessage:I.t("transaction:broadcast.timeout")});this.notifySubscribers(u)}break}}async tryBroadcast(e,d){if(!ce.getChainById(d,e.chainId))return;const s=ae(e.chainId)?.broadcastTransaction;if(s)try{await h.updateStatus({id:e.id,status:"broadcasting"}),await h.incrementRetry({id:e.id});const t=await s(e.rawTx),f=await h.updateStatus({id:e.id,status:"broadcasted",txHash:t});this.notifySubscribers(f),this.sendNotification(f,"broadcasted")}catch(t){const f=t instanceof F||t instanceof Error?t.message:I.t("transaction:broadcast.failed"),T=t instanceof F?t.code:void 0,A=await h.updateStatus({id:e.id,status:"failed",errorCode:T,errorMessage:f});this.notifySubscribers(A),this.sendNotification(A,"failed")}}async retryBroadcast(e,d){const o=await h.getById({id:e});return o?(await this.tryBroadcast(o,d),h.getById({id:e})):null}sendNotification(e,d){const o=e.meta?.displayAmount??"",u=e.meta?.displaySymbol??"",s=e.meta?.type??"transfer";let t,f,T;switch(d){case"broadcasted":t=I.t("notification:pendingTx.broadcasted.title"),f=o?I.t("notification:pendingTx.broadcasted.message",{type:s,amount:o,symbol:u}):I.t("notification:pendingTx.broadcasted.messageSimple"),T="pending";break;case"confirmed":t=I.t("notification:pendingTx.confirmed.title"),f=o?I.t("notification:pendingTx.confirmed.message",{type:s,amount:o,symbol:u}):I.t("notification:pendingTx.confirmed.messageSimple"),T="success";break;case"failed":t=I.t("notification:pendingTx.failed.title"),f=e.errorMessage??I.t("notification:pendingTx.failed.message"),T="failed";break}ee.add({type:"transaction",title:t,message:f,data:{txHash:e.txHash,walletId:e.walletId,status:T,pendingTxId:e.id}})}}const z=new be;function Y(...a){const e=`[chain-effect] pending-tx ${a.join(" ")}`;ne(e,{args:a})}function we(a,e,d,o){const u=le(),s=e&&d?te(e,d):a,t=a&&a!==s?a:void 0,f=l.useMemo(()=>{if(!o?.length)return[];const i=new Set;for(const c of o)c?.hash&&i.add(c.hash.toLowerCase());return Array.from(i).toSorted()},[o]),T=l.useMemo(()=>f.join("|"),[f]),[A,b]=l.useState([]),[N,m]=l.useState(!1),g=l.useCallback(async()=>{if(!s)return[];const i=new Set([s]);t&&i.add(t);const c=await Promise.all(Array.from(i).map(r=>h.getPending({walletId:r}))),S=new Map;for(const r of c)for(const p of r)S.set(p.id,p);const y=Array.from(S.values()).toSorted((r,p)=>p.createdAt-r.createdAt);return Y("snapshot",s??"none",`len=${y.length}`),y},[s,t]);l.useEffect(()=>{if(!s){b([]),m(!1);return}let i=!0;if(m(!0),(async()=>{try{const r=await g();if(!i)return;b(r)}finally{i&&m(!1)}})(),(async()=>{e&&d&&await h.normalizeWalletKeyByAddress({chainId:e,address:d,walletId:s}),await h.deleteConfirmed({walletId:s}),t&&await h.deleteConfirmed({walletId:t});const r=await g();i&&b(r)})().catch(()=>{}),!e)return()=>{i=!1};const S=se(e,s,t);if(!S)return()=>{i=!1};let y;return V(S).then(r=>{const p=()=>{const n=W(r.changes.pipe(ie(x=>re(async()=>{if(!i)return;Y("changes",s??"none",`len=${x.length}`);const v=await g();i&&b(v)}))));y=()=>{W(oe(n)),W(r.stop)}};V(r.refresh).then(async n=>{if(!i)return;Y("refresh",s??"none",`len=${n.length}`);const x=await g();i&&b(x)}).finally(()=>{i&&p()})}).catch(()=>{}),()=>{i=!1,y?.()}},[s,e,d,t,g]),l.useEffect(()=>{s&&(z.syncWalletPendingTransactions(s,u),t&&z.syncWalletPendingTransactions(t,u))},[s,t,u]),l.useEffect(()=>{!s||f.length===0||(async()=>(await h.deleteByTxHash({walletId:s,txHashes:f}),t&&await h.deleteByTxHash({walletId:t,txHashes:f})))()},[s,t,T,f]),l.useEffect(()=>s?h.subscribe((c,S)=>{if(!(c.walletId!==s&&c.walletId!==t))if(S==="created"){if(c.status==="confirmed")return;b(y=>{const r=new Map;for(const p of y)r.set(p.id,p);return r.set(c.id,c),Array.from(r.values()).toSorted((p,n)=>n.createdAt-p.createdAt)})}else S==="updated"?b(y=>{if(c.status==="confirmed")return y.filter(p=>p.id!==c.id);const r=new Map;for(const p of y)r.set(p.id,p);return r.set(c.id,c),Array.from(r.values()).toSorted((p,n)=>n.createdAt-p.createdAt)}):S==="deleted"&&b(y=>y.filter(r=>r.id!==c.id))}):void 0,[s,t]);const E=l.useCallback(async i=>{await h.delete({id:i.id})},[]),M=l.useCallback(async i=>await z.retryBroadcast(i.id,u),[u]),_=l.useCallback(async()=>{const i=A.filter(c=>c.status==="failed");await Promise.all(i.map(c=>h.delete({id:c.id})))},[A]);return{transactions:A,isLoading:N,deleteTransaction:E,retryTransaction:M,clearAllFailed:_}}const G=["discover","mine","stack"],Te={discover:$,mine:U,stack:q};function Se(a,e){const o=a.length-1,u=l.useRef(null),s=l.useMemo(()=>{const m=O.state.activeSubPage,g=a.indexOf(m);return g>=0?g:0},[a]),{onSwiper:t,onSlideChange:f}=J("ecosystem-indicator","ecosystem-main",{initialIndex:s});l.useEffect(()=>{u.current&&(u.current.allowTouchMove=e)},[e]);const[T,A]=l.useState(0),b=o>0?T*o:0,N=m=>{const g=Math.abs(b-m);return Math.max(0,1-g)};return{icon:w.jsx(K,{className:"-my-2.5 !h-10 !w-15",modules:[Q],onSwiper:m=>{u.current=m,t(m)},onSlideChange:f,onProgress:(m,g)=>A(g),slidesPerView:"auto",centeredSlides:!0,spaceBetween:8,allowTouchMove:e,resistance:!0,resistanceRatio:.5,children:a.map((m,g)=>{const E=Te[m],M=N(g);return w.jsx(X,{className:"!flex !w-5 cursor-pointer !items-center !justify-center",children:w.jsx(E,{className:k("size-5 transition-opacity duration-100",e?"text-primary":"text-muted-foreground"),style:{opacity:M},stroke:1.5})},m)})}),label:w.jsx("div",{className:"flex h-4 items-center justify-center gap-1",children:a.map((m,g)=>{const E=Math.round(b)===g;return w.jsx("span",{className:k("size-1 rounded-full transition-all duration-200",E?"bg-primary scale-125":"bg-muted-foreground/40")},m)})})}}function xe({activeTab:a,onTabChange:e,className:d}){const{t:o}=de("common"),u=C(O,n=>n.activeSubPage),s=C(O,n=>n.availableSubPages),t=C(D,n=>H.getApps(n).length>0),f=C(D,H.hasRunningStackApps),T=ge(),A=ye(),b=he(),{transactions:N}=we(T?.id,b,A?.address),m=N.filter(n=>n.status!=="confirmed").length,g=a==="ecosystem",E=l.useMemo(()=>s?.length?s:f?G:G.filter(n=>n!=="stack"),[s,f]),M=Se(E,g),_=l.useMemo(()=>u==="stack"||t?q:u==="mine"?U:$,[u,t]),i=l.useMemo(()=>[{id:"wallet",label:o("a11y.tabWallet"),icon:fe},{id:"ecosystem",label:o("a11y.tabEcosystem"),icon:_},{id:"settings",label:o("a11y.tabSettings"),icon:me}],[o,_]),c=l.useRef({startY:0,startTime:0}),S=30,y=.3,r=l.useCallback(n=>{const x=n.touches[0];x&&(c.current={startY:x.clientY,startTime:Date.now()})},[]),p=l.useCallback(n=>{const x=n.changedTouches[0];if(!x)return;const v=c.current.startY-x.clientY,j=Date.now()-c.current.startTime,P=v/j;t&&(v>S||P>y)&&(n.preventDefault(),Z())},[t]);return w.jsx("div",{"data-testid":"tab-bar",className:k("fixed right-0 bottom-0 left-0 z-50","bg-background/80 supports-[backdrop-filter]:bg-background/60 border-t backdrop-blur-xl","pb-[env(safe-area-inset-bottom)]",d),style:{height:"var(--tab-bar-height)"},children:w.jsx("div",{className:"mx-auto flex h-[52px] max-w-md",children:i.map(n=>{const x=n.icon,v=a===n.id,j=n.label,P=n.id==="ecosystem";return w.jsxs("button",{onClick:()=>e(n.id),onTouchStart:P?r:void 0,onTouchEnd:P?p:void 0,"data-testid":`tab-${n.id}`,className:k("flex flex-1 flex-col items-center justify-center gap-1 transition-colors",v?"text-primary":"text-muted-foreground"),"aria-label":j,"aria-current":v?"page":void 0,children:[w.jsxs("div",{className:"relative",children:[P?M.icon:w.jsx(x,{className:k("size-5",v&&"text-primary"),stroke:1.5}),P&&t&&!v&&w.jsx("span",{className:"bg-primary absolute -top-0.5 -right-0.5 size-2 rounded-full"}),n.id==="wallet"&&m>0&&w.jsx("span",{className:"bg-destructive text-destructive-foreground absolute -top-1 -right-2 flex min-w-4 items-center justify-center rounded-full px-1 text-[10px] font-medium",children:m>9?"9+":m})]}),P&&v?M.label:w.jsx("span",{className:"text-xs font-medium",children:j})]},n.id)})})})}xe.__docgenInfo={description:"",methods:[],displayName:"TabBar",props:{activeTab:{required:!0,tsType:{name:"union",raw:"'wallet' | 'ecosystem' | 'settings'",elements:[{name:"literal",value:"'wallet'"},{name:"literal",value:"'ecosystem'"},{name:"literal",value:"'settings'"}]},description:""},onTabChange:{required:!0,tsType:{name:"signature",type:"function",raw:"(tab: TabId) => void",signature:{arguments:[{type:{name:"union",raw:"'wallet' | 'ecosystem' | 'settings'",elements:[{name:"literal",value:"'wallet'"},{name:"literal",value:"'ecosystem'"},{name:"literal",value:"'settings'"}]},name:"tab"}],return:{name:"void"}}},description:""},className:{required:!1,tsType:{name:"string"},description:""}}};export{xe as T,Le as a,Ye as b,ge as c,ye as d,he as e,Oe as f,we as g,z as p,He as u};
