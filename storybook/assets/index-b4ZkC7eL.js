const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./derivation-BNPn19nD.js","./iframe-BKKGzOJ9.js","./preload-helper-PPVm8Dsz.js","./iframe-BnfMbOkf.css","./service-6XO18RSB.js","./schemas-CO8_C8zP.js","./index-D0E7N0oa.js"])))=>i.map(i=>d[i]);
import{r as J}from"./iframe-BKKGzOJ9.js";import{c as le,e as HE}from"./service-6XO18RSB.js";import{A as se}from"./amount-BQsqQYGO.js";import{o as bd,s as mo,u as DE,c as UE}from"./schemas-CO8_C8zP.js";import"./index-D0E7N0oa.js";import{D as Aa,F as KE,u as jE,G as Ii,j as to,H as go,k as Cr,q as kr,I as HS,J as zm,K as Vm,L as qm}from"./derivation-BNPn19nD.js";import{c as zE,p as VE,i as qE,s as WE}from"./bioforest-Dms9Dixt.js";import{_ as ts}from"./preload-helper-PPVm8Dsz.js";class JE extends Error{source;chainId;method;issues;constructor(t){super(`[InvalidData] ${t.source}:${t.chainId}:${t.method}`,{cause:t.cause instanceof Error?t.cause:void 0}),this.name="InvalidDataError",this.source=t.source,this.chainId=t.chainId,this.method=t.method,this.issues=t.issues??[]}}const GE=e=>typeof e=="function",d=function(e,t){if(typeof e=="function")return function(){return e(arguments)?t.apply(this,arguments):n=>t(n,...arguments)};switch(e){case 0:case 1:throw new RangeError(`Invalid arity ${e}`);case 2:return function(n,r){return arguments.length>=2?t(n,r):function(s){return t(s,n)}};case 3:return function(n,r,s){return arguments.length>=3?t(n,r,s):function(o){return t(o,n,r)}};case 4:return function(n,r,s,o){return arguments.length>=4?t(n,r,s,o):function(i){return t(i,n,r,s)}};case 5:return function(n,r,s,o,i){return arguments.length>=5?t(n,r,s,o,i):function(c){return t(c,n,r,s,o)}};default:return function(){if(arguments.length>=e)return t.apply(this,arguments);const n=arguments;return function(r){return t(r,...n)}}}},ee=e=>e,_u=e=>()=>e,Wm=_u(!0),Kf=_u(!1),DS=_u(void 0),Ra=DS;function p(e,t,n,r,s,o,i,c,a){switch(arguments.length){case 1:return e;case 2:return t(e);case 3:return n(t(e));case 4:return r(n(t(e)));case 5:return s(r(n(t(e))));case 6:return o(s(r(n(t(e)))));case 7:return i(o(s(r(n(t(e))))));case 8:return c(i(o(s(r(n(t(e)))))));case 9:return a(c(i(o(s(r(n(t(e))))))));default:{let u=arguments[0];for(let l=1;l<arguments.length;l++)u=arguments[l](u);return u}}}const wu=e=>(t,n)=>t===n||e(t,n),YE=d(2,(e,t)=>wu((n,r)=>e(t(n),t(r)))),QE=e=>wu((t,n)=>{if(t.length!==n.length)return!1;for(let r=0;r<t.length;r++)if(!e(t[r],n[r]))return!1;return!0}),Jm="effect/GlobalValue";let ci;const be=(e,t)=>(ci||(globalThis[Jm]??=new Map,ci=globalThis[Jm]),ci.has(e)||ci.set(e,t()),ci.get(e)),mn=e=>typeof e=="string",hr=e=>typeof e=="number",Di=e=>typeof e=="boolean",vu=e=>typeof e=="bigint",jf=e=>typeof e=="symbol",fc=GE,XE=e=>e===void 0,ZE=e=>e!==void 0,Yl=e=>e!==null,eC=e=>!1,_d=e=>typeof e=="object"&&e!==null,mr=e=>_d(e)||fc(e),te=d(2,(e,t)=>mr(e)&&t in e),US=d(2,(e,t)=>te(e,"_tag")&&e._tag===t),Ns=e=>e==null,tC=e=>e!=null,nC=e=>e instanceof Date,KS=e=>typeof e=="string"||te(e,Symbol.iterator),rC=e=>_d(e)&&!Array.isArray(e),sC=e=>te(e,"then")&&fc(e.then),ku=e=>`BUG: ${e} - please report an issue at https://github.com/Effect-TS/effect/issues`;let jS=class zS{self;called=!1;constructor(t){this.self=t}next(t){return this.called?{value:t,done:!0}:(this.called=!0,{value:this.self,done:!1})}return(t){return{value:t,done:!0}}throw(t){throw t}[Symbol.iterator](){return new zS(this.self)}};const oC=335903614,iC=4150755663,cC=1481765933,aC=1284865837,uC=9007199254740992,lC=134217728;class fC{_state;constructor(t,n,r,s){return Ns(n)&&Ns(t)?(n=Math.random()*4294967295>>>0,t=0):Ns(n)&&(n=t,t=0),Ns(s)&&Ns(r)?(s=this._state?this._state[3]:iC,r=this._state?this._state[2]:oC):Ns(s)&&(s=r,r=0),this._state=new Int32Array([0,0,r>>>0,((s||0)|1)>>>0]),this._next(),Gm(this._state,this._state[0],this._state[1],t>>>0,n>>>0),this._next(),this}getState(){return[this._state[0],this._state[1],this._state[2],this._state[3]]}setState(t){this._state[0]=t[0],this._state[1]=t[1],this._state[2]=t[2],this._state[3]=t[3]|1}integer(t){return Math.round(this.number()*Number.MAX_SAFE_INTEGER)%t}number(){const t=(this._next()&67108863)*1,n=(this._next()&134217727)*1;return(t*lC+n)/uC}_next(){const t=this._state[0]>>>0,n=this._state[1]>>>0;hC(this._state,t,n,cC,aC),Gm(this._state,this._state[0],this._state[1],this._state[2],this._state[3]);let r=t>>>18,s=(n>>>18|t<<14)>>>0;r=(r^t)>>>0,s=(s^n)>>>0;const o=(s>>>27|r<<5)>>>0,i=t>>>27,c=(-i>>>0&31)>>>0;return(o>>>i|o<<c)>>>0}}function hC(e,t,n,r,s){let o=(n>>>16)*(s&65535)>>>0,i=(n&65535)*(s>>>16)>>>0,c=(n&65535)*(s&65535)>>>0,a=(n>>>16)*(s>>>16)+((i>>>16)+(o>>>16))>>>0;i=i<<16>>>0,c=c+i>>>0,c>>>0<i>>>0&&(a=a+1>>>0),o=o<<16>>>0,c=c+o>>>0,c>>>0<o>>>0&&(a=a+1>>>0),a=a+Math.imul(n,r)>>>0,a=a+Math.imul(t,s)>>>0,e[0]=a,e[1]=c}function Gm(e,t,n,r,s){let o=t+r>>>0;const i=n+s>>>0;i>>>0<n>>>0&&(o=o+1|0),e[0]=o,e[1]=i}const zf=Symbol.for("effect/Utils/YieldWrap");class hc{#e;constructor(t){this.#e=t}[zf](){return this.#e}}function dC(e){if(typeof e=="object"&&e!==null&&zf in e)return e[zf]();throw new Error(ku("yieldWrapGet"))}const cn=be("effect/Utils/isStructuralRegion",()=>({enabled:!1,tester:void 0})),VS={effect_internal_function:e=>e()},pC={effect_internal_function:e=>e()},mC=VS.effect_internal_function(()=>new Error().stack)?.includes("effect_internal_function")===!0,Dt=mC?VS.effect_internal_function:pC.effect_internal_function,Ql=be(Symbol.for("effect/Hash/randomHashCache"),()=>new WeakMap),he=Symbol.for("effect/Hash"),Y=e=>{if(cn.enabled===!0)return 0;switch(typeof e){case"number":return vd(e);case"bigint":return Ze(e.toString(10));case"boolean":return Ze(String(e));case"symbol":return Ze(String(e));case"string":return Ze(e);case"undefined":return Ze("undefined");case"function":case"object":return e===null?Ze("null"):e instanceof Date?Number.isNaN(e.getTime())?Ze("Invalid Date"):Y(e.toISOString()):e instanceof URL?Y(e.href):gC(e)?e[he]():wd(e);default:throw new Error(`BUG: unhandled typeof ${typeof e} - please report an issue at https://github.com/Effect-TS/effect/issues`)}},wd=e=>(Ql.has(e)||Ql.set(e,vd(Math.floor(Math.random()*Number.MAX_SAFE_INTEGER))),Ql.get(e)),ye=e=>t=>t*53^e,Tu=e=>e&3221225471|e>>>1&1073741824,gC=e=>te(e,he),vd=e=>{if(e!==e||e===1/0)return 0;let t=e|0;for(t!==e&&(t^=e*4294967295);e>4294967295;)t^=e/=4294967295;return Tu(t)},Ze=e=>{let t=5381,n=e.length;for(;n;)t=t*33^e.charCodeAt(--n);return Tu(t)},yC=(e,t)=>{let n=12289;for(let r=0;r<t.length;r++)n^=p(Ze(t[r]),ye(Y(e[t[r]])));return Tu(n)},qS=e=>yC(e,Object.keys(e)),dc=e=>{let t=6151;for(let n=0;n<e.length;n++)t=p(t,ye(Y(e[n])));return Tu(t)},Ye=function(){if(arguments.length===1){const n=arguments[0];return function(r){return Object.defineProperty(n,he,{value(){return r},enumerable:!1}),r}}const e=arguments[0],t=arguments[1];return Object.defineProperty(e,he,{value(){return t},enumerable:!1}),t},fe=Symbol.for("effect/Equal");function oe(){return arguments.length===1?e=>Oa(e,arguments[0]):Oa(arguments[0],arguments[1])}function Oa(e,t){if(e===t)return!0;const n=typeof e;if(n!==typeof t)return!1;if(n==="object"||n==="function"){if(e!==null&&t!==null){if(Pa(e)&&Pa(t))return Y(e)===Y(t)&&e[fe](t)?!0:cn.enabled&&cn.tester?cn.tester(e,t):!1;if(e instanceof Date&&t instanceof Date){const r=e.getTime(),s=t.getTime();return r===s||Number.isNaN(r)&&Number.isNaN(s)}else if(e instanceof URL&&t instanceof URL)return e.href===t.href}if(cn.enabled){if(Array.isArray(e)&&Array.isArray(t))return e.length===t.length&&e.every((r,s)=>Oa(r,t[s]));if(Object.getPrototypeOf(e)===Object.prototype&&Object.getPrototypeOf(t)===Object.prototype){const r=Object.keys(e),s=Object.keys(t);if(r.length===s.length){for(const o of r)if(!(o in t&&Oa(e[o],t[o])))return cn.tester?cn.tester(e,t):!1;return!0}}return cn.tester?cn.tester(e,t):!1}}return cn.enabled&&cn.tester?cn.tester(e,t):!1}const Pa=e=>te(e,fe),kd=()=>oe,Me=Symbol.for("nodejs.util.inspect.custom"),Ge=e=>{try{if(te(e,"toJSON")&&fc(e.toJSON)&&e.toJSON.length===0)return e.toJSON();if(Array.isArray(e))return e.map(Ge)}catch{return{}}return wC(e)},Xl="[Circular]";function SC(e){try{return e.toISOString()}catch{return"Invalid Date"}}function bC(e){try{const t=e.toString();return typeof t=="string"?t:String(t)}catch{return"[toString threw]"}}function Td(e){return mn(e)?JSON.stringify(e):String(e)}function Lr(e,t){const n=new WeakSet,r=(i,c)=>{const a=i?.constructor;return a&&a!==Object.prototype.constructor&&a.name?`${a.name}(${c})`:c},s=i=>{try{return Reflect.ownKeys(i)}catch{return["[ownKeys threw]"]}};function o(i,c=0){if(Array.isArray(i))return n.has(i)?Xl:(n.add(i),`[${i.map(a=>o(a,c)).join(",")}]`);if(nC(i))return SC(i);if(te(i,"toString")&&fc(i.toString)&&i.toString!==Object.prototype.toString&&i.toString!==Array.prototype.toString){const a=bC(i);return i instanceof Error&&i.cause?`${a} (cause: ${o(i.cause,c)})`:a}if(mn(i))return JSON.stringify(i);if(hr(i)||i==null||Di(i)||jf(i))return String(i);if(vu(i))return String(i)+"n";if(i instanceof Set||i instanceof Map)return n.has(i)?Xl:(n.add(i),`${i.constructor.name}(${o(Array.from(i),c)})`);if(mr(i)){if(n.has(i))return Xl;n.add(i);const a=s(i);{const u=`{${a.map(l=>`${Td(l)}:${o(i[l],c)}`).join(",")}}`;return r(i,u)}}return String(i)}return o(e,0)}const ct=e=>JSON.stringify(e,null,2),yo=(e,t=2)=>{if(typeof e=="string")return e;try{return typeof e=="object"?WS(e,t):String(e)}catch{return String(e)}},WS=(e,t)=>{let n=[];const r=JSON.stringify(e,(s,o)=>typeof o=="object"&&o!==null?n.includes(o)?void 0:n.push(o)&&(ns.fiberRefs!==void 0&&JS(o)?o[Ed](ns.fiberRefs):o):o,t);return n=void 0,r},Ed=Symbol.for("effect/Inspectable/Redactable"),JS=e=>typeof e=="object"&&e!==null&&Ed in e,ns=be("effect/Inspectable/redactableState",()=>({fiberRefs:void 0})),_C=(e,t)=>{const n=ns.fiberRefs;ns.fiberRefs=e;try{return t()}finally{ns.fiberRefs=n}},wC=e=>JS(e)&&ns.fiberRefs!==void 0?e[Ed](ns.fiberRefs):e,G=(e,t)=>{switch(t.length){case 0:return e;case 1:return t[0](e);case 2:return t[1](t[0](e));case 3:return t[2](t[1](t[0](e)));case 4:return t[3](t[2](t[1](t[0](e))));case 5:return t[4](t[3](t[2](t[1](t[0](e)))));case 6:return t[5](t[4](t[3](t[2](t[1](t[0](e))))));case 7:return t[6](t[5](t[4](t[3](t[2](t[1](t[0](e)))))));case 8:return t[7](t[6](t[5](t[4](t[3](t[2](t[1](t[0](e))))))));case 9:return t[8](t[7](t[6](t[5](t[4](t[3](t[2](t[1](t[0](e)))))))));default:{let n=e;for(let r=0,s=t.length;r<s;r++)n=t[r](n);return n}}},$i="Async",Eu="Commit",Ot="Failure",ua="OnFailure",Fa="OnSuccess",xa="OnSuccessAndFailure",Pt="Success",GS="Sync",vC="Tag",Vo="UpdateRuntimeFlags",Na="While",Ai="Iterator",YS="WithRuntime",la="Yield",Cd="RevertFlags";let kC="3.19.15";const Id=()=>kC,TC=Symbol.for("effect/Effect"),EC=Symbol.for("effect/Stream"),CC=Symbol.for("effect/Sink"),IC=Symbol.for("effect/Channel"),So={_R:e=>e,_E:e=>e,_A:e=>e,_V:Id()},$C={_A:e=>e,_In:e=>e,_L:e=>e,_E:e=>e,_R:e=>e},AC={_Env:e=>e,_InErr:e=>e,_InElem:e=>e,_InDone:e=>e,_OutErr:e=>e,_OutElem:e=>e,_OutDone:e=>e},pc={[TC]:So,[EC]:So,[CC]:$C,[IC]:AC,[fe](e){return this===e},[he](){return Ye(this,wd(this))},[Symbol.iterator](){return new jS(new hc(this))},pipe(){return G(this,arguments)}},$d={[he](){return Ye(this,qS(this))},[fe](e){const t=Object.keys(this),n=Object.keys(e);if(t.length!==n.length)return!1;for(const r of t)if(!(r in e&&oe(this[r],e[r])))return!1;return!0}},mc={...pc,_op:Eu},RC={...mc,...$d},OC=(function(){function e(){}return e.prototype=mc,e})(),QS=Symbol.for("effect/Option"),XS={...pc,[QS]:{_A:e=>e},[Me](){return this.toJSON()},toString(){return ct(this.toJSON())}},PC=Object.assign(Object.create(XS),{_tag:"Some",_op:"Some",[fe](e){return Ad(e)&&eb(e)&&oe(this.value,e.value)},[he](){return Ye(this,ye(Y(this._tag))(Y(this.value)))},toJSON(){return{_id:"Option",_tag:this._tag,value:Ge(this.value)}}}),FC=Y("None"),xC=Object.assign(Object.create(XS),{_tag:"None",_op:"None",[fe](e){return Ad(e)&&ZS(e)},[he](){return FC},toJSON(){return{_id:"Option",_tag:this._tag}}}),Ad=e=>te(e,QS),ZS=e=>e._tag==="None",eb=e=>e._tag==="Some",Rd=Object.create(xC),Ba=e=>{const t=Object.create(PC);return t.value=e,t},tb=Symbol.for("effect/Either"),nb={...pc,[tb]:{_R:e=>e},[Me](){return this.toJSON()},toString(){return ct(this.toJSON())}},NC=Object.assign(Object.create(nb),{_tag:"Right",_op:"Right",[fe](e){return Od(e)&&sb(e)&&oe(this.right,e.right)},[he](){return ye(Y(this._tag))(Y(this.right))},toJSON(){return{_id:"Either",_tag:this._tag,right:Ge(this.right)}}}),BC=Object.assign(Object.create(nb),{_tag:"Left",_op:"Left",[fe](e){return Od(e)&&rb(e)&&oe(this.left,e.left)},[he](){return ye(Y(this._tag))(Y(this.left))},toJSON(){return{_id:"Either",_tag:this._tag,left:Ge(this.left)}}}),Od=e=>te(e,tb),rb=e=>e._tag==="Left",sb=e=>e._tag==="Right",MC=e=>{const t=Object.create(BC);return t.left=e,t},LC=e=>{const t=Object.create(NC);return t.right=e,t},pe=LC,re=MC,HC=Od,vt=rb,Pn=sb,DC=d(2,(e,{onLeft:t,onRight:n})=>vt(e)?re(t(e.left)):pe(n(e.right))),UC=d(2,(e,t)=>vt(e)?re(t(e.left)):pe(e.right)),KC=d(2,(e,t)=>Pn(e)?pe(t(e.right)):re(e.left)),Kt=d(2,(e,{onLeft:t,onRight:n})=>vt(e)?t(e.left):n(e.right)),jC=Kt({onLeft:ee,onRight:ee}),ob=d(2,(e,t)=>{if(Pn(e))return e.right;throw t(e.left)}),zC=ob(()=>new Error("getOrThrow called on a Left")),ib=e=>e.length>0,cb=e=>(t,n)=>t===n?0:e(t,n),VC=cb((e,t)=>e<t?-1:1),ab=d(2,(e,t)=>cb((n,r)=>e(t(n),t(r)))),qC=e=>d(2,(t,n)=>e(t,n)===1),K=()=>Rd,U=Ba,WC=Ad,Ue=ZS,$e=eb,xe=d(2,(e,{onNone:t,onSome:n})=>Ue(e)?t():n(e.value)),qe=d(2,(e,t)=>Ue(e)?t():e.value),or=d(2,(e,t)=>Ue(e)?t():e),JC=d(2,(e,t)=>Ue(e)?U(t()):e),Cu=e=>e==null?K():U(e),An=qe(DS),GC=e=>(...t)=>{try{return U(e(...t))}catch{return K()}},no=d(2,(e,t)=>Ue(e)?K():U(t(e.value))),qo=d(2,(e,t)=>Ue(e)?K():t(e.value)),YC=d(2,(e,t)=>Ue(e)?K():Cu(t(e.value))),QC=qo,ai=d(2,(e,t)=>QC(e,n=>t(n)?Ba(n):Rd)),XC=e=>wu((t,n)=>Ue(t)?Ue(n):Ue(n)?!1:e(t.value,n.value)),ZC=e=>d(2,(t,n)=>Ue(t)?!1:e(t.value,n)),eI=kd(),tI=ZC(eI),nI=d(2,(e,t)=>Ue(e)?!1:t(e.value)),Ym=e=>(t,n)=>Ue(t)?n:Ue(n)?t:U(e(t.value,n.value)),rI=(...e)=>e,Iu=e=>new Array(e),sI=d(2,(e,t)=>{const n=Math.max(1,Math.floor(e)),r=new Array(n);for(let s=0;s<n;s++)r[s]=t(s);return r}),Ne=e=>Array.isArray(e)?e:Array.from(e),oI=e=>Array.isArray(e)?e:[e],iI=d(2,(e,{onEmpty:t,onNonEmpty:n})=>_t(e)?n(jt(e),ls(e)):t()),Ma=d(2,(e,t)=>[t,...e]),cI=d(2,(e,t)=>[...e,t]),ub=d(2,(e,t)=>Ne(e).concat(Ne(t))),aI=Array.isArray,uI=e=>e.length===0,lI=uI,fa=ib,_t=ib,lb=(e,t)=>e<0||e>=t.length,fI=(e,t)=>Math.floor(Math.min(Math.max(0,e),t.length)),hI=d(2,(e,t)=>{const n=Math.floor(t);return lb(n,e)?K():U(e[n])}),fb=d(2,(e,t)=>{const n=Math.floor(t);if(lb(n,e))throw new Error(`Index ${n} out of bounds`);return e[n]}),Ri=hI(0),jt=fb(0),dI=e=>_t(e)?U(hb(e)):K(),hb=e=>e[e.length-1],ls=e=>e.slice(1),pI=(e,t)=>{let n=0;for(const r of e){if(!t(r,n))break;n++}return n},mI=d(2,(e,t)=>db(e,pI(e,t))),gI=d(2,(e,t)=>{const n=Ne(e);return n.slice(fI(t,n),n.length)}),Qm=e=>Array.from(e).reverse(),Ui=d(2,(e,t)=>{const n=Array.from(e);return n.sort(t),n}),Xm=d(2,(e,t)=>yI(e,t,rI)),yI=d(3,(e,t,n)=>{const r=Ne(e),s=Ne(t);if(_t(r)&&_t(s)){const o=[n(jt(r),jt(s))],i=Math.min(r.length,s.length);for(let c=1;c<i;c++)o[c]=n(r[c],s[c]);return o}return[]}),SI=kd(),db=d(2,(e,t)=>{const n=Array.from(e),r=Math.floor(t);return _t(n)?r>=1?bI(n,r):[[],n]:[n,[]]}),bI=d(2,(e,t)=>{const n=Math.max(1,Math.floor(t));return n>=e.length?[bi(e),[]]:[Ma(e.slice(1,n),jt(e)),e.slice(n)]}),bi=e=>e.slice(),_I=d(3,(e,t,n)=>{const r=Ne(e),s=Ne(t);return _t(r)?_t(s)?pb(n)(ub(r,s)):r:s}),ha=d(2,(e,t)=>_I(e,t,SI)),fs=()=>[],yn=e=>[e],rs=d(2,(e,t)=>e.map(t)),La=d(2,(e,t)=>{if(lI(e))return[];const n=[];for(let r=0;r<e.length;r++){const s=t(e[r],r);for(let o=0;o<s.length;o++)n.push(s[o])}return n}),wI=La(ee),vI=d(2,(e,t)=>{const n=Ne(e),r=[];for(let s=0;s<n.length;s++){const o=t(n[s],s);$e(o)&&r.push(o.value)}return r}),kI=d(2,(e,t)=>{const n=Ne(e),r=[];for(let s=0;s<n.length;s++)t(n[s],s)&&r.push(n[s]);return r}),Pd=d(3,(e,t,n)=>Ne(e).reduce((r,s,o)=>n(r,s,o),t)),Zm=(e,t)=>{const n=[];let r=e,s;for(;$e(s=t(r));){const[o,i]=s.value;n.push(o),r=i}return n},Fd=QE,pb=d(2,(e,t)=>{const n=Ne(e);if(_t(n)){const r=[jt(n)],s=ls(n);for(const o of s)r.every(i=>!t(o,i))&&r.push(o);return r}return[]}),TI=e=>pb(e,kd()),Wo=d(2,(e,t)=>Ne(e).join(t)),mb=(e,t)=>{switch(t._tag){case"StringKeyword":case"TemplateLiteral":return Object.keys(e);case"SymbolKeyword":return Object.getOwnPropertySymbols(e);case"Refinement":return mb(e,t.from)}},gb=e=>{let t=!1,n;return()=>(t||(n=e(),t=!0),n)},yb=e=>Array.isArray(e),eg=e=>`[${Td(e)}]`,Sb=e=>yb(e)?e.map(eg).join(""):eg(e),Hr=(e,t,n,r)=>{let s=e;return n&&_t(n)&&(s+=`
at path: ${Sb(n)}`),t!==void 0&&(s+=`
details: ${t}`),r&&(s+=`
schema (${r._tag}): ${r}`),s},bb=(e,t,n)=>Hr("Unsupported schema or overlapping types",`cannot extend ${e} with ${t}`,n),EI=e=>Hr("Unsupported key schema",void 0,void 0,e),CI=e=>Hr("Unsupported literal",`literal value: ${Lr(e)}`),tg=e=>Hr("Duplicate index signature",`${e} index signature`),II=Hr("Unsupported index signature parameter","An index signature parameter type must be `string`, `symbol`, a template literal type or a refinement of the previous types"),$I=Hr("Invalid element","A required element cannot follow an optional element. ts(1257)"),ng=e=>Hr("Duplicate property signature transformation",`Duplicate key ${Lr(e)}`),_b=e=>Hr("Duplicate property signature",`Duplicate key ${Lr(e)}`),bo=VC,Ha=e=>e.replace(/[/\\^$*+?.()|[\]{}]/g,"\\$&"),AI=Symbol.for("effect/annotation/TypeConstructor"),RI=Symbol.for("effect/annotation/Brand"),OI=Symbol.for("effect/annotation/SchemaId"),wb=Symbol.for("effect/annotation/Message"),xd=Symbol.for("effect/annotation/MissingMessage"),$u=Symbol.for("effect/annotation/Identifier"),Wn=Symbol.for("effect/annotation/Title"),ro=Symbol.for("effect/annotation/AutoTitle"),Jo=Symbol.for("effect/annotation/Description"),vb=Symbol.for("effect/annotation/Examples"),kb=Symbol.for("effect/annotation/Default"),Tb=Symbol.for("effect/annotation/JSONSchema"),Eb=Symbol.for("effect/annotation/Arbitrary"),Cb=Symbol.for("effect/annotation/Pretty"),Ib=Symbol.for("effect/annotation/Equivalence"),PI=Symbol.for("effect/annotation/Documentation"),$b=Symbol.for("effect/annotation/Concurrency"),Ab=Symbol.for("effect/annotation/Batching"),Rb=Symbol.for("effect/annotation/ParseIssueTitle"),Ob=Symbol.for("effect/annotation/ParseOptions"),Pb=Symbol.for("effect/annotation/DecodingFallback"),Da=Symbol.for("effect/annotation/Surrogate"),FI=Symbol.for("effect/annotation/StableFilter"),zt=d(2,(e,t)=>Object.prototype.hasOwnProperty.call(e.annotations,t)?U(e.annotations[t]):K()),xI=zt(RI),NI=zt(wb),BI=zt(xd),Fb=zt(Wn),xb=zt(ro),Au=zt($u),Nb=zt(Jo),MI=zt($b),LI=zt(Ab),HI=zt(Rb),DI=zt(Ob),UI=zt(Pb),Bb=zt(Da),KI=zt(FI),jI=e=>nI(KI(e),t=>t===!0),Mb=Symbol.for("effect/annotation/JSONIdentifier"),zI=zt(Mb),VI=e=>or(zI(e),()=>Au(e));class Ru{typeParameters;decodeUnknown;encodeUnknown;annotations;_tag="Declaration";constructor(t,n,r,s={}){this.typeParameters=t,this.decodeUnknown=n,this.encodeUnknown=r,this.annotations=s}toString(){return qe(Dn(this),()=>"<declaration schema>")}toJSON(){return{_tag:this._tag,typeParameters:this.typeParameters.map(t=>t.toJSON()),annotations:ft(this.annotations)}}}const gr=e=>t=>t._tag===e;let Ua=class{literal;annotations;_tag="Literal";constructor(t,n={}){this.literal=t,this.annotations=n}toString(){return qe(Dn(this),()=>Lr(this.literal))}toJSON(){return{_tag:this._tag,literal:vu(this.literal)?String(this.literal):this.literal,annotations:ft(this.annotations)}}};const Oi=gr("Literal"),qI=new Ua(null);class WI{symbol;annotations;_tag="UniqueSymbol";constructor(t,n={}){this.symbol=t,this.annotations=n}toString(){return qe(Dn(this),()=>Lr(this.symbol))}toJSON(){return{_tag:this._tag,symbol:String(this.symbol),annotations:ft(this.annotations)}}}class JI{annotations;_tag="UndefinedKeyword";constructor(t={}){this.annotations=t}toString(){return Dr(this)}toJSON(){return{_tag:this._tag,annotations:ft(this.annotations)}}}const Vf=new JI({[Wn]:"undefined"});class GI{annotations;_tag="NeverKeyword";constructor(t={}){this.annotations=t}toString(){return Dr(this)}toJSON(){return{_tag:this._tag,annotations:ft(this.annotations)}}}const Nd=new GI({[Wn]:"never"});class YI{annotations;_tag="UnknownKeyword";constructor(t={}){this.annotations=t}toString(){return Dr(this)}toJSON(){return{_tag:this._tag,annotations:ft(this.annotations)}}}const Lb=new YI({[Wn]:"unknown"});class QI{annotations;_tag="AnyKeyword";constructor(t={}){this.annotations=t}toString(){return Dr(this)}toJSON(){return{_tag:this._tag,annotations:ft(this.annotations)}}}const XI=new QI({[Wn]:"any"});class ZI{annotations;_tag="StringKeyword";constructor(t={}){this.annotations=t}toString(){return Dr(this)}toJSON(){return{_tag:this._tag,annotations:ft(this.annotations)}}}const qf=new ZI({[Wn]:"string",[Jo]:"a string"}),Wf=gr("StringKeyword");class e${annotations;_tag="NumberKeyword";constructor(t={}){this.annotations=t}toString(){return Dr(this)}toJSON(){return{_tag:this._tag,annotations:ft(this.annotations)}}}const Jf=new e$({[Wn]:"number",[Jo]:"a number"}),rg=gr("NumberKeyword");class t${annotations;_tag="BooleanKeyword";constructor(t={}){this.annotations=t}toString(){return Dr(this)}toJSON(){return{_tag:this._tag,annotations:ft(this.annotations)}}}const Gf=new t$({[Wn]:"boolean",[Jo]:"a boolean"}),sg=gr("BooleanKeyword");class n${annotations;_tag="BigIntKeyword";constructor(t={}){this.annotations=t}toString(){return Dr(this)}toJSON(){return{_tag:this._tag,annotations:ft(this.annotations)}}}const r$=new n$({[Wn]:"bigint",[Jo]:"a bigint"}),s$=gr("SymbolKeyword");let Ou=class{type;annotations;constructor(t,n={}){this.type=t,this.annotations=n}toJSON(){return{type:this.type.toJSON(),annotations:ft(this.annotations)}}toString(){return String(this.type)}};class vs extends Ou{isOptional;constructor(t,n,r={}){super(t,r),this.isOptional=n}toJSON(){return{type:this.type.toJSON(),isOptional:this.isOptional,annotations:ft(this.annotations)}}toString(){return String(this.type)+(this.isOptional?"?":"")}}const Hb=e=>e.map(t=>t.type);class Bd{elements;rest;isReadonly;annotations;_tag="TupleType";constructor(t,n,r,s={}){this.elements=t,this.rest=n,this.isReadonly=r,this.annotations=s;let o=!1,i=!1;for(const c of t)if(c.isOptional)o=!0;else if(o){i=!0;break}if(i||o&&n.length>1)throw new Error($I)}toString(){return qe(Dn(this),()=>o$(this))}toJSON(){return{_tag:this._tag,elements:this.elements.map(t=>t.toJSON()),rest:this.rest.map(t=>t.toJSON()),isReadonly:this.isReadonly,annotations:ft(this.annotations)}}}const o$=e=>{const t=e.elements.map(String).join(", ");return iI(e.rest,{onEmpty:()=>`readonly [${t}]`,onNonEmpty:(n,r)=>{const s=String(n),o=s.includes(" | ")?`(${s})`:s;if(r.length>0){const i=r.map(String).join(", ");return e.elements.length>0?`readonly [${t}, ...${o}[], ${i}]`:`readonly [...${o}[], ${i}]`}else return e.elements.length>0?`readonly [${t}, ...${o}[]]`:`ReadonlyArray<${s}>`}})};class It extends vs{name;isReadonly;constructor(t,n,r,s,o){super(n,r,o),this.name=t,this.isReadonly=s}toString(){return(this.isReadonly?"readonly ":"")+String(this.name)+(this.isOptional?"?":"")+": "+this.type}toJSON(){return{name:String(this.name),type:this.type.toJSON(),isOptional:this.isOptional,isReadonly:this.isReadonly,annotations:ft(this.annotations)}}}const Db=e=>{switch(e._tag){case"StringKeyword":case"SymbolKeyword":case"TemplateLiteral":return!0;case"Refinement":return Db(e.from)}return!1};class Pu{type;isReadonly;parameter;constructor(t,n,r){if(this.type=n,this.isReadonly=r,Db(t))this.parameter=t;else throw new Error(II)}toString(){return(this.isReadonly?"readonly ":"")+`[x: ${this.parameter}]: ${this.type}`}toJSON(){return{parameter:this.parameter.toJSON(),type:this.type.toJSON(),isReadonly:this.isReadonly}}}class Ir{annotations;_tag="TypeLiteral";propertySignatures;indexSignatures;constructor(t,n,r={}){this.annotations=r;const s={};for(let i=0;i<t.length;i++){const c=t[i].name;if(Object.prototype.hasOwnProperty.call(s,c))throw new Error(_b(c));s[c]=null}const o={string:!1,symbol:!1};for(let i=0;i<n.length;i++){const c=Wb(n[i].parameter);if(Wf(c)){if(o.string)throw new Error(tg("string"));o.string=!0}else if(s$(c)){if(o.symbol)throw new Error(tg("symbol"));o.symbol=!0}}this.propertySignatures=t,this.indexSignatures=n}toString(){return qe(Dn(this),()=>i$(this))}toJSON(){return{_tag:this._tag,propertySignatures:this.propertySignatures.map(t=>t.toJSON()),indexSignatures:this.indexSignatures.map(t=>t.toJSON()),annotations:ft(this.annotations)}}}const og=e=>e.map(String).join("; "),i$=e=>{if(e.propertySignatures.length>0){const t=e.propertySignatures.map(String).join("; ");return e.indexSignatures.length>0?`{ ${t}; ${og(e.indexSignatures)} }`:`{ ${t} }`}else return e.indexSignatures.length>0?`{ ${og(e.indexSignatures)} }`:"{}"},ig=gr("TypeLiteral"),c$=Ui(ab(bo,e=>{switch(e._tag){case"AnyKeyword":return 0;case"UnknownKeyword":return 1;case"ObjectKeyword":return 2;case"StringKeyword":case"NumberKeyword":case"BooleanKeyword":case"BigIntKeyword":case"SymbolKeyword":return 3}return 4})),a$={string:"StringKeyword",number:"NumberKeyword",boolean:"BooleanKeyword",bigint:"BigIntKeyword"},Ub=e=>La(e,t=>Ld(t)?Ub(t.types):[t]),u$=e=>{const t=c$(e),n=[],r={},s=[];for(const o of t)switch(o._tag){case"NeverKeyword":break;case"AnyKeyword":return[XI];case"UnknownKeyword":return[Lb];case"ObjectKeyword":case"UndefinedKeyword":case"VoidKeyword":case"StringKeyword":case"NumberKeyword":case"BooleanKeyword":case"BigIntKeyword":case"SymbolKeyword":{r[o._tag]||(r[o._tag]=o,n.push(o));break}case"Literal":{const i=typeof o.literal;switch(i){case"string":case"number":case"bigint":case"boolean":{const c=a$[i];!r[c]&&!s.includes(o.literal)&&(s.push(o.literal),n.push(o));break}case"object":{s.includes(o.literal)||(s.push(o.literal),n.push(o));break}}break}case"UniqueSymbol":{!r.SymbolKeyword&&!s.includes(o.symbol)&&(s.push(o.symbol),n.push(o));break}case"TupleType":{r.ObjectKeyword||n.push(o);break}case"TypeLiteral":{o.propertySignatures.length===0&&o.indexSignatures.length===0?r["{}"]||(r["{}"]=o,n.push(o)):r.ObjectKeyword||n.push(o);break}default:n.push(o)}return n};let Sn=class Yf{types;annotations;static make=(t,n)=>Md(t)?new Yf(t,n):t.length===1?t[0]:Nd;static unify=(t,n)=>Yf.make(u$(Ub(t)),n);_tag="Union";constructor(t,n={}){this.types=t,this.annotations=n}toString(){return qe(Dn(this),()=>this.types.map(String).join(" | "))}toJSON(){return{_tag:this._tag,types:this.types.map(t=>t.toJSON()),annotations:ft(this.annotations)}}};const l$=(e,t)=>e.map(t),Md=e=>e.length>1,Ld=gr("Union"),Zl=be(Symbol.for("effect/Schema/AST/toJSONMemoMap"),()=>new WeakMap);class Ka{f;annotations;_tag="Suspend";constructor(t,n={}){this.f=t,this.annotations=n,this.f=gb(t)}toString(){return Dn(this).pipe(or(()=>qo(GC(this.f)(),t=>Dn(t))),qe(()=>"<suspended schema>"))}toJSON(){const t=this.f();let n=Zl.get(t);return n||(Zl.set(t,{_tag:this._tag}),n={_tag:this._tag,ast:t.toJSON(),annotations:ft(this.annotations)},Zl.set(t,n),n)}}let Kb=class{from;filter;annotations;_tag="Refinement";constructor(t,n,r={}){this.from=t,this.filter=n,this.annotations=r}toString(){return Au(this).pipe(qe(()=>xe(Jb(this),{onNone:()=>`{ ${this.from} | filter }`,onSome:t=>so(this.from)?String(this.from)+" & "+t:t})))}toJSON(){return{_tag:this._tag,from:this.from.toJSON(),annotations:ft(this.annotations)}}};const so=gr("Refinement"),ef={};let Gs=class{from;to;transformation;annotations;_tag="Transformation";constructor(t,n,r,s={}){this.from=t,this.to=n,this.transformation=r,this.annotations=s}toString(){return qe(Dn(this),()=>`(${String(this.from)} <-> ${String(this.to)})`)}toJSON(){return{_tag:this._tag,from:this.from.toJSON(),to:this.to.toJSON(),annotations:ft(this.annotations)}}};const f$=gr("Transformation");class jb{decode;encode;_tag="FinalTransformation";constructor(t,n){this.decode=t,this.encode=n}}const h$=e=>t=>t._tag===e;class d${_tag="ComposeTransformation"}const p$=new d$;let m$=class{from;to;decode;encode;constructor(t,n,r,s){this.from=t,this.to=n,this.decode=r,this.encode=s}};class Qf{propertySignatureTransformations;_tag="TypeLiteralTransformation";constructor(t){this.propertySignatureTransformations=t;const n={},r={};for(const s of t){const o=s.from;if(n[o])throw new Error(ng(o));n[o]=!0;const i=s.to;if(r[i])throw new Error(ng(i));r[i]=!0}}}const cg=h$("TypeLiteralTransformation"),Hd=(e,t)=>{const n=Object.getOwnPropertyDescriptors(e),r={...e.annotations};delete r[$u];const s={...r,...t},o=Bb(e);return $e(o)&&(s[Da]=Hd(o.value,t)),n.annotations.value=s,Object.create(Object.getPrototypeOf(e),n)},g$="[\\s\\S]*?",y$="[+-]?\\d*\\.?\\d+(?:[Ee][+-]?\\d+)?",zb=(e,t)=>{switch(e._tag){case"Literal":return Ha(String(e.literal));case"StringKeyword":return g$;case"NumberKeyword":return y$;case"TemplateLiteral":return Vb(e);case"Union":return e.types.map(n=>zb(n)).join("|")}},S$=(e,t,n,r)=>Ld(e)?`(${t})`:t,Vb=(e,t,n)=>{let r="";if(e.head!==""){const s=Ha(e.head);r+=s}for(const s of e.spans){const o=zb(s.type);if(r+=S$(s.type,o),s.literal!==""){const i=Ha(s.literal);r+=i}}return r},b$=e=>new RegExp(`^${Vb(e)}$`),ag=(e,t)=>{const n=[],r=[],s=o=>{switch(o._tag){case"NeverKeyword":break;case"StringKeyword":case"SymbolKeyword":case"TemplateLiteral":case"Refinement":r.push(new Pu(o,t,!0));break;case"Literal":if(mn(o.literal)||hr(o.literal))n.push(new It(o.literal,t,!1,!0));else throw new Error(CI(o.literal));break;case"Enums":{for(const[i,c]of o.enums)n.push(new It(c,t,!1,!0));break}case"UniqueSymbol":n.push(new It(o.symbol,t,!1,!0));break;case"Union":o.types.forEach(s);break;default:throw new Error(EI(o))}};return s(e),{propertySignatures:n,indexSignatures:r}},qb=e=>t=>{let n;for(const r of e)Object.prototype.hasOwnProperty.call(t.annotations,r)&&(n===void 0&&(n={}),n[r]=t.annotations[r]);return n},_$=e=>t=>{const n={...t.annotations};for(const r of e)delete n[r];return n},w$=qb([vb,kb,Tb,Eb,Cb,Ib]),ut=e=>{switch(e._tag){case"Declaration":{const t=un(e.typeParameters,ut);return t===e.typeParameters?e:new Ru(t,e.decodeUnknown,e.encodeUnknown,e.annotations)}case"TupleType":{const t=un(e.elements,s=>{const o=ut(s.type);return o===s.type?s:new vs(o,s.isOptional)}),n=Hb(e.rest),r=un(n,ut);return t===e.elements&&r===n?e:new Bd(t,r.map(s=>new Ou(s)),e.isReadonly,e.annotations)}case"TypeLiteral":{const t=un(e.propertySignatures,r=>{const s=ut(r.type);return s===r.type?r:new It(r.name,s,r.isOptional,r.isReadonly)}),n=un(e.indexSignatures,r=>{const s=ut(r.type);return s===r.type?r:new Pu(r.parameter,s,r.isReadonly)});return t===e.propertySignatures&&n===e.indexSignatures?e:new Ir(t,n,e.annotations)}case"Union":{const t=un(e.types,ut);return t===e.types?e:Sn.make(t,e.annotations)}case"Suspend":return new Ka(()=>ut(e.f()),e.annotations);case"Refinement":{const t=ut(e.from);return t===e.from?e:new Kb(t,e.filter,e.annotations)}case"Transformation":{const t=w$(e);return ut(t!==void 0?Hd(e.to,t):e.to)}}return e};function un(e,t){let n=!1;const r=Iu(e.length);for(let s=0;s<e.length;s++){const o=e[s],i=t(o);i!==o&&(n=!0),r[s]=i}return n?r:e}const In=(e,t)=>{switch(e._tag){case"Declaration":{const n=un(e.typeParameters,r=>In(r));return n===e.typeParameters?e:new Ru(n,e.decodeUnknown,e.encodeUnknown)}case"TupleType":{const n=un(e.elements,o=>{const i=In(o.type);return i===o.type?o:new vs(i,o.isOptional)}),r=Hb(e.rest),s=un(r,o=>In(o));return n===e.elements&&s===r?e:new Bd(n,s.map(o=>new Ou(o)),e.isReadonly)}case"TypeLiteral":{const n=un(e.propertySignatures,s=>{const o=In(s.type);return o===s.type?s:new It(s.name,o,s.isOptional,s.isReadonly)}),r=un(e.indexSignatures,s=>{const o=In(s.type);return o===s.type?s:new Pu(s.parameter,o,s.isReadonly)});return n===e.propertySignatures&&r===e.indexSignatures?e:new Ir(n,r)}case"Union":{const n=un(e.types,r=>In(r));return n===e.types?e:Sn.make(n)}case"Suspend":{let n;const r=VI(e);return $e(r)&&(n={[Mb]:`${r.value}Encoded`}),new Ka(()=>In(e.f()),n)}case"Refinement":return In(e.from);case"Transformation":return In(e.from)}return e},Xf=e=>In(e),ft=e=>{const t={};for(const n of Object.getOwnPropertySymbols(e))t[String(n)]=e[n];return t},Wb=e=>{switch(e._tag){case"StringKeyword":case"SymbolKeyword":case"TemplateLiteral":return e;case"Refinement":return Wb(e.from)}},Dr=e=>qe(Dn(e),()=>e._tag);function v$(e){return xe(xI(e),{onNone:()=>"",onSome:t=>t.map(n=>` & Brand<${Lr(n)}>`).join("")})}const Jb=e=>Fb(e).pipe(or(()=>Nb(e)),or(()=>xb(e)),no(t=>t+v$(e))),Dn=e=>or(Au(e),()=>Jb(e)),k$=Symbol.for("effect/Context/Tag"),ja=Symbol.for("effect/Context/Reference"),T$="effect/STM",E$=Symbol.for(T$),Gb={...pc,_op:"Tag",[E$]:So,[k$]:{_Service:e=>e,_Identifier:e=>e},toString(){return ct(this.toJSON())},toJSON(){return{_id:"Tag",key:this.key,stack:this.stack}},[Me](){return this.toJSON()},of(e){return e},context(e){return Xb(this,e)}},C$={...Gb,[ja]:ja},I$=e=>{const t=Error.stackTraceLimit;Error.stackTraceLimit=2;const n=new Error;Error.stackTraceLimit=t;const r=Object.create(Gb);return Object.defineProperty(r,"stack",{get(){return n.stack}}),r.key=e,r},$$=()=>(e,t)=>{const n=Error.stackTraceLimit;Error.stackTraceLimit=2;const r=new Error;Error.stackTraceLimit=n;function s(){}return Object.setPrototypeOf(s,C$),s.key=e,s.defaultValue=t.defaultValue,Object.defineProperty(s,"stack",{get(){return r.stack}}),s},Yb=Symbol.for("effect/Context"),A$={[Yb]:{_Services:e=>e},[fe](e){if(Qb(e)&&this.unsafeMap.size===e.unsafeMap.size){for(const t of this.unsafeMap.keys())if(!e.unsafeMap.has(t)||!oe(this.unsafeMap.get(t),e.unsafeMap.get(t)))return!1;return!0}return!1},[he](){return Ye(this,vd(this.unsafeMap.size))},pipe(){return G(this,arguments)},toString(){return ct(this.toJSON())},toJSON(){return{_id:"Context",services:Array.from(this.unsafeMap).map(Ge)}},[Me](){return this.toJSON()}},hs=e=>{const t=Object.create(A$);return t.unsafeMap=e,t},R$=e=>{const t=new Error(`Service not found${e.key?`: ${String(e.key)}`:""}`);if(e.stack){const n=e.stack.split(`
`);if(n.length>2){const r=n[2].match(/at (.*)/);r&&(t.message=t.message+` (defined at ${r[1]})`)}}if(t.stack){const n=t.stack.split(`
`);n.splice(1,3),t.stack=n.join(`
`)}return t},Qb=e=>te(e,Yb),O$=e=>te(e,ja),P$=hs(new Map),F$=()=>P$,Xb=(e,t)=>hs(new Map([[e.key,t]])),x$=d(3,(e,t,n)=>{const r=new Map(e.unsafeMap);return r.set(t.key,n),hs(r)}),tf=be("effect/Context/defaultValueCache",()=>new Map),Dd=e=>{if(tf.has(e.key))return tf.get(e.key);const t=e.defaultValue();return tf.set(e.key,t),t},N$=(e,t)=>e.unsafeMap.has(t.key)?e.unsafeMap.get(t.key):Dd(t),Zb=d(2,(e,t)=>{if(!e.unsafeMap.has(t.key)){if(ja in t)return Dd(t);throw R$(t)}return e.unsafeMap.get(t.key)}),B$=Zb,M$=d(2,(e,t)=>e.unsafeMap.has(t.key)?Ba(e.unsafeMap.get(t.key)):O$(t)?Ba(Dd(t)):Rd),L$=d(2,(e,t)=>{const n=new Map(e.unsafeMap);for(const[r,s]of t.unsafeMap)n.set(r,s);return hs(n)}),H$=(...e)=>{const t=new Map;for(let n=0;n<e.length;n++)e[n].unsafeMap.forEach((r,s)=>{t.set(s,r)});return hs(t)},ks=I$,D$=Qb,Ud=F$,U$=Xb,Jr=x$,e_=B$,t_=Zb,gc=M$,Fu=L$,K$=H$,xu=$$,n_=Symbol.for("effect/Chunk");function j$(e,t,n,r,s){for(let o=t;o<Math.min(e.length,t+s);o++)n[r+o-t]=e[o];return n}const r_=[],z$=e=>wu((t,n)=>t.length===n.length&&ir(t).every((r,s)=>e(r,cr(n,s)))),V$=z$(oe),q$={[n_]:{_A:e=>e},toString(){return ct(this.toJSON())},toJSON(){return{_id:"Chunk",values:ir(this).map(Ge)}},[Me](){return this.toJSON()},[fe](e){return Kd(e)&&V$(this,e)},[he](){return Ye(this,dc(ir(this)))},[Symbol.iterator](){switch(this.backing._tag){case"IArray":return this.backing.array[Symbol.iterator]();case"IEmpty":return r_[Symbol.iterator]();default:return ir(this)[Symbol.iterator]()}},pipe(){return G(this,arguments)}},Xe=e=>{const t=Object.create(q$);switch(t.backing=e,e._tag){case"IEmpty":{t.length=0,t.depth=0,t.left=t,t.right=t;break}case"IConcat":{t.length=e.left.length+e.right.length,t.depth=1+Math.max(e.left.depth,e.right.depth),t.left=e.left,t.right=e.right;break}case"IArray":{t.length=e.array.length,t.depth=0,t.left=bn,t.right=bn;break}case"ISingleton":{t.length=1,t.depth=0,t.left=bn,t.right=bn;break}case"ISlice":{t.length=e.length,t.depth=e.chunk.depth+1,t.left=bn,t.right=bn;break}}return t},Kd=e=>te(e,n_),bn=Xe({_tag:"IEmpty"}),We=()=>bn,da=(...e)=>Y$(e),Be=e=>Xe({_tag:"ISingleton",a:e}),Ki=e=>Kd(e)?e:rn(Ne(e)),Zf=(e,t,n)=>{switch(e.backing._tag){case"IArray":{j$(e.backing.array,0,t,n,e.length);break}case"IConcat":{Zf(e.left,t,n),Zf(e.right,t,n+e.left.length);break}case"ISingleton":{t[n]=e.backing.a;break}case"ISlice":{let r=0,s=n;for(;r<e.length;)t[s]=cr(e,r),r+=1,s+=1;break}}},W$=e=>{switch(e.backing._tag){case"IEmpty":return r_;case"IArray":return e.backing.array;default:{const t=new Array(e.length);return Zf(e,t,0),e.backing={_tag:"IArray",array:t},e.left=bn,e.right=bn,e.depth=0,t}}},ir=W$,J$=e=>{switch(e.backing._tag){case"IEmpty":case"ISingleton":return e;case"IArray":return Xe({_tag:"IArray",array:Qm(e.backing.array)});case"IConcat":return Xe({_tag:"IConcat",left:dr(e.backing.right),right:dr(e.backing.left)});case"ISlice":return rn(Qm(ir(e)))}},dr=J$,G$=d(2,(e,t)=>t<0||t>=e.length?K():U(cr(e,t))),rn=e=>e.length===0?We():e.length===1?Be(e[0]):Xe({_tag:"IArray",array:e}),Y$=e=>rn(e),cr=d(2,(e,t)=>{switch(e.backing._tag){case"IEmpty":throw new Error("Index out of bounds");case"ISingleton":{if(t!==0)throw new Error("Index out of bounds");return e.backing.a}case"IArray":{if(t>=e.length||t<0)throw new Error("Index out of bounds");return e.backing.array[t]}case"IConcat":return t<e.left.length?cr(e.left,t):cr(e.right,t-e.left.length);case"ISlice":return cr(e.backing.chunk,t+e.backing.offset)}}),_o=d(2,(e,t)=>St(e,Be(t))),xt=d(2,(e,t)=>St(Be(t),e)),eh=d(2,(e,t)=>{if(t<=0)return bn;if(t>=e.length)return e;switch(e.backing._tag){case"ISlice":return Xe({_tag:"ISlice",chunk:e.backing.chunk,length:t,offset:e.backing.offset});case"IConcat":return t>e.left.length?Xe({_tag:"IConcat",left:e.left,right:eh(e.right,t-e.left.length)}):eh(e.left,t);default:return Xe({_tag:"ISlice",chunk:e,offset:0,length:t})}}),ji=d(2,(e,t)=>{if(t<=0)return e;if(t>=e.length)return bn;switch(e.backing._tag){case"ISlice":return Xe({_tag:"ISlice",chunk:e.backing.chunk,offset:e.backing.offset+t,length:e.backing.length-t});case"IConcat":return t>e.left.length?ji(e.right,t-e.left.length):Xe({_tag:"IConcat",left:ji(e.left,t),right:e.right});default:return Xe({_tag:"ISlice",chunk:e,offset:t,length:e.length-t})}}),St=d(2,(e,t)=>{if(e.backing._tag==="IEmpty")return t;if(t.backing._tag==="IEmpty")return e;const n=t.depth-e.depth;if(Math.abs(n)<=1)return Xe({_tag:"IConcat",left:e,right:t});if(n<-1)if(e.left.depth>=e.right.depth){const r=St(e.right,t);return Xe({_tag:"IConcat",left:e.left,right:r})}else{const r=St(e.right.right,t);if(r.depth===e.depth-3){const s=Xe({_tag:"IConcat",left:e.right.left,right:r});return Xe({_tag:"IConcat",left:e.left,right:s})}else{const s=Xe({_tag:"IConcat",left:e.left,right:e.right.left});return Xe({_tag:"IConcat",left:s,right:r})}}else if(t.right.depth>=t.left.depth){const r=St(e,t.left);return Xe({_tag:"IConcat",left:r,right:t.right})}else{const r=St(e,t.left.left);if(r.depth===t.depth-3){const s=Xe({_tag:"IConcat",left:r,right:t.left.right});return Xe({_tag:"IConcat",left:s,right:t.right})}else{const s=Xe({_tag:"IConcat",left:t.left.right,right:t.right});return Xe({_tag:"IConcat",left:r,right:s})}}}),s_=d(2,(e,t)=>rn(vI(e,t))),Nu=d(2,(e,t)=>rn(kI(e,t))),Bu=e=>e.length===0,Un=e=>e.length>0,jd=G$(0),o_=e=>cr(e,0),Fn=o_,i_=d(2,(e,t)=>e.backing._tag==="ISingleton"?Be(t(e.backing.a,0)):rn(p(ir(e),rs((n,r)=>t(n,r))))),Q$=d(2,(e,t)=>[eh(e,t),ji(e,t)]),X$=d(2,(e,t)=>{let n=0;for(const r of ir(e)){if(t(r))break;n++}return Q$(e,n)}),rr=e=>ji(e,1),c_=Pd,th=Symbol.for("effect/Duration"),a_=BigInt(0),ug=BigInt(24),Vc=BigInt(60),nh=BigInt(1e3),lg=BigInt(1e6),fg=BigInt(1e9),Z$=/^(-?\d+(?:\.\d+)?)\s+(nanos?|micros?|millis?|seconds?|minutes?|hours?|days?|weeks?)$/,qt=e=>{if(u_(e))return e;if(hr(e))return ie(e);if(vu(e))return nf(e);if(Array.isArray(e)&&e.length===2&&e.every(hr))return e[0]===-1/0||e[1]===-1/0||Number.isNaN(e[0])||Number.isNaN(e[1])?wo:e[0]===1/0||e[1]===1/0?rA:nf(BigInt(Math.round(e[0]*1e9))+BigInt(Math.round(e[1])));if(mn(e)){const t=Z$.exec(e);if(t){const[n,r,s]=t,o=Number(r);switch(s){case"nano":case"nanos":return nf(BigInt(r));case"micro":case"micros":return sA(BigInt(r));case"milli":case"millis":return ie(o);case"second":case"seconds":return zd(o);case"minute":case"minutes":return oA(o);case"hour":case"hours":return iA(o);case"day":case"days":return cA(o);case"week":case"weeks":return aA(o)}}}throw new Error("Invalid DurationInput")},hg={_tag:"Millis",millis:0},eA={_tag:"Infinity"},tA={[th]:th,[he](){return Ye(this,qS(this.value))},[fe](e){return u_(e)&&gA(this,e)},toString(){return`Duration(${SA(this)})`},toJSON(){switch(this.value._tag){case"Millis":return{_id:"Duration",_tag:"Millis",millis:this.value.millis};case"Nanos":return{_id:"Duration",_tag:"Nanos",hrtime:lA(this)};case"Infinity":return{_id:"Duration",_tag:"Infinity"}}},[Me](){return this.toJSON()},pipe(){return G(this,arguments)}},Wt=e=>{const t=Object.create(tA);return hr(e)?isNaN(e)||e<=0?t.value=hg:Number.isFinite(e)?Number.isInteger(e)?t.value={_tag:"Millis",millis:e}:t.value={_tag:"Nanos",nanos:BigInt(Math.round(e*1e6))}:t.value=eA:e<=a_?t.value=hg:t.value={_tag:"Nanos",nanos:e},t},u_=e=>te(e,th),nA=e=>{switch(e.value._tag){case"Millis":return e.value.millis===0;case"Nanos":return e.value.nanos===a_;case"Infinity":return!1}},wo=Wt(0),rA=Wt(1/0),nf=e=>Wt(e),sA=e=>Wt(e*nh),ie=e=>Wt(e),zd=e=>Wt(e*1e3),oA=e=>Wt(e*6e4),iA=e=>Wt(e*36e5),cA=e=>Wt(e*864e5),aA=e=>Wt(e*6048e5),zi=e=>l_(e,{onMillis:t=>t,onNanos:t=>Number(t)/1e6}),uA=e=>{const t=qt(e);switch(t.value._tag){case"Infinity":throw new Error("Cannot convert infinite duration to nanos");case"Nanos":return t.value.nanos;case"Millis":return BigInt(Math.round(t.value.millis*1e6))}},lA=e=>{const t=qt(e);switch(t.value._tag){case"Infinity":return[1/0,0];case"Nanos":return[Number(t.value.nanos/fg),Number(t.value.nanos%fg)];case"Millis":return[Math.floor(t.value.millis/1e3),Math.round(t.value.millis%1e3*1e6)]}},l_=d(2,(e,t)=>{const n=qt(e);switch(n.value._tag){case"Nanos":return t.onNanos(n.value.nanos);case"Infinity":return t.onMillis(1/0);case"Millis":return t.onMillis(n.value.millis)}}),Mu=d(3,(e,t,n)=>{const r=qt(e),s=qt(t);if(r.value._tag==="Infinity"||s.value._tag==="Infinity")return n.onMillis(zi(r),zi(s));if(r.value._tag==="Nanos"||s.value._tag==="Nanos"){const o=r.value._tag==="Nanos"?r.value.nanos:BigInt(Math.round(r.value.millis*1e6)),i=s.value._tag==="Nanos"?s.value.nanos:BigInt(Math.round(s.value.millis*1e6));return n.onNanos(o,i)}return n.onMillis(r.value.millis,s.value.millis)}),fA=(e,t)=>Mu(e,t,{onMillis:(n,r)=>n===r,onNanos:(n,r)=>n===r}),hA=d(2,(e,t)=>l_(e,{onMillis:n=>Wt(n*t),onNanos:n=>Wt(n*BigInt(t))})),dA=d(2,(e,t)=>Mu(e,t,{onMillis:(n,r)=>Wt(n+r),onNanos:(n,r)=>Wt(n+r)})),pA=d(2,(e,t)=>Mu(e,t,{onMillis:(n,r)=>n<=r,onNanos:(n,r)=>n<=r})),mA=d(2,(e,t)=>Mu(e,t,{onMillis:(n,r)=>n>=r,onNanos:(n,r)=>n>=r})),gA=d(2,(e,t)=>fA(qt(e),qt(t))),yA=e=>{const t=qt(e);if(t.value._tag==="Infinity")return{days:1/0,hours:1/0,minutes:1/0,seconds:1/0,millis:1/0,nanos:1/0};const n=uA(t),r=n/lg,s=r/nh,o=s/Vc,i=o/Vc,c=i/ug;return{days:Number(c),hours:Number(i%ug),minutes:Number(o%Vc),seconds:Number(s%Vc),millis:Number(r%nh),nanos:Number(n%lg)}},SA=e=>{const t=qt(e);if(t.value._tag==="Infinity")return"Infinity";if(nA(t))return"0";const n=yA(t),r=[];return n.days!==0&&r.push(`${n.days}d`),n.hours!==0&&r.push(`${n.hours}h`),n.minutes!==0&&r.push(`${n.minutes}m`),n.seconds!==0&&r.push(`${n.seconds}s`),n.millis!==0&&r.push(`${n.millis}ms`),n.nanos!==0&&r.push(`${n.nanos}ns`),r.join(" ")},ds=5,Vd=Math.pow(2,ds),bA=Vd-1,_A=Vd/2,wA=Vd/4;function vA(e){return e-=e>>1&1431655765,e=(e&858993459)+(e>>2&858993459),e=e+(e>>4)&252645135,e+=e>>8,e+=e>>16,e&127}function vo(e,t){return t>>>e&bA}function Ys(e){return 1<<e}function f_(e,t){return vA(e&t-1)}const kA=(e,t)=>({value:e,previous:t});function oo(e,t,n,r){let s=r;if(!e){const o=r.length;s=new Array(o);for(let i=0;i<o;++i)s[i]=r[i]}return s[t]=n,s}function h_(e,t,n){const r=n.length-1;let s=0,o=0,i=n;if(e)s=o=t;else for(i=new Array(r);s<t;)i[o++]=n[s++];for(++s;s<=r;)i[o++]=n[s++];return e&&(i.length=r),i}function TA(e,t,n,r){const s=r.length;if(e){let a=s;for(;a>=t;)r[a--]=r[a];return r[t]=n,r}let o=0,i=0;const c=new Array(s+1);for(;o<t;)c[i++]=r[o++];for(c[t]=n;o<s;)c[++i]=r[o++];return c}class Rr{_tag="EmptyNode";modify(t,n,r,s,o,i){const c=r(K());return Ue(c)?new Rr:(++i.value,new ss(t,s,o,c))}}function _n(e){return US(e,"EmptyNode")}function EA(e){return _n(e)||e._tag==="LeafNode"||e._tag==="CollisionNode"}function Lu(e,t){return _n(e)?!1:t===e.edit}class ss{edit;hash;key;value;_tag="LeafNode";constructor(t,n,r,s){this.edit=t,this.hash=n,this.key=r,this.value=s}modify(t,n,r,s,o,i){if(oe(o,this.key)){const a=r(this.value);return a===this.value?this:Ue(a)?(--i.value,new Rr):Lu(this,t)?(this.value=a,this):new ss(t,s,o,a)}const c=r(K());return Ue(c)?this:(++i.value,d_(t,n,this.hash,this,s,new ss(t,s,o,c)))}}class qd{edit;hash;children;_tag="CollisionNode";constructor(t,n,r){this.edit=t,this.hash=n,this.children=r}modify(t,n,r,s,o,i){if(s===this.hash){const a=Lu(this,t),u=this.updateCollisionList(a,t,this.hash,this.children,r,o,i);return u===this.children?this:u.length>1?new qd(t,this.hash,u):u[0]}const c=r(K());return Ue(c)?this:(++i.value,d_(t,n,this.hash,this,s,new ss(t,s,o,c)))}updateCollisionList(t,n,r,s,o,i,c){const a=s.length;for(let l=0;l<a;++l){const f=s[l];if("key"in f&&oe(i,f.key)){const h=f.value,m=o(h);return m===h?s:Ue(m)?(--c.value,h_(t,l,s)):oo(t,l,new ss(n,r,i,m),s)}}const u=o(K());return Ue(u)?s:(++c.value,oo(t,a,new ss(n,r,i,u),s))}}class ko{edit;mask;children;_tag="IndexedNode";constructor(t,n,r){this.edit=t,this.mask=n,this.children=r}modify(t,n,r,s,o,i){const c=this.mask,a=this.children,u=vo(n,s),l=Ys(u),f=f_(c,l),h=c&l,m=Lu(this,t);if(!h){const C=new Rr().modify(t,n+ds,r,s,o,i);return C?a.length>=_A?IA(t,u,C,c,a):new ko(t,c|l,TA(m,f,C,a)):this}const y=a[f],b=y.modify(t,n+ds,r,s,o,i);if(y===b)return this;let _=c,k;if(_n(b)){if(_&=~l,!_)return new Rr;if(a.length<=2&&EA(a[f^1]))return a[f^1];k=h_(m,f,a)}else k=oo(m,f,b,a);return m?(this.mask=_,this.children=k,this):new ko(t,_,k)}}class Wd{edit;size;children;_tag="ArrayNode";constructor(t,n,r){this.edit=t,this.size=n,this.children=r}modify(t,n,r,s,o,i){let c=this.size;const a=this.children,u=vo(n,s),l=a[u],f=(l||new Rr).modify(t,n+ds,r,s,o,i);if(l===f)return this;const h=Lu(this,t);let m;if(_n(l)&&!_n(f))++c,m=oo(h,u,f,a);else if(!_n(l)&&_n(f)){if(--c,c<=wA)return CA(t,c,u,a);m=oo(h,u,new Rr,a)}else m=oo(h,u,f,a);return h?(this.size=c,this.children=m,this):new Wd(t,c,m)}}function CA(e,t,n,r){const s=new Array(t-1);let o=0,i=0;for(let c=0,a=r.length;c<a;++c)if(c!==n){const u=r[c];u&&!_n(u)&&(s[o++]=u,i|=1<<c)}return new ko(e,i,s)}function IA(e,t,n,r,s){const o=[];let i=r,c=0;for(let a=0;i;++a)i&1&&(o[a]=s[c++]),i>>>=1;return o[t]=n,new Wd(e,c+1,o)}function $A(e,t,n,r,s,o){if(n===s)return new qd(e,n,[o,r]);const i=vo(t,n),c=vo(t,s);if(i===c)return a=>new ko(e,Ys(i)|Ys(c),[a]);{const a=i<c?[r,o]:[o,r];return new ko(e,Ys(i)|Ys(c),a)}}function d_(e,t,n,r,s,o){let i,c=t;for(;;){const a=$A(e,c,n,r,s,o);if(typeof a=="function")i=kA(a,i),c=c+ds;else{let u=a;for(;i!=null;)u=i.value(u),i=i.previous;return u}}}const p_="effect/HashMap",rh=Symbol.for(p_),AA={[rh]:rh,[Symbol.iterator](){return new Hu(this,(e,t)=>[e,t])},[he](){let e=Y(p_);for(const t of this)e^=p(Y(t[0]),ye(Y(t[1])));return Ye(this,e)},[fe](e){if(PA(e)){if(e._size!==this._size)return!1;for(const t of this){const n=p(e,Gd(t[0],Y(t[0])));if(Ue(n))return!1;if(!oe(t[1],n.value))return!1}return!0}return!1},toString(){return ct(this.toJSON())},toJSON(){return{_id:"HashMap",values:Array.from(this).map(Ge)}},[Me](){return this.toJSON()},pipe(){return G(this,arguments)}},Jd=(e,t,n,r)=>{const s=Object.create(AA);return s._editable=e,s._edit=t,s._root=n,s._size=r,s};class Hu{map;f;v;constructor(t,n){this.map=t,this.f=n,this.v=m_(this.map._root,this.f,void 0)}next(){if(Ue(this.v))return{done:!0,value:void 0};const t=this.v.value;return this.v=za(t.cont),{done:!1,value:t.value}}[Symbol.iterator](){return new Hu(this.map,this.f)}}const za=e=>e?g_(e[0],e[1],e[2],e[3],e[4]):K(),m_=(e,t,n=void 0)=>{switch(e._tag){case"LeafNode":return $e(e.value)?U({value:t(e.key,e.value.value),cont:n}):za(n);case"CollisionNode":case"ArrayNode":case"IndexedNode":{const r=e.children;return g_(r.length,r,0,t,n)}default:return za(n)}},g_=(e,t,n,r,s)=>{for(;n<e;){const o=t[n++];if(o&&!_n(o))return m_(o,r,[e,t,n,r,s])}return za(s)},RA=Jd(!1,0,new Rr,0),Du=()=>RA,OA=e=>{const t=S_(Du());for(const n of e)Vi(t,n[0],n[1]);return MA(t)},PA=e=>te(e,rh),FA=e=>e&&_n(e._root),xA=d(2,(e,t)=>Gd(e,t,Y(t))),Gd=d(3,(e,t,n)=>{let r=e._root,s=0;for(;;)switch(r._tag){case"LeafNode":return oe(t,r.key)?r.value:K();case"CollisionNode":{if(n===r.hash){const o=r.children;for(let i=0,c=o.length;i<c;++i){const a=o[i];if("key"in a&&oe(t,a.key))return a.value}}return K()}case"IndexedNode":{const o=vo(s,n),i=Ys(o);if(r.mask&i){r=r.children[f_(r.mask,i)],s+=ds;break}return K()}case"ArrayNode":{if(r=r.children[vo(s,n)],r){s+=ds;break}return K()}default:return K()}}),NA=d(2,(e,t)=>$e(Gd(e,t,Y(t)))),Vi=d(3,(e,t,n)=>Yd(e,t,()=>U(n))),BA=d(3,(e,t,n)=>e._editable?(e._root=t,e._size=n,e):t===e._root?e:Jd(e._editable,e._edit,t,n)),y_=e=>new Hu(e,t=>t),sh=e=>e._size,S_=e=>Jd(!0,e._edit+1,e._root,e._size),MA=e=>(e._editable=!1,e),Yd=d(3,(e,t,n)=>LA(e,t,Y(t),n)),LA=d(4,(e,t,n,r)=>{const s={value:e._size},o=e._root.modify(e._editable?e._edit:NaN,0,r,n,t,s);return p(e,BA(o,s.value))}),dg=d(2,(e,t)=>Yd(e,t,K)),HA=d(2,(e,t)=>Uu(e,Du(),(n,r,s)=>Vi(n,s,t(r,s)))),DA=d(2,(e,t)=>Uu(e,void 0,(n,r,s)=>t(r,s))),Uu=d(3,(e,t,n)=>{const r=e._root;if(r._tag==="LeafNode")return $e(r.value)?n(t,r.value.value,r.key):t;if(r._tag==="EmptyNode")return t;const s=[r.children];let o;for(;o=s.pop();)for(let i=0,c=o.length;i<c;){const a=o[i++];a&&!_n(a)&&(a._tag==="LeafNode"?$e(a.value)&&(t=n(t,a.value.value,a.key)):s.push(a.children))}return t}),b_="effect/HashSet",oh=Symbol.for(b_),UA={[oh]:oh,[Symbol.iterator](){return y_(this._keyMap)},[he](){return Ye(this,ye(Y(this._keyMap))(Y(b_)))},[fe](e){return KA(e)?sh(this._keyMap)===sh(e._keyMap)&&oe(this._keyMap,e._keyMap):!1},toString(){return ct(this.toJSON())},toJSON(){return{_id:"HashSet",values:Array.from(this).map(Ge)}},[Me](){return this.toJSON()},pipe(){return G(this,arguments)}},Ku=e=>{const t=Object.create(UA);return t._keyMap=e,t},KA=e=>te(e,oh),jA=Ku(Du()),ju=()=>jA,zA=e=>{const t=Qd(ju());for(const n of e)qi(t,n);return Xd(t)},VA=(...e)=>{const t=Qd(ju());for(const n of e)qi(t,n);return Xd(t)},qA=d(2,(e,t)=>NA(e._keyMap,t)),WA=e=>sh(e._keyMap),Qd=e=>Ku(S_(e._keyMap)),Xd=e=>(e._keyMap._editable=!1,e),__=d(2,(e,t)=>{const n=Qd(e);return t(n),Xd(n)}),qi=d(2,(e,t)=>e._keyMap._editable?(Vi(t,!0)(e._keyMap),e):Ku(Vi(t,!0)(e._keyMap))),w_=d(2,(e,t)=>e._keyMap._editable?(dg(t)(e._keyMap),e):Ku(dg(t)(e._keyMap))),JA=d(2,(e,t)=>__(e,n=>{for(const r of t)w_(n,r)})),GA=d(2,(e,t)=>__(ju(),n=>{YA(e,r=>qi(n,r));for(const r of t)qi(n,r)})),YA=d(2,(e,t)=>DA(e._keyMap,(n,r)=>t(r))),QA=d(3,(e,t,n)=>Uu(e._keyMap,t,(r,s,o)=>n(r,o))),ps=ju,XA=zA,Zd=VA,ZA=qA,ep=WA,Pi=qi,v_=w_,pg=JA,Wi=GA,Ji=QA,mg=Symbol.for("effect/MutableRef"),e1={[mg]:mg,toString(){return ct(this.toJSON())},toJSON(){return{_id:"MutableRef",current:Ge(this.current)}},[Me](){return this.toJSON()},pipe(){return G(this,arguments)}},Ts=e=>{const t=Object.create(e1);return t.current=e,t},t1=d(3,(e,t,n)=>oe(t,e.current)?(e.current=n,!0):!1),_e=e=>e.current,Es=d(2,(e,t)=>(e.current=t,e)),zu="effect/FiberId",ms=Symbol.for(zu),To="None",ih="Runtime",ch="Composite",n1=Ze(`${zu}-${To}`);let r1=class{[ms]=ms;_tag=To;id=-1;startTimeMillis=-1;[he](){return n1}[fe](t){return tp(t)&&t._tag===To}toString(){return ct(this.toJSON())}toJSON(){return{_id:"FiberId",_tag:this._tag}}[Me](){return this.toJSON()}};class s1{id;startTimeMillis;[ms]=ms;_tag=ih;constructor(t,n){this.id=t,this.startTimeMillis=n}[he](){return Ye(this,Ze(`${zu}-${this._tag}-${this.id}-${this.startTimeMillis}`))}[fe](t){return tp(t)&&t._tag===ih&&this.id===t.id&&this.startTimeMillis===t.startTimeMillis}toString(){return ct(this.toJSON())}toJSON(){return{_id:"FiberId",_tag:this._tag,id:this.id,startTimeMillis:this.startTimeMillis}}[Me](){return this.toJSON()}}let o1=class{left;right;[ms]=ms;_tag=ch;constructor(t,n){this.left=t,this.right=n}_hash;[he](){return p(Ze(`${zu}-${this._tag}`),ye(Y(this.left)),ye(Y(this.right)),Ye(this))}[fe](t){return tp(t)&&t._tag===ch&&oe(this.left,t.left)&&oe(this.right,t.right)}toString(){return ct(this.toJSON())}toJSON(){return{_id:"FiberId",_tag:this._tag,left:Ge(this.left),right:Ge(this.right)}}[Me](){return this.toJSON()}};const k_=new r1,tp=e=>te(e,ms),T_=d(2,(e,t)=>e._tag===To?t:t._tag===To?e:new o1(e,t)),i1=e=>p(e,Ji(k_,(t,n)=>T_(n)(t))),ah=e=>{switch(e._tag){case To:return ps();case ih:return Zd(e.id);case ch:return p(ah(e.left),Wi(ah(e.right)))}},gg=be(Symbol.for("effect/Fiber/Id/_fiberCounter"),()=>Ts(0)),E_=e=>Array.from(ah(e)).map(n=>`#${n}`).join(","),c1=()=>{const e=_e(gg);return p(gg,Es(e+1)),new s1(e,Date.now())},Eo=k_,a1=T_,u1=i1,l1=E_,C_=c1,np=Du,f1=OA,h1=FA,I_=xA,$_=Vi,A_=y_,d1=Yd,p1=HA,R_=Uu,Gi=Symbol.for("effect/List"),uh=e=>Ne(e),m1=e=>YE(Fd(e),uh),g1=m1(oe),y1={[Gi]:Gi,_tag:"Cons",toString(){return ct(this.toJSON())},toJSON(){return{_id:"List",_tag:"Cons",values:uh(this).map(Ge)}},[Me](){return this.toJSON()},[fe](e){return P_(e)&&this._tag===e._tag&&g1(this,e)},[he](){return Ye(this,dc(uh(this)))},[Symbol.iterator](){let e=!1,t=this;return{next(){if(e)return this.return();if(t._tag==="Nil")return e=!0,this.return();const n=t.head;return t=t.tail,{done:e,value:n}},return(n){return e||(e=!0),{done:!0,value:n}}}},pipe(){return G(this,arguments)}},Va=(e,t)=>{const n=Object.create(y1);return n.head=e,n.tail=t,n},S1=Ze("Nil"),b1={[Gi]:Gi,_tag:"Nil",toString(){return ct(this.toJSON())},toJSON(){return{_id:"List",_tag:"Nil"}},[Me](){return this.toJSON()},[he](){return S1},[fe](e){return P_(e)&&this._tag===e._tag},[Symbol.iterator](){return{next(){return{done:!0,value:void 0}}}},pipe(){return G(this,arguments)}},O_=Object.create(b1),P_=e=>te(e,Gi),ar=e=>e._tag==="Nil",_1=e=>e._tag==="Cons",w1=()=>O_,gs=(e,t)=>Va(e,t),Co=w1,rp=e=>Va(e,O_),v1=d(2,(e,t)=>T1(t,e)),k1=d(2,(e,t)=>gs(t,e)),T1=d(2,(e,t)=>{if(ar(e))return t;if(ar(t))return e;{const n=Va(t.head,e);let r=n,s=t.tail;for(;!ar(s);){const o=Va(s.head,e);r.tail=o,r=o,s=s.tail}return n}}),E1=d(3,(e,t,n)=>{let r=t,s=e;for(;!ar(s);)r=n(r,s.head),s=s.tail;return r}),C1=e=>{let t=Co(),n=e;for(;!ar(n);)t=k1(t,n.head),n=n.tail;return t},Vu=(function(){function e(t){t&&Object.assign(this,t)}return e.prototype=$d,e})(),I1=Symbol.for("effect/DifferContextPatch");function yg(e){return e}const yc={...Vu.prototype,[I1]:{_Value:yg,_Patch:yg}},$1=Object.assign(Object.create(yc),{_tag:"Empty"}),A1=Object.create($1),F_=()=>A1,R1=Object.assign(Object.create(yc),{_tag:"AndThen"}),O1=(e,t)=>{const n=Object.create(R1);return n.first=e,n.second=t,n},P1=Object.assign(Object.create(yc),{_tag:"AddService"}),F1=(e,t)=>{const n=Object.create(P1);return n.key=e,n.service=t,n},x1=Object.assign(Object.create(yc),{_tag:"RemoveService"}),N1=e=>{const t=Object.create(x1);return t.key=e,t},B1=Object.assign(Object.create(yc),{_tag:"UpdateService"}),M1=(e,t)=>{const n=Object.create(B1);return n.key=e,n.update=t,n},L1=(e,t)=>{const n=new Map(e.unsafeMap);let r=F_();for(const[s,o]of t.unsafeMap.entries())if(n.has(s)){const i=n.get(s);n.delete(s),oe(i,o)||(r=pa(M1(s,()=>o))(r))}else n.delete(s),r=pa(F1(s,o))(r);for(const[s]of n.entries())r=pa(N1(s))(r);return r},pa=d(2,(e,t)=>O1(e,t)),H1=d(2,(e,t)=>{if(e._tag==="Empty")return t;let n=!1,r=Be(e);const s=new Map(t.unsafeMap);for(;Un(r);){const i=Fn(r),c=rr(r);switch(i._tag){case"Empty":{r=c;break}case"AddService":{s.set(i.key,i.service),r=c;break}case"AndThen":{r=xt(xt(c,i.second),i.first);break}case"RemoveService":{s.delete(i.key),r=c;break}case"UpdateService":{s.set(i.key,i.update(s.get(i.key))),n=!0,r=c;break}}}if(!n)return hs(s);const o=new Map;for(const[i]of t.unsafeMap)s.has(i)&&(o.set(i,s.get(i)),s.delete(i));for(const[i,c]of s)o.set(i,c);return hs(o)}),D1=Symbol.for("effect/DifferHashSetPatch");function rf(e){return e}const qu={...Vu.prototype,[D1]:{_Value:rf,_Key:rf,_Patch:rf}},U1=Object.assign(Object.create(qu),{_tag:"Empty"}),K1=Object.create(U1),x_=()=>K1,j1=Object.assign(Object.create(qu),{_tag:"AndThen"}),z1=(e,t)=>{const n=Object.create(j1);return n.first=e,n.second=t,n},V1=Object.assign(Object.create(qu),{_tag:"Add"}),q1=e=>{const t=Object.create(V1);return t.value=e,t},W1=Object.assign(Object.create(qu),{_tag:"Remove"}),J1=e=>{const t=Object.create(W1);return t.value=e,t},G1=(e,t)=>{const[n,r]=Ji([e,x_()],([s,o],i)=>ZA(i)(s)?[v_(i)(s),o]:[s,lh(q1(i))(o)])(t);return Ji(r,(s,o)=>lh(J1(o))(s))(n)},lh=d(2,(e,t)=>z1(e,t)),Y1=d(2,(e,t)=>{if(e._tag==="Empty")return t;let n=t,r=Be(e);for(;Un(r);){const s=Fn(r),o=rr(r);switch(s._tag){case"Empty":{r=o;break}case"AndThen":{r=xt(s.first)(xt(s.second)(o));break}case"Add":{n=Pi(s.value)(n),r=o;break}case"Remove":n=v_(s.value)(n),r=o}}return n}),Q1=Symbol.for("effect/DifferReadonlyArrayPatch");function Sg(e){return e}const Sc={...Vu.prototype,[Q1]:{_Value:Sg,_Patch:Sg}},X1=Object.assign(Object.create(Sc),{_tag:"Empty"}),Z1=Object.create(X1),N_=()=>Z1,eR=Object.assign(Object.create(Sc),{_tag:"AndThen"}),tR=(e,t)=>{const n=Object.create(eR);return n.first=e,n.second=t,n},nR=Object.assign(Object.create(Sc),{_tag:"Append"}),rR=e=>{const t=Object.create(nR);return t.values=e,t},sR=Object.assign(Object.create(Sc),{_tag:"Slice"}),oR=(e,t)=>{const n=Object.create(sR);return n.from=e,n.until=t,n},iR=Object.assign(Object.create(Sc),{_tag:"Update"}),cR=(e,t)=>{const n=Object.create(iR);return n.index=e,n.patch=t,n},aR=e=>{let t=0,n=N_();for(;t<e.oldValue.length&&t<e.newValue.length;){const r=e.oldValue[t],s=e.newValue[t],o=e.differ.diff(r,s);oe(o,e.differ.empty)||(n=ma(n,cR(t,o))),t=t+1}return t<e.oldValue.length&&(n=ma(n,oR(0,t))),t<e.newValue.length&&(n=ma(n,rR(gI(t)(e.newValue)))),n},ma=d(2,(e,t)=>tR(e,t)),uR=d(3,(e,t,n)=>{if(e._tag==="Empty")return t;let r=t.slice(),s=yn(e);for(;fa(s);){const o=jt(s),i=ls(s);switch(o._tag){case"Empty":{s=i;break}case"AndThen":{i.unshift(o.first,o.second),s=i;break}case"Append":{for(const c of o.values)r.push(c);s=i;break}case"Slice":{r=r.slice(o.from,o.until),s=i;break}case"Update":{r[o.index]=n.patch(o.patch,r[o.index]),s=i;break}}}return r}),lR=Symbol.for("effect/Differ"),fR={[lR]:{_P:ee,_V:ee},pipe(){return G(this,arguments)}},Go=e=>{const t=Object.create(fR);return t.empty=e.empty,t.diff=e.diff,t.combine=e.combine,t.patch=e.patch,t},hR=()=>Go({empty:F_(),combine:(e,t)=>pa(t)(e),diff:(e,t)=>L1(e,t),patch:(e,t)=>H1(t)(e)}),dR=()=>Go({empty:x_(),combine:(e,t)=>lh(t)(e),diff:(e,t)=>G1(e,t),patch:(e,t)=>Y1(t)(e)}),pR=e=>Go({empty:N_(),combine:(t,n)=>ma(t,n),diff:(t,n)=>aR({oldValue:t,newValue:n,differ:e}),patch:(t,n)=>uR(t,n,e)}),B_=()=>mR((e,t)=>t),mR=e=>Go({empty:ee,combine:(t,n)=>t===ee?n:n===ee?t:r=>n(t(r)),diff:(t,n)=>oe(t,n)?ee:_u(n),patch:(t,n)=>e(n,t(n))}),Yi=255,M_=8,fh=e=>e&Yi,hh=e=>e>>M_&Yi,bc=(e,t)=>(e&Yi)+((t&e&Yi)<<M_),gR=bc(0,0),yR=e=>bc(e,e),SR=e=>bc(e,0),bR=d(2,(e,t)=>bc(fh(e)&~t,hh(e))),_R=d(2,(e,t)=>e|t),wR=e=>~e>>>0&Yi,vR=0,Cs=1,kR=2,L_=4,dh=16,H_=32,TR=e=>Wu(e,H_),ER=d(2,(e,t)=>e&~t),CR=d(2,(e,t)=>e|t),vr=e=>D_(e)&&!$R(e),D_=e=>Wu(e,Cs),Wu=d(2,(e,t)=>(e&t)!==0),U_=(...e)=>e.reduce((t,n)=>t|n,0),IR=U_(vR),bg=e=>Wu(e,L_),$R=e=>Wu(e,dh),os=d(2,(e,t)=>bc(e^t,t)),io=d(2,(e,t)=>e&(wR(fh(t))|hh(t))|fh(t)&hh(t)),_g=Go({empty:gR,diff:(e,t)=>os(e,t),combine:(e,t)=>_R(t)(e),patch:(e,t)=>io(t,e)}),AR=yR,K_=SR,wg=bR,j_=(e,t)=>({_tag:"Par",left:e,right:t}),qc=(e,t)=>({_tag:"Seq",left:e,right:t}),RR=e=>{let t=rp(e),n=Co();for(;;){const[r,s]=E1(t,[z_(),Co()],([o,i],c)=>{const[a,u]=OR(c);return[BR(o,a),v1(i,u)]});if(n=PR(n,r),ar(s))return C1(n);t=s}throw new Error("BUG: BlockedRequests.flatten - please report an issue at https://github.com/Effect-TS/effect/issues")},OR=e=>{let t=e,n=z_(),r=Co(),s=Co();for(;;)switch(t._tag){case"Empty":{if(ar(r))return[n,s];t=r.head,r=r.tail;break}case"Par":{r=gs(t.right,r),t=t.left;break}case"Seq":{const o=t.left,i=t.right;switch(o._tag){case"Empty":{t=i;break}case"Par":{const c=o.left,a=o.right;t=j_(qc(c,i),qc(a,i));break}case"Seq":{const c=o.left,a=o.right;t=qc(c,qc(a,i));break}case"Single":{t=o,s=gs(i,s);break}}break}case"Single":{if(n=NR(n,t),ar(r))return[n,s];t=r.head,r=r.tail;break}}throw new Error("BUG: BlockedRequests.step - please report an issue at https://github.com/Effect-TS/effect/issues")},PR=(e,t)=>{if(ar(e))return rp(sf(t));if(MR(t))return e;const n=jR(e.head),r=LR(t);return n.length===1&&r.length===1&&oe(n[0],r[0])?gs(KR(e.head,sf(t)),e.tail):gs(sf(t),e)},FR=Symbol.for("effect/RequestBlock/RequestBlockParallel"),xR={_R:e=>e};class sp{map;[FR]=xR;constructor(t){this.map=t}}const z_=()=>new sp(np()),NR=(e,t)=>new sp(d1(e.map,t.dataSource,n=>JC(no(n,_o(t.blockedRequest)),()=>Be(t.blockedRequest)))),BR=(e,t)=>new sp(R_(e.map,t.map,(n,r,s)=>$_(n,s,xe(I_(n,s),{onNone:()=>r,onSome:o=>St(r,o)})))),MR=e=>h1(e.map),LR=e=>Array.from(A_(e.map)),sf=e=>UR(p1(e.map,t=>Be(t))),HR=Symbol.for("effect/RequestBlock/RequestBlockSequential"),DR={_R:e=>e};class V_{map;[HR]=DR;constructor(t){this.map=t}}const UR=e=>new V_(e),KR=(e,t)=>new V_(R_(t.map,e.map,(n,r,s)=>$_(n,s,xe(I_(n,s),{onNone:()=>We(),onSome:o=>St(o,r)})))),jR=e=>Array.from(A_(e.map)),zR=e=>Array.from(e.map),Yo="Die",ys="Empty",Is="Fail",Qo="Interrupt",Io="Parallel",$o="Sequential",q_="effect/Cause",W_=Symbol.for(q_),VR={_E:e=>e},Xo={[W_]:VR,[he](){return p(Y(q_),ye(Y(oO(this))),Ye(this))},[fe](e){return qR(e)&&sO(this,e)},pipe(){return G(this,arguments)},toJSON(){switch(this._tag){case"Empty":return{_id:"Cause",_tag:this._tag};case"Die":return{_id:"Cause",_tag:this._tag,defect:Ge(this.defect)};case"Interrupt":return{_id:"Cause",_tag:this._tag,fiberId:this.fiberId.toJSON()};case"Fail":return{_id:"Cause",_tag:this._tag,failure:Ge(this.error)};case"Sequential":case"Parallel":return{_id:"Cause",_tag:this._tag,left:Ge(this.left),right:Ge(this.right)}}},toString(){return Zo(this)},[Me](){return this.toJSON()}},Or=(()=>{const e=Object.create(Xo);return e._tag=ys,e})(),Pr=e=>{const t=Object.create(Xo);return t._tag=Is,t.error=e,t},tn=e=>{const t=Object.create(Xo);return t._tag=Yo,t.defect=e,t},ln=e=>{const t=Object.create(Xo);return t._tag=Qo,t.fiberId=e,t},Fr=(e,t)=>{const n=Object.create(Xo);return n._tag=Io,n.left=e,n.right=t,n},At=(e,t)=>{const n=Object.create(Xo);return n._tag=$o,n.left=e,n.right=t,n},qR=e=>te(e,W_),WR=e=>e._tag===ys,JR=e=>e._tag===Is,J_=e=>e._tag===Yo,GR=e=>e._tag===ys?!0:Ao(e,!0,(t,n)=>{switch(n._tag){case ys:return U(t);case Yo:case Is:case Qo:return U(!1);default:return K()}}),G_=e=>$e(eO(e)),Ju=e=>ip(void 0,cO)(e),YR=e=>dr(Ao(e,We(),(t,n)=>n._tag===Is?U(p(t,xt(n.error))):K())),QR=e=>dr(Ao(e,We(),(t,n)=>n._tag===Yo?U(p(t,xt(n.defect))):K())),Y_=e=>Ao(e,ps(),(t,n)=>n._tag===Qo?U(p(t,Pi(n.fiberId))):K()),XR=e=>op(e,t=>t._tag===Is?U(t.error):K()),Q_=e=>{const t=XR(e);switch(t._tag){case"None":return pe(e);case"Some":return re(t.value)}},ZR=e=>Gu(e,{onEmpty:U(Or),onFail:no(Pr),onDie:t=>U(tn(t)),onInterrupt:t=>U(ln(t)),onSequential:Ym(At),onParallel:Ym(Fr)}),eO=e=>op(e,t=>t._tag===Qo?U(t.fiberId):K()),vg=e=>Gu(e,{onEmpty:Or,onFail:()=>Or,onDie:tn,onInterrupt:ln,onSequential:At,onParallel:Fr}),tO=e=>Gu(e,{onEmpty:Or,onFail:tn,onDie:tn,onInterrupt:ln,onSequential:At,onParallel:Fr}),nO=d(2,(e,t)=>rO(e,n=>Pr(t(n)))),rO=d(2,(e,t)=>Gu(e,{onEmpty:Or,onFail:n=>t(n),onDie:n=>tn(n),onInterrupt:n=>ln(n),onSequential:(n,r)=>At(n,r),onParallel:(n,r)=>Fr(n,r)})),sO=(e,t)=>{let n=Be(e),r=Be(t);for(;Un(n)&&Un(r);){const[s,o]=p(Fn(n),Ao([ps(),We()],([a,u],l)=>{const[f,h]=ph(l);return U([p(a,Wi(f)),p(u,St(h))])})),[i,c]=p(Fn(r),Ao([ps(),We()],([a,u],l)=>{const[f,h]=ph(l);return U([p(a,Wi(f)),p(u,St(h))])}));if(!oe(s,i))return!1;n=o,r=c}return!0},oO=e=>iO(Be(e),We()),iO=(e,t)=>{for(;;){const[n,r]=p(e,Pd([ps(),We()],([o,i],c)=>{const[a,u]=ph(c);return[p(o,Wi(a)),p(i,St(u))]})),s=ep(n)>0?p(t,xt(n)):t;if(Bu(r))return dr(s);e=r,t=s}throw new Error(ku("Cause.flattenCauseLoop"))},op=d(2,(e,t)=>{const n=[e];for(;n.length>0;){const r=n.pop(),s=t(r);switch(s._tag){case"None":{switch(r._tag){case $o:case Io:{n.push(r.right),n.push(r.left);break}}break}case"Some":return s}}return K()}),ph=e=>{let t=e;const n=[];let r=ps(),s=We();for(;t!==void 0;)switch(t._tag){case ys:{if(n.length===0)return[r,s];t=n.pop();break}case Is:{if(r=Pi(r,da(t._tag,t.error)),n.length===0)return[r,s];t=n.pop();break}case Yo:{if(r=Pi(r,da(t._tag,t.defect)),n.length===0)return[r,s];t=n.pop();break}case Qo:{if(r=Pi(r,da(t._tag,t.fiberId)),n.length===0)return[r,s];t=n.pop();break}case $o:{switch(t.left._tag){case ys:{t=t.right;break}case $o:{t=At(t.left.left,At(t.left.right,t.right));break}case Io:{t=Fr(At(t.left.left,t.right),At(t.left.right,t.right));break}default:{s=xt(s,t.right),t=t.left;break}}break}case Io:{n.push(t.right),t=t.left;break}}throw new Error(ku("Cause.evaluateCauseLoop"))},cO={emptyCase:Wm,failCase:Kf,dieCase:Kf,interruptCase:Wm,sequentialCase:(e,t,n)=>t&&n,parallelCase:(e,t,n)=>t&&n},kg="SequentialCase",Tg="ParallelCase",Gu=d(2,(e,{onDie:t,onEmpty:n,onFail:r,onInterrupt:s,onParallel:o,onSequential:i})=>ip(e,void 0,{emptyCase:()=>n,failCase:(c,a)=>r(a),dieCase:(c,a)=>t(a),interruptCase:(c,a)=>s(a),sequentialCase:(c,a,u)=>i(a,u),parallelCase:(c,a,u)=>o(a,u)})),Ao=d(3,(e,t,n)=>{let r=t,s=e;const o=[];for(;s!==void 0;){const i=n(r,s);switch(r=$e(i)?i.value:r,s._tag){case $o:{o.push(s.right),s=s.left;break}case Io:{o.push(s.right),s=s.left;break}default:{s=void 0;break}}s===void 0&&o.length>0&&(s=o.pop())}return r}),ip=d(3,(e,t,n)=>{const r=[e],s=[];for(;r.length>0;){const i=r.pop();switch(i._tag){case ys:{s.push(pe(n.emptyCase(t)));break}case Is:{s.push(pe(n.failCase(t,i.error)));break}case Yo:{s.push(pe(n.dieCase(t,i.defect)));break}case Qo:{s.push(pe(n.interruptCase(t,i.fiberId)));break}case $o:{r.push(i.right),r.push(i.left),s.push(re({_tag:kg}));break}case Io:{r.push(i.right),r.push(i.left),s.push(re({_tag:Tg}));break}}}const o=[];for(;s.length>0;){const i=s.pop();switch(i._tag){case"Left":{switch(i.left._tag){case kg:{const c=o.pop(),a=o.pop(),u=n.sequentialCase(t,c,a);o.push(u);break}case Tg:{const c=o.pop(),a=o.pop(),u=n.parallelCase(t,c,a);o.push(u);break}}break}case"Right":{o.push(i.right);break}}}if(o.length===0)throw new Error("BUG: Cause.reduceWithContext - please report an issue at https://github.com/Effect-TS/effect/issues");return o.pop()}),Zo=(e,t)=>Ju(e)?"All fibers interrupted without errors.":Z_(e).map(function(n){return t?.renderErrorCause!==!0||n.cause===void 0?n.stack:`${n.stack} {
${X_(n.cause,"  ")}
}`}).join(`
`),X_=(e,t)=>{const n=e.stack.split(`
`);let r=`${t}[cause]: ${n[0]}`;for(let s=1,o=n.length;s<o;s++)r+=`
${t}${n[s]}`;return e.cause&&(r+=` {
${X_(e.cause,`${t}  `)}
${t}}`),r};class qa extends globalThis.Error{span=void 0;constructor(t){const n=typeof t=="object"&&t!==null,r=Error.stackTraceLimit;Error.stackTraceLimit=1,super(aO(t),n&&"cause"in t&&typeof t.cause<"u"?{cause:new qa(t.cause)}:void 0),this.message===""&&(this.message="An error has occurred"),Error.stackTraceLimit=r,this.name=t instanceof Error?t.name:"Error",n&&(Ro in t&&(this.span=t[Ro]),Object.keys(t).forEach(s=>{s in this||(this[s]=t[s])})),this.stack=fO(`${this.name}: ${this.message}`,t instanceof Error&&t.stack?t.stack:"",this.span)}}const aO=e=>{if(typeof e=="string")return e;if(typeof e=="object"&&e!==null&&e instanceof Error)return e.message;try{if(te(e,"toString")&&fc(e.toString)&&e.toString!==Object.prototype.toString&&e.toString!==globalThis.Array.prototype.toString)return e.toString()}catch{}return WS(e)},uO=/\((.*)\)/g,lO=be("effect/Tracer/spanToTrace",()=>new WeakMap),fO=(e,t,n)=>{const r=[e],s=t.startsWith(e)?t.slice(e.length).split(`
`):t.split(`
`);for(let o=1;o<s.length;o++){if(s[o].includes(" at new BaseEffectError")||s[o].includes(" at new YieldableError")){o++;continue}if(s[o].includes("Generator.next")||s[o].includes("effect_internal_function"))break;r.push(s[o].replace(/at .*effect_instruction_i.*\((.*)\)/,"at $1").replace(/EffectPrimitive\.\w+/,"<anonymous>"))}if(n){let o=n,i=0;for(;o&&o._tag==="Span"&&i<10;){const c=lO.get(o);if(typeof c=="function"){const a=c();if(typeof a=="string"){const u=a.matchAll(uO);let l=!1;for(const[,f]of u)l=!0,r.push(`    at ${o.name} (${f})`);l||r.push(`    at ${o.name} (${a.replace(/^at /,"")})`)}else r.push(`    at ${o.name}`)}else r.push(`    at ${o.name}`);o=An(o.parent),i++}}return r.join(`
`)},Ro=Symbol.for("effect/SpanAnnotation"),Z_=e=>ip(e,void 0,{emptyCase:()=>[],dieCase:(t,n)=>[new qa(n)],failCase:(t,n)=>[new qa(n)],interruptCase:()=>[],parallelCase:(t,n,r)=>[...n,...r],sequentialCase:(t,n,r)=>[...n,...r]}),_c="Pending",Yu="Done",hO="effect/Deferred",dO=Symbol.for(hO),pO={_E:e=>e,_A:e=>e},mO=e=>({_tag:_c,joiners:e}),ew=e=>({_tag:Yu,effect:e});class wc{self;called=!1;constructor(t){this.self=t}next(t){return this.called?{value:t,done:!0}:(this.called=!0,{value:this.self,done:!1})}return(t){return{value:t,done:!0}}throw(t){throw t}[Symbol.iterator](){return new wc(this.self)}}const tw=(e,t)=>{const n=new ht("Blocked");return n.effect_instruction_i0=e,n.effect_instruction_i1=t,n},gO=e=>{const t=new ht("RunBlocked");return t.effect_instruction_i0=e,t},Oo=Symbol.for("effect/Effect");class yO{patch;op;_op=Cd;constructor(t,n){this.patch=t,this.op=n}}class ht{_op;effect_instruction_i0=void 0;effect_instruction_i1=void 0;effect_instruction_i2=void 0;trace=void 0;[Oo]=So;constructor(t){this._op=t}[fe](t){return this===t}[he](){return Ye(this,wd(this))}pipe(){return G(this,arguments)}toJSON(){return{_id:"Effect",_op:this._op,effect_instruction_i0:Ge(this.effect_instruction_i0),effect_instruction_i1:Ge(this.effect_instruction_i1),effect_instruction_i2:Ge(this.effect_instruction_i2)}}toString(){return ct(this.toJSON())}[Me](){return this.toJSON()}[Symbol.iterator](){return new wc(new hc(this))}}class nw{_op;effect_instruction_i0=void 0;effect_instruction_i1=void 0;effect_instruction_i2=void 0;trace=void 0;[Oo]=So;constructor(t){this._op=t,this._tag=t}[fe](t){return il(t)&&t._op==="Failure"&&oe(this.effect_instruction_i0,t.effect_instruction_i0)}[he](){return p(Ze(this._tag),ye(Y(this.effect_instruction_i0)),Ye(this))}get cause(){return this.effect_instruction_i0}pipe(){return G(this,arguments)}toJSON(){return{_id:"Exit",_tag:this._op,cause:this.cause.toJSON()}}toString(){return ct(this.toJSON())}[Me](){return this.toJSON()}[Symbol.iterator](){return new wc(new hc(this))}}class rw{_op;effect_instruction_i0=void 0;effect_instruction_i1=void 0;effect_instruction_i2=void 0;trace=void 0;[Oo]=So;constructor(t){this._op=t,this._tag=t}[fe](t){return il(t)&&t._op==="Success"&&oe(this.effect_instruction_i0,t.effect_instruction_i0)}[he](){return p(Ze(this._tag),ye(Y(this.effect_instruction_i0)),Ye(this))}get value(){return this.effect_instruction_i0}pipe(){return G(this,arguments)}toJSON(){return{_id:"Exit",_tag:this._op,value:Ge(this.value)}}toString(){return ct(this.toJSON())}[Me](){return this.toJSON()}[Symbol.iterator](){return new wc(new hc(this))}}const yr=e=>te(e,Oo),Ee=e=>{const t=new ht(YS);return t.effect_instruction_i0=e,t},sw=d(3,(e,t,n)=>kn(r=>P(e,s=>P(Mn(ae(()=>r(t(s)))),o=>ae(()=>n(s,o)).pipe(sn({onFailure:i=>{switch(o._tag){case Ot:return lt(At(o.effect_instruction_i0,i));case Pt:return lt(i)}},onSuccess:()=>o})))))),Jt=d(2,(e,t)=>P(e,()=>L(t))),on=e=>Jt(e,void 0),ow=function(){const e=new ht(Eu);switch(arguments.length){case 2:{e.effect_instruction_i0=arguments[0],e.commit=arguments[1];break}case 3:{e.effect_instruction_i0=arguments[0],e.effect_instruction_i1=arguments[1],e.commit=arguments[2];break}case 4:{e.effect_instruction_i0=arguments[0],e.effect_instruction_i1=arguments[1],e.effect_instruction_i2=arguments[2],e.commit=arguments[3];break}default:throw new Error(ku("you're not supposed to end up here"))}return e},Wa=(e,t=Eo)=>{const n=new ht($i);let r;return n.effect_instruction_i0=s=>{r=e(s)},n.effect_instruction_i1=t,Tc(n,s=>yr(r)?r:Ke)},iw=(e,t=Eo)=>ae(()=>Wa(e,t)),Kn=(e,t=Eo)=>ow(e,function(){let n,r;function s(a){n?n(a):r===void 0&&(r=a)}const o=new ht($i);o.effect_instruction_i0=a=>{n=a,r&&a(r)},o.effect_instruction_i1=t;let i,c;return this.effect_instruction_i0.length!==1?(c=new AbortController,i=Dt(()=>this.effect_instruction_i0(s,c.signal))):i=Dt(()=>this.effect_instruction_i0(s)),i||c?Tc(o,a=>(c&&c.abort(),i??Ke)):o}),cw=d(2,(e,t)=>{const n=new ht(ua);return n.effect_instruction_i0=e,n.effect_instruction_i1=t,n}),Po=d(2,(e,t)=>jn(e,{onFailure:t,onSuccess:L})),Eg=Symbol.for("effect/OriginalAnnotation"),cp=(e,t)=>$e(t)?new Proxy(e,{has(n,r){return r===Ro||r===Eg||r in n},get(n,r){return r===Ro?t.value:r===Eg?e:n[r]}}):e,Tr=e=>mr(e)&&!(Ro in e)?Ee(t=>lt(tn(cp(e,bp(t))))):lt(tn(e)),aw=e=>uw(()=>tn(new qO(e))),Fo=e=>jn(e,{onFailure:t=>L(re(t)),onSuccess:t=>L(pe(t))}),Mn=e=>lw(e,{onFailure:Oe,onSuccess:et}),rt=e=>mr(e)&&!(Ro in e)?Ee(t=>lt(Pr(cp(e,bp(t))))):lt(Pr(e)),Qu=e=>P(M(e),rt),lt=e=>{const t=new nw(Ot);return t.effect_instruction_i0=e,t},uw=e=>P(M(e),lt),Xu=Ee(e=>L(e.id())),vc=e=>Ee(t=>e(t.id())),P=d(2,(e,t)=>{const n=new ht(Fa);return n.effect_instruction_i0=e,n.effect_instruction_i1=t,n}),SO=e=>{const t=new ht("OnStep");return t.effect_instruction_i0=e,t},kc=e=>P(e,ee),lw=d(2,(e,t)=>sn(e,{onFailure:n=>L(t.onFailure(n)),onSuccess:n=>L(t.onSuccess(n))})),sn=d(2,(e,t)=>{const n=new ht(xa);return n.effect_instruction_i0=e,n.effect_instruction_i1=t.onFailure,n.effect_instruction_i2=t.onSuccess,n}),jn=d(2,(e,t)=>sn(e,{onFailure:n=>{if(QR(n).length>0)return lt(tO(n));const s=YR(n);return s.length>0?t.onFailure(o_(s)):lt(n)},onSuccess:t.onSuccess})),sr=d(2,(e,t)=>ae(()=>{const n=Ne(e),r=Iu(n.length);let s=0;return Jt(fp({while:()=>s<n.length,body:()=>t(n[s],s),step:o=>{r[s++]=o}}),r)})),Zu=d(2,(e,t)=>ae(()=>{const n=Ne(e);let r=0;return fp({while:()=>r<n.length,body:()=>t(n[r],r),step:()=>{r++}})})),Tt=P(Xu,e=>fw(e)),fw=e=>lt(ln(e)),ap=e=>{const t=new ht(Vo);return t.effect_instruction_i0=AR(Cs),t.effect_instruction_i1=()=>e,t},bO=d(2,(e,t)=>kn(n=>P(Mn(n(e)),r=>nP(t,r)))),ne=d(2,(e,t)=>P(e,n=>M(()=>t(n)))),up=d(2,(e,t)=>jn(e,{onFailure:n=>Qu(()=>t.onFailure(n)),onSuccess:n=>M(()=>t.onSuccess(n))})),el=d(2,(e,t)=>sn(e,{onFailure:n=>{const r=Q_(n);switch(r._tag){case"Left":return Qu(()=>t(r.left));case"Right":return lt(r.right)}},onSuccess:L})),xo=d(2,(e,t)=>kn(n=>sn(n(e),{onFailure:r=>{const s=Oe(r);return sn(t(s),{onFailure:o=>Oe(At(r,o)),onSuccess:()=>s})},onSuccess:r=>{const s=et(r);return mt(t(s),s)}}))),Tc=d(2,(e,t)=>xo(e,cl({onFailure:n=>Ju(n)?on(t(Y_(n))):Ke,onSuccess:()=>Ke}))),lp=e=>_O(e,ee),_O=d(2,(e,t)=>jn(e,{onFailure:n=>Tr(t(n)),onSuccess:L})),L=e=>{const t=new rw(Pt);return t.effect_instruction_i0=e,t},ae=e=>{const t=new ht(Eu);return t.commit=e,t},M=e=>{const t=new ht(GS);return t.effect_instruction_i0=e,t},tl=d(e=>e.length===3||e.length===2&&!(mr(e[1])&&"onlyEffect"in e[1]),(e,t)=>P(e,n=>{const r=typeof t=="function"?t(n):t;return yr(r)?Jt(r,n):sC(r)?Wa(s=>{r.then(o=>s(L(n)),o=>s(rt(new vw(o,"An unknown error occurred in Effect.tap"))))}):L(n)})),wO=e=>Ee(t=>{const n=t.getFiberRef(yh),r=p(n,qe(()=>t.scope()));return e(Ec(yh,U(r)))}),$s=e=>{const t=new ht(Vo);return t.effect_instruction_i0=K_(Cs),t.effect_instruction_i1=()=>e,t},kn=e=>ow(e,function(){const t=new ht(Vo);return t.effect_instruction_i0=K_(Cs),t.effect_instruction_i1=n=>D_(n)?Dt(()=>this.effect_instruction_i0(ap)):Dt(()=>this.effect_instruction_i0($s)),t}),Ke=L(void 0),vO=e=>{const t=new ht(Vo);return t.effect_instruction_i0=e,t.effect_instruction_i1=void 0,t},nl=d(2,(e,t)=>P(t,n=>n?p(e,ne(U)):L(K()))),fp=e=>{const t=new ht(Na);return t.effect_instruction_i0=e.while,t.effect_instruction_i1=e.body,t.effect_instruction_i2=e.step,t},mh=e=>ae(()=>{const t=new ht(Ai);return t.effect_instruction_i0=e(),t}),hw=function(){const e=arguments.length===1?arguments[0]:arguments[1].bind(arguments[0]);return mh(()=>e(p))},kO=(e,...t)=>Object.defineProperty(t.length===0?function(...n){return mh(()=>e.apply(this,n))}:function(...n){let r=mh(()=>e.apply(this,n));for(const s of t)r=s(r,...n);return r},"length",{value:e.length,configurable:!0}),TO=d(2,(e,t)=>{const n=new ht(Vo);return n.effect_instruction_i0=t,n.effect_instruction_i1=()=>e,n}),rl=e=>{const t=new ht(la);return typeof e?.priority<"u"?UO(t,e.priority):t},dw=d(2,(e,t)=>P(e,n=>ne(t,r=>[n,r]))),sl=d(2,(e,t)=>P(e,n=>Jt(t,n))),mt=d(2,(e,t)=>P(e,()=>t)),pw=d(3,(e,t,n)=>P(e,r=>ne(t,s=>n(r,s)))),hp=e=>P(Xu,t=>p(e,Qi(t))),Qi=d(2,(e,t)=>P(e.interruptAsFork(t),()=>e.await)),EO={_tag:"All",syslog:0,label:"ALL",ordinal:Number.MIN_SAFE_INTEGER,pipe(){return G(this,arguments)}},CO={_tag:"Fatal",syslog:2,label:"FATAL",ordinal:5e4,pipe(){return G(this,arguments)}},IO={_tag:"Error",syslog:3,label:"ERROR",ordinal:4e4,pipe(){return G(this,arguments)}},mw={_tag:"Warning",syslog:4,label:"WARN",ordinal:3e4,pipe(){return G(this,arguments)}},gw={_tag:"Info",syslog:6,label:"INFO",ordinal:2e4,pipe(){return G(this,arguments)}},yw={_tag:"Debug",syslog:7,label:"DEBUG",ordinal:1e4,pipe(){return G(this,arguments)}},$O={_tag:"Trace",syslog:7,label:"TRACE",ordinal:0,pipe(){return G(this,arguments)}},AO={_tag:"None",syslog:7,label:"OFF",ordinal:Number.MAX_SAFE_INTEGER,pipe(){return G(this,arguments)}},RO="effect/FiberRef",OO=Symbol.for(RO),PO={_A:e=>e},dp=e=>Ee(t=>et(t.getFiberRef(e))),ol=d(2,(e,t)=>P(dp(e),t)),Cg=d(2,(e,t)=>FO(e,()=>[void 0,t])),FO=d(2,(e,t)=>Ee(n=>{const[r,s]=t(n.getFiberRef(e));return n.setFiberRef(e,s),L(r)})),Ec=d(3,(e,t,n)=>sw(sl(dp(t),Cg(t,n)),()=>e,r=>Cg(t,r))),xO=d(3,(e,t,n)=>ol(t,r=>Ec(e,t,n(r)))),Gt=(e,t)=>ei(e,{differ:B_(),fork:t?.fork??ee,join:t?.join}),NO=e=>{const t=dR();return ei(e,{differ:t,fork:t.empty})},BO=e=>{const t=pR(B_());return ei(e,{differ:t,fork:t.empty})},Sw=e=>{const t=hR();return ei(e,{differ:t,fork:t.empty})},ei=(e,t)=>({...mc,[OO]:PO,initial:e,commit(){return dp(this)},diff:(r,s)=>t.differ.diff(r,s),combine:(r,s)=>t.differ.combine(r,s),patch:r=>s=>t.differ.patch(r,s),fork:t.fork,join:t.join??((r,s)=>s)}),MO=e=>ei(e,{differ:_g,fork:_g.empty}),Ur=be(Symbol.for("effect/FiberRef/currentContext"),()=>Sw(Ud())),Cc=be(Symbol.for("effect/FiberRef/currentSchedulingPriority"),()=>Gt(0)),bw=be(Symbol.for("effect/FiberRef/currentMaxOpsBeforeYield"),()=>Gt(2048)),LO=be(Symbol.for("effect/FiberRef/currentLogAnnotation"),()=>Gt(np())),HO=be(Symbol.for("effect/FiberRef/currentLogLevel"),()=>Gt(gw)),DO=be(Symbol.for("effect/FiberRef/currentLogSpan"),()=>Gt(Co())),UO=d(2,(e,t)=>Ec(e,Cc,t)),KO=be(Symbol.for("effect/FiberRef/currentConcurrency"),()=>Gt("unbounded")),jO=be(Symbol.for("effect/FiberRef/currentRequestBatching"),()=>Gt(!0)),zO=be(Symbol.for("effect/FiberRef/currentUnhandledErrorLogLevel"),()=>Gt(U(yw))),VO=be(Symbol.for("effect/FiberRef/versionMismatchErrorLogLevel"),()=>Gt(U(mw))),gh=be(Symbol.for("effect/FiberRef/currentMetricLabels"),()=>BO(fs())),yh=be(Symbol.for("effect/FiberRef/currentForkScopeOverride"),()=>Gt(K(),{fork:()=>K(),join:(e,t)=>e})),Wc=be(Symbol.for("effect/FiberRef/currentInterruptedCause"),()=>Gt(Or,{fork:()=>Or,join:(e,t)=>e})),Ig=Symbol.for("effect/Scope"),$g=Symbol.for("effect/CloseableScope"),_w=(e,t)=>e.addFinalizer(()=>on(t)),Ja=(e,t)=>e.addFinalizer(t),Sh=(e,t)=>e.close(t),er=(e,t)=>e.fork(t),pp=(function(){class e extends globalThis.Error{commit(){return rt(this)}toJSON(){const n={...this};return this.message&&(n.message=this.message),this.cause&&(n.cause=this.cause),n}[Me](){return this.toString!==globalThis.Error.prototype.toString?this.stack?`${this.toString()}
${this.stack.split(`
`).slice(1).join(`
`)}`:this.toString():"Bun"in globalThis?Zo(Pr(this),{renderErrorCause:!0}):this}}return Object.assign(e.prototype,RC),e})(),ww=(e,t)=>{class n extends pp{_tag=t}return Object.assign(n.prototype,e),n.prototype.name=t,n},Ag=Symbol.for("effect/Cause/errors/RuntimeException"),qO=ww({[Ag]:Ag},"RuntimeException"),WO=Symbol.for("effect/Cause/errors/InterruptedException"),JO=e=>te(e,WO),Rg=Symbol.for("effect/Cause/errors/NoSuchElement"),mp=ww({[Rg]:Rg},"NoSuchElementException"),Og=Symbol.for("effect/Cause/errors/UnknownException"),vw=(function(){class e extends pp{_tag="UnknownException";error;constructor(n,r){super(r??"An unknown error occurred",{cause:n}),this.error=n}}return Object.assign(e.prototype,{[Og]:Og,name:"UnknownException"}),e})(),il=e=>yr(e)&&"_tag"in e&&(e._tag==="Success"||e._tag==="Failure"),GO=e=>e._tag==="Failure",YO=e=>e._tag==="Success",QO=d(2,(e,t)=>{switch(e._tag){case Ot:return Oe(e.effect_instruction_i0);case Pt:return et(t)}}),of=e=>QO(e,void 0),co=(e,t)=>eP(e,t?.parallel?Fr:At),kw=e=>Oe(tn(e)),bh=e=>Oe(Pr(e)),Oe=e=>{const t=new nw(Ot);return t.effect_instruction_i0=e,t},Tw=e=>Oe(ln(e)),ga=d(2,(e,t)=>{switch(e._tag){case Ot:return Oe(e.effect_instruction_i0);case Pt:return et(t(e.effect_instruction_i0))}}),cl=d(2,(e,{onFailure:t,onSuccess:n})=>{switch(e._tag){case Ot:return t(e.effect_instruction_i0);case Pt:return n(e.effect_instruction_i0)}}),_h=d(2,(e,{onFailure:t,onSuccess:n})=>{switch(e._tag){case Ot:return t(e.effect_instruction_i0);case Pt:return n(e.effect_instruction_i0)}}),et=e=>{const t=new rw(Pt);return t.effect_instruction_i0=e,t},wn=et(void 0),XO=d(2,(e,t)=>gp(e,t,{onSuccess:(n,r)=>[n,r],onFailure:At})),ZO=d(2,(e,t)=>gp(e,t,{onSuccess:(n,r)=>r,onFailure:At})),gp=d(3,(e,t,{onFailure:n,onSuccess:r})=>{switch(e._tag){case Ot:switch(t._tag){case Pt:return Oe(e.effect_instruction_i0);case Ot:return Oe(n(e.effect_instruction_i0,t.effect_instruction_i0))}case Pt:switch(t._tag){case Pt:return et(r(e.effect_instruction_i0,t.effect_instruction_i0));case Ot:return Oe(t.effect_instruction_i0)}}}),eP=(e,t)=>{const n=Ki(e);return Un(n)?p(rr(n),Pd(p(Fn(n),ga(Be)),(r,s)=>p(r,gp(s,{onSuccess:(o,i)=>p(o,xt(i)),onFailure:t}))),ga(dr),ga(r=>ir(r)),U):K()},Ic=e=>({...mc,[dO]:pO,state:Ts(mO([])),commit(){return zn(this)},blockingOn:e}),$c=()=>P(Xu,e=>tP(e)),tP=e=>M(()=>Ic(e)),zn=e=>iw(t=>{const n=_e(e.state);switch(n._tag){case Yu:return t(n.effect);case _c:return n.joiners.push(t),sP(e,t)}},e.blockingOn),al=d(2,(e,t)=>M(()=>{const n=_e(e.state);switch(n._tag){case Yu:return!1;case _c:{Es(e.state,ew(t));for(let r=0,s=n.joiners.length;r<s;r++)n.joiners[r](t);return!0}}})),nP=d(2,(e,t)=>al(e,t)),Ew=d(2,(e,t)=>al(e,lt(t))),yp=d(2,(e,t)=>al(e,fw(t))),rP=e=>M(()=>_e(e.state)._tag===Yu),Ac=d(2,(e,t)=>al(e,L(t))),ul=(e,t)=>{const n=_e(e.state);if(n._tag===_c){Es(e.state,ew(t));for(let r=0,s=n.joiners.length;r<s;r++)n.joiners[r](t)}},sP=(e,t)=>M(()=>{const n=_e(e.state);if(n._tag===_c){const r=n.joiners.indexOf(t);r>=0&&n.joiners.splice(r,1)}}),oP=Ee(e=>et(e.currentContext)),iP=()=>oP,As=e=>P(iP(),e),ll=d(2,(e,t)=>Ec(Ur,t)(e)),Sp=d(2,(e,t)=>xO(Ur,n=>Fu(n,t))(e)),cP=d(2,(e,t)=>As(n=>ll(e,t(n)))),bp=e=>{const t=e.currentSpan;return t!==void 0&&t._tag==="Span"?U(t):K()},hn=$c,Et=zn,Cw=Ew,wh=rP,xn=Ac,Iw=GO,Ga=YO,aP=co,uP=kw,$w=bh,dn=Oe,lP=ga,Nn=cl,fn=et,fP=wn,Pg=XO,Xi=ZO,Fg=Symbol.for("effect/MutableHashMap"),hP={[Fg]:Fg,[Symbol.iterator](){return new _p(this)},toString(){return ct(this.toJSON())},toJSON(){return{_id:"MutableHashMap",values:Array.from(this).map(Ge)}},[Me](){return this.toJSON()},pipe(){return G(this,arguments)}};class _p{self;referentialIterator;bucketIterator;constructor(t){this.self=t,this.referentialIterator=t.referential[Symbol.iterator]()}next(){if(this.bucketIterator!==void 0)return this.bucketIterator.next();const t=this.referentialIterator.next();return t.done?(this.bucketIterator=new dP(this.self.buckets.values()),this.next()):t}[Symbol.iterator](){return new _p(this.self)}}class dP{backing;constructor(t){this.backing=t}currentBucket;next(){if(this.currentBucket===void 0){const n=this.backing.next();if(n.done)return n;this.currentBucket=n.value[Symbol.iterator]()}const t=this.currentBucket.next();return t.done?(this.currentBucket=void 0,this.next()):t}}const pP=()=>{const e=Object.create(hP);return e.referential=new Map,e.buckets=new Map,e.bucketsSize=0,e},Wr=d(2,(e,t)=>{if(Pa(t)===!1)return e.referential.has(t)?U(e.referential.get(t)):K();const n=t[he](),r=e.buckets.get(n);return r===void 0?K():mP(e,r,t)}),mP=(e,t,n,r=!1)=>{for(let s=0,o=t.length;s<o;s++)if(n[fe](t[s][0])){const i=t[s][1];return r&&(t.splice(s,1),e.bucketsSize--),U(i)}return K()},ui=d(2,(e,t)=>$e(Wr(e,t))),li=d(3,(e,t,n)=>{if(Pa(t)===!1)return e.referential.set(t,n),e;const r=t[he](),s=e.buckets.get(r);return s===void 0?(e.buckets.set(r,[[t,n]]),e.bucketsSize++,e):(gP(e,s,t),s.push([t,n]),e.bucketsSize++,e)}),gP=(e,t,n)=>{for(let r=0,s=t.length;r<s;r++)if(n[fe](t[r][0])){t.splice(r,1),e.bucketsSize--;return}},xg=Symbol.for("effect/MutableList"),yP={[xg]:xg,[Symbol.iterator](){let e=!1,t=this.head;return{next(){if(e)return this.return();if(t==null)return e=!0,this.return();const n=t.value;return t=t.next,{done:e,value:n}},return(n){return e||(e=!0),{done:!0,value:n}}}},toString(){return ct(this.toJSON())},toJSON(){return{_id:"MutableList",values:Array.from(this).map(Ge)}},[Me](){return this.toJSON()},pipe(){return G(this,arguments)}},SP=e=>({value:e,removed:!1,prev:void 0,next:void 0}),bP=()=>{const e=Object.create(yP);return e.head=void 0,e.tail=void 0,e._length=0,e},Aw=e=>wp(e)===0,wp=e=>e._length,_P=d(2,(e,t)=>{const n=SP(t);return e.head===void 0&&(e.head=n),e.tail===void 0||(e.tail.next=n,n.prev=e.tail),e.tail=n,e._length+=1,e}),wP=e=>{const t=e.head;if(t!==void 0)return vP(e,t),t.value},vP=(e,t)=>{t.removed||(t.removed=!0,t.prev!==void 0&&t.next!==void 0?(t.prev.next=t.next,t.next.prev=t.prev):t.prev!==void 0?(e.tail=t.prev,t.prev.next=void 0):t.next!==void 0?(e.head=t.next,t.next.prev=void 0):(e.tail=void 0,e.head=void 0),e._length>0&&(e._length-=1))},Ng=Symbol.for("effect/MutableQueue"),st=Symbol.for("effect/mutable/MutableQueue/Empty"),kP={[Ng]:Ng,[Symbol.iterator](){return Array.from(this.queue)[Symbol.iterator]()},toString(){return ct(this.toJSON())},toJSON(){return{_id:"MutableQueue",values:Array.from(this).map(Ge)}},[Me](){return this.toJSON()},pipe(){return G(this,arguments)}},Rw=e=>{const t=Object.create(kP);return t.queue=bP(),t.capacity=e,t},TP=e=>Rw(e),fl=()=>Rw(void 0),vp=e=>wp(e.queue),is=e=>Aw(e.queue),EP=e=>e.capacity===void 0?1/0:e.capacity,No=d(2,(e,t)=>{const n=wp(e.queue);return e.capacity!==void 0&&n===e.capacity?!1:(_P(t)(e.queue),!0)}),kp=d(2,(e,t)=>{const n=t[Symbol.iterator]();let r,s=We(),o=!0;for(;o&&(r=n.next())&&!r.done;)o=No(r.value)(e);for(;r!=null&&!r.done;)s=xt(r.value)(s),r=n.next();return dr(s)}),ur=d(2,(e,t)=>Aw(e.queue)?t:wP(e.queue)),hl=d(2,(e,t)=>{let n=We(),r=0;for(;r<t;){const s=ur(st)(e);if(s===st)break;n=xt(s)(n),r+=1}return dr(n)}),CP="effect/Clock",Bg=Symbol.for(CP),dl=ks("effect/Clock"),IP=2**31-1,Mg={unsafeSchedule(e,t){const n=zi(t);if(n>IP)return Kf;let r=!1;const s=setTimeout(()=>{r=!0,e()},n);return()=>(clearTimeout(s),!r)}},Lg=(function(){const e=BigInt(1e6);if(typeof performance>"u"||typeof performance.now!="function")return()=>BigInt(Date.now())*e;let t;return()=>(t===void 0&&(t=BigInt(Date.now())*e-BigInt(Math.round(performance.now()*1e6))),t+BigInt(Math.round(performance.now()*1e6)))})(),$P=(function(){const e=typeof process=="object"&&"hrtime"in process&&typeof process.hrtime.bigint=="function"?process.hrtime:void 0;if(!e)return Lg;const t=Lg()-e.bigint();return()=>t+e.bigint()})();class AP{[Bg]=Bg;unsafeCurrentTimeMillis(){return Date.now()}unsafeCurrentTimeNanos(){return $P()}currentTimeMillis=M(()=>this.unsafeCurrentTimeMillis());currentTimeNanos=M(()=>this.unsafeCurrentTimeNanos());scheduler(){return L(Mg)}sleep(t){return Kn(n=>{const r=Mg.unsafeSchedule(()=>n(Ke),t);return on(M(r))})}}const RP=()=>new AP,Ow="And",Pw="Or",Fw="InvalidData",xw="MissingData",Nw="SourceUnavailable",Bw="Unsupported",OP="effect/ConfigError",Hg=Symbol.for(OP),ti={_tag:"ConfigError",[Hg]:Hg},Mw=(e,t)=>{const n=Object.create(ti);return n._op=Ow,n.left=e,n.right=t,Object.defineProperty(n,"toString",{enumerable:!1,value(){return`${this.left} and ${this.right}`}}),Object.defineProperty(n,"message",{enumerable:!1,get(){return this.toString()}}),n},Lw=(e,t)=>{const n=Object.create(ti);return n._op=Pw,n.left=e,n.right=t,Object.defineProperty(n,"toString",{enumerable:!1,value(){return`${this.left} or ${this.right}`}}),Object.defineProperty(n,"message",{enumerable:!1,get(){return this.toString()}}),n},PP=(e,t,n={pathDelim:"."})=>{const r=Object.create(ti);return r._op=Fw,r.path=e,r.message=t,Object.defineProperty(r,"toString",{enumerable:!1,value(){return`(Invalid data at ${p(this.path,Wo(n.pathDelim))}: "${this.message}")`}}),r},Ss=(e,t,n={pathDelim:"."})=>{const r=Object.create(ti);return r._op=xw,r.path=e,r.message=t,Object.defineProperty(r,"toString",{enumerable:!1,value(){return`(Missing data at ${p(this.path,Wo(n.pathDelim))}: "${this.message}")`}}),r},FP=(e,t,n,r={pathDelim:"."})=>{const s=Object.create(ti);return s._op=Nw,s.path=e,s.message=t,s.cause=n,Object.defineProperty(s,"toString",{enumerable:!1,value(){return`(Source unavailable at ${p(this.path,Wo(r.pathDelim))}: "${this.message}")`}}),s},xP=(e,t,n={pathDelim:"."})=>{const r=Object.create(ti);return r._op=Bw,r.path=e,r.message=t,Object.defineProperty(r,"toString",{enumerable:!1,value(){return`(Unsupported operation at ${p(this.path,Wo(n.pathDelim))}: "${this.message}")`}}),r},Xr=d(2,(e,t)=>{switch(e._op){case Ow:return Mw(Xr(e.left,t),Xr(e.right,t));case Pw:return Lw(Xr(e.left,t),Xr(e.right,t));case Fw:return PP([...t,...e.path],e.message);case xw:return Ss([...t,...e.path],e.message);case Nw:return FP([...t,...e.path],e.message,e.cause);case Bw:return xP([...t,...e.path],e.message)}}),NP={_tag:"Empty"},cf=d(2,(e,t)=>{let n=rp(t),r=e;for(;_1(n);){const s=n.head;switch(s._tag){case"Empty":{n=n.tail;break}case"AndThen":{n=gs(s.first,gs(s.second,n.tail));break}case"MapName":{r=rs(r,s.f),n=n.tail;break}case"Nested":{r=Ma(r,s.name),n=n.tail;break}case"Unnested":{if(p(Ri(r),tI(s.name)))r=ls(r),n=n.tail;else return re(Ss(r,`Expected ${s.name} to be in path in ConfigProvider#unnested`));break}}}return pe(r)}),BP="Constant",MP="Fail",LP="Fallback",HP="Described",DP="Lazy",UP="MapOrFail",KP="Nested",jP="Primitive",zP="Sequence",VP="HashMap",qP="ZipWith";var Dg={};const Ya=(e,t)=>[...e,...t],WP="effect/ConfigProvider",Ug=Symbol.for(WP),JP=ks("effect/ConfigProvider"),GP="effect/ConfigProviderFlat",Kg=Symbol.for(GP),YP=e=>({[Ug]:Ug,pipe(){return G(this,arguments)},...e}),QP=e=>({[Kg]:Kg,patch:e.patch,load:(t,n,r=!0)=>e.load(t,n,r),enumerateChildren:e.enumerateChildren}),XP=e=>YP({load:t=>P(an(e,fs(),t,!1),n=>xe(Ri(n),{onNone:()=>rt(Ss(fs(),`Expected a single value having structure: ${t}`)),onSome:L})),flattened:e}),ZP=e=>{const{pathDelim:t,seqDelim:n}=Object.assign({},{pathDelim:"_",seqDelim:","},e),r=a=>p(a,Wo(t)),s=a=>a.split(t),o=()=>typeof process<"u"&&"env"in process&&typeof Dg=="object"?Dg:{};return XP(QP({load:(a,u,l=!0)=>{const f=r(a),h=o(),m=f in h?U(h[f]):K();return p(m,el(()=>Ss(a,`Expected ${f} to exist in the process context`)),P(y=>sF(y,a,u,n,l)))},enumerateChildren:a=>M(()=>{const u=o(),h=Object.keys(u).map(m=>s(m.toUpperCase())).filter(m=>{for(let y=0;y<a.length;y++){const b=p(a,fb(y)),_=m[y];if(_===void 0||b!==_)return!1}return!0}).flatMap(m=>m.slice(a.length,a.length+1));return XA(h)}),patch:NP}))},eF=(e,t,n,r)=>{const s=Zm(n.length,a=>a>=r.length?K():U([e(a),a+1])),o=Zm(r.length,a=>a>=n.length?K():U([t(a),a+1])),i=Ya(n,s),c=Ya(r,o);return[i,c]},tF=(e,t)=>{let n=t;if(n._tag==="Nested"){const r=e.slice();for(;n._tag==="Nested";)r.push(n.name),n=n.config;return r}return e},an=(e,t,n,r)=>{const s=n;switch(s._tag){case BP:return L(yn(s.value));case HP:return ae(()=>an(e,t,s.config,r));case MP:return rt(Ss(t,s.message));case LP:return p(ae(()=>an(e,t,s.first,r)),Po(o=>s.condition(o)?p(an(e,t,s.second,r),Po(i=>rt(Lw(o,i)))):rt(o)));case DP:return ae(()=>an(e,t,s.config(),r));case UP:return ae(()=>p(an(e,t,s.original,r),P(sr(o=>p(s.mapOrFail(o),el(Xr(tF(t,s.original))))))));case KP:return ae(()=>an(e,Ya(t,yn(s.name)),s.config,r));case jP:return p(cf(t,e.patch),P(o=>p(e.load(o,s,r),P(i=>{if(i.length===0){const c=p(dI(o),qe(()=>"<n/a>"));return rt(Ss([],`Expected ${s.description} with name ${c}`))}return L(i)}))));case zP:return p(cf(t,e.patch),P(o=>p(e.enumerateChildren(o),P(iF),P(i=>i.length===0?ae(()=>ne(an(e,t,s.config,!0),yn)):p(sr(i,c=>an(e,cI(t,`[${c}]`),s.config,!0)),ne(c=>{const a=wI(c);return a.length===0?yn(fs()):yn(a)}))))));case VP:return ae(()=>p(cf(t,e.patch),P(o=>p(e.enumerateChildren(o),P(i=>p(i,sr(c=>an(e,Ya(o,yn(c)),s.valueConfig,r)),ne(c=>c.length===0?yn(np()):p(oF(c),rs(a=>f1(Xm(Ne(i),a)))))))))));case qP:return ae(()=>p(an(e,t,s.left,r),Fo,P(o=>p(an(e,t,s.right,r),Fo,P(i=>{if(vt(o)&&vt(i))return rt(Mw(o.left,i.left));if(vt(o)&&Pn(i))return rt(o.left);if(Pn(o)&&vt(i))return rt(i.left);if(Pn(o)&&Pn(i)){const c=p(t,Wo(".")),a=nF(t,c),[u,l]=eF(a,a,p(o.right,rs(pe)),p(i.right,rs(pe)));return p(u,Xm(l),sr(([f,h])=>p(dw(f,h),ne(([m,y])=>s.zip(m,y)))))}throw new Error("BUG: ConfigProvider.fromFlatLoop - please report an issue at https://github.com/Effect-TS/effect/issues")})))))}},nF=(e,t)=>n=>re(Ss(e,`The element at index ${n} in a sequence at path "${t}" was missing`)),rF=(e,t)=>e.split(new RegExp(`\\s*${Ha(t)}\\s*`)),sF=(e,t,n,r,s)=>s?p(rF(e,r),sr(o=>n.parse(o.trim())),el(Xr(t))):p(n.parse(e),up({onFailure:Xr(t),onSuccess:yn})),oF=e=>Object.keys(e[0]).map(t=>e.map(n=>n[t])),iF=e=>p(sr(e,aF),up({onFailure:()=>fs(),onSuccess:Ui(bo)}),Fo,ne(jC)),cF=/^(\[(\d+)\])$/,aF=e=>{const t=e.match(cF);if(t!==null){const n=t[2];return p(n!==void 0&&n.length>0?U(n):K(),qo(uF))}return K()},uF=e=>{const t=Number.parseInt(e);return Number.isNaN(t)?K():U(t)},jg=Symbol.for("effect/Console"),Hw=ks("effect/Console"),lF={[jg]:jg,assert(e,...t){return M(()=>{console.assert(e,...t)})},clear:M(()=>{console.clear()}),count(e){return M(()=>{console.count(e)})},countReset(e){return M(()=>{console.countReset(e)})},debug(...e){return M(()=>{console.debug(...e)})},dir(e,t){return M(()=>{console.dir(e,t)})},dirxml(...e){return M(()=>{console.dirxml(...e)})},error(...e){return M(()=>{console.error(...e)})},group(e){return e?.collapsed?M(()=>console.groupCollapsed(e?.label)):M(()=>console.group(e?.label))},groupEnd:M(()=>{console.groupEnd()}),info(...e){return M(()=>{console.info(...e)})},log(...e){return M(()=>{console.log(...e)})},table(e,t){return M(()=>{console.table(e,t)})},time(e){return M(()=>console.time(e))},timeEnd(e){return M(()=>console.timeEnd(e))},timeLog(e,...t){return M(()=>{console.timeLog(e,...t)})},trace(...e){return M(()=>{console.trace(...e)})},warn(...e){return M(()=>{console.warn(...e)})},unsafe:console},fF="effect/Random",zg=Symbol.for(fF),hF=ks("effect/Random");class dF{seed;[zg]=zg;PRNG;constructor(t){this.seed=t,this.PRNG=new fC(t)}get next(){return M(()=>this.PRNG.number())}get nextBoolean(){return ne(this.next,t=>t>.5)}get nextInt(){return M(()=>this.PRNG.integer(Number.MAX_SAFE_INTEGER))}nextRange(t,n){return ne(this.next,r=>(n-t)*r+t)}nextIntBetween(t,n){return M(()=>this.PRNG.integer(n-t)+t)}shuffle(t){return pF(t,n=>this.nextIntBetween(0,n))}}const pF=(e,t)=>ae(()=>p(M(()=>Array.from(e)),P(n=>{const r=[];for(let s=n.length;s>=2;s=s-1)r.push(s);return p(r,Zu(s=>p(t(s),ne(o=>mF(n,s-1,o)))),Jt(Ki(n)))}))),mF=(e,t,n)=>{const r=e[t];return e[t]=e[n],e[n]=r,e},gF=e=>new dF(Y(e)),Vg=Symbol.for("effect/Tracer"),yF=e=>({[Vg]:Vg,...e}),Dw=ks("effect/Tracer"),Uw=ks("effect/ParentSpan"),qg=(function(){const e="abcdef0123456789",t=e.length;return function(n){let r="";for(let s=0;s<n;s++)r+=e.charAt(Math.floor(Math.random()*t));return r}})();class SF{name;parent;context;startTime;kind;_tag="Span";spanId;traceId="native";sampled=!0;status;attributes;events=[];links;constructor(t,n,r,s,o,i){this.name=t,this.parent=n,this.context=r,this.startTime=o,this.kind=i,this.status={_tag:"Started",startTime:o},this.attributes=new Map,this.traceId=n._tag==="Some"?n.value.traceId:qg(32),this.spanId=qg(16),this.links=Array.from(s)}end(t,n){this.status={_tag:"Ended",endTime:t,exit:n,startTime:this.status.startTime}}attribute(t,n){this.attributes.set(t,n)}event(t,n,r){this.events.push([t,n,r??{}])}addLinks(t){this.links.push(...t)}}const bF=yF({span:(e,t,n,r,s,o)=>new SF(e,t,n,r,s,o),context:e=>e()}),_F=p(Ud(),Jr(dl,RP()),Jr(Hw,lF),Jr(hF,gF(Math.random())),Jr(JP,ZP()),Jr(Dw,bF)),Qa=be(Symbol.for("effect/DefaultServices/currentServices"),()=>Sw(_F)),wF=e=>{const t=qt(e);return Kw(n=>n.sleep(t))},vF=e=>Ee(t=>e(t.currentDefaultServices)),Kw=e=>vF(t=>e(t.unsafeMap.get(dl.key))),kF=Kw(e=>e.currentTimeMillis),TF=wF,EF=kF;function CF(e){return new xr(e)}function IF(){return CF(new Map)}const Wg=Symbol.for("effect/FiberRefs");class xr{locals;[Wg]=Wg;constructor(t){this.locals=t}pipe(){return G(this,arguments)}}const $F=(e,t,n,r=!1)=>{const s=e;let o=t,i=n,c=r,a;for(;a===void 0;)if(_t(o)&&_t(i)){const u=jt(o)[0],l=ls(o),f=jt(i)[0],h=jt(i)[1],m=ls(i);u.startTimeMillis<f.startTimeMillis?(i=m,c=!0):u.startTimeMillis>f.startTimeMillis?o=l:u.id<f.id?(i=m,c=!0):u.id>f.id?o=l:a=[h,c]}else a=[s.initial,!0];return a},AF=d(3,(e,t,n)=>{const r=new Map(e.locals);return n.locals.forEach((s,o)=>{const i=s[0][1];if(!s[0][0][fe](t)){if(!r.has(o)){if(oe(i,o.initial))return;r.set(o,[[t,o.join(o.initial,i)]]);return}const c=r.get(o),[a,u]=$F(o,c,s);if(u){const l=o.diff(a,i),f=c[0][1],h=o.join(f,o.patch(l)(f));if(!oe(f,h)){let m;const y=c[0][0];y[fe](t)?m=[[y,h],...c.slice(1)]:m=[[t,h],...c],r.set(o,m)}}}}),new xr(r)}),RF=d(2,(e,t)=>{const n=new Map;return jw(e,n,t),new xr(n)}),jw=(e,t,n)=>{e.locals.forEach((r,s)=>{const o=r[0][1],i=s.patch(s.fork)(o);oe(o,i)?t.set(s,r):t.set(s,[[n,i],...r])})},zw=d(2,(e,t)=>{const n=new Map(e.locals);return n.delete(t),new xr(n)}),OF=d(2,(e,t)=>e.locals.has(t)?U(jt(e.locals.get(t))[1]):K()),Zi=d(2,(e,t)=>p(OF(e,t),qe(()=>t.initial))),vh=d(2,(e,{fiberId:t,fiberRef:n,value:r})=>{if(e.locals.size===0)return new xr(new Map([[n,[[t,r]]]]));const s=new Map(e.locals);return kh(s,t,n,r),new xr(s)}),kh=(e,t,n,r)=>{const s=e.get(n)??[];let o;if(_t(s)){const[i,c]=jt(s);if(i[fe](t)){if(oe(c,r))return;o=[[t,r],...s.slice(1)]}else o=[[t,r],...s]}else o=[[t,r]];e.set(n,o)},PF=d(2,(e,{entries:t,forkAs:n})=>{if(e.locals.size===0)return new xr(new Map(t));const r=new Map(e.locals);return n!==void 0&&jw(e,r,n),t.forEach(([s,o])=>{o.length===1?kh(r,o[0][0],s,o[0][1]):o.forEach(([i,c])=>{kh(r,i,s,c)})}),new xr(r)}),FF=Zi,xF=PF,NF=IF,BF=EO,MF=CO,LF=IO,HF=mw,DF=gw,UF=yw,KF=$O,jF=AO,zF=p(bo,ab(e=>e.ordinal)),VF=qC(zF),qF=e=>{switch(e){case"All":return BF;case"Debug":return UF;case"Error":return LF;case"Fatal":return MF;case"Info":return DF;case"Trace":return KF;case"None":return jF;case"Warning":return HF}},Vw=e=>e.replace(/[\s="]/g,"_"),WF=e=>t=>`${Vw(t.label)}=${e-t.startTime}ms`,JF=pc,GF=OC;let ni=class extends GF{};const Bo=Symbol.for("effect/Readable"),Tp=Symbol.for("effect/Ref"),Ep={_A:e=>e};class YF extends ni{ref;commit(){return this.get}[Tp]=Ep;[Bo]=Bo;constructor(t){super(),this.ref=t,this.get=M(()=>_e(this.ref))}get;modify(t){return M(()=>{const n=_e(this.ref),[r,s]=t(n);return n!==s&&Es(s)(this.ref),r})}}const Cp=e=>new YF(Ts(e)),Xa=e=>M(()=>Cp(e)),pn=e=>e.get,ao=d(2,(e,t)=>e.modify(()=>[void 0,t])),qw=d(2,(e,t)=>e.modify(t)),Za=d(2,(e,t)=>e.modify(n=>[void 0,t(n)])),QF=Tp,Ip=Xa,Fi=pn,fi=qw,Ww=ao,Jw=Za,Gw="Empty",Yw="Add",Qw="Remove",Xw="Update",Zw="AndThen",XF={_tag:Gw},ev=(e,t)=>{const n=new Map(e.locals);let r=XF;for(const[s,o]of t.locals.entries()){const i=jt(o)[1],c=n.get(s);if(c!==void 0){const a=jt(c)[1];oe(a,i)||(r=af({_tag:Xw,fiberRef:s,patch:s.diff(a,i)})(r))}else r=af({_tag:Yw,fiberRef:s,value:i})(r);n.delete(s)}for(const[s]of n.entries())r=af({_tag:Qw,fiberRef:s})(r);return r},af=d(2,(e,t)=>({_tag:Zw,first:e,second:t})),tv=d(3,(e,t,n)=>{let r=n,s=yn(e);for(;_t(s);){const o=jt(s),i=ls(s);switch(o._tag){case Gw:{s=i;break}case Yw:{r=vh(r,{fiberId:t,fiberRef:o.fiberRef,value:o.value}),s=i;break}case Qw:{r=zw(r,o.fiberRef),s=i;break}case Xw:{const c=Zi(r,o.fiberRef);r=vh(r,{fiberId:t,fiberRef:o.fiberRef,value:o.fiberRef.patch(o.patch)(c)}),s=i;break}case Zw:{s=Ma(o.first)(Ma(o.second)(i));break}}}return r}),nv="effect/MetricLabel",Th=Symbol.for(nv);class ZF{key;value;[Th]=Th;_hash;constructor(t,n){this.key=t,this.value=n,this._hash=Ze(nv+this.key+this.value)}[he](){return this._hash}[fe](t){return tx(t)&&this.key===t.key&&this.value===t.value}pipe(){return G(this,arguments)}}const ex=(e,t)=>new ZF(e,t),tx=e=>te(e,Th),nx=e=>ne(e,U),rx=d(2,(e,t)=>sn(e,{onFailure:n=>{const r=t(n);switch(r._tag){case"None":return lt(n);case"Some":return r.value}},onSuccess:L})),sx=e=>px(e,ix,ev),rv=d(2,(e,t)=>jn(e,{onFailure:n=>L(t.onFailure(n)),onSuccess:n=>L(t.onSuccess(n))})),ox=e=>{const t=P(P(e,()=>rl()),()=>t);return t},ix=Ee(e=>L(e.getFiberRefs())),cx=e=>rv(e,{onFailure:Ra,onSuccess:Ra}),Jg=d(2,(e,t)=>sn(e,{onFailure:n=>uw(()=>t(n)),onSuccess:L})),ax=e=>ne(e,t=>!t),ux=e=>yx((t,n)=>p(e,tv(t,n))),lx=e=>e.length>=1?Kn((t,n)=>{try{e(n).then(r=>t(L(r)),r=>t(Tr(r)))}catch(r){t(Tr(r))}}):Kn(t=>{try{e().then(n=>t(L(n)),n=>t(Tr(n)))}catch(n){t(Tr(n))}}),fx=d(3,(e,t,n)=>As(r=>ll(e,Jr(r,t,n)))),eu=d(3,(e,t,n)=>As(r=>P(n,s=>ll(e,p(r,Jr(t,s)))))),hx=d(3,(e,t,n)=>Ne(e).reduce((r,s,o)=>P(r,i=>n(i,s,o)),L(t))),sv=TF,dx=L(K()),px=d(3,(e,t,n)=>P(t,r=>P(e,s=>ne(t,o=>[n(r,o),s])))),mx=d(2,(e,t)=>sn(e,{onFailure:n=>mt(t(n),lt(n)),onSuccess:L})),gx=e=>{let t,n;typeof e=="function"?t=e:(t=e.try,n=e.catch);const r=s=>n?Qu(()=>n(s)):rt(new vw(s,"An unknown error occurred in Effect.tryPromise"));return t.length>=1?Kn((s,o)=>{try{t(o).then(i=>s(L(i)),i=>s(r(i)))}catch(i){s(r(i))}}):Kn(s=>{try{t().then(o=>s(L(o)),o=>s(r(o)))}catch(o){s(r(o))}})},yx=e=>Ee(t=>(t.setFiberRefs(e(t.id(),t.getFiberRefs())),Ke)),Sx=d(2,(e,t)=>ae(()=>t()?ne(e,U):L(K()))),ov="Sequential",iv="Parallel",bx="ParallelN",$r={_tag:ov},Eh={_tag:iv},_x=e=>({_tag:bx,parallelism:e}),wx=e=>e._tag===ov,vx=e=>e._tag===iv,tu=$r,Ch=Eh,Ih=_x,ec=ev,tc=tv,pl="effect/FiberStatus",bs=Symbol.for(pl),nu="Done",Gg="Running",Yg="Suspended",kx=Ze(`${pl}-${nu}`);let Tx=class{[bs]=bs;_tag=nu;[he](){return kx}[fe](t){return $p(t)&&t._tag===nu}};class Ex{runtimeFlags;[bs]=bs;_tag=Gg;constructor(t){this.runtimeFlags=t}[he](){return p(Y(pl),ye(Y(this._tag)),ye(Y(this.runtimeFlags)),Ye(this))}[fe](t){return $p(t)&&t._tag===Gg&&this.runtimeFlags===t.runtimeFlags}}class Cx{runtimeFlags;blockingOn;[bs]=bs;_tag=Yg;constructor(t,n){this.runtimeFlags=t,this.blockingOn=n}[he](){return p(Y(pl),ye(Y(this._tag)),ye(Y(this.runtimeFlags)),ye(Y(this.blockingOn)),Ye(this))}[fe](t){return $p(t)&&t._tag===Yg&&this.runtimeFlags===t.runtimeFlags&&oe(this.blockingOn,t.blockingOn)}}const Ix=new Tx,$x=e=>new Ex(e),Ax=(e,t)=>new Cx(e,t),$p=e=>te(e,bs),Rx=e=>e._tag===nu,Ox=Ix,cv=$x,Px=Ax,av=Rx,Fx=Symbol.for("effect/Micro"),ru=Symbol.for("effect/Micro/MicroExit"),Qg=Symbol.for("effect/Micro/MicroCause"),xx={_E:ee};class uv extends globalThis.Error{_tag;traces;[Qg];constructor(t,n,r){const s=`MicroCause.${t}`;let o,i,c;if(n instanceof globalThis.Error){o=`(${s}) ${n.name}`,i=n.message;const a=i.split(`
`).length;c=n.stack?`(${s}) ${n.stack.split(`
`).slice(0,a+3).join(`
`)}`:`${o}: ${i}`}else o=s,i=yo(n,0),c=`${o}: ${i}`;r.length>0&&(c+=`
    ${r.join(`
    `)}`),super(i),this._tag=t,this.traces=r,this[Qg]=xx,this.name=o,this.stack=c}pipe(){return G(this,arguments)}toString(){return this.stack}[Me](){return this.stack}}class Nx extends uv{defect;constructor(t,n=[]){super("Die",t,n),this.defect=t}}const Bx=(e,t=[])=>new Nx(e,t);class Mx extends uv{constructor(t=[]){super("Interrupt","interrupted",t)}}const Lx=(e=[])=>new Mx(e),Hx=e=>e._tag==="Interrupt",Xg=Symbol.for("effect/Micro/MicroFiber"),Dx={_A:ee,_E:ee};class Ux{context;interruptible;[Xg];_stack=[];_observers=[];_exit;_children;currentOpCount=0;constructor(t,n=!0){this.context=t,this.interruptible=n,this[Xg]=Dx}getRef(t){return N$(this.context,t)}addObserver(t){return this._exit?(t(this._exit),Ra):(this._observers.push(t),()=>{const n=this._observers.indexOf(t);n>=0&&this._observers.splice(n,1)})}_interrupted=!1;unsafeInterrupt(){this._exit||(this._interrupted=!0,this.interruptible&&this.evaluate(Fp))}unsafePoll(){return this._exit}evaluate(t){if(this._exit)return;if(this._yielded!==void 0){const s=this._yielded;this._yielded=void 0,s()}const n=this.runLoop(t);if(n===Jc)return;const r=Zg.interruptChildren&&Zg.interruptChildren(this);if(r!==void 0)return this.evaluate(ou(r,()=>n));this._exit=n;for(let s=0;s<this._observers.length;s++)this._observers[s](n);this._observers.length=0}runLoop(t){let n=!1,r=t;this.currentOpCount=0;try{for(;;){if(this.currentOpCount++,!n&&this.getRef(xp).shouldYield(this)){n=!0;const s=r;r=ou(qx,()=>s)}if(r=r[$h](this),r===Jc){const s=this._yielded;return ru in s?(this._yielded=void 0,s):Jc}}}catch(s){return te(r,$h)?Ah(s):Ah(`MicroFiber.runLoop: Not a valid effect: ${String(r)}`)}}getCont(t){for(;;){const n=this._stack.pop();if(!n)return;const r=n[su]&&n[su](this);if(r)return{[t]:r};if(n[t])return n}}_yielded=void 0;yieldWith(t){return this._yielded=t,Jc}children(){return this._children??=new Set}}const Zg=be("effect/Micro/fiberMiddleware",()=>({interruptChildren:void 0})),lv=Symbol.for("effect/Micro/identifier"),gt=Symbol.for("effect/Micro/args"),$h=Symbol.for("effect/Micro/evaluate"),Mo=Symbol.for("effect/Micro/successCont"),uo=Symbol.for("effect/Micro/failureCont"),su=Symbol.for("effect/Micro/ensureCont"),Jc=Symbol.for("effect/Micro/Yield"),Kx={_A:ee,_E:ee,_R:ee},jx={...JF,_op:"Micro",[Fx]:Kx,pipe(){return G(this,arguments)},[Symbol.iterator](){return new jS(new hc(this))},toJSON(){return{_id:"Micro",op:this[lv],...gt in this?{args:this[gt]}:void 0}},toString(){return ct(this)},[Me](){return ct(this)}};function zx(e){return Ah("Micro.evaluate: Not implemented")}const ml=e=>({...jx,[lv]:e.op,[$h]:e.eval??zx,[Mo]:e.contA,[uo]:e.contE,[su]:e.ensure}),Ap=e=>{const t=ml(e);return function(){const n=Object.create(t);return n[gt]=e.single===!1?arguments:arguments[0],n}},fv=e=>{const t={...ml(e),[ru]:ru,_tag:e.op,get[e.prop](){return this[gt]},toJSON(){return{_id:"MicroExit",_tag:e.op,[e.prop]:this[gt]}},[fe](n){return Gx(n)&&n._tag===e.op&&oe(this[gt],n[gt])},[he](){return Ye(this,ye(Ze(e.op))(Y(this[gt])))}};return function(n){const r=Object.create(t);return r[gt]=n,r[Mo]=void 0,r[uo]=void 0,r[su]=void 0,r}},Rp=fv({op:"Success",prop:"value",eval(e){const t=e.getCont(Mo);return t?t[Mo](this[gt],e):e.yieldWith(this)}}),hv=fv({op:"Failure",prop:"cause",eval(e){let t=e.getCont(uo);for(;Hx(this[gt])&&t&&e.interruptible;)t=e.getCont(uo);return t?t[uo](this[gt],e):e.yieldWith(this)}}),Vx=Ap({op:"Yield",eval(e){let t=!1;return e.getRef(xp).scheduleTask(()=>{t||e.evaluate(Yx)},this[gt]??0),e.yieldWith(()=>{t=!0})}}),qx=Vx(0),Wx=Rp(void 0),Op=Ap({op:"WithMicroFiber",eval(e){return this[gt](e)}}),ou=d(2,(e,t)=>{const n=Object.create(Jx);return n[gt]=e,n[Mo]=t,n}),Jx=ml({op:"OnSuccess",eval(e){return e._stack.push(this),this[gt]}}),Gx=e=>te(e,ru),dv=Rp,Pp=hv,Fp=Pp(Lx()),Ah=e=>Pp(Bx(e)),Yx=dv(void 0),Qx="setImmediate"in globalThis?globalThis.setImmediate:e=>setTimeout(e,0);class pv{tasks=[];running=!1;scheduleTask(t,n){this.tasks.push(t),this.running||(this.running=!0,Qx(this.afterScheduled))}afterScheduled=()=>{this.running=!1,this.runTasks()};runTasks(){const t=this.tasks;this.tasks=[];for(let n=0,r=t.length;n<r;n++)t[n]()}shouldYield(t){return t.currentOpCount>=t.getRef(eN)}flush(){for(;this.tasks.length>0;)this.runTasks()}}const Xx=d(2,(e,t)=>Op(n=>{const r=n.context;return n.context=t(r),rN(e,()=>(n.context=r,Wx))})),Zx=d(2,(e,t)=>Xx(e,Fu(t)));class eN extends xu()("effect/Micro/currentMaxOpsBeforeYield",{defaultValue:()=>2048}){}class xp extends xu()("effect/Micro/currentScheduler",{defaultValue:()=>new pv}){}const tN=d(2,(e,t)=>{const n=Object.create(nN);return n[gt]=e,n[Mo]=t.onSuccess,n[uo]=t.onFailure,n}),nN=ml({op:"OnSuccessAndFailure",eval(e){return e._stack.push(this),this[gt]}}),rN=d(2,(e,t)=>oN(n=>tN(n(e),{onFailure:r=>ou(t(Pp(r)),()=>hv(r)),onSuccess:r=>ou(t(dv(r)),()=>Rp(r))}))),mv=Ap({op:"SetInterruptible",ensure(e){if(e.interruptible=this[gt],e._interrupted&&e.interruptible)return()=>Fp}}),sN=e=>Op(t=>t.interruptible?e:(t.interruptible=!0,t._stack.push(mv(!1)),t._interrupted?Fp:e)),oN=e=>Op(t=>t.interruptible?(t.interruptible=!1,t._stack.push(mv(!0)),e(sN)):e(ee)),iN=(e,t)=>{const n=new Ux(xp.context(new pv));return n.evaluate(e),n};class gv{buckets=[];scheduleTask(t,n){const r=this.buckets.length;let s,o=0;for(;o<r&&this.buckets[o][0]<=n;o++)s=this.buckets[o];s&&s[0]===n?s[1].push(t):o===r?this.buckets.push([n,[t]]):this.buckets.splice(o,0,[n,[t]])}}class cN{maxNextTickBeforeTimer;running=!1;tasks=new gv;constructor(t){this.maxNextTickBeforeTimer=t}starveInternal(t){const n=this.tasks.buckets;this.tasks.buckets=[];for(const[r,s]of n)for(let o=0;o<s.length;o++)s[o]();this.tasks.buckets.length===0?this.running=!1:this.starve(t)}starve(t=0){t>=this.maxNextTickBeforeTimer?setTimeout(()=>this.starveInternal(0),0):Promise.resolve(void 0).then(()=>this.starveInternal(t+1))}shouldYield(t){return t.currentOpCount>t.getFiberRef(bw)?t.getFiberRef(Cc):!1}scheduleTask(t,n){this.tasks.scheduleTask(t,n),this.running||(this.running=!0,this.starve())}}const yv=be(Symbol.for("effect/Scheduler/defaultScheduler"),()=>new cN(2048));class Sv{tasks=new gv;deferred=!1;scheduleTask(t,n){this.deferred?yv.scheduleTask(t,n):this.tasks.scheduleTask(t,n)}shouldYield(t){return t.currentOpCount>t.getFiberRef(bw)?t.getFiberRef(Cc):!1}flush(){for(;this.tasks.buckets.length>0;){const t=this.tasks.buckets;this.tasks.buckets=[];for(const[n,r]of t)for(let s=0;s<r.length;s++)r[s]()}this.deferred=!0}}const Np=be(Symbol.for("effect/FiberRef/currentScheduler"),()=>Gt(yv)),bv=be(Symbol.for("effect/FiberRef/currentRequestMap"),()=>Gt(new Map)),ey=(e,t,n,r)=>{switch(e){case void 0:return t();case"unbounded":return n();case"inherit":return ol(KO,s=>s==="unbounded"?n():s>1?r(s):t());default:return e>1?r(e):t()}},Bp="InterruptSignal",Mp="Stateful",Lp="Resume",Hp="YieldNow",uf=e=>({_tag:Bp,cause:e}),ya=e=>({_tag:Mp,onFiber:e}),Bs=e=>({_tag:Lp,effect:e}),aN=()=>({_tag:Hp}),uN="effect/FiberScope",iu=Symbol.for(uN);class lN{[iu]=iu;fiberId=Eo;roots=new Set;add(t,n){this.roots.add(n),n.addObserver(()=>{this.roots.delete(n)})}}class fN{fiberId;parent;[iu]=iu;constructor(t,n){this.fiberId=t,this.parent=n}add(t,n){this.parent.tell(ya(r=>{r.addChild(n),n.addObserver(()=>{r.removeChild(n)})}))}}const hN=e=>new fN(e.id(),e),gl=be(Symbol.for("effect/FiberScope/Global"),()=>new lN),dN="effect/Fiber",pN=Symbol.for(dN),mN={_E:e=>e,_A:e=>e},gN="effect/Fiber",yN=Symbol.for(gN),SN=e=>e.await,bN=e=>e.inheritAll,nc=e=>sl(kc(e.await),e.inheritAll);({...mc});const _N=e=>e.status,jr="effect/FiberCurrent",wN="effect/Logger",vN=Symbol.for(wN),kN={_Message:e=>e,_Output:e=>e},Dp=e=>({[vN]:kN,log:e,pipe(){return G(this,arguments)}}),TN=/^[^\s"=]*$/,EN=(e,t)=>({annotations:n,cause:r,date:s,fiberId:o,logLevel:i,message:c,spans:a})=>{const u=y=>y.match(TN)?y:e(y),l=(y,b)=>`${Vw(y)}=${u(b)}`,f=(y,b)=>" "+l(y,b);let h=l("timestamp",s.toISOString());h+=f("level",i.label),h+=f("fiber",E_(o));const m=oI(c);for(let y=0;y<m.length;y++)h+=f("message",yo(m[y],t));WR(r)||(h+=f("cause",Zo(r,{renderErrorCause:!0})));for(const y of a)h+=" "+WF(s.getTime())(y);for(const[y,b]of n)h+=f(y,yo(b,t));return h},CN=e=>`"${e.replace(/\\([\s\S])|(")/g,"\\$1$2")}"`,IN=Dp(EN(CN)),$N=typeof process=="object"&&process!==null&&typeof process.stdout=="object"&&process.stdout!==null;$N&&process.stdout.isTTY;const _v="effect/MetricBoundaries",Rh=Symbol.for(_v);class AN{values;[Rh]=Rh;constructor(t){this.values=t,this._hash=p(Ze(_v),ye(dc(this.values)))}_hash;[he](){return this._hash}[fe](t){return RN(t)&&oe(this.values,t.values)}pipe(){return G(this,arguments)}}const RN=e=>te(e,Rh),ON=e=>{const t=p(e,ub(Be(Number.POSITIVE_INFINITY)),TI);return new AN(t)},PN=e=>p(sI(e.count-1,t=>e.start*Math.pow(e.factor,t)),rn,ON),FN="effect/MetricKeyType",wv=Symbol.for(FN),vv="effect/MetricKeyType/Counter",Oh=Symbol.for(vv),xN="effect/MetricKeyType/Frequency",NN=Symbol.for(xN),BN="effect/MetricKeyType/Gauge",MN=Symbol.for(BN),kv="effect/MetricKeyType/Histogram",Ph=Symbol.for(kv),LN="effect/MetricKeyType/Summary",HN=Symbol.for(LN),Tv={_In:e=>e,_Out:e=>e};class DN{incremental;bigint;[wv]=Tv;[Oh]=Oh;constructor(t,n){this.incremental=t,this.bigint=n,this._hash=Ze(vv)}_hash;[he](){return this._hash}[fe](t){return Ev(t)}pipe(){return G(this,arguments)}}class UN{boundaries;[wv]=Tv;[Ph]=Ph;constructor(t){this.boundaries=t,this._hash=p(Ze(kv),ye(Y(this.boundaries)))}_hash;[he](){return this._hash}[fe](t){return Cv(t)&&oe(this.boundaries,t.boundaries)}pipe(){return G(this,arguments)}}const KN=e=>new DN(e?.incremental??!1,e?.bigint??!1),jN=e=>new UN(e),Ev=e=>te(e,Oh),zN=e=>te(e,NN),VN=e=>te(e,MN),Cv=e=>te(e,Ph),qN=e=>te(e,HN),WN="effect/MetricKey",Iv=Symbol.for(WN),JN={_Type:e=>e},GN=Fd(oe);class Up{name;keyType;description;tags;[Iv]=JN;constructor(t,n,r,s=[]){this.name=t,this.keyType=n,this.description=r,this.tags=s,this._hash=p(Ze(this.name+this.description),ye(Y(this.keyType)),ye(dc(this.tags)))}_hash;[he](){return this._hash}[fe](t){return YN(t)&&this.name===t.name&&oe(this.keyType,t.keyType)&&oe(this.description,t.description)&&GN(this.tags,t.tags)}pipe(){return G(this,arguments)}}const YN=e=>te(e,Iv),QN=(e,t)=>new Up(e,KN(t),Cu(t?.description)),XN=(e,t,n)=>new Up(e,jN(t),Cu(n)),ZN=d(2,(e,t)=>t.length===0?e:new Up(e.name,e.keyType,e.description,ha(e.tags,t))),eB="effect/MetricState",Rc=Symbol.for(eB),$v="effect/MetricState/Counter",Fh=Symbol.for($v),Av="effect/MetricState/Frequency",xh=Symbol.for(Av),Rv="effect/MetricState/Gauge",Nh=Symbol.for(Rv),Ov="effect/MetricState/Histogram",Bh=Symbol.for(Ov),Pv="effect/MetricState/Summary",Mh=Symbol.for(Pv),Oc={_A:e=>e};class tB{count;[Rc]=Oc;[Fh]=Fh;constructor(t){this.count=t}[he](){return p(Y($v),ye(Y(this.count)),Ye(this))}[fe](t){return hB(t)&&this.count===t.count}pipe(){return G(this,arguments)}}const nB=Fd(oe);class rB{occurrences;[Rc]=Oc;[xh]=xh;constructor(t){this.occurrences=t}_hash;[he](){return p(Ze(Av),ye(dc(Ne(this.occurrences.entries()))),Ye(this))}[fe](t){return dB(t)&&nB(Ne(this.occurrences.entries()),Ne(t.occurrences.entries()))}pipe(){return G(this,arguments)}}class sB{value;[Rc]=Oc;[Nh]=Nh;constructor(t){this.value=t}[he](){return p(Y(Rv),ye(Y(this.value)),Ye(this))}[fe](t){return pB(t)&&this.value===t.value}pipe(){return G(this,arguments)}}class oB{buckets;count;min;max;sum;[Rc]=Oc;[Bh]=Bh;constructor(t,n,r,s,o){this.buckets=t,this.count=n,this.min=r,this.max=s,this.sum=o}[he](){return p(Y(Ov),ye(Y(this.buckets)),ye(Y(this.count)),ye(Y(this.min)),ye(Y(this.max)),ye(Y(this.sum)),Ye(this))}[fe](t){return mB(t)&&oe(this.buckets,t.buckets)&&this.count===t.count&&this.min===t.min&&this.max===t.max&&this.sum===t.sum}pipe(){return G(this,arguments)}}class iB{error;quantiles;count;min;max;sum;[Rc]=Oc;[Mh]=Mh;constructor(t,n,r,s,o,i){this.error=t,this.quantiles=n,this.count=r,this.min=s,this.max=o,this.sum=i}[he](){return p(Y(Pv),ye(Y(this.error)),ye(Y(this.quantiles)),ye(Y(this.count)),ye(Y(this.min)),ye(Y(this.max)),ye(Y(this.sum)),Ye(this))}[fe](t){return gB(t)&&this.error===t.error&&oe(this.quantiles,t.quantiles)&&this.count===t.count&&this.min===t.min&&this.max===t.max&&this.sum===t.sum}pipe(){return G(this,arguments)}}const cB=e=>new tB(e),aB=e=>new rB(e),uB=e=>new sB(e),lB=e=>new oB(e.buckets,e.count,e.min,e.max,e.sum),fB=e=>new iB(e.error,e.quantiles,e.count,e.min,e.max,e.sum),hB=e=>te(e,Fh),dB=e=>te(e,xh),pB=e=>te(e,Nh),mB=e=>te(e,Bh),gB=e=>te(e,Mh),yB="effect/MetricHook",SB=Symbol.for(yB),bB={_In:e=>e,_Out:e=>e},Pc=e=>({[SB]:bB,pipe(){return G(this,arguments)},...e}),ty=BigInt(0),_B=e=>{let t=e.keyType.bigint?ty:0;const n=e.keyType.incremental?e.keyType.bigint?s=>s>=ty:s=>s>=0:s=>!0,r=s=>{n(s)&&(t=t+s)};return Pc({get:()=>cB(t),update:r,modify:r})},wB=e=>{const t=new Map;for(const r of e.keyType.preregisteredWords)t.set(r,0);const n=r=>{const s=t.get(r)??0;t.set(r,s+1)};return Pc({get:()=>aB(t),update:n,modify:n})},vB=(e,t)=>{let n=t;return Pc({get:()=>uB(n),update:r=>{n=r},modify:r=>{n=n+r}})},kB=e=>{const t=e.keyType.boundaries.values,n=t.length,r=new Uint32Array(n+1),s=new Float64Array(n);let o=0,i=0,c=Number.MAX_VALUE,a=Number.MIN_VALUE;p(t,Ui(bo),rs((f,h)=>{s[h]=f}));const u=f=>{let h=0,m=n;for(;h!==m;){const y=Math.floor(h+(m-h)/2),b=s[y];f<=b?m=y:h=y,m===h+1&&(f<=s[h]?m=h:h=m)}r[h]=r[h]+1,o=o+1,i=i+f,f<c&&(c=f),f>a&&(a=f)},l=()=>{const f=Iu(n);let h=0;for(let m=0;m<n;m++){const y=s[m],b=r[m];h=h+b,f[m]=[y,h]}return f};return Pc({get:()=>lB({buckets:l(),count:o,min:c,max:a,sum:i}),update:u,modify:u})},TB=e=>{const{error:t,maxAge:n,maxSize:r,quantiles:s}=e.keyType,o=p(s,Ui(bo)),i=Iu(r);let c=0,a=0,u=0,l=0,f=0;const h=y=>{const b=[];let _=0;for(;_!==r-1;){const k=i[_];if(k!=null){const[C,v]=k,T=ie(y-C);mA(T,wo)&&pA(T,n)&&b.push(v)}_=_+1}return EB(t,o,Ui(b,bo))},m=(y,b)=>{if(r>0){c=c+1;const _=c%r;i[_]=[b,y]}l=a===0?y:Math.min(l,y),f=a===0?y:Math.max(f,y),a=a+1,u=u+y};return Pc({get:()=>fB({error:t,quantiles:h(Date.now()),count:a,min:l,max:f,sum:u}),update:([y,b])=>m(y,b),modify:([y,b])=>m(y,b)})},EB=(e,t,n)=>{const r=n.length;if(!_t(t))return fs();const s=t[0],o=t.slice(1),i=ny(e,r,K(),0,s,n),c=yn(i);return o.forEach(a=>{c.push(ny(e,r,i.value,i.consumed,a,i.rest))}),rs(c,a=>[a.quantile,a.value])},ny=(e,t,n,r,s,o)=>{let i=e,c=t,a=n,u=r,l=s,f=o,h=e,m=t,y=n,b=r,_=s,k=o;for(;;){if(!_t(f))return{quantile:l,value:K(),consumed:u,rest:[]};if(l===1)return{quantile:l,value:U(hb(f)),consumed:u+f.length,rest:[]};const C=jt(f),v=mI(f,O=>O===C),T=l*c,R=i/2*T,w=u+v[0].length,I=Math.abs(w-T);if(w<T-R){h=i,m=c,y=Ri(f),b=w,_=l,k=v[1],i=h,c=m,a=y,u=b,l=_,f=k;continue}if(w>T+R){const O=Ue(a)?U(C):a;return{quantile:l,value:O,consumed:u,rest:f}}switch(a._tag){case"None":{h=i,m=c,y=Ri(f),b=w,_=l,k=v[1],i=h,c=m,a=y,u=b,l=_,f=k;continue}case"Some":{const O=Math.abs(T-a.value);if(I<O){h=i,m=c,y=Ri(f),b=w,_=l,k=v[1],i=h,c=m,a=y,u=b,l=_,f=k;continue}return{quantile:l,value:U(a.value),consumed:u,rest:f}}}}throw new Error("BUG: MetricHook.resolveQuantiles - please report an issue at https://github.com/Effect-TS/effect/issues")},CB="effect/MetricPair",IB=Symbol.for(CB),$B={_Type:e=>e},AB=(e,t)=>({[IB]:$B,metricKey:e,metricState:t,pipe(){return G(this,arguments)}}),RB="effect/MetricRegistry",ry=Symbol.for(RB);class OB{[ry]=ry;map=pP();snapshot(){const t=[];for(const[n,r]of this.map)t.push(AB(n,r.get()));return t}get(t){const n=p(this.map,Wr(t),An);if(n==null){if(Ev(t.keyType))return this.getCounter(t);if(VN(t.keyType))return this.getGauge(t);if(zN(t.keyType))return this.getFrequency(t);if(Cv(t.keyType))return this.getHistogram(t);if(qN(t.keyType))return this.getSummary(t);throw new Error("BUG: MetricRegistry.get - unknown MetricKeyType - please report an issue at https://github.com/Effect-TS/effect/issues")}else return n}getCounter(t){let n=p(this.map,Wr(t),An);if(n==null){const r=_B(t);p(this.map,ui(t))||p(this.map,li(t,r)),n=r}return n}getFrequency(t){let n=p(this.map,Wr(t),An);if(n==null){const r=wB(t);p(this.map,ui(t))||p(this.map,li(t,r)),n=r}return n}getGauge(t){let n=p(this.map,Wr(t),An);if(n==null){const r=vB(t,t.keyType.bigint?BigInt(0):0);p(this.map,ui(t))||p(this.map,li(t,r)),n=r}return n}getHistogram(t){let n=p(this.map,Wr(t),An);if(n==null){const r=kB(t);p(this.map,ui(t))||p(this.map,li(t,r)),n=r}return n}getSummary(t){let n=p(this.map,Wr(t),An);if(n==null){const r=TB(t);p(this.map,ui(t))||p(this.map,li(t,r)),n=r}return n}}const PB=()=>new OB,FB="effect/Metric",xB=Symbol.for(FB),NB={_Type:e=>e,_In:e=>e,_Out:e=>e},sy=be(Symbol.for("effect/Metric/globalMetricRegistry"),()=>PB()),Fv=function(e,t,n,r){const s=Object.assign(o=>tl(o,i=>HB(s,i)),{[xB]:NB,keyType:e,unsafeUpdate:t,unsafeValue:n,unsafeModify:r,register(){return this.unsafeValue([]),this},pipe(){return G(this,arguments)}});return s},yl=(e,t)=>xv(QN(e,t)),xv=e=>{let t;const n=new WeakMap,r=s=>{if(s.length===0)return t!==void 0||(t=sy.get(e)),t;let o=n.get(s);return o!==void 0||(o=sy.get(ZN(e,s)),n.set(s,o)),o};return Fv(e.keyType,(s,o)=>r(o).update(s),s=>r(s).get(),(s,o)=>r(o).modify(s))},BB=(e,t,n)=>xv(XN(e,t,n)),MB=d(3,(e,t,n)=>LB(e,[ex(t,n)])),LB=d(2,(e,t)=>Fv(e.keyType,(n,r)=>e.unsafeUpdate(n,ha(t,r)),n=>e.unsafeValue(ha(t,n)),(n,r)=>e.unsafeModify(n,ha(t,r)))),HB=d(2,(e,t)=>ol(gh,n=>M(()=>e.unsafeUpdate(t,n))));({...$d});const DB=d(2,(e,t)=>ol(bv,n=>M(()=>{if(n.has(e)){const r=n.get(e);r.state.completed||(r.state.completed=!0,ul(r.result,t))}}))),UB="effect/Supervisor",Sl=Symbol.for(UB),Kp={_T:e=>e};class bl{underlying;value0;[Sl]=Kp;constructor(t,n){this.underlying=t,this.value0=n}get value(){return this.value0}onStart(t,n,r,s){this.underlying.onStart(t,n,r,s)}onEnd(t,n){this.underlying.onEnd(t,n)}onEffect(t,n){this.underlying.onEffect(t,n)}onSuspend(t){this.underlying.onSuspend(t)}onResume(t){this.underlying.onResume(t)}map(t){return new bl(this,p(this.value,ne(t)))}zip(t){return new _l(this,t)}}class _l{left;right;_tag="Zip";[Sl]=Kp;constructor(t,n){this.left=t,this.right=n}get value(){return dw(this.left.value,this.right.value)}onStart(t,n,r,s){this.left.onStart(t,n,r,s),this.right.onStart(t,n,r,s)}onEnd(t,n){this.left.onEnd(t,n),this.right.onEnd(t,n)}onEffect(t,n){this.left.onEffect(t,n),this.right.onEffect(t,n)}onSuspend(t){this.left.onSuspend(t),this.right.onSuspend(t)}onResume(t){this.left.onResume(t),this.right.onResume(t)}map(t){return new bl(this,p(this.value,ne(t)))}zip(t){return new _l(this,t)}}const Nv=e=>te(e,Sl)&&US(e,"Zip");class KB{effect;[Sl]=Kp;constructor(t){this.effect=t}get value(){return this.effect}onStart(t,n,r,s){}onEnd(t,n){}onEffect(t,n){}onSuspend(t){}onResume(t){}map(t){return new bl(this,p(this.value,ne(t)))}zip(t){return new _l(this,t)}onRun(t,n){return t()}}const jB=e=>new KB(e),wl=be("effect/Supervisor/none",()=>jB(Ke)),zB=Go,Bv="Empty",Mv="AddSupervisor",Lv="RemoveSupervisor",Hv="AndThen",xi={_tag:Bv},Sa=(e,t)=>({_tag:Hv,first:e,second:t}),VB=(e,t)=>qB(t,Be(e)),qB=(e,t)=>{let n=e,r=t;for(;Un(r);){const s=Fn(r);switch(s._tag){case Bv:{r=rr(r);break}case Mv:{n=n.zip(s.supervisor),r=rr(r);break}case Lv:{n=Lh(n,s.supervisor),r=rr(r);break}case Hv:{r=xt(s.first)(xt(s.second)(rr(r)));break}}}return n},Lh=(e,t)=>oe(e,t)?wl:Nv(e)?Lh(e.left,t).zip(Lh(e.right,t)):e,cu=e=>oe(e,wl)?ps():Nv(e)?p(cu(e.left),Wi(cu(e.right))):Zd(e),WB=(e,t)=>{if(oe(e,t))return xi;const n=cu(e),r=cu(t),s=p(r,pg(n),Ji(xi,(i,c)=>Sa(i,{_tag:Mv,supervisor:c}))),o=p(n,pg(r),Ji(xi,(i,c)=>Sa(i,{_tag:Lv,supervisor:c})));return Sa(s,o)},JB=zB({empty:xi,patch:VB,combine:Sa,diff:WB}),GB=yl("effect_fiber_started",{incremental:!0}),oy=yl("effect_fiber_active"),YB=yl("effect_fiber_successes",{incremental:!0}),QB=yl("effect_fiber_failures",{incremental:!0}),XB=MB(BB("effect_fiber_lifetimes",PN({start:.5,factor:2,count:35})),"time_unit","milliseconds"),hi="Continue",ZB="Done",iy="Yield",eM={_E:e=>e,_A:e=>e},Gc=e=>{throw new Error(`BUG: FiberRuntime - ${yo(e)} - please report an issue at https://github.com/Effect-TS/effect/issues`)},Gn=Symbol.for("effect/internal/fiberRuntime/YieldedOp"),Yn=be("effect/internal/fiberRuntime/yieldedOpChannel",()=>({currentOp:null})),di={[Fa]:(e,t,n)=>Dt(()=>t.effect_instruction_i1(n)),OnStep:(e,t,n)=>et(et(n)),[xa]:(e,t,n)=>Dt(()=>t.effect_instruction_i2(n)),[Cd]:(e,t,n)=>(e.patchRuntimeFlags(e.currentRuntimeFlags,t.patch),vr(e.currentRuntimeFlags)&&e.isInterrupted()?Oe(e.getInterruptedCause()):et(n)),[Na]:(e,t,n)=>(Dt(()=>t.effect_instruction_i2(n)),Dt(()=>t.effect_instruction_i0())?(e.pushStack(t),Dt(()=>t.effect_instruction_i1())):Ke),[Ai]:(e,t,n)=>{for(;;){const r=Dt(()=>t.effect_instruction_i0.next(n));if(r.done)return et(r.value);const s=dC(r.value);if(il(s)){if(s._tag==="Failure")return s}else return e.pushStack(t),s;n=s.value}}},tM={[Bp]:(e,t,n,r)=>(e.processNewInterruptSignal(r.cause),vr(t)?Oe(r.cause):n),[Lp]:(e,t,n,r)=>{throw new Error("It is illegal to have multiple concurrent run loops in a single fiber")},[Mp]:(e,t,n,r)=>(r.onFiber(e,cv(t)),n),[Hp]:(e,t,n,r)=>P(rl(),()=>n)},nM=e=>Zu(RR(e),t=>Ln(zR(t),([n,r])=>{const s=new Map,o=[];for(const c of r){o.push(ir(c));for(const a of c)s.set(a.request,a)}const i=o.flat();return Ec(EM(n.runAll(o),i,()=>i.forEach(c=>{c.listeners.interrupted=!0})),bv,s)},!1,!1)),rM=Id();class Dv extends ni{[pN]=mN;[yN]=eM;_fiberRefs;_fiberId;_queue=new Array;_children=null;_observers=new Array;_running=!1;_stack=[];_asyncInterruptor=null;_asyncBlockingOn=null;_exitValue=null;_steps=[];_isYielding=!1;currentRuntimeFlags;currentOpCount=0;currentSupervisor;currentScheduler;currentTracer;currentSpan;currentContext;currentDefaultServices;constructor(t,n,r){if(super(),this.currentRuntimeFlags=r,this._fiberId=t,this._fiberRefs=n,bg(r)){const s=this.getFiberRef(gh);GB.unsafeUpdate(1,s),oy.unsafeUpdate(1,s)}this.refreshRefCache()}commit(){return nc(this)}id(){return this._fiberId}resume(t){this.tell(Bs(t))}get status(){return this.ask((t,n)=>n)}get runtimeFlags(){return this.ask((t,n)=>av(n)?t.currentRuntimeFlags:n.runtimeFlags)}scope(){return hN(this)}get children(){return this.ask(t=>Array.from(t.getChildren()))}getChildren(){return this._children===null&&(this._children=new Set),this._children}getInterruptedCause(){return this.getFiberRef(Wc)}fiberRefs(){return this.ask(t=>t.getFiberRefs())}ask(t){return ae(()=>{const n=Ic(this._fiberId);return this.tell(ya((r,s)=>{ul(n,M(()=>t(r,s)))})),zn(n)})}tell(t){this._queue.push(t),this._running||(this._running=!0,this.drainQueueLaterOnExecutor())}get await(){return Kn(t=>{const n=r=>t(L(r));return this.tell(ya((r,s)=>{r._exitValue!==null?n(this._exitValue):r.addObserver(n)})),M(()=>this.tell(ya((r,s)=>{r.removeObserver(n)})))},this.id())}get inheritAll(){return Ee((t,n)=>{const r=t.id(),s=t.getFiberRefs(),o=n.runtimeFlags,i=this.getFiberRefs(),c=AF(s,r,i);t.setFiberRefs(c);const a=t.getFiberRef(ly),u=p(os(o,a),wg(Cs),wg(dh));return vO(u)})}get poll(){return M(()=>Cu(this._exitValue))}unsafePoll(){return this._exitValue}interruptAsFork(t){return M(()=>this.tell(uf(ln(t))))}unsafeInterruptAsFork(t){this.tell(uf(ln(t)))}addObserver(t){this._exitValue!==null?t(this._exitValue):this._observers.push(t)}removeObserver(t){this._observers=this._observers.filter(n=>n!==t)}getFiberRefs(){return this.setFiberRef(ly,this.currentRuntimeFlags),this._fiberRefs}unsafeDeleteFiberRef(t){this._fiberRefs=zw(this._fiberRefs,t)}getFiberRef(t){return this._fiberRefs.locals.has(t)?this._fiberRefs.locals.get(t)[0][1]:t.initial}setFiberRef(t,n){this._fiberRefs=vh(this._fiberRefs,{fiberId:this._fiberId,fiberRef:t,value:n}),this.refreshRefCache()}refreshRefCache(){this.currentDefaultServices=this.getFiberRef(Qa),this.currentTracer=this.currentDefaultServices.unsafeMap.get(Dw.key),this.currentSupervisor=this.getFiberRef(kM),this.currentScheduler=this.getFiberRef(Np),this.currentContext=this.getFiberRef(Ur),this.currentSpan=this.currentContext.unsafeMap.get(Uw.key)}setFiberRefs(t){this._fiberRefs=t,this.refreshRefCache()}addChild(t){this.getChildren().add(t)}removeChild(t){this.getChildren().delete(t)}transferChildren(t){const n=this._children;if(this._children=null,n!==null&&n.size>0)for(const r of n)r._exitValue===null&&t.add(this.currentRuntimeFlags,r)}drainQueueOnCurrentThread(){let t=!0;for(;t;){let n=hi;const r=globalThis[jr];globalThis[jr]=this;try{for(;n===hi;)n=this._queue.length===0?ZB:this.evaluateMessageWhileSuspended(this._queue.splice(0,1)[0])}finally{this._running=!1,globalThis[jr]=r}this._queue.length>0&&!this._running?(this._running=!0,n===iy?(this.drainQueueLaterOnExecutor(),t=!1):t=!0):t=!1}}drainQueueLaterOnExecutor(){this.currentScheduler.scheduleTask(this.run,this.getFiberRef(Cc))}drainQueueWhileRunning(t,n){let r=n;for(;this._queue.length>0;){const s=this._queue.splice(0,1)[0];r=tM[s._tag](this,t,r,s)}return r}isInterrupted(){return!GR(this.getFiberRef(Wc))}addInterruptedCause(t){const n=this.getFiberRef(Wc);this.setFiberRef(Wc,At(n,t))}processNewInterruptSignal(t){this.addInterruptedCause(t),this.sendInterruptSignalToAllChildren()}sendInterruptSignalToAllChildren(){if(this._children===null||this._children.size===0)return!1;let t=!1;for(const n of this._children)n.tell(uf(ln(this.id()))),t=!0;return t}interruptAllChildren(){if(this.sendInterruptSignalToAllChildren()){const t=this._children.values();this._children=null;let n=!1;return fp({while:()=>!n,body:()=>{const s=t.next();return s.done?M(()=>{n=!0}):on(s.value.await)},step:()=>{}})}return null}reportExitValue(t){if(bg(this.currentRuntimeFlags)){const n=this.getFiberRef(gh),r=this.id().startTimeMillis,s=Date.now();switch(XB.unsafeUpdate(s-r,n),oy.unsafeUpdate(-1,n),t._tag){case Pt:{YB.unsafeUpdate(1,n);break}case Ot:{QB.unsafeUpdate(1,n);break}}}if(t._tag==="Failure"){const n=this.getFiberRef(zO);!Ju(t.cause)&&n._tag==="Some"&&this.log("Fiber terminated with an unhandled error",t.cause,n)}}setExitValue(t){this._exitValue=t,this.reportExitValue(t);for(let n=this._observers.length-1;n>=0;n--)this._observers[n](t);this._observers=[]}getLoggers(){return this.getFiberRef(aM)}log(t,n,r){const s=$e(r)?r.value:this.getFiberRef(HO),o=this.getFiberRef(sM);if(VF(o,s))return;const i=this.getFiberRef(DO),c=this.getFiberRef(LO),a=this.getLoggers(),u=this.getFiberRefs();if(ep(a)>0){const l=e_(this.getFiberRef(Qa),dl),f=new Date(l.unsafeCurrentTimeMillis());_C(u,()=>{for(const h of a)h.log({fiberId:this.id(),logLevel:s,message:t,cause:n,context:u,spans:i,annotations:c,date:f})})}}evaluateMessageWhileSuspended(t){switch(t._tag){case Hp:return iy;case Bp:return this.processNewInterruptSignal(t.cause),this._asyncInterruptor!==null&&(this._asyncInterruptor(Oe(t.cause)),this._asyncInterruptor=null),hi;case Lp:return this._asyncInterruptor=null,this._asyncBlockingOn=null,this.evaluateEffect(t.effect),hi;case Mp:return t.onFiber(this,this._exitValue!==null?Ox:Px(this.currentRuntimeFlags,this._asyncBlockingOn)),hi;default:return Gc(t)}}evaluateEffect(t){this.currentSupervisor.onResume(this);try{let n=vr(this.currentRuntimeFlags)&&this.isInterrupted()?Oe(this.getInterruptedCause()):t;for(;n!==null;){const r=n,s=this.runLoop(r);if(s===Gn){const o=Yn.currentOp;Yn.currentOp=null,o._op===la?TR(this.currentRuntimeFlags)?(this.tell(aN()),this.tell(Bs(wn)),n=null):n=wn:o._op===$i&&(n=null)}else{this.currentRuntimeFlags=p(this.currentRuntimeFlags,CR(dh));const o=this.interruptAllChildren();o!==null?n=P(o,()=>s):(this._queue.length===0?this.setExitValue(s):this.tell(Bs(s)),n=null)}}}finally{this.currentSupervisor.onSuspend(this)}}start(t){if(this._running)this.tell(Bs(t));else{this._running=!0;const n=globalThis[jr];globalThis[jr]=this;try{this.evaluateEffect(t)}finally{this._running=!1,globalThis[jr]=n,this._queue.length>0&&this.drainQueueLaterOnExecutor()}}}startFork(t){this.tell(Bs(t))}patchRuntimeFlags(t,n){const r=io(t,n);return globalThis[jr]=this,this.currentRuntimeFlags=r,r}initiateAsync(t,n){let r=!1;const s=o=>{r||(r=!0,this.tell(Bs(o)))};vr(t)&&(this._asyncInterruptor=s);try{n(s)}catch(o){s(lt(tn(o)))}}pushStack(t){this._stack.push(t),t._op==="OnStep"&&this._steps.push({refs:this.getFiberRefs(),flags:this.currentRuntimeFlags})}popStack(){const t=this._stack.pop();if(t)return t._op==="OnStep"&&this._steps.pop(),t}getNextSuccessCont(){let t=this.popStack();for(;t;){if(t._op!==ua)return t;t=this.popStack()}}getNextFailCont(){let t=this.popStack();for(;t;){if(t._op!==Fa&&t._op!==Na&&t._op!==Ai)return t;t=this.popStack()}}[vC](t){return M(()=>t_(this.currentContext,t))}Left(t){return rt(t.left)}None(t){return rt(new mp)}Right(t){return et(t.right)}Some(t){return et(t.value)}Micro(t){return Wa(n=>{let r=n;const s=iN(Zx(t,this.currentContext));return s.addObserver(o=>{if(o._tag==="Success")return r(et(o.value));switch(o.cause._tag){case"Interrupt":return r(Oe(ln(Eo)));case"Fail":return r(rt(o.cause.error));case"Die":return r(Tr(o.cause.defect))}}),Wa(o=>{r=i=>{o(Ke)},s.unsafeInterrupt()})})}[GS](t){const n=Dt(()=>t.effect_instruction_i0()),r=this.getNextSuccessCont();return r!==void 0?(r._op in di||Gc(r),di[r._op](this,r,n)):(Yn.currentOp=et(n),Gn)}[Pt](t){const n=t,r=this.getNextSuccessCont();return r!==void 0?(r._op in di||Gc(r),di[r._op](this,r,n.effect_instruction_i0)):(Yn.currentOp=n,Gn)}[Ot](t){const n=t.effect_instruction_i0,r=this.getNextFailCont();if(r!==void 0)switch(r._op){case ua:case xa:return vr(this.currentRuntimeFlags)&&this.isInterrupted()?Oe(vg(n)):Dt(()=>r.effect_instruction_i1(n));case"OnStep":return vr(this.currentRuntimeFlags)&&this.isInterrupted()?Oe(vg(n)):et(Oe(n));case Cd:return this.patchRuntimeFlags(this.currentRuntimeFlags,r.patch),vr(this.currentRuntimeFlags)&&this.isInterrupted()?Oe(At(n,this.getInterruptedCause())):Oe(n);default:Gc(r)}else return Yn.currentOp=Oe(n),Gn}[YS](t){return Dt(()=>t.effect_instruction_i0(this,cv(this.currentRuntimeFlags)))}Blocked(t){const n=this.getFiberRefs(),r=this.currentRuntimeFlags;if(this._steps.length>0){const s=[],o=this._steps[this._steps.length-1];let i=this.popStack();for(;i&&i._op!=="OnStep";)s.push(i),i=this.popStack();this.setFiberRefs(o.refs),this.currentRuntimeFlags=o.flags;const c=ec(o.refs,n),a=os(o.flags,r);return et(tw(t.effect_instruction_i0,Ee(u=>{for(;s.length>0;)u.pushStack(s.pop());return u.setFiberRefs(tc(u.id(),u.getFiberRefs())(c)),u.currentRuntimeFlags=io(a)(u.currentRuntimeFlags),t.effect_instruction_i1})))}return kn(s=>P(Vp(gO(t.effect_instruction_i0)),()=>s(t.effect_instruction_i1)))}RunBlocked(t){return nM(t.effect_instruction_i0)}[Vo](t){const n=t.effect_instruction_i0,r=this.currentRuntimeFlags,s=io(r,n);if(vr(s)&&this.isInterrupted())return Oe(this.getInterruptedCause());if(this.patchRuntimeFlags(this.currentRuntimeFlags,n),t.effect_instruction_i1){const o=os(s,r);return this.pushStack(new yO(o,t)),Dt(()=>t.effect_instruction_i1(r))}else return wn}[Fa](t){return this.pushStack(t),t.effect_instruction_i0}OnStep(t){return this.pushStack(t),t.effect_instruction_i0}[ua](t){return this.pushStack(t),t.effect_instruction_i0}[xa](t){return this.pushStack(t),t.effect_instruction_i0}[$i](t){return this._asyncBlockingOn=t.effect_instruction_i1,this.initiateAsync(this.currentRuntimeFlags,t.effect_instruction_i0),Yn.currentOp=t,Gn}[la](t){return this._isYielding=!1,Yn.currentOp=t,Gn}[Na](t){const n=t.effect_instruction_i0,r=t.effect_instruction_i1;return n()?(this.pushStack(t),r()):wn}[Ai](t){return di[Ai](this,t,void 0)}[Eu](t){return Dt(()=>t.commit())}runLoop(t){let n=t;for(this.currentOpCount=0;;){if((this.currentRuntimeFlags&kR)!==0&&this.currentSupervisor.onEffect(this,n),this._queue.length>0&&(n=this.drainQueueWhileRunning(this.currentRuntimeFlags,n)),!this._isYielding){this.currentOpCount+=1;const r=this.currentScheduler.shouldYield(this);if(r!==!1){this._isYielding=!0,this.currentOpCount=0;const s=n;n=P(rl({priority:r}),()=>s)}}try{if(n=this.currentTracer.context(()=>{if(rM!==n[Oo]._V){const r=this.getFiberRef(VO);if(r._tag==="Some"){const s=n[Oo]._V;this.log(`Executing an Effect versioned ${s} with a Runtime of version ${Id()}, you may want to dedupe the effect dependencies, you can use the language service plugin to detect this at compile time: https://github.com/Effect-TS/language-service`,Or,r)}}return this[n._op](n)},this),n===Gn){const r=Yn.currentOp;return r._op===la||r._op===$i?Gn:(Yn.currentOp=null,r._op===Pt||r._op===Ot?r:Oe(tn(r)))}}catch(r){n!==Gn&&!te(n,"_op")||!(n._op in this)?n=aw(`Not a valid effect: ${yo(n)}`):JO(r)?n=Oe(At(tn(r),ln(Eo))):n=Tr(r)}}}run=()=>{this.drainQueueOnCurrentThread()}}const sM=be("effect/FiberRef/currentMinimumLogLevel",()=>Gt(qF("Info"))),oM=e=>Dp(t=>{const n=FF(t.context,Qa);e_(n,Hw).unsafe.log(e.log(t))}),iM=be(Symbol.for("effect/Logger/defaultLogger"),()=>oM(IN)),cM=be(Symbol.for("effect/Logger/tracerLogger"),()=>Dp(({annotations:e,cause:t,context:n,fiberId:r,logLevel:s,message:o})=>{const i=gc(Zi(n,Ur),Uw);if(i._tag==="None"||i.value._tag==="ExternalSpan")return;const c=t_(Zi(n,Qa),dl),a={};for(const[u,l]of e)a[u]=l;a["effect.fiberId"]=l1(r),a["effect.logLevel"]=s.label,t!==null&&t._tag!=="Empty"&&(a["effect.cause"]=Zo(t,{renderErrorCause:!0})),i.value.event(yo(Array.isArray(o)&&o.length===1?o[0]:o),c.unsafeCurrentTimeNanos(),a)})),aM=be(Symbol.for("effect/FiberRef/currentLoggers"),()=>NO(Zd(iM,cM))),uM=d(e=>yr(e[0]),(e,t)=>$s(tl(e,n=>lM(r=>t(n,r))))),lM=e=>Ee(t=>{const n=t.getFiberRefs(),r=ER(t.currentRuntimeFlags,Cs);return P(jv,s=>Ja(s,o=>Ee(i=>{const c=i.getFiberRefs(),a=i.currentRuntimeFlags,u=ec(c,n),l=os(a,r),f=ec(n,c);return i.setFiberRefs(tc(u,i.id(),n)),rc(TO(e(o),l),M(()=>{i.setFiberRefs(tc(f,i.id(),i.getFiberRefs()))}))})))}),fM=e=>{if(Array.isArray(e)||KS(e))return[e,K()];const t=Object.keys(e),n=t.length;return[t.map(r=>e[r]),U(r=>{const s={};for(let o=0;o<n;o++)s[t[o]]=r[o];return s})]},hM=(e,t,n)=>{const r=[];for(const s of e)r.push(Fo(s));return P(Lo(r,ee,{concurrency:n?.concurrency,batching:n?.batching,concurrentFinalizers:n?.concurrentFinalizers}),s=>{const o=K(),i=s.length,c=new Array(i),a=new Array(i);let u=!1;for(let l=0;l<i;l++){const f=s[l];f._tag==="Left"?(c[l]=U(f.left),u=!0):(a[l]=f.right,c[l]=o)}return u?t._tag==="Some"?rt(t.value(c)):rt(c):n?.discard?Ke:t._tag==="Some"?L(t.value(a)):L(a)})},dM=(e,t,n)=>{const r=[];for(const s of e)r.push(Fo(s));return n?.discard?Lo(r,ee,{concurrency:n?.concurrency,batching:n?.batching,discard:!0,concurrentFinalizers:n?.concurrentFinalizers}):ne(Lo(r,ee,{concurrency:n?.concurrency,batching:n?.batching,concurrentFinalizers:n?.concurrentFinalizers}),s=>t._tag==="Some"?t.value(s):s)},jp=(e,t)=>{const[n,r]=fM(e);return t?.mode==="validate"?hM(n,r,t):t?.mode==="either"?dM(n,r,t):t?.discard!==!0&&r._tag==="Some"?ne(Lo(n,ee,t),r.value):Lo(n,ee,t)},Lo=d(e=>KS(e[0]),(e,t,n)=>Ee(r=>{const s=n?.batching===!0||n?.batching==="inherit"&&r.getFiberRef(jO);return n?.discard?ey(n.concurrency,()=>Ms(tu,n?.concurrentFinalizers)(o=>s?Ln(e,(i,c)=>o(t(i,c)),!0,!1,1):Zu(e,(i,c)=>o(t(i,c)))),()=>Ms(Ch,n?.concurrentFinalizers)(o=>Ln(e,(i,c)=>o(t(i,c)),s,!1)),o=>Ms(Ih(o),n?.concurrentFinalizers)(i=>Ln(e,(c,a)=>i(t(c,a)),s,!1,o))):ey(n?.concurrency,()=>Ms(tu,n?.concurrentFinalizers)(o=>s?Hh(e,1,(i,c)=>o(t(i,c)),!0):sr(e,(i,c)=>o(t(i,c)))),()=>Ms(Ch,n?.concurrentFinalizers)(o=>zp(e,(i,c)=>o(t(i,c)),s)),o=>Ms(Ih(o),n?.concurrentFinalizers)(i=>Hh(e,o,(c,a)=>i(t(c,a)),s)))})),zp=(e,t,n)=>ae(()=>{const r=Ne(e),s=new Array(r.length);return mt(Ln(r,(i,c)=>P(t(i,c),a=>M(()=>s[c]=a)),n,!1),L(s))}),Ln=(e,t,n,r,s)=>kn(o=>wO(i=>Ee(c=>{let a=Array.from(e).reverse(),u=a.length;if(u===0)return Ke;let l=0,f=!1;const h=s?Math.min(a.length,s):a.length,m=new Set,y=new Array,b=()=>m.forEach(O=>{O.currentScheduler.scheduleTask(()=>{O.unsafeInterruptAsFork(c.id())},0)}),_=new Array,k=new Array,C=new Array,v=()=>{const O=y.filter(({exit:H})=>H._tag==="Failure").sort((H,F)=>H.index<F.index?-1:H.index===F.index?0:1).map(({exit:H})=>H);return O.length===0&&O.push(wn),O},T=(O,H=!1)=>{const F=$s(i(O)),E=pM(F,c,c.currentRuntimeFlags,gl);return c.currentScheduler.scheduleTask(()=>{H&&E.unsafeInterruptAsFork(c.id()),E.resume(F)},0),E},R=()=>{r||(u-=a.length,a=[]),f=!0,b()},w=n?SO:Mn,I=T(Kn(O=>{const H=(E,V)=>{E._op==="Blocked"?C.push(E):(y.push({index:V,exit:E}),E._op==="Failure"&&!f&&R())},F=()=>{if(a.length>0){const E=a.pop();let V=l++;const q=()=>{const ce=a.pop();return V=l++,P(rl(),()=>P(w(o(t(ce,V))),D))},D=ce=>a.length>0&&(H(ce,V),a.length>0)?q():L(ce),B=P(w(o(t(E,V))),D),x=T(B);_.push(x),m.add(x),f&&x.currentScheduler.scheduleTask(()=>{x.unsafeInterruptAsFork(c.id())},0),x.addObserver(ce=>{let je;if(ce._op==="Failure"?je=ce:je=ce.effect_instruction_i0,k.push(x),m.delete(x),H(je,V),y.length===u)O(L(qe(co(v(),{parallel:!0}),()=>wn)));else if(C.length+y.length===u){const Vt=v(),xs=C.map(br=>br.effect_instruction_i0).reduce(j_);O(L(tw(xs,Ln([qe(co(Vt,{parallel:!0}),()=>wn),...C.map(br=>br.effect_instruction_i1)],br=>br,n,!0,s))))}else F()})}};for(let E=0;E<h;E++)F()}));return on(xo(kc(o(nc(I))),cl({onFailure:O=>{R();const H=C.length+1,F=Math.min(typeof s=="number"?s:C.length,C.length),E=Array.from(C);return Kn(V=>{let q=0,D=0;const B=(ce,je)=>Vt=>{q++,q===H&&V(et(Oe(O))),E.length>0&&je&&x()},x=()=>{T(E.pop(),!0).addObserver(B(D,!0)),D++};I.addObserver(B(D,!1)),D++;for(let ce=0;ce<F;ce++)x()})},onSuccess:()=>sr(k,O=>O.inheritAll)})))}))),Hh=(e,t,n,r)=>ae(()=>{const s=Ne(e),o=new Array(s.length);return mt(Ln(s,(c,a)=>ne(n(c,a),u=>o[a]=u),r,!1,t),L(o))}),Vp=e=>mM(e,gl),Uv=(e,t,n,r=null)=>{const s=au(e,t,n,r);return s.resume(e),s},pM=(e,t,n,r=null)=>au(e,t,n,r),au=(e,t,n,r=null)=>{const s=C_(),o=t.getFiberRefs(),i=RF(o,s),c=new Dv(s,i,n),a=Zi(i,Ur),u=c.currentSupervisor;return u.onStart(a,e,U(t),c),c.addObserver(f=>u.onEnd(f,c)),(r!==null?r:p(t.getFiberRef(yh),qe(()=>t.scope()))).add(n,c),c},mM=(e,t)=>Ee((n,r)=>L(Uv(e,n,r.runtimeFlags,t))),cy=e=>As(t=>xe(gc(t,Rs),{onNone:()=>e,onSome:n=>{switch(n.strategy._tag){case"Parallel":return e;case"Sequential":case"ParallelN":return P(er(n,Ch),r=>xc(e,r))}}})),ay=e=>t=>As(n=>xe(gc(n,Rs),{onNone:()=>t,onSome:r=>r.strategy._tag==="ParallelN"&&r.strategy.parallelism===e?t:P(er(r,Ih(e)),s=>xc(t,s))})),Ms=(e,t)=>n=>As(r=>xe(gc(r,Rs),{onNone:()=>n(ee),onSome:s=>{if(t===!0){const o=e._tag==="Parallel"?cy:e._tag==="Sequential"?uy:ay(e.parallelism);switch(s.strategy._tag){case"Parallel":return o(n(cy));case"Sequential":return o(n(uy));case"ParallelN":return o(n(ay(s.strategy.parallelism)))}}else return n(ee)}})),gM=e=>P(Rs,e),Kv=e=>P(vl(),t=>xo(e(t),n=>t.close(n))),uy=e=>As(t=>xe(gc(t,Rs),{onNone:()=>e,onSome:n=>{switch(n.strategy._tag){case"Sequential":return e;case"Parallel":case"ParallelN":return P(er(n,tu),r=>xc(e,r))}}})),yM=d(e=>yr(e[1]),(e,t,n)=>Fc(e,t,(r,s)=>[r,s],n)),SM=d(e=>yr(e[1]),(e,t,n)=>n?.concurrent!==!0&&(n?.batching===void 0||n.batching===!1)?sl(e,t):Fc(e,t,(r,s)=>r,n)),bM=d(e=>yr(e[1]),(e,t,n)=>n?.concurrent!==!0&&(n?.batching===void 0||n.batching===!1)?mt(e,t):Fc(e,t,(r,s)=>s,n)),Fc=d(e=>yr(e[1]),(e,t,n,r)=>ne(jp([e,t],{concurrency:r?.concurrent?2:1,batching:r?.batching,concurrentFinalizers:r?.concurrentFinalizers}),([s,o])=>n(s,o))),Rs=ks("effect/Scope"),jv=Rs,_M=(e,t)=>{e.state._tag==="Open"&&e.state.finalizers.set({},t)},wM={[Ig]:Ig,[$g]:$g,pipe(){return G(this,arguments)},fork(e){return M(()=>{const t=zv(e);if(this.state._tag==="Closed")return t.state=this.state,t;const n={},r=s=>t.close(s);return this.state.finalizers.set(n,r),_M(t,s=>M(()=>{this.state._tag==="Open"&&this.state.finalizers.delete(n)})),t})},close(e){return ae(()=>{if(this.state._tag==="Closed")return Ke;const t=Array.from(this.state.finalizers.values()).reverse();return this.state={_tag:"Closed",exit:e},t.length===0?Ke:wx(this.strategy)?p(sr(t,n=>Mn(n(e))),P(n=>p(co(n),no(of),qe(()=>wn)))):vx(this.strategy)?p(zp(t,n=>Mn(n(e)),!1),P(n=>p(co(n,{parallel:!0}),no(of),qe(()=>wn)))):p(Hh(t,this.strategy.parallelism,n=>Mn(n(e)),!1),P(n=>p(co(n,{parallel:!0}),no(of),qe(()=>wn))))})},addFinalizer(e){return ae(()=>this.state._tag==="Closed"?e(this.state.exit):(this.state.finalizers.set({},e),Ke))}},zv=(e=$r)=>{const t=Object.create(wM);return t.strategy=e,t.state={_tag:"Open",finalizers:new Map},t},vl=(e=$r)=>M(()=>zv(e)),xc=d(2,(e,t)=>cP(e,Fu(U$(Rs,t)))),vM=e=>ei(e,{differ:JB,fork:xi}),ly=MO(IR),kM=vM(wl),Vv=d(3,(e,t,n)=>TM(e,t,{onSelfWin:(r,s)=>P(r.await,o=>{switch(o._tag){case Pt:return P(r.inheritAll,()=>n.onSelfDone(o,s));case Ot:return n.onSelfDone(o,s)}}),onOtherWin:(r,s)=>P(r.await,o=>{switch(o._tag){case Pt:return P(r.inheritAll,()=>n.onOtherDone(o,s));case Ot:return n.onOtherDone(o,s)}})})),qv=d(2,(e,t)=>vc(n=>Vv(e,t,{onSelfDone:(r,s)=>_h(r,{onFailure:o=>p(nc(s),Jg(i=>Fr(o,i))),onSuccess:o=>p(s,Qi(n),Jt(o))}),onOtherDone:(r,s)=>_h(r,{onFailure:o=>p(nc(s),Jg(i=>Fr(i,o))),onSuccess:o=>p(s,Qi(n),Jt(o))})}))),TM=d(3,(e,t,n)=>Ee((r,s)=>{const o=s.runtimeFlags,i=Ts(!0),c=au(e,r,o,n.selfScope),a=au(t,r,o,n.otherScope);return Kn(u=>{c.addObserver(()=>fy(c,a,n.onSelfWin,i,u)),a.addObserver(()=>fy(a,c,n.onOtherWin,i,u)),c.startFork(e),a.startFork(t)},a1(c.id(),a.id()))})),fy=(e,t,n,r,s)=>{t1(!0,!1)(r)&&s(n(e,t))},rc=d(2,(e,t)=>kn(n=>sn(n(e),{onFailure:r=>sn(t,{onFailure:s=>lt(At(r,s)),onSuccess:()=>lt(r)}),onSuccess:r=>Jt(t,r)}))),EM=(e,t,n)=>vc(r=>P(P(Vp(ap(e)),s=>Kn(o=>{const i=t.map(u=>u.listeners.count),c=()=>{i.every(u=>u===0)&&t.every(u=>u.result.state.current._tag==="Pending"?!0:!!(u.result.state.current._tag==="Done"&&il(u.result.state.current.effect)&&u.result.state.current.effect._tag==="Failure"&&G_(u.result.state.current.effect.cause)))&&(a.forEach(u=>u()),n?.(),o(hp(s)))};s.addObserver(u=>{a.forEach(l=>l()),o(u)});const a=t.map((u,l)=>{const f=h=>{i[l]=h,c()};return u.listeners.addObserver(f),()=>u.listeners.removeObserver(f)});return c(),M(()=>{a.forEach(u=>u())})})),()=>ae(()=>{const s=t.flatMap(o=>o.state.completed?[]:[o]);return Zu(s,o=>DB(o.request,Tw(r)))}))),CM=Pr,Dh=tn,IM=ln,$M=JR,AM=J_,Wv=G_,lf=Ju,RM=Y_,OM=Q_,PM=ZR,Jv=nO,FM=Zo,xM="effect/ScheduleInterval",uu=Symbol.for(xM),Gv={[uu]:uu,startMillis:0,endMillis:0},qp=(e,t)=>e>t?Gv:{[uu]:uu,startMillis:e,endMillis:t},NM=d(2,(e,t)=>BM(e,t)===e),BM=d(2,(e,t)=>e.endMillis<=t.startMillis?e:t.endMillis<=e.startMillis?t:e.startMillis<t.startMillis?e:t.startMillis<e.startMillis?t:e.endMillis<=t.endMillis?e:t),MM=e=>e.startMillis>=e.endMillis,LM=d(2,(e,t)=>{const n=Math.max(e.startMillis,t.startMillis),r=Math.min(e.endMillis,t.endMillis);return qp(n,r)}),HM=e=>ie(e.endMillis-e.startMillis),DM=e=>qp(e,Number.POSITIVE_INFINITY),hy=qp,Yv=Gv,UM=NM,KM=MM,jM=LM,zM=HM,VM=DM,qM="effect/ScheduleIntervals",dy=Symbol.for(qM),Qv=e=>({[dy]:dy,intervals:e}),WM=d(2,(e,t)=>JM(e.intervals,t.intervals,We())),JM=(e,t,n)=>{let r=e,s=t,o=n;for(;Un(r)&&Un(s);){const i=p(Fn(r),jM(Fn(s))),c=KM(i)?o:p(o,xt(i));p(Fn(r),UM(Fn(s)))?r=rr(r):s=rr(s),o=c}return Qv(dr(o))},Uh=e=>p(e.intervals,jd,qe(()=>Yv)).startMillis,GM=e=>p(e.intervals,jd,qe(()=>Yv)).endMillis,Xv=d(2,(e,t)=>Uh(e)<Uh(t)),YM=e=>Un(e.intervals),QM=d(2,(e,t)=>Xv(e,t)?t:e),XM=Qv,ZM=WM,Kh=Uh,jh=GM,e2=Xv,t2=YM,n2=QM,Wp="Continue",Zv="Done",r2=e=>({_tag:Wp,intervals:e}),s2=e=>({_tag:Wp,intervals:XM(Be(e))}),o2={_tag:Zv},i2=e=>e._tag===Wp,c2=e=>e._tag===Zv,ek=r2,tk=s2,_s=o2,py=i2,ws=c2,sc=_w,a2=Ja,zh=Sh,u2=xc,nk=er,l2=vl;class f2{permits;waiters=new Set;taken=0;constructor(t){this.permits=t}get free(){return this.permits-this.taken}take=t=>iw(n=>{if(this.free<t){const r=()=>{this.free<t||(this.waiters.delete(r),this.taken+=t,n(L(t)))};return this.waiters.add(r),M(()=>{this.waiters.delete(r)})}return this.taken+=t,n(L(t))});updateTakenUnsafe(t,n){return this.taken=n(this.taken),this.waiters.size>0&&t.getFiberRef(Np).scheduleTask(()=>{const r=this.waiters.values();let s=r.next();for(;s.done===!1&&this.free>0;)s.value(),s=r.next()},t.getFiberRef(Cc)),L(this.free)}updateTaken(t){return Ee(n=>this.updateTakenUnsafe(n,t))}resize=t=>on(Ee(n=>(this.permits=t,this.free<0?Ke:this.updateTakenUnsafe(n,r=>r))));release=t=>this.updateTaken(n=>n-t);releaseAll=this.updateTaken(t=>0);withPermits=t=>n=>kn(r=>P(r(this.take(t)),s=>rc(r(n),this.release(s))));withPermitsIfAvailable=t=>n=>kn(r=>ae(()=>this.free<t?dx:(this.taken+=t,rc(r(nx(n)),this.release(t)))))}const rk=e=>new f2(e),h2=e=>M(()=>rk(e)),d2=d(2,(e,t)=>Ee((n,r)=>{const s=t,o=Uv(e,n,r.runtimeFlags,gl);if(s.state._tag==="Open"){const i=()=>vc(a=>oe(a,o.id())?Ke:on(hp(o))),c={};s.state.finalizers.set(c,i),o.addObserver(()=>{s.state._tag!=="Closed"&&s.state.finalizers.delete(c)})}else o.unsafeInterruptAsFork(n.id());return L(o)})),p2=d(2,(e,t)=>p(Mn(e),qv(Mn(t)),n=>kc(n))),m2="effect/Ref/SynchronizedRef",sk=Symbol.for(m2),ok={_A:e=>e};class g2 extends ni{ref;withLock;[sk]=ok;[Tp]=Ep;[Bo]=Bo;constructor(t,n){super(),this.ref=t,this.withLock=n,this.get=pn(this.ref)}get;commit(){return this.get}modify(t){return this.modifyEffect(n=>L(t(n)))}modifyEffect(t){return this.withLock(p(P(pn(this.ref),t),P(([n,r])=>Jt(ao(this.ref,r),n))))}}const y2=e=>M(()=>ik(e)),ik=e=>{const t=Cp(e),n=rk(1);return new g2(t,n.withPermits(1))},S2=Symbol.for("effect/ManagedRuntime"),b2="Fresh",_2="MergeAll",ck=SN,my=bN,Fe=hp,w2=Qi,gy=nc,v2=_N,Nc=e=>function(){if(arguments.length===1){const t=arguments[0];return(n,...r)=>e(t,n,...r)}return e.apply(this,arguments)},Jp=Nc((e,t,n)=>{const r=C_(),s=[[Ur,[[r,e.context]]]];n?.scheduler&&s.push([Np,[[r,n.scheduler]]]);let o=xF(e.fiberRefs,{entries:s,forkAs:r});n?.updateRefs&&(o=n.updateRefs(o,r));const i=new Dv(r,o,e.runtimeFlags);let c=t;n?.scope&&(c=P(nk(n.scope,$r),u=>mt(_w(u,vc(l=>oe(l,i.id())?Ke:Qi(i,l))),xo(t,l=>zh(u,l)))));const a=i.currentSupervisor;return a!==wl&&(a.onStart(e.context,c,K(),i),i.addObserver(u=>a.onEnd(u,i))),gl.add(e.runtimeFlags,i),n?.immediate===!1?i.resume(c):i.start(c),i}),k2=Nc((e,t)=>{const n=I2(e)(t);if(n._tag==="Failure")throw ak(n.effect_instruction_i0);return n.effect_instruction_i0});class T2 extends Error{fiber;_tag="AsyncFiberException";constructor(t){super(`Fiber #${t.id().id} cannot be resolved synchronously. This is caused by using runSync on an effect that performs async work`),this.fiber=t,this.name=this._tag,this.stack=this.message}}const E2=e=>{const t=Error.stackTraceLimit;Error.stackTraceLimit=0;const n=new T2(e);return Error.stackTraceLimit=t,n},ff=Symbol.for("effect/Runtime/FiberFailure"),Yc=Symbol.for("effect/Runtime/FiberFailure/Cause");class C2 extends Error{[ff];[Yc];constructor(t){const n=Z_(t)[0];super(n?.message||"An error has occurred"),this[ff]=ff,this[Yc]=t,this.name=n?`(FiberFailure) ${n.name}`:"FiberFailure",n?.stack&&(this.stack=n.stack)}toJSON(){return{_id:"FiberFailure",cause:this[Yc].toJSON()}}toString(){return"(FiberFailure) "+Zo(this[Yc],{renderErrorCause:!0})}[Me](){return this.toString()}}const ak=e=>{const t=Error.stackTraceLimit;Error.stackTraceLimit=0;const n=new C2(e);return Error.stackTraceLimit=t,n},uk=e=>{const t=e;switch(t._op){case"Failure":case"Success":return t;case"Left":return bh(t.left);case"Right":return et(t.right);case"Some":return et(t.value);case"None":return bh(new mp)}},I2=Nc((e,t)=>{const n=uk(t);if(n)return n;const r=new Sv,s=Jp(e)(t,{scheduler:r});r.flush();const o=s.unsafePoll();return o||kw(cp(E2(s),bp(s)))}),$2=Nc((e,t,n)=>A2(e,t,n).then(r=>{switch(r._tag){case Pt:return r.effect_instruction_i0;case Ot:throw ak(r.effect_instruction_i0)}})),A2=Nc((e,t,n)=>new Promise(r=>{const s=uk(t);s&&r(s);const o=Jp(e)(t);o.addObserver(i=>{r(i)}),n?.signal!==void 0&&(n.signal.aborted?o.unsafeInterruptAsFork(o.id()):n.signal.addEventListener("abort",()=>{o.unsafeInterruptAsFork(o.id())},{once:!0}))}));class lk{context;runtimeFlags;fiberRefs;constructor(t,n,r){this.context=t,this.runtimeFlags=n,this.fiberRefs=r}pipe(){return G(this,arguments)}}const R2=e=>new lk(e.context,e.runtimeFlags,e.fiberRefs),O2=()=>Ee((e,t)=>L(new lk(e.getFiberRef(Ur),t.runtimeFlags,e.getFiberRefs()))),P2=U_(Cs,H_,L_),oc=R2({context:Ud(),runtimeFlags:P2,fiberRefs:NF()}),F2=Jp(oc),x2=$2(oc),N2=k2(oc),B2=d(2,(e,t)=>e.modifyEffect(t)),M2="effect/Layer",fk=Symbol.for(M2),L2={_RIn:e=>e,_E:e=>e,_ROut:e=>e},H2={[fk]:L2,pipe(){return G(this,arguments)}},D2="effect/Layer/MemoMap",hf=Symbol.for(D2),U2=xu()("effect/Layer/CurrentMemoMap",{defaultValue:()=>V2()}),K2=e=>te(e,fk),j2=e=>e._op_layer===b2;class hk{ref;[hf];constructor(t){this.ref=t,this[hf]=hf}getOrElseMemoize(t,n){return p(B2(this.ref,r=>{const s=r.get(t);if(s!==void 0){const[o,i]=s,c=p(o,P(([a,u])=>p(ux(a),Jt(u))),xo(cl({onFailure:()=>Ke,onSuccess:()=>Ja(n,i)})));return L([c,r])}return p(Xa(0),P(o=>p($c(),P(i=>p(Xa(()=>Ke),ne(c=>{const a=kn(l=>p(vl(),P(f=>p(l(P(pk(t,f,!0),h=>sx(h(this)))),Mn,P(h=>{switch(h._tag){case Ot:return p(Ew(i,h.effect_instruction_i0),mt(Sh(f,h)),mt(lt(h.effect_instruction_i0)));case Pt:return p(ao(c,m=>p(Sh(f,m),nl(qw(o,y=>[y===1,y-1])),on)),mt(Za(o,m=>m+1)),mt(Ja(n,m=>p(M(()=>r.delete(t)),mt(pn(c)),P(y=>y(m))))),mt(Ac(i,h.effect_instruction_i0)),Jt(h.effect_instruction_i0[1]))}}))))),u=[p(zn(i),xo(_h({onFailure:()=>Ke,onSuccess:()=>Za(o,l=>l+1)}))),l=>p(pn(c),P(f=>f(l)))];return[a,j2(t)?r:r.set(t,u)]}))))))}),kc)}}const z2=ae(()=>ne(y2(new Map),e=>new hk(e))),V2=()=>new hk(ik(new Map)),dk=d(2,(e,t)=>P(z2,n=>q2(e,n,t))),q2=d(3,(e,t,n)=>P(pk(e,n),r=>fx(r(t),U2,t))),pk=(e,t,n=!1)=>{const r=e;switch(r._op_layer){case"Locally":return M(()=>s=>r.f(s.getOrElseMemoize(r.self,t)));case"ExtendScope":return M(()=>s=>gM(o=>s.getOrElseMemoize(r.layer,o)));case"Fold":return M(()=>s=>p(s.getOrElseMemoize(r.layer,t),sn({onFailure:o=>s.getOrElseMemoize(r.failureK(o),t),onSuccess:o=>s.getOrElseMemoize(r.successK(o),t)})));case"Fresh":return M(()=>s=>p(r.layer,dk(t)));case"FromEffect":return M(n?()=>s=>r.effect:()=>s=>s.getOrElseMemoize(e,t));case"Provide":return M(()=>s=>p(s.getOrElseMemoize(r.first,t),P(o=>p(s.getOrElseMemoize(r.second,t),ll(o)))));case"Scoped":return M(n?()=>s=>xc(r.effect,t):()=>s=>s.getOrElseMemoize(e,t));case"Suspend":return M(()=>s=>s.getOrElseMemoize(r.evaluate(),t));case"ProvideMerge":return M(()=>s=>p(s.getOrElseMemoize(r.first,t),pw(s.getOrElseMemoize(r.second,t),r.zipK)));case"ZipWith":return hw(function*(){const s=yield*er(t,Eh),o=yield*er(s,$r),i=yield*er(s,$r);return c=>p(c.getOrElseMemoize(r.first,o),Fc(c.getOrElseMemoize(r.second,i),r.zipK,{concurrent:!0}))});case"MergeAll":{const s=r.layers;return ne(er(t,Eh),o=>i=>{const c=new Array(s.length);return ne(Ln(s,kO(function*(a,u){const l=yield*er(o,$r),f=yield*i.getOrElseMemoize(a,l);c[u]=f}),!1,!1),()=>K$(...c))})}}},W2=(...e)=>{const t=Object.create(H2);return t._op_layer=_2,t.layers=e,t},yy=d(2,(e,t)=>Kv(n=>P(dk(t,n),r=>Sp(e,r)))),Sy=d(2,(e,t)=>{const n=ec(oc.fiberRefs,t.fiberRefs),r=os(oc.runtimeFlags,t.runtimeFlags);return kn(s=>Ee(o=>{const i=o.getFiberRef(Ur),c=o.getFiberRefs(),a=tc(o.id(),c)(n),u=o.currentRuntimeFlags,l=io(r)(u),f=ec(a,c),h=os(l,u);return o.setFiberRefs(a),o.currentRuntimeFlags=l,rc(Sp(s(e),Fu(i,t.context)),Ee(m=>(m.setFiberRefs(tc(m.id(),m.getFiberRefs())(f)),m.currentRuntimeFlags=io(h)(m.currentRuntimeFlags),Ke)))}))}),J2=d(2,(e,t)=>Array.isArray(t)?yy(e,W2(...t)):K2(t)?yy(e,t):D$(t)?Sp(e,t):S2 in t?P(t.runtimeEffect,n=>Sy(e,n)):Sy(e,t)),G2=Vu,Y2=(function(){const e=Symbol.for("effect/Data/Error/plainArgs");return{BaseEffectError:class extends pp{constructor(n){super(n?.message,n?.cause?{cause:n.cause}:void 0),n&&(Object.assign(this,n),Object.defineProperty(this,e,{value:n,enumerable:!1}))}toJSON(){return{...this[e],...this}}}}.BaseEffectError})(),Q2=e=>{const t={BaseEffectError:class extends Y2{_tag=e}};return t.BaseEffectError.prototype.name=e,t.BaseEffectError},X2="effect/Schedule",mk=Symbol.for(X2),gk=e=>te(e,mk),Z2="effect/ScheduleDriver",eL=Symbol.for(Z2),Vh={start:0,now:0,input:void 0,output:void 0,elapsed:wo,elapsedSincePrevious:wo,recurrence:0},lu=xu()("effect/Schedule/CurrentIterationMetadata",{defaultValue:()=>Vh}),tL={_Out:e=>e,_In:e=>e,_R:e=>e},nL={_Out:e=>e,_In:e=>e,_R:e=>e};class rL{initial;step;[mk]=tL;constructor(t,n){this.initial=t,this.step=n}pipe(){return G(this,arguments)}}const by=(e,t,n,r)=>Za(e,s=>s.recurrence===0?{now:t,input:n,output:r,recurrence:s.recurrence+1,elapsed:wo,elapsedSincePrevious:wo,start:t}:{now:t,input:n,output:r,recurrence:s.recurrence+1,elapsed:ie(t-s.start),elapsedSincePrevious:ie(t-s.now),start:s.start});class sL{schedule;ref;[eL]=nL;constructor(t,n){this.schedule=t,this.ref=n}get state(){return ne(pn(this.ref),t=>t[1])}get last(){return P(pn(this.ref),([t,n])=>{switch(t._tag){case"None":return Qu(()=>new mp);case"Some":return L(t.value)}})}iterationMeta=Cp(Vh);get reset(){return ao(this.ref,[K(),this.schedule.initial]).pipe(sl(ao(this.iterationMeta,Vh)))}next(t){return p(ne(pn(this.ref),n=>n[1]),P(n=>p(EF,P(r=>p(ae(()=>this.schedule.step(r,t,n)),P(([s,o,i])=>{const c=ao(this.ref,[U(o),s]);if(ws(i))return c.pipe(mt(rt(K())));const a=Kh(i.intervals)-r;if(a<=0)return c.pipe(mt(by(this.iterationMeta,r,t,o)),Jt(o));const u=ie(a);return p(c,mt(by(this.iterationMeta,r,t,o)),mt(sv(u)),Jt(o))}))))))}}const Os=(e,t)=>new rL(e,t),yk=d(2,(e,t)=>oL(e,n=>M(()=>t(n)))),oL=d(2,(e,t)=>fL(e,(n,r)=>ne(t(n),s=>dA(r,qt(s))))),Sk=d(2,(e,t)=>Gp(e,(n,r)=>M(()=>t(n,r)))),Gp=d(2,(e,t)=>Os(e.initial,(n,r,s)=>P(e.step(n,r,s),([o,i,c])=>ws(c)?L([o,i,_s]):ne(t(r,i),a=>a?[o,i,c]:[o,i,_s])))),iL=d(2,(e,t)=>Os([e.initial,t.initial],(n,r,s)=>P(e.step(n,r,s[0]),([o,i,c])=>ne(t.step(n,i,s[1]),([a,u,l])=>ws(c)?[[o,a],u,_s]:ws(l)?[[o,a],u,_s]:[[o,a],u,ek(p(c.intervals,n2(l.intervals)))])))),cL=e=>yk(e,t=>t),Yp=e=>p(Xa([K(),e.initial]),ne(t=>new sL(e,t))),aL=(e,t=2)=>{const n=qt(e);return cL(_k(Bc,r=>hA(n,Math.pow(t,r))))},bk=d(2,(e,t)=>uL(e,t,ZM)),uL=d(3,(e,t,n)=>Os([e.initial,t.initial],(r,s,o)=>p(pw(e.step(r,s,o[0]),t.step(r,s,o[1]),(i,c)=>[i,c]),P(([[i,c,a],[u,l,f]])=>py(a)&&py(f)?qh(e,t,s,i,c,a.intervals,u,l,f.intervals,n):L([[i,u],[c,l],_s]))))),qh=(e,t,n,r,s,o,i,c,a,u)=>{const l=u(o,a);return t2(l)?L([[r,i],[s,c],ek(l)]):p(o,e2(a))?P(e.step(jh(o),n,r),([f,h,m])=>ws(m)?L([[f,i],[h,c],_s]):qh(e,t,n,f,h,m.intervals,i,c,a,u)):P(t.step(jh(a),n,i),([f,h,m])=>ws(m)?L([[r,f],[s,h],_s]):qh(e,t,n,r,s,o,f,h,m.intervals,u))},_k=d(2,(e,t)=>lL(e,n=>M(()=>t(n)))),lL=d(2,(e,t)=>Os(e.initial,(n,r,s)=>P(e.step(n,r,s),([o,i,c])=>ne(t(i),a=>[o,a,c])))),fL=d(2,(e,t)=>Os(e.initial,(n,r,s)=>P(e.step(n,r,s),([o,i,c])=>{if(ws(c))return L([o,i,c]);const a=c.intervals,u=zM(hy(n,Kh(a)));return ne(t(i,u),l=>{const f=qt(l),h=Kh(a),m=n+zi(f),y=m-h,b=Math.max(0,jh(a)+y),_=hy(m,b);return[o,i,tk(_)]})}))),hL=e=>Os(e.initial,(t,n,r)=>p(e.step(t,n,r),ne(([s,o,i])=>[s,n,i]))),Qp=e=>gL(Bc,t=>t<e),dL=e=>yk(Bc,()=>e),pL=(e,t)=>Os(e,(n,r,s)=>M(()=>[t(s),s,tk(VM(n))])),wk=d(2,(e,t)=>Gp(e,(n,r)=>ax(t(n)))),mL=d(2,(e,t)=>Sk(e,(n,r)=>t(n))),vk=d(2,(e,t)=>Gp(e,(n,r)=>t(n))),gL=d(2,(e,t)=>Sk(e,(n,r)=>t(r))),ba=Symbol.for("effect/Schedule/ScheduleDefect");class yL{error;[ba];constructor(t){this.error=t,this[ba]=ba}}const SL=e=>te(e,ba),fu=e=>Po(e,t=>Tr(new yL(t))),bL=e=>xe(op(e,t=>J_(t)&&SL(t.defect)?U(t.defect):K()),{onNone:()=>e,onSome:t=>Pr(t.error)}),kk=e=>cw(e,t=>lt(bL(t))),_y=d(2,(e,t)=>wL(e,t,(n,r)=>rt(n))),_L=d(2,(e,t)=>{if(gk(t))return _y(e,t);const n=t.schedule??hL(Bc),r=t.while?vk(n,i=>{const c=t.while(i);return typeof c=="boolean"?L(c):fu(c)}):n,s=t.until?wk(r,i=>{const c=t.until(i);return typeof c=="boolean"?L(c):fu(c)}):r,o=t.times?bk(s,Qp(t.times)).pipe(_k(i=>i[0])):s;return kk(_y(e,o))}),wL=d(3,(e,t,n)=>P(Yp(t),r=>jn(e,{onFailure:s=>n(s,K()),onSuccess:s=>Tk(eu(e,lu,pn(r.iterationMeta)),r,(o,i)=>eu(n(o,i),lu,pn(r.iterationMeta)),s)}))),Tk=(e,t,n,r)=>jn(t.next(r),{onFailure:()=>lp(t.last),onSuccess:s=>jn(e,{onFailure:o=>n(o,U(s)),onSuccess:o=>Tk(e,t,n,o)})}),wy=d(2,(e,t)=>TL(e,t,(n,r)=>rt(n))),vL=d(2,(e,t)=>gk(t)?wy(e,t):kk(wy(e,kL(t)))),kL=e=>{const t=e.schedule??Bc,n=e.while?vk(t,s=>{const o=e.while(s);return typeof o=="boolean"?L(o):fu(o)}):t,r=e.until?wk(n,s=>{const o=e.until(s);return typeof o=="boolean"?L(o):fu(o)}):n;return e.times!==void 0?bk(r,Qp(e.times)):r},TL=d(3,(e,t,n)=>P(Yp(t),r=>Ek(eu(e,lu,pn(r.iterationMeta)),r,(s,o)=>eu(n(s,o),lu,pn(r.iterationMeta))))),Ek=(e,t,n)=>Po(e,r=>jn(t.next(r),{onFailure:()=>p(t.last,lp,P(s=>n(r,s))),onSuccess:()=>Ek(e,t,n)})),Bc=pL(0,e=>e+1),ri=yr,ze=jp,vn=Lo,EL=hx,vy=Ee,Ct=rt,lr=lt,CL=aw,$=hw,W=lx,z=L,tt=ae,Qe=M,me=Ke,Ve=Po,Nr=cw,df=rx,IL=cx,Qc=vL,Ps=gx,Ls=Tt,Zt=ap,_i=$s,Xp=kn,cs=Jt,Ae=on,j=ne,$L=up,kl=el,AL=sw,Qs=rc,RL=jv,Wh=Kv,OL=vc,ot=Vp,Hn=d2,PL=sv,Jh=J2,Hs=Fo,yt=Mn,Ck=bO,FL=Sx,X=P,Gr=kc,pf=qv,xL=p2,Ik=Vv,Ie=tl,Zp=mx,NL=ox,ky=_L,$k=rv,hu=lw,On=sn,BL=jn,ML=lp,LL=O2,em=h2,Zr=F2,Q=x2,HL=N2,Gh=yM,Tl=SM,Ce=bM,El=Fc,DL="effect/QueueEnqueue",Ak=Symbol.for(DL),UL="effect/QueueDequeue",tm=Symbol.for(UL),KL="effect/QueueStrategy",Rk=Symbol.for(KL),jL="effect/BackingQueue",zL=Symbol.for(jL),Ok={_A:e=>e},VL={_A:e=>e},Pk={_In:e=>e},nm={_Out:e=>e};class qL extends ni{queue;takers;shutdownHook;shutdownFlag;strategy;[Ak]=Pk;[tm]=nm;constructor(t,n,r,s,o){super(),this.queue=t,this.takers=n,this.shutdownHook=r,this.shutdownFlag=s,this.strategy=o}pipe(){return G(this,arguments)}commit(){return this.take}capacity(){return this.queue.capacity()}get size(){return ae(()=>Po(this.unsafeSize(),()=>Tt))}unsafeSize(){return _e(this.shutdownFlag)?K():U(this.queue.length()-vp(this.takers)+this.strategy.surplusSize())}get isEmpty(){return ne(this.size,t=>t<=0)}get isFull(){return ne(this.size,t=>t>=this.capacity())}get shutdown(){return $s(Ee(t=>(p(this.shutdownFlag,Es(!0)),p(Ln(lo(this.takers),n=>yp(n,t.id()),!1,!1),mt(this.strategy.shutdown),nl(Ac(this.shutdownHook,void 0)),on))))}get isShutdown(){return M(()=>_e(this.shutdownFlag))}get awaitShutdown(){return zn(this.shutdownHook)}isActive(){return!_e(this.shutdownFlag)}unsafeOffer(t){if(_e(this.shutdownFlag))return!1;let n;if(this.queue.length()===0){const s=p(this.takers,ur(st));s!==st?(as(s,t),n=!0):n=!1}else n=!1;if(n)return!0;const r=this.queue.offer(t);return Xs(this.strategy,this.queue,this.takers),r}offer(t){return ae(()=>{if(_e(this.shutdownFlag))return Tt;let n;if(this.queue.length()===0){const s=p(this.takers,ur(st));s!==st?(as(s,t),n=!0):n=!1}else n=!1;if(n)return L(!0);const r=this.queue.offer(t);return Xs(this.strategy,this.queue,this.takers),r?L(!0):this.strategy.handleSurplus([t],this.queue,this.takers,this.shutdownFlag)})}offerAll(t){return ae(()=>{if(_e(this.shutdownFlag))return Tt;const n=Ne(t),r=this.queue.length()===0?Ne(cH(this.takers,n.length)):fs,[s,o]=p(n,db(r.length));for(let c=0;c<r.length;c++){const a=r[c],u=s[c];as(a,u)}if(o.length===0)return L(!0);const i=this.queue.offerAll(o);return Xs(this.strategy,this.queue,this.takers),Bu(i)?L(!0):this.strategy.handleSurplus(i,this.queue,this.takers,this.shutdownFlag)})}get take(){return Ee(t=>{if(_e(this.shutdownFlag))return Tt;const n=this.queue.poll(st);if(n!==st)return this.strategy.unsafeOnQueueEmptySpace(this.queue,this.takers),L(n);{const r=Ic(t.id());return p(ae(()=>(p(this.takers,No(r)),Xs(this.strategy,this.queue,this.takers),_e(this.shutdownFlag)?Tt:zn(r))),Tc(()=>M(()=>aH(this.takers,r))))}})}get takeAll(){return ae(()=>_e(this.shutdownFlag)?Tt:M(()=>{const t=this.queue.pollUpTo(Number.POSITIVE_INFINITY);return this.strategy.unsafeOnQueueEmptySpace(this.queue,this.takers),Ki(t)}))}takeUpTo(t){return ae(()=>_e(this.shutdownFlag)?Tt:M(()=>{const n=this.queue.pollUpTo(t);return this.strategy.unsafeOnQueueEmptySpace(this.queue,this.takers),Ki(n)}))}takeBetween(t,n){return ae(()=>Fk(this,t,n,We()))}}const Fk=(e,t,n,r)=>n<t?L(r):p(tH(e,n),P(s=>{const o=t-s.length;return o===1?p(Yh(e),ne(i=>p(r,St(s),_o(i)))):o>1?p(Yh(e),P(i=>Fk(e,o-1,n-s.length-1,p(r,St(s),_o(i))))):L(p(r,St(s)))})),WL=e=>p(M(()=>TP(e)),P(t=>xk(Nk(t),rH()))),JL=()=>p(M(()=>fl()),P(e=>xk(Nk(e),sH()))),GL=(e,t,n,r,s)=>new qL(e,t,n,r,s),xk=(e,t)=>p($c(),ne(n=>GL(e,fl(),n,Ts(!1),t)));class YL{mutable;[zL]=VL;constructor(t){this.mutable=t}poll(t){return ur(this.mutable,t)}pollUpTo(t){return hl(this.mutable,t)}offerAll(t){return kp(this.mutable,t)}offer(t){return No(this.mutable,t)}capacity(){return EP(this.mutable)}length(){return vp(this.mutable)}}const Nk=e=>new YL(e),QL=e=>e.size,XL=e=>e.isShutdown,ZL=e=>e.shutdown,eH=d(2,(e,t)=>e.offer(t)),Yh=e=>e.take,tH=d(2,(e,t)=>e.takeUpTo(t)),nH=d(3,(e,t,n)=>e.takeBetween(t,n)),rH=()=>new oH,sH=()=>new iH;class oH{[Rk]=Ok;putters=fl();surplusSize(){return vp(this.putters)}onCompleteTakersWithEmptyQueue(t){for(;!is(this.putters)&&!is(t);){const n=ur(t,void 0),r=ur(this.putters,void 0);r[2]&&as(r[1],!0),as(n,r[0])}}get shutdown(){return p(Xu,P(t=>p(M(()=>lo(this.putters)),P(n=>Ln(n,([r,s,o])=>o?p(yp(s,t),on):Ke,!1,!1)))))}handleSurplus(t,n,r,s){return Ee(o=>{const i=Ic(o.id());return p(ae(()=>(this.unsafeOffer(t,i),this.unsafeOnQueueEmptySpace(n,r),Xs(this,n,r),_e(s)?Tt:zn(i))),Tc(()=>M(()=>this.unsafeRemove(i))))})}unsafeOnQueueEmptySpace(t,n){let r=!0;for(;r&&(t.capacity()===Number.POSITIVE_INFINITY||t.length()<t.capacity());){const s=p(this.putters,ur(st));if(s===st)r=!1;else{const o=t.offer(s[0]);o&&s[2]?as(s[1],!0):o||du(this.putters,p(lo(this.putters),xt(s))),Xs(this,t,n)}}}unsafeOffer(t,n){const r=Ne(t);for(let s=0;s<r.length;s++){const o=r[s];s===r.length-1?p(this.putters,No([o,n,!0])):p(this.putters,No([o,n,!1]))}}unsafeRemove(t){du(this.putters,p(lo(this.putters),Nu(([,n])=>n!==t)))}}let iH=class{[Rk]=Ok;surplusSize(){return 0}get shutdown(){return Ke}onCompleteTakersWithEmptyQueue(){}handleSurplus(t,n,r,s){return L(!1)}unsafeOnQueueEmptySpace(t,n){}};const as=(e,t)=>ul(e,L(t)),du=(e,t)=>p(e,kp(t)),lo=e=>p(e,hl(Number.POSITIVE_INFINITY)),cH=(e,t)=>p(e,hl(t)),aH=(e,t)=>{du(e,p(lo(e),Nu(n=>t!==n)))},Xs=(e,t,n)=>{let r=!0;for(;r&&t.length()!==0;){const s=p(n,ur(st));if(s!==st){const o=t.poll(st);o!==st?(as(s,o),e.unsafeOnQueueEmptySpace(t,n)):du(n,p(lo(n),xt(s))),r=!0}else r=!1}r&&t.length()===0&&!is(n)&&e.onCompleteTakersWithEmptyQueue(n)},Rn=Symbol.for("effect/PubSub/AbsentValue"),Bk=(e,t)=>n=>{n.has(e)||n.set(e,new Set),n.get(e).add(t)},uH=(e,t)=>n=>{if(!n.has(e))return;const r=n.get(e);r.delete(t),r.size===0&&n.delete(e)},lH=e=>ae(()=>{const t=pH(e);return wH(t,new $H)}),fH=e=>e.shutdown,hH=d(2,(e,t)=>e.publish(t)),dH=e=>e.subscribe,pH=e=>new yH(e?.replay?new OH(e.replay):void 0),mH=(e,t,n)=>ne($c(),r=>gH(e,t,e.subscribe(),fl(),r,Ts(!1),n)),gH=(e,t,n,r,s,o,i)=>new bH(e,t,n,r,s,o,i,e.replayWindow());class yH{replayBuffer;publisherHead={value:Rn,subscribers:0,next:null};publisherTail=this.publisherHead;publisherIndex=0;subscribersIndex=0;capacity=Number.MAX_SAFE_INTEGER;constructor(t){this.replayBuffer=t}replayWindow(){return this.replayBuffer?new PH(this.replayBuffer):FH}isEmpty(){return this.publisherHead===this.publisherTail}isFull(){return!1}size(){return this.publisherIndex-this.subscribersIndex}publish(t){const n=this.publisherTail.subscribers;return n!==0&&(this.publisherTail.next={value:t,subscribers:n,next:null},this.publisherTail=this.publisherTail.next,this.publisherIndex+=1),this.replayBuffer&&this.replayBuffer.offer(t),!0}publishAll(t){if(this.publisherTail.subscribers!==0)for(const n of t)this.publish(n);else this.replayBuffer&&this.replayBuffer.offerAll(t);return We()}slide(){this.publisherHead!==this.publisherTail&&(this.publisherHead=this.publisherHead.next,this.publisherHead.value=Rn,this.subscribersIndex+=1),this.replayBuffer&&this.replayBuffer.slide()}subscribe(){return this.publisherTail.subscribers+=1,new SH(this,this.publisherTail,this.publisherIndex,!1)}}class SH{self;subscriberHead;subscriberIndex;unsubscribed;constructor(t,n,r,s){this.self=t,this.subscriberHead=n,this.subscriberIndex=r,this.unsubscribed=s}isEmpty(){if(this.unsubscribed)return!0;let t=!0,n=!0;for(;n;)this.subscriberHead===this.self.publisherTail?n=!1:this.subscriberHead.next.value!==Rn?(t=!1,n=!1):(this.subscriberHead=this.subscriberHead.next,this.subscriberIndex+=1);return t}size(){return this.unsubscribed?0:this.self.publisherIndex-Math.max(this.subscriberIndex,this.self.subscribersIndex)}poll(t){if(this.unsubscribed)return t;let n=!0,r=t;for(;n;)if(this.subscriberHead===this.self.publisherTail)n=!1;else{const s=this.subscriberHead.next.value;s!==Rn&&(r=s,this.subscriberHead.subscribers-=1,this.subscriberHead.subscribers===0&&(this.self.publisherHead=this.self.publisherHead.next,this.self.publisherHead.value=Rn,this.self.subscribersIndex+=1),n=!1),this.subscriberHead=this.subscriberHead.next,this.subscriberIndex+=1}return r}pollUpTo(t){const n=[],r=Rn;let s=0;for(;s!==t;){const o=this.poll(r);o===r?s=t:(n.push(o),s+=1)}return Ki(n)}unsubscribe(){if(!this.unsubscribed)for(this.unsubscribed=!0,this.self.publisherTail.subscribers-=1;this.subscriberHead!==this.self.publisherTail;)this.subscriberHead.next.value!==Rn&&(this.subscriberHead.subscribers-=1,this.subscriberHead.subscribers===0&&(this.self.publisherHead=this.self.publisherHead.next,this.self.publisherHead.value=Rn,this.self.subscribersIndex+=1)),this.subscriberHead=this.subscriberHead.next}}class bH extends ni{pubsub;subscribers;subscription;pollers;shutdownHook;shutdownFlag;strategy;replayWindow;[tm]=nm;constructor(t,n,r,s,o,i,c,a){super(),this.pubsub=t,this.subscribers=n,this.subscription=r,this.pollers=s,this.shutdownHook=o,this.shutdownFlag=i,this.strategy=c,this.replayWindow=a}commit(){return this.take}pipe(){return G(this,arguments)}capacity(){return this.pubsub.capacity}isActive(){return!_e(this.shutdownFlag)}get size(){return ae(()=>_e(this.shutdownFlag)?Tt:L(this.subscription.size()+this.replayWindow.remaining))}unsafeSize(){return _e(this.shutdownFlag)?K():U(this.subscription.size()+this.replayWindow.remaining)}get isFull(){return ae(()=>_e(this.shutdownFlag)?Tt:L(this.subscription.size()===this.capacity()))}get isEmpty(){return ne(this.size,t=>t===0)}get shutdown(){return $s(Ee(t=>(Es(this.shutdownFlag,!0),p(zp(rm(this.pollers),n=>yp(n,t.id()),!1),mt(M(()=>{this.subscribers.delete(this.subscription),this.subscription.unsubscribe(),this.strategy.unsafeOnPubSubEmptySpace(this.pubsub,this.subscribers)})),nl(Ac(this.shutdownHook,void 0)),on))))}get isShutdown(){return M(()=>_e(this.shutdownFlag))}get awaitShutdown(){return zn(this.shutdownHook)}get take(){return Ee(t=>{if(_e(this.shutdownFlag))return Tt;if(this.replayWindow.remaining>0){const r=this.replayWindow.take();return L(r)}const n=is(this.pollers)?this.subscription.poll(st):st;if(n===st){const r=Ic(t.id());return p(ae(()=>(p(this.pollers,No(r)),p(this.subscribers,Bk(this.subscription,this.pollers)),this.strategy.unsafeCompletePollers(this.pubsub,this.subscribers,this.subscription,this.pollers),_e(this.shutdownFlag)?Tt:zn(r))),Tc(()=>M(()=>IH(this.pollers,r))))}else return this.strategy.unsafeOnPubSubEmptySpace(this.pubsub,this.subscribers),L(n)})}get takeAll(){return ae(()=>{if(_e(this.shutdownFlag))return Tt;const t=is(this.pollers)?TH(this.subscription):We();return this.strategy.unsafeOnPubSubEmptySpace(this.pubsub,this.subscribers),this.replayWindow.remaining>0?L(St(this.replayWindow.takeAll(),t)):L(t)})}takeUpTo(t){return ae(()=>{if(_e(this.shutdownFlag))return Tt;let n;if(this.replayWindow.remaining>=t){const s=this.replayWindow.takeN(t);return L(s)}else this.replayWindow.remaining>0&&(n=this.replayWindow.takeAll(),t=t-n.length);const r=is(this.pollers)?EH(this.subscription,t):We();return this.strategy.unsafeOnPubSubEmptySpace(this.pubsub,this.subscribers),L(n?St(n,r):r)})}takeBetween(t,n){return ae(()=>Mk(this,t,n,We()))}}const Mk=(e,t,n,r)=>n<t?L(r):p(e.takeUpTo(n),P(s=>{const o=t-s.length;return o===1?p(e.take,ne(i=>p(r,St(s),_o(i)))):o>1?p(e.take,P(i=>Mk(e,o-1,n-s.length-1,p(r,St(s),_o(i))))):L(p(r,St(s)))}));class _H{pubsub;subscribers;scope;shutdownHook;shutdownFlag;strategy;[Ak]=Pk;[tm]=nm;constructor(t,n,r,s,o,i){this.pubsub=t,this.subscribers=n,this.scope=r,this.shutdownHook=s,this.shutdownFlag=o,this.strategy=i}capacity(){return this.pubsub.capacity}get size(){return ae(()=>_e(this.shutdownFlag)?Tt:M(()=>this.pubsub.size()))}unsafeSize(){return _e(this.shutdownFlag)?K():U(this.pubsub.size())}get isFull(){return ne(this.size,t=>t===this.capacity())}get isEmpty(){return ne(this.size,t=>t===0)}get awaitShutdown(){return zn(this.shutdownHook)}get isShutdown(){return M(()=>_e(this.shutdownFlag))}get shutdown(){return $s(Ee(t=>(p(this.shutdownFlag,Es(!0)),p(this.scope.close(Tw(t.id())),mt(this.strategy.shutdown),nl(Ac(this.shutdownHook,void 0)),on))))}publish(t){return ae(()=>_e(this.shutdownFlag)?Tt:this.pubsub.publish(t)?(this.strategy.unsafeCompleteSubscribers(this.pubsub,this.subscribers),L(!0)):this.strategy.handleSurplus(this.pubsub,this.subscribers,Be(t),this.shutdownFlag))}isActive(){return!_e(this.shutdownFlag)}unsafeOffer(t){return _e(this.shutdownFlag)?!1:this.pubsub.publish(t)?(this.strategy.unsafeCompleteSubscribers(this.pubsub,this.subscribers),!0):!1}publishAll(t){return ae(()=>{if(_e(this.shutdownFlag))return Tt;const n=CH(this.pubsub,t);return this.strategy.unsafeCompleteSubscribers(this.pubsub,this.subscribers),Bu(n)?L(!0):this.strategy.handleSurplus(this.pubsub,this.subscribers,n,this.shutdownFlag)})}get subscribe(){const t=tl(jp([this.scope.fork($r),mH(this.pubsub,this.subscribers,this.strategy)]),n=>n[0].addFinalizer(()=>n[1].shutdown));return ne(uM(t,(n,r)=>n[0].close(r)),n=>n[1])}offer(t){return this.publish(t)}offerAll(t){return this.publishAll(t)}pipe(){return G(this,arguments)}}const wH=(e,t)=>P(vl(),n=>ne($c(),r=>vH(e,new Map,n,r,Ts(!1),t))),vH=(e,t,n,r,s,o)=>new _H(e,t,n,r,s,o),kH=(e,t)=>{ul(e,L(t))},Lk=(e,t)=>p(e,kp(t)),rm=e=>p(e,hl(Number.POSITIVE_INFINITY)),TH=e=>e.pollUpTo(Number.POSITIVE_INFINITY),EH=(e,t)=>e.pollUpTo(t),CH=(e,t)=>e.publishAll(t),IH=(e,t)=>{Lk(e,p(rm(e),Nu(n=>n!==t)))};class $H{get shutdown(){return Ke}handleSurplus(t,n,r,s){return L(!1)}unsafeOnPubSubEmptySpace(t,n){}unsafeCompletePollers(t,n,r,s){return AH(this,t,n,r,s)}unsafeCompleteSubscribers(t,n){return RH(this,t,n)}}const AH=(e,t,n,r,s)=>{let o=!0;for(;o&&!r.isEmpty();){const i=p(s,ur(st));if(i===st)p(n,uH(r,s)),is(s)?o=!1:p(n,Bk(r,s));else{const c=r.poll(st);c===st?Lk(s,p(rm(s),xt(i))):(kH(i,c),e.unsafeOnPubSubEmptySpace(t,n))}}},RH=(e,t,n)=>{for(const[r,s]of n)for(const o of s)e.unsafeCompletePollers(t,n,r,o)};class OH{capacity;constructor(t){this.capacity=t}head={value:Rn,next:null};tail=this.head;size=0;index=0;slide(){this.index++}offer(t){this.tail.value=t,this.tail.next={value:Rn,next:null},this.tail=this.tail.next,this.size===this.capacity?this.head=this.head.next:this.size+=1}offerAll(t){for(const n of t)this.offer(n)}}class PH{buffer;head;index;remaining;constructor(t){this.buffer=t,this.index=t.index,this.remaining=t.size,this.head=t.head}fastForward(){for(;this.index<this.buffer.index;)this.head=this.head.next,this.index++}take(){if(this.remaining===0)return;this.index<this.buffer.index&&this.fastForward(),this.remaining--;const t=this.head.value;return this.head=this.head.next,t}takeN(t){if(this.remaining===0)return We();this.index<this.buffer.index&&this.fastForward();const n=Math.min(t,this.remaining),r=new Array(n);for(let s=0;s<n;s++){const o=this.head.value;this.head=this.head.next,r[s]=o}return this.remaining-=n,rn(r)}takeAll(){return this.takeN(this.remaining)}}const FH={remaining:0,take:()=>{},takeN:()=>We(),takeAll:()=>We()},Hk=lH,Qh=fH,sm=hH,Ty=dH,om=WL,Dk=JL,xH=QL,NH=XL,ic=ZL,Ut=eH,Xh=Yh,BH=nH,Uk="Continue",MH="Close",LH="Yield",HH="effect/ChannelChildExecutorDecision",Ey=Symbol.for(HH),DH={[Ey]:Ey},Kk=e=>{const t=Object.create(DH);return t._tag=Uk,t},_a="ContinuationK",UH="ContinuationFinalizer",jk=Symbol.for("effect/ChannelContinuation"),zk={_Env:e=>e,_InErr:e=>e,_InElem:e=>e,_InDone:e=>e,_OutErr:e=>e,_OutDone:e=>e,_OutErr2:e=>e,_OutElem:e=>e,_OutDone2:e=>e};class Vk{onSuccess;onHalt;_tag=_a;[jk]=zk;constructor(t,n){this.onSuccess=t,this.onHalt=n}onExit(t){return Iw(t)?this.onHalt(t.cause):this.onSuccess(t.value)}}class KH{finalizer;_tag=UH;[jk]=zk;constructor(t){this.finalizer=t}}const qk="PullAfterNext",jH="PullAfterAllEnqueued",zH="effect/ChannelUpstreamPullStrategy",VH=Symbol.for(zH),qH={_A:e=>e},WH={[VH]:qH},Wk=e=>{const t=Object.create(WH);return t._tag=qk,t.emitSeparator=e,t},Jk="BracketOut",Gk="Bridge",im="ConcatAll",Yk="Emit",Qk="Ensuring",Xk="Fail",Zk="Fold",eT="FromEffect",tT="PipeTo",JH="Provide",nT="Read",rT="Succeed",sT="SucceedNow",oT="Suspend",GH="effect/Channel",iT=Symbol.for(GH),YH={_Env:e=>e,_InErr:e=>e,_InElem:e=>e,_InDone:e=>e,_OutErr:e=>e,_OutElem:e=>e,_OutDone:e=>e},Yt={[iT]:YH,pipe(){return G(this,arguments)}},cT=e=>te(e,iT)||ri(e),QH=d(2,(e,t)=>{const n=Object.create(Yt);return n._tag=Jk,n.acquire=()=>e,n.finalizer=t,n}),aT=(e,t,n)=>{const r=Object.create(Yt);return r._tag=im,r.combineInners=t,r.combineAll=n,r.onPull=()=>Wk(K()),r.onEmit=()=>Kk,r.value=()=>e,r.k=ee,r},XH=d(4,(e,t,n,r)=>{const s=Object.create(Yt);return s._tag=im,s.combineInners=n,s.combineAll=r,s.onPull=()=>Wk(K()),s.onEmit=()=>Kk,s.value=()=>e,s.k=t,s}),cm=d(2,(e,t)=>{const n=Object.create(Yt);return n._tag=Gk,n.input=t,n.channel=e,n}),ZH=d(2,(e,t)=>{const n=Object.create(Yt);return n._tag=Qk,n.channel=e,n.finalizer=t,n}),Ar=e=>bt(CM(e)),bt=e=>eD(()=>e),eD=e=>{const t=Object.create(Yt);return t._tag=Xk,t.error=e,t},Te=d(2,(e,t)=>{const n=Object.create(Yt);return n._tag=Zk,n.channel=e,n.k=new Vk(t,bt),n}),kt=e=>{const t=Object.create(Yt);return t._tag=eT,t.effect=()=>e,t},Ft=d(2,(e,t)=>{const n=Object.create(Yt);return n._tag=tT,n.left=()=>e,n.right=()=>t,n}),Mc=e=>Jn({onInput:e.onInput,onFailure:t=>Kt(OM(t),{onLeft:e.onFailure,onRight:bt}),onDone:e.onDone}),Jn=e=>{const t=Object.create(Yt);return t._tag=nT,t.more=e.onInput,t.done=new Vk(e.onDone,e.onFailure),t},am=e=>uT(()=>e),Vn=e=>{const t=Object.create(Yt);return t._tag=sT,t.terminal=e,t},Cl=e=>{const t=Object.create(Yt);return t._tag=oT,t.channel=e,t},uT=e=>{const t=Object.create(Yt);return t._tag=rT,t.evaluate=e,t},Mt=Vn(void 0),Re=e=>{const t=Object.create(Yt);return t._tag=Yk,t.out=e,t},Lc="Done",Hc="Emit",si="FromEffect",Dc="Read",tD=Symbol.for("effect/ChannelState"),nD={_E:e=>e,_R:e=>e},Il={[tD]:nD},Ds=()=>{const e=Object.create(Il);return e._tag=Lc,e},mf=()=>{const e=Object.create(Il);return e._tag=Hc,e},pi=e=>{const t=Object.create(Il);return t._tag=si,t.effect=e,t},gf=(e,t,n,r)=>{const s=Object.create(Il);return s._tag=Dc,s.upstream=e,s.onEffect=t,s.onEmit=n,s.onDone=r,s},pu=e=>e._tag===si,rD=e=>pu(e)?e.effect:me,Cy=e=>pu(e)?IL(e.effect):void 0,lT="PullFromChild",Zh="PullFromUpstream",ed="DrainChildExecutors",fT="Emit";class Xc{childExecutor;parentSubexecutor;onEmit;_tag=lT;constructor(t,n,r){this.childExecutor=t,this.parentSubexecutor=n,this.onEmit=r}close(t){const n=this.childExecutor.close(t),r=this.parentSubexecutor.close(t);return n!==void 0&&r!==void 0?El(yt(n),yt(r),(s,o)=>p(s,Xi(o))):n!==void 0?n:r!==void 0?r:void 0}enqueuePullFromChild(t){return this}}class Yr{upstreamExecutor;createChild;lastDone;activeChildExecutors;combineChildResults;combineWithChildResult;onPull;onEmit;_tag=Zh;constructor(t,n,r,s,o,i,c,a){this.upstreamExecutor=t,this.createChild=n,this.lastDone=r,this.activeChildExecutors=s,this.combineChildResults=o,this.combineWithChildResult=i,this.onPull=c,this.onEmit=a}close(t){const n=this.upstreamExecutor.close(t),s=[...this.activeChildExecutors.map(o=>o!==void 0?o.childExecutor.close(t):void 0),n].reduce((o,i)=>o!==void 0&&i!==void 0?El(o,yt(i),(c,a)=>Xi(c,a)):o!==void 0?o:i!==void 0?yt(i):void 0,void 0);return s}enqueuePullFromChild(t){return new Yr(this.upstreamExecutor,this.createChild,this.lastDone,[...this.activeChildExecutors,t],this.combineChildResults,this.combineWithChildResult,this.onPull,this.onEmit)}}class Zs{upstreamExecutor;lastDone;activeChildExecutors;upstreamDone;combineChildResults;combineWithChildResult;onPull;_tag=ed;constructor(t,n,r,s,o,i,c){this.upstreamExecutor=t,this.lastDone=n,this.activeChildExecutors=r,this.upstreamDone=s,this.combineChildResults=o,this.combineWithChildResult=i,this.onPull=c}close(t){const n=this.upstreamExecutor.close(t),s=[...this.activeChildExecutors.map(o=>o!==void 0?o.childExecutor.close(t):void 0),n].reduce((o,i)=>o!==void 0&&i!==void 0?El(o,yt(i),(c,a)=>Xi(c,a)):o!==void 0?o:i!==void 0?yt(i):void 0,void 0);return s}enqueuePullFromChild(t){return new Zs(this.upstreamExecutor,this.lastDone,[...this.activeChildExecutors,t],this.upstreamDone,this.combineChildResults,this.combineWithChildResult,this.onPull)}}class yf{value;next;_tag=fT;constructor(t,n){this.value=t,this.next=n}close(t){const n=this.next.close(t);return n}enqueuePullFromChild(t){return this}}const sD="Pulled",oD="NoUpstream",iD="effect/ChannelUpstreamPullRequest",cD=Symbol.for(iD),aD={_A:e=>e},hT={[cD]:aD},Iy=e=>{const t=Object.create(hT);return t._tag=sD,t.value=e,t},uD=e=>{const t=Object.create(hT);return t._tag=oD,t.activeDownstreamCount=e,t};class es{_activeSubexecutor=void 0;_cancelled=void 0;_closeLastSubstream=void 0;_currentChannel;_done=void 0;_doneStack=[];_emitted=void 0;_executeCloseLastSubstream;_input=void 0;_inProgressFinalizer=void 0;_providedEnv;constructor(t,n,r){this._currentChannel=t,this._executeCloseLastSubstream=r,this._providedEnv=n}run(){let t;for(;t===void 0;)if(this._cancelled!==void 0)t=this.processCancellation();else if(this._activeSubexecutor!==void 0)t=this.runSubexecutor();else try{if(this._currentChannel===void 0)t=Ds();else switch(ri(this._currentChannel)&&(this._currentChannel=kt(this._currentChannel)),this._currentChannel._tag){case Jk:{t=this.runBracketOut(this._currentChannel);break}case Gk:{const n=this._currentChannel.input;if(this._currentChannel=this._currentChannel.channel,this._input!==void 0){const r=this._input;this._input=void 0;const s=()=>X(n.awaitRead(),()=>tt(()=>{const o=r.run();switch(o._tag){case Lc:return Nn(r.getDone(),{onFailure:i=>n.error(i),onSuccess:i=>n.done(i)});case Hc:return X(n.emit(r.getEmit()),()=>s());case si:return On(o.effect,{onFailure:i=>n.error(i),onSuccess:()=>s()});case Dc:return um(o,()=>s(),i=>n.error(i))}}));t=pi(X(ot(Zt(s())),o=>Qe(()=>this.addFinalizer(i=>X(Fe(o),()=>tt(()=>{const c=this.restorePipe(i,r);return c!==void 0?c:me}))))))}break}case im:{const n=new es(this._currentChannel.value(),this._providedEnv,s=>Qe(()=>{const o=this._closeLastSubstream===void 0?me:this._closeLastSubstream;this._closeLastSubstream=p(o,Ce(s))}));n._input=this._input;const r=this._currentChannel;this._activeSubexecutor=new Yr(n,s=>r.k(s),void 0,[],(s,o)=>r.combineInners(s,o),(s,o)=>r.combineAll(s,o),s=>r.onPull(s),s=>r.onEmit(s)),this._closeLastSubstream=void 0,this._currentChannel=void 0;break}case Yk:{this._emitted=this._currentChannel.out,this._currentChannel=this._activeSubexecutor!==void 0?void 0:Mt,t=mf();break}case Qk:{this.runEnsuring(this._currentChannel);break}case Xk:{t=this.doneHalt(this._currentChannel.error());break}case Zk:{this._doneStack.push(this._currentChannel.k),this._currentChannel=this._currentChannel.channel;break}case eT:{const n=this._providedEnv===void 0?this._currentChannel.effect():p(this._currentChannel.effect(),Jh(this._providedEnv));t=pi(On(n,{onFailure:r=>{const s=this.doneHalt(r);return s!==void 0&&pu(s)?s.effect:me},onSuccess:r=>{const s=this.doneSucceed(r);return s!==void 0&&pu(s)?s.effect:me}}));break}case tT:{const n=this._input,r=new es(this._currentChannel.left(),this._providedEnv,s=>this._executeCloseLastSubstream(s));r._input=n,this._input=r,this.addFinalizer(s=>{const o=this.restorePipe(s,n);return o!==void 0?o:me}),this._currentChannel=this._currentChannel.right();break}case JH:{const n=this._providedEnv;this._providedEnv=this._currentChannel.context(),this._currentChannel=this._currentChannel.inner,this.addFinalizer(()=>Qe(()=>{this._providedEnv=n}));break}case nT:{const n=this._currentChannel;t=gf(this._input,ee,r=>{try{this._currentChannel=n.more(r)}catch(s){this._currentChannel=n.done.onExit(uP(s))}},r=>{const s=o=>n.done.onExit(o);this._currentChannel=s(r)});break}case rT:{t=this.doneSucceed(this._currentChannel.evaluate());break}case sT:{t=this.doneSucceed(this._currentChannel.terminal);break}case oT:{this._currentChannel=this._currentChannel.channel();break}}}catch(n){this._currentChannel=bt(Dh(n))}return t}getDone(){return this._done}getEmit(){return this._emitted}cancelWith(t){this._cancelled=t}clearInProgressFinalizer(){this._inProgressFinalizer=void 0}storeInProgressFinalizer(t){this._inProgressFinalizer=t}popAllFinalizers(t){const n=[];let r=this._doneStack.pop();for(;r;)r._tag==="ContinuationFinalizer"&&n.push(r.finalizer),r=this._doneStack.pop();const s=n.length===0?me:bf(n,t);return this.storeInProgressFinalizer(s),s}popNextFinalizers(){const t=[];for(;this._doneStack.length!==0;){const n=this._doneStack[this._doneStack.length-1];if(n._tag===_a)return t;t.push(n),this._doneStack.pop()}return t}restorePipe(t,n){const r=this._input;return this._input=n,r!==void 0?r.close(t):me}close(t){let n;const r=this._inProgressFinalizer;r!==void 0&&(n=p(r,Qs(Qe(()=>this.clearInProgressFinalizer()))));let s;const o=this.popAllFinalizers(t);o!==void 0&&(s=p(o,Qs(Qe(()=>this.clearInProgressFinalizer()))));const i=this._activeSubexecutor===void 0?void 0:this._activeSubexecutor.close(t);if(!(i===void 0&&n===void 0&&s===void 0))return p(yt(Sf(i)),Gh(yt(Sf(n))),Gh(yt(Sf(s))),j(([[c,a],u])=>p(c,Xi(a),Xi(u))),_i,X(c=>tt(()=>c)))}doneSucceed(t){if(this._doneStack.length===0)return this._done=fn(t),this._currentChannel=void 0,Ds();const n=this._doneStack[this._doneStack.length-1];if(n._tag===_a){this._doneStack.pop(),this._currentChannel=n.onSuccess(t);return}const r=this.popNextFinalizers();if(this._doneStack.length===0)return this._doneStack=r.reverse(),this._done=fn(t),this._currentChannel=void 0,Ds();const s=bf(r.map(i=>i.finalizer),fn(t));this.storeInProgressFinalizer(s);const o=p(s,Qs(Qe(()=>this.clearInProgressFinalizer())),_i,X(()=>Qe(()=>this.doneSucceed(t))));return pi(o)}doneHalt(t){if(this._doneStack.length===0)return this._done=dn(t),this._currentChannel=void 0,Ds();const n=this._doneStack[this._doneStack.length-1];if(n._tag===_a){this._doneStack.pop();try{this._currentChannel=n.onHalt(t)}catch(i){this._currentChannel=bt(Dh(i))}return}const r=this.popNextFinalizers();if(this._doneStack.length===0)return this._doneStack=r.reverse(),this._done=dn(t),this._currentChannel=void 0,Ds();const s=bf(r.map(i=>i.finalizer),dn(t));this.storeInProgressFinalizer(s);const o=p(s,Qs(Qe(()=>this.clearInProgressFinalizer())),_i,X(()=>Qe(()=>this.doneHalt(t))));return pi(o)}processCancellation(){return this._currentChannel=void 0,this._done=this._cancelled,this._cancelled=void 0,Ds()}runBracketOut(t){const n=_i(On(this.provide(t.acquire()),{onFailure:r=>Qe(()=>{this._currentChannel=bt(r)}),onSuccess:r=>Qe(()=>{this.addFinalizer(s=>this.provide(t.finalizer(r,s))),this._currentChannel=Re(r)})}));return pi(n)}provide(t){return this._providedEnv===void 0?t:p(t,Jh(this._providedEnv))}runEnsuring(t){this.addFinalizer(t.finalizer),this._currentChannel=t.channel}addFinalizer(t){this._doneStack.push(new KH(t))}runSubexecutor(){const t=this._activeSubexecutor;switch(t._tag){case lT:return this.pullFromChild(t.childExecutor,t.parentSubexecutor,t.onEmit,t);case Zh:return this.pullFromUpstream(t);case ed:return this.drainChildExecutors(t);case fT:return this._emitted=t.value,this._activeSubexecutor=t.next,mf()}}replaceSubexecutor(t){this._currentChannel=void 0,this._activeSubexecutor=t}finishWithExit(t){const n=Nn(t,{onFailure:r=>this.doneHalt(r),onSuccess:r=>this.doneSucceed(r)});return this._activeSubexecutor=void 0,n===void 0?me:rD(n)}finishSubexecutorWithCloseEffect(t,...n){this.addFinalizer(()=>p(n,vn(s=>p(Qe(()=>s(t)),X(o=>o!==void 0?o:me)),{discard:!0})));const r=p(t,Nn({onFailure:s=>this.doneHalt(s),onSuccess:s=>this.doneSucceed(s)}));return this._activeSubexecutor=void 0,r}applyUpstreamPullStrategy(t,n,r){switch(r._tag){case qk:{const s=!t||n.some(o=>o!==void 0);return[r.emitSeparator,s?[void 0,...n]:n]}case jH:{const s=!t||n.some(o=>o!==void 0);return[r.emitSeparator,s?[...n,void 0]:n]}}}pullFromChild(t,n,r,s){return gf(t,ee,o=>{const i=r(o);switch(i._tag){case Uk:break;case MH:{this.finishWithDoneValue(t,n,i.value);break}case LH:{const c=n.enqueuePullFromChild(s);this.replaceSubexecutor(c);break}}this._activeSubexecutor=new yf(o,this._activeSubexecutor)},Nn({onFailure:o=>{const i=this.handleSubexecutorFailure(t,n,o);return i===void 0?void 0:Cy(i)},onSuccess:o=>{this.finishWithDoneValue(t,n,o)}}))}finishWithDoneValue(t,n,r){const s=n;switch(s._tag){case Zh:{const o=new Yr(s.upstreamExecutor,s.createChild,s.lastDone!==void 0?s.combineChildResults(s.lastDone,r):r,s.activeChildExecutors,s.combineChildResults,s.combineWithChildResult,s.onPull,s.onEmit);this._closeLastSubstream=t.close(fn(r)),this.replaceSubexecutor(o);break}case ed:{const o=new Zs(s.upstreamExecutor,s.lastDone!==void 0?s.combineChildResults(s.lastDone,r):r,s.activeChildExecutors,s.upstreamDone,s.combineChildResults,s.combineWithChildResult,s.onPull);this._closeLastSubstream=t.close(fn(r)),this.replaceSubexecutor(o);break}}}handleSubexecutorFailure(t,n,r){return this.finishSubexecutorWithCloseEffect(dn(r),s=>n.close(s),s=>t.close(s))}pullFromUpstream(t){if(t.activeChildExecutors.length===0)return this.performPullFromUpstream(t);const n=t.activeChildExecutors[0],r=new Yr(t.upstreamExecutor,t.createChild,t.lastDone,t.activeChildExecutors.slice(1),t.combineChildResults,t.combineWithChildResult,t.onPull,t.onEmit);if(n===void 0)return this.performPullFromUpstream(r);this.replaceSubexecutor(new Xc(n.childExecutor,r,n.onEmit))}performPullFromUpstream(t){return gf(t.upstreamExecutor,n=>{const r=this._closeLastSubstream===void 0?me:this._closeLastSubstream;return this._closeLastSubstream=void 0,p(this._executeCloseLastSubstream(r),Ce(n))},n=>{if(this._closeLastSubstream!==void 0){const i=this._closeLastSubstream;return this._closeLastSubstream=void 0,p(this._executeCloseLastSubstream(i),j(()=>{const c=new es(t.createChild(n),this._providedEnv,this._executeCloseLastSubstream);c._input=this._input;const[a,u]=this.applyUpstreamPullStrategy(!1,t.activeChildExecutors,t.onPull(Iy(n)));this._activeSubexecutor=new Xc(c,new Yr(t.upstreamExecutor,t.createChild,t.lastDone,u,t.combineChildResults,t.combineWithChildResult,t.onPull,t.onEmit),t.onEmit),$e(a)&&(this._activeSubexecutor=new yf(a.value,this._activeSubexecutor))}))}const r=new es(t.createChild(n),this._providedEnv,this._executeCloseLastSubstream);r._input=this._input;const[s,o]=this.applyUpstreamPullStrategy(!1,t.activeChildExecutors,t.onPull(Iy(n)));this._activeSubexecutor=new Xc(r,new Yr(t.upstreamExecutor,t.createChild,t.lastDone,o,t.combineChildResults,t.combineWithChildResult,t.onPull,t.onEmit),t.onEmit),$e(s)&&(this._activeSubexecutor=new yf(s.value,this._activeSubexecutor))},n=>{if(t.activeChildExecutors.some(o=>o!==void 0)){const o=new Zs(t.upstreamExecutor,t.lastDone,[void 0,...t.activeChildExecutors],t.upstreamExecutor.getDone(),t.combineChildResults,t.combineWithChildResult,t.onPull);if(this._closeLastSubstream!==void 0){const i=this._closeLastSubstream;return this._closeLastSubstream=void 0,p(this._executeCloseLastSubstream(i),j(()=>this.replaceSubexecutor(o)))}this.replaceSubexecutor(o);return}const r=this._closeLastSubstream,s=this.finishSubexecutorWithCloseEffect(p(n,lP(o=>t.combineWithChildResult(t.lastDone,o))),()=>r,o=>t.upstreamExecutor.close(o));return s===void 0?void 0:Cy(s)})}drainChildExecutors(t){if(t.activeChildExecutors.length===0){const o=this._closeLastSubstream;return o!==void 0&&this.addFinalizer(()=>z(o)),this.finishSubexecutorWithCloseEffect(t.upstreamDone,()=>o,i=>t.upstreamExecutor.close(i))}const n=t.activeChildExecutors[0],r=t.activeChildExecutors.slice(1);if(n===void 0){const[o,i]=this.applyUpstreamPullStrategy(!0,r,t.onPull(uD(r.reduce((c,a)=>a!==void 0?c+1:c,0))));return this.replaceSubexecutor(new Zs(t.upstreamExecutor,t.lastDone,i,t.upstreamDone,t.combineChildResults,t.combineWithChildResult,t.onPull)),$e(o)?(this._emitted=o.value,mf()):void 0}const s=new Zs(t.upstreamExecutor,t.lastDone,r,t.upstreamDone,t.combineChildResults,t.combineWithChildResult,t.onPull);this.replaceSubexecutor(new Xc(n.childExecutor,s,n.onEmit))}}const Sf=e=>e!==void 0?e:me,bf=(e,t)=>p(vn(e,n=>yt(n(t))),j(n=>p(aP(n),qe(()=>fP))),X(n=>tt(()=>n))),um=(e,t,n)=>{const r=[e],s=()=>{const o=r.pop();if(o===void 0||o.upstream===void 0)return CL("Unexpected end of input for channel execution");const i=o.upstream.run();switch(i._tag){case Hc:{const c=o.onEmit(o.upstream.getEmit());return r.length===0?c===void 0?tt(t):p(c,On({onFailure:n,onSuccess:t})):c===void 0?tt(()=>s()):p(c,On({onFailure:n,onSuccess:()=>s()}))}case Lc:{const c=o.onDone(o.upstream.getDone());return r.length===0?c===void 0?tt(t):p(c,On({onFailure:n,onSuccess:t})):c===void 0?tt(()=>s()):p(c,On({onFailure:n,onSuccess:()=>s()}))}case si:return r.push(o),p(o.onEffect(i.effect),Nr(c=>tt(()=>{const a=o.onDone(dn(c));return a===void 0?me:a})),On({onFailure:n,onSuccess:()=>s()}));case Dc:return r.push(o),r.push(i),tt(()=>s())}};return s()},dT=d(2,(e,t)=>{const n=(r,s,o)=>AL(Qe(()=>new es(e,void 0,ee)),i=>tt(()=>wa(i.run(),i).pipe(Ck(r),Ce(Et(r)),Tl(Et(s)))),(i,c)=>{const a=i.close(c);return a===void 0?me:Zp(a,u=>sc(o,lr(u)))});return Xp(r=>ze([nk(t,tu),hn(),hn()]).pipe(X(([s,o,i])=>r(n(o,i,s)).pipe(Hn(t),X(c=>t.addFinalizer(a=>{const u=Iw(a)?RM(a.cause):void 0;return wh(o).pipe(X(l=>l?xn(i,void 0).pipe(Ce(ck(c)),Ce(my(c))):xn(i,void 0).pipe(Ce(u&&ep(u)>0?w2(c,u1(u)):Fe(c)),Ce(my(c)))))}).pipe(Ce(r(Et(o)))))))))}),wa=(e,t)=>{const n=e;switch(n._tag){case si:return p(n.effect,X(()=>wa(t.run(),t)));case Hc:return wa(t.run(),t);case Lc:return tt(()=>t.getDone());case Dc:return um(n,()=>wa(t.run(),t),lr)}},pT="Done",lD="Await",fD="effect/ChannelMergeDecision",hD=Symbol.for(fD),mT={[hD]:{_R:e=>e,_E0:e=>e,_Z0:e=>e,_E:e=>e,_Z:e=>e}},dD=e=>{const t=Object.create(mT);return t._tag=pT,t.effect=e,t},td=e=>{const t=Object.create(mT);return t._tag=lD,t.f=e,t},gT="BothRunning",yT="LeftDone",ST="RightDone",pD="effect/ChannelMergeState",$y=Symbol.for(pD),lm={[$y]:$y},_f=(e,t)=>{const n=Object.create(lm);return n._tag=gT,n.left=e,n.right=t,n},Ay=e=>{const t=Object.create(lm);return t._tag=yT,t.f=e,t},Ry=e=>{const t=Object.create(lm);return t._tag=ST,t.f=e,t},bT="BackPressure",_T="BufferSliding",mD="effect/ChannelMergeStrategy",Oy=Symbol.for(mD),wT={[Oy]:Oy},gD=e=>{const t=Object.create(wT);return t._tag=bT,t},yD=e=>{const t=Object.create(wT);return t._tag=_T,t},SD=d(2,(e,{onBackPressure:t,onBufferSliding:n})=>{switch(e._tag){case bT:return t();case _T:return n()}}),qs="Empty",wi="Emit",vi="Error",ki="Done",vT=e=>({_tag:qs,notifyProducer:e}),wf=e=>({_tag:wi,notifyConsumers:e}),bD=e=>({_tag:vi,cause:e}),_D=e=>({_tag:ki,done:e});class wD{ref;constructor(t){this.ref=t}awaitRead(){return Gr(fi(this.ref,t=>t._tag===qs?[Et(t.notifyProducer),t]:[me,t]))}get close(){return OL(t=>this.error(IM(t)))}done(t){return Gr(fi(this.ref,n=>{switch(n._tag){case qs:return[Et(n.notifyProducer),n];case wi:return[vn(n.notifyConsumers,r=>xn(r,re(t)),{discard:!0}),_D(t)];case vi:return[Ls,n];case ki:return[Ls,n]}}))}emit(t){return X(hn(),n=>Gr(fi(this.ref,r=>{switch(r._tag){case qs:return[Et(r.notifyProducer),r];case wi:{const s=r.notifyConsumers[0],o=r.notifyConsumers.slice(1);if(s!==void 0)return[xn(s,pe(t)),o.length===0?vT(n):wf(o)];throw new Error("Bug: Channel.SingleProducerAsyncInput.emit - Queue was empty! please report an issue at https://github.com/Effect-TS/effect/issues")}case vi:return[Ls,r];case ki:return[Ls,r]}})))}error(t){return Gr(fi(this.ref,n=>{switch(n._tag){case qs:return[Et(n.notifyProducer),n];case wi:return[vn(n.notifyConsumers,r=>Cw(r,t),{discard:!0}),bD(t)];case vi:return[Ls,n];case ki:return[Ls,n]}}))}get take(){return this.takeWith(t=>dn(Jv(t,re)),t=>fn(t),t=>$w(pe(t)))}takeWith(t,n,r){return X(hn(),s=>Gr(fi(this.ref,o=>{switch(o._tag){case qs:return[Ce(xn(o.notifyProducer,void 0),hu(Et(s),{onFailure:t,onSuccess:Kt({onLeft:r,onRight:n})})),wf([s])];case wi:return[hu(Et(s),{onFailure:t,onSuccess:Kt({onLeft:r,onRight:n})}),wf([...o.notifyConsumers,s])];case vi:return[z(t(o.cause)),o];case ki:return[z(r(o.done)),o]}})))}}const fm=()=>p(hn(),X(e=>Ip(vT(e))),j(e=>new wD(e))),vD=d(2,(e,t)=>dm(e,()=>t)),mu=d(2,(e,t)=>XH(e,t,()=>{},()=>{})),hm=e=>{const t=Jn({onInput:()=>t,onFailure:bt,onDone:am});return Ft(e,t)},kT=d(2,(e,t)=>ZH(e,()=>t)),kD=e=>Te(e,ee),$l=e=>nn(e.takeWith(bt,t=>Te(Re(t),()=>$l(e)),am)),TT=()=>Mc({onInput:e=>Te(Re(e),()=>TT()),onFailure:Ar,onDone:Vn}),dm=d(2,(e,t)=>Te(e,n=>uT(()=>t(n)))),Al=d(2,(e,t)=>{const n=Mc({onInput:r=>Te(Re(t(r)),()=>n),onFailure:Ar,onDone:Vn});return Ft(e,n)}),TD=d(3,(e,t,n)=>pm(r=>$(function*(){const s=yield*fm(),o=$l(s),i=yield*om(n);yield*sc(r,ic(i));const c=yield*hn(),a=n===Number.POSITIVE_INFINITY?f=>ee:(yield*em(n)).withPermits;yield*(yield*o.pipe(Ft(e),fo(r))).pipe(On({onFailure:f=>Ut(i,lr(f)),onSuccess:Kt({onLeft:f=>Ce(Zt(a(n)(me)),Ae(Ut(i,z(re(f))))),onRight:f=>$(function*(){const h=yield*hn(),m=yield*hn();yield*Ut(i,j(Et(h),pe)),yield*xn(m,void 0).pipe(Ce(Xp(y=>yt(y(Et(c))).pipe(xL(yt(y(t(f)))),X(ee))).pipe(Zp(y=>Cw(c,y)),Ck(h))),a(1),Hn(r)),yield*Et(m)})})}),NL,Zt,Hn(r));const l=nn(hu(Gr(Xh(i)),{onFailure:bt,onSuccess:Kt({onLeft:Vn,onRight:f=>Te(Re(f),()=>l)})}));return cm(l,s)}))),ED=e=>t=>CD(e)(t,Ra),CD=({bufferSize:e=16,concurrency:t,mergeStrategy:n=gD()})=>(r,s)=>pm(o=>$(function*(){const i=t==="unbounded"?Number.MAX_SAFE_INTEGER:t,c=yield*fm(),a=$l(c),u=yield*om(e);yield*sc(o,ic(u));const l=yield*Dk();yield*sc(o,ic(l));const f=yield*Ip(K()),h=yield*hn(),m=(yield*em(i)).withPermits,y=yield*fo(Ft(a,r),o);function b(k){return k.pipe(X(Kt({onLeft:C=>z(U(C)),onRight:C=>cs(Ut(u,z(pe(C))),K())})),ky({until:C=>$e(C)}),X(C=>Jw(f,xe({onNone:()=>U(C.value),onSome:v=>U(s(v,C.value))}))),Nr(C=>Wv(C)?lr(C):Ut(u,lr(C)).pipe(Ce(xn(h,void 0)),Ae)))}yield*y.pipe(On({onFailure:k=>Ut(u,lr(k)).pipe(Ce(z(!1))),onSuccess:Kt({onLeft:k=>Ik(Zt(Et(h)),Zt(m(i)(me)),{onSelfDone:(C,v)=>cs(Fe(v),!1),onOtherDone:(C,v)=>Ce(Fe(v),Fi(f).pipe(X(xe({onNone:()=>Ut(u,z(re(k))),onSome:T=>Ut(u,z(re(s(T,k))))})),cs(!1)))}),onRight:k=>SD(n,{onBackPressure:()=>$(function*(){const C=yield*hn(),v=Wh(R=>fo(Ft(a,k),R).pipe(X(w=>pf(yt(b(w)),yt(Zt(Et(h))))),X(ee)));return yield*xn(C,void 0).pipe(Ce(v),m(1),Hn(o)),yield*Et(C),!(yield*wh(h))}),onBufferSliding:()=>$(function*(){const C=yield*hn(),v=yield*hn(),T=yield*xH(l);yield*Xh(l).pipe(X(I=>xn(I,void 0)),FL(()=>T>=i)),yield*Ut(l,C);const R=Wh(I=>fo(Ft(a,k),I).pipe(X(O=>yt(b(O)).pipe(pf(yt(Zt(Et(h)))),pf(yt(Zt(Et(C)))))),X(ee)));return yield*xn(v,void 0).pipe(Ce(R),m(1),Hn(o)),yield*Et(v),!(yield*wh(h))})})})}),ky({while:k=>k}),Hn(o));const _=p(Xh(u),Gr,hu({onFailure:bt,onSuccess:Kt({onLeft:Vn,onRight:k=>Te(Re(k),()=>_)})}),nn);return cm(_,c)})),ET=d(3,(e,t,n)=>ED(n)(Al(e,t))),CT=d(2,(e,t)=>{function n(r){return $(function*(){const s=yield*fm(),o=$l(s),i=yield*fo(Ft(o,e),r),c=yield*fo(Ft(o,t.other),r);function a(l,f,h){return(m,y,b)=>{function _(k){const C=k;return C._tag===pT?z(kt(Ce(Fe(f),C.effect))):j(ck(f),Nn({onFailure:v=>kt(C.f(dn(v))),onSuccess:Kt({onLeft:v=>kt(C.f(fn(v))),onRight:v=>Ol(Re(v),u(b(C.f)))})}))}return Nn(l,{onFailure:k=>_(m(dn(k))),onSuccess:Kt({onLeft:k=>_(m(fn(k))),onRight:k=>z(Te(Re(k),()=>Te(kt(Hn(Zt(h),r)),C=>u(y(C,f)))))})})}}function u(l){switch(l._tag){case gT:{const f=Zt(gy(l.left)),h=Zt(gy(l.right));return nn(Ik(f,h,{onSelfDone:(m,y)=>Ce(Fe(y),a(m,l.right,i)(t.onSelfDone,_f,b=>Ay(b))),onOtherDone:(m,y)=>Ce(Fe(y),a(m,l.left,c)(t.onOtherDone,(b,_)=>_f(_,b),b=>Ry(b)))}))}case yT:return nn(j(yt(c),Nn({onFailure:f=>kt(l.f(dn(f))),onSuccess:Kt({onLeft:f=>kt(l.f(fn(f))),onRight:f=>Te(Re(f),()=>u(Ay(l.f)))})})));case ST:return nn(j(yt(i),Nn({onFailure:f=>kt(l.f(dn(f))),onSuccess:Kt({onLeft:f=>kt(l.f(fn(f))),onRight:f=>Te(Re(f),()=>u(Ry(l.f)))})})))}}return kt(vy(l=>{const f=vy(y=>(y.transferChildren(l.scope()),me)),h=Zt(i).pipe(Qs(f),Hn(r)),m=Zt(c).pipe(Qs(f),Hn(r));return El(h,m,(y,b)=>_f(y,b))})).pipe(Te(u),cm(s))})}return pm(n)}),IT=d(2,(e,t)=>Cl(()=>{let n;const r=Mc({onInput:o=>Te(Re(o),()=>r),onFailure:o=>(n=OD(o),bt(Dh(n))),onDone:Vn}),s=Jn({onInput:o=>p(Re(o),Te(()=>s)),onFailure:o=>AM(o)&&PD(o.defect)&&oe(o.defect,n)?Ar(o.defect.error):bt(o),onDone:Vn});return Ft(Ft(Ft(e,r),t),s)})),ID=e=>Wh(t=>dT(e,t)),$D=e=>ID(hm(e)),$T=e=>nn(Xp(t=>j(l2(),n=>QH(Zp(t(u2(e,n)),r=>zh(n,dn(r))),(r,s)=>zh(n,s))))),AT=e=>AD(j(RL,t=>Te(kt(e(t)),Re))),fo=d(2,(e,t)=>Gh(Qe(()=>new es(e,void 0,ee)),LL()).pipe(Ie(([n,r])=>a2(t,s=>{const o=n.close(s);return o!==void 0?Jh(o,r):me})),_i,j(([n])=>tt(()=>nd(n.run(),n))))),nd=(e,t)=>{const n=e;switch(n._tag){case Lc:return Nn(t.getDone(),{onFailure:lr,onSuccess:r=>z(re(r))});case Hc:return z(pe(t.getEmit()));case si:return p(n.effect,X(()=>nd(t.run(),t)));case Dc:return um(n,()=>nd(t.run(),t),r=>lr(r))}},nn=e=>kD(kt(e)),AD=e=>aT($T(e),(t,n)=>t,(t,n)=>t),pm=e=>aT(AT(e),(t,n)=>t,(t,n)=>t),Rl=e=>RT(0,e.length,e),RT=(e,t,n)=>e===t?Mt:p(Re(p(n,cr(e))),Te(()=>RT(e+1,t,n))),RD=d(e=>cT(e[1]),(e,t,n)=>n?.concurrent?CT(e,{other:t,onSelfDone:r=>td(s=>tt(()=>Pg(r,s))),onOtherDone:r=>td(s=>tt(()=>Pg(s,r)))}):Te(e,r=>dm(t,s=>[r,s]))),Ol=d(e=>cT(e[1]),(e,t,n)=>n?.concurrent?dm(RD(e,t,{concurrent:!0}),r=>r[1]):Te(e,()=>t)),rd=Symbol.for("effect/Channel/ChannelException"),OD=e=>({_tag:"ChannelException",[rd]:rd,error:e}),PD=e=>te(e,rd),FD=Symbol.for("effect/Sink"),xD={_A:e=>e,_In:e=>e,_L:e=>e,_E:e=>e,_R:e=>e};class Uc{channel;[FD]=xD;constructor(t){this.channel=t}pipe(){return G(this,arguments)}}const ND=e=>new Uc(Cl(()=>mm(e()))),BD=new Uc(hm(TT())),MD=(e,t,n)=>ND(()=>new Uc(OT(e,t,n))),OT=(e,t,n)=>t(e)?Mc({onInput:r=>{const[s,o]=PT(e,r,t,n,0,r.length);return Un(o)?p(Re(o),vD(s)):OT(s,t,n)},onFailure:Ar,onDone:()=>Vn(e)}):Vn(e),PT=(e,t,n,r,s,o)=>{if(s===o)return[e,We()];const i=r(e,p(t,cr(s)));return n(i)?PT(i,t,n,r,s+1,o):[i,p(t,ji(s+1))]},LD=e=>{const t=Jn({onInput:n=>p(kt(vn(n,r=>e(r),{discard:!0})),Te(()=>t)),onFailure:bt,onDone:()=>Mt});return new Uc(t)},HD=e=>new Uc(kt(e)),DD=()=>MD(K(),Ue,(e,t)=>xe(e,{onNone:()=>U(t),onSome:()=>e})),mm=e=>ri(e)?mm(HD(e)):e.channel,UD=dD,KD=td,gm=iL,jD=Yp,FT=aL,ym=Qp,Sm=dL,zD=mL,VD="Left",qD="Right",WD="Both",JD="Either",GD={_tag:VD},YD={_tag:qD},xT={_tag:WD},QD={_tag:JD},XD=e=>{switch(e){case"left":return GD;case"right":return YD;case"both":return xT;case"either":return QD;default:return e}},ZD=xT,eU="effect/Take",tU=Symbol.for(eU),nU={_A:e=>e,_E:e=>e};class Pl{exit;[tU]=nU;constructor(t){this.exit=t}pipe(){return G(this,arguments)}}const Py=e=>new Pl(fn(e)),Fy=new Pl($w(K())),rU=e=>new Pl(dn(p(e,Jv(U)))),sU=e=>new Pl(fn(Be(e))),oU=()=>Ct(K()),iU=e=>kl(lr(e),U),cU="effect/Stream",NT=Symbol.for(cU),aU={_R:e=>e,_E:e=>e,_A:e=>e};class Je{channel;[NT]=aU;constructor(t){this.channel=t}pipe(){return G(this,arguments)}}const bm=e=>te(e,NT)||ri(e),_m=4096,uU=e=>p(e,lU((t,n)=>oe(n)(t))),lU=d(2,(e,t)=>{const n=r=>Jn({onInput:s=>{const[o,i]=c_(s,[r,We()],([c,a],u)=>$e(c)&&t(c.value,u)?[U(u),a]:[U(u),p(a,_o(u))]);return Te(Re(i),()=>n(o))},onFailure:bt,onDone:()=>Mt});return new Je(p(He(e),Ft(n(K()))))}),fU=d(2,(e,t)=>new Je(p(He(e),Ol(He(t))))),hU=new Je(Mt),sd=d(2,(e,t)=>new Je(p(He(e),kT(t)))),dU=e=>MT(Ct(U(e))),pU=d(2,(e,t)=>HT(e,Nu(t))),mU=d(2,(e,t)=>HT(e,s_(t))),Fl=d(e=>bm(e[0]),(e,t,n)=>{const r=n?.bufferSize??16;return n?.switch?od(n?.concurrency,()=>xy(e,1,r,t),s=>xy(e,s,r,t)):od(n?.concurrency,()=>new Je(mu(He(e),s=>p(s,i_(o=>He(t(o))),c_(Mt,(o,i)=>p(o,Ol(i)))))),s=>new Je(p(He(e),mu(Rl),ET(o=>He(t(o)),n))))}),od=(e,t,n)=>{switch(e){case void 0:return t();case"unbounded":return n(Number.MAX_SAFE_INTEGER);default:return e>1?n(e):t()}},xy=d(4,(e,t,n,r)=>new Je(p(He(e),mu(Rl),ET(s=>He(r(s)),{concurrency:t,mergeStrategy:yD(),bufferSize:n})))),wm=d(e=>bm(e[0]),(e,t)=>Fl(e,ee,t)),gU=e=>{const t=Jn({onInput:n=>Te(Rl(n),()=>t),onFailure:bt,onDone:()=>Mt});return new Je(p(He(e),Ft(t)))},yU=e=>{const t=(r,s)=>{const[o,i]=p(r,X$(a=>!Ga(a))),c=p(jd(i),xe({onNone:()=>s,onSome:Nn({onFailure:a=>xe(PM(a),{onNone:()=>Mt,onSome:bt}),onSuccess:()=>Mt})}));return p(Re(p(o,s_(a=>Ga(a)?U(a.value):K()))),Te(()=>c))},n=Jn({onInput:r=>t(r,n),onFailure:r=>bt(r),onDone:()=>Mt});return new Je(p(He(e),Ft(n)))},BT=e=>gU(yU(p(e,yu(t=>t.exit)))),He=e=>{if("channel"in e)return e.channel;if(ri(e))return He(xl(e));throw new TypeError("Expected a Stream.")},SU=e=>new Je(Bu(e)?Mt:Re(e)),xl=e=>p(e,kl(U),MT),MT=e=>new Je(nn($k(e,{onFailure:xe({onNone:()=>Mt,onSome:Ar}),onSuccess:t=>Re(Be(t))}))),LT=(e,t)=>{const n=t?.maxChunkSize??_m;if(t?.scoped){const s=j(Ty(e),o=>gu(o,{maxChunkSize:n,shutdown:!0}));return t.shutdown?j(s,sd(Qh(e))):s}const r=Fl(UT(Ty(e)),s=>gu(s,{maxChunkSize:n}));return t?.shutdown?sd(r,Qh(e)):r},bU=e=>km(()=>Kd(e)?SU(e):_U(e[Symbol.iterator]())),_U=(e,t=_m)=>p(Qe(()=>{let n=[];const r=s=>p(Qe(()=>{let o=s.next();if(t===1)return o.done?Mt:p(Re(Be(o.value)),Te(()=>r(s)));n=[];let i=0;for(;o.done===!1&&(n.push(o.value),i=i+1,!(i>=t));)o=s.next();return i>0?p(Re(rn(n)),Te(()=>r(s))):Mt}),nn);return new Je(r(e))}),MU),gu=(e,t)=>p(BH(e,1,t?.maxChunkSize??_m),Nr(n=>p(NH(e),X(r=>r&&Wv(n)?oU():iU(n)))),DT,t?.shutdown?sd(ic(e)):ee),wU=(...e)=>bU(e),yu=d(2,(e,t)=>new Je(p(He(e),Al(i_(t))))),vU=d(3,(e,t,n)=>km(()=>{const r=s=>Mc({onInput:o=>p(tt(()=>{const i=[],c=a=>Qe(()=>{i.push(a)});return p(o,EL(s,(a,u)=>p(n(a,u),X(([l,f])=>p(c(f),cs(l))))),$k({onFailure:a=>i.length!==0?Ol(Re(rn(i)),Ar(a)):Ar(a),onSuccess:a=>Te(Re(rn(i)),()=>r(a))}))}),nn),onFailure:Ar,onDone:()=>Mt});return new Je(p(He(e),IT(r(t))))})),HT=d(2,(e,t)=>new Je(p(He(e),Al(t)))),id=d(2,(e,t)=>{const n=r=>{const s=r.next();if(s.done)return Jn({onInput:o=>n(o[Symbol.iterator]()),onFailure:bt,onDone:am});{const o=s.value;return nn(j(t(o),i=>Te(Re(Be(i)),()=>n(r))))}};return new Je(p(He(e),Ft(Cl(()=>n(We()[Symbol.iterator]())))))}),kU=d(3,(e,t,n)=>new Je(p(He(e),mu(Rl),TD(n,t),Al(Be)))),TU=d(e=>bm(e[1]),(e,t,n)=>EU(e,t,{onSelf:ee,onOther:ee,haltStrategy:n?.haltStrategy})),EU=d(3,(e,t,n)=>{const r=n.haltStrategy?XD(n.haltStrategy):ZD,s=o=>i=>o||!Ga(i)?UD(tt(()=>i)):KD(c=>tt(()=>c));return new Je(CT(He(yu(e,n.onSelf)),{other:He(yu(t,n.onOther)),onSelfDone:s(r._tag==="Either"||r._tag==="Left"),onOtherDone:s(r._tag==="Either"||r._tag==="Right")}))}),CU=e=>IU(p(e,kl(U))),DT=e=>BU(e,t=>p(j(t,n=>U([n,t])),Ve(xe({onNone:()=>z(K()),onSome:Ct})))),IU=e=>DT(p(e,j(Be))),vm=d(2,(e,t)=>He(e).pipe(IT(mm(t)),$D)),$U=e=>vm(e,BD),AU=d(2,(e,t)=>vm(e,LD(t))),RU=e=>vm(e,DD()),OU=d(2,(e,t)=>mU(PU(e,t,{onElement:U,onSchedule:K}),ee)),PU=d(3,(e,t,n)=>{const r=(s,o)=>{const i=o.next();return i.done?Jn({onInput:c=>r(s,c[Symbol.iterator]()),onFailure:bt,onDone:Vn}):nn(BL(s.next(i.value),{onFailure:()=>p(s.last,ML,j(c=>p(Re(da(n.onElement(i.value),n.onSchedule(c))),Te(()=>r(s,o)))),Tl(s.reset)),onSuccess:()=>z(p(Re(Be(n.onElement(i.value))),Te(()=>r(s,o))))}))};return new Je(p(kt(jD(t)),Te(s=>p(He(e),Ft(r(s,We()[Symbol.iterator]()))))))}),FU=d(3,(e,t,n)=>new Je(p(Re(Be(t)),Te(()=>He(p(e,vU(t,(r,s)=>p(n(r,s),j(o=>[o,o]))))))))),UT=e=>new Je(kT($T(p(e,j(Be))),me)),xU=e=>new Je(AT(t=>e(t).pipe(j(Be)))),km=e=>new Je(Cl(()=>He(e()))),NU=d(2,(e,t)=>id(e,n=>cs(t(n),n))),BU=(e,t)=>km(()=>{const n=r=>nn(j(t(r),xe({onNone:()=>Mt,onSome:([s,o])=>Te(Re(s),()=>n(o))})));return new Je(n(e))}),MU=e=>wm(xl(e)),LU=e=>wm(UT(e)),HU=e=>wm(xU(t=>e(t))),DU="effect/GroupBy",KT=Symbol.for(DU),UU={_R:e=>e,_E:e=>e,_K:e=>e,_V:e=>e},KU=e=>te(e,KT),jU=d(e=>KU(e[0]),(e,t,n)=>Fl(e.grouped,([r,s])=>t(r,BT(gu(s,{shutdown:!0}))),{concurrency:"unbounded",bufferSize:n?.bufferSize??16})),zU=e=>({[KT]:UU,pipe(){return G(this,arguments)},grouped:e}),VU=d(e=>typeof e[0]!="function",(e,t,n)=>n?.key?jU(qU(e,n.key,{bufferSize:n.bufferSize}),(r,s)=>id(s,t)):od(n?.concurrency,()=>id(e,t),r=>n?.unordered?Fl(e,s=>xl(t(s)),{concurrency:r}):kU(e,r,t))),qU=d(e=>typeof e[0]!="function",(e,t,n)=>{const r=(s,o)=>Jn({onInput:i=>Te(kt(vn(WU(i,t),([c,a])=>{const u=s.get(c);return u===void 0?p(om(n?.bufferSize??16),X(l=>p(Qe(()=>{s.set(c,l)}),Ce(Ut(o,sU([c,l]))),Ce(p(Ut(l,Py(a)),df(f=>lf(f)?U(me):K())))))):df(Ut(u,Py(a)),l=>lf(l)?U(me):K())},{discard:!0})),()=>r(s,o)),onFailure:i=>kt(Ut(o,rU(i))),onDone:()=>kt(p(vn(s.entries(),([i,c])=>p(Ut(c,Fy),df(a=>lf(a)?U(me):K())),{discard:!0}),Ce(Ut(o,Fy))))});return zU(HU(s=>$(function*(){const o=new Map,i=yield*Dk();return yield*sc(s,ic(i)),yield*He(e).pipe(Ft(r(o,i)),hm,dT(s),Hn(s),cs(BT(gu(i,{shutdown:!0}))))})))}),WU=d(2,(e,t)=>{const n=[],r=e[Symbol.iterator](),s=new Map;let o;for(;(o=r.next())&&!o.done;){const i=o.value,c=t(i);if(s.has(c))s.get(c).push(i);else{const a=[i];n.push([c,a]),s.set(c,a)}}return rn(n.map(i=>[i[0],rn(i[1])]))});class Nt{path;actual;issue;_tag="Pointer";constructor(t,n,r){this.path=t,this.actual=n,this.issue=r}}class Ny{actual;message;_tag="Unexpected";constructor(t,n){this.actual=t,this.message=n}}class mi{ast;message;_tag="Missing";actual=void 0;constructor(t,n){this.ast=t,this.message=n}}class nt{ast;actual;issues;output;_tag="Composite";constructor(t,n,r,s){this.ast=t,this.actual=n,this.issues=r,this.output=s}}class vf{ast;actual;kind;issue;_tag="Refinement";constructor(t,n,r,s){this.ast=t,this.actual=n,this.kind=r,this.issue=s}}class kf{ast;actual;kind;issue;_tag="Transformation";constructor(t,n,r,s){this.ast=t,this.actual=n,this.kind=r,this.issue=s}}class tr{ast;actual;message;_tag="Type";constructor(t,n,r){this.ast=t,this.actual=n,this.message=r}}class By{ast;actual;message;_tag="Forbidden";constructor(t,n,r){this.ast=t,this.actual=n,this.message=r}}const My=Symbol.for("effect/Schema/ParseErrorTypeId");class JU extends Q2("ParseError"){[My]=My;get message(){return this.toString()}toString(){return va.formatIssueSync(this.issue)}toJSON(){return{_id:"ParseError",message:this.toString()}}[Me](){return this.toJSON()}}const GU=e=>new JU({issue:e}),Ho=pe,Tm=re,Ht=HC,Er=d(2,(e,t)=>Ht(e)?Kt(e,{onLeft:re,onRight:t}):X(e,t)),Xt=d(2,(e,t)=>Ht(e)?KC(e,t):j(e,t)),Tf=d(2,(e,t)=>Ht(e)?UC(e,t):kl(e,t)),YU=d(2,(e,t)=>Ht(e)?DC(e,{onLeft:t.onFailure,onRight:t.onSuccess}):$L(e,t)),jT=d(2,(e,t)=>Ht(e)?Kt(e,{onLeft:t,onRight:pe}):Ve(e,t)),Nl=(e,t)=>t===void 0||hr(t)?e:e===void 0?t:{...e,...t},QU=(e,t,n)=>{const r=wt(e,t);return(s,o)=>r(s,Nl(n,o))},zT=(e,t,n)=>{const r=QU(e,t,n);return(s,o)=>ob(r(s,o),GU)},VT=(e,t,n)=>{const r=wt(e,t);return(s,o)=>r(s,{...Nl(n,o),isEffectAllowed:!0})},XU=(e,t)=>zT(e.ast,!0,t),ZU=(e,t)=>VT(e.ast,!0,t),qT=(e,t)=>VT(e.ast,!1,t),WT=(e,t)=>zT(ut(e.ast),!0,t),eK=(e,t)=>{const n=wt(ut(e.ast),!0);return(r,s)=>Pn(n(r,{exact:!0,...Nl(t,s)}))},tK=be(Symbol.for("effect/ParseResult/decodeMemoMap"),()=>new WeakMap),nK=be(Symbol.for("effect/ParseResult/encodeMemoMap"),()=>new WeakMap),wt=(e,t)=>{const n=t?tK:nK,r=n.get(e);if(r)return r;const s=rK(e,t),o=DI(e),i=$e(o)?(u,l)=>s(u,Nl(l,o.value)):s,c=UI(e),a=t&&$e(c)?(u,l)=>Ei(jT(i(u,l),c.value),e,u,l):i;return n.set(e,a),a},Ef=e=>An(MI(e)),Cf=e=>An(LI(e)),rK=(e,t)=>{switch(e._tag){case"Refinement":if(t){const n=wt(e.from,!0);return(r,s)=>{s=s??ef;const o=s?.errors==="all",i=Er(jT(n(r,s),c=>{const a=new vf(e,r,"From",c);return o&&jI(e)&&QT(c)?xe(e.filter(r,s,e),{onNone:()=>re(a),onSome:u=>re(new nt(e,r,[a,new vf(e,r,"Predicate",u)]))}):re(a)}),c=>xe(e.filter(c,s,e),{onNone:()=>pe(c),onSome:a=>re(new vf(e,r,"Predicate",a))}));return Ei(i,e,r,s)}}else{const n=wt(ut(e),!0),r=wt(JT(e.from),!1);return(s,o)=>Ei(Er(n(s,o),i=>r(i,o)),e,s,o)}case"Transformation":{const n=iK(e.transformation,t),r=t?wt(e.from,!0):wt(e.to,!1),s=t?wt(e.to,!0):wt(e.from,!1);return(o,i)=>Ei(Er(Tf(r(o,i),c=>new kf(e,o,t?"Encoded":"Type",c)),c=>Er(Tf(n(c,i??ef,e,o),a=>new kf(e,o,"Transformation",a)),a=>Tf(s(a,i),u=>new kf(e,o,t?"Type":"Encoded",u)))),e,o,i)}case"Declaration":{const n=t?e.decodeUnknown(...e.typeParameters):e.encodeUnknown(...e.typeParameters);return(r,s)=>Ei(n(r,s??ef,e),e,r,s)}case"Literal":return Qt(e,n=>n===e.literal);case"UniqueSymbol":return Qt(e,n=>n===e.symbol);case"UndefinedKeyword":return Qt(e,XE);case"NeverKeyword":return Qt(e,eC);case"UnknownKeyword":case"AnyKeyword":case"VoidKeyword":return pe;case"StringKeyword":return Qt(e,mn);case"NumberKeyword":return Qt(e,hr);case"BooleanKeyword":return Qt(e,Di);case"BigIntKeyword":return Qt(e,vu);case"SymbolKeyword":return Qt(e,jf);case"ObjectKeyword":return Qt(e,mr);case"Enums":return Qt(e,n=>e.enums.some(([r,s])=>s===n));case"TemplateLiteral":{const n=b$(e);return Qt(e,r=>mn(r)&&n.test(r))}case"TupleType":{const n=e.elements.map(u=>wt(u.type,t)),r=e.rest.map(u=>wt(u.type,t));let s=e.elements.filter(u=>!u.isOptional);e.rest.length>0&&(s=s.concat(e.rest.slice(1)));const o=s.length,i=e.elements.length>0?e.elements.map((u,l)=>l).join(" | "):"never",c=Ef(e),a=Cf(e);return(u,l)=>{if(!aI(u))return re(new tr(e,u));const f=l?.errors==="all",h=[];let m=0;const y=[],b=u.length;for(let v=b;v<=o-1;v++){const T=new Nt(v,u,new mi(s[v-b]));if(f){h.push([m++,T]);continue}else return re(new nt(e,u,T,y))}if(e.rest.length===0)for(let v=e.elements.length;v<=b-1;v++){const T=new Nt(v,u,new Ny(u[v],`is unexpected, expected: ${i}`));if(f){h.push([m++,T]);continue}else return re(new nt(e,u,T,y))}let _=0,k;for(;_<n.length;_++)if(b<_+1){if(e.elements[_].isOptional)continue}else{const v=n[_],T=v(u[_],l);if(Ht(T)){if(vt(T)){const R=new Nt(_,u,T.left);if(f){h.push([m++,R]);continue}else return re(new nt(e,u,R,gn(y)))}y.push([m++,T.right])}else{const R=m++,w=_;k||(k=[]),k.push(({es:I,output:O})=>X(Hs(T),H=>{if(vt(H)){const F=new Nt(w,u,H.left);return f?(I.push([R,F]),me):re(new nt(e,u,F,gn(O)))}return O.push([R,H.right]),me}))}}if(_t(r)){const[v,...T]=r;for(;_<b-T.length;_++){const R=v(u[_],l);if(Ht(R))if(vt(R)){const w=new Nt(_,u,R.left);if(f){h.push([m++,w]);continue}else return re(new nt(e,u,w,gn(y)))}else y.push([m++,R.right]);else{const w=m++,I=_;k||(k=[]),k.push(({es:O,output:H})=>X(Hs(R),F=>{if(vt(F)){const E=new Nt(I,u,F.left);return f?(O.push([w,E]),me):re(new nt(e,u,E,gn(H)))}else return H.push([w,F.right]),me}))}}for(let R=0;R<T.length;R++)if(_+=R,!(b<_+1)){const w=T[R](u[_],l);if(Ht(w)){if(vt(w)){const I=new Nt(_,u,w.left);if(f){h.push([m++,I]);continue}else return re(new nt(e,u,I,gn(y)))}y.push([m++,w.right])}else{const I=m++,O=_;k||(k=[]),k.push(({es:H,output:F})=>X(Hs(w),E=>{if(vt(E)){const V=new Nt(O,u,E.left);return f?(H.push([I,V]),me):re(new nt(e,u,V,gn(F)))}return F.push([I,E.right]),me}))}}}const C=({es:v,output:T})=>fa(v)?re(new nt(e,u,gn(v),gn(T))):pe(gn(T));if(k&&k.length>0){const v=k;return tt(()=>{const T={es:bi(h),output:bi(y)};return X(vn(v,R=>R(T),{concurrency:c,batching:a,discard:!0}),()=>C(T))})}return C({output:y,es:h})}}case"TypeLiteral":{if(e.propertySignatures.length===0&&e.indexSignatures.length===0)return Qt(e,tC);const n=[],r={},s=[];for(const l of e.propertySignatures)n.push([wt(l.type,t),l]),r[l.name]=null,s.push(l.name);const o=e.indexSignatures.map(l=>[wt(l.parameter,t),wt(l.type,t),l.parameter]),i=Sn.make(e.indexSignatures.map(l=>l.parameter).concat(s.map(l=>jf(l)?new WI(l):new Ua(l)))),c=wt(i,t),a=Ef(e),u=Cf(e);return(l,f)=>{if(!rC(l))return re(new tr(e,l));const h=f?.errors==="all",m=[];let y=0;const b=f?.onExcessProperty==="error",_=f?.onExcessProperty==="preserve",k={};let C;if(b||_){C=Reflect.ownKeys(l);for(const w of C){const I=c(w,f);if(Ht(I)&&vt(I))if(b){const O=new Nt(w,l,new Ny(l[w],`is unexpected, expected: ${String(i)}`));if(h){m.push([y++,O]);continue}else return re(new nt(e,l,O,k))}else k[w]=l[w]}}let v;const T=f?.exact===!0;for(let w=0;w<n.length;w++){const I=n[w][1],O=I.name,H=Object.prototype.hasOwnProperty.call(l,O);if(!H){if(I.isOptional)continue;if(T){const V=new Nt(O,l,new mi(I));if(h){m.push([y++,V]);continue}else return re(new nt(e,l,V,k))}}const F=n[w][0],E=F(l[O],f);if(Ht(E)){if(vt(E)){const V=new Nt(O,l,H?E.left:new mi(I));if(h){m.push([y++,V]);continue}else return re(new nt(e,l,V,k))}k[O]=E.right}else{const V=y++,q=O;v||(v=[]),v.push(({es:D,output:B})=>X(Hs(E),x=>{if(vt(x)){const ce=new Nt(q,l,H?x.left:new mi(I));return h?(D.push([V,ce]),me):re(new nt(e,l,ce,B))}return B[q]=x.right,me}))}}for(let w=0;w<o.length;w++){const I=o[w],O=I[0],H=I[1],F=mb(l,I[2]);for(const E of F){const V=O(E,f);if(Ht(V)&&Pn(V)){const q=H(l[E],f);if(Ht(q))if(vt(q)){const D=new Nt(E,l,q.left);if(h){m.push([y++,D]);continue}else return re(new nt(e,l,D,k))}else Object.prototype.hasOwnProperty.call(r,E)||(k[E]=q.right);else{const D=y++,B=E;v||(v=[]),v.push(({es:x,output:ce})=>X(Hs(q),je=>{if(vt(je)){const Vt=new Nt(B,l,je.left);return h?(x.push([D,Vt]),me):re(new nt(e,l,Vt,ce))}else return Object.prototype.hasOwnProperty.call(r,E)||(ce[E]=je.right),me}))}}}}const R=({es:w,output:I})=>{if(fa(w))return re(new nt(e,l,gn(w),I));if(f?.propertyOrder==="original"){const O=C||Reflect.ownKeys(l);for(const F of s)O.indexOf(F)===-1&&O.push(F);const H={};for(const F of O)Object.prototype.hasOwnProperty.call(I,F)&&(H[F]=I[F]);return pe(H)}return pe(I)};if(v&&v.length>0){const w=v;return tt(()=>{const I={es:bi(m),output:Object.assign({},k)};return X(vn(w,O=>O(I),{concurrency:a,batching:u,discard:!0}),()=>R(I))})}return R({es:m,output:k})}}case"Union":{const n=sK(e.types,t),r=Reflect.ownKeys(n.keys),s=r.length,o=e.types.length,i=new Map;for(let u=0;u<o;u++)i.set(e.types[u],wt(e.types[u],t));const c=Ef(e)??1,a=Cf(e);return(u,l)=>{const f=[];let h=0,m=[];if(s>0)if(_d(u))for(let _=0;_<s;_++){const k=r[_],C=n.keys[k].buckets;if(Object.prototype.hasOwnProperty.call(u,k)){const v=String(u[k]);if(Object.prototype.hasOwnProperty.call(C,v))m=m.concat(C[v]);else{const{candidates:T,literals:R}=n.keys[k],w=Sn.make(R),I=T.length===o?new Ir([new It(k,w,!1,!0)],[]):Sn.make(T);f.push([h++,new nt(I,u,new Nt(k,u,new tr(w,u[k])))])}}else{const{candidates:v,literals:T}=n.keys[k],R=new It(k,Sn.make(T),!1,!0),w=v.length===o?new Ir([R],[]):Sn.make(v);f.push([h++,new nt(w,u,new Nt(k,u,new mi(R)))])}}else{const _=n.candidates.length===o?e:Sn.make(n.candidates);f.push([h++,new tr(_,u)])}n.otherwise.length>0&&(m=m.concat(n.otherwise));let y;for(let _=0;_<m.length;_++){const k=m[_],C=i.get(k)(u,l);if(Ht(C)&&(!y||y.length===0)){if(Pn(C))return C;f.push([h++,C.left])}else{const v=h++;y||(y=[]),y.push(T=>tt(()=>"finalResult"in T?me:X(Hs(C),R=>(Pn(R)?T.finalResult=R:T.es.push([v,R.left]),me))))}}const b=_=>fa(_)?_.length===1&&_[0][1]._tag==="Type"?re(_[0][1]):re(new nt(e,u,gn(_))):re(new tr(e,u));if(y&&y.length>0){const _=y;return tt(()=>{const k={es:bi(f)};return X(vn(_,C=>C(k),{concurrency:c,batching:a,discard:!0}),()=>"finalResult"in k?k.finalResult:b(k.es))})}return b(f)}}case"Suspend":{const n=gb(()=>wt(e.f(),t));return(r,s)=>n()(r,s)}}},Qt=(e,t)=>n=>t(n)?pe(n):re(new tr(e,n)),Ti=(e,t)=>{switch(e._tag){case"Declaration":{const n=Bb(e);if($e(n))return Ti(n.value,t);break}case"TypeLiteral":{const n=[];for(let r=0;r<e.propertySignatures.length;r++){const s=e.propertySignatures[r],o=t?Xf(s.type):ut(s.type);Oi(o)&&!s.isOptional&&n.push([s.name,o])}return n}case"TupleType":{const n=[];for(let r=0;r<e.elements.length;r++){const s=e.elements[r],o=t?Xf(s.type):ut(s.type);Oi(o)&&!s.isOptional&&n.push([r,o])}return n}case"Refinement":return Ti(e.from,t);case"Suspend":return Ti(e.f(),t);case"Transformation":return Ti(t?e.from:e.to,t)}return[]},sK=(e,t)=>{const n={},r=[],s=[];for(let o=0;o<e.length;o++){const i=e[o],c=Ti(i,t);if(c.length>0){s.push(i);for(let a=0;a<c.length;a++){const[u,l]=c[a],f=String(l.literal);n[u]=n[u]||{buckets:{},literals:[],candidates:[]};const h=n[u].buckets;if(Object.prototype.hasOwnProperty.call(h,f)){if(a<c.length-1)continue;h[f].push(i),n[u].literals.push(l),n[u].candidates.push(i)}else{h[f]=[i],n[u].literals.push(l),n[u].candidates.push(i);break}}}else r.push(i)}return{keys:n,otherwise:r,candidates:s}},JT=e=>so(e)?JT(e.from):e,Ei=(e,t,n,r)=>{if(r?.isEffectAllowed===!0||Ht(e))return e;const s=new Sv,o=Zr(e,{scheduler:s});s.flush();const i=o.unsafePoll();if(i){if(Ga(i))return pe(i.value);const c=i.cause;return $M(c)?re(c.error):re(new By(t,n,FM(c)))}return re(new By(t,n,"cannot be be resolved synchronously, this is caused by using runSync on an effect that performs async work"))},oK=([e],[t])=>e>t?1:e<t?-1:0;function gn(e){return e.sort(oK).map(t=>t[1])}const iK=(e,t)=>{switch(e._tag){case"FinalTransformation":return t?e.decode:e.encode;case"ComposeTransformation":return pe;case"TypeLiteralTransformation":return n=>{let r=pe(n);for(const s of e.propertySignatureTransformations){const[o,i]=t?[s.from,s.to]:[s.to,s.from],c=t?s.decode:s.encode;r=Xt(r,u=>{const l=c(Object.prototype.hasOwnProperty.call(u,o)?U(u[o]):K());return delete u[o],$e(l)&&(u[i]=l.value),u})}return r}}},Lt=(e,t=[])=>({value:e,forest:t}),va={formatIssue:e=>Xt(Ws(e),cK),formatIssueSync:e=>{const t=va.formatIssue(e);return Ht(t)?zC(t):HL(t)},formatError:e=>va.formatIssue(e.issue),formatErrorSync:e=>va.formatIssueSync(e.issue)},cK=e=>e.value+GT(`
`,e.forest),GT=(e,t)=>{let n="";const r=t.length;let s;for(let o=0;o<r;o++){s=t[o];const i=o===r-1;n+=e+(i?"":"")+" "+s.value,n+=GT(e+(r>1&&!i?"  ":"   "),s.forest)}return n},aK=e=>{switch(e){case"Encoded":return"Encoded side transformation failure";case"Transformation":return"Transformation process failure";case"Type":return"Type side transformation failure"}},uK=e=>{switch(e){case"From":return"From side refinement failure";case"Predicate":return"Predicate refinement failure"}},YT=e=>"ast"in e?U(e.ast):K(),cd=pe(void 0),lK=e=>YT(e).pipe(qo(NI),xe({onNone:()=>cd,onSome:t=>{const n=t(e);return mn(n)?pe({message:n,override:!1}):ri(n)?j(n,r=>({message:r,override:!1})):mn(n.message)?pe({message:n.message,override:n.override}):j(n.message,r=>({message:r,override:n.override}))}})),Em=e=>t=>t._tag===e,QT=Em("Composite"),Ly=Em("Refinement"),Hy=Em("Transformation"),Ni=e=>Er(lK(e),t=>t!==void 0?!t.override&&(QT(e)||Ly(e)&&e.kind==="From"||Hy(e)&&e.kind!=="Transformation")?Hy(e)||Ly(e)?Ni(e.issue):cd:pe(t.message):cd),XT=e=>YT(e).pipe(qo(HI),YC(t=>t(e)),An);function fK(e){return Nb(e).pipe(or(()=>Fb(e)),or(()=>xb(e)),or(()=>Au(e)),qe(()=>`{ ${e.from} | filter }`))}function hK(e){return e.message!==void 0?e.message:`Expected ${so(e.ast)?fK(e.ast):String(e.ast)}, actual ${Lr(e.actual)}`}const dK=e=>Xt(Ni(e),t=>t??XT(e)??hK(e)),Zc=e=>XT(e)??String(e.ast),pK=e=>e.message??"is forbidden",mK=e=>e.message??"is unexpected",gK=e=>{const t=BI(e.ast);if($e(t)){const n=t.value();return mn(n)?pe(n):n}return pe(e.message??"is missing")},Ws=e=>{switch(e._tag){case"Type":return Xt(dK(e),Lt);case"Forbidden":return pe(Lt(Zc(e),[Lt(pK(e))]));case"Unexpected":return pe(Lt(mK(e)));case"Missing":return Xt(gK(e),Lt);case"Transformation":return Er(Ni(e),t=>t!==void 0?pe(Lt(t)):Xt(Ws(e.issue),n=>Lt(Zc(e),[Lt(aK(e.kind),[n])])));case"Refinement":return Er(Ni(e),t=>t!==void 0?pe(Lt(t)):Xt(Ws(e.issue),n=>Lt(Zc(e),[Lt(uK(e.kind),[n])])));case"Pointer":return Xt(Ws(e.issue),t=>Lt(Sb(e.path),[t]));case"Composite":return Er(Ni(e),t=>{if(t!==void 0)return pe(Lt(t));const n=Zc(e);return yb(e.issues)?Xt(vn(e.issues,Ws),r=>Lt(n,r)):Xt(Ws(e.issues),r=>Lt(n,[r]))})}},yK=d(e=>mr(e[0]),(e,...t)=>{const n={};for(const r of t)r in e&&(n[r]=e[r]);return n}),SK=d(e=>mr(e[0]),(e,...t)=>{const n={...e};for(const r of t)delete n[r];return n}),Do=Symbol.for("effect/Schema");function at(e){return class{[Do]=ad;static ast=e;static annotations(n){return at(Sr(this.ast,n))}static pipe(){return G(this,arguments)}static toString(){return String(e)}static Type;static Encoded;static Context;static[Do]=ad}}const ad={_A:e=>e,_I:e=>e,_R:e=>e},Dy={typeConstructor:AI,schemaId:OI,message:wb,missingMessage:xd,identifier:$u,title:Wn,description:Jo,examples:vb,default:kb,documentation:PI,jsonSchema:Tb,arbitrary:Eb,pretty:Cb,equivalence:Ib,concurrency:$b,batching:Ab,parseIssueTitle:Rb,parseOptions:Ob,decodingFallback:Pb},Kc=e=>{if(!e)return{};const t={...e};for(const n in Dy)if(n in e){const r=Dy[n];t[r]=e[n],delete t[n]}return t},Sr=(e,t)=>Hd(e,Kc(t)),bK=e=>at(Xf(e.ast)),$n=e=>at(ut(e.ast)),pr=e=>te(e,Do)&&mr(e[Do]);function _K(e){return Md(e)?Sn.make(l$(e,t=>new Ua(t))):new Ua(e[0])}function ZT(e,t=_K(e)){return class extends at(t){static annotations(r){return ZT(this.literals,Sr(this.ast,r))}static literals=[...e]}}function jc(...e){return _t(e)?ZT(e):r0}const wK=(e,t,n)=>Cm(e,new Ru(e.map(r=>r.ast),(...r)=>t.decode(...r.map(at)),(...r)=>t.encode(...r.map(at)),Kc(n))),vK=(e,t)=>{const n=()=>(s,o,i)=>e(s)?Ho(s):Tm(new tr(i,s)),r=n;return Cm([],new Ru([],n,r,Kc(t)))};function Cm(e,t){return class extends at(t){static annotations(r){return Cm(this.typeParameters,Sr(this.ast,r))}static typeParameters=[...e]}}const e0=function(){if(Array.isArray(arguments[0])){const n=arguments[0],r=arguments[1],s=arguments[2];return wK(n,r,s)}const e=arguments[0],t=arguments[1];return vK(e,t)};class t0 extends at(Vf){}class n0 extends at(qI){}class r0 extends at(Nd){}class Bl extends at(Lb){}class kK extends at(r$){}class g extends at(qf){}class N extends at(Jf){}class ve extends at(Gf){}const TK=e=>Sn.make(e.map(t=>t.ast));function s0(e,t=TK(e)){return class extends at(t){static annotations(r){return s0(this.members,Sr(this.ast,r))}static members=[...e]}}function De(...e){return Md(e)?s0(e):_t(e)?e[0]:r0}const we=e=>De(e,n0),Ci=e=>De(e,t0),If=e=>De(e,n0,t0),EK=(e,t)=>new Bd(e.map(n=>pr(n)?new vs(n.ast,!1):n.ast),t.map(n=>pr(n)?new Ou(n.ast):n.ast),!0);function o0(e,t,n=EK(e,t)){return class extends at(n){static annotations(s){return o0(this.elements,this.rest,Sr(this.ast,s))}static elements=[...e];static rest=[...t]}}function i0(e,t){return class extends o0([],[e],t){static annotations(r){return i0(this.value,Sr(this.ast,r))}static value=e}}const ue=e=>i0(e),ud=e=>e?'"?:"':'":"';class cc extends vs{isReadonly;defaultValue;_tag="PropertySignatureDeclaration";constructor(t,n,r,s,o){super(t,n,s),this.isReadonly=r,this.defaultValue=o}toString(){const t=ud(this.isOptional),n=String(this.type);return`PropertySignature<${t}, ${n}, never, ${t}, ${n}>`}}class c0 extends vs{isReadonly;fromKey;constructor(t,n,r,s,o){super(t,n,s),this.isReadonly=r,this.fromKey=o}}class Ml extends vs{isReadonly;defaultValue;constructor(t,n,r,s,o){super(t,n,s),this.isReadonly=r,this.defaultValue=o}}const CK=e=>e===void 0?"never":mn(e)?JSON.stringify(e):String(e);class Ll{from;to;decode;encode;_tag="PropertySignatureTransformation";constructor(t,n,r,s){this.from=t,this.to=n,this.decode=r,this.encode=s}toString(){return`PropertySignature<${ud(this.to.isOptional)}, ${this.to.type}, ${CK(this.from.fromKey)}, ${ud(this.from.isOptional)}, ${this.from.type}>`}}const a0=(e,t)=>{switch(e._tag){case"PropertySignatureDeclaration":return new cc(e.type,e.isOptional,e.isReadonly,{...e.annotations,...t},e.defaultValue);case"PropertySignatureTransformation":return new Ll(e.from,new Ml(e.to.type,e.to.isOptional,e.to.isReadonly,{...e.to.annotations,...t},e.to.defaultValue),e.decode,e.encode)}},u0=Symbol.for("effect/PropertySignature"),Im=e=>te(e,u0);class Hl{ast;[Do];[u0]=null;_TypeToken;_Key;_EncodedToken;_HasDefault;constructor(t){this.ast=t}pipe(){return G(this,arguments)}annotations(t){return new Hl(a0(this.ast,Kc(t)))}toString(){return String(this.ast)}}const Su=e=>new Hl(e);class Dl extends Hl{from;constructor(t,n){super(t),this.from=n}annotations(t){return new Dl(a0(this.ast,Kc(t)),this.from)}}const ea=d(2,(e,t)=>{const n=e.ast;switch(n._tag){case"PropertySignatureDeclaration":return Su(new cc(n.type,n.isOptional,n.isReadonly,n.annotations,t));case"PropertySignatureTransformation":return Su(new Ll(n.from,new Ml(n.to.type,n.to.isOptional,n.to.isReadonly,n.to.annotations,t),n.decode,n.encode))}}),_r=(e,t,n)=>Su(new Ll(new c0(e.ast,!0,!0,{},void 0),new Ml(t.ast,!1,!0,{},void 0),r=>U(n.decode(r)),qo(n.encode))),Uy=(e,t,n)=>Su(new Ll(new c0(e.ast,!0,!0,{},void 0),new Ml(t.ast,!0,!0,{},void 0),n.decode,n.encode)),IK=(e,t)=>{const n=t?.exact,r=t?.default,s=t?.nullable,o=t?.as=="Option",i=t?.onNoneEncoding?or(t.onNoneEncoding):ee;if(n){if(r)return s?ea(_r(we(e),$n(e),{decode:xe({onNone:r,onSome:c=>c===null?r():c}),encode:U}),r).ast:ea(_r(e,$n(e),{decode:xe({onNone:r,onSome:ee}),encode:U}),r).ast;if(o){const c=zy($n(e));return s?_r(we(e),c,{decode:ai(Yl),encode:i}).ast:_r(e,c,{decode:ee,encode:ee}).ast}else return s?Uy(we(e),$n(e),{decode:ai(Yl),encode:ee}).ast:new cc(e.ast,!0,!0,{},void 0)}else{if(r)return s?ea(_r(If(e),$n(e),{decode:xe({onNone:r,onSome:c=>c??r()}),encode:U}),r).ast:ea(_r(Ci(e),$n(e),{decode:xe({onNone:r,onSome:c=>c===void 0?r():c}),encode:U}),r).ast;if(o){const c=zy($n(e));return s?_r(If(e),c,{decode:ai(a=>a!=null),encode:i}).ast:_r(Ci(e),c,{decode:ai(ZE),encode:i}).ast}else return s?Uy(If(e),Ci($n(e)),{decode:ai(Yl),encode:ee}).ast:new cc(Ci(e).ast,!0,!0,{},void 0)}},S=e=>{const t=e.ast===Vf||e.ast===Nd?Vf:Ci(e).ast;return new Dl(new cc(t,!0,!0,{},void 0),e)},l0=d(e=>pr(e[0]),(e,t)=>new Dl(IK(e,t),e)),$K=qb([xd]),AK=(e,t)=>{const n=Reflect.ownKeys(e),r=[];if(n.length>0){const o=[],i=[],c=[];for(let a=0;a<n.length;a++){const u=n[a],l=e[u];if(Im(l)){const f=l.ast;switch(f._tag){case"PropertySignatureDeclaration":{const h=f.type,m=f.isOptional,y=f.annotations;o.push(new It(u,h,m,!0,$K(f))),i.push(new It(u,ut(h),m,!0,y)),r.push(new It(u,h,m,!0,y));break}case"PropertySignatureTransformation":{const h=f.from.fromKey??u;o.push(new It(h,f.from.type,f.from.isOptional,!0,f.from.annotations)),i.push(new It(u,f.to.type,f.to.isOptional,!0,f.to.annotations)),c.push(new m$(h,u,f.decode,f.encode));break}}}else o.push(new It(u,l.ast,!1,!0)),i.push(new It(u,ut(l.ast),!1,!0)),r.push(new It(u,l.ast,!1,!0))}if(_t(c)){const a=[],u=[];for(const l of t){const{indexSignatures:f,propertySignatures:h}=ag(l.key.ast,l.value.ast);h.forEach(m=>{o.push(m),i.push(new It(m.name,ut(m.type),m.isOptional,m.isReadonly,m.annotations))}),f.forEach(m=>{a.push(m),u.push(new Pu(m.parameter,ut(m.type),m.isReadonly))})}return new Gs(new Ir(o,a,{[ro]:"Struct (Encoded side)"}),new Ir(i,u,{[ro]:"Struct (Type side)"}),new Qf(c))}}const s=[];for(const o of t){const{indexSignatures:i,propertySignatures:c}=ag(o.key.ast,o.value.ast);c.forEach(a=>r.push(a)),i.forEach(a=>s.push(a))}return new Ir(r,s)},f0=(e,t)=>{const n=Reflect.ownKeys(e);for(const r of n){const s=e[r];if(t[r]===void 0&&Im(s)){const o=s.ast,i=o._tag==="PropertySignatureDeclaration"?o.defaultValue:o.to.defaultValue;i!==void 0&&(t[r]=i())}}return t};function $m(e,t,n=AK(e,t)){return class extends at(n){static annotations(s){return $m(this.fields,this.records,Sr(this.ast,s))}static fields={...e};static records=[...t];static make=(s,o)=>{const i=f0(e,{...s});return y0(o)?i:WT(this)(i)};static pick(...s){return A(yK(e,...s))}static omit(...s){return A(SK(e,...s))}}}function A(e,...t){return $m(e,t)}function h0(e,t,n){return class extends $m({},[{key:e,value:t}],n){static annotations(s){return h0(e,t,Sr(this.ast,s))}static key=e;static value=t}}const Ky=e=>h0(e.key,e.value),gi=(e,t,n)=>{if(ig(e)&&ig(t)){const r=[...e.propertySignatures];for(const s of t.propertySignatures){const o=s.name,i=r.findIndex(c=>c.name===o);if(i===-1)r.push(s);else{const{isOptional:c,type:a}=r[i];r[i]=new It(o,bu(a,s.type,n.concat(o)),c,!0)}}return new Ir(r,e.indexSignatures.concat(t.indexSignatures))}throw new Error(bb(e,t,n))},RK=_$([$u]),yi=(e,t)=>t.map(n=>new Kb(n,e.filter,RK(e))),bu=(e,t,n)=>Sn.make(Qn([e],[t],n)),zr=e=>Ld(e)?e.types:[e],Qn=(e,t,n)=>La(e,r=>La(t,s=>{switch(s._tag){case"Literal":{if(mn(s.literal)&&Wf(r)||hr(s.literal)&&rg(r)||Di(s.literal)&&sg(r))return[s];break}case"StringKeyword":{if(s===qf){if(Wf(r)||Oi(r)&&mn(r.literal))return[r];if(so(r))return yi(r,Qn(zr(r.from),[s],n))}else if(r===qf)return[s];break}case"NumberKeyword":{if(s===Jf){if(rg(r)||Oi(r)&&hr(r.literal))return[r];if(so(r))return yi(r,Qn(zr(r.from),[s],n))}else if(r===Jf)return[s];break}case"BooleanKeyword":{if(s===Gf){if(sg(r)||Oi(r)&&Di(r.literal))return[r];if(so(r))return yi(r,Qn(zr(r.from),[s],n))}else if(r===Gf)return[s];break}case"Union":return Qn(zr(r),s.types,n);case"Suspend":return[new Ka(()=>bu(r,s.f(),n))];case"Refinement":return yi(s,Qn(zr(r),zr(s.from),n));case"TypeLiteral":{switch(r._tag){case"Union":return Qn(r.types,[s],n);case"Suspend":return[new Ka(()=>bu(r.f(),s,n))];case"Refinement":return yi(r,Qn(zr(r.from),[s],n));case"TypeLiteral":return[gi(r,s,n)];case"Transformation":{const o=r.transformation,i=gi(r.from,s,n),c=gi(r.to,ut(s),n);switch(o._tag){case"TypeLiteralTransformation":return[new Gs(i,c,new Qf(o.propertySignatureTransformations))];case"ComposeTransformation":return[new Gs(i,c,p$)];case"FinalTransformation":return[new Gs(i,c,new jb((a,u,l,f)=>Xt(o.decode(a,u,l,f),h=>({...a,...h})),(a,u,l,f)=>Xt(o.encode(a,u,l,f),h=>({...a,...h}))))]}}}break}case"Transformation":{if(f$(r)){if(cg(s.transformation)&&cg(r.transformation))return[new Gs(gi(r.from,s.from,n),gi(r.to,s.to,n),new Qf(s.transformation.propertySignatureTransformations.concat(r.transformation.propertySignatureTransformations)))]}else return Qn([s],[r],n);break}}throw new Error(bb(r,s,n))})),OK=d(2,(e,t)=>at(bu(e.ast,t.ast,[]))),PK=Symbol.for("effect/SchemaId/Refine");function d0(e,t,n){return class extends at(n){static annotations(s){return d0(this.from,this.to,Sr(this.ast,s))}static from=e;static to=t}}const ld=d(e=>pr(e[0])&&pr(e[1]),(e,t,n)=>d0(e,t,new Gs(e.ast,t.ast,new jb(n.decode,n.encode)))),FK=d(e=>pr(e[0])&&pr(e[1]),(e,t,n)=>ld(e,t,{strict:!0,decode:(r,s,o,i)=>Ho(n.decode(r,i)),encode:(r,s,o,i)=>Ho(n.encode(r,i))})),xK=(e,t,n,r)=>YU(e,{onFailure:s=>new nt(n,r,s),onSuccess:t}),NK=e=>e._tag==="None"?K():U(e.value),BK=(e,t)=>n=>n.oneof(t,n.record({_tag:n.constant("None")}),n.record({_tag:n.constant("Some"),value:e(n)})).map(NK),MK=e=>xe({onNone:()=>"none()",onSome:t=>`some(${e(t)})`}),jy=e=>(t,n,r)=>WC(t)?Ue(t)?Ho(K()):xK(e(t.value,n),U,r,t):Tm(new tr(r,t)),zy=e=>e0([e],{decode:t=>jy(ZU(t)),encode:t=>jy(qT(t))},{typeConstructor:{_tag:"effect/Option"},pretty:MK,arbitrary:BK,equivalence:XC}),LK=e=>pr(e)||Im(e),p0=e=>Reflect.ownKeys(e).every(t=>LK(e[t])),Am=e=>"fields"in e?e.fields:Am(e[PK]),m0=e=>p0(e)?A(e):pr(e)?e:A(Am(e)),g0=e=>p0(e)?e:Am(e),En=e=>(t,n)=>ka({kind:"Class",identifier:e,schema:m0(t),fields:g0(t),Base:G2,annotations:n}),$f=(e,t)=>{const n={...e};for(const r of Reflect.ownKeys(t)){if(r in e)throw new Error(_b(r));n[r]=t[r]}return n};function y0(e){return Di(e)?e:e?.disableValidation??!1}const Vy=be("effect/Schema/astCache",()=>new WeakMap),HK=e=>e===void 0?[]:Array.isArray(e)?e:[e],ka=({Base:e,annotations:t,disableToString:n,fields:r,identifier:s,kind:o,schema:i})=>{const c=Symbol.for(`effect/Schema/${o}/${s}`),[a,u,l]=HK(t),f=$n(i),h=f.annotations({identifier:s,...a}),m=f.annotations({[ro]:`${s} (Type side)`,...a}),y=i.annotations({[ro]:`${s} (Constructor)`,...a}),b=i.annotations({[ro]:`${s} (Encoded side)`,...l}),_=i.annotations({...l,...a,...u}),k=v=>te(v,c)&&eK(m)(v),C=class extends e{constructor(v={},T=!1){v={...v},v=f0(r,v),y0(T)||(v=WT(y)(v)),super(v,!0)}static[Do]=ad;static get ast(){let v=Vy.get(this);if(v)return v;const T=e0([i],{decode:()=>(R,w,I)=>R instanceof this||k(R)?Ho(R):Tm(new tr(I,R)),encode:()=>(R,w)=>R instanceof this?Ho(R):Xt(qT(m)(R,w),I=>new this(I,!0))},{identifier:s,pretty:R=>w=>`${s}(${R(w)})`,arbitrary:R=>w=>R(w).map(I=>new this(I)),equivalence:ee,[Da]:h.ast,...a});return v=FK(b,T,{strict:!0,decode:R=>new this(R,!0),encode:ee}).annotations({[Da]:_.ast,...u}).ast,Vy.set(this,v),v}static pipe(){return G(this,arguments)}static annotations(v){return at(this.ast).annotations(v)}static toString(){return`(${String(b)} <-> ${s})`}static make(...v){return new this(...v)}static fields={...r};static identifier=s;static extend(v){return(T,R)=>{const w=g0(T),I=m0(T),O=$f(r,w);return ka({kind:o,identifier:v,schema:OK(i,I),fields:O,Base:this,annotations:R})}}static transformOrFail(v){return(T,R,w)=>{const I=$f(r,T);return ka({kind:o,identifier:v,schema:ld(i,$n(A(I)),R),fields:I,Base:this,annotations:w})}}static transformOrFailFrom(v){return(T,R,w)=>{const I=$f(r,T);return ka({kind:o,identifier:v,schema:ld(bK(i),A(I),R),fields:I,Base:this,annotations:w})}}get[c](){return c}};return n!==!0&&Object.defineProperty(C.prototype,"toString",{value(){return`${s}({ ${Reflect.ownKeys(r).map(v=>`${Td(v)}: ${Lr(this[v])}`).join(", ")} })`},configurable:!0,writable:!0}),C},DK=uU,qy=hU,UK=dU,Uo=pU,KK=xl,jK=LT,zK=yu,Wy=VU,Jy=TU,S0=CU,fr=$U,qn=AU,VK=RU,qK=FU,b0=OU,us=NU,Gy=Symbol.for("effect/Subscribable"),WK=sk,JK="effect/SubscriptionRef",GK=Symbol.for(JK),YK={_A:e=>e};class QK extends ni{ref;pubsub;semaphore;[Bo]=Bo;[Gy]=Gy;[QF]=Ep;[WK]=ok;[GK]=YK;constructor(t,n,r){super(),this.ref=t,this.pubsub=n,this.semaphore=r,this.get=Fi(this.ref)}commit(){return this.get}get;get changes(){return p(Fi(this.ref),X(t=>j(LT(this.pubsub,{scoped:!0}),n=>fU(wU(t),n))),this.semaphore.withPermits(1),LU)}modify(t){return this.modifyEffect(n=>z(t(n)))}modifyEffect(t){return p(Fi(this.ref),X(t),X(([n,r])=>p(Ww(this.ref,r),cs(n),Tl(sm(this.pubsub,r)))),this.semaphore.withPermits(1))}}const XK=e=>Fi(e.ref),ZK=e=>p(ze([Hk(),Ip(e),em(1)]),j(([t,n,r])=>new QK(n,t,r))),ej=d(2,(e,t)=>p(Ww(e.ref,t),Tl(sm(e.pubsub,t)),e.semaphore.withPermits(1))),Bt=XK,$t=ZK,Rt=ej,en=Jw;function tj(){if(typeof globalThis>"u")return;const e=globalThis.localStorage;if(e)try{const t=e.getItem("__CHAIN_EFFECT_DEBUG__");if(t===null)return;const n=t.trim();return n.length===0?void 0:n==="true"||n==="1"?!0:n==="false"||n==="0"?!1:n}catch{return}}function nj(){if(typeof globalThis>"u")return;const t=globalThis.__CHAIN_EFFECT_DEBUG__;if(typeof t=="boolean")return t;if(typeof t=="string")return t.trim()===""?void 0:t}function rj(e){if(!e.startsWith("/"))return null;const t=e.lastIndexOf("/");if(t<=0)return null;const n=e.slice(1,t),r=e.slice(t+1);try{return new RegExp(n,r)}catch{return null}}function sj(e){const t=nj()??tj();if(t===!0)return!0;if(!t)return!1;const n=rj(t);return n?n.test(e):e.includes(t)}function oj(){if(typeof globalThis>"u")return null;const t=globalThis.__CHAIN_EFFECT_LOG__;return typeof t=="function"?t:null}function Bn(e){if(e instanceof Error)return e.message;if(typeof e=="string")return e;try{return JSON.stringify(e)}catch{return String(e)}}function dt(e,...t){if(!sj(e))return;const n=oj();n&&n("[chain-effect]",e,...t)}class ij{constructor(){this.keyToValue=new Map,this.valueToKey=new Map}set(t,n){this.keyToValue.set(t,n),this.valueToKey.set(n,t)}getByKey(t){return this.keyToValue.get(t)}getByValue(t){return this.valueToKey.get(t)}clear(){this.keyToValue.clear(),this.valueToKey.clear()}}class _0{constructor(t){this.generateIdentifier=t,this.kv=new ij}register(t,n){this.kv.getByValue(t)||(n||(n=this.generateIdentifier(t)),this.kv.set(n,t))}clear(){this.kv.clear()}getIdentifier(t){return this.kv.getByValue(t)}getValue(t){return this.kv.getByKey(t)}}class cj extends _0{constructor(){super(t=>t.name),this.classToAllowedProps=new Map}register(t,n){typeof n=="object"?(n.allowProps&&this.classToAllowedProps.set(t,n.allowProps),super.register(t,n.identifier)):super.register(t,n)}getAllowedProps(t){return this.classToAllowedProps.get(t)}}function aj(e){if("values"in Object)return Object.values(e);const t=[];for(const n in e)e.hasOwnProperty(n)&&t.push(e[n]);return t}function uj(e,t){const n=aj(e);if("find"in n)return n.find(t);const r=n;for(let s=0;s<r.length;s++){const o=r[s];if(t(o))return o}}function Ko(e,t){Object.entries(e).forEach(([n,r])=>t(r,n))}function Ta(e,t){return e.indexOf(t)!==-1}function Yy(e,t){for(let n=0;n<e.length;n++){const r=e[n];if(t(r))return r}}class lj{constructor(){this.transfomers={}}register(t){this.transfomers[t.name]=t}findApplicable(t){return uj(this.transfomers,n=>n.isApplicable(t))}findByName(t){return this.transfomers[t]}}const fj=e=>Object.prototype.toString.call(e).slice(8,-1),w0=e=>typeof e>"u",hj=e=>e===null,ac=e=>typeof e!="object"||e===null||e===Object.prototype?!1:Object.getPrototypeOf(e)===null?!0:Object.getPrototypeOf(e)===Object.prototype,fd=e=>ac(e)&&Object.keys(e).length===0,Br=e=>Array.isArray(e),dj=e=>typeof e=="string",pj=e=>typeof e=="number"&&!isNaN(e),mj=e=>typeof e=="boolean",gj=e=>e instanceof RegExp,uc=e=>e instanceof Map,lc=e=>e instanceof Set,v0=e=>fj(e)==="Symbol",yj=e=>e instanceof Date&&!isNaN(e.valueOf()),k0=e=>e instanceof Error,Qy=e=>typeof e=="number"&&isNaN(e),Sj=e=>mj(e)||hj(e)||w0(e)||pj(e)||dj(e)||v0(e),bj=e=>typeof e=="bigint",_j=e=>e===1/0||e===-1/0,wj=e=>ArrayBuffer.isView(e)&&!(e instanceof DataView),vj=e=>e instanceof URL,hd=e=>e.replace(/\\/g,"\\\\").replace(/\./g,"\\."),Af=e=>e.map(String).map(hd).join("."),Bi=(e,t)=>{const n=[];let r="";for(let o=0;o<e.length;o++){let i=e.charAt(o);if(!t&&i==="\\"){const u=e.charAt(o+1);if(u==="\\"){r+="\\",o++;continue}else if(u!==".")throw Error("invalid path")}if(i==="\\"&&e.charAt(o+1)==="."){r+=".",o++;continue}if(i==="."){n.push(r),r="";continue}r+=i}const s=r;return n.push(s),n};function Cn(e,t,n,r){return{isApplicable:e,annotation:t,transform:n,untransform:r}}const T0=[Cn(w0,"undefined",()=>null,()=>{}),Cn(bj,"bigint",e=>e.toString(),e=>typeof BigInt<"u"?BigInt(e):(console.error("Please add a BigInt polyfill."),e)),Cn(yj,"Date",e=>e.toISOString(),e=>new Date(e)),Cn(k0,"Error",(e,t)=>{const n={name:e.name,message:e.message};return"cause"in e&&(n.cause=e.cause),t.allowedErrorProps.forEach(r=>{n[r]=e[r]}),n},(e,t)=>{const n=new Error(e.message,{cause:e.cause});return n.name=e.name,n.stack=e.stack,t.allowedErrorProps.forEach(r=>{n[r]=e[r]}),n}),Cn(gj,"regexp",e=>""+e,e=>{const t=e.slice(1,e.lastIndexOf("/")),n=e.slice(e.lastIndexOf("/")+1);return new RegExp(t,n)}),Cn(lc,"set",e=>[...e.values()],e=>new Set(e)),Cn(uc,"map",e=>[...e.entries()],e=>new Map(e)),Cn(e=>Qy(e)||_j(e),"number",e=>Qy(e)?"NaN":e>0?"Infinity":"-Infinity",Number),Cn(e=>e===0&&1/e===-1/0,"number",()=>"-0",Number),Cn(vj,"URL",e=>e.toString(),e=>new URL(e))];function Ul(e,t,n,r){return{isApplicable:e,annotation:t,transform:n,untransform:r}}const E0=Ul((e,t)=>v0(e)?!!t.symbolRegistry.getIdentifier(e):!1,(e,t)=>["symbol",t.symbolRegistry.getIdentifier(e)],e=>e.description,(e,t,n)=>{const r=n.symbolRegistry.getValue(t[1]);if(!r)throw new Error("Trying to deserialize unknown symbol");return r}),kj=[Int8Array,Uint8Array,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Float64Array,Uint8ClampedArray].reduce((e,t)=>(e[t.name]=t,e),{}),C0=Ul(wj,e=>["typed-array",e.constructor.name],e=>[...e],(e,t)=>{const n=kj[t[1]];if(!n)throw new Error("Trying to deserialize unknown typed array");return new n(e)});function I0(e,t){return e?.constructor?!!t.classRegistry.getIdentifier(e.constructor):!1}const $0=Ul(I0,(e,t)=>["class",t.classRegistry.getIdentifier(e.constructor)],(e,t)=>{const n=t.classRegistry.getAllowedProps(e.constructor);if(!n)return{...e};const r={};return n.forEach(s=>{r[s]=e[s]}),r},(e,t,n)=>{const r=n.classRegistry.getValue(t[1]);if(!r)throw new Error(`Trying to deserialize unknown class '${t[1]}' - check https://github.com/blitz-js/superjson/issues/116#issuecomment-773996564`);return Object.assign(Object.create(r.prototype),e)}),A0=Ul((e,t)=>!!t.customTransformerRegistry.findApplicable(e),(e,t)=>["custom",t.customTransformerRegistry.findApplicable(e).name],(e,t)=>t.customTransformerRegistry.findApplicable(e).serialize(e),(e,t,n)=>{const r=n.customTransformerRegistry.findByName(t[1]);if(!r)throw new Error("Trying to deserialize unknown custom value");return r.deserialize(e)}),Tj=[$0,E0,A0,C0],Xy=(e,t)=>{const n=Yy(Tj,s=>s.isApplicable(e,t));if(n)return{value:n.transform(e,t),type:n.annotation(e,t)};const r=Yy(T0,s=>s.isApplicable(e,t));if(r)return{value:r.transform(e,t),type:r.annotation}},R0={};T0.forEach(e=>{R0[e.annotation]=e});const Ej=(e,t,n)=>{if(Br(t))switch(t[0]){case"symbol":return E0.untransform(e,t,n);case"class":return $0.untransform(e,t,n);case"custom":return A0.untransform(e,t,n);case"typed-array":return C0.untransform(e,t,n);default:throw new Error("Unknown transformation: "+t)}else{const r=R0[t];if(!r)throw new Error("Unknown transformation: "+t);return r.untransform(e,n)}},eo=(e,t)=>{if(t>e.size)throw new Error("index out of bounds");const n=e.keys();for(;t>0;)n.next(),t--;return n.next().value};function O0(e){if(Ta(e,"__proto__"))throw new Error("__proto__ is not allowed as a property");if(Ta(e,"prototype"))throw new Error("prototype is not allowed as a property");if(Ta(e,"constructor"))throw new Error("constructor is not allowed as a property")}const Cj=(e,t)=>{O0(t);for(let n=0;n<t.length;n++){const r=t[n];if(lc(e))e=eo(e,+r);else if(uc(e)){const s=+r,o=+t[++n]==0?"key":"value",i=eo(e,s);switch(o){case"key":e=i;break;case"value":e=e.get(i);break}}else e=e[r]}return e},dd=(e,t,n)=>{if(O0(t),t.length===0)return n(e);let r=e;for(let o=0;o<t.length-1;o++){const i=t[o];if(Br(r)){const c=+i;r=r[c]}else if(ac(r))r=r[i];else if(lc(r)){const c=+i;r=eo(r,c)}else if(uc(r)){if(o===t.length-2)break;const a=+i,u=+t[++o]==0?"key":"value",l=eo(r,a);switch(u){case"key":r=l;break;case"value":r=r.get(l);break}}}const s=t[t.length-1];if(Br(r)?r[+s]=n(r[+s]):ac(r)&&(r[s]=n(r[s])),lc(r)){const o=eo(r,+s),i=n(o);o!==i&&(r.delete(o),r.add(i))}if(uc(r)){const o=+t[t.length-2],i=eo(r,o);switch(+s==0?"key":"value"){case"key":{const a=n(i);r.set(a,r.get(i)),a!==i&&r.delete(i);break}case"value":{r.set(i,n(r.get(i)));break}}}return e},P0=e=>e<1;function pd(e,t,n,r=[]){if(!e)return;const s=P0(n);if(!Br(e)){Ko(e,(c,a)=>pd(c,t,n,[...r,...Bi(a,s)]));return}const[o,i]=e;i&&Ko(i,(c,a)=>{pd(c,t,n,[...r,...Bi(a,s)])}),t(o,r)}function Ij(e,t,n,r){return pd(t,(s,o)=>{e=dd(e,o,i=>Ej(i,s,r))},n),e}function $j(e,t,n){const r=P0(n);function s(o,i){const c=Cj(e,Bi(i,r));o.map(a=>Bi(a,r)).forEach(a=>{e=dd(e,a,()=>c)})}if(Br(t)){const[o,i]=t;o.forEach(c=>{e=dd(e,Bi(c,r),()=>e)}),i&&Ko(i,s)}else Ko(t,s);return e}const Aj=(e,t)=>ac(e)||Br(e)||uc(e)||lc(e)||k0(e)||I0(e,t);function Rj(e,t,n){const r=n.get(e);r?r.push(t):n.set(e,[t])}function Oj(e,t){const n={};let r;return e.forEach(s=>{if(s.length<=1)return;t||(s=s.map(c=>c.map(String)).sort((c,a)=>c.length-a.length));const[o,...i]=s;o.length===0?r=i.map(Af):n[Af(o)]=i.map(Af)}),r?fd(n)?[r]:[r,n]:fd(n)?void 0:n}const F0=(e,t,n,r,s=[],o=[],i=new Map)=>{const c=Sj(e);if(!c){Rj(e,s,t);const m=i.get(e);if(m)return r?{transformedValue:null}:m}if(!Aj(e,n)){const m=Xy(e,n),y=m?{transformedValue:m.value,annotations:[m.type]}:{transformedValue:e};return c||i.set(e,y),y}if(Ta(o,e))return{transformedValue:null};const a=Xy(e,n),u=a?.value??e,l=Br(u)?[]:{},f={};Ko(u,(m,y)=>{if(y==="__proto__"||y==="constructor"||y==="prototype")throw new Error(`Detected property ${y}. This is a prototype pollution risk, please remove it from your object.`);const b=F0(m,t,n,r,[...s,y],[...o,e],i);l[y]=b.transformedValue,Br(b.annotations)?f[hd(y)]=b.annotations:ac(b.annotations)&&Ko(b.annotations,(_,k)=>{f[hd(y)+"."+k]=_})});const h=fd(f)?{transformedValue:l,annotations:a?[a.type]:void 0}:{transformedValue:l,annotations:a?[a.type,f]:f};return c||i.set(e,h),h};function x0(e){return Object.prototype.toString.call(e).slice(8,-1)}function Zy(e){return x0(e)==="Array"}function Pj(e){if(x0(e)!=="Object")return!1;const t=Object.getPrototypeOf(e);return!!t&&t.constructor===Object&&t===Object.prototype}function Fj(e,t,n,r,s){const o={}.propertyIsEnumerable.call(r,t)?"enumerable":"nonenumerable";o==="enumerable"&&(e[t]=n),s&&o==="nonenumerable"&&Object.defineProperty(e,t,{value:n,enumerable:!1,writable:!0,configurable:!0})}function md(e,t={}){if(Zy(e))return e.map(s=>md(s,t));if(!Pj(e))return e;const n=Object.getOwnPropertyNames(e),r=Object.getOwnPropertySymbols(e);return[...n,...r].reduce((s,o)=>{if(o==="__proto__"||Zy(t.props)&&!t.props.includes(o))return s;const i=e[o],c=md(i,t);return Fj(s,o,c,e,t.nonenumerable),s},{})}class Pe{constructor({dedupe:t=!1}={}){this.classRegistry=new cj,this.symbolRegistry=new _0(n=>n.description??""),this.customTransformerRegistry=new lj,this.allowedErrorProps=[],this.dedupe=t}serialize(t){const n=new Map,r=F0(t,n,this,this.dedupe),s={json:r.transformedValue};r.annotations&&(s.meta={...s.meta,values:r.annotations});const o=Oj(n,this.dedupe);return o&&(s.meta={...s.meta,referentialEqualities:o}),s.meta&&(s.meta.v=1),s}deserialize(t,n){const{json:r,meta:s}=t;let o=n?.inPlace?r:md(r);return s?.values&&(o=Ij(o,s.values,s.v??0,this)),s?.referentialEqualities&&(o=$j(o,s.referentialEqualities,s.v??0)),o}stringify(t){return JSON.stringify(this.serialize(t))}parse(t){return this.deserialize(JSON.parse(t),{inPlace:!0})}registerClass(t,n){this.classRegistry.register(t,n)}registerSymbol(t,n){this.symbolRegistry.register(t,n)}registerCustom(t,n){this.customTransformerRegistry.register({name:n,...t})}allowErrorProps(...t){this.allowedErrorProps.push(...t)}}Pe.defaultInstance=new Pe;Pe.serialize=Pe.defaultInstance.serialize.bind(Pe.defaultInstance);Pe.deserialize=Pe.defaultInstance.deserialize.bind(Pe.defaultInstance);Pe.stringify=Pe.defaultInstance.stringify.bind(Pe.defaultInstance);Pe.parse=Pe.defaultInstance.parse.bind(Pe.defaultInstance);Pe.registerClass=Pe.defaultInstance.registerClass.bind(Pe.defaultInstance);Pe.registerSymbol=Pe.defaultInstance.registerSymbol.bind(Pe.defaultInstance);Pe.registerCustom=Pe.defaultInstance.registerCustom.bind(Pe.defaultInstance);Pe.allowErrorProps=Pe.defaultInstance.allowErrorProps.bind(Pe.defaultInstance);const N0=new Pe({dedupe:!0});class B0 extends En("AmountValue")({raw:g,decimals:N,symbol:g,formatted:S(g)}){}class Zq extends En("AddressParams")({address:g}){}class eW extends En("TxHistoryParams")({address:g,limit:l0(N,{default:()=>20}),page:S(N)}){}class tW extends En("TransactionParams")({txHash:g}){}class nW extends En("BalanceOutput")({amount:B0,symbol:g}){}class xj extends En("TokenMetadata")({possibleSpam:S(ve),securityScore:S(we(N)),verified:S(ve),totalSupply:S(g)}){}class Nj extends En("TokenBalance")({symbol:g,name:g,amount:B0,isNative:ve,decimals:N,icon:S(g),contractAddress:S(g),metadata:S(xj)}){}ue(Nj);const Bj=jc("native","token","nft"),Mj=jc("in","out","self"),Lj=jc("transfer","approve","swap","stake","unstake","claim","bridge","contract","mint","burn","gift","grab","trust","signFor","emigrate","immigrate","issueAsset","increaseAsset","destroyAsset","issueEntity","destroyEntity","locationName","dapp","certificate","mark","signature","unknown"),M0=jc("pending","confirming","confirmed","failed");class Hj extends En("Asset")({assetType:Bj,value:g,symbol:g,decimals:N,contractAddress:S(g),name:S(g),logoUrl:S(g),tokenId:S(g)}){}class Dj extends En("FeeInfo")({value:g,symbol:g,decimals:N}){}class L0 extends En("Transaction")({hash:g,from:g,to:g,timestamp:N,status:M0,blockNumber:S(kK),action:Lj,direction:Mj,assets:ue(Hj),fee:S(Dj),nonce:S(N),fromEntity:S(g),toEntity:S(g),summary:S(g)}){}ue(L0);we(L0);class rW extends En("TransactionStatusOutput")({status:M0,confirmations:N,requiredConfirmations:N}){}const Rm="chain-effect-http-cache";function Uj(e){return typeof e=="object"&&e!==null}function Ea(e){if(typeof e=="bigint")return e.toString();if(!Uj(e))return Array.isArray(e)?e.map(Ea):e;if(Array.isArray(e))return e.map(Ea);const t={};for(const n of Object.keys(e).slice().sort())t[n]=Ea(e[n]);return t}function Kj(e){return JSON.stringify(Ea(e))}function Om(e,t){if(!t)return e;const n=btoa(Kj(t)).replace(/[+/=]/g,r=>r==="+"?"-":r==="/"?"_":"");return`${e}?__body=${n}`}function Pm(e){return new Request(e,{method:"GET"})}const jj=(e,t,n)=>Ps({try:async()=>{const r=Rm,s=await caches.open(r),o=Om(e,t),i=Pm(o),c=await s.match(i);if(!c)return K();const a=await c.json();return U({data:a.data,timestamp:a.timestamp,fromCache:!0})},catch:()=>new Error("Cache read failed")}).pipe(Ve(()=>z(K()))),Rf=(e,t,n,r)=>Ps({try:async()=>{const s=Rm,o=await caches.open(s),i=Om(e,t),c=Pm(i),a={data:n,timestamp:Date.now()},u=new Response(JSON.stringify(a),{headers:{"Content-Type":"application/json","X-Cache-Timestamp":String(a.timestamp)}});await o.put(c,u)},catch:()=>new Error("Cache write failed")}).pipe(Ve(()=>me)),zj=(e,t,n)=>Ps({try:async()=>{const r=Rm,s=await caches.open(r),o=Om(e,t),i=Pm(o);return s.delete(i)},catch:()=>new Error("Cache delete failed")}).pipe(Ve(()=>z(!1)));class it{constructor(t,n,r){this.message=t,this.status=n,this.body=r}_tag="HttpError"}class eS{constructor(t,n){this.message=t,this.retryAfter=n}_tag="RateLimitError"}class Vj{constructor(t,n){this.message=t,this.errors=n}_tag="SchemaError"}class sW extends Error{_tag="NoSupportError";constructor(t="This feature is not supported by the provider"){super(t),this.name="NoSupportError"}}class oW extends Error{constructor(t="This service is limited",n){super(t),this.reason=n,this.name="ServiceLimitedError"}_tag="ServiceLimitedError"}function qj(e,t){if(!t)return e;let n=e;for(const[r,s]of Object.entries(t))n=n.replace(`:${r}`,encodeURIComponent(String(s)));return n}function Wj(e,t){if(!t)return e;const n=new URL(e);for(const[r,s]of Object.entries(t))s!==void 0&&n.searchParams.set(r,String(s));return n.toString()}function ho(e){const{url:t,method:n="GET",pathParams:r,searchParams:s,headers:o={},body:i,schema:c,timeout:a=3e4,cache:u}=e;let l=qj(t,r);return l=Wj(l,s),Ps({try:async()=>{const f=new AbortController,h=setTimeout(()=>f.abort(),a);try{const m={method:n,headers:{"Content-Type":"application/json",...o},signal:f.signal,cache:u};n==="POST"&&i!==void 0&&(m.body=JSON.stringify(i));const y=await fetch(l,m);if(clearTimeout(h),y.status===429){const _=y.headers.get("retry-after");throw new eS("Rate limit exceeded",_?parseInt(_,10):void 0)}if(!y.ok){const _=await y.text().catch(()=>"");throw new it(`HTTP ${y.status}: ${y.statusText}`,y.status,_.slice(0,500))}const b=await y.json();return c?XU(c)(b):b}finally{clearTimeout(h)}},catch:f=>f instanceof eS||f instanceof it||f instanceof Vj?f:f instanceof Error&&f.name==="AbortError"?new it(`Request timeout after ${a}ms`):new it(f instanceof Error?f.message:String(f))})}FT(ie(1e3),2).pipe(gm(ym(3)));Sm(zd(5)).pipe(gm(ym(3)));const Of=new Map;function Jj(e){return typeof e=="object"&&e!==null}function Ca(e){if(typeof e=="bigint")return e.toString();if(!Jj(e))return Array.isArray(e)?e.map(Ca):e;if(Array.isArray(e))return e.map(Ca);const t={};for(const n of Object.keys(e).slice().sort())t[n]=Ca(e[n]);return t}function Gj(e){return JSON.stringify(Ca(e))}function Yj(e,t){if(!t)return e;const n=btoa(Gj(t)).replace(/[+/=]/g,r=>r==="+"?"-":r==="/"?"_":"");return`${e}?__body=${n}`}function Z(e){const{cacheStrategy:t="ttl",cacheTtl:n=5e3,canCache:r,...s}=e,o=Yj(e.url,e.body);return W(async()=>{const i=Of.get(o);if(i)return dt("httpFetchCached pending",e.url),i;const c=async u=>{if(!r)return!0;try{return await r(u)}catch(l){return dt("httpFetchCached can-cache error",e.url,Bn(l)),!1}},a=(async()=>{const u=await Q(jj(e.url,e.body)),l=$e(u)?u.value.data:null,f=$e(u)?await c(u.value.data):!1;if($e(u)&&!f&&await Q(zj(e.url,e.body)),t==="cache-first"){if($e(u)&&f&&l!==null)return dt("httpFetchCached cache-first hit",e.url),l;dt("httpFetchCached cache-first miss",e.url);try{const h=await Q(ho(s));return await c(h)&&await Q(Rf(e.url,e.body,h)),h}catch(h){throw dt("httpFetchCached cache-first fetch error",e.url,Bn(h)),h}}if(t==="network-first")try{dt("httpFetchCached network-first fetch",e.url);const h=await Q(ho(s));return await c(h)&&await Q(Rf(e.url,e.body,h)),h}catch(h){if(dt("httpFetchCached network-first fetch error",e.url,Bn(h)),$e(u)&&f&&l!==null)return dt("httpFetchCached network-first fallback",e.url),l;throw h}if($e(u)&&f){const h=Date.now()-u.value.timestamp;if(h<n)return dt("httpFetchCached ttl hit",e.url,`age=${h}ms`,`ttl=${n}ms`),l;dt("httpFetchCached ttl expired",e.url,`age=${h}ms`,`ttl=${n}ms`)}else dt("httpFetchCached ttl miss",e.url);try{const h=await Q(ho(s));return await c(h)&&await Q(Rf(e.url,e.body,h)),h}catch(h){throw dt("httpFetchCached ttl fetch error",e.url,Bn(h)),h}})();Of.set(o,a);try{return await a}finally{Of.delete(o)}})}function Qj(e){return typeof e=="object"&&e!==null}function Mi(e){return Array.isArray(e)?`array(len=${e.length})`:Qj(e)?"hash"in e?`object(hash=${String(e.hash)})`:"symbol"in e?`object(symbol=${String(e.symbol)})`:"object":String(e)}function Xn(e,...t){dt(e,...t)}const ke=e=>$(function*(){const{fetch:t,interval:n,events:r,walletEvents:s,immediate:o=!0}=e,i=yield*$t(null),c=S0(t).pipe(b0(Sm(n))),a=r?r.pipe(Wy(()=>t)):qy,u=s?s.eventBus.forWalletEvents(s.chainId,s.address,s.types).pipe(Wy(()=>t)):qy,h=yield*Jy(Jy(c,a),u).pipe(DK).pipe(qn(m=>$(function*(){Xn(`${e.name} poll`,Mi(m)),yield*Rt(i,m)})),ot);if(o){const m=yield*Ve(t,()=>z(null));m!==null&&(Xn(`${e.name} initial`,Mi(m)),yield*Rt(i,m))}return{ref:i,fiber:h,get:Bt(i),changes:i.changes.pipe(Uo(m=>m!==null)),refresh:$(function*(){const m=yield*t;return yield*Rt(i,m),m}),stop:Fe(h).pipe(Ae)}}),Le=e=>$(function*(){const{name:t,dependsOn:n,hasChanged:r,fetch:s}=e,o=yield*$t(null),i=yield*Bt(n),c=n.changes.pipe(Uo(u=>u!==null),qK({prev:i},(u,l)=>$(function*(){if(Xn(`${t} dep`,Mi(l)),r(u.prev,l)){const h=u.prev!==null;Xn(`${t} fetch`,h?"force":"cache");const m=yield*Ve(s(l,h),y=>(Xn(`${t} fetch error`,Bn(y)),z(null)));m!==null&&(Xn(`${t} set`,Mi(m)),yield*Rt(o,m))}else Xn(`${t} skip`,"unchanged");return{prev:l}})),fr),a=yield*ot(c);if(i!==null){const u=yield*Ve(s(i,!1),l=>(Xn(`${t} initial fetch error`,Bn(l)),z(null)));u!==null&&(Xn(`${t} initial`,Mi(u)),yield*Rt(o,u))}return{ref:o,fiber:a,get:Bt(o),changes:o.changes.pipe(Uo(u=>u!==null)),refresh:$(function*(){const u=yield*Bt(n);if(u===null)return yield*Ct(new Error("Dependency not available"));const l=yield*s(u,!0);return yield*Rt(o,l),l}),stop:Fe(a).pipe(Ae)}}),Xj=$(function*(){const e=yield*Hk(),t=jK(e);return{emit:n=>sm(e,n),stream:t,forWallet:(n,r)=>t.pipe(Uo(s=>s.chainId===n&&s.address.toLowerCase()===r.toLowerCase())),forWalletEvents:(n,r,s)=>t.pipe(Uo(o=>o.chainId===n&&o.address.toLowerCase()===r.toLowerCase()&&s.includes(o.type))),shutdown:Qh(e)}}),Zj=(e,t,n)=>({type:"tx:confirmed",chainId:e,address:t,txHash:n,timestamp:Date.now()}),ez="chain-effect-snapshots",tz=1,Mr="snapshots",H0=3,Fm=new Map;let ta=null;function Kl(){return typeof indexedDB<"u"}function xm(){return Kl()?ta||(ta=new Promise((e,t)=>{const n=indexedDB.open(ez,tz);n.addEventListener("error",()=>t(n.error)),n.addEventListener("success",()=>e(n.result)),n.onupgradeneeded=r=>{const s=r.target.result;s.objectStoreNames.contains(Mr)||s.createObjectStore(Mr,{keyPath:"key"})}}),ta):Promise.reject(new Error("IndexedDB is not available"))}function Nm(e){const t=Fm.get(e);return t||null}function nz(e){Fm.set(e.key,e)}function Bm(e){Fm.delete(e)}async function Mm(e){if(!Kl())return Nm(e);try{const t=await xm(),n=await new Promise((s,o)=>{const a=t.transaction(Mr,"readonly").objectStore(Mr).get(e);a.addEventListener("error",()=>o(a.error)),a.addEventListener("success",()=>s(a.result??null))});if(!n)return null;if(n.serializerVersion!==H0)return await jl(e),null;const r=N0.parse(n.payload);return{key:n.key,data:r,timestamp:n.timestamp}}catch{return null}}async function jo(e){if(nz(e),!!Kl())try{const t=await xm();await new Promise((n,r)=>{const i=t.transaction(Mr,"readwrite").objectStore(Mr).put({key:e.key,payload:N0.stringify(e.data),timestamp:e.timestamp,serializerVersion:H0});i.addEventListener("error",()=>r(i.error)),i.addEventListener("success",()=>n())})}catch{}}async function jl(e){if(Bm(e),!!Kl())try{const t=await xm();await new Promise((n,r)=>{const i=t.transaction(Mr,"readwrite").objectStore(Mr).delete(e);i.addEventListener("error",()=>r(i.error)),i.addEventListener("success",()=>n())})}catch{}}function gd(e){return typeof e=="object"&&e!==null}function Ia(e){if(typeof e=="bigint")return e.toString();if(!gd(e))return Array.isArray(e)?e.map(Ia):e;if(Array.isArray(e))return e.map(Ia);const t={};for(const n of Object.keys(e).slice().sort())t[n]=Ia(e[n]);return t}function D0(e){return JSON.stringify(Ia(e))}function tS(e){if(Array.isArray(e)){const t=e[0];if(gd(t)&&"hash"in t){const n=typeof t.hash=="string"?t.hash:String(t.hash);return`array(len=${e.length}, firstHash=${n})`}return`array(len=${e.length})`}return gd(e)?"hash"in e?`object(hash=${typeof e.hash=="string"?e.hash:String(e.hash)})`:"symbol"in e?`object(symbol=${typeof e.symbol=="string"?e.symbol:String(e.symbol)})`:"object":String(e)}function wr(e,...t){dt(e,...t)}const rz="chain-effect:snapshot";function U0(e,t){return`${rz}:${e}:${t}`}function Lm(e,t){return Number.isFinite(t)?Date.now()-e>t:!1}function K0(e,t){const n=Nm(e);return n?Lm(n.timestamp,t)?(Bm(e),null):n:null}function Se(e,t){const n=new Map,r=i=>i==null?"__empty__":D0(i),s=async i=>{const c=r(i),a=n.get(c);if(a)return a.refCount++,wr(`${e} reuse source`,c,`refs=${a.refCount}`),a.source;wr(`${e} create source`,c);const u=await Q(t(i));return n.set(c,{source:u,refCount:1}),u},o=i=>{const c=r(i),a=n.get(c);a&&(a.refCount--,a.refCount<=0&&(Zr(a.source.stop),n.delete(c)))};return{name:e,async fetch(i){const c=await s(i);try{const a=await Q(c.get);return a===null?Q(c.refresh):a}finally{o(i)}},subscribe(i,c,a){let u=!1,l=null;return wr(`${e} subscribe`,r(i)),s(i).then(f=>{if(u){o(i);return}let h=!0;const m=qn(f.changes,b=>Qe(()=>{u||(wr(`${e} emit`,h?"initial":"update",tS(b)),c(b,h?"initial":"update"),h=!1)})).pipe(Nr(b=>Qe(()=>{u||(wr(`${e} changes stream failed`,Bn(b)),a?.(b))}))),y=Zr(m);l=()=>{Zr(Fe(y)),o(i)}}).catch(f=>{wr(`${e} getOrCreateSource failed`,Bn(f)),a?.(f)}),()=>{u=!0,l?.()}},useState(i,c){const a=c?.enabled!==!1,u=c?.useSnapshot!==!1,l=c?.snapshotMaxAgeMs??Number.POSITIVE_INFINITY,f=J.useMemo(()=>r(i),[i]),h=J.useMemo(()=>U0(e,f),[f]),m=J.useMemo(()=>u?K0(h,l):null,[h,l,u]),[y,b]=J.useState(()=>a?!m:!1),[_,k]=J.useState(!1),[C,v]=J.useState(void 0),T=J.useRef(i);T.current=i;const R=J.useRef(this),w=J.useRef(m?.data),I=J.useRef(m?{key:h,timestamp:m.timestamp}:null),O=J.useRef(null),H=J.useRef(h);H.current!==h&&(H.current=h,m?(w.current=m.data,I.current={key:h,timestamp:m.timestamp}):(w.current=void 0,I.current=null)),J.useEffect(()=>{if(!a||!u)return;let D=!0;return(async()=>{const B=await Mm(h);if(!D||!B)return;if(Lm(B.timestamp,l)){await jl(h);return}const x=I.current;x&&x.key===h&&x.timestamp>=B.timestamp||(w.current=B.data,I.current={key:h,timestamp:B.timestamp},b(!1),O.current?.())})(),()=>{D=!1}},[a,h,l,u]);const F=J.useCallback(D=>{if(O.current=D,!a)return w.current=void 0,()=>{};const B=w.current!==void 0;b(!B),k(!0),v(void 0),wr(`${e} subscribe`,f);const x=R.current.subscribe(T.current,ce=>{const je=Date.now();w.current=ce,I.current={key:h,timestamp:je},u&&jo({key:h,data:ce,timestamp:je}),b(!1),k(!1),v(void 0),wr(`${e} storeChange`,tS(ce)),D()});return()=>{O.current=null,x()}},[a,f,h,u]),E=J.useCallback(()=>w.current,[]),V=J.useSyncExternalStore(F,E,E),q=J.useCallback(async()=>{if(a){k(!0),v(void 0);try{const D=await s(T.current),B=await Q(D.refresh),x=Date.now();w.current=B,I.current={key:h,timestamp:x},u&&jo({key:h,data:B,timestamp:x})}catch(D){v(D instanceof Error?D:new Error(String(D)))}finally{k(!1),b(!1)}}},[a,h,u]);return J.useEffect(()=>{a||(w.current=void 0,b(!1),k(!1),v(void 0))},[a]),J.useEffect(()=>{!a||!u||b(!m)},[a,m,u]),{data:V,isLoading:y,isFetching:_,error:C,refetch:q}},invalidate(){for(const[i,c]of n)Zr(c.source.stop);n.clear()}}}function j0(e,t,n){const r=new Map,s=3e4,o=i=>i==null?"__empty__":D0(i);return{name:e,async fetch(i){const c=o(i),a=r.get(c),u=Date.now();if(a&&u-a.timestamp<s)return a.value;const l=t(i),f=await Q(VK(l).pipe(X(h=>h._tag==="Some"?z(h.value):Ct(new Error("No data")))));return r.set(c,{value:f,timestamp:u}),f},subscribe(i,c){let a=!0,u=!1;const l=t(i),f=qn(l,m=>Qe(()=>{if(u)return;const y=o(i);r.set(y,{value:m,timestamp:Date.now()}),c(m,a?"initial":"update"),a=!1})),h=Zr(f);return()=>{u=!0,Zr(Fe(h))}},useState(i,c){const a=c?.enabled!==!1,u=c?.useSnapshot!==!1,l=c?.snapshotMaxAgeMs??Number.POSITIVE_INFINITY,f=J.useMemo(()=>o(i),[i]),h=J.useMemo(()=>U0(e,f),[f]),m=J.useMemo(()=>{const x=r.get(f);return!x||Date.now()-x.timestamp>=s?null:{key:h,data:x.value,timestamp:x.timestamp}},[f,h]),y=J.useMemo(()=>u?K0(h,l):null,[h,l,u]),b=J.useMemo(()=>u?m?y?m.timestamp>=y.timestamp?m:y:m:y:m,[m,y,u]),[_,k]=J.useState(()=>a?!b:!1),[C,v]=J.useState(!1),[T,R]=J.useState(void 0),w=J.useRef(i);w.current=i;const I=J.useRef(this),O=J.useRef(b?.data),H=J.useRef(b?{key:h,timestamp:b.timestamp}:null),F=J.useRef(null),E=J.useRef(h);E.current!==h&&(E.current=h,b?(O.current=b.data,H.current={key:h,timestamp:b.timestamp}):(O.current=void 0,H.current=null)),J.useEffect(()=>{if(!a||!u)return;let x=!0;return(async()=>{const ce=await Mm(h);if(!x||!ce)return;if(Lm(ce.timestamp,l)){await jl(h);return}const je=H.current;je&&je.key===h&&je.timestamp>=ce.timestamp||(O.current=ce.data,H.current={key:h,timestamp:ce.timestamp},k(!1),F.current?.())})(),()=>{x=!1}},[a,h,l,u]);const V=J.useCallback(x=>{if(F.current=x,!a)return O.current=void 0,()=>{};const ce=O.current!==void 0;k(!ce),v(!0),R(void 0);const je=I.current.subscribe(w.current,Vt=>{const xs=Date.now();O.current=Vt,H.current={key:h,timestamp:xs},u&&jo({key:h,data:Vt,timestamp:xs}),k(!1),v(!1),R(void 0),x()});return()=>{F.current=null,je()}},[a,h,u]),q=J.useCallback(()=>O.current,[]),D=J.useSyncExternalStore(V,q,q),B=J.useCallback(async()=>{if(a){v(!0),R(void 0);try{r.delete(o(w.current));const x=await I.current.fetch(w.current),ce=Date.now();O.current=x,H.current={key:h,timestamp:ce},u&&jo({key:h,data:x,timestamp:ce})}catch(x){R(x instanceof Error?x:new Error(String(x)))}finally{v(!1),k(!1)}}},[a,h,u]);return J.useEffect(()=>{a||(O.current=void 0,k(!1),v(!1),R(void 0))},[a]),J.useEffect(()=>{!a||!u||k(!b)},[a,b,u]),{data:D,isLoading:_,isFetching:C,error:T,refetch:B}},invalidate(){r.clear()}}}const sz="chain-effect-poll-meta",oz=1,zo="poll-meta";let na=null;function z0(){return na||(na=new Promise((e,t)=>{const n=indexedDB.open(sz,oz);n.addEventListener("error",()=>t(n.error)),n.addEventListener("success",()=>e(n.result)),n.onupgradeneeded=r=>{const s=r.target.result;s.objectStoreNames.contains(zo)||s.createObjectStore(zo,{keyPath:"key"})}}),na)}const iz=e=>Ps({try:async()=>{const t=await z0();return new Promise((n,r)=>{const i=t.transaction(zo,"readonly").objectStore(zo).get(e);i.addEventListener("error",()=>r(i.error)),i.addEventListener("success",()=>n(i.result??null))})},catch:t=>new Error(`Failed to get poll meta: ${t}`)}).pipe(Ve(()=>z(null))),cz=e=>Ps({try:async()=>{const t=await z0();return new Promise((n,r)=>{const i=t.transaction(zo,"readwrite").objectStore(zo).put(e);i.addEventListener("error",()=>r(i.error)),i.addEventListener("success",()=>n())})},catch:t=>new Error(`Failed to set poll meta: ${t}`)}).pipe(Ve(()=>me)),Pf=(e,t)=>$(function*(){const n=Date.now(),r={key:e,nextPollTime:n+t,lastSuccessTime:n,interval:t};yield*cz(r)}),az=(e,t)=>$(function*(){const n=yield*iz(e);if(!n)return 0;const r=Date.now(),s=n.nextPollTime-r,o=t??n.interval;return s>o?0:Math.max(0,s)}),po=new Map,Ff=new Map;function zl(e,t,n){return`${e}:${t.toLowerCase()}:${n}`}function Vl(e,t){return W(async()=>{const n=po.get(e);if(n)if(n.pollFiber){const o=await Q(v2(n.pollFiber));if(!av(o))return n.refCount++,n.source;po.delete(e)}else return n.refCount++,n.source;const r=Ff.get(e);if(r){const o=await r,i=po.get(e);return i&&i.refCount++,o}const s=uz(e,t);Ff.set(e,s);try{return await s}finally{Ff.delete(e)}})}async function uz(e,t){return Q($(function*(){const n=yield*$t(null),r=zi(qt(t.interval)),s=e,o=$(function*(){const l=yield*az(s,r);dt(`${s} poll fiber started`,`delay=${l}ms`,`interval=${r}ms`),l>0&&(yield*PL(ie(l))),yield*S0($(function*(){dt(`${s} polling`);const f=yield*Ve(t.fetch,h=>(dt(`${s} poll error`,Bn(h)),z(null)));return f!==null&&(dt(`${s} poll success`,"update ref"),yield*Rt(n,f),yield*Pf(s,r)),f})).pipe(b0(Sm(t.interval)),fr)}),i=yield*ot(o),c=yield*Ve(t.fetch,l=>(dt(`${e} immediate fetch error`,Bn(l)),z(null)));c!==null&&(yield*Rt(n,c),yield*Pf(s,r));const a={ref:n,fiber:i,get:Bt(n),changes:n.changes.pipe(Uo(l=>l!==null)),refresh:$(function*(){const l=yield*t.fetch;return yield*Rt(n,l),yield*Pf(s,r),l}),stop:lz(e)},u={source:a,refCount:1,pollFiber:i};return po.set(e,u),a}))}function lz(e){return $(function*(){const t=po.get(e);t&&(t.refCount--,t.refCount<=0&&(t.pollFiber&&(yield*Fe(t.pollFiber)),po.delete(e)))})}function fz(){if(typeof globalThis>"u")return;const e=globalThis.localStorage;if(e)try{const t=e.getItem("__CHAIN_EFFECT_DEBUG__");if(t===null)return;const n=t.trim();return n.length===0?void 0:n==="true"||n==="1"?!0:n==="false"||n==="0"?!1:n}catch{return}}function hz(){if(typeof globalThis>"u")return;const t=globalThis.__CHAIN_EFFECT_DEBUG__;if(typeof t=="boolean")return t;if(typeof t=="string")return t.trim()===""?void 0:t}function dz(){if(typeof globalThis>"u")return;const t=globalThis.__CHAIN_EFFECT_LOG__;if(typeof t=="function")return t}function pz(e){if(!e.startsWith("/"))return null;const t=e.lastIndexOf("/");if(t<=0)return null;const n=e.slice(1,t),r=e.slice(t+1);try{return new RegExp(n,r)}catch{return null}}function V0(e){const t=hz()??fz();if(t===!0)return!0;if(!t)return!1;const n=pz(t);return n?n.test(e):e.includes(t)}function iW(e,t){if(!V0(e))return;const n=dz();n&&n(e,t)}const cW=bd({chainId:mo(),data:DE(),signature:mo()});class de extends Error{code;details;constructor(t,n,r,s){super(n,{cause:s}),this.name="ChainServiceError",this.code=t,this.details=r}}const ge={CHAIN_NOT_SUPPORTED:"CHAIN_NOT_SUPPORTED",NOT_SUPPORTED:"NOT_SUPPORTED",NETWORK_ERROR:"NETWORK_ERROR",INSUFFICIENT_BALANCE:"INSUFFICIENT_BALANCE",INSUFFICIENT_FEE:"INSUFFICIENT_FEE",INVALID_ADDRESS:"INVALID_ADDRESS",TRANSACTION_REJECTED:"TRANSACTION_REJECTED",TRANSACTION_TIMEOUT:"TRANSACTION_TIMEOUT",TX_BUILD_FAILED:"TX_BUILD_FAILED",TX_BROADCAST_FAILED:"TX_BROADCAST_FAILED",SIGNATURE_FAILED:"SIGNATURE_FAILED",ADDRESS_FROZEN:"ADDRESS_FROZEN",PAYSECRET_REQUIRED:"PAYSECRET_REQUIRED",ADDRESS_NOT_ACTIVATED:"ADDRESS_NOT_ACTIVATED",ENERGY_INSUFFICIENT:"ENERGY_INSUFFICIENT",NONCE_TOO_LOW:"NONCE_TOO_LOW",GAS_TOO_LOW:"GAS_TOO_LOW",UTXO_INSUFFICIENT:"UTXO_INSUFFICIENT"},mz=new Set(["isValidAddress","normalizeAddress"]);function yd(e){return typeof e=="object"&&e!==null}function $a(e){if(typeof e=="bigint")return e.toString();if(!yd(e))return Array.isArray(e)?e.map($a):e;if(Array.isArray(e))return e.map($a);const t={};for(const n of Object.keys(e).sort())t[n]=$a(e[n]);return t}function nS(e){return JSON.stringify($a(e))}const gz="chain-effect:snapshot";function yz(e,t){return`${gz}:${e}:${t}`}function q0(e,t){return Number.isFinite(t)?Date.now()-e>t:!1}function Sz(e,t){const n=Nm(e);return n?q0(n.timestamp,t)?(Bm(e),null):n:null}function Vr(...e){const t=`[chain-provider] ${e.join(" ")}`;V0(t)&&console.log("[chain-provider]",...e)}function rS(e){if(Array.isArray(e)){const t=e[0];return yd(t)&&"hash"in t?`array(len=${e.length}, firstHash=${String(t.hash)})`:`array(len=${e.length})`}return yd(e)?"hash"in e?`object(hash=${String(e.hash)})`:"symbol"in e?`object(symbol=${String(e.symbol)})`:"object":String(e)}function qr(e,t){if(t.length===0)return j0(e,()=>UK({_tag:"HttpError",message:"No providers available"}));if(t.length===1)return t[0];Vr(`${e} fallback`,`sources=${t.map(o=>o.name).join(",")}`);let n=null;const r=async o=>{for(const i of t)try{const c=await i.fetch(o);return n=i,c}catch{}throw new Error("All providers failed")},s=(o,i,c)=>{let a=!1,u=null;const l=o==null?"__empty__":nS(o);Vr(`${e} subscribe`,l);const f=m=>{if(a)return;if(m>=t.length){c?.(new Error(`[${e}] all providers failed`));return}const y=t[m];Vr(`${e} probe`,y.name);let b=!1;u=y.subscribe(o,(_,k)=>{a||(b||(b=!0,n=y,Vr(`${e} resolved`,y.name)),Vr(`${e} emit`,k,rS(_)),i(_,k))},_=>{a||b||(Vr(`${e} error`,y.name,String(_)),u?.(),u=null,f(m+1))})},h=n?t.indexOf(n):-1;return f(h>=0?h:0),()=>{a=!0,u?.()}};return{name:e,fetch:r,subscribe:s,useState(o,i){const c=i?.enabled!==!1,a=i?.useSnapshot!==!1,u=i?.snapshotMaxAgeMs??Number.POSITIVE_INFINITY,l=q=>q==null?"__empty__":nS(q),f=J.useMemo(()=>l(o),[o]),h=J.useMemo(()=>yz(e,f),[f]),m=J.useMemo(()=>a?Sz(h,u):null,[h,u,a]),[y,b]=J.useState(()=>c?!m:!1),[_,k]=J.useState(!1),[C,v]=J.useState(void 0),T=J.useRef(o);T.current=o;const R=J.useRef(m?.data),w=J.useRef(m?{key:h,timestamp:m.timestamp}:null),I=J.useRef(null),O=J.useRef(h);O.current!==h&&(O.current=h,m?(R.current=m.data,w.current={key:h,timestamp:m.timestamp}):(R.current=void 0,w.current=null)),J.useEffect(()=>{if(!c||!a)return;let q=!0;return(async()=>{const D=await Mm(h);if(!q||!D)return;if(q0(D.timestamp,u)){await jl(h);return}const B=w.current;B&&B.key===h&&B.timestamp>=D.timestamp||(R.current=D.data,w.current={key:h,timestamp:D.timestamp},b(!1),I.current?.())})(),()=>{q=!1}},[c,h,u,a]);const H=J.useCallback(q=>{if(I.current=q,!c)return R.current=void 0,()=>{};const D=R.current!==void 0;b(!D),k(!0),v(void 0);const B=s(T.current,x=>{const ce=Date.now();R.current=x,w.current={key:h,timestamp:ce},a&&jo({key:h,data:x,timestamp:ce}),b(!1),k(!1),v(void 0),Vr(`${e} storeChange`,rS(x)),q()},x=>{v(x instanceof Error?x:new Error(String(x))),k(!1),b(!1)});return()=>{I.current=null,B()}},[c,f,h,a]),F=J.useCallback(()=>R.current,[]),E=J.useSyncExternalStore(H,F,F),V=J.useCallback(async()=>{if(c){k(!0),v(void 0);try{const q=await r(T.current),D=Date.now();R.current=q,w.current={key:h,timestamp:D},a&&jo({key:h,data:q,timestamp:D})}catch(q){v(q instanceof Error?q:new Error(String(q)))}finally{k(!1),b(!1)}}},[c,h,a]);return J.useEffect(()=>{c||(R.current=void 0,b(!1),k(!1),v(void 0))},[c]),J.useEffect(()=>{!c||!a||b(!m)},[c,m,a]),{data:E,isLoading:y,isFetching:_,error:C,refetch:V}},invalidate(){n=null;for(const o of t)o.invalidate()}}}class W0{chainId;providers;_nativeBalance;_tokenBalances;_transactionHistory;_transaction;_transactionStatus;_blockHeight;_allBalances;constructor(t,n){this.chainId=t,this.providers=n}supports(t){return t==="nativeBalance"?this.providers.some(n=>n.nativeBalance!==void 0):t==="tokenBalances"?this.providers.some(n=>n.tokenBalances!==void 0):t==="transactionHistory"?this.providers.some(n=>n.transactionHistory!==void 0):t==="blockHeight"?this.providers.some(n=>n.blockHeight!==void 0):t==="transactionStatus"?this.providers.some(n=>n.transactionStatus!==void 0):this.providers.some(n=>typeof n[t]=="function")}getMethod(t){const n=this.providers.filter(i=>typeof i[t]=="function");if(n.length===0)return;const r=n[0],s=r[t];return typeof s!="function"?void 0:mz.has(t)?s.bind(r):(async(...i)=>{let c=null,a=null;for(const u of n){const l=u[t];if(typeof l=="function")try{return await l.apply(u,i)}catch(f){if(c=f,f instanceof de&&f.code===ge.NOT_SUPPORTED)continue;a||(a=f instanceof Error?f:new Error(String(f)))}}throw a||(c instanceof Error?c:new Error("All providers failed"))})}get supportsNativeBalance(){return this.supports("nativeBalance")}get supportsTokenBalances(){return this.supports("tokenBalances")}get supportsTransactionHistory(){return this.supports("transactionHistory")}get supportsBlockHeight(){return this.supports("blockHeight")}get supportsFeeEstimate(){return this.supports("estimateFee")}get supportsBuildTransaction(){return this.supports("buildTransaction")}get supportsSignTransaction(){return this.supports("signTransaction")}get supportsBroadcast(){return this.supports("broadcastTransaction")}get supportsFullTransaction(){return this.supportsBuildTransaction&&this.supportsSignTransaction&&this.supportsBroadcast}get supportsDeriveAddress(){return this.supports("deriveAddress")}get supportsAddressValidation(){return this.supports("isValidAddress")}get nativeBalance(){if(!this._nativeBalance){const t=this.providers.map(n=>n.nativeBalance).filter(n=>n!==void 0);this._nativeBalance=qr(`${this.chainId}.nativeBalance`,t)}return this._nativeBalance}get tokenBalances(){if(!this._tokenBalances){const t=this.providers.map(n=>n.tokenBalances).filter(n=>n!==void 0);this._tokenBalances=qr(`${this.chainId}.tokenBalances`,t)}return this._tokenBalances}get allBalances(){if(!this._allBalances){const t=this.supportsTokenBalances,n=this.supportsNativeBalance;if(t)this._allBalances=this.tokenBalances;else if(n){const{chainId:r}=this,s=le.getSymbol(r),o=le.getDecimals(r);this._allBalances=j0(`${r}.allBalances`,i=>{const c=this.nativeBalance;return KK(Ps({try:()=>c.fetch(i),catch:a=>({_tag:"HttpError",message:String(a)})})).pipe(zK(a=>a?[{symbol:a.symbol||s,name:a.symbol||s,amount:a.amount,isNative:!0,decimals:o}]:[]))})}else this._allBalances=qr(`${this.chainId}.allBalances`,[])}return this._allBalances}get transactionHistory(){if(!this._transactionHistory){const t=this.providers.map(n=>n.transactionHistory).filter(n=>n!==void 0);this._transactionHistory=qr(`${this.chainId}.transactionHistory`,t)}return this._transactionHistory}get transaction(){if(!this._transaction){const t=this.providers.map(n=>n.transaction).filter(n=>n!==void 0);this._transaction=qr(`${this.chainId}.transaction`,t)}return this._transaction}get transactionStatus(){if(!this._transactionStatus){const t=this.providers.map(n=>n.transactionStatus).filter(n=>n!==void 0);this._transactionStatus=qr(`${this.chainId}.transactionStatus`,t)}return this._transactionStatus}get blockHeight(){if(!this._blockHeight){const t=this.providers.map(n=>n.blockHeight).filter(n=>n!==void 0);this._blockHeight=qr(`${this.chainId}.blockHeight`,t)}return this._blockHeight}get buildTransaction(){return this.getMethod("buildTransaction")}get estimateFee(){return this.getMethod("estimateFee")}get signTransaction(){return this.getMethod("signTransaction")}get broadcastTransaction(){return this.getMethod("broadcastTransaction")}get deriveAddress(){return this.getMethod("deriveAddress")}get deriveAddresses(){return this.getMethod("deriveAddresses")}get isValidAddress(){return this.getMethod("isValidAddress")}get normalizeAddress(){return this.getMethod("normalizeAddress")}get bioGetAccountInfo(){return this.getMethod("bioGetAccountInfo")}get bioVerifyPayPassword(){return this.getMethod("bioVerifyPayPassword")}get bioGetAssetDetail(){return this.getMethod("bioGetAssetDetail")}get supportsBioAccountInfo(){return this.supports("bioGetAccountInfo")}getProviders(){return this.providers}getProviderByType(t){return this.providers.find(n=>n.type===t)}}function oi(e){return class extends e{async deriveAddress(n,r=0){const s=new TextDecoder().decode(n);return Aa(s,"ethereum",r).address}async deriveAddresses(n,r,s){const o=new TextDecoder().decode(n),i=[];for(let c=0;c<s;c++){const a=Aa(o,"ethereum",r+c);i.push(a.address)}return i}isValidAddress(n){return KE(n,"ethereum")}normalizeAddress(n){return jE(n)}async signMessage(n,r){throw new Error("Not implemented")}async verifyMessage(n,r,s){throw new Error("Not implemented")}}}const bz={ethereum:1,"ethereum-sepolia":11155111,binance:56,"bsc-testnet":97},_z=Cr(Ii(new TextEncoder().encode("transfer(address,uint256)"))).slice(0,8);function ii(e){return class extends e{#e=null;get#n(){return le.getRpcUrl(this.chainId)}get#t(){return le.getDecimals(this.chainId)}get#r(){return le.getSymbol(this.chainId)}async#o(){if(this.#e!==null)return this.#e;try{const n=await this.#s("eth_chainId"),r=parseInt(n,16);if(Number.isFinite(r))return this.#e=r,r}catch{}return this.#e=bz[this.chainId]??1,this.#e}async#s(n,r=[]){const s=await fetch(this.#n,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({jsonrpc:"2.0",id:Date.now(),method:n,params:r})});if(!s.ok)throw new de(ge.NETWORK_ERROR,`HTTP ${s.status}: ${s.statusText}`);const o=await s.json();if(o.error)throw new de(ge.NETWORK_ERROR,o.error.message,{code:o.error.code});return o.result}async buildTransaction(n){if(n.type!=="transfer")throw new de(ge.NOT_SUPPORTED,`Transaction type not supported: ${n.type}`);const r=n,s=await this.#s("eth_getTransactionCount",[r.from,"pending"]),o=parseInt(s,16),i=await this.#s("eth_gasPrice"),c=await this.#o(),a=r.tokenAddress?.toLowerCase(),u=!!a;let l=r.to,f="0x"+r.amount.raw.toString(16),h="0x",m="0x5208";return u&&a&&(h=this.#u(r.to,r.amount.raw),l=a,f="0x",m=await this.#f({from:r.from,to:l,data:h,value:f})),{chainId:this.chainId,intentType:"transfer",data:{nonce:o,gasPrice:i,gasLimit:m,to:l,value:f,data:h,chainId:c}}}async estimateFee(n){const r=await this.#s("eth_gasPrice"),i=21000n*BigInt(r),c=se.fromRaw((i*80n/100n).toString(),this.#t,this.#r),a=se.fromRaw(i.toString(),this.#t,this.#r),u=se.fromRaw((i*120n/100n).toString(),this.#t,this.#r);return{slow:{amount:c,estimatedTime:60},standard:{amount:a,estimatedTime:15},fast:{amount:u,estimatedTime:5}}}async signTransaction(n,r){if(!r.privateKey)throw new de(ge.SIGNATURE_FAILED,"privateKey is required for EVM signing");const s=n.data,o=await this.#l(s.chainId),i=this.#c([this.#i(s.nonce),s.gasPrice,s.gasLimit,s.to.toLowerCase(),s.value,s.data,this.#i(o),"0x","0x"]),c=Ii(to(i.slice(2))),a=go.sign(c,r.privateKey,{prehash:!1,format:"recovered"}),u=a[0],l=BigInt("0x"+Cr(a.slice(1,33))),f=BigInt("0x"+Cr(a.slice(33,65))),h=o*2+35+u,m=l.toString(16).padStart(64,"0"),y=f.toString(16).padStart(64,"0"),b=this.#c([this.#i(s.nonce),s.gasPrice,s.gasLimit,s.to.toLowerCase(),s.value,s.data,this.#i(h),"0x"+m,"0x"+y]);return{chainId:this.chainId,data:b,signature:"0x"+m+y}}async broadcastTransaction(n){const r=n.data;return await this.#s("eth_sendRawTransaction",[r])}#i(n){return n===0?"0x":"0x"+n.toString(16)}#c(n){const r=n.map(a=>{if(a==="0x"||a==="")return new Uint8Array([128]);let u=a.startsWith("0x")?a.slice(2):a;u.length%2===1&&(u="0"+u);const l=to(u);if(l.length===1&&l[0]<128)return l;if(l.length<=55)return new Uint8Array([128+l.length,...l]);const f=this.#a(l.length);return new Uint8Array([183+f.length,...f,...l])}),s=r.reduce((a,u)=>a+u.length,0);let o;if(s<=55)o=new Uint8Array([192+s]);else{const a=this.#a(s);o=new Uint8Array([247+a.length,...a])}const i=new Uint8Array(o.length+s);i.set(o);let c=o.length;for(const a of r)i.set(a,c),c+=a.length;return"0x"+Cr(i)}#u(n,r){const s=n.toLowerCase().replace(/^0x/,"").padStart(64,"0"),o=r.toString(16).padStart(64,"0");return`0x${_z}${s}${o}`}async#l(n){if(typeof n=="number"&&Number.isFinite(n))return n;if(typeof n=="string"){const r=n.trim();if(r){const s=r.startsWith("0x")?parseInt(r,16):parseInt(r,10);if(Number.isFinite(s))return s}}return this.#o()}async#f(n){try{return await this.#s("eth_estimateGas",[n])}catch{return"0x186a0"}}#a(n){const r=n.toString(16),s=r.length%2?"0"+r:r;return to(s)}}}const xf=new Map;function wz(e,t){if(!e||e.trim()==="")return;if(xf.has(t))return xf.get(t);const n=e.split(",").map(s=>s.trim()).filter(s=>s.length>0);if(n.length===0)return;const r=n[Math.floor(Math.random()*n.length)];return xf.set(t,r),r}function ql(e,t){if(!e)return;const n=globalThis.__API_KEYS__;return wz(n?.[e],t)}let Nf=null;const Tn=()=>Nf?z(Nf):Xj.pipe(Ie(e=>Qe(()=>{Nf=e}))),sS=A({status:g,message:g,result:Bl}),vz=A({hash:g,from:g,to:g,value:g,timeStamp:g,isError:g,blockNumber:g,input:S(g),methodId:S(g),functionName:S(g)});function kz(e,t,n){const r=e.toLowerCase(),s=t.toLowerCase();return r===n&&s===n?"self":r===n?"out":"in"}function Tz(e){try{const{Schema:t}=require("effect");return t.decodeUnknownSync(vz)(e)}catch{return null}}function Ez(e,t){return!e||e.length!==t.length?!0:e.length===0&&t.length===0?!1:e[0]?.hash!==t[0]?.hash}class Cz{chainId;type;endpoint;config;constructor(t,n){this.type=t.type,this.endpoint=t.endpoint,this.config=t.config,this.chainId=n}}class J0 extends oi(ii(Cz)){symbol;decimals;baseUrl;apiKey;pollingInterval=3e4;_eventBus=null;_txHistorySources=new Map;_txHistoryCreations=new Map;_balanceSources=new Map;_balanceCreations=new Map;nativeBalance;transactionHistory;constructor(t,n){super(t,n),this.symbol=le.getSymbol(n),this.decimals=le.getDecimals(n),this.baseUrl=this.endpoint,this.apiKey=ql(this.config?.apiKeyEnv,`etherscan-${n}`);const r=this;this.transactionHistory=Se(`etherscan.${n}.transactionHistory`,s=>r.createTransactionHistorySource(s)),this.nativeBalance=Se(`etherscan.${n}.nativeBalance`,s=>r.createBalanceSource(s))}buildUrl(t){const n=new URL(this.baseUrl);for(const[r,s]of Object.entries(t))n.searchParams.set(r,s);return this.apiKey&&n.searchParams.set("apikey",this.apiKey),n.toString()}createTransactionHistorySource(t){return this.getSharedTxHistorySource(t.address)}createBalanceSource(t){return this.getSharedBalanceSource(t.address)}getSharedTxHistorySource(t){const n=this,r=t.toLowerCase(),s=r,o=this.symbol,i=this.decimals,c=l=>({...l,stop:n.releaseSharedTxHistorySource(s)}),a=n._txHistorySources.get(s);if(a)return a.refCount+=1,z(c(a.source));const u=n._txHistoryCreations.get(s);return W(u?async()=>{const l=await u,f=n._txHistorySources.get(s);return f&&(f.refCount+=1),c(l)}:async()=>{const l=Q($(function*(){n._eventBus||(n._eventBus=yield*Tn());const f=n._eventBus,h=n.fetchTransactionHistory({address:t,limit:50},!0).pipe(j(b=>{if(b.status==="0"||!Array.isArray(b.result))throw new it("API rate limited",429);return b.result.map(Tz).filter(_=>_!==null).map(_=>({hash:_.hash,from:_.from,to:_.to,timestamp:parseInt(_.timeStamp,10)*1e3,status:_.isError==="0"?"confirmed":"failed",blockNumber:BigInt(_.blockNumber),action:"transfer",direction:kz(_.from,_.to,r),assets:[{assetType:"native",value:_.value,symbol:o,decimals:i}]}))})),m=yield*ke({name:`etherscan.${n.chainId}.txHistory.${s}`,fetch:h,interval:ie(n.pollingInterval),walletEvents:{eventBus:f,chainId:n.chainId,address:t,types:["tx:confirmed","tx:sent"]}}),y=m.stop;return n._txHistorySources.set(s,{source:m,refCount:1,stopAll:y}),m}));n._txHistoryCreations.set(s,l);try{const f=await l;return c(f)}finally{n._txHistoryCreations.delete(s)}})}releaseSharedTxHistorySource(t){const n=this;return $(function*(){const r=n._txHistorySources.get(t);r&&(r.refCount-=1,r.refCount<=0&&(yield*r.stopAll,n._txHistorySources.delete(t)))})}getSharedBalanceSource(t){const n=this,r=t.toLowerCase(),s=this.symbol,o=this.decimals,i=u=>({...u,stop:n.releaseSharedBalanceSource(r)}),c=n._balanceSources.get(r);if(c)return c.refCount+=1,z(i(c.source));const a=n._balanceCreations.get(r);return W(a?async()=>{const u=await a,l=n._balanceSources.get(r);return l&&(l.refCount+=1),i(u)}:async()=>{const u=Q($(function*(){const l=yield*n.getSharedTxHistorySource(t),f=yield*Le({name:`etherscan.${n.chainId}.balance`,dependsOn:l.ref,hasChanged:Ez,fetch:(m,y)=>n.fetchBalance(t,y).pipe(j(b=>{if(b.status==="0"||typeof b.result!="string")throw new it("API rate limited",429);return{amount:se.fromRaw(b.result,o,s),symbol:s}}))}),h=ze([f.stop,l.stop]).pipe(Ae);return n._balanceSources.set(r,{source:f,refCount:1,stopAll:h}),f}));n._balanceCreations.set(r,u);try{const l=await u;return i(l)}finally{n._balanceCreations.delete(r)}})}releaseSharedBalanceSource(t){const n=this;return $(function*(){const r=n._balanceSources.get(t);r&&(r.refCount-=1,r.refCount<=0&&(yield*r.stopAll,n._balanceSources.delete(t)))})}fetchBalance(t,n=!1){return Z({url:this.buildUrl({module:"account",action:"balance",address:t,tag:"latest"}),schema:sS,cacheStrategy:n?"network-first":"cache-first"})}fetchTransactionHistory(t,n=!1){return Z({url:this.buildUrl({module:"account",action:"txlist",address:t.address,page:"1",offset:String(t.limit??20),sort:"desc"}),schema:sS,cacheStrategy:n?"network-first":"cache-first"})}}function G0(e,t){return e.type==="etherscan-v1"||e.type.includes("blockscout")?new J0(e,t):null}const oS=A({status:g,message:g,result:Bl}),Iz=A({hash:g,from:g,to:g,value:g,timeStamp:g,isError:g,blockNumber:g,input:S(g),methodId:S(g),functionName:S(g)});function $z(e,t,n){const r=e.toLowerCase(),s=t.toLowerCase();return r===n&&s===n?"self":r===n?"out":"in"}function Az(e){try{const{Schema:t}=require("effect");return t.decodeUnknownSync(Iz)(e)}catch{return null}}function Rz(e,t){return!e||e.length!==t.length?!0:e.length===0&&t.length===0?!1:e[0]?.hash!==t[0]?.hash}class Oz{chainId;type;endpoint;config;constructor(t,n){this.type=t.type,this.endpoint=t.endpoint,this.config=t.config,this.chainId=n}}class Y0 extends oi(ii(Oz)){symbol;decimals;baseUrl;apiKey;evmChainId;pollingInterval=3e4;_eventBus=null;_txHistorySources=new Map;_txHistoryCreations=new Map;_balanceSources=new Map;_balanceCreations=new Map;nativeBalance;transactionHistory;constructor(t,n){super(t,n),this.symbol=le.getSymbol(n),this.decimals=le.getDecimals(n),this.baseUrl=this.endpoint,this.apiKey=ql(this.config?.apiKeyEnv,`etherscan-${n}`);const r=this.config?.evmChainId;if(!r)throw new Error(`[EtherscanV2Provider] evmChainId is required for chain ${n}`);this.evmChainId=r;const s=this;this.transactionHistory=Se(`etherscan-v2.${n}.transactionHistory`,o=>s.createTransactionHistorySource(o)),this.nativeBalance=Se(`etherscan-v2.${n}.nativeBalance`,o=>s.createBalanceSource(o))}buildUrl(t){const n=new URL(this.baseUrl);n.searchParams.set("chainid",this.evmChainId.toString());for(const[r,s]of Object.entries(t))n.searchParams.set(r,s);return this.apiKey&&n.searchParams.set("apikey",this.apiKey),n.toString()}createTransactionHistorySource(t){return this.getSharedTxHistorySource(t.address)}createBalanceSource(t){return this.getSharedBalanceSource(t.address)}getSharedTxHistorySource(t){const n=this,r=t.toLowerCase(),s=r,o=this.symbol,i=this.decimals,c=l=>({...l,stop:n.releaseSharedTxHistorySource(s)}),a=n._txHistorySources.get(s);if(a)return a.refCount+=1,z(c(a.source));const u=n._txHistoryCreations.get(s);return W(u?async()=>{const l=await u,f=n._txHistorySources.get(s);return f&&(f.refCount+=1),c(l)}:async()=>{const l=Q($(function*(){n._eventBus||(n._eventBus=yield*Tn());const f=n._eventBus,h=n.fetchTransactionHistory({address:t,limit:50},!0).pipe(j(b=>{if(b.status==="0"||!Array.isArray(b.result))throw new it("API rate limited",429);return b.result.map(Az).filter(_=>_!==null).map(_=>({hash:_.hash,from:_.from,to:_.to,timestamp:parseInt(_.timeStamp,10)*1e3,status:_.isError==="0"?"confirmed":"failed",blockNumber:BigInt(_.blockNumber),action:"transfer",direction:$z(_.from,_.to,r),assets:[{assetType:"native",value:_.value,symbol:o,decimals:i}]}))})),m=yield*ke({name:`etherscan-v2.${n.chainId}.txHistory.${s}`,fetch:h,interval:ie(n.pollingInterval),walletEvents:{eventBus:f,chainId:n.chainId,address:t,types:["tx:confirmed","tx:sent"]}}),y=m.stop;return n._txHistorySources.set(s,{source:m,refCount:1,stopAll:y}),m}));n._txHistoryCreations.set(s,l);try{const f=await l;return c(f)}finally{n._txHistoryCreations.delete(s)}})}releaseSharedTxHistorySource(t){const n=this;return $(function*(){const r=n._txHistorySources.get(t);r&&(r.refCount-=1,r.refCount<=0&&(yield*r.stopAll,n._txHistorySources.delete(t)))})}getSharedBalanceSource(t){const n=this,r=t.toLowerCase(),s=this.symbol,o=this.decimals,i=u=>({...u,stop:n.releaseSharedBalanceSource(r)}),c=n._balanceSources.get(r);if(c)return c.refCount+=1,z(i(c.source));const a=n._balanceCreations.get(r);return W(a?async()=>{const u=await a,l=n._balanceSources.get(r);return l&&(l.refCount+=1),i(u)}:async()=>{const u=Q($(function*(){const l=yield*n.getSharedTxHistorySource(t),f=yield*Le({name:`etherscan-v2.${n.chainId}.balance`,dependsOn:l.ref,hasChanged:Rz,fetch:(m,y)=>n.fetchBalance(t,y).pipe(j(b=>{if(b.status==="0"||typeof b.result!="string")throw new it("API rate limited",429);const _=b.result.startsWith("0x")?BigInt(b.result).toString():b.result;return{amount:se.fromRaw(_,o,s),symbol:s}}))}),h=ze([f.stop,l.stop]).pipe(Ae);return n._balanceSources.set(r,{source:f,refCount:1,stopAll:h}),f}));n._balanceCreations.set(r,u);try{const l=await u;return i(l)}finally{n._balanceCreations.delete(r)}})}releaseSharedBalanceSource(t){const n=this;return $(function*(){const r=n._balanceSources.get(t);r&&(r.refCount-=1,r.refCount<=0&&(yield*r.stopAll,n._balanceSources.delete(t)))})}fetchBalance(t,n=!1){return Z({url:this.buildUrl({module:"account",action:"balance",address:t,tag:"latest"}),schema:oS,cacheStrategy:n?"network-first":"cache-first"})}fetchTransactionHistory(t,n=!1){return Z({url:this.buildUrl({module:"account",action:"txlist",address:t.address,page:"1",offset:String(t.limit??20),sort:"desc"}),schema:oS,cacheStrategy:n?"network-first":"cache-first"})}}function Q0(e,t){return e.type==="etherscan-v2"?new Y0(e,t):null}const iS=A({jsonrpc:g,id:N,result:g}),Pz=A({hash:g,from:g,to:we(g),value:g,blockNumber:we(g),input:g}),Fz=A({jsonrpc:g,id:N,result:we(Pz)}),xz=A({status:g,blockNumber:g,transactionHash:g}),Nz=A({jsonrpc:g,id:N,result:we(xz)});function cS(e,t){return e===null?!0:e!==t}class Bz{chainId;type;endpoint;config;constructor(t,n){this.type=t.type,this.endpoint=t.endpoint,this.config=t.config,this.chainId=n}}class X0 extends oi(ii(Bz)){symbol;decimals;pollingInterval=3e4;_balanceSources=new Map;_balanceCreations=new Map;_transactionSources=new Map;_transactionCreations=new Map;nativeBalance;blockHeight;transaction;constructor(t,n){super(t,n),this.symbol=le.getSymbol(n),this.decimals=le.getDecimals(n);const r=this;this.blockHeight=Se(`evm-rpc.${n}.blockHeight`,()=>r.createBlockHeightSource()),this.nativeBalance=Se(`evm-rpc.${n}.nativeBalance`,s=>r.createBalanceSource(s)),this.transaction=Se(`evm-rpc.${n}.transaction`,s=>r.createTransactionSource(s))}createBlockHeightSource(){return this.getSharedBlockHeightSource()}getSharedBlockHeightSource(){const t=this,n=zl(this.chainId,"global","blockHeight"),r=t.fetchBlockNumber(!0).pipe(j(s=>BigInt(s.result)));return Vl(n,{fetch:r,interval:ie(t.pollingInterval)})}createBalanceSource(t){return this.getSharedBalanceSource(t.address)}createTransactionSource(t){return this.getSharedTransactionSource(t)}getSharedBalanceSource(t){const n=this,r=t.toLowerCase(),s=this.symbol,o=this.decimals,i=u=>({...u,stop:n.releaseSharedBalanceSource(r)}),c=n._balanceSources.get(r);if(c)return c.refCount+=1,z(i(c.source));const a=n._balanceCreations.get(r);return W(a?async()=>{const u=await a,l=n._balanceSources.get(r);return l&&(l.refCount+=1),i(u)}:async()=>{const u=Q($(function*(){const l=yield*n.getSharedBlockHeightSource(),f=yield*Le({name:`evm-rpc.${n.chainId}.balance`,dependsOn:l.ref,hasChanged:cS,fetch:(m,y)=>n.fetchBalance(t,y).pipe(j(b=>{const _=BigInt(b.result).toString();return{amount:se.fromRaw(_,o,s),symbol:s}}))}),h=ze([f.stop,l.stop]).pipe(Ae);return n._balanceSources.set(r,{source:f,refCount:1,stopAll:h}),f}));n._balanceCreations.set(r,u);try{const l=await u;return i(l)}finally{n._balanceCreations.delete(r)}})}releaseSharedBalanceSource(t){const n=this;return $(function*(){const r=n._balanceSources.get(t);r&&(r.refCount-=1,r.refCount<=0&&(yield*r.stopAll,n._balanceSources.delete(t)))})}getSharedTransactionSource(t){const n=this,r=t.txHash,s=this.symbol,o=this.decimals,i=u=>({...u,stop:n.releaseSharedTransactionSource(r)}),c=n._transactionSources.get(r);if(c)return c.refCount+=1,z(i(c.source));const a=n._transactionCreations.get(r);return W(a?async()=>{const u=await a,l=n._transactionSources.get(r);return l&&(l.refCount+=1),i(u)}:async()=>{const u=Q($(function*(){const l=yield*n.getSharedBlockHeightSource(),f=$(function*(){const[y,b]=yield*ze([n.fetchTransaction(t.txHash,!0),n.fetchTransactionReceipt(t.txHash,!0)]),_=y.result,k=b.result;if(!_)return null;let C;k?C=k.status==="0x1"?"confirmed":"failed":C="pending";const v=BigInt(_.value||"0x0").toString(),T=k?.blockNumber?BigInt(k.blockNumber):void 0,R={hash:_.hash,from:_.from,to:_.to??"",timestamp:Date.now(),status:C,action:_.to?"transfer":"contract",direction:"out",assets:[{assetType:"native",value:v,symbol:s,decimals:o}]};return T===void 0?R:{...R,blockNumber:T}}),h=yield*Le({name:`evm-rpc.${n.chainId}.transaction`,dependsOn:l.ref,hasChanged:cS,fetch:()=>f}),m=ze([h.stop,l.stop]).pipe(Ae);return n._transactionSources.set(r,{source:h,refCount:1,stopAll:m}),h}));n._transactionCreations.set(r,u);try{const l=await u;return i(l)}finally{n._transactionCreations.delete(r)}})}releaseSharedTransactionSource(t){const n=this;return $(function*(){const r=n._transactionSources.get(t);r&&(r.refCount-=1,r.refCount<=0&&(yield*r.stopAll,n._transactionSources.delete(t)))})}fetchBlockNumber(t=!1){return Z({url:this.endpoint,method:"POST",body:{jsonrpc:"2.0",id:1,method:"eth_blockNumber",params:[]},schema:iS,cacheStrategy:t?"network-first":"cache-first"})}fetchBalance(t,n=!1){return Z({url:this.endpoint,method:"POST",body:{jsonrpc:"2.0",id:1,method:"eth_getBalance",params:[t,"latest"]},schema:iS,cacheStrategy:n?"network-first":"cache-first"})}fetchTransaction(t,n=!1){return Z({url:this.endpoint,method:"POST",body:{jsonrpc:"2.0",id:1,method:"eth_getTransactionByHash",params:[t]},schema:Fz,cacheStrategy:n?"network-first":"cache-first"})}fetchTransactionReceipt(t,n=!1){return Z({url:this.endpoint,method:"POST",body:{jsonrpc:"2.0",id:1,method:"eth_getTransactionReceipt",params:[t]},schema:Nz,cacheStrategy:n?"network-first":"cache-first"})}}function Z0(e,t){return e.type.endsWith("-rpc")&&(e.type.includes("ethereum")||e.type.includes("bsc"))?new X0(e,t):null}A({success:ve,result:A({height:N,timestamp:N,signature:S(g)})});A({success:ve,result:S(A({assets:S(ue(A({symbol:g,balance:g})))}))});A({success:ve,result:S(A({trs:S(ue(A({height:N,signature:g,tIndex:N,transaction:A({signature:g,senderId:g,recipientId:S(g),fee:g,timestamp:N,type:S(g),asset:S(A({transferAsset:S(A({amount:g,assetType:S(g)}))}))})}))),count:S(N)}))});A({genesisBlock:A({forgeInterval:N,beginEpochTime:S(N)})});const eE=new Map,Mz=15e3;function Lz(e,t){eE.set(e,t)}function lW(e){return eE.get(e)??Mz}function Hz(e){return Array.from(e).map(t=>t.toString(16).padStart(2,"0")).join("")}function Dz(e){return class extends e{#e=null;#n(){if(!this.#e){const n=le.getConfig(this.chainId);this.#e=n?.prefix??"b"}return this.#e}async deriveAddress(n,r=0){const s=new TextDecoder().decode(n),o=zE(s);return VE(o.publicKey,this.#n())}async deriveAddresses(n,r,s){const o=await this.deriveAddress(n,r);return Array(s).fill(o)}isValidAddress(n){return qE(n)}normalizeAddress(n){return n}async signMessage(n,r){const s=WE(n,r);return Hz(s)}async verifyMessage(n,r,s){return!1}}}class Js extends Error{constructor(t,n,r){super(t),this.status=n,this.response=r,this.name="ApiError"}}class Uz{baseUrl;timeout;fetchFn;constructor(t){this.baseUrl=t.baseUrl.replace(/\/$/,""),this.timeout=t.timeout??3e4,this.fetchFn=t.fetch??((n,r)=>fetch(n,r))}async request(t,n,r){const s=`${this.baseUrl}${n}`,o=new AbortController,i=setTimeout(()=>o.abort(),this.timeout);try{const c={method:t,signal:o.signal};r&&(c.headers={"Content-Type":"application/json"},c.body=JSON.stringify(r));const a=await this.fetchFn(s,c),u=await a.json();if(!a.ok)throw new Js(u.message??`Request failed: ${a.status}`,a.status,u);if(!u.success)throw new Js(u.message??"Request failed",a.status,u);return u.result}catch(c){throw c instanceof Js?c:c instanceof Error&&c.name==="AbortError"?new Js("Request timeout",void 0,void 0):new Js(c instanceof Error?c.message:"Unknown error",void 0,void 0)}finally{clearTimeout(i)}}async get(t){return this.request("GET",t)}async post(t,n){return this.request("POST",t,n)}}const Kz="https://walletapi.bfmeta.info";class jz{client;chainPath;constructor(t){this.chainPath=t.chainPath;const n={baseUrl:t.baseUrl??Kz};t.timeout!==void 0&&(n.timeout=t.timeout),t.fetch!==void 0&&(n.fetch=t.fetch),this.client=new Uz(n)}path(t){return`/wallet/${this.chainPath}${t}`}async getLastBlock(){return this.client.get(this.path("/lastblock"))}async getBlockByHeight(t){return this.client.post(this.path("/block/query"),{height:t})}async getBalance(t){return this.client.post(this.path("/address/balance"),t)}async getAddressInfo(t){return this.client.post(this.path("/address/info"),{address:t})}async getAddressAssets(t){return this.client.post(this.path("/address/asset"),{address:t})}async getBlockAverageFee(){return this.client.get(this.path("/blockAveFee"))}async broadcastTransaction(t){return this.client.post(this.path("/transactions/broadcast"),t)}async queryTransactions(t){return this.client.post(this.path("/transactions/query"),t)}async queryPendingTransactions(t){return this.client.post(this.path("/pendingTr"),t)}async queryTokenList(t){return this.client.post(this.path("/assets"),t)}async queryTokenDetail(t){return this.client.post(this.path("/asset/details"),t)}}const zz=bd({code:mo(),message:mo()}),aS=bd({success:UE(),minFee:mo().optional(),message:mo().optional(),error:zz.optional()});class ra extends Error{constructor(t,n,r){super(n),this.code=t,this.minFee=r,this.name="BroadcastError",this.isRetryable=Vz(t,n)}isRetryable}function Vz(e,t){if(e&&["001-11028","001-11029","002-41011","001-00034"].includes(e))return!1;const r=t.toLowerCase();return["timeout","timed out","network","connection","econnrefused","enotfound","socket","fetch failed","failed to fetch"].some(i=>r.includes(i))?!0:["insufficient","not enough","rejected","invalid","expired"].some(i=>r.includes(i))?!1:e===void 0}const uS=new Map;function qz(e){const t=e.match(/^(https?:\/\/[^/]+)\/wallet\/([^/]+)\/?$/);if(t)return{baseUrl:t[1],chainPath:t[2]};throw new Error(`Invalid wallet API URL format: ${e}. Expected format: https://host/wallet/chainPath`)}function Wl(e){let t=uS.get(e);if(!t){const{baseUrl:n,chainPath:r}=qz(e);t=new jz({baseUrl:n,chainPath:r}),uS.set(e,t)}return t}const lS=new Map,fS=new Map;let sa=null,oa=null;async function Hm(e,t){const n=t,r=lS.get(n);if(r)return r;let s;typeof document<"u"?s=new URL(`./configs/${t.replace(/^\.\//,"")}`,document.baseURI).href:s=`./configs/${t.replace(/^\.\//,"")}`;let o;if(s.startsWith("http://")||s.startsWith("https://")){const i=await fetch(s);if(!i.ok)throw new Error(`Failed to fetch genesis block for ${e}: ${i.status}`);o=await i.json()}else o=(await import(s)).default;return lS.set(n,o),o}async function Wz(){const{sha256:e}=await ts(async()=>{const{sha256:o}=await import("./derivation-BNPn19nD.js").then(i=>i.P);return{sha256:o}},__vite__mapDeps([0,1,2,3]),import.meta.url),{md5:t,ripemd160:n}=await ts(async()=>{const{md5:o,ripemd160:i}=await import("./derivation-BNPn19nD.js").then(c=>c.Q);return{md5:o,ripemd160:i}},__vite__mapDeps([0,1,2,3]),import.meta.url),r=o=>{const i=[];return{update(c){const a=typeof c=="string"?new TextEncoder().encode(c):c;return i.push(a),this},async digest(){const c=i.reduce((l,f)=>l+f.length,0),a=new Uint8Array(c);let u=0;for(const l of i)a.set(l,u),u+=l.length;return Buffer.from(o(a))}}};return{sha256(o){if(!o)return r(c=>e(c));const i=typeof o=="string"?new TextEncoder().encode(o):o;return Promise.resolve(Buffer.from(e(i)))},md5(o){if(!o)return r(c=>t(c));const i=typeof o=="string"?new TextEncoder().encode(o):o;return Promise.resolve(Buffer.from(t(i)))},ripemd160(o){if(!o)return r(c=>n(c));const i=typeof o=="string"?new TextEncoder().encode(o):o;return Promise.resolve(Buffer.from(n(i)))}}}async function Jz(){return sa||oa||(oa=(async()=>(sa={setup:(await ts(()=>import("./bioforest-chain-bundle-BNO2sBqj.js"),[],import.meta.url)).setup},sa))(),oa)}async function Kr(e){const{chainConfigService:t}=await ts(async()=>{const{chainConfigService:u}=await import("./service-6XO18RSB.js").then(l=>l.s);return{chainConfigService:u}},__vite__mapDeps([4,1,2,3,5,6,0]),import.meta.url),n=t.getBiowalletGenesisBlock(e);if(!n)throw new Error(`Genesis block path not configured for chain: ${e}`);const r=await Hm(e,n),s=r.magic,o=fS.get(s);if(o)return o;const i=await Jz(),c=await Wz(),a=await i.setup(r,c,{n:"KeyApp",m:"true",a:"web"});return fS.set(s,a),a}async function Fs(e){const n=await Wl(e).getLastBlock();return{height:n.height,timestamp:n.timestamp}}async function Jl(e,t){const n=Wl(e);try{return await n.getAddressInfo(t)??{address:t}}catch{return{address:t}}}async function tE(e){const t=await Kr(e.chainId),n=await Fs(e.baseUrl),r=n.height,s=n.timestamp;let o=e.fee;o||(o=await t.transactionController.getTransferTransactionMinFee({transaction:{applyBlockHeight:r,timestamp:s,remark:e.remark??{}},assetInfo:{sourceChainName:await t.getChainName(),sourceChainMagic:await t.getMagic(),assetType:e.assetType,amount:e.amount}}));let i=!1;if(e.paySecret){const u=await Jl(e.baseUrl,e.from);u.secondPublicKey&&(i=await Dm(e.chainId,e.mainSecret,e.paySecret,u.secondPublicKey)==="v1")}const c={mainSecret:e.mainSecret,...e.paySecret?{paySecret:e.paySecret,usePaySecretV1:i}:{}},a={sourceChainName:await t.getChainName(),sourceChainMagic:await t.getMagic(),assetType:e.assetType,amount:e.amount};return t.transactionController.createTransferTransactionJSON({secrets:c,transaction:{fee:o,recipientId:e.to,applyBlockHeight:r,timestamp:s,remark:e.remark??{},effectiveBlockHeight:r+100},assetInfo:a})}async function nE(e,t){const{nonce:n,...r}=t,s=Wl(e);try{const o=await s.broadcastTransaction(r);if(o&&typeof o=="object"&&"signature"in o)return{txHash:t.signature,alreadyExists:!1};const i=aS.safeParse(o);if(i.success){const c=i.data;if(!c.success){const a=c.error?.code,u=c.error?.message??c.message??"Transaction rejected";if(a==="001-00034")return{txHash:t.signature,alreadyExists:!0};throw new ra(a,u,c.minFee)}return{txHash:t.signature,alreadyExists:!1}}return{txHash:t.signature,alreadyExists:!1}}catch(o){if(o instanceof ra)throw o;if(o instanceof Js&&o.response){const i=aS.safeParse(o.response);if(i.success){const c=i.data,a=c.error?.code,u=c.error?.message??c.message??"Transaction rejected";if(a==="001-00034")return{txHash:t.signature,alreadyExists:!0};throw new ra(a,u,c.minFee)}}throw new ra(void 0,o instanceof Error?o.message:"Transaction rejected")}}async function Dm(e,t,n,r){const o=(await Kr(e)).accountBaseHelper();try{if((await o.createSecondSecretKeypairV2(t,n)).publicKey.toString("hex")===r)return"v2"}catch{}try{if((await o.createSecondSecretKeypair(t,n)).publicKey.toString("hex")===r)return"v1"}catch{}return!1}async function rE(e){const{baseUrl:t,chainId:n,intent:r,fromAddress:s}=e,o=await Kr(n),i=await Fs(t),c=i.height,a=i.timestamp;switch(r.type){case"transfer":{let u=!1;if(s)try{u=!!(await Jl(t,s)).secondPublicKey}catch{}const l=r.amount||"99999999999999999";let f=await o.transactionController.getTransferTransactionMinFee({transaction:{applyBlockHeight:c,timestamp:a,remark:r.remark??{}},assetInfo:{sourceChainName:await o.getChainName(),sourceChainMagic:await o.getMagic(),assetType:await o.getAssetType(),amount:l}});return u&&(f=String(BigInt(f)*BigInt(105)/BigInt(100))),f}case"setPayPassword":return o.transactionController.getSignatureTransactionMinFee({newPaySecret:`${Date.now()}getSignatureTransactionMinFee`,applyBlockHeight:c,timestamp:a});default:throw new Error(`Unknown fee intent type: ${r.type}`)}}async function sE(e,t,n,r,s){return rE({baseUrl:e,chainId:t,intent:{type:"transfer",amount:r??"0",remark:s},fromAddress:n})}async function oE(e,t){const n=await Kr(t),r=await Fs(e),s=r.height,o=r.timestamp;return n.transactionController.getSignatureTransactionMinFee({newPaySecret:`${Date.now()}getSignatureTransactionMinFee`,applyBlockHeight:s,timestamp:o})}async function iE(e){const t=await Kr(e.chainId),n=await Fs(e.baseUrl),r=n.height,s=n.timestamp;let o=e.fee;return o||(o=await t.transactionController.getSignatureTransactionMinFee({newPaySecret:e.newPaySecret,applyBlockHeight:r,timestamp:s})),t.transactionController.createSignatureTransactionJSON({mainSecret:e.mainSecret},{newPaySecret:e.newPaySecret,fee:o,applyBlockHeight:r,timestamp:s,effectiveBlockHeight:r+100})}async function Um(e,t,n,r){const s=await Kr(t),o=await Fs(e),i=o.height,c=o.timestamp;return s.transactionController.getDestoryAssetTransactionMinFee({transaction:{applyBlockHeight:i,timestamp:c,remark:{}},assetInfo:{sourceChainName:await s.getChainName(),sourceChainMagic:await s.getMagic(),assetType:n,amount:r}})}async function cE(e){const t=await Kr(e.chainId),n=await Fs(e.baseUrl),r=n.height,s=n.timestamp;let o=e.fee;o||(o=await Um(e.baseUrl,e.chainId,e.assetType,e.amount));let i=!1;if(e.paySecret){const l=await Jl(e.baseUrl,e.from);l.secondPublicKey&&(i=await Dm(e.chainId,e.mainSecret,e.paySecret,l.secondPublicKey)==="v1")}const c={mainSecret:e.mainSecret,...e.paySecret?{paySecret:e.paySecret,usePaySecretV1:i}:{}},a={sourceChainName:await t.getChainName(),sourceChainMagic:await t.getMagic(),assetType:e.assetType,amount:e.amount};return t.transactionController.createDestoryAssetTransactionJSON({secrets:c,transaction:{fee:o,recipientId:e.recipientId,applyBlockHeight:r,timestamp:s,remark:e.remark??{},effectiveBlockHeight:r+100},assetInfo:a})}async function Gz(e,t,n){const r=Wl(e);try{const s=await r.queryTokenDetail({assetType:t,address:n});return s?.applyAddress?{applyAddress:s.applyAddress,assetType:s.assetType}:null}catch{return null}}const Bf=Object.freeze(Object.defineProperty({__proto__:null,broadcastTransaction:nE,createDestroyTransaction:cE,createSignatureTransaction:iE,createTransferTransaction:tE,fetchGenesisBlock:Hm,getAddressInfo:Jl,getAssetDetail:Gz,getBioforestCore:Kr,getDestroyTransactionMinFee:Um,getLastBlock:Fs,getMinFee:rE,getSignatureTransactionMinFee:oE,getTransferMinFee:sE,verifyTwoStepSecret:Dm},Symbol.toStringTag,{value:"Module"}));function Yz(e){return class extends e{#e=null;get#n(){return le.getConfig(this.chainId)}get#t(){return this.#e||(this.#e=le.getBiowalletApi(this.chainId)??""),this.#e}async buildTransaction(n){switch(n.type){case"transfer":return this.#r(n);case"destroy":return this.#o(n);case"setPayPassword":return this.#s(n);default:throw new de(ge.NOT_SUPPORTED,`Transaction type not supported: ${n.type}`)}}async#r(n){const r=this.#n;if(!n.from||!n.to)throw new de(ge.INVALID_ADDRESS,"Invalid address");return{chainId:r.id,intentType:"transfer",data:{from:n.from,to:n.to,amount:n.amount.toRawString(),assetType:n.bioAssetType??r.symbol,memo:n.memo,remark:n.remark},estimatedFee:n.fee}}async#o(n){const r=this.#n;if(!n.from||!n.recipientId)throw new de(ge.INVALID_ADDRESS,"Invalid address");return{chainId:r.id,intentType:"destroy",data:{from:n.from,recipientId:n.recipientId,amount:n.amount.toRawString(),assetType:n.bioAssetType,...n.remark?{remark:n.remark}:{}},estimatedFee:n.fee}}async#s(n){const r=this.#n;if(!n.from)throw new de(ge.INVALID_ADDRESS,"Invalid address");return{chainId:r.id,intentType:"setPayPassword",data:{from:n.from},estimatedFee:n.fee}}async estimateFee(n){const r=this.#n,{decimals:s,symbol:o}=r,i=(c,a)=>({amount:c,estimatedTime:a});if(!this.#t)throw new de(ge.NETWORK_ERROR,"RPC URL not configured for BioForest chain");try{let c;switch(n.intentType){case"transfer":{const u=n.data;c=await sE(this.#t,r.id,u.from,u.amount,void 0);break}case"destroy":{const u=n.data;c=await Um(this.#t,r.id,u.assetType,u.amount);break}case"setPayPassword":{c=await oE(this.#t,r.id);break}default:throw new de(ge.NOT_SUPPORTED,`Fee estimation not supported for: ${n.intentType}`)}const a=se.fromRaw(c,s,o);return{slow:i(a,30),standard:i(a,15),fast:i(a.mul(2),5)}}catch(c){throw c instanceof de?c:new de(ge.NETWORK_ERROR,"Failed to calculate minimum fee from SDK",void 0,c instanceof Error?c:void 0)}}async signTransaction(n,r){if(!r.bioSecret)throw new de(ge.SIGNATURE_FAILED,"bioSecret is required for BioChain signing");if(!this.#t)throw new de(ge.NETWORK_ERROR,"RPC URL not configured");const s=this.#n;try{switch(n.intentType){case"transfer":{const o=n.data,i=n.estimatedFee?n.estimatedFee.toRawString():(await this.estimateFee(n)).standard.amount.toRawString(),c=o.remark??(o.memo?{memo:o.memo}:void 0),a=await tE({baseUrl:this.#t,chainId:s.id,mainSecret:r.bioSecret,paySecret:r.bioPaySecret,from:o.from,to:o.to,amount:o.amount,assetType:o.assetType,fee:i,remark:c});return{chainId:n.chainId,data:a,signature:a.signature}}case"destroy":{const o=n.data,i=n.estimatedFee?n.estimatedFee.toRawString():(await this.estimateFee(n)).standard.amount.toRawString(),c=await cE({baseUrl:this.#t,chainId:s.id,mainSecret:r.bioSecret,paySecret:r.bioPaySecret,from:o.from,recipientId:o.recipientId,assetType:o.assetType,amount:o.amount,fee:i,remark:o.remark});return{chainId:n.chainId,data:c,signature:c.signature}}case"setPayPassword":{if(!r.bioNewPaySecret)throw new de(ge.SIGNATURE_FAILED,"bioNewPaySecret is required for setPayPassword");const o=await iE({baseUrl:this.#t,chainId:s.id,mainSecret:r.bioSecret,newPaySecret:r.bioNewPaySecret});return{chainId:n.chainId,data:o,signature:o.signature}}default:throw new de(ge.NOT_SUPPORTED,`Signing not supported for: ${n.intentType}`)}}catch(o){throw o instanceof de?o:new de(ge.SIGNATURE_FAILED,"Failed to sign transaction",void 0,o instanceof Error?o:void 0)}}async broadcastTransaction(n){if(!this.#t)throw new de(ge.NETWORK_ERROR,"RPC URL not configured");try{return(await nE(this.#t,n.data)).txHash}catch(r){throw r instanceof de?r:new de(ge.TX_BROADCAST_FAILED,"Failed to broadcast transaction",void 0,r instanceof Error?r:void 0)}}}}function Qz(e){return class extends e{async bioGetAccountInfo(t){const{getAddressInfo:n}=await ts(async()=>{const{getAddressInfo:r}=await Promise.resolve().then(()=>Bf);return{getAddressInfo:r}},void 0,import.meta.url);try{const r=await n(this.endpoint,t);return{address:t,secondPublicKey:r?.secondPublicKey??null}}catch{return{address:t,secondPublicKey:null}}}async bioVerifyPayPassword(t){const{getBioforestCore:n}=await ts(async()=>{const{getBioforestCore:o}=await Promise.resolve().then(()=>Bf);return{getBioforestCore:o}},void 0,import.meta.url),s=(await n(this.chainId)).accountBaseHelper();try{if((await s.createSecondSecretKeypairV2(t.mainSecret,t.paySecret)).publicKey.toString("hex")===t.publicKey)return!0}catch{}try{if((await s.createSecondSecretKeypair(t.mainSecret,t.paySecret)).publicKey.toString("hex")===t.publicKey)return!0}catch{}return!1}async bioGetAssetDetail(t,n){const{getAssetDetail:r}=await ts(async()=>{const{getAssetDetail:s}=await Promise.resolve().then(()=>Bf);return{getAssetDetail:s}},void 0,import.meta.url);try{const s=await r(this.endpoint,t,n);return s?.applyAddress?{assetType:s.assetType,applyAddress:s.applyAddress}:null}catch{return null}}}}const Xz=A({assetNumber:g,assetType:g}),Zz=A({address:g,assets:Ky({key:g,value:Ky({key:g,value:Xz})})}),eV=A({success:ve,result:S(we(Zz))}),tV=A({assetType:g,amount:g}),nV=A({totalAmount:g,assetType:g}),rV=A({transactionSignature:g}),sV=A({trustees:ue(g),numberOfSignFor:N,assetType:g,amount:g}),oV=A({publicKey:S(g)}),iV=A({assetType:g,amount:g}),cV=A({entityId:S(g)}),aV=A({factoryId:S(g)}),uV=A({transferAsset:S(tV),giftAsset:S(nV),grabAsset:S(rV),trustAsset:S(sV),signature:S(oV),destroyAsset:S(iV),issueEntity:S(cV),issueEntityFactory:S(aV)}),aE=A({type:g,senderId:g,recipientId:l0(g,{default:()=>""}),timestamp:N,signature:g,asset:S(uV)}),lV=A({height:N,signature:g,transaction:aE}),fV=A({trs:ue(lV),count:S(N)}),hS=A({success:ve,result:S(fV)}),hV=A({height:N}),dV=A({success:ve,result:S(hV)}),pV=A({state:N,trJson:aE,signature:S(g),createdTime:g}),mV=A({success:ve,result:S(ue(pV))});function uE(e,t,n){const r=e.toLowerCase(),s=t.toLowerCase(),o=n.toLowerCase();return s&&r===o&&s===o?"self":r===o?"out":"in"}const gV=0;function lE(e){const t={"AST-01":"transfer","AST-02":"transfer","AST-03":"destroyAsset","BSE-01":"signature","ETY-01":"issueEntity","ETY-02":"issueEntity","GFT-01":"gift","GFT-02":"gift","GRB-01":"grab","GRB-02":"grab","TRS-01":"trust","TRS-02":"trust","SGN-01":"signFor","SGN-02":"signFor","EMI-01":"emigrate","EMI-02":"emigrate","IMI-01":"immigrate","IMI-02":"immigrate","ISA-01":"issueAsset","ICA-01":"increaseAsset","DSA-01":"destroyAsset","ISE-01":"issueEntity","DSE-01":"destroyEntity","LNS-01":"locationName","DAP-01":"dapp","CRT-01":"certificate","MRK-01":"mark"},n=e.split("-");if(n.length>=4){const r=`${n[n.length-2]}-${n[n.length-1]}`;return t[r]??"unknown"}return"unknown"}function fE(e,t){return e?e.transferAsset?{value:e.transferAsset.amount,assetType:e.transferAsset.assetType}:e.giftAsset?{value:e.giftAsset.totalAmount,assetType:e.giftAsset.assetType}:e.trustAsset?{value:e.trustAsset.amount,assetType:e.trustAsset.assetType}:e.grabAsset?{value:"0",assetType:t}:e.destroyAsset?{value:e.destroyAsset.amount,assetType:e.destroyAsset.assetType}:e.issueEntity||e.issueEntityFactory?{value:"0",assetType:t}:e.signature?{value:"0",assetType:t}:{value:null,assetType:t}:{value:null,assetType:t}}function dS(e,t){const{signature:n,height:r,status:s,createdTime:o,address:i="",epochMs:c}=t,{value:a,assetType:u}=fE(e.asset,"BFM"),l=o?new Date(o).getTime():c+e.timestamp*1e3,f=i?uE(e.senderId,e.recipientId??"",i):"out";return{hash:n,from:e.senderId,to:e.recipientId??"",timestamp:l,status:s,blockNumber:r!==void 0?BigInt(r):void 0,action:lE(e.type),direction:f,assets:[{assetType:"native",value:a??"0",symbol:u,decimals:8}]}}class yV{chainId;type;endpoint;config;constructor(t,n){this.type=t.type,this.endpoint=t.endpoint,this.config=t.config,this.chainId=n}}class hE extends Qz(Dz(Yz(yV))){symbol;decimals;baseUrl;forgeInterval=15e3;epochMs=gV;get pendingTxCacheTtl(){return Math.max(1e3,Math.floor(this.forgeInterval/4))}_eventBus=null;_txHistorySources=new Map;_txHistoryCreations=new Map;_balanceSources=new Map;_balanceCreations=new Map;_tokenBalanceSources=new Map;_tokenBalanceCreations=new Map;nativeBalance;tokenBalances;transactionHistory;blockHeight;transaction;constructor(t,n){super(t,n),this.symbol=le.getSymbol(n),this.decimals=le.getDecimals(n),this.baseUrl=this.endpoint;const r=le.getBiowalletGenesisBlock(n);r&&Hm(n,r).then(c=>{const a=c.asset.genesisAsset.forgeInterval;typeof a=="number"&&(this.forgeInterval=a*1e3,Lz(n,this.forgeInterval));const u=c.asset.genesisAsset.beginEpochTime;typeof u=="number"&&(this.epochMs=u)}).catch(c=>{console.warn("Failed to fetch genesis block:",c)});const s=this.symbol,o=this.decimals,i=this;this.transactionHistory=Se(`biowallet.${n}.transactionHistory`,c=>i.createTransactionHistorySource(c,s,o)),this.nativeBalance=Se(`biowallet.${n}.nativeBalance`,c=>i.createBalanceSource(c,s,o)),this.tokenBalances=Se(`biowallet.${n}.tokenBalances`,c=>i.createTokenBalancesSource(c,s,o)),this.blockHeight=Se(`biowallet.${n}.blockHeight`,()=>i.createBlockHeightSource()),this.transaction=Se(`biowallet.${n}.transaction`,c=>i.createTransactionSource(c))}getSharedBlockHeightSource(){const t=this,n=zl(this.chainId,"global","blockHeight"),r=t.fetchBlockHeight().pipe(j(s=>s.result?.height?BigInt(s.result.height):BigInt(0)));return Vl(n,{fetch:r,interval:ie(this.forgeInterval)})}getSharedTxHistorySource(t,n,r){const s=this,o=t.toLowerCase(),i=o,c=l=>({...l,stop:s.releaseSharedTxHistorySource(i)}),a=s._txHistorySources.get(i);if(a)return a.refCount+=1,z(c(a.source));const u=s._txHistoryCreations.get(i);return W(u?async()=>{const l=await u,f=s._txHistorySources.get(i);return f&&(f.refCount+=1),c(l)}:async()=>{const l=Q($(function*(){const f=yield*s.getSharedBlockHeightSource(),h=yield*Le({name:`biowallet.${s.chainId}.txHistory.${o}`,dependsOn:f.ref,hasChanged:()=>!0,fetch:(_,k)=>s.fetchTransactionList({address:t,limit:50},!0).pipe(j(C=>C.result?.trs?C.result.trs.map(v=>{const T=v.transaction,R=lE(T.type),w=uE(T.senderId,T.recipientId??"",o),{value:I,assetType:O}=fE(T.asset,n);return I===null?null:{hash:T.signature??v.signature,from:T.senderId,to:T.recipientId??"",timestamp:s.epochMs+T.timestamp*1e3,status:"confirmed",blockNumber:BigInt(v.height),action:R,direction:w,assets:[{assetType:"native",value:I,symbol:O,decimals:r}]}}).filter(v=>v!==null).sort((v,T)=>T.timestamp-v.timestamp):[]))});s._eventBus||(s._eventBus=yield*Tn());const y=yield*s._eventBus.forWalletEvents(s.chainId,o,["tx:confirmed"]).pipe(qn(()=>Ve(h.refresh,()=>me)),ot),b=ze([h.stop,Fe(y)]).pipe(Ae);return s._txHistorySources.set(i,{source:h,refCount:1,stopAll:b}),h}));s._txHistoryCreations.set(i,l);try{const f=await l;return c(f)}finally{s._txHistoryCreations.delete(i)}})}releaseSharedTxHistorySource(t){const n=this;return $(function*(){const r=n._txHistorySources.get(t);r&&(r.refCount-=1,r.refCount<=0&&(yield*r.stopAll,n._txHistorySources.delete(t)))})}getSharedBalanceSource(t,n,r){const s=this,i=t.toLowerCase(),c=l=>({...l,stop:s.releaseSharedBalanceSource(i)}),a=s._balanceSources.get(i);if(a)return a.refCount+=1,z(c(a.source));const u=s._balanceCreations.get(i);return W(u?async()=>{const l=await u,f=s._balanceSources.get(i);return f&&(f.refCount+=1),c(l)}:async()=>{const l=Q($(function*(){const f=yield*s.getSharedTxHistorySource(t,n,r),h=yield*Le({name:`biowallet.${s.chainId}.balance`,dependsOn:f.ref,hasChanged:()=>!0,fetch:(y,b)=>s.fetchAddressAsset(t,b??!1).pipe(j(_=>{if(!_.result?.assets)return{amount:se.zero(r,n),symbol:n};for(const k of Object.values(_.result.assets))for(const C of Object.values(k))if(C.assetType===n)return{amount:se.fromRaw(C.assetNumber,r,n),symbol:n};return{amount:se.zero(r,n),symbol:n}}))}),m=ze([h.stop,f.stop]).pipe(Ae);return s._balanceSources.set(i,{source:h,refCount:1,stopAll:m}),h}));s._balanceCreations.set(i,l);try{const f=await l;return c(f)}finally{s._balanceCreations.delete(i)}})}releaseSharedBalanceSource(t){const n=this;return $(function*(){const r=n._balanceSources.get(t);r&&(r.refCount-=1,r.refCount<=0&&(yield*r.stopAll,n._balanceSources.delete(t)))})}getSharedTokenBalancesSource(t,n,r){const s=this,i=t.toLowerCase(),c=l=>({...l,stop:s.releaseSharedTokenBalancesSource(i)}),a=s._tokenBalanceSources.get(i);if(a)return a.refCount+=1,z(c(a.source));const u=s._tokenBalanceCreations.get(i);return W(u?async()=>{const l=await u,f=s._tokenBalanceSources.get(i);return f&&(f.refCount+=1),c(l)}:async()=>{const l=Q($(function*(){const f=yield*s.getSharedTxHistorySource(t,n,r),h=yield*Le({name:`biowallet.${s.chainId}.tokenBalances`,dependsOn:f.ref,hasChanged:()=>!0,fetch:(y,b)=>s.fetchAddressAsset(t,b??!1).pipe(j(_=>{if(!_.result?.assets)return[];const k=[];for(const C of Object.values(_.result.assets))for(const v of Object.values(C)){const T=v.assetType===n;k.push({symbol:v.assetType,name:v.assetType,amount:se.fromRaw(v.assetNumber,r,v.assetType),isNative:T,decimals:r})}return k.sort((C,v)=>C.isNative&&!v.isNative?-1:!C.isNative&&v.isNative?1:v.amount.toNumber()-C.amount.toNumber()),k}))}),m=ze([h.stop,f.stop]).pipe(Ae);return s._tokenBalanceSources.set(i,{source:h,refCount:1,stopAll:m}),h}));s._tokenBalanceCreations.set(i,l);try{const f=await l;return c(f)}finally{s._tokenBalanceCreations.delete(i)}})}releaseSharedTokenBalancesSource(t){const n=this;return $(function*(){const r=n._tokenBalanceSources.get(t);r&&(r.refCount-=1,r.refCount<=0&&(yield*r.stopAll,n._tokenBalanceSources.delete(t)))})}createTransactionHistorySource(t,n,r){return this.getSharedTxHistorySource(t.address,n,r)}createBalanceSource(t,n,r){return this.getSharedBalanceSource(t.address,n,r)}createTokenBalancesSource(t,n,r){return this.getSharedTokenBalancesSource(t.address,n,r)}createBlockHeightSource(){return this.getSharedBlockHeightSource()}createTransactionSource(t){const n=this;return $(function*(){const r=ze({pending:n.fetchPendingTransactions(t.senderId??""),confirmed:n.fetchSingleTransaction(t.txHash)}).pipe(j(({pending:o,confirmed:i})=>{if(i.result?.trs?.length){const c=i.result.trs[0];return dS(c.transaction,{signature:c.transaction.signature??c.signature,height:c.height,status:"confirmed",epochMs:n.epochMs})}if(o.result&&o.result.length>0){const c=o.result.find(a=>a.signature===t.txHash);if(c)return dS(c.trJson,{signature:c.trJson.signature??c.signature??"",status:"pending",createdTime:c.createdTime,epochMs:n.epochMs})}return null}));return yield*ke({name:`biowallet.${n.chainId}.transaction`,fetch:r,interval:ie(n.forgeInterval)})})}fetchBlockHeight(){return Z({url:`${this.baseUrl}/lastblock`,schema:dV,cacheStrategy:"network-first",cache:"no-store",headers:{"Cache-Control":"no-cache"}})}fetchAddressAsset(t,n=!1){return Z({url:`${this.baseUrl}/address/asset`,method:"POST",body:{address:t},schema:eV,cacheStrategy:n?"network-first":"cache-first"})}fetchTransactionList(t,n=!1){return Z({url:`${this.baseUrl}/transactions/query`,method:"POST",body:{address:t.address,page:t.page??1,pageSize:t.limit??50,sort:-1},schema:hS,cacheStrategy:n?"network-first":"cache-first"})}fetchSingleTransaction(t){return Z({url:`${this.baseUrl}/transactions/query`,method:"POST",body:{signature:t},schema:hS,cacheStrategy:"ttl",cacheTtl:this.pendingTxCacheTtl})}fetchPendingTransactions(t){return Z({url:`${this.baseUrl}/pendingTr`,method:"POST",body:{senderId:t,sort:-1},schema:mV,cacheStrategy:"ttl",cacheTtl:this.pendingTxCacheTtl})}}function dE(e,t){return e.type==="biowallet-v1"?new hE(e,t):null}const SV=A({success:ve,result:S(we(De(g,N)))}),bV=De(SV,g,N),_V=A({blockNumber:S(g),timeStamp:g,hash:g,from:g,to:g,value:g,isError:S(g),txreceipt_status:S(g)}),wV=A({blockNumber:S(g),timeStamp:g,hash:g,from:g,to:g,value:g,tokenSymbol:S(g),tokenName:S(g),tokenDecimal:S(g),contractAddress:S(g)}),vV=A({status:S(g),message:S(g),result:ue(_V)}),kV=A({status:S(g),message:S(g),result:ue(wV)}),TV=A({success:ve,result:S(vV)}),EV=A({success:ve,result:S(kV)}),pE=A({amount:we(De(g,N)),contractAddress:S(we(g)),decimals:S(we(N)),icon:S(we(g)),symbol:S(we(g)),name:S(we(g))}),CV=ue(pE),IV=A({success:ve,result:S(we(ue(pE)))}),pS=De(CV,IV),$V=A({chain:S(g),address:g,name:g,icon:S(g),symbol:g,decimals:N}),AV=A({data:ue($V),page:N,pageSize:N,total:N,pages:S(N)}),RV=A({success:ve,result:S(AV)});function mS(e,t,n){const r=e.toLowerCase(),s=t.toLowerCase();return r===n&&s===n?"self":r===n?"out":"in"}function Li(e){return e==null?"0":String(e)}function Us(e){return typeof e=="string"||typeof e=="number"?{success:!0,amount:Li(e)}:{success:e.success,amount:Li(e.result)}}function OV(e){return Promise.resolve(e.success)}function zc(e){if(!e)return!1;const t=e.status?.toUpperCase(),n=e.message?.toUpperCase();return n==="NO TRANSACTIONS FOUND"?!0:!(t==="0"||n==="NOTOK")}function gS(e){return e.success?Promise.resolve(zc(e.result)):Promise.resolve(!1)}function PV(e){return typeof e=="string"||typeof e=="number"?Promise.resolve(!0):Promise.resolve(e.success)}function yS(e){return Array.isArray(e)?Promise.resolve(!0):Promise.resolve(e.success)}function SS(e){return Array.isArray(e)?e:e.result??[]}function FV(e){return!e||!e.success?!1:zc(e.result)}function Ks(e,t){t.success}function xV(e){if(typeof e=="number")return e;if(typeof e=="string"){const t=Number.parseInt(e,10);return Number.isNaN(t)?0:t}return 0}function bS(e,t){return!e||e.length!==t.length?!0:e.length===0&&t.length===0?!1:e[0]?.hash!==t[0]?.hash}function NV(e,t){const n=new Map;for(const r of e)n.set(r.hash,r);for(const r of t){const s=n.get(r.hash);if(s){s.assets=[...s.assets,...r.assets],n.set(r.hash,s);continue}n.set(r.hash,r)}return Array.from(n.values()).sort((r,s)=>s.timestamp-r.timestamp)}function BV(e){const t=new Set;for(const n of e)for(const r of n.assets)r.assetType==="token"&&r.contractAddress&&t.add(r.contractAddress);return[...t].sort()}function _S(e){return!e.success||!e.result?[]:e.result.data.map(t=>t.address).filter(t=>t.length>0).map(t=>t.toLowerCase()).sort()}function MV(e){return e.success&&e.result?e:{success:!0,result:{data:[],page:1,pageSize:0,total:0}}}function LV(e,t){return t.success&&zc(t.result)?z(t):Ct(new it(`[bscwallet] ${e} NOTOK`))}function HV(e,t){return t.success&&zc(t.result)?z(t):Ct(new it(`[bscwallet] ${e} NOTOK`))}class DV{chainId;type;endpoint;config;constructor(t,n){this.type=t.type,this.endpoint=t.endpoint,this.config=t.config,this.chainId=n}}class mE extends oi(ii(DV)){symbol;decimals;baseUrl;pollingInterval=3e4;balanceCacheTtlMs=5e3;tokenListCacheTtl=600*1e3;_normalHistoryDisabled=!1;_eventBus=null;_txHistorySources=new Map;_txHistoryCreations=new Map;_balanceSources=new Map;_balanceCreations=new Map;_tokenBalanceSources=new Map;_tokenBalanceCreations=new Map;_tokenListSource=null;_tokenListCreation=null;nativeBalance;tokenBalances;transactionHistory;constructor(t,n){super(t,n),this.symbol=le.getSymbol(n),this.decimals=le.getDecimals(n),this.baseUrl=this.endpoint;const r=this;this.transactionHistory=Se(`bscwallet.${n}.transactionHistory`,s=>r.createTransactionHistorySource(s)),this.nativeBalance=Se(`bscwallet.${n}.nativeBalance`,s=>r.createBalanceSource(s)),this.tokenBalances=Se(`bscwallet.${n}.tokenBalances`,s=>r.createTokenBalancesSource(s))}createTransactionHistorySource(t){return this.getSharedTxHistorySource(t.address)}createBalanceSource(t){return this.getSharedBalanceSource(t.address).pipe(Nr(n=>this.createBalanceFallbackSource(t.address)))}createTokenBalancesSource(t){return this.getSharedTokenBalanceSource(t.address).pipe(Nr(n=>this.createTokenBalancesFallbackSource(t.address)))}createBalanceFallbackSource(t){const n=this.symbol,r=this.decimals;return ke({name:`bscwallet.${this.chainId}.balance.fallback`,interval:ie(this.pollingInterval),immediate:!0,fetch:this.fetchBalance(t,!0).pipe(j(s=>{const o=Us(s);return{amount:se.fromRaw(o.amount,r,n),symbol:n}}))})}createTokenBalancesFallbackSource(t){const n=this.symbol,r=this.decimals;return ke({name:`bscwallet.${this.chainId}.tokenBalances.fallback`,interval:ie(this.pollingInterval),immediate:!0,fetch:this.fetchTokenBalances(t,[],!0).pipe(j(s=>{const o=[],i=Us(s.native);o.push({symbol:n,name:n,amount:se.fromRaw(i.amount,r,n),isNative:!0,decimals:r});for(const c of s.tokens){const a=c.symbol??"BEP20",u=c.decimals??0;o.push({symbol:a,name:c.name??a,amount:se.fromRaw(Li(c.amount),u,a),isNative:!1,decimals:u,icon:c.icon,contractAddress:c.contractAddress})}return o}))})}getSharedTxHistorySource(t){const n=this,r=t.toLowerCase(),s=r,o=this.symbol,i=this.decimals,c=l=>({...l,stop:n.releaseSharedTxHistorySource(s)}),a=n._txHistorySources.get(s);if(a)return a.refCount+=1,z(c(a.source));const u=n._txHistoryCreations.get(s);return W(u?async()=>{const l=await u,f=n._txHistorySources.get(s);return f&&(f.refCount+=1),c(l)}:async()=>{const l=Q($(function*(){n._eventBus||(n._eventBus=yield*Tn());const f=n._eventBus,h=yield*ke({name:`bscwallet.${n.chainId}.txHistory.native.${s}`,fetch:n.fetchNativeHistory({address:t,limit:50},!0),interval:ie(n.pollingInterval),walletEvents:{eventBus:f,chainId:n.chainId,address:t,types:["tx:confirmed","tx:sent"]}}),m=yield*h.get;if(!FV(m))return yield*h.stop,yield*Ct(new it("[bscwallet] trans/normal/history NOTOK"));const y=yield*n.getSharedTokenListSource(),b=yield*$t(0),_=en(b,E=>E+1).pipe(Ae),k=yield*$t(new Map),C=[],v=E=>ot(E.pipe(us(()=>_),fr));C.push(yield*v(h.changes));const T=new Map,R=new Map,w=E=>$(function*(){if(T.has(E))return;const V=yield*ke({name:`bscwallet.${n.chainId}.txHistory.bep20.${s}.${E}`,fetch:n.fetchTokenHistory({address:t,limit:50,contractAddress:E},!0),interval:ie(n.pollingInterval),immediate:!1,walletEvents:{eventBus:f,chainId:n.chainId,address:t,types:["tx:confirmed","tx:sent"]}});T.set(E,V);const q=yield*ot(V.changes.pipe(qn(D=>en(k,B=>{const x=new Map(B);return x.set(E,D),x}).pipe(Ce(_)))));R.set(E,q),yield*ot(V.refresh.pipe(Ae))}),I=E=>$(function*(){const V=T.get(E);V&&(yield*V.stop,T.delete(E));const q=R.get(E);q&&(yield*Fe(q),R.delete(E)),yield*en(k,D=>{const B=new Map(D);return B.delete(E),B}).pipe(Ce(_))}),O=E=>$(function*(){const V=E?_S(E):[],q=new Set(V);for(const D of T.keys())q.has(D)||(yield*I(D));for(const D of q)T.has(D)||(yield*w(D))});yield*O(yield*y.get),C.push(yield*ot(y.changes.pipe(qn(E=>O(E).pipe(Ce(_))))));const H=yield*Le({name:`bscwallet.${n.chainId}.txHistory.${s}`,dependsOn:b,hasChanged:(E,V)=>E!==V,fetch:()=>$(function*(){const V=((yield*h.get)?.result?.result??[]).map(B=>{const x=B.isError==="1"||B.txreceipt_status==="0"?"failed":"confirmed";return{hash:B.hash,from:B.from,to:B.to,timestamp:parseInt(B.timeStamp,10)*1e3,status:x,blockNumber:B.blockNumber?BigInt(B.blockNumber):void 0,action:"transfer",direction:mS(B.from,B.to,r),assets:[{assetType:"native",value:B.value,symbol:o,decimals:i}]}}),D=[...(yield*Bt(k)).values()].flatMap(B=>(B?.result?.result??[]).map(x=>{const ce=x.tokenSymbol??"BEP20",je=xV(x.tokenDecimal),Vt=x.contractAddress?.toLowerCase();return{hash:x.hash,from:x.from,to:x.to,timestamp:parseInt(x.timeStamp,10)*1e3,status:"confirmed",blockNumber:x.blockNumber?BigInt(x.blockNumber):void 0,action:"transfer",direction:mS(x.from,x.to,r),assets:[{assetType:"token",value:x.value,symbol:ce,decimals:je,contractAddress:Vt,name:x.tokenName}]}}));return NV(V,D)})}),F=$(function*(){for(const E of C)yield*Fe(E);for(const E of T.values())yield*E.stop;for(const E of R.values())yield*Fe(E);yield*H.stop,yield*h.stop,yield*n.releaseSharedTokenListSource()});return n._txHistorySources.set(s,{source:H,refCount:1,stopAll:F}),H}));n._txHistoryCreations.set(s,l);try{const f=await l;return c(f)}finally{n._txHistoryCreations.delete(s)}})}releaseSharedTxHistorySource(t){const n=this;return $(function*(){const r=n._txHistorySources.get(t);r&&(r.refCount-=1,r.refCount<=0&&(yield*r.stopAll,n._txHistorySources.delete(t)))})}getSharedBalanceSource(t){const n=this,r=t.toLowerCase(),s=this.symbol,o=this.decimals,i=u=>({...u,stop:n.releaseSharedBalanceSource(r)}),c=n._balanceSources.get(r);if(c)return c.refCount+=1,z(i(c.source));const a=n._balanceCreations.get(r);return W(a?async()=>{const u=await a,l=n._balanceSources.get(r);return l&&(l.refCount+=1),i(u)}:async()=>{const u=Q($(function*(){const l=yield*Ve(n.getSharedTxHistorySource(t),w=>$(function*(){return null}));if(l===null){const w=yield*ke({name:`bscwallet.${n.chainId}.balance.poll`,interval:ie(n.pollingInterval),immediate:!0,fetch:n.fetchBalance(t,!0).pipe(j(I=>{const O=Us(I);return{amount:se.fromRaw(O.amount,o,s),symbol:s}}))});return n._balanceSources.set(r,{source:w,refCount:1,stopAll:w.stop}),w}const f=yield*$t(null),h=yield*$t(0),m=en(h,w=>w+1).pipe(Ae),y=w=>{const I=Us(w);return{amount:se.fromRaw(I.amount,o,s),symbol:s}},b=yield*Le({name:`bscwallet.${n.chainId}.balance.dep`,dependsOn:l.ref,hasChanged:bS,fetch:(w,I)=>n.fetchBalance(t,I).pipe(j(y),Ie(O=>Rt(f,O)))}),_=(yield*l.get)===null,k=yield*ke({name:`bscwallet.${n.chainId}.balance.poll`,interval:ie(n.pollingInterval),immediate:_,fetch:$(function*(){const w=yield*l.get,I=yield*Bt(f);if(w!==null&&I!==null)return I;const O=yield*n.fetchBalance(t,!0),H=y(O);return yield*Rt(f,H),H})}),C=[],v=w=>ot(w.pipe(us(()=>m),fr));C.push(yield*v(b.changes)),C.push(yield*v(k.changes));const T=yield*Le({name:`bscwallet.${n.chainId}.balance`,dependsOn:h,hasChanged:(w,I)=>w!==I,fetch:()=>$(function*(){const w=yield*Bt(f);return w||(yield*Ct(new it("[bscwallet] balance cache empty")))})}),R=$(function*(){for(const w of C)yield*Fe(w);yield*b.stop,yield*k.stop,yield*T.stop,yield*l.stop});return n._balanceSources.set(r,{source:T,refCount:1,stopAll:R}),T}));n._balanceCreations.set(r,u);try{const l=await u;return i(l)}finally{n._balanceCreations.delete(r)}})}releaseSharedBalanceSource(t){const n=this;return $(function*(){const r=n._balanceSources.get(t);r&&(r.refCount-=1,r.refCount<=0&&(yield*r.stopAll,n._balanceSources.delete(t)))})}getSharedTokenBalanceSource(t){const n=this,r=t.toLowerCase(),s=this.symbol,o=this.decimals,i=u=>({...u,stop:n.releaseSharedTokenBalanceSource(r)}),c=n._tokenBalanceSources.get(r);if(c)return c.refCount+=1,z(i(c.source));const a=n._tokenBalanceCreations.get(r);return W(a?async()=>{const u=await a,l=n._tokenBalanceSources.get(r);return l&&(l.refCount+=1),i(u)}:async()=>{const u=Q($(function*(){const l=yield*Ve(n.getSharedTxHistorySource(t),w=>$(function*(){return null}));if(l===null){const w=yield*ke({name:`bscwallet.${n.chainId}.tokenBalances.poll`,interval:ie(n.pollingInterval),immediate:!0,fetch:n.fetchTokenBalances(t,[],!0).pipe(j(I=>{const O=[],H=Us(I.native);O.push({symbol:s,name:s,amount:se.fromRaw(H.amount,o,s),isNative:!0,decimals:o});for(const F of I.tokens){const E=F.symbol??"BEP20",V=F.decimals??0;O.push({symbol:E,name:F.name??E,amount:se.fromRaw(Li(F.amount),V,E),isNative:!1,decimals:V,icon:F.icon,contractAddress:F.contractAddress})}return O}))});return n._tokenBalanceSources.set(r,{source:w,refCount:1,stopAll:w.stop}),w}const f=yield*$t(null),h=yield*$t(0),m=en(h,w=>w+1).pipe(Ae),y=w=>{const I=[],O=Us(w.native);I.push({symbol:s,name:s,amount:se.fromRaw(O.amount,o,s),isNative:!0,decimals:o});for(const H of w.tokens){const F=H.symbol??"BEP20",E=H.decimals??0;I.push({symbol:F,name:H.name??F,amount:se.fromRaw(Li(H.amount),E,F),isNative:!1,decimals:E,icon:H.icon,contractAddress:H.contractAddress})}return I},b=yield*Le({name:`bscwallet.${n.chainId}.tokenBalances.dep`,dependsOn:l.ref,hasChanged:bS,fetch:(w,I)=>n.fetchTokenBalances(t,BV(w),I).pipe(j(y),Ie(O=>Rt(f,O)))}),_=(yield*l.get)===null,k=yield*ke({name:`bscwallet.${n.chainId}.tokenBalances.poll`,interval:ie(n.pollingInterval),immediate:_,fetch:$(function*(){const w=yield*l.get,I=yield*Bt(f);if(w!==null&&I!==null)return I;const O=yield*n.fetchTokenBalances(t,[],!0),H=y(O);return yield*Rt(f,H),H})}),C=[],v=w=>ot(w.pipe(us(()=>m),fr));C.push(yield*v(b.changes)),C.push(yield*v(k.changes));const T=yield*Le({name:`bscwallet.${n.chainId}.tokenBalances`,dependsOn:h,hasChanged:(w,I)=>w!==I,fetch:()=>$(function*(){const w=yield*Bt(f);return w||(yield*Ct(new it("[bscwallet] tokenBalances cache empty")))})}),R=$(function*(){for(const w of C)yield*Fe(w);yield*b.stop,yield*k.stop,yield*T.stop,yield*l.stop});return n._tokenBalanceSources.set(r,{source:T,refCount:1,stopAll:R}),T}));n._tokenBalanceCreations.set(r,u);try{const l=await u;return i(l)}finally{n._tokenBalanceCreations.delete(r)}})}releaseSharedTokenBalanceSource(t){const n=this;return $(function*(){const r=n._tokenBalanceSources.get(t);r&&(r.refCount-=1,r.refCount<=0&&(yield*r.stopAll,n._tokenBalanceSources.delete(t)))})}getSharedTokenListSource(){const t=this;return t._tokenListSource?(t._tokenListSource.refCount+=1,z(t._tokenListSource.source)):t._tokenListCreation?W(async()=>{const n=await t._tokenListCreation;return t._tokenListSource&&(t._tokenListSource.refCount+=1),n}):W(async()=>{const n=Q($(function*(){const r=yield*ke({name:`bscwallet.${t.chainId}.tokenList`,fetch:t.fetchTokenList(!1),interval:ie(t.tokenListCacheTtl),immediate:!0});return t._tokenListSource={source:r,refCount:1,stopAll:r.stop},r}));t._tokenListCreation=n;try{return await n}finally{t._tokenListCreation=null}})}releaseSharedTokenListSource(){const t=this;return $(function*(){const n=t._tokenListSource;n&&(n.refCount-=1,n.refCount<=0&&(yield*n.stopAll,t._tokenListSource=null))})}fetchBalance(t,n=!1){return Z({url:`${this.baseUrl}/balance?address=${t}`,schema:bV,cacheStrategy:n?"ttl":"cache-first",cacheTtl:this.balanceCacheTtlMs,canCache:PV}).pipe(Ie(r=>{typeof r=="object"&&r!==null&&"success"in r&&Ks("balance",r)}))}fetchNativeHistory(t,n=!1){return this._normalHistoryDisabled?Ct(new it("[bscwallet] trans/normal/history disabled")):Z({url:`${this.baseUrl}/trans/normal/history`,method:"POST",body:{address:t.address,page:1,offset:t.limit??50},schema:TV,cacheStrategy:n?"ttl":"cache-first",cacheTtl:this.balanceCacheTtlMs,canCache:gS}).pipe(Ie(r=>Ks("trans/normal/history",r)),X(r=>(r.success&&r.result&&!zc(r.result)&&(this._normalHistoryDisabled=!0),LV("trans/normal/history",r))))}fetchTokenHistory(t,n=!1){return t.contractAddress?Z({url:`${this.baseUrl}/trans/bep20/history`,method:"POST",body:{address:t.address,contractaddress:t.contractAddress,page:1,offset:t.limit??50},schema:EV,cacheStrategy:n?"ttl":"cache-first",cacheTtl:this.balanceCacheTtlMs,canCache:gS}).pipe(Ie(r=>Ks("trans/bep20/history",r)),X(r=>HV("trans/bep20/history",r))):z({success:!0,result:{result:[]}})}fetchTokenBalances(t,n,r=!1){const s=[...n].sort();if(s.length===0){const o=this;return $(function*(){const i=yield*o.fetchTokenList(!1),c=_S(i),a=yield*o.fetchBalance(t,r);if(c.length===0)return{native:a,tokens:[]};const u=yield*Z({url:`${o.baseUrl}/account/balance/v2`,method:"POST",body:{address:t,contracts:c},schema:pS,cacheStrategy:r?"ttl":"cache-first",cacheTtl:o.balanceCacheTtlMs,canCache:yS}).pipe(Ie(l=>{Array.isArray(l)||Ks("account/balance/v2",l)}),j(SS),Ve(()=>z([])));return{native:a,tokens:u}})}return ze({native:this.fetchBalance(t,r),tokens:Z({url:`${this.baseUrl}/account/balance/v2`,method:"POST",body:{address:t,contracts:s},schema:pS,cacheStrategy:r?"ttl":"cache-first",cacheTtl:this.balanceCacheTtlMs,canCache:yS}).pipe(Ie(o=>{Array.isArray(o)||Ks("account/balance/v2",o)}),j(SS),Ve(()=>z([])))})}fetchTokenList(t=!1){return Z({url:`${this.baseUrl}/contract/tokens`,method:"POST",body:{page:1,pageSize:50,chain:"BSC"},schema:RV,cacheStrategy:t?"network-first":"ttl",cacheTtl:this.tokenListCacheTtl,canCache:OV}).pipe(Ie(n=>Ks("contract/tokens",n)),j(MV))}}function gE(e,t){return e.type==="bscwallet-v1"?new mE(e,t):null}const ia="123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz";function yE(e){return class extends e{async deriveAddress(n,r=0){const s=new TextDecoder().decode(n);return Aa(s,"tron",r).address}async deriveAddresses(n,r,s){const o=new TextDecoder().decode(n),i=[];for(let c=0;c<s;c++){const a=Aa(o,"tron",r+c);i.push(a.address)}return i}isValidAddress(n){if(!n.startsWith("T")||n.length!==34)return!1;for(const r of n)if(!ia.includes(r))return!1;try{const r=this.#e(n);if(r.length!==25)return!1;const s=r.slice(0,21),o=r.slice(21),i=kr(kr(s));return o.every((c,a)=>c===i[a])}catch{return!1}}#e(n){let r=BigInt(0);for(const i of n){const c=ia.indexOf(i);if(c===-1)throw new Error(`Invalid base58 character: ${i}`);r=r*58n+BigInt(c)}const s=r.toString(16).padStart(50,"0"),o=new Uint8Array(25);for(let i=0;i<25;i++)o[i]=parseInt(s.slice(i*2,i*2+2),16);return o}normalizeAddress(n){return n}async signMessage(n,r){const s=typeof n=="string"?new TextEncoder().encode(n):n,o=new TextEncoder().encode(`TRON Signed Message:
`+s.length),i=Ii(new Uint8Array([...o,...s])),c=go.sign(i,r,{prehash:!1,format:"recovered"});return Cr(c)}async verifyMessage(n,r,s){try{const o=typeof n=="string"?new TextEncoder().encode(n):n,i=new TextEncoder().encode(`TRON Signed Message:
`+o.length),c=Ii(new Uint8Array([...i,...o])),a=to(r),u=go.recoverPublicKey(c,a);if(!u)return!1;const f=Ii(u.slice(1)).slice(-20),h=new Uint8Array([65,...f]),m=kr(kr(h)).slice(0,4),y=new Uint8Array([...h,...m]);return this.#n(y)===s}catch{return!1}}#n(n){let r=BigInt(0);for(const o of n)r=r*256n+BigInt(o);let s="";for(;r>0n;){const o=Number(r%58n);r=r/58n,s=ia[o]+s}for(const o of n)if(o===0)s=ia[0]+s;else break;return s}}}const UV="https://api.trongrid.io";function SE(e){return class extends e{#e=null;#n="";#t(){if(!this.#e){const n=le.getConfig(this.chainId);if(!n)throw new de(ge.CHAIN_NOT_SUPPORTED,`Chain config not found: ${this.chainId}`);this.#e=n,this.#n=le.getRpcUrl(this.chainId)||UV}return this.#e}async#r(n,r){const s=`${this.#n}${n}`,o=r?{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(r)}:{method:"GET"},i=await fetch(s,o);if(!i.ok)throw new de(ge.NETWORK_ERROR,`Tron API error: ${i.status} ${i.statusText}`);return i.json()}#o(n){const r="123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz";let s=BigInt(0);for(const i of n){const c=r.indexOf(i);if(c===-1)throw new Error(`Invalid base58 character: ${i}`);s=s*58n+BigInt(c)}return s.toString(16).padStart(50,"0").slice(0,42)}async buildTransaction(n){if(n.type!=="transfer")throw new de(ge.NOT_SUPPORTED,`Transaction type not supported: ${n.type}`);const r=n;if(r.tokenAddress)throw new de(ge.NOT_SUPPORTED,"TRC20 transaction builder not available");const s=this.#t(),o=this.#o(r.from),i=this.#o(r.to),c=await this.#r("/wallet/createtransaction",{owner_address:o,to_address:i,amount:Number(r.amount.raw),visible:!1});if(!c.txID)throw new de(ge.TX_BUILD_FAILED,"Failed to create Tron transaction");return{chainId:s.id,intentType:"transfer",data:c}}async estimateFee(n){const r=this.#t(),o={amount:se.fromRaw("0",r.decimals,r.symbol),estimatedTime:3};return{slow:o,standard:o,fast:o}}async signTransaction(n,r){if(!r.privateKey)throw new de(ge.SIGNATURE_FAILED,"privateKey is required for Tron signing");const s=n.data,o=to(s.txID),i=go.sign(o,r.privateKey,{prehash:!1,format:"recovered"}),c=Cr(i),a={...s,signature:[c]};return{chainId:n.chainId,data:a,signature:c}}async broadcastTransaction(n){const r=n.data,s=await this.#r("/wallet/broadcasttransaction",r);if(!s.result){const o=s.message?Buffer.from(s.message,"hex").toString("utf8"):s.code??"Unknown error";throw new de(ge.TX_BROADCAST_FAILED,`Broadcast failed: ${o}`)}return r.txID}}}const bE=HS(kr);function Km(e){return e.startsWith("0x")||e.startsWith("0X")?e.slice(2):e}function jm(e){return/^[0-9a-fA-F]+$/.test(e)}function KV(e){const t=Km(e);if(t.length%2!==0||!jm(t))throw new Error(`Invalid hex: ${e}`);const n=new Uint8Array(t.length/2);for(let r=0;r<n.length;r++)n[r]=parseInt(t.slice(r*2,r*2+2),16);return n}function jV(e){return Array.from(e,t=>t.toString(16).padStart(2,"0")).join("")}function Zn(e){const t=e.trim(),n=Km(t);if(n.length===42&&jm(n)&&n.startsWith("41"))return n;if(!t.startsWith("T"))throw new Error(`Invalid Tron address: ${e}`);const r=bE.decode(t);if(r.length!==21)throw new Error(`Invalid Tron address length: ${e}`);return jV(r)}function zV(e){const t=Km(e).toLowerCase();if(!jm(t))throw new Error(`Invalid Tron hex address: ${e}`);const n=t.length===40?`41${t}`:t;if(n.length!==42)throw new Error(`Invalid Tron hex length: ${e}`);const r=KV(n);return bE.encode(r)}function pt(e){const t=e.trim();return t.startsWith("T")?t:zV(t)}function nr(e){return Zn(e).toLowerCase()}const VV=A({balance:S(N),address:S(g)}),qV=A({block_header:S(A({raw_data:S(A({number:S(N)}))}))}),WV=A({amount:S(N),owner_address:S(g),to_address:S(g)}),JV=A({parameter:S(A({value:S(WV)})),type:S(g)}),_E=A({txID:g,block_timestamp:S(N),raw_data:S(A({contract:S(ue(JV)),timestamp:S(N)})),ret:S(ue(A({contractRet:S(g)})))}),GV=A({success:ve,data:S(ue(_E))});function Mf(e){try{return nr(e)}catch{return e.toLowerCase()}}function wS(e,t,n){const r=Mf(e),s=Mf(t),o=Mf(n);return r===o&&s===o?"self":r===o?"out":"in"}function YV(e,t){return!e||e.length!==t.length?!0:e.length===0&&t.length===0?!1:e[0]?.hash!==t[0]?.hash}class QV{chainId;type;endpoint;config;constructor(t,n){this.type=t.type,this.endpoint=t.endpoint,this.config=t.config,this.chainId=n}}class wE extends yE(SE(QV)){symbol;decimals;baseUrl;headers;pollingInterval=3e4;_eventBus=null;_txHistorySources=new Map;_txHistoryCreations=new Map;_balanceSources=new Map;_balanceCreations=new Map;nativeBalance;transactionHistory;transaction;blockHeight;constructor(t,n){super(t,n),this.symbol=le.getSymbol(n),this.decimals=le.getDecimals(n),this.baseUrl=this.endpoint;const r=ql(this.config?.apiKeyEnv,`trongrid-${n}`);this.headers=r?{"TRON-PRO-API-KEY":r}:{};const s=this;this.blockHeight=Se(`tron-rpc.${n}.blockHeight`,()=>s.createBlockHeightSource()),this.transactionHistory=Se(`tron-rpc.${n}.transactionHistory`,o=>s.createTransactionHistorySource(o)),this.nativeBalance=Se(`tron-rpc.${n}.nativeBalance`,o=>s.createBalanceSource(o)),this.transaction=Se(`tron-rpc.${n}.transaction`,o=>s.createTransactionSource(o))}createBlockHeightSource(){return this.getSharedBlockHeightSource()}getSharedBlockHeightSource(){const t=this,n=zl(this.chainId,"global","blockHeight"),r=t.fetchNowBlock(!0).pipe(j(s=>BigInt(s.block_header?.raw_data?.number??0)));return Vl(n,{fetch:r,interval:ie(t.pollingInterval)})}createTransactionHistorySource(t){return this.getSharedTxHistorySource(t.address)}createBalanceSource(t){return this.getSharedBalanceSource(t.address)}getSharedTxHistorySource(t){const n=this,r=pt(t),s=nr(t),o=this.symbol,i=this.decimals,c=l=>({...l,stop:n.releaseSharedTxHistorySource(s)}),a=n._txHistorySources.get(s);if(a)return a.refCount+=1,z(c(a.source));const u=n._txHistoryCreations.get(s);return W(u?async()=>{const l=await u,f=n._txHistorySources.get(s);return f&&(f.refCount+=1),c(l)}:async()=>{const l=Q($(function*(){n._eventBus||(n._eventBus=yield*Tn());const f=n._eventBus,h=n.fetchTransactionList(r,!0).pipe(j(b=>!b.success||!b.data?[]:b.data.map(_=>{const C=_.raw_data?.contract?.[0]?.parameter?.value,v=C?.owner_address??"",T=C?.to_address??"",R=pt(v),w=pt(T),I=_.ret?.[0]?.contractRet==="SUCCESS"?"confirmed":"failed";return{hash:_.txID,from:R,to:w,timestamp:_.block_timestamp??_.raw_data?.timestamp??0,status:I,action:"transfer",direction:wS(v,T,r),assets:[{assetType:"native",value:(C?.amount??0).toString(),symbol:o,decimals:i}]}}))),m=yield*ke({name:`tron-rpc.${n.chainId}.txHistory.${s}`,fetch:h,interval:ie(n.pollingInterval),walletEvents:{eventBus:f,chainId:n.chainId,address:r,types:["tx:confirmed","tx:sent"]}}),y=m.stop;return n._txHistorySources.set(s,{source:m,refCount:1,stopAll:y}),m}));n._txHistoryCreations.set(s,l);try{const f=await l;return c(f)}finally{n._txHistoryCreations.delete(s)}})}releaseSharedTxHistorySource(t){const n=this;return $(function*(){const r=n._txHistorySources.get(t);r&&(r.refCount-=1,r.refCount<=0&&(yield*r.stopAll,n._txHistorySources.delete(t)))})}getSharedBalanceSource(t){const n=this,r=nr(t),s=this.symbol,o=this.decimals,i=u=>({...u,stop:n.releaseSharedBalanceSource(r)}),c=n._balanceSources.get(r);if(c)return c.refCount+=1,z(i(c.source));const a=n._balanceCreations.get(r);return W(a?async()=>{const u=await a,l=n._balanceSources.get(r);return l&&(l.refCount+=1),i(u)}:async()=>{const u=Q($(function*(){const l=yield*n.getSharedTxHistorySource(t),f=yield*Le({name:`tron-rpc.${n.chainId}.balance`,dependsOn:l.ref,hasChanged:YV,fetch:(m,y)=>n.fetchAccount(t,y).pipe(j(b=>({amount:se.fromRaw((b.balance??0).toString(),o,s),symbol:s})))}),h=ze([f.stop,l.stop]).pipe(Ae);return n._balanceSources.set(r,{source:f,refCount:1,stopAll:h}),f}));n._balanceCreations.set(r,u);try{const l=await u;return i(l)}finally{n._balanceCreations.delete(r)}})}releaseSharedBalanceSource(t){const n=this;return $(function*(){const r=n._balanceSources.get(t);r&&(r.refCount-=1,r.refCount<=0&&(yield*r.stopAll,n._balanceSources.delete(t)))})}createTransactionSource(t){const n=this,r=this.symbol,s=this.decimals;return $(function*(){const o=n.fetchTransactionById(t.txHash).pipe(j(c=>{if(!c.txID)return null;const u=c.raw_data?.contract?.[0]?.parameter?.value,l=u?.owner_address??"",f=u?.to_address??"",h=pt(l),m=pt(f);let y;!c.ret||c.ret.length===0?y="pending":y=c.ret[0]?.contractRet==="SUCCESS"?"confirmed":"failed";const b=t.senderId??h;return{hash:c.txID,from:h,to:m,timestamp:c.block_timestamp??c.raw_data?.timestamp??0,status:y,action:"transfer",direction:wS(l,f,b),assets:[{assetType:"native",value:(u?.amount??0).toString(),symbol:r,decimals:s}]}}));return yield*ke({name:`tron-rpc.${n.chainId}.transaction`,fetch:o,interval:ie(3e3)})})}fetchNowBlock(t=!1){return Z({url:`${this.baseUrl}/wallet/getnowblock`,method:"POST",headers:this.headers,schema:qV,cacheStrategy:t?"network-first":"cache-first",cache:"no-store"})}fetchAccount(t,n=!1){return Z({url:`${this.baseUrl}/wallet/getaccount`,method:"POST",headers:this.headers,body:{address:Zn(t)},schema:VV,cacheStrategy:n?"network-first":"cache-first"})}fetchTransactionList(t,n=!1){const r=pt(t);return Z({url:`${this.baseUrl}/v1/accounts/${r}/transactions`,headers:this.headers,schema:GV,cacheStrategy:n?"network-first":"cache-first"})}fetchTransactionById(t){return Z({url:`${this.baseUrl}/wallet/gettransactionbyid`,method:"POST",headers:this.headers,body:{value:t},schema:_E,cacheStrategy:"ttl",cacheTtl:Math.max(1e3,Math.floor(this.pollingInterval/4))})}}function vE(e,t){return e.type==="tron-rpc"||e.type==="tron-rpc-pro"?new wE(e,t):null}function kE(e){return class extends e{async deriveAddress(n,r=0){const s=new TextDecoder().decode(n);return zm(s,84,r).address}async deriveAddresses(n,r,s){const o=new TextDecoder().decode(n),i=[];for(let c=0;c<s;c++){const a=zm(o,84,r+c);i.push(a.address)}return i}isValidAddress(n){try{if(n.startsWith("1")||n.startsWith("3"))return HS(kr).decode(n).length===21;if(n.toLowerCase().startsWith("bc1q")){const r=n.toLowerCase(),s=Vm.decode(r),o=Vm.fromWords(s.words.slice(1));return s.prefix==="bc"&&s.words[0]===0&&o.length===20}if(n.toLowerCase().startsWith("bc1p")){const r=n.toLowerCase(),s=qm.decode(r),o=qm.fromWords(s.words.slice(1));return s.prefix==="bc"&&s.words[0]===1&&o.length===32}return!1}catch{return!1}}normalizeAddress(n){return n.startsWith("bc1")||n.startsWith("BC1")?n.toLowerCase():n}async signMessage(n,r){const s=typeof n=="string"?new TextEncoder().encode(n):n,o=new TextEncoder().encode(`Bitcoin Signed Message:
`),i=new Uint8Array([s.length]),c=new Uint8Array([...o,...i,...s]),a=kr(kr(c)),u=go.sign(a,r,{prehash:!1,format:"recovered"});return Cr(u)}async verifyMessage(n,r,s){return!1}}}const XV="https://mempool.space/api";function TE(e){return class extends e{#e=null;get#n(){return this.#e||(this.#e=le.getMempoolApi(this.chainId)??XV),this.#e}get#t(){return le.getConfig(this.chainId)}async#r(n,r){const s=`${this.#n}${n}`,o=await fetch(s,r);if(!o.ok)throw new de(ge.NETWORK_ERROR,`Bitcoin API error: ${o.status}`);const i=await o.text();try{return JSON.parse(i)}catch{return i}}async buildTransaction(n){if(n.type!=="transfer")throw new de(ge.NOT_SUPPORTED,`Transaction type not supported: ${n.type}`);const r=n,s=await this.#r(`/address/${r.from}/utxo`);if(s.length===0)throw new de(ge.INSUFFICIENT_BALANCE,"No UTXOs available");const i=(await this.#r("/v1/fees/recommended")).halfHourFee,c=s.reduce((y,b)=>y+b.value,0),a=Number(r.amount.raw),u=10+s.length*68+62,l=i*u;if(c<a+l)throw new de(ge.INSUFFICIENT_BALANCE,`Insufficient balance: need ${a+l}, have ${c}`);const f=c-a-l,h=this.#t,m={inputs:s.map(y=>({txid:y.txid,vout:y.vout,value:y.value,scriptPubKey:""})),outputs:[{address:r.to,value:a}],fee:l,changeAddress:r.from};return f>546&&m.outputs.push({address:r.from,value:f}),{chainId:h.id,intentType:"transfer",data:m}}async estimateFee(n){try{const r=await this.#r("/v1/fees/recommended"),s=140,o=this.#t,i={amount:se.fromRaw((r.hourFee*s).toString(),o.decimals,o.symbol),estimatedTime:3600},c={amount:se.fromRaw((r.halfHourFee*s).toString(),o.decimals,o.symbol),estimatedTime:1800},a={amount:se.fromRaw((r.fastestFee*s).toString(),o.decimals,o.symbol),estimatedTime:600};return{slow:i,standard:c,fast:a}}catch{const r=this.#t,s={amount:se.fromRaw("2000",r.decimals,r.symbol),estimatedTime:1800};return{slow:s,standard:s,fast:s}}}async signTransaction(n,r){throw new de(ge.CHAIN_NOT_SUPPORTED,"Bitcoin transaction signing requires specialized library (bitcoinjs-lib or similar)")}async broadcastTransaction(n){const r=n.data;return await this.#r("/tx",{method:"POST",body:r})}}}const ZV=A({chain_stats:A({funded_txo_sum:N,spent_txo_sum:N})}),e3=A({txid:g,vin:ue(A({prevout:S(A({scriptpubkey_address:S(g)}))})),vout:ue(A({scriptpubkey_address:S(g),value:S(N)})),status:A({confirmed:ve,block_time:S(N)})}),t3=ue(e3);function n3(e,t,n){const r=e?.some(o=>o.prevout?.scriptpubkey_address===n),s=t?.some(o=>o.scriptpubkey_address===n);return r&&s?"self":r?"out":"in"}function r3(e,t){return!e||e.length!==t.length?!0:e.length===0&&t.length===0?!1:e[0]?.hash!==t[0]?.hash}class s3{chainId;type;endpoint;config;constructor(t,n){this.type=t.type,this.endpoint=t.endpoint,this.config=t.config,this.chainId=n}}class EE extends kE(TE(s3)){symbol;decimals;baseUrl;pollingInterval=6e4;_eventBus=null;_txHistorySources=new Map;_txHistoryCreations=new Map;_balanceSources=new Map;_balanceCreations=new Map;nativeBalance;transactionHistory;blockHeight;constructor(t,n){super(t,n),this.symbol=le.getSymbol(n),this.decimals=le.getDecimals(n),this.baseUrl=this.endpoint;const r=this;this.blockHeight=Se(`mempool.${n}.blockHeight`,()=>r.createBlockHeightSource()),this.transactionHistory=Se(`mempool.${n}.transactionHistory`,s=>r.createTransactionHistorySource(s)),this.nativeBalance=Se(`mempool.${n}.nativeBalance`,s=>r.createBalanceSource(s))}createBlockHeightSource(){return this.getSharedBlockHeightSource()}getSharedBlockHeightSource(){const t=this,n=zl(this.chainId,"global","blockHeight"),r=t.fetchBlockHeight(!0).pipe(j(s=>BigInt(s)));return Vl(n,{fetch:r,interval:ie(t.pollingInterval)})}createTransactionHistorySource(t){return this.getSharedTxHistorySource(t.address)}createBalanceSource(t){return this.getSharedBalanceSource(t.address)}getSharedTxHistorySource(t){const n=this,r=t,s=this.symbol,o=this.decimals,i=u=>({...u,stop:n.releaseSharedTxHistorySource(r)}),c=n._txHistorySources.get(r);if(c)return c.refCount+=1,z(i(c.source));const a=n._txHistoryCreations.get(r);return W(a?async()=>{const u=await a,l=n._txHistorySources.get(r);return l&&(l.refCount+=1),i(u)}:async()=>{const u=Q($(function*(){n._eventBus||(n._eventBus=yield*Tn());const l=n._eventBus,f=n.fetchTransactionHistory(t,!0).pipe(j(y=>y.map(b=>({hash:b.txid,from:b.vin[0]?.prevout?.scriptpubkey_address??"",to:b.vout[0]?.scriptpubkey_address??"",timestamp:(b.status.block_time??0)*1e3,status:b.status.confirmed?"confirmed":"pending",action:"transfer",direction:n3(b.vin,b.vout,t),assets:[{assetType:"native",value:(b.vout[0]?.value??0).toString(),symbol:s,decimals:o}]})))),h=yield*ke({name:`mempool.${n.chainId}.txHistory.${r}`,fetch:f,interval:ie(n.pollingInterval),walletEvents:{eventBus:l,chainId:n.chainId,address:t,types:["tx:confirmed","tx:sent"]}}),m=h.stop;return n._txHistorySources.set(r,{source:h,refCount:1,stopAll:m}),h}));n._txHistoryCreations.set(r,u);try{const l=await u;return i(l)}finally{n._txHistoryCreations.delete(r)}})}releaseSharedTxHistorySource(t){const n=this;return $(function*(){const r=n._txHistorySources.get(t);r&&(r.refCount-=1,r.refCount<=0&&(yield*r.stopAll,n._txHistorySources.delete(t)))})}getSharedBalanceSource(t){const n=this,r=t,s=this.symbol,o=this.decimals,i=u=>({...u,stop:n.releaseSharedBalanceSource(r)}),c=n._balanceSources.get(r);if(c)return c.refCount+=1,z(i(c.source));const a=n._balanceCreations.get(r);return W(a?async()=>{const u=await a,l=n._balanceSources.get(r);return l&&(l.refCount+=1),i(u)}:async()=>{const u=Q($(function*(){const l=yield*n.getSharedTxHistorySource(t),f=yield*Le({name:`mempool.${n.chainId}.balance`,dependsOn:l.ref,hasChanged:r3,fetch:(m,y)=>n.fetchAddressInfo(t,y).pipe(j(b=>{const _=b.chain_stats.funded_txo_sum-b.chain_stats.spent_txo_sum;return{amount:se.fromRaw(_.toString(),o,s),symbol:s}}))}),h=ze([f.stop,l.stop]).pipe(Ae);return n._balanceSources.set(r,{source:f,refCount:1,stopAll:h}),f}));n._balanceCreations.set(r,u);try{const l=await u;return i(l)}finally{n._balanceCreations.delete(r)}})}releaseSharedBalanceSource(t){const n=this;return $(function*(){const r=n._balanceSources.get(t);r&&(r.refCount-=1,r.refCount<=0&&(yield*r.stopAll,n._balanceSources.delete(t)))})}fetchBlockHeight(t=!1){return Z({url:`${this.baseUrl}/blocks/tip/height`,cacheStrategy:t?"network-first":"cache-first"})}fetchAddressInfo(t,n=!1){return Z({url:`${this.baseUrl}/address/${t}`,schema:ZV,cacheStrategy:n?"network-first":"cache-first"})}fetchTransactionHistory(t,n=!1){return Z({url:`${this.baseUrl}/address/${t}/txs`,schema:t3,cacheStrategy:n?"network-first":"cache-first"})}}function CE(e,t){return e.type.startsWith("mempool-")?new EE(e,t):null}const o3=A({success:ve,result:S(De(g,N))}),i3=De(o3,g,N),c3=A({blockNumber:S(g),timeStamp:g,hash:g,from:g,to:g,value:g,isError:S(g),txreceipt_status:S(g),input:S(g),methodId:S(g),functionName:S(g)}),a3=A({blockNumber:S(g),timeStamp:g,hash:g,from:g,to:g,value:g,tokenSymbol:S(g),tokenName:S(g),tokenDecimal:S(g),contractAddress:S(g)}),u3=A({status:S(g),message:S(g),result:ue(c3)}),l3=A({status:S(g),message:S(g),result:ue(a3)}),f3=A({success:ve,result:S(u3)}),h3=A({success:ve,result:S(l3)}),IE=A({amount:De(g,N),contractAddress:S(g),decimals:S(N),icon:S(g),symbol:S(g),name:S(g)}),d3=ue(IE),p3=A({success:ve,result:S(ue(IE))}),vS=De(d3,p3),m3=A({chain:S(g),address:g,name:g,icon:S(g),symbol:g,decimals:N}),g3=A({data:ue(m3),page:N,pageSize:N,total:N,pages:S(N)}),y3=A({success:ve,result:S(g3)});function kS(e,t,n){const r=e.toLowerCase(),s=t.toLowerCase();return r===n&&s===n?"self":r===n?"out":"in"}function S3(e){return e.value&&e.value!=="0"?"transfer":"contract"}function Hi(e){return e==null?"0":String(e)}function js(e){return typeof e=="string"||typeof e=="number"?{success:!0,amount:Hi(e)}:{success:e.success,amount:Hi(e.result)}}function b3(e){return Promise.resolve(e.success)}function Gl(e){if(!e)return!1;const t=e.status?.toUpperCase(),n=e.message?.toUpperCase();return n==="NO TRANSACTIONS FOUND"?!0:!(t==="0"||n==="NOTOK")}function TS(e){return e.success?Promise.resolve(Gl(e.result)):Promise.resolve(!1)}function _3(e){return typeof e=="string"||typeof e=="number"?Promise.resolve(!0):Promise.resolve(e.success)}function ES(e){return Array.isArray(e)?Promise.resolve(!0):Promise.resolve(e.success)}function CS(e){return Array.isArray(e)?e:e.result??[]}function w3(e){return!e||!e.success?!1:Gl(e.result)}function zs(e,t){t.success}function v3(e){if(typeof e=="number")return e;if(typeof e=="string"){const t=Number.parseInt(e,10);return Number.isNaN(t)?0:t}return 0}function IS(e,t){return!e||e.length!==t.length?!0:e.length===0&&t.length===0?!1:e[0]?.hash!==t[0]?.hash}function k3(e,t){const n=new Map;for(const r of e)n.set(r.hash,r);for(const r of t){const s=n.get(r.hash);if(s){s.assets=[...s.assets,...r.assets],n.set(r.hash,s);continue}n.set(r.hash,r)}return Array.from(n.values()).sort((r,s)=>s.timestamp-r.timestamp)}function T3(e){const t=new Set;for(const n of e)for(const r of n.assets)r.assetType==="token"&&r.contractAddress&&t.add(r.contractAddress);return[...t].sort()}function $S(e){return!e.success||!e.result?[]:e.result.data.map(t=>t.address).filter(t=>t.length>0).map(t=>t.toLowerCase()).sort()}function E3(e){return e.success&&e.result?e:{success:!0,result:{data:[],page:1,pageSize:0,total:0}}}function C3(e,t){return t.success&&Gl(t.result)?z(t):Ct(new it(`[ethwallet] ${e} NOTOK`))}function I3(e,t){return t.success&&Gl(t.result)?z(t):Ct(new it(`[ethwallet] ${e} NOTOK`))}class $3{chainId;type;endpoint;config;constructor(t,n){this.type=t.type,this.endpoint=t.endpoint,this.config=t.config,this.chainId=n}}class $E extends oi(ii($3)){symbol;decimals;baseUrl;pollingInterval=3e4;balanceCacheTtlMs=5e3;tokenListCacheTtl=600*1e3;_eventBus=null;_txHistorySources=new Map;_txHistoryCreations=new Map;_balanceSources=new Map;_balanceCreations=new Map;_tokenBalanceSources=new Map;_tokenBalanceCreations=new Map;_tokenListSource=null;_tokenListCreation=null;nativeBalance;tokenBalances;transactionHistory;constructor(t,n){super(t,n),this.symbol=le.getSymbol(n),this.decimals=le.getDecimals(n),this.baseUrl=this.endpoint;const r=this;this.transactionHistory=Se(`ethwallet.${n}.transactionHistory`,s=>r.createTransactionHistorySource(s)),this.nativeBalance=Se(`ethwallet.${n}.nativeBalance`,s=>r.createBalanceSource(s)),this.tokenBalances=Se(`ethwallet.${n}.tokenBalances`,s=>r.createTokenBalancesSource(s))}createTransactionHistorySource(t){return this.getSharedTxHistorySource(t.address)}createBalanceSource(t){return this.getSharedBalanceSource(t.address).pipe(Nr(n=>this.createBalanceFallbackSource(t.address)))}createTokenBalancesSource(t){return this.getSharedTokenBalanceSource(t.address).pipe(Nr(n=>this.createTokenBalancesFallbackSource(t.address)))}createBalanceFallbackSource(t){const n=this.symbol,r=this.decimals;return ke({name:`ethwallet.${this.chainId}.balance.fallback`,interval:ie(this.pollingInterval),immediate:!0,fetch:this.fetchBalance(t,!0).pipe(j(s=>{const o=js(s);return{amount:se.fromRaw(o.amount,r,n),symbol:n}}))})}createTokenBalancesFallbackSource(t){const n=this.symbol,r=this.decimals;return ke({name:`ethwallet.${this.chainId}.tokenBalances.fallback`,interval:ie(this.pollingInterval),immediate:!0,fetch:this.fetchTokenBalances(t,[],!0).pipe(j(s=>{const o=[],i=js(s.native);o.push({symbol:n,name:n,amount:se.fromRaw(i.amount,r,n),isNative:!0,decimals:r});for(const c of s.tokens){const a=c.symbol??"ERC20",u=c.decimals??0;o.push({symbol:a,name:c.name??a,amount:se.fromRaw(Hi(c.amount),u,a),isNative:!1,decimals:u,icon:c.icon,contractAddress:c.contractAddress})}return o}))})}getSharedTxHistorySource(t){const n=this,r=t.toLowerCase(),s=r,o=this.symbol,i=this.decimals,c=l=>({...l,stop:n.releaseSharedTxHistorySource(s)}),a=n._txHistorySources.get(s);if(a)return a.refCount+=1,z(c(a.source));const u=n._txHistoryCreations.get(s);return W(u?async()=>{const l=await u,f=n._txHistorySources.get(s);return f&&(f.refCount+=1),c(l)}:async()=>{const l=Q($(function*(){n._eventBus||(n._eventBus=yield*Tn());const f=n._eventBus,h=yield*ke({name:`ethwallet.${n.chainId}.txHistory.native.${s}`,fetch:n.fetchNativeHistory({address:t,limit:50},!0),interval:ie(n.pollingInterval),walletEvents:{eventBus:f,chainId:n.chainId,address:t,types:["tx:confirmed","tx:sent"]}}),m=yield*h.get;if(!w3(m))return yield*h.stop,yield*Ct(new it("[ethwallet] trans/normal/history NOTOK"));const y=yield*n.getSharedTokenListSource(),b=yield*$t(0),_=en(b,E=>E+1).pipe(Ae),k=yield*$t(new Map),C=[],v=E=>ot(E.pipe(us(()=>_),fr));C.push(yield*v(h.changes));const T=new Map,R=new Map,w=E=>$(function*(){if(T.has(E))return;const V=yield*ke({name:`ethwallet.${n.chainId}.txHistory.erc20.${s}.${E}`,fetch:n.fetchTokenHistory({address:t,limit:50,contractAddress:E},!0),interval:ie(n.pollingInterval),immediate:!1,walletEvents:{eventBus:f,chainId:n.chainId,address:t,types:["tx:confirmed","tx:sent"]}});T.set(E,V);const q=yield*ot(V.changes.pipe(qn(D=>en(k,B=>{const x=new Map(B);return x.set(E,D),x}).pipe(Ce(_)))));R.set(E,q),yield*ot(V.refresh.pipe(Ae))}),I=E=>$(function*(){const V=T.get(E);V&&(yield*V.stop,T.delete(E));const q=R.get(E);q&&(yield*Fe(q),R.delete(E)),yield*en(k,D=>{const B=new Map(D);return B.delete(E),B}).pipe(Ce(_))}),O=E=>$(function*(){const V=E?$S(E):[],q=new Set(V);for(const D of T.keys())q.has(D)||(yield*I(D));for(const D of q)T.has(D)||(yield*w(D))});yield*O(yield*y.get),C.push(yield*ot(y.changes.pipe(qn(E=>O(E).pipe(Ce(_))))));const H=yield*Le({name:`ethwallet.${n.chainId}.txHistory.${s}`,dependsOn:b,hasChanged:(E,V)=>E!==V,fetch:()=>$(function*(){const V=((yield*h.get)?.result?.result??[]).map(B=>{const x=B.isError==="1"||B.txreceipt_status==="0"?"failed":"confirmed";return{hash:B.hash,from:B.from,to:B.to,timestamp:parseInt(B.timeStamp,10)*1e3,status:x,blockNumber:B.blockNumber?BigInt(B.blockNumber):void 0,action:S3(B),direction:kS(B.from,B.to,r),assets:[{assetType:"native",value:B.value,symbol:o,decimals:i}]}}),D=[...(yield*Bt(k)).values()].flatMap(B=>(B?.result?.result??[]).map(x=>{const ce=x.tokenSymbol??"ERC20",je=v3(x.tokenDecimal),Vt=x.contractAddress?.toLowerCase();return{hash:x.hash,from:x.from,to:x.to,timestamp:parseInt(x.timeStamp,10)*1e3,status:"confirmed",blockNumber:x.blockNumber?BigInt(x.blockNumber):void 0,action:"transfer",direction:kS(x.from,x.to,r),assets:[{assetType:"token",value:x.value,symbol:ce,decimals:je,contractAddress:Vt,name:x.tokenName}]}}));return k3(V,D)})}),F=$(function*(){for(const E of C)yield*Fe(E);for(const E of T.values())yield*E.stop;for(const E of R.values())yield*Fe(E);yield*H.stop,yield*h.stop,yield*n.releaseSharedTokenListSource()});return n._txHistorySources.set(s,{source:H,refCount:1,stopAll:F}),H}));n._txHistoryCreations.set(s,l);try{const f=await l;return c(f)}finally{n._txHistoryCreations.delete(s)}})}releaseSharedTxHistorySource(t){const n=this;return $(function*(){const r=n._txHistorySources.get(t);r&&(r.refCount-=1,r.refCount<=0&&(yield*r.stopAll,n._txHistorySources.delete(t)))})}getSharedBalanceSource(t){const n=this,r=t.toLowerCase(),s=this.symbol,o=this.decimals,i=u=>({...u,stop:n.releaseSharedBalanceSource(r)}),c=n._balanceSources.get(r);if(c)return c.refCount+=1,z(i(c.source));const a=n._balanceCreations.get(r);return W(a?async()=>{const u=await a,l=n._balanceSources.get(r);return l&&(l.refCount+=1),i(u)}:async()=>{const u=Q($(function*(){const l=yield*Ve(n.getSharedTxHistorySource(t),w=>$(function*(){return null}));if(l===null){const w=yield*ke({name:`ethwallet.${n.chainId}.balance.poll`,interval:ie(n.pollingInterval),immediate:!0,fetch:n.fetchBalance(t,!0).pipe(j(I=>{const O=js(I);return{amount:se.fromRaw(O.amount,o,s),symbol:s}}))});return n._balanceSources.set(r,{source:w,refCount:1,stopAll:w.stop}),w}const f=yield*$t(null),h=yield*$t(0),m=en(h,w=>w+1).pipe(Ae),y=w=>{const I=js(w);return{amount:se.fromRaw(I.amount,o,s),symbol:s}},b=yield*Le({name:`ethwallet.${n.chainId}.balance.dep`,dependsOn:l.ref,hasChanged:IS,fetch:(w,I)=>n.fetchBalance(t,I).pipe(j(y),Ie(O=>Rt(f,O)))}),_=(yield*l.get)===null,k=yield*ke({name:`ethwallet.${n.chainId}.balance.poll`,interval:ie(n.pollingInterval),immediate:_,fetch:$(function*(){const w=yield*l.get,I=yield*Bt(f);if(w!==null&&I!==null)return I;const O=yield*n.fetchBalance(t,!0),H=y(O);return yield*Rt(f,H),H})}),C=[],v=w=>ot(w.pipe(us(()=>m),fr));C.push(yield*v(b.changes)),C.push(yield*v(k.changes));const T=yield*Le({name:`ethwallet.${n.chainId}.balance`,dependsOn:h,hasChanged:(w,I)=>w!==I,fetch:()=>$(function*(){const w=yield*Bt(f);return w||(yield*Ct(new it("[ethwallet] balance cache empty")))})}),R=$(function*(){for(const w of C)yield*Fe(w);yield*b.stop,yield*k.stop,yield*T.stop,yield*l.stop});return n._balanceSources.set(r,{source:T,refCount:1,stopAll:R}),T}));n._balanceCreations.set(r,u);try{const l=await u;return i(l)}finally{n._balanceCreations.delete(r)}})}releaseSharedBalanceSource(t){const n=this;return $(function*(){const r=n._balanceSources.get(t);r&&(r.refCount-=1,r.refCount<=0&&(yield*r.stopAll,n._balanceSources.delete(t)))})}getSharedTokenBalanceSource(t){const n=this,r=t.toLowerCase(),s=this.symbol,o=this.decimals,i=u=>({...u,stop:n.releaseSharedTokenBalanceSource(r)}),c=n._tokenBalanceSources.get(r);if(c)return c.refCount+=1,z(i(c.source));const a=n._tokenBalanceCreations.get(r);return W(a?async()=>{const u=await a,l=n._tokenBalanceSources.get(r);return l&&(l.refCount+=1),i(u)}:async()=>{const u=Q($(function*(){const l=yield*Ve(n.getSharedTxHistorySource(t),w=>$(function*(){return null}));if(l===null){const w=yield*ke({name:`ethwallet.${n.chainId}.tokenBalances.poll`,interval:ie(n.pollingInterval),immediate:!0,fetch:n.fetchTokenBalances(t,[],!0).pipe(j(I=>{const O=[],H=js(I.native);O.push({symbol:s,name:s,amount:se.fromRaw(H.amount,o,s),isNative:!0,decimals:o});for(const F of I.tokens){const E=F.symbol??"ERC20",V=F.decimals??0;O.push({symbol:E,name:F.name??E,amount:se.fromRaw(Hi(F.amount),V,E),isNative:!1,decimals:V,icon:F.icon,contractAddress:F.contractAddress})}return O}))});return n._tokenBalanceSources.set(r,{source:w,refCount:1,stopAll:w.stop}),w}const f=yield*$t(null),h=yield*$t(0),m=en(h,w=>w+1).pipe(Ae),y=w=>{const I=[],O=js(w.native);I.push({symbol:s,name:s,amount:se.fromRaw(O.amount,o,s),isNative:!0,decimals:o});for(const H of w.tokens){const F=H.symbol??"ERC20",E=H.decimals??0;I.push({symbol:F,name:H.name??F,amount:se.fromRaw(Hi(H.amount),E,F),isNative:!1,decimals:E,icon:H.icon,contractAddress:H.contractAddress})}return I},b=yield*Le({name:`ethwallet.${n.chainId}.tokenBalances.dep`,dependsOn:l.ref,hasChanged:IS,fetch:(w,I)=>n.fetchTokenBalances(t,T3(w),I).pipe(j(y),Ie(O=>Rt(f,O)))}),_=(yield*l.get)===null,k=yield*ke({name:`ethwallet.${n.chainId}.tokenBalances.poll`,interval:ie(n.pollingInterval),immediate:_,fetch:$(function*(){const w=yield*l.get,I=yield*Bt(f);if(w!==null&&I!==null)return I;const O=yield*n.fetchTokenBalances(t,[],!0),H=y(O);return yield*Rt(f,H),H})}),C=[],v=w=>ot(w.pipe(us(()=>m),fr));C.push(yield*v(b.changes)),C.push(yield*v(k.changes));const T=yield*Le({name:`ethwallet.${n.chainId}.tokenBalances`,dependsOn:h,hasChanged:(w,I)=>w!==I,fetch:()=>$(function*(){const w=yield*Bt(f);return w||(yield*Ct(new it("[ethwallet] tokenBalances cache empty")))})}),R=$(function*(){for(const w of C)yield*Fe(w);yield*b.stop,yield*k.stop,yield*T.stop,yield*l.stop});return n._tokenBalanceSources.set(r,{source:T,refCount:1,stopAll:R}),T}));n._tokenBalanceCreations.set(r,u);try{const l=await u;return i(l)}finally{n._tokenBalanceCreations.delete(r)}})}releaseSharedTokenBalanceSource(t){const n=this;return $(function*(){const r=n._tokenBalanceSources.get(t);r&&(r.refCount-=1,r.refCount<=0&&(yield*r.stopAll,n._tokenBalanceSources.delete(t)))})}getSharedTokenListSource(){const t=this;return t._tokenListSource?(t._tokenListSource.refCount+=1,z(t._tokenListSource.source)):t._tokenListCreation?W(async()=>{const n=await t._tokenListCreation;return t._tokenListSource&&(t._tokenListSource.refCount+=1),n}):W(async()=>{const n=Q($(function*(){const r=yield*ke({name:`ethwallet.${t.chainId}.tokenList`,fetch:t.fetchTokenList(!1),interval:ie(t.tokenListCacheTtl),immediate:!0});return t._tokenListSource={source:r,refCount:1,stopAll:r.stop},r}));t._tokenListCreation=n;try{return await n}finally{t._tokenListCreation=null}})}releaseSharedTokenListSource(){const t=this;return $(function*(){const n=t._tokenListSource;n&&(n.refCount-=1,n.refCount<=0&&(yield*n.stopAll,t._tokenListSource=null))})}fetchBalance(t,n=!1){return Z({url:`${this.baseUrl}/balance?address=${t}`,schema:i3,cacheStrategy:n?"ttl":"cache-first",cacheTtl:this.balanceCacheTtlMs,canCache:_3}).pipe(Ie(r=>{typeof r=="object"&&r!==null&&"success"in r&&zs("balance",r)}))}fetchNativeHistory(t,n=!1){return Z({url:`${this.baseUrl}/trans/normal/history`,method:"POST",body:{address:t.address,page:1,offset:t.limit??50},schema:f3,cacheStrategy:n?"ttl":"cache-first",cacheTtl:this.balanceCacheTtlMs,canCache:TS}).pipe(Ie(r=>zs("trans/normal/history",r)),X(r=>C3("trans/normal/history",r)))}fetchTokenHistory(t,n=!1){return t.contractAddress?Z({url:`${this.baseUrl}/trans/erc20/history`,method:"POST",body:{address:t.address,contractaddress:t.contractAddress,page:1,offset:t.limit??50},schema:h3,cacheStrategy:n?"ttl":"cache-first",cacheTtl:this.balanceCacheTtlMs,canCache:TS}).pipe(Ie(r=>zs("trans/erc20/history",r)),X(r=>I3("trans/erc20/history",r))):z({success:!0,result:{result:[]}})}fetchTokenBalances(t,n,r=!1){const s=[...n].sort();if(s.length===0){const o=this;return $(function*(){const i=yield*o.fetchTokenList(!1),c=$S(i),a=yield*o.fetchBalance(t,r);if(c.length===0)return{native:a,tokens:[]};const u=yield*Z({url:`${o.baseUrl}/account/balance/v2`,method:"POST",body:{address:t,contracts:c},schema:vS,cacheStrategy:r?"ttl":"cache-first",cacheTtl:o.balanceCacheTtlMs,canCache:ES}).pipe(Ie(l=>{Array.isArray(l)||zs("account/balance/v2",l)}),j(CS),Ve(()=>z([])));return{native:a,tokens:u}})}return ze({native:this.fetchBalance(t,r),tokens:Z({url:`${this.baseUrl}/account/balance/v2`,method:"POST",body:{address:t,contracts:s},schema:vS,cacheStrategy:r?"ttl":"cache-first",cacheTtl:this.balanceCacheTtlMs,canCache:ES}).pipe(Ie(o=>{Array.isArray(o)||zs("account/balance/v2",o)}),j(CS),Ve(()=>z([])))})}fetchTokenList(t=!1){return Z({url:`${this.baseUrl}/contract/tokens`,method:"POST",body:{page:1,pageSize:50,chain:"ETH"},schema:y3,cacheStrategy:t?"network-first":"ttl",cacheTtl:this.tokenListCacheTtl,canCache:b3}).pipe(Ie(n=>zs("contract/tokens",n)),j(E3))}}function AE(e,t){return e.type==="ethwallet-v1"?new $E(e,t):null}const A3=A({success:ve,result:S(De(g,N))}),R3=De(A3,g,N),O3=A({txID:g,from:g,to:g,amount:De(g,N),timestamp:N,contractRet:S(g),blockNumber:S(De(g,N)),fee:S(De(g,N))}),P3=A({txID:g,from:g,to:g,value:De(g,N),timestamp:N,tokenSymbol:S(g),token_symbol:S(g),tokenName:S(g),token_name:S(g),tokenDecimal:S(N),token_decimals:S(N),contractAddress:S(g),token_address:S(g),contractRet:S(g)}),F3=A({success:ve,data:S(ue(O3)),fingerprint:S(g),pageSize:S(N)}),x3=A({success:ve,data:S(ue(P3)),fingerprint:S(g),pageSize:S(N)}),RE=A({amount:De(g,N),contractAddress:S(g),decimals:S(N),icon:S(g),symbol:S(g),name:S(g)}),N3=ue(RE),B3=A({success:ve,result:S(ue(RE))}),AS=De(N3,B3),M3=A({chain:S(g),address:g,name:g,icon:S(g),symbol:g,decimals:N}),L3=A({data:ue(M3),page:N,pageSize:N,total:N,pages:S(N)}),H3=A({success:ve,result:L3}),D3=A({from:g,to:g,state:S(De(g,N)),createdTime:De(g,N),txHash:g,value:De(g,N),assetSymbol:S(g),fee:S(De(g,N)),extra:S(Bl)}),U3=ue(D3),K3=Bl;function j3(e){return typeof e=="object"&&e!==null}function Qr(e){return e==null?"0":String(e)}function Lf(e){try{return nr(e)}catch{return e.toLowerCase()}}function Hf(e,t,n){const r=Lf(e),s=Lf(t),o=Lf(n);return r===o&&s===o?"self":r===o?"out":"in"}function z3(e){if(typeof e=="string"){const t=e.toLowerCase();return t.includes("success")||t.includes("confirm")?"confirmed":t.includes("fail")?"failed":"pending"}return typeof e=="number"&&e>=2?"confirmed":"pending"}function V3(e,t){const n=new Map;for(const r of e)n.set(r.hash,r);for(const r of t){const s=n.get(r.hash);if(s){s.assets=[...s.assets,...r.assets],n.set(r.hash,s);continue}n.set(r.hash,r)}return Array.from(n.values()).sort((r,s)=>s.timestamp-r.timestamp)}function q3(e){return j3(e)?Object.keys(e).length>0:!1}function Df(e){return Promise.resolve(e.success)}function W3(e){return typeof e=="string"||typeof e=="number"?Promise.resolve(!0):Promise.resolve(e.success)}function RS(e){return typeof e=="string"||typeof e=="number"?{success:!0,amount:Qr(e)}:{success:e.success,amount:Qr(e.result)}}function OS(e){return Array.isArray(e)?Promise.resolve(!0):Promise.resolve(e.success)}function PS(e){return Array.isArray(e)?e:e.result??[]}function Vs(e,t){t.success}function J3(e){const t=new Set;for(const n of e)for(const r of n.assets)r.assetType==="token"&&r.contractAddress&&t.add(r.contractAddress);return[...t].sort()}function FS(e,t){return!e||e.length!==t.length?!0:e.length===0&&t.length===0?!1:e[0]?.hash!==t[0]?.hash}function xS(e){return e.success?e.result.data.map(t=>t.address).filter(t=>t.length>0).map(t=>pt(t)).sort():[]}class G3{chainId;type;endpoint;config;constructor(t,n){this.type=t.type,this.endpoint=t.endpoint,this.config=t.config,this.chainId=n}}function NS(e,t){const n=Math.max(e.length,0);return(BigInt(Math.floor(n/2)+68)*1000n+(t?10000000n:0n)).toString()}class OE extends yE(SE(G3)){symbol;decimals;baseUrl;pollingInterval=3e4;tokenListCacheTtl=600*1e3;_eventBus=null;_txHistorySources=new Map;_txHistoryCreations=new Map;_balanceSources=new Map;_balanceCreations=new Map;_tokenBalanceSources=new Map;_tokenBalanceCreations=new Map;_tokenListSource=null;_tokenListCreation=null;get pendingTxCacheTtl(){return Math.max(1e3,Math.floor(this.pollingInterval/4))}nativeBalance;tokenBalances;transactionHistory;transaction;constructor(t,n){super(t,n),this.symbol=le.getSymbol(n),this.decimals=le.getDecimals(n),this.baseUrl=this.endpoint;const r=this;this.transactionHistory=Se(`tronwallet.${n}.transactionHistory`,s=>r.createTransactionHistorySource(s)),this.nativeBalance=Se(`tronwallet.${n}.nativeBalance`,s=>r.createBalanceSource(s)),this.tokenBalances=Se(`tronwallet.${n}.tokenBalances`,s=>r.createTokenBalancesSource(s)),this.transaction=Se(`tronwallet.${n}.transaction`,s=>r.createTransactionSource(s))}createTransactionHistorySource(t){return this.getSharedTxHistorySource(t.address)}createBalanceSource(t){return this.getSharedBalanceSource(t.address)}createTokenBalancesSource(t){return this.getSharedTokenBalanceSource(t.address)}createTransactionSource(t){const n=this,r=this.symbol,s=this.decimals;return $(function*(){const o=$(function*(){const[c,a]=yield*ze([n.fetchTransactionReceipt(t.txHash),t.senderId?n.fetchPendingTransactions(t.senderId):z([])]),u=a.find(f=>f.txHash===t.txHash),l=q3(c);if(u){const f=pt(u.from),h=pt(u.to);return{hash:u.txHash,from:f,to:h,timestamp:Number(u.createdTime)||Date.now(),status:l?"confirmed":z3(u.state),action:"transfer",direction:Hf(u.from,u.to,t.senderId??f),assets:[{assetType:"native",value:Qr(u.value),symbol:r,decimals:s}]}}if(l){const f=t.senderId?pt(t.senderId):"";return{hash:t.txHash,from:f,to:"",timestamp:Date.now(),status:"confirmed",action:"transfer",direction:f?"out":"in",assets:[{assetType:"native",value:"0",symbol:r,decimals:s}]}}return null});return yield*ke({name:`tronwallet.${n.chainId}.transaction`,fetch:o,interval:ie(3e3)})})}async buildTransaction(t){if(t.type!=="transfer")throw new de(ge.NOT_SUPPORTED,`Transaction type not supported: ${t.type}`);const n=t,r=Zn(n.from),s=Zn(n.to),o=!!n.fee,i=n.fee?.raw??"0",c=n.tokenAddress?.trim(),a=!!c;let u=this.symbol;if(c)try{u=await this.resolveTokenSymbol(c)}catch(m){console.warn("[tronwallet] resolveTokenSymbol failed",m),u=c}if(a&&c){const m=Zn(c),y=o&&Number.isFinite(Number(i))?Number(i):1e8,b=await Q(ho({url:`${this.baseUrl}/trans/contract`,method:"POST",body:{owner_address:r,contract_address:m,function_selector:"transfer(address,uint256)",input:[{type:"address",value:s},{type:"uint256",value:n.amount.toRawString()}],fee_limit:y,call_value:0}})),_=this.extractTrc20Transaction(b),k=o?i:NS(_.raw_data_hex??"",!0),C={from:r,to:s,amount:n.amount.raw,fee:k,assetSymbol:u};return{chainId:this.chainId,intentType:"transfer",data:{rawTx:_,detail:C,isToken:!0}}}const l=await Q(ho({url:`${this.baseUrl}/trans/create`,method:"POST",body:{owner_address:r,to_address:s,amount:Number(n.amount.raw),extra_data:n.memo}})),f=o?i:NS(l.raw_data_hex??"",!1),h={from:r,to:s,amount:n.amount.raw,fee:f,assetSymbol:u};return{chainId:this.chainId,intentType:"transfer",data:{rawTx:l,detail:h,isToken:!1}}}async signTransaction(t,n){if(!n.privateKey)throw new de(ge.SIGNATURE_FAILED,"privateKey is required for Tron signing");const r=t.data,s=to(r.rawTx.txID),o=go.sign(s,n.privateKey,{prehash:!1,format:"recovered"}),i=Cr(o),c={...r.rawTx,signature:[i]};return{chainId:t.chainId,data:{signedTx:c,detail:r.detail,isToken:r.isToken},signature:i}}async broadcastTransaction(t){const n=t.data,r=n.isToken?`${this.baseUrl}/trans/trc20/broadcast`:`${this.baseUrl}/trans/broadcast`;if(!(await Q(ho({url:r,method:"POST",body:{...n.signedTx,detail:n.detail}}))).result)throw new de(ge.TX_BROADCAST_FAILED,"Broadcast failed");return n.signedTx.txID}getSharedTxHistorySource(t){const n=this,r=pt(t),s=nr(t),o=this.symbol,i=this.decimals,c=l=>({...l,stop:n.releaseSharedTxHistorySource(s)}),a=n._txHistorySources.get(s);if(a)return a.refCount+=1,z(c(a.source));const u=n._txHistoryCreations.get(s);return W(u?async()=>{const l=await u,f=n._txHistorySources.get(s);return f&&(f.refCount+=1),c(l)}:async()=>{const l=Q($(function*(){n._eventBus||(n._eventBus=yield*Tn());const f=n._eventBus,h=yield*ke({name:`tronwallet.${n.chainId}.txHistory.native.${s}`,fetch:n.fetchNativeHistory({address:r,limit:50},!0),interval:ie(n.pollingInterval),walletEvents:{eventBus:f,chainId:n.chainId,address:r,types:["tx:confirmed","tx:sent"]}}),m=yield*n.getSharedTokenListSource(),y=yield*$t(0),b=en(y,F=>F+1).pipe(Ae),_=yield*$t(new Map),k=[],C=F=>ot(F.pipe(us(()=>b),fr));k.push(yield*C(h.changes));const v=new Map,T=new Map,R=F=>$(function*(){if(v.has(F))return;const E=yield*ke({name:`tronwallet.${n.chainId}.txHistory.trc20.${s}.${F}`,fetch:n.fetchTrc20History({address:r,limit:50,contractAddress:F},!0),interval:ie(n.pollingInterval),immediate:!1,walletEvents:{eventBus:f,chainId:n.chainId,address:r,types:["tx:confirmed","tx:sent"]}});v.set(F,E);const V=yield*ot(E.changes.pipe(qn(q=>en(_,D=>{const B=new Map(D);return B.set(F,q),B}).pipe(Ce(b)))));T.set(F,V),yield*ot(E.refresh.pipe(Ae))}),w=F=>$(function*(){const E=v.get(F);E&&(yield*E.stop,v.delete(F));const V=T.get(F);V&&(yield*Fe(V),T.delete(F)),yield*en(_,q=>{const D=new Map(q);return D.delete(F),D}).pipe(Ce(b))}),I=F=>$(function*(){const E=F?xS(F):[],V=new Set(E);for(const q of v.keys())V.has(q)||(yield*w(q));for(const q of V)v.has(q)||(yield*R(q))});yield*I(yield*m.get),k.push(yield*ot(m.changes.pipe(qn(F=>I(F).pipe(Ce(b))))));const O=yield*Le({name:`tronwallet.${n.chainId}.txHistory.${s}`,dependsOn:y,hasChanged:(F,E)=>F!==E,fetch:()=>$(function*(){const E=((yield*h.get)?.data??[]).map(D=>{const B=pt(D.from),x=pt(D.to),ce=D.contractRet==="SUCCESS"?"confirmed":"failed";return{hash:D.txID,from:B,to:x,timestamp:D.timestamp,status:ce,blockNumber:D.blockNumber?BigInt(String(D.blockNumber)):void 0,action:"transfer",direction:Hf(D.from,D.to,r),assets:[{assetType:"native",value:Qr(D.amount),symbol:o,decimals:i}],fee:D.fee!==void 0?{value:Qr(D.fee),symbol:o,decimals:i}:void 0}}),q=[...(yield*Bt(_)).values()].flatMap(D=>(D?.data??[]).map(B=>{const x=pt(B.from),ce=pt(B.to),je=B.contractRet?B.contractRet==="SUCCESS"?"confirmed":"failed":"confirmed",Vt=B.tokenSymbol??B.token_symbol??"TRC20",xs=B.tokenDecimal??B.token_decimals??0,br=B.contractAddress??B.token_address,LE=br?pt(br):"";return{hash:B.txID,from:x,to:ce,timestamp:B.timestamp,status:je,action:"transfer",direction:Hf(B.from,B.to,r),assets:[{assetType:"token",value:Qr(B.value),symbol:Vt,decimals:xs,contractAddress:LE,name:B.tokenName??B.token_name}]}}));return V3(E,q)})}),H=$(function*(){for(const F of k)yield*Fe(F);for(const F of v.values())yield*F.stop;for(const F of T.values())yield*Fe(F);yield*O.stop,yield*h.stop,yield*n.releaseSharedTokenListSource()});return n._txHistorySources.set(s,{source:O,refCount:1,stopAll:H}),O}));n._txHistoryCreations.set(s,l);try{const f=await l;return c(f)}finally{n._txHistoryCreations.delete(s)}})}releaseSharedTxHistorySource(t){const n=this;return $(function*(){const r=n._txHistorySources.get(t);r&&(r.refCount-=1,r.refCount<=0&&(yield*r.stopAll,n._txHistorySources.delete(t)))})}getSharedBalanceSource(t){const n=this,r=nr(t),s=this.symbol,o=this.decimals,i=u=>({...u,stop:n.releaseSharedBalanceSource(r)}),c=n._balanceSources.get(r);if(c)return c.refCount+=1,z(i(c.source));const a=n._balanceCreations.get(r);return W(a?async()=>{const u=await a,l=n._balanceSources.get(r);return l&&(l.refCount+=1),i(u)}:async()=>{const u=Q($(function*(){const l=yield*n.getSharedTxHistorySource(t),f=yield*Le({name:`tronwallet.${n.chainId}.balance`,dependsOn:l.ref,hasChanged:FS,fetch:(m,y)=>n.fetchBalance(t,y).pipe(j(b=>{const _=RS(b);return{amount:se.fromRaw(_.amount,o,s),symbol:s}}))}),h=ze([f.stop,l.stop]).pipe(Ae);return n._balanceSources.set(r,{source:f,refCount:1,stopAll:h}),f}));n._balanceCreations.set(r,u);try{const l=await u;return i(l)}finally{n._balanceCreations.delete(r)}})}releaseSharedBalanceSource(t){const n=this;return $(function*(){const r=n._balanceSources.get(t);r&&(r.refCount-=1,r.refCount<=0&&(yield*r.stopAll,n._balanceSources.delete(t)))})}getSharedTokenBalanceSource(t){const n=this,r=nr(t),s=this.symbol,o=this.decimals,i=u=>({...u,stop:n.releaseSharedTokenBalanceSource(r)}),c=n._tokenBalanceSources.get(r);if(c)return c.refCount+=1,z(i(c.source));const a=n._tokenBalanceCreations.get(r);return W(a?async()=>{const u=await a,l=n._tokenBalanceSources.get(r);return l&&(l.refCount+=1),i(u)}:async()=>{const u=Q($(function*(){const l=yield*n.getSharedTxHistorySource(t),f=yield*Le({name:`tronwallet.${n.chainId}.tokenBalances`,dependsOn:l.ref,hasChanged:FS,fetch:(m,y)=>n.fetchTokenBalances(t,J3(m),y).pipe(j(b=>{const _=[],k=RS(b.native);_.push({symbol:s,name:s,amount:se.fromRaw(k.amount,o,s),isNative:!0,decimals:o});for(const C of b.tokens){const v=C.symbol??"TRC20",T=C.decimals??0,R=C.contractAddress?pt(C.contractAddress):void 0;_.push({symbol:v,name:C.name??v,amount:se.fromRaw(Qr(C.amount),T,v),isNative:!1,decimals:T,icon:C.icon,contractAddress:R})}return _}))}),h=ze([f.stop,l.stop]).pipe(Ae);return n._tokenBalanceSources.set(r,{source:f,refCount:1,stopAll:h}),f}));n._tokenBalanceCreations.set(r,u);try{const l=await u;return i(l)}finally{n._tokenBalanceCreations.delete(r)}})}releaseSharedTokenBalanceSource(t){const n=this;return $(function*(){const r=n._tokenBalanceSources.get(t);r&&(r.refCount-=1,r.refCount<=0&&(yield*r.stopAll,n._tokenBalanceSources.delete(t)))})}getSharedTokenListSource(){const t=this;return t._tokenListSource?(t._tokenListSource.refCount+=1,z(t._tokenListSource.source)):t._tokenListCreation?W(async()=>{const n=await t._tokenListCreation;return t._tokenListSource&&(t._tokenListSource.refCount+=1),n}):W(async()=>{const n=Q($(function*(){const r=yield*ke({name:`tronwallet.${t.chainId}.tokenList`,fetch:t.fetchTokenList(!1),interval:ie(t.tokenListCacheTtl),immediate:!0});return t._tokenListSource={source:r,refCount:1,stopAll:r.stop},r}));t._tokenListCreation=n;try{return await n}finally{t._tokenListCreation=null}})}releaseSharedTokenListSource(){const t=this;return $(function*(){const n=t._tokenListSource;n&&(n.refCount-=1,n.refCount<=0&&(yield*n.stopAll,t._tokenListSource=null))})}fetchBalance(t,n=!1){return Z({url:`${this.baseUrl}/balance`,method:"GET",searchParams:{address:Zn(t)},schema:R3,cacheStrategy:n?"network-first":"cache-first",canCache:W3}).pipe(Ie(r=>{typeof r=="object"&&r!==null&&"success"in r&&Vs("balance",r)}))}fetchNativeHistory(t,n=!1){return Z({url:`${this.baseUrl}/trans/common/history`,method:"POST",body:{address:Zn(t.address),limit:t.limit??50},schema:F3,cacheStrategy:n?"network-first":"cache-first",canCache:Df}).pipe(Ie(r=>Vs("trans/common/history",r)))}fetchTrc20History(t,n=!1){return t.contractAddress?Z({url:`${this.baseUrl}/trans/trc20/history`,method:"POST",body:{address:Zn(t.address),limit:t.limit??50,contract_address:pt(t.contractAddress)},schema:x3,cacheStrategy:n?"network-first":"cache-first",canCache:Df}).pipe(Ie(r=>Vs("trans/trc20/history",r))):z({success:!0,data:[],fingerprint:"",pageSize:0})}fetchTransactions(t,n=!1){return ze({native:this.fetchNativeHistory(t,n),trc20:this.fetchTrc20History(t,n).pipe(Ve(()=>z({success:!1,data:[]})))})}fetchTokenBalances(t,n,r=!1){const s=pt(t),o=[...n].sort();if(o.length===0){const i=this;return $(function*(){const c=yield*i.fetchTokenList(!1),a=xS(c),u=yield*i.fetchBalance(t,r);if(a.length===0)return{native:u,tokens:[]};const l=yield*Z({url:`${i.baseUrl}/account/balance/v2`,method:"POST",body:{address:s,contracts:a},schema:AS,cacheStrategy:r?"network-first":"cache-first",canCache:OS}).pipe(Ie(f=>{Array.isArray(f)||Vs("account/balance/v2",f)}),j(PS),Ve(()=>z([])));return{native:u,tokens:l}})}return ze({native:this.fetchBalance(t,r),tokens:Z({url:`${this.baseUrl}/account/balance/v2`,method:"POST",body:{address:s,contracts:o},schema:AS,cacheStrategy:r?"network-first":"cache-first",canCache:OS}).pipe(Ie(i=>{Array.isArray(i)||Vs("account/balance/v2",i)}),j(PS),Ve(()=>z([])))})}fetchTokenList(t=!1){return Z({url:`${this.baseUrl}/contract/tokens`,method:"POST",body:{page:1,pageSize:50,chain:"TRON"},schema:H3,cacheStrategy:t?"network-first":"ttl",cacheTtl:this.tokenListCacheTtl,canCache:Df}).pipe(Ie(n=>Vs("contract/tokens",n)))}async resolveTokenSymbol(t){const n=t.trim();if(!n)return t;const r=nr(n);return(await Q(this.fetchTokenList(!1))).result.data.find(i=>i.address&&nr(i.address)===r)?.symbol??t}extractTrc20Transaction(t){if(t&&typeof t=="object"){const n=t;if("success"in n&&n.success===!1)throw new de(ge.TX_BUILD_FAILED,"TRC20 transaction build failed");const r=n.transaction;if(r&&typeof r=="object"&&"txID"in r)return r;const s=n.result;if(s&&typeof s=="object"){const o=s.transaction;if(o&&typeof o=="object"&&"txID"in o)return o}if("txID"in n)return n}throw new de(ge.TX_BUILD_FAILED,"Invalid TRC20 transaction response")}fetchPendingTransactions(t){return Z({url:`${this.baseUrl}/trans/pending`,method:"POST",body:{address:Zn(t),assetSymbol:this.symbol},schema:U3,cacheStrategy:"ttl",cacheTtl:this.pendingTxCacheTtl})}fetchTransactionReceipt(t){return Z({url:`${this.baseUrl}/trans/receipt`,method:"POST",body:{txId:t},schema:K3,cacheStrategy:"ttl",cacheTtl:this.pendingTxCacheTtl})}}function PE(e,t){return e.type==="tronwallet-v1"?new OE(e,t):null}const Y3=A({txid:g,vin:S(ue(A({addresses:S(ue(g))}))),vout:S(ue(A({addresses:S(ue(g)),value:S(g)}))),blockTime:S(N),confirmations:S(N)}),Q3=A({balance:g,txs:S(N),transactions:S(ue(Y3))}),X3=A({success:ve,result:S(Q3)}),Z3=A({txid:g,vin:S(ue(A({addresses:S(ue(g))}))),vout:S(ue(A({addresses:S(ue(g)),value:S(g)}))),blockTime:S(N),confirmations:S(N),blockHeight:S(N)}),eq=A({success:ve,result:S(Z3)}),tq=A({txid:g,vout:N,value:De(g,N),scriptPubKey:S(g)}),nq=A({success:ve,result:S(ue(tq))}),rq=A({success:ve,result:S(De(g,N))}),sq=A({success:ve,result:S(g)});function BS(e,t,n){const r=e?.some(o=>o.addresses?.includes(n)),s=t?.some(o=>o.addresses?.includes(n));return r&&s?"self":r?"out":"in"}function oq(e,t){return!e||e.length!==t.length?!0:e.length===0&&t.length===0?!1:e[0]?.hash!==t[0]?.hash}function iq(e){return e.result??{balance:"0",transactions:[]}}function ca(e){return Promise.resolve(e.success)}function Uf(e,t){return t.success&&t.result!==void 0?z(t.result):Ct(new it(`[btcwallet] ${e} failed`))}function cq(e,t){return t.success?z(t.result??null):Ct(new it(`[btcwallet] ${e} failed`))}function Si(e,t){t.success}class aq{chainId;type;endpoint;config;constructor(t,n){this.type=t.type,this.endpoint=t.endpoint,this.config=t.config,this.chainId=n}}class FE extends kE(TE(aq)){symbol;decimals;baseUrl;pollingInterval=6e4;_eventBus=null;_txHistorySources=new Map;_txHistoryCreations=new Map;_balanceSources=new Map;_balanceCreations=new Map;_transactionSources=new Map;_transactionCreations=new Map;nativeBalance;transactionHistory;transaction;constructor(t,n){super(t,n),this.symbol=le.getSymbol(n),this.decimals=le.getDecimals(n),this.baseUrl=this.endpoint;const r=this;this.transactionHistory=Se(`btcwallet.${n}.transactionHistory`,s=>r.createTransactionHistorySource(s)),this.nativeBalance=Se(`btcwallet.${n}.nativeBalance`,s=>r.createBalanceSource(s)),this.transaction=Se(`btcwallet.${n}.transaction`,s=>r.createTransactionSource(s))}createTransactionHistorySource(t){return this.getSharedTxHistorySource(t.address)}createBalanceSource(t){return this.getSharedBalanceSource(t.address)}createTransactionSource(t){return this.getSharedTransactionSource(t.txHash,t.senderId)}getSharedTxHistorySource(t){const n=this,r=t,s=this.symbol,o=this.decimals,i=u=>({...u,stop:n.releaseSharedTxHistorySource(r)}),c=n._txHistorySources.get(r);if(c)return c.refCount+=1,z(i(c.source));const a=n._txHistoryCreations.get(r);return W(a?async()=>{const u=await a,l=n._txHistorySources.get(r);return l&&(l.refCount+=1),i(u)}:async()=>{const u=Q($(function*(){n._eventBus||(n._eventBus=yield*Tn());const l=n._eventBus,f=n.fetchAddressInfo(t,!0).pipe(j(y=>(y.transactions??[]).map(b=>({hash:b.txid,from:b.vin?.[0]?.addresses?.[0]??"",to:b.vout?.[0]?.addresses?.[0]??"",timestamp:(b.blockTime??0)*1e3,status:(b.confirmations??0)>0?"confirmed":"pending",action:"transfer",direction:BS(b.vin,b.vout,t),assets:[{assetType:"native",value:b.vout?.[0]?.value??"0",symbol:s,decimals:o}]})))),h=yield*ke({name:`btcwallet.${n.chainId}.txHistory.${r}`,fetch:f,interval:ie(n.pollingInterval),walletEvents:{eventBus:l,chainId:n.chainId,address:t,types:["tx:confirmed","tx:sent"]}}),m=h.stop;return n._txHistorySources.set(r,{source:h,refCount:1,stopAll:m}),h}));n._txHistoryCreations.set(r,u);try{const l=await u;return i(l)}finally{n._txHistoryCreations.delete(r)}})}releaseSharedTxHistorySource(t){const n=this;return $(function*(){const r=n._txHistorySources.get(t);r&&(r.refCount-=1,r.refCount<=0&&(yield*r.stopAll,n._txHistorySources.delete(t)))})}getSharedBalanceSource(t){const n=this,r=t,s=this.symbol,o=this.decimals,i=u=>({...u,stop:n.releaseSharedBalanceSource(r)}),c=n._balanceSources.get(r);if(c)return c.refCount+=1,z(i(c.source));const a=n._balanceCreations.get(r);return W(a?async()=>{const u=await a,l=n._balanceSources.get(r);return l&&(l.refCount+=1),i(u)}:async()=>{const u=Q($(function*(){const l=yield*n.getSharedTxHistorySource(t),f=yield*Le({name:`btcwallet.${n.chainId}.balance`,dependsOn:l.ref,hasChanged:oq,fetch:(m,y)=>n.fetchAddressInfo(t,y).pipe(j(b=>({amount:se.fromRaw(b.balance,o,s),symbol:s})))}),h=ze([f.stop,l.stop]).pipe(Ae);return n._balanceSources.set(r,{source:f,refCount:1,stopAll:h}),f}));n._balanceCreations.set(r,u);try{const l=await u;return i(l)}finally{n._balanceCreations.delete(r)}})}releaseSharedBalanceSource(t){const n=this;return $(function*(){const r=n._balanceSources.get(t);r&&(r.refCount-=1,r.refCount<=0&&(yield*r.stopAll,n._balanceSources.delete(t)))})}getSharedTransactionSource(t,n){const r=this,s=n?`${t}:${n}`:t,o=this.symbol,i=this.decimals,c=l=>({...l,stop:r.releaseSharedTransactionSource(s)}),a=r._transactionSources.get(s);if(a)return a.refCount+=1,z(c(a.source));const u=r._transactionCreations.get(s);return W(u?async()=>{const l=await u,f=r._transactionSources.get(s);return f&&(f.refCount+=1),c(l)}:async()=>{const l=Q($(function*(){const f=r.fetchTransactionDetail(t,!0).pipe(j(y=>{if(!y)return null;const b=n?BS(y.vin,y.vout,n):"self";return{hash:y.txid,from:y.vin?.[0]?.addresses?.[0]??"",to:y.vout?.[0]?.addresses?.[0]??"",timestamp:(y.blockTime??0)*1e3,status:(y.confirmations??0)>0?"confirmed":"pending",action:"transfer",direction:b,assets:[{assetType:"native",value:y.vout?.[0]?.value??"0",symbol:o,decimals:i}]}})),h=yield*ke({name:`btcwallet.${r.chainId}.transaction.${s}`,fetch:f,interval:ie(r.pollingInterval)}),m=h.stop;return r._transactionSources.set(s,{source:h,refCount:1,stopAll:m}),h}));r._transactionCreations.set(s,l);try{const f=await l;return c(f)}finally{r._transactionCreations.delete(s)}})}releaseSharedTransactionSource(t){const n=this;return $(function*(){const r=n._transactionSources.get(t);r&&(r.refCount-=1,r.refCount<=0&&(yield*r.stopAll,n._transactionSources.delete(t)))})}fetchAddressInfo(t,n=!1){const r=`/api/v2/address/${t}?page=1&pageSize=50&details=txs`;return Z({url:this.baseUrl,method:"POST",body:{url:r,method:"GET"},schema:X3,cacheStrategy:n?"ttl":"cache-first",cacheTtl:5e3,canCache:ca}).pipe(Ie(s=>Si("blockbook/address",s)),j(iq))}fetchTransactionDetail(t,n=!1){const r=`/api/v2/tx/${t}`;return Z({url:this.baseUrl,method:"POST",body:{url:r,method:"GET"},schema:eq,cacheStrategy:n?"ttl":"cache-first",cacheTtl:5e3,canCache:ca}).pipe(Ie(s=>Si("blockbook/tx",s)),X(s=>cq("blockbook/tx",s)))}fetchUtxos(t,n=!1){const r=`/api/v2/utxo/${t}`;return Z({url:this.baseUrl,method:"POST",body:{url:r,method:"GET"},schema:nq,cacheStrategy:n?"ttl":"cache-first",cacheTtl:15e3,canCache:ca}).pipe(Ie(s=>Si("blockbook/utxo",s)),X(s=>Uf("blockbook/utxo",s)))}fetchFeeRate(t=6,n=!1){const r=`/api/v2/estimatefee/${t}`;return Z({url:this.baseUrl,method:"POST",body:{url:r,method:"GET"},schema:rq,cacheStrategy:n?"ttl":"cache-first",cacheTtl:3e4,canCache:ca}).pipe(Ie(s=>Si("blockbook/estimatefee",s)),X(s=>Uf("blockbook/estimatefee",s)),j(s=>String(s)))}broadcastRawTransaction(t){const n=`/api/v2/sendtx/${t}`;return Z({url:this.baseUrl,method:"POST",body:{url:n,method:"GET"},schema:sq,cacheStrategy:"network-first",cacheTtl:0,canCache:async()=>!1}).pipe(Ie(r=>Si("blockbook/sendtx",r)),X(r=>Uf("blockbook/sendtx",r)))}async buildTransaction(t){if(t.type!=="transfer")throw new Error(`Transaction type not supported: ${t.type}`);const n=t,r=await Q(this.fetchUtxos(n.from,!0));if(r.length===0)throw new Error("No UTXOs available");const s=await Q(this.fetchFeeRate(6,!0)),o=Number(s),i=Number.isFinite(o)?o*1e8:0,c=i>0?Math.ceil(i/1e3):1,a=r.reduce((y,b)=>y+Number(b.value),0),u=Number(n.amount.raw),l=10+r.length*68+62,f=c*l;if(a<u+f)throw new Error(`Insufficient balance: need ${u+f}, have ${a}`);const h=a-u-f,m={inputs:r.map(y=>({txid:y.txid,vout:y.vout,value:Number(y.value),scriptPubKey:y.scriptPubKey??""})),outputs:[{address:n.to,value:u}],fee:f,changeAddress:n.from};return h>546&&m.outputs.push({address:n.from,value:h}),{chainId:this.chainId,intentType:"transfer",data:m}}async estimateFee(t){const n=await Q(this.fetchFeeRate(6,!0)),r=Number(n),s=Number.isFinite(r)?r*1e8:0,o=s>0?Math.ceil(s/1e3):1,i=le.getConfig(this.chainId),a=BigInt(o*140),u={amount:se.fromRaw((a*80n/100n).toString(),i.decimals,i.symbol),estimatedTime:3600},l={amount:se.fromRaw(a.toString(),i.decimals,i.symbol),estimatedTime:1800},f={amount:se.fromRaw((a*120n/100n).toString(),i.decimals,i.symbol),estimatedTime:600};return{slow:u,standard:l,fast:f}}async broadcastTransaction(t){const n=t.data;return Q(this.broadcastRawTransaction(n))}}function xE(e,t){return e.type==="btcwallet-v1"?new FE(e,t):null}const uq={ethereum:"eth",binance:"bsc",polygon:"polygon",avalanche:"avalanche",fantom:"fantom",arbitrum:"arbitrum",optimism:"optimism",base:"base"},lq=A({balance:g}),fq=A({transactionHash:g,blockNumber:g,status:S(g)}),hq=A({jsonrpc:g,id:N,result:we(fq)}),dq=A({token_address:g,symbol:g,name:g,decimals:N,balance:g,logo:S(we(g)),thumbnail:S(we(g)),possible_spam:S(ve),verified_contract:S(ve),total_supply:S(we(g)),security_score:S(we(N))}),pq=ue(dq),mq=A({from_address:g,to_address:g,value:g,value_formatted:S(we(g)),direction:S(jc("send","receive")),token_symbol:S(we(g)),token_logo:S(we(g))}),gq=A({from_address:g,to_address:g,value:g,value_formatted:S(we(g)),token_name:S(we(g)),token_symbol:S(we(g)),token_decimals:S(we(g)),token_logo:S(we(g)),address:g}),yq=A({hash:g,from_address:g,to_address:we(g),value:g,block_timestamp:g,block_number:g,receipt_status:S(g),transaction_fee:S(g),category:S(g),summary:S(g),possible_spam:S(ve),from_address_entity:S(we(g)),to_address_entity:S(we(g)),native_transfers:S(ue(mq)),erc20_transfers:S(ue(gq))}),Sq=A({result:ue(yq),cursor:S(we(g)),page:S(N),page_size:S(N)});function bq(e,t,n){const r=e.toLowerCase(),s=t.toLowerCase(),o=n.toLowerCase();return r===o&&s===o?"self":r===o?"out":"in"}function _q(e){switch(e){case"send":case"receive":return"transfer";case"token send":case"token receive":return"transfer";case"nft send":case"nft receive":return"transfer";case"approve":return"approve";case"contract interaction":return"contract";default:return"transfer"}}function MS(e,t){return!e||e.length!==t.length?!0:e.length===0&&t.length===0?!1:e[0]?.hash!==t[0]?.hash}const aa=FT(zd(5),2).pipe(gm(ym(3)),zD(e=>e._tag==="RateLimitError"||e._tag==="HttpError"&&(e.status===429||e.status===401)));class wq{chainId;type;endpoint;config;constructor(t,n){this.type=t.type,this.endpoint=t.endpoint,this.config=t.config,this.chainId=n}}class NE extends oi(ii(wq)){symbol;decimals;moralisChain;apiKey;baseUrl;txStatusInterval;erc20Interval;rpcUrl;_eventBus=null;_txHistorySources=new Map;_txHistoryCreations=new Map;_balanceSources=new Map;_balanceCreations=new Map;_tokenBalanceSources=new Map;_tokenBalanceCreations=new Map;nativeBalance;tokenBalances;transactionHistory;transactionStatus;constructor(t,n){if(super(t,n),this.symbol=le.getSymbol(n),this.decimals=le.getDecimals(n),this.moralisChain=uq[n],!this.moralisChain)throw new Error(`[MoralisProviderEffect] Unsupported chain: ${n}`);this.baseUrl=this.endpoint;const r=ql("MORALIS_API_KEY",`moralis-${n}`);if(!r)throw new Error("[MoralisProviderEffect] MORALIS_API_KEY is required");this.apiKey=r,this.txStatusInterval=this.config?.txStatusInterval??3e3,this.erc20Interval=this.config?.erc20Interval??12e4,this.rpcUrl=le.getRpcUrl(n);const s=this;this.transactionHistory=Se(`moralis.${n}.transactionHistory`,o=>s.createTransactionHistorySource(o)),this.nativeBalance=Se(`moralis.${n}.nativeBalance`,o=>s.createBalanceSource(o)),this.tokenBalances=Se(`moralis.${n}.tokenBalances`,o=>s.createTokenBalancesSource(o)),this.transactionStatus=Se(`moralis.${n}.transactionStatus`,o=>s.createTransactionStatusSource(o))}createTransactionHistorySource(t){return this.getSharedTxHistorySource(t.address)}createBalanceSource(t){return this.getSharedBalanceSource(t.address)}createTokenBalancesSource(t){return this.getSharedTokenBalanceSource(t.address)}getSharedTxHistorySource(t){const n=this,r=t.toLowerCase(),s=r,o=this.symbol,i=this.decimals,c=l=>({...l,stop:n.releaseSharedTxHistorySource(s)}),a=n._txHistorySources.get(s);if(a)return a.refCount+=1,z(c(a.source));const u=n._txHistoryCreations.get(s);return W(u?async()=>{const l=await u,f=n._txHistorySources.get(s);return f&&(f.refCount+=1),c(l)}:async()=>{const l=Q($(function*(){n._eventBus||(n._eventBus=yield*Tn());const f=n._eventBus,h=n.fetchWalletHistory({address:t,limit:50},!0).pipe(Qc(aa),j(b=>b.result.filter(_=>!_.possible_spam).map(_=>{const k=bq(_.from_address,_.to_address??"",r),C=_q(_.category),v=_.erc20_transfers&&_.erc20_transfers.length>0,T=_.native_transfers&&_.native_transfers.length>0,R=[];if(v)for(const w of _.erc20_transfers)R.push({assetType:"token",value:w.value,symbol:w.token_symbol??"Unknown",decimals:parseInt(w.token_decimals??"18",10),contractAddress:w.address,name:w.token_name,logoUrl:w.token_logo??void 0});if(T||R.length===0){const w=T?_.native_transfers[0].value:_.value;R.unshift({assetType:"native",value:w,symbol:o,decimals:i})}return{hash:_.hash,from:_.from_address,to:_.to_address??"",timestamp:new Date(_.block_timestamp).getTime(),status:_.receipt_status==="1"?"confirmed":"failed",blockNumber:BigInt(_.block_number),action:C,direction:k,assets:R,fee:_.transaction_fee?{value:_.transaction_fee,symbol:o,decimals:i}:void 0,fromEntity:_.from_address_entity??void 0,toEntity:_.to_address_entity??void 0,summary:_.summary}}))),m=yield*ke({name:`moralis.${n.chainId}.txHistory.${s}`,fetch:h,interval:ie(n.erc20Interval),walletEvents:{eventBus:f,chainId:n.chainId,address:t,types:["tx:confirmed","tx:sent"]}}),y=m.stop;return n._txHistorySources.set(s,{source:m,refCount:1,stopAll:y}),m}));n._txHistoryCreations.set(s,l);try{const f=await l;return c(f)}finally{n._txHistoryCreations.delete(s)}})}releaseSharedTxHistorySource(t){const n=this;return $(function*(){const r=n._txHistorySources.get(t);r&&(r.refCount-=1,r.refCount<=0&&(yield*r.stopAll,n._txHistorySources.delete(t)))})}getSharedBalanceSource(t){const n=this,r=t.toLowerCase(),s=this.symbol,o=this.decimals,i=u=>({...u,stop:n.releaseSharedBalanceSource(r)}),c=n._balanceSources.get(r);if(c)return c.refCount+=1,z(i(c.source));const a=n._balanceCreations.get(r);return W(a?async()=>{const u=await a,l=n._balanceSources.get(r);return l&&(l.refCount+=1),i(u)}:async()=>{const u=Q($(function*(){const l=yield*n.getSharedTxHistorySource(t),f=yield*Le({name:`moralis.${n.chainId}.balance`,dependsOn:l.ref,hasChanged:MS,fetch:(m,y)=>n.fetchNativeBalance(t,y).pipe(Qc(aa),j(b=>({amount:se.fromRaw(b.balance,o,s),symbol:s})))}),h=ze([f.stop,l.stop]).pipe(Ae);return n._balanceSources.set(r,{source:f,refCount:1,stopAll:h}),f}));n._balanceCreations.set(r,u);try{const l=await u;return i(l)}finally{n._balanceCreations.delete(r)}})}releaseSharedBalanceSource(t){const n=this;return $(function*(){const r=n._balanceSources.get(t);r&&(r.refCount-=1,r.refCount<=0&&(yield*r.stopAll,n._balanceSources.delete(t)))})}getSharedTokenBalanceSource(t){const n=this,r=t.toLowerCase(),s=this.symbol,o=this.decimals,i=this.chainId,c=l=>({...l,stop:n.releaseSharedTokenBalanceSource(r)}),a=n._tokenBalanceSources.get(r);if(a)return a.refCount+=1,z(c(a.source));const u=n._tokenBalanceCreations.get(r);return W(u?async()=>{const l=await u,f=n._tokenBalanceSources.get(r);return f&&(f.refCount+=1),c(l)}:async()=>{const l=Q($(function*(){const f=yield*n.getSharedTxHistorySource(t),h=ze({native:n.fetchNativeBalance(t),tokens:n.fetchTokenBalances(t)}).pipe(Qc(aa),j(({native:b,tokens:_})=>{const k=[];k.push({symbol:s,name:s,amount:se.fromRaw(b.balance,o,s),isNative:!0,decimals:o});const C=_.filter(v=>!v.possible_spam);for(const v of C){const T=v.logo??v.thumbnail??le.getTokenIconByContract(i,v.token_address)??void 0;k.push({symbol:v.symbol,name:v.name,amount:se.fromRaw(v.balance,v.decimals,v.symbol),isNative:!1,decimals:v.decimals,icon:T,contractAddress:v.token_address,metadata:{possibleSpam:v.possible_spam,securityScore:v.security_score??void 0,verified:v.verified_contract,totalSupply:v.total_supply??void 0}})}return k})),m=yield*Le({name:`moralis.${n.chainId}.tokenBalances`,dependsOn:f.ref,hasChanged:MS,fetch:()=>h}),y=ze([m.stop,f.stop]).pipe(Ae);return n._tokenBalanceSources.set(r,{source:m,refCount:1,stopAll:y}),m}));n._tokenBalanceCreations.set(r,l);try{const f=await l;return c(f)}finally{n._tokenBalanceCreations.delete(r)}})}releaseSharedTokenBalanceSource(t){const n=this;return $(function*(){const r=n._tokenBalanceSources.get(t);r&&(r.refCount-=1,r.refCount<=0&&(yield*r.stopAll,n._tokenBalanceSources.delete(t)))})}createTransactionStatusSource(t){const n=this,r=this.chainId;return $(function*(){n._eventBus||(n._eventBus=yield*Tn());const s=n._eventBus,o=n.fetchTransactionReceipt(t.txHash).pipe(Qc(aa),X(c=>$(function*(){const a=c.result;return!a?.blockNumber?{status:"pending",confirmations:0,requiredConfirmations:1}:(t.address&&(yield*s.emit(Zj(r,t.address,t.txHash))),{status:a.status==="0x1"||a.status===void 0?"confirmed":"failed",confirmations:1,requiredConfirmations:1})})));return yield*ke({name:`moralis.${n.chainId}.txStatus`,fetch:o,interval:ie(n.txStatusInterval)})})}fetchNativeBalance(t,n=!1){return Z({url:`${this.baseUrl}/${t}/balance`,searchParams:{chain:this.moralisChain},headers:{"X-API-Key":this.apiKey,accept:"application/json"},schema:lq,cacheStrategy:n?"network-first":"cache-first"})}fetchTokenBalances(t,n=!1){return Z({url:`${this.baseUrl}/${t}/erc20`,searchParams:{chain:this.moralisChain},headers:{"X-API-Key":this.apiKey,accept:"application/json"},schema:pq,cacheStrategy:n?"network-first":"cache-first"}).pipe(j(r=>r.slice()))}fetchWalletHistory(t,n=!1){return Z({url:`${this.baseUrl}/wallets/${t.address}/history`,searchParams:{chain:this.moralisChain,limit:String(t.limit??20)},headers:{"X-API-Key":this.apiKey,accept:"application/json"},schema:Sq,cacheStrategy:n?"network-first":"cache-first"})}fetchTransactionReceipt(t,n=!1){return Z({url:this.rpcUrl,method:"POST",body:{jsonrpc:"2.0",id:1,method:"eth_getTransactionReceipt",params:[t]},schema:hq,cacheStrategy:n?"network-first":"cache-first"})}}function BE(e,t){if(e.type==="moralis")try{return new NE(e,t)}catch(n){return console.warn(`[MoralisProviderEffect] Failed to create provider for ${t}:`,n),null}return null}const vq=[BE,dE,gE,Q0,G0,Z0,vE,CE,AE,PE,xE];function ME(e){const t=e.trim();if(t.length===0)return t;const n=le.getConfig(t);return n?n.id:t.toLowerCase()}function kq(e,t){for(const n of vq){const r=n(e,t);if(r)return r}return null}function Sd(e){const t=ME(e),n=le.getApi(t),r=[];for(const s of n){const o=kq(s,t);o&&r.push(o)}return new W0(t,r)}const LS=new Map;function Tq(e){return e.map(t=>{const n=t.config?JSON.stringify(t.config):"";return`${t.type}|${t.endpoint}|${n}`}).join(",")}function Eq(e){const t=ME(e);if(!HE.state.snapshot)return Sd(t);const n=le.getApi(t),r=Tq(n),s=LS.get(t);if(s&&s.apiKey===r)return s.provider;const o=Sd(t);return LS.set(t,{provider:o,apiKey:r}),o}const yW=Object.freeze(Object.defineProperty({__proto__:null,BiowalletProviderEffect:hE,BscWalletProviderEffect:mE,BtcWalletProviderEffect:FE,ChainProvider:W0,EthWalletProviderEffect:$E,EtherscanV1ProviderEffect:J0,EtherscanV2ProviderEffect:Y0,EvmRpcProviderEffect:X0,InvalidDataError:JE,MempoolProviderEffect:EE,MoralisProviderEffect:NE,TronRpcProviderEffect:wE,TronWalletProviderEffect:OE,createBiowalletProviderEffect:dE,createBscWalletProviderEffect:gE,createBtcwalletProviderEffect:xE,createChainProvider:Sd,createEtherscanV1ProviderEffect:G0,createEtherscanV2ProviderEffect:Q0,createEthwalletProviderEffect:AE,createEvmRpcProviderEffect:Z0,createMempoolProviderEffect:CE,createMoralisProviderEffect:BE,createTronRpcProviderEffect:vE,createTronwalletProviderEffect:PE,getChainProvider:Eq},Symbol.toStringTag,{value:"Module"}));export{de as C,it as H,JE as I,sW as N,cW as S,$ as a,lW as b,ke as c,Tn as d,Zj as e,Zr as f,Eq as g,qn as h,V0 as i,Fe as j,Sd as k,iW as l,ie as m,pt as n,oW as o,W as p,N0 as q,Q as r,z as s,Ps as t,sE as u,ge as v,W0 as w,yW as x};
