const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./web-66kZx7dJ.js","./user-profile-Dve6_0lJ.js","./preload-helper-PPVm8Dsz.js","./index-D0E7N0oa.js","./derivation-BN6xqWKL.js","./iframe-DDpXk3xY.js","./iframe-DDLhkRVc.css","./schemas-CO8_C8zP.js","./avatar-codec-Byq6V-zy.js","./service-Bn7AeIKQ.js","./bioforest-B0k2ODEM.js","./breakpoint-DQ_qwb34.js","./nacl-fast-CqfJ7qrS.js","./nacl-fast-BvZxmqUA.js","./ed2curve-BV7H09ER.js"])))=>i.map(i=>d[i]);
import{W as yt,I as Et,c as bt}from"./wujie-container-PyOgY-VZ.js";import{t as _t}from"./web-66kZx7dJ.js";import{S as Oe,q as O,r as De}from"./iframe-DDpXk3xY.js";import{_ as E}from"./preload-helper-PPVm8Dsz.js";import{g as X,k as Rt,n as he}from"./index-DiWtt6s-.js";import{w as ke,o as Tt,e as It}from"./user-profile-Dve6_0lJ.js";import{A as Ot}from"./amount-BQsqQYGO.js";import{e as x,f as Dt,a as kt}from"./service-Bn7AeIKQ.js";import{D as me,j as we,x as vt,B as Nt}from"./derivation-BN6xqWKL.js";import"./index-D0E7N0oa.js";import{c as ve,p as Ne,h as Pt,b as N,s as Mt}from"./bioforest-B0k2ODEM.js";import{p as Ct,g as jt,t as Ut,E as Lt}from"./index-DRQXAVdd.js";const Pe={motion:{timeScale:1,layoutDuration:.45,uiFastDuration:.15,layoutEase:[.4,0,.1,1],spring:{stiffness:220,damping:28,mass:.85}},css:{}};function Z(e){return!Number.isFinite(e)||e<=0?1:e}function P(e,t){const n=Z(t);return e/n}function Ae(e,t,n){const s=Z(t);return e*Math.pow(s,n)}function xt(e,t){return t?{motion:{...e.motion,...t.motion,spring:{...e.motion.spring,...t.motion?.spring}},css:{...e.css,...t.css}}:e}const Se=new WeakMap,ye=new WeakMap;function Nr(e){const t=Se.get(e);if(t)return t;const{motion:n}=e,s={type:"spring",stiffness:Ae(n.spring.stiffness,n.timeScale,2),damping:Ae(n.spring.damping,n.timeScale,1),mass:n.spring.mass},i={layout:{duration:P(n.layoutDuration,n.timeScale),ease:n.layoutEase}},c={duration:P(n.uiFastDuration,n.timeScale),ease:"easeOut"},o={motionConfig:s,sharedLayout:i,uiFast:c};return Se.set(e,o),o}function Pr(e){const t=ye.get(e);if(t)return t;const{motion:n}=e,s={"--miniapp-motion-time-scale":String(Z(n.timeScale)),"--miniapp-motion-layout-duration":`${P(n.layoutDuration,n.timeScale)}s`,"--miniapp-motion-ui-fast-duration":`${P(n.uiFastDuration,n.timeScale)}s`,"--miniapp-motion-layout-ease":`cubic-bezier(${n.layoutEase.join(",")})`};return ye.set(e,s),s}const Ht={iframe:new Et,wujie:new yt};function Bt(e){return Ht[e]}async function Kt(e,t){return Bt(e).create(t)}const Mr={bio_requestAccounts:{risk:"low"},bio_selectAccount:{risk:"low"},bio_pickWallet:{risk:"low"},bio_createTransaction:{risk:"low"},bio_signMessage:{risk:"medium"},bio_signTypedData:{risk:"medium"},bio_signTransaction:{risk:"high"},bio_sendTransaction:{risk:"high"},bio_destroyAsset:{risk:"high"},bio_requestCryptoToken:{risk:"high"},bio_cryptoExecute:{risk:"low"},bio_getCryptoTokenInfo:{risk:"low"},bio_accounts:{risk:"low"},bio_chainId:{risk:"low"},bio_getBalance:{risk:"low"}},a={USER_REJECTED:4001,UNAUTHORIZED:4100,UNSUPPORTED_METHOD:4200,INTERNAL_ERROR:-32603,INVALID_PARAMS:-32602,METHOD_NOT_FOUND:-32601};function Ee(e,t,n,s){return{type:"bio_response",id:e,success:!1,error:{code:t,message:n,data:s}}}const Me="ecosystem_my_apps",Vt={teleport:"xin.dweb.teleport",forge:"xin.dweb.biobridge",biobridge:"xin.dweb.biobridge"};function I(e){return Vt[e]??e}function be(){try{const e=localStorage.getItem(Me),t=e?JSON.parse(e):[],n=t.map(s=>({...s,appId:I(s.appId)}));return JSON.stringify(t)!==JSON.stringify(n)&&Ce(n),n}catch{return[]}}function Ce(e){localStorage.setItem(Me,JSON.stringify(e))}var _e=[{name:"RWA",url:"https://iweb.xin/rwahub.bfmeta.com.miniapp/source.json"}];const K=["discover","mine"],je="ecosystem_store",Ue=()=>O.t("ecosystem:sources.defaultName");function qt(){if(!Array.isArray(_e))return[];const e=new Date().toISOString();return _e.filter(t=>!!(t?.url&&t?.name)).map(t=>({url:t.url,name:t.name,lastUpdated:e,enabled:!0,status:"idle",icon:t.icon}))}function zt(e,t){return e.length===t.length&&e.every((n,s)=>n===t[s])}function Le(){const t=[{url:"./miniapps/ecosystem.json",name:Ue(),lastUpdated:new Date().toISOString(),enabled:!0,status:"idle"}];for(const n of qt())t.some(s=>s.url===n.url)||t.push(n);return t}function Re(e){const t=Le(),n=[...e];for(const s of t)n.some(r=>r.url===s.url)||n.push(s);return n}function Wt(e){if(!Array.isArray(e))return[];const t=new Date().toISOString();return e.map(n=>{if(typeof n=="string")return{url:n,name:"Bio 官方生态",lastUpdated:t,enabled:!0,status:"idle"};if(!n||typeof n!="object")return null;const s=n;return typeof s.url!="string"||s.url.length===0?null:{url:s.url,name:typeof s.name=="string"&&s.name.length>0?s.name:Ue(),lastUpdated:typeof s.lastUpdated=="string"&&s.lastUpdated.length>0?s.lastUpdated:t,enabled:typeof s.enabled=="boolean"?s.enabled:!0,status:s.status??"idle",errorMessage:s.errorMessage,icon:s.icon}}).filter(n=>n!==null)}function $t(){try{const e=localStorage.getItem(je);if(e){const t=JSON.parse(e),n=Array.isArray(t.availableSubPages)&&t.availableSubPages.length>0?t.availableSubPages:K,s=t.activeSubPage??"discover",r=n.includes(s)?n:[...n,s],i=Wt(t.sources),c=Re(i);return{permissions:t.permissions??[],sources:c.length>0?c:Le(),myApps:be(),availableSubPages:r,activeSubPage:s,swiperProgress:0,syncSource:null}}}catch{}return{permissions:[],sources:Re([]),myApps:be(),availableSubPages:K,activeSubPage:"discover",swiperProgress:0,syncSource:null}}function Ft(e){try{localStorage.setItem(je,JSON.stringify({permissions:e.permissions,sources:e.sources,availableSubPages:e.availableSubPages,activeSubPage:e.activeSubPage})),Ce(e.myApps)}catch{}}const f=new Oe($t());f.subscribe(()=>{Ft(f.state)});const xe={getGrantedPermissions:(e,t)=>e.permissions.find(n=>n.appId===t)?.granted??[],hasPermission:(e,t,n)=>xe.getGrantedPermissions(e,t).includes(n),getEnabledSources:e=>e.sources.filter(t=>t.enabled),isAppInstalled:(e,t)=>{const n=I(t);return e.myApps.some(s=>s.appId===n)}},Jt={installApp:e=>{f.setState(t=>{const n=I(e);return t.myApps.some(s=>s.appId===n)?t:{...t,myApps:[{appId:n,installedAt:Date.now(),lastUsedAt:Date.now()},...t.myApps]}})},uninstallApp:e=>{f.setState(t=>{const n=I(e);return{...t,myApps:t.myApps.filter(s=>s.appId!==n)}})},updateAppLastUsed:e=>{f.setState(t=>{const n=I(e);return t.myApps.find(r=>r.appId===n)?{...t,myApps:t.myApps.map(r=>r.appId===n?{...r,lastUsedAt:Date.now()}:r)}:t})},grantPermissions:(e,t)=>{f.setState(n=>{const s=n.permissions.find(r=>r.appId===e);if(s){const r=[...new Set([...s.granted,...t])];return{...n,permissions:n.permissions.map(i=>i.appId===e?{...i,granted:r,grantedAt:Date.now()}:i)}}else return{...n,permissions:[...n.permissions,{appId:e,granted:t,grantedAt:Date.now()}]}})},revokePermissions:(e,t)=>{f.setState(n=>t?{...n,permissions:n.permissions.map(s=>s.appId===e?{...s,granted:s.granted.filter(r=>!t.includes(r))}:s)}:{...n,permissions:n.permissions.filter(s=>s.appId!==e)})},addSource:(e,t)=>{f.setState(n=>n.sources.some(s=>s.url===e)?n:{...n,sources:[...n.sources,{url:e,name:t,lastUpdated:new Date().toISOString(),enabled:!0,status:"idle"}]})},removeSource:e=>{f.setState(t=>({...t,sources:t.sources.filter(n=>n.url!==e)}))},toggleSource:e=>{f.setState(t=>({...t,sources:t.sources.map(n=>n.url===e?{...n,enabled:!n.enabled}:n)}))},updateSourceTimestamp:e=>{f.setState(t=>({...t,sources:t.sources.map(n=>n.url===e?{...n,lastUpdated:new Date().toISOString()}:n)}))},updateSourceStatus:(e,t,n)=>{f.setState(s=>({...s,sources:s.sources.map(r=>r.url===e?{...r,status:t,errorMessage:t==="error"?n:void 0,...t==="success"?{lastUpdated:new Date().toISOString()}:{}}:r)}))},setActiveSubPage:e=>{f.setState(t=>({...t,activeSubPage:e}))},setAvailableSubPages:e=>{f.setState(t=>{const n=e.length>0?e:K;if(zt(t.availableSubPages,n))return t;const s=n.includes(t.activeSubPage)?t.activeSubPage:n[0]??"mine";return{...t,availableSubPages:n,activeSubPage:s}})},setSwiperProgress:e=>{f.setState(t=>({...t,swiperProgress:e}))},setSyncSource:e=>{f.setState(t=>({...t,syncSource:e}))}},Gt=["bio_requestAccounts","bio_signMessage","bio_signTypedData","bio_signTransaction","bio_sendTransaction"];function Q(e){return Gt.includes(e)}function Yt(e,t){return Q(t)?xe.hasPermission(f.state,e,t):!0}function Xt(e,t){Jt.grantPermissions(e,t)}function Cr(e){const t=O.t.bind(O),s=["bio_requestAccounts","bio_accounts","bio_selectAccount","bio_pickWallet","bio_chainId","bio_getBalance","bio_createTransaction","bio_signMessage","bio_signTypedData","bio_signTransaction","bio_sendTransaction","bio_destroyAsset","bio_requestCryptoToken","bio_cryptoExecute","bio_getCryptoTokenInfo"].includes(e);return{label:s?t(`ecosystem:permissions.${e}.name`):e,description:t(s?`ecosystem:permissions.${e}.description`:"ecosystem:permissions.defaultDescription"),sensitive:Q(e)}}class Zt{handlers=new Map;iframe=null;appId="";appName="";origin="*";manifestPermissions=[];messageHandler=null;permissionRequestCallback=null;registerHandler(t,n){this.handlers.set(t,n)}setPermissionRequestCallback(t){this.permissionRequestCallback=t}attach(t,n,s,r=[]){this.detach(),this.iframe=t,this.appId=n,this.appName=s,this.manifestPermissions=r;try{const i=new URL(t.src,window.location.origin);this.origin=i.origin}catch{this.origin="*"}this.messageHandler=this.handleMessage.bind(this),window.addEventListener("message",this.messageHandler)}detach(){this.messageHandler&&(window.removeEventListener("message",this.messageHandler),this.messageHandler=null),this.iframe=null,this.appId="",this.appName="",this.manifestPermissions=[]}emit(t,...n){this.emitTo("bio",t,...n)}emitEth(t,...n){this.emitTo("eth",t,...n)}emitTron(t,...n){this.emitTo("tron",t,...n)}emitTo(t,n,...s){if(!this.iframe?.contentWindow)return;const r={type:`${t}_event`,event:n,args:s};this.iframe.contentWindow.postMessage(r,this.origin)}handleMessage(t){const n=t.data;if(!n||typeof n!="object"||!("type"in n)||!(n.type==="bio_request"||n.type==="eth_request"||n.type==="tron_request"))return;console.log("[BioBridge] Received bio message:",{origin:t.origin,expectedOrigin:this.origin,type:n.type,method:n.method});const r=this.origin.includes("localhost")&&t.origin.includes("localhost");if(!(this.origin==="*"||t.origin===this.origin||r)){console.warn("[BioBridge] Origin mismatch, ignoring message");return}if(!(t.source===this.iframe?.contentWindow||r&&t.source instanceof Window)){console.warn("[BioBridge] Source mismatch, ignoring message");return}console.log("[BioBridge] Processing message:",n.type),n.type==="bio_request"?this.processRequest(n,"bio"):n.type==="eth_request"?this.processRequest(n,"eth"):n.type==="tron_request"&&this.processRequest(n,"tron")}async processRequest(t,n){const{id:s,method:r,params:i}=t,c=this.handlers.get(r);if(!c){this.sendResponse(n,{type:`${n}_response`,id:s,success:!1,error:{code:a.METHOD_NOT_FOUND,message:`Method not found: ${r}`}});return}if(!(n!=="bio"||["bio_connect","bio_closeSplashScreen"].includes(r))){const p=["bio_accounts","bio_selectAccount","bio_pickWallet"].includes(r)&&this.manifestPermissions.includes("bio_requestAccounts"),l=p?"bio_requestAccounts":r;if(!(this.manifestPermissions.includes(r)||r==="bio_requestAccounts"||p)){this.sendResponse(n,Ee(s,a.UNAUTHORIZED,`Permission not declared in manifest: ${r}`));return}if(Q(l)&&!Yt(this.appId,l)&&!await this.requestPermission([l])){this.sendResponse(n,Ee(s,a.USER_REJECTED,"Permission denied by user"));return}}try{const p=d.state.apps.get(this.appId)?.manifest;let l=p?.icon;if(l&&!l.startsWith("http")&&!l.startsWith("data:"))try{const b=new URL(p?.url??"",window.location.origin);l=new URL(l,b).href}catch{}const h={appId:this.appId,appName:this.appName,appIcon:l,origin:this.origin,permissions:this.manifestPermissions},m=await c(i?.[0],h);this.sendResponse(n,{type:`${n}_response`,id:s,success:!0,result:m})}catch(u){const p=u instanceof Error?u.message:"Unknown error",l=u.code??a.INTERNAL_ERROR;this.sendResponse(n,{type:`${n}_response`,id:s,success:!1,error:{code:l,message:p}})}}async requestPermission(t){if(!this.permissionRequestCallback)return!1;try{const n=await this.permissionRequestCallback(this.appId,this.appName,t);return n&&Xt(this.appId,t),n}catch{return!1}}sendResponse(t,n){this.iframe?.contentWindow&&this.iframe.contentWindow.postMessage(n,this.origin)}}const g=new Zt,_=new Map,w={register(e,t){_.set(e,t)},unregister(e){_.delete(e)},get(e){return _.get(e)},has(e){return _.has(e)},getRegisteredApps(){return Array.from(_.keys())},clear(){_.clear()}},Qt=async(e,t)=>{wt(t.appId)};let He=null,Be=null;function jr(e){He=e}function Ur(e){Be=e}function ee(e){return w.get(e)?.showWalletPicker??He}function en(e){return w.get(e)?.getConnectedAccounts??Be}const tn=async(e,t)=>({connected:!0}),nn=async(e,t)=>{const n=ee(t.appId);if(!n)throw Object.assign(new Error("Wallet picker not available"),{code:a.INTERNAL_ERROR});const r=await n({chain:e?.chain,app:{name:t.appName,icon:t.appIcon}});if(!r)throw Object.assign(new Error("User rejected"),{code:a.USER_REJECTED});return[r]},sn=async(e,t)=>{const n=en(t.appId);return n?n():[]},rn=async(e,t)=>{const n=ee(t.appId);if(!n)throw Object.assign(new Error("Wallet picker not available"),{code:a.INTERNAL_ERROR});const r=await n({...e,app:{name:t.appName,icon:t.appIcon}});if(!r)throw Object.assign(new Error("User rejected"),{code:a.USER_REJECTED});return r},an=async(e,t)=>{const n=ee(t.appId);if(!n)throw Object.assign(new Error("Wallet picker not available"),{code:a.INTERNAL_ERROR});const r=await n({...e,app:{name:t.appName,icon:t.appIcon}});if(!r)throw Object.assign(new Error("User rejected"),{code:a.USER_REJECTED});return r},on=async(e,t)=>ke.state.selectedChain,cn=async(e,t)=>{const n=e;if(!n?.address||!n?.chain)throw Object.assign(new Error("Missing address or chain"),{code:a.INVALID_PARAMS});const s=X(n.chain);try{return(await s.nativeBalance.fetch({address:n.address}))?.amount.toRawString()??"0"}catch{return"0"}};let Ke=null;function Lr(e){Ke=e}function Ve(e){return w.get(e)?.showSigningDialog??Ke}const dn=async(e,t)=>{const n=e;if(!n?.message||!n?.address)throw Object.assign(new Error("Missing message or address"),{code:a.INVALID_PARAMS});const s=Ve(t.appId);if(!s)throw Object.assign(new Error("Signing dialog not available"),{code:a.INTERNAL_ERROR});const r=await s({message:n.message,address:n.address,app:{name:t.appName}});if(!r)throw Object.assign(new Error("User rejected"),{code:a.USER_REJECTED});return r},ln=async(e,t)=>{const n=e;if(!n?.data||!n?.address)throw Object.assign(new Error("Missing data or address"),{code:a.INVALID_PARAMS});const s=Ve(t.appId);if(!s)throw Object.assign(new Error("Signing dialog not available"),{code:a.INTERNAL_ERROR});const r=JSON.stringify(n.data,null,2),i=await s({message:r,address:n.address,app:{name:t.appName}});if(!i)throw Object.assign(new Error("User rejected"),{code:a.USER_REJECTED});return i};let qe=null;function xr(e){qe=e}function un(e){return w.get(e)?.showTransferDialog??qe}const pn=async(e,t)=>{const n=e;if(!n?.from||!n?.to||!n?.amount||!n?.chain)throw Object.assign(new Error("Missing required parameters: from, to, amount, chain"),{code:a.INVALID_PARAMS});const s=un(t.appId);if(!s)throw Object.assign(new Error("Transfer dialog not available"),{code:a.INTERNAL_ERROR});const r={from:n.from,to:n.to,amount:n.amount,chain:n.chain,app:{name:t.appName}};n.asset&&(r.asset=n.asset),n.tokenAddress&&(r.tokenAddress=n.tokenAddress);const i=await s(r);if(!i)throw Object.assign(new Error("User rejected"),{code:a.USER_REJECTED});return i};let gn=null;function fn(e){return w.get(e)?.showDestroyDialog??gn}const hn=async(e,t)=>{const n=e;if(!n?.from||!n?.amount||!n?.chain||!n?.asset)throw Object.assign(new Error("Missing required parameters: from, amount, chain, asset"),{code:a.INVALID_PARAMS});const s=fn(t.appId);if(!s)throw Object.assign(new Error("Destroy dialog not available"),{code:a.INTERNAL_ERROR});const r={from:n.from,amount:n.amount,chain:n.chain,asset:n.asset,app:{name:t.appName}},i=await s(r);if(!i)throw Object.assign(new Error("User rejected"),{code:a.USER_REJECTED});return i};function mn(e,t){const n=ke.state.wallets,s=t.startsWith("0x"),r=s?t.toLowerCase():t;for(const i of n)if(i.chainAddresses.find(o=>o.chain!==e?!1:s||o.address.startsWith("0x")?o.address.toLowerCase()===r:o.address===r))return i.id;return null}async function ze(e){if(x.state.snapshot||await Dt.initialize(),!x.state.snapshot)throw Object.assign(new Error("Chain configs not initialized"),{code:a.INTERNAL_ERROR});const n=kt.getChainById(x.state,e);if(!n)throw Object.assign(new Error(`Unsupported chain: ${e}`),{code:a.INVALID_PARAMS});return n}const wn=async(e,t)=>{const n=e,s=n?.type??"transfer";if(!n?.from||!n?.amount||!n?.chain)throw Object.assign(new Error("Missing required parameters: from, amount, chain"),{code:a.INVALID_PARAMS});if(s==="transfer"&&!n?.to)throw Object.assign(new Error("Missing required parameters: to"),{code:a.INVALID_PARAMS});if(s==="destroy"&&!n?.recipientId&&!n?.to)throw Object.assign(new Error("Missing required parameters: recipientId"),{code:a.INVALID_PARAMS});if(!mn(n.chain,n.from))throw Object.assign(new Error("From address is not owned by current user"),{code:a.UNAUTHORIZED});const i=await ze(n.chain),c=n.tokenAddress?.trim()||void 0,o=n.asset??i.symbol,u=c&&typeof n.assetDecimals=="number"?n.assetDecimals:i.decimals,p=Ot.parse(n.amount,u,o),l=c&&i.chainKind==="tron"?Rt(i.id):X(i.id),h=l.buildTransaction;if(!l.supportsBuildTransaction||!h)throw Object.assign(new Error(`Chain ${i.id} does not support transaction building`),{code:a.UNSUPPORTED_METHOD});const m=await h(s==="destroy"?{type:"destroy",from:n.from,recipientId:n.recipientId??n.to,amount:p,bioAssetType:n.asset??i.symbol,...n.remark?{remark:n.remark}:{}}:{type:"transfer",from:n.from,to:n.to,amount:p,tokenAddress:c,...n.asset?{bioAssetType:n.asset}:{},...n.remark?{remark:n.remark}:{}});if(c&&i.chainKind==="tron"){const L=m.data;if(!L||typeof L!="object"||!("rawTx"in L))throw Object.assign(new Error("TRC20 transaction builder not available"),{code:a.UNSUPPORTED_METHOD})}return{chainId:m.chainId,intentType:m.intentType,data:m.data}};let We=null;function Hr(e){We=e}function An(e){return w.get(e)?.showSignTransactionDialog??We}const Sn=async(e,t)=>{const n=e;if(!n?.from||!n?.chain||!n?.unsignedTx)throw Object.assign(new Error("Missing required parameters: from, chain, unsignedTx"),{code:a.INVALID_PARAMS});const s=An(t.appId);if(!s)throw Object.assign(new Error("SignTransaction dialog not available"),{code:a.INTERNAL_ERROR});const r=await s({from:n.from,chain:n.chain,unsignedTx:n.unsignedTx,app:{name:t.appName}});if(!r)throw Object.assign(new Error("User rejected"),{code:a.USER_REJECTED});return r};async function Br(e){const t=await ze(e.chainId),n=X(t.id),s=n.signTransaction;if(!n.supportsSignTransaction||!s)throw Object.assign(new Error(`Chain ${t.id} does not support transaction signing`),{code:a.UNSUPPORTED_METHOD});const r=await(await E(async()=>{const{walletStorageService:o}=await import("./web-66kZx7dJ.js").then(u=>u.i);return{walletStorageService:o}},__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11]),import.meta.url)).walletStorageService.getMnemonic(e.walletId,e.password);let i;if(t.chainKind==="evm"){const o=me(r,"ethereum",0,0);if(o.address.toLowerCase()!==e.from.toLowerCase())throw Object.assign(new Error("Signing address mismatch"),{code:a.INVALID_PARAMS});i=we(o.privateKey)}else if(t.chainKind==="bioforest"){const o=ve(r);if(Ne(o.publicKey,t.prefix??"b")!==e.from)throw Object.assign(new Error("Signing address mismatch"),{code:a.INVALID_PARAMS});i=o.secretKey}else if(t.chainKind==="tron"){const o=me(r,"tron",0,0),u=he(e.from),p=he(o.address);if(u!==p)throw Object.assign(new Error("Signing address mismatch"),{code:a.INVALID_PARAMS});i=we(o.privateKey)}else throw Object.assign(new Error(`Unsupported chain kind: ${t.chainKind}`),{code:a.UNSUPPORTED_METHOD});const c=await s({chainId:e.unsignedTx.chainId,intentType:e.unsignedTx.intentType??"transfer",data:e.unsignedTx.data},t.chainKind==="bioforest"?{bioSecret:r,privateKey:i}:{privateKey:i});return{chainId:c.chainId,data:c.data,signature:c.signature}}const $e=new Map,Fe=new Map;let Je=null,V=null,Ge=null,Ye=null;function Kr(e){Je=e}function Vr(e){V=e}function qr(e){Ge=e}function zr(e){Ye=e}function yn(e){return w.get(e)?.showEvmWalletPicker??Je}function Xe(e){return w.get(e)?.showEvmSigningDialog??Ge}function En(e){return w.get(e)?.showEvmTransactionDialog??Ye}function v(e){return $e.get(e)??Ut(Lt.binance)}function bn(e,t){$e.set(e,t)}function _n(e){return Fe.get(e)??[]}function Rn(e,t){Fe.set(e,t)}const Tn=async(e,t)=>v(t.appId),In=async(e,t)=>{const n=yn(t.appId);if(!n)throw Object.assign(new Error("Wallet picker not available"),{code:a.INTERNAL_ERROR});const s=v(t.appId),r=await n({chainId:s,app:{name:t.appName,icon:t.appIcon}});if(!r)throw Object.assign(new Error("User rejected"),{code:a.USER_REJECTED});const i=[r.address];return Rn(t.appId,i),i},On=async(e,t)=>_n(t.appId),Dn=async(e,t)=>{const n=e;if(!n?.chainId)throw Object.assign(new Error("Missing chainId"),{code:a.INVALID_PARAMS});const s=n.chainId;if(!jt(s))throw Object.assign(new Error(`Chain ${s} not supported`),{code:4902});const i=v(t.appId);if(i===s)return null;if(V&&!await V({fromChainId:i,toChainId:s,appName:t.appName,appIcon:t.appIcon}))throw Object.assign(new Error("User rejected"),{code:a.USER_REJECTED});return bn(t.appId,s),null},kn=async(e,t)=>{throw Object.assign(new Error("Adding custom chains is not supported"),{code:a.UNSUPPORTED_METHOD})},Ze=async(e,t)=>{const[n,s]=e;if(!n||!s)throw Object.assign(new Error("Missing message or address"),{code:a.INVALID_PARAMS});const r=Xe(t.appId);if(!r)throw Object.assign(new Error("Signing dialog not available"),{code:a.INTERNAL_ERROR});const i=await r({message:n,address:s,appName:t.appName});if(!i)throw Object.assign(new Error("User rejected"),{code:a.USER_REJECTED});return i.signature},vn=async(e,t)=>{const[n,s]=e;return Ze([s,n],t)},Nn=async(e,t)=>{const[n,s]=e;if(!n||!s)throw Object.assign(new Error("Missing address or typedData"),{code:a.INVALID_PARAMS});const r=typeof s=="string"?JSON.parse(s):s,i=Xe(t.appId);if(!i)throw Object.assign(new Error("Signing dialog not available"),{code:a.INTERNAL_ERROR});const c=JSON.stringify(r,null,2),o=await i({message:c,address:n,appName:t.appName});if(!o)throw Object.assign(new Error("User rejected"),{code:a.USER_REJECTED});return o.signature},Pn=async(e,t)=>{const n=e;if(!n?.from)throw Object.assign(new Error("Missing transaction data"),{code:a.INVALID_PARAMS});const s=En(t.appId);if(!s)throw Object.assign(new Error("Transaction dialog not available"),{code:a.INTERNAL_ERROR});n.chainId||(n.chainId=v(t.appId));const r=await s({tx:n,appName:t.appName});if(!r)throw Object.assign(new Error("User rejected"),{code:a.USER_REJECTED});return r.txHash},Mn=async(e,t)=>{throw e?.from?Object.assign(new Error("eth_signTransaction not yet supported, use eth_sendTransaction"),{code:a.UNSUPPORTED_METHOD}):Object.assign(new Error("Missing transaction data"),{code:a.INVALID_PARAMS})},Cn=async(e,t)=>{const[n]=e;if(!n)throw Object.assign(new Error("Missing address"),{code:a.INVALID_PARAMS});return"0x0"},jn=async(e,t)=>{const n=v(t.appId),s=Ct(n);return String(s)},Un=async(e,t)=>"0x0",Ln=async(e,t)=>"KeyApp/1.0.0",xn={eth_chainId:Tn,eth_requestAccounts:In,eth_accounts:On,wallet_switchEthereumChain:Dn,wallet_addEthereumChain:kn,personal_sign:Ze,eth_sign:vn,eth_signTypedData_v4:Nn,eth_sendTransaction:Pn,eth_signTransaction:Mn,eth_getBalance:Cn,net_version:jn,eth_blockNumber:Un,web3_clientVersion:Ln};function Hn(e){for(const[t,n]of Object.entries(xn))e(t,n)}const Qe=new Map;let et=null,Bn=null;function Wr(e){et=e}function Kn(e){return w.get(e)?.showTronWalletPicker??et}function Vn(e){return w.get(e)?.showTronSigningDialog??Bn}function tt(e){return Qe.get(e)??null}function qn(e,t){Qe.set(e,t)}function zn(e){return{base58:e.address,hex:e.address}}const Wn=async(e,t)=>{const n=Kn(t.appId);if(!n)throw Object.assign(new Error("Wallet picker not available"),{code:a.INTERNAL_ERROR});const s=await n({app:{name:t.appName,icon:t.appIcon}});if(!s)throw Object.assign(new Error("User rejected"),{code:a.USER_REJECTED});const r=zn(s);return qn(t.appId,r),{code:200,message:"ok",data:r}},$n=async(e,t)=>{const n=tt(t.appId);return n?{code:200,message:"ok",data:n}:{code:4e3,message:"Not connected",data:null}},Fn=async(e,t)=>tt(t.appId),Jn=async(e,t)=>{const n=e;if(!n?.txID)throw Object.assign(new Error("Invalid transaction"),{code:a.INVALID_PARAMS});const s=Vn(t.appId);if(!s)throw Object.assign(new Error("Signing dialog not available"),{code:a.INTERNAL_ERROR});const r=await s({transaction:n,appName:t.appName});if(!r)throw Object.assign(new Error("User rejected"),{code:a.USER_REJECTED});return r.signedTransaction},Gn=async(e,t)=>{const n=e;if(!n?.txID||!n.signature)throw Object.assign(new Error("Invalid signed transaction"),{code:a.INVALID_PARAMS});return{result:!0,txid:n.txID}},Yn=async(e,t)=>{if(!e)throw Object.assign(new Error("Missing address"),{code:a.INVALID_PARAMS});return 0},Xn=async(e,t)=>{const n=e;if(!n)throw Object.assign(new Error("Missing address"),{code:a.INVALID_PARAMS});return{address:n,balance:0}},Zn={tron_requestAccounts:Wn,tron_accounts:$n,tron_getDefaultAddress:Fn,tron_signTransaction:Jn,tron_sendRawTransaction:Gn,tron_getBalance:Yn,tron_getAccount:Xn};function Qn(e){for(const[t,n]of Object.entries(Zn))e(t,n)}const es="crypto-box-db",ts=2,A="tokens";class ns{db=null;initialized=!1;async initialize(){this.initialized||(this.db=await Tt(es,ts,{upgrade(t,n){t.objectStoreNames.contains(A)&&t.deleteObjectStore(A);const s=t.createObjectStore(A,{keyPath:"tokenId"});s.createIndex("by-miniapp","miniappId"),s.createIndex("by-wallet","walletId"),s.createIndex("by-expires","expiresAt")}}),this.initialized=!0,await this.cleanupExpired())}ensureInitialized(){if(!this.initialized||!this.db)throw new Error("TokenStore not initialized")}generateTokenId(){return crypto.randomUUID()}async sha256(t){const s=new TextEncoder().encode(t),r=await crypto.subtle.digest("SHA-256",s);return Array.from(new Uint8Array(r)).map(c=>c.toString(16).padStart(2,"0")).join("")}async deriveSessionSecret(t,n,s,r){return this.sha256(`${t}:${n}:${s}:${r}`)}async createToken(t){this.ensureInitialized();const{TOKEN_DURATION_MS:n}=await E(async()=>{const{TOKEN_DURATION_MS:m}=await Promise.resolve().then(()=>q);return{TOKEN_DURATION_MS:m}},void 0,import.meta.url),s=Date.now(),r=this.generateTokenId(),i=s+n[t.duration],c=await this.deriveSessionSecret(t.walletId,t.patternKey,t.miniappId,r),o={patternKey:t.patternKey,miniappId:t.miniappId,walletId:t.walletId,address:t.address,actions:t.actions,expiresAt:i},u=JSON.stringify(await vt(JSON.stringify(o),c)),p={tokenId:r,miniappId:t.miniappId,walletId:t.walletId,address:t.address,actions:t.actions,expiresAt:i,createdAt:s,encryptedPayload:u};await this.db.put(A,p);const{encryptedPayload:l,...h}=p;return{token:h,sessionSecret:c}}async decryptPayload(t,n){try{const s=JSON.parse(t.encryptedPayload),r=await Nt(s,n);return JSON.parse(r)}catch{return null}}async getToken(t){return this.ensureInitialized(),await this.db.get(A,t)??null}async deleteToken(t){this.ensureInitialized(),await this.db.delete(A,t)}async validateToken(t,n,s,r){this.ensureInitialized();const i=await this.getToken(t);if(!i)return{valid:!1,error:"TOKEN_NOT_FOUND"};const c=await this.decryptPayload(i,n);return c?c.miniappId!==s?{valid:!1,error:"MINIAPP_MISMATCH"}:Date.now()>c.expiresAt?(await this.deleteToken(t),{valid:!1,error:"TOKEN_EXPIRED"}):c.actions.includes(r)?{valid:!0,token:i,payload:c}:{valid:!1,error:"ACTION_NOT_PERMITTED"}:{valid:!1,error:"INVALID_SESSION_SECRET"}}async getTokenInfo(t,n,s){this.ensureInitialized();const r=await this.getToken(t);if(!r)return{valid:!1,address:"",expiresAt:0,actions:[],invalidReason:"TOKEN_NOT_FOUND"};const i=await this.decryptPayload(r,n);return i?i.miniappId!==s?{valid:!1,address:"",expiresAt:0,actions:[],invalidReason:"MINIAPP_MISMATCH"}:Date.now()>i.expiresAt?(await this.deleteToken(t),{valid:!1,address:i.address,expiresAt:i.expiresAt,actions:i.actions,invalidReason:"TOKEN_EXPIRED"}):{valid:!0,address:i.address,expiresAt:i.expiresAt,actions:i.actions}:{valid:!1,address:"",expiresAt:0,actions:[],invalidReason:"INVALID_SESSION_SECRET"}}async cleanupExpired(){this.ensureInitialized();const t=Date.now(),n=this.db.transaction(A,"readwrite"),s=n.store.index("by-expires");let r=0,i=await s.openCursor(IDBKeyRange.upperBound(t));for(;i;)await i.delete(),r++,i=await i.continue();return await n.done,r}async getTokensByMiniapp(t){this.ensureInitialized();const n=Date.now();return(await this.db.getAllFromIndex(A,"by-miniapp",t)).filter(r=>r.expiresAt>n).map(({encryptedPayload:r,...i})=>i)}close(){this.db&&(this.db.close(),this.db=null,this.initialized=!1)}}const T=new ns;class ss{async execute(t,n){const s=await T.validateToken(t.tokenId,t.sessionSecret,n,t.action);if(!s.valid){const{CryptoBoxErrorCodes:o}=await E(async()=>{const{CryptoBoxErrorCodes:p}=await Promise.resolve().then(()=>q);return{CryptoBoxErrorCodes:p}},void 0,import.meta.url),u={TOKEN_NOT_FOUND:o.TOKEN_NOT_FOUND,MINIAPP_MISMATCH:o.MINIAPP_MISMATCH,TOKEN_EXPIRED:o.TOKEN_EXPIRED,ACTION_NOT_PERMITTED:o.ACTION_NOT_PERMITTED,INVALID_SESSION_SECRET:o.INVALID_SESSION_SECRET,ADDRESS_MISMATCH:o.ADDRESS_MISMATCH};throw Object.assign(new Error(`Token validation failed: ${s.error}`),{code:u[s.error]})}const{payload:r}=s;if(t.address&&t.address!==r.address){const{CryptoBoxErrorCodes:o}=await E(async()=>{const{CryptoBoxErrorCodes:u}=await Promise.resolve().then(()=>q);return{CryptoBoxErrorCodes:u}},void 0,import.meta.url);throw Object.assign(new Error(`Address mismatch: requested ${t.address} but token is for ${r.address}`),{code:o.ADDRESS_MISMATCH})}const i=await this.getKeypairForWallet(r.walletId,r.address,r.patternKey);let c;switch(t.action){case"asymmetricEncrypt":c=await this.executeAsymmetricEncrypt(t.params,i);break;case"sign":c=await this.executeSign(t.params,i);break;default:throw new Error(`Unknown action: ${t.action}`)}return{...c,address:r.address}}async getKeypairForWallet(t,n,s){try{const r=await It.getMnemonic(t,s),i=ve(r),c=n.charAt(0);if(Ne(i.publicKey,c)!==n)throw new Error(`Address mismatch: token address ${n} does not match wallet`);return i}catch(r){throw r instanceof Error&&r.message.includes("Address mismatch")?r:new Error(`Failed to get keypair for wallet ${t}: invalid patternKey or wallet not found`)}}normalizePublicKey(t){if(typeof t=="string")return t;if(t&&typeof t=="object"&&"type"in t&&"data"in t){const n=t;if(n.type==="Buffer"&&Array.isArray(n.data))return n.data.map(s=>s.toString(16).padStart(2,"0")).join("")}if(Array.isArray(t)||t instanceof Uint8Array)return Array.from(t).map(n=>n.toString(16).padStart(2,"0")).join("");throw new Error(`Invalid publicKey format: ${typeof t}`)}async executeAsymmetricEncrypt(t,n){const s=Pt(this.normalizePublicKey(t.recipientPublicKey)),r=new TextEncoder().encode(t.data),i=await E(()=>import("./nacl-fast-CqfJ7qrS.js").then(h=>h.n),__vite__mapDeps([12,5,2,6,13]),import.meta.url),c=await E(()=>import("./ed2curve-BV7H09ER.js").then(h=>h.e),__vite__mapDeps([14,5,2,6,13]),import.meta.url),o=c.convertPublicKey(s),u=c.convertSecretKey(n.secretKey);if(!o||!u)throw new Error("Failed to convert Ed25519 keys to X25519");const p=new Uint8Array(24),l=i.box(r,p,o,u);return{result:N(l),publicKey:N(n.publicKey)}}async executeSign(t,n){const s=new TextEncoder().encode(t.data),r=Mt(s,n.secretKey);return{result:N(r),publicKey:N(n.publicKey)}}}const rs=new ss,is={"5min":300*1e3,"30min":1800*1e3,"2hour":7200*1e3,"1day":1440*60*1e3},as=["5min","30min","2hour","1day"],S={TOKEN_NOT_FOUND:4100,MINIAPP_MISMATCH:4101,TOKEN_EXPIRED:4102,ACTION_NOT_PERMITTED:4103,INVALID_SESSION_SECRET:4104,ADDRESS_MISMATCH:4105,USER_REJECTED:4001,INTERNAL_ERROR:-32603},os={asymmetricEncrypt:{name:"非对称加密",description:"使用您的私钥进行非对称加密"},sign:{name:"数据签名",description:"使用您的私钥进行签名"}},cs={"5min":"5 分钟","30min":"30 分钟","2hour":"2 小时","1day":"1 天"},q=Object.freeze(Object.defineProperty({__proto__:null,CRYPTO_ACTION_LABELS:os,CryptoBoxErrorCodes:S,TOKEN_DURATION_LABELS:cs,TOKEN_DURATION_MS:is,TOKEN_DURATION_OPTIONS:as},Symbol.toStringTag,{value:"Module"}));let z=null;function $r(e){z=e}const ds=async(e,t)=>{const n=e;if(!n?.actions||!n?.duration||!n?.address)throw Object.assign(new Error("Missing required parameters: actions, duration, address"),{code:S.INTERNAL_ERROR});const s=["asymmetricEncrypt","sign"];for(const l of n.actions)if(!s.includes(l))throw Object.assign(new Error(`Invalid action: ${l}`),{code:S.INTERNAL_ERROR});if(!z)throw Object.assign(new Error("Crypto authorize dialog not available"),{code:S.INTERNAL_ERROR});const r=z(t.appId);if(!r)throw Object.assign(new Error("Crypto authorize dialog not available"),{code:S.INTERNAL_ERROR});const i=await r({actions:n.actions,duration:n.duration,address:n.address,chainId:n.chainId,app:{name:t.appName,icon:t.appIcon}});if(!i.approved||!i.patternKey||!i.walletId)throw Object.assign(new Error("User rejected"),{code:S.USER_REJECTED});const c=i.selectedDuration||n.duration;await T.initialize();const{token:o,sessionSecret:u}=await T.createToken({miniappId:t.appId,walletId:i.walletId,address:n.address,actions:n.actions,duration:c,patternKey:i.patternKey});return{tokenId:o.tokenId,sessionSecret:u,expiresAt:o.expiresAt,grantedActions:o.actions,address:o.address}},ls=async(e,t)=>{const n=e;if(!n?.tokenId||!n?.sessionSecret||!n?.action||!n?.params)throw Object.assign(new Error("Missing required parameters: tokenId, sessionSecret, action, params"),{code:S.INTERNAL_ERROR});return await T.initialize(),await rs.execute(n,t.appId)},us=async(e,t)=>{const n=e;if(!n?.tokenId||!n?.sessionSecret)throw Object.assign(new Error("Missing required parameters: tokenId, sessionSecret"),{code:S.INTERNAL_ERROR});await T.initialize();const s=await T.getTokenInfo(n.tokenId,n.sessionSecret,t.appId);return{valid:s.valid,address:s.address,expiresAt:s.expiresAt,actions:s.actions,invalidReason:s.invalidReason}};let Te=!1;function ps(){Te||(Te=!0,g.registerHandler("bio_connect",tn),g.registerHandler("bio_closeSplashScreen",Qt),g.registerHandler("bio_requestAccounts",nn),g.registerHandler("bio_accounts",sn),g.registerHandler("bio_selectAccount",rn),g.registerHandler("bio_pickWallet",an),g.registerHandler("bio_chainId",on),g.registerHandler("bio_getBalance",cn),g.registerHandler("bio_signMessage",dn),g.registerHandler("bio_signTypedData",ln),g.registerHandler("bio_createTransaction",wn),g.registerHandler("bio_signTransaction",Sn),g.registerHandler("bio_sendTransaction",pn),g.registerHandler("bio_destroyAsset",hn),g.registerHandler("bio_requestCryptoToken",ds),g.registerHandler("bio_cryptoExecute",ls),g.registerHandler("bio_getCryptoTokenInfo",us),Hn((e,t)=>g.registerHandler(e,t)),Qn((e,t)=>g.registerHandler(e,t)))}ps();function te(){return g}const ne=new Map,W=new Set;function $(e,t){const n=`${e}:${t}`;return ne.get(n)??null}function nt(e){return W.add(e),()=>W.delete(e)}function st(){W.forEach(e=>e())}const se=new Map,re=new Map,ie=new Map,ae=new Map;let rt=null,it=null;const oe=new Map,ce=new Map,D=new Map;function gs(e,t){se.set(e,t)}function fs(e,t){re.set(e,t)}function hs(e){se.delete(e),re.delete(e)}function de(e){return se.get(e)??null}function ms(e){return re.get(e)??null}function ws(e,t){ie.set(e,t)}function As(e){ie.delete(e)}function Ss(e){return ie.get(e)??null}function ys(e,t){ae.set(e,t)}function Es(e){ae.delete(e)}function bs(e){return ae.get(e)??null}function _s(e){rt=e}function Rs(){return rt}function Ts(e){it=e}function Is(){return it}function at(e,t){oe.set(e,t)}function ot(e){oe.delete(e)}function le(e){return oe.get(e)??null}function ct(e){const t=le(e);if(!t)return null;const n=t.closest(".swiper-slide");if(n&&!n.classList.contains("swiper-slide-active"))return null;const s=t.getBoundingClientRect();return s.width<=0||s.height<=0?null:s}function Os(e,t){ce.set(e,t)}function Ds(e){ce.delete(e)}function ks(e){return ce.get(e)??null}function vs(e,t,n){const s=D.get(e)??new Map;s.set(t,n),D.set(e,s);const r=`${e}:${t}`;ne.set(r,"ready"),st()}function Ns(e,t){const n=D.get(e);if(!n)return;n.delete(t),n.size===0&&D.delete(e);const s=`${e}:${t}`;ne.set(s,"lost"),st()}function dt(e,t){return D.get(e)?.get(t)??null}function lt(e,t){const n=dt(e,t);if(!n)return null;const s=n.closest(".swiper-slide");if(s&&!s.classList.contains("swiper-slide-active"))return null;const r=n.getBoundingClientRect();return r.width<=0||r.height<=0?null:r}function Ps(e){at("stack",e)}function Ms(){ot("stack")}function Cs(){return le("stack")}function js(){return ct("stack")}async function Us(){return E(()=>Promise.resolve().then(()=>Ar),void 0,import.meta.url)}function Ls(){De.useEffect(()=>{Us().then(({miniappRuntimeStore:e,activateApp:t})=>{const{activeAppId:n}=e.state;n&&t(n)})})}function xs(e,t){return De.useSyncExternalStore(nt,()=>$(e,t),()=>$(e,t))}const H=O.t.bind(O),Hs={apps:new Map,visualConfig:Pe,activeAppId:null,focusedAppId:null,presentations:new Map,zOrderSeed:1,isStackViewOpen:!1,maxBackgroundApps:4};function ut(e){const t=d.state.apps.get(e);if(!t)return;const n=t.containerHandle?.getIframe()??t.iframeRef;n&&te().attach(n,e,t.manifest.name,t.manifest.permissions??[])}function Bs(e,t,n){const s=t.getIframe();s&&(te().attach(s,e,n.name,n.permissions??[]),Vs(s))}function Ks(){const e=document.createElement("div");e.style.cssText="position:fixed;top:env(safe-area-inset-top,0px);visibility:hidden;",document.body.appendChild(e);const t=e.offsetTop;return document.body.removeChild(e),Math.max(t,8)+32+8}function Vs(e){const t=Ks(),s={type:"keyapp:context-update",payload:{theme:{colorMode:document.documentElement.classList.contains("dark")?"dark":"light"},env:{platform:"web",safeAreaInsets:{top:t,bottom:0,left:0,right:0}}}};e.contentWindow?.postMessage(s,"*")}const d=new Oe(Hs);function pt(e){d.setState(t=>({...t,visualConfig:xt(t.visualConfig,e)}))}function qs(e){pt({motion:{timeScale:e}})}function zs(){d.setState(e=>({...e,visualConfig:Pe}))}const F=new Set;function y(e){F.forEach(t=>t(e))}let Ie=0;function gt(e,t){return Ie+=1,{id:`${e}:${t}:${Date.now()}:${Ie}`,kind:e,status:"requested",startedAt:Date.now()}}function Ws(e){const t=e.splashScreen;return t?typeof t=="object"&&typeof t.timeout=="number"?t.timeout:5e3:null}function $s(e,t){if(!e||e==="preparing"){if(t==="launching")return"opening";if(t==="splash")return"splash";if(t==="active")return"opened"}return e==="launching"&&t==="splash"?"splash":(e==="launching"||e==="splash")&&t==="active"?"opened":e==="active"&&t==="background"?"backgrounding":e==="background"&&t==="active"?"foregrounding":t==="closing"?"closing":t==="preparing"?"closed":t==="launching"?"opening":t==="splash"?"splash":t==="active"?"opened":t==="background"?"backgrounded":"closed"}function k(e,t){d.setState(n=>{const s=n.apps.get(e);if(!s)return n;const r=$s(s.state,t),i=new Map(n.apps);return i.set(e,{...s,state:t,flow:r}),{...n,apps:i}}),y({type:"app:state-change",appId:e,state:t})}function Fs(e,t){d.setState(n=>{const s=n.apps.get(e);if(!s||s.processStatus===t)return n;const r=new Map(n.apps);return r.set(e,{...s,processStatus:t}),{...n,apps:r}})}function Js(e,t){d.setState(n=>{const s=n.apps.get(e);if(!s||s.readiness===t)return n;const r=new Map(n.apps);return r.set(e,{...s,readiness:t}),{...n,apps:r}})}function ft(e){Js(e,"ready");const t=d.state.apps.get(e);t&&!t.manifest.splashScreen&&(t.state==="launching"||t.state==="splash")&&U(e)}function Gs(e){switch(e){case"opening":return"opened";case"backgrounding":return"backgrounded";case"foregrounding":return"opened";default:return e}}function Ys(e){d.setState(t=>{const n=t.apps.get(e);if(!n)return t;const s=Gs(n.flow);if(s===n.flow)return t;const r=new Map(t.apps);return r.set(e,{...n,flow:s}),{...t,apps:r}})}const Xs={launchToSplash:100},M=new Map,J=new Map,G=new Map,Zs=3e4,Qs=2500,Y=new Map;function R(e){const t=Y.get(e);t&&(t.cancelled=!0,t.rafId!==null&&cancelAnimationFrame(t.rafId),Y.delete(e))}function er(e){if(!e)return!1;const t=e.getBoundingClientRect();return t.width>0&&t.height>0}function tr(e){return e.containerHandle?.isConnected()??!1}function C(e){const t=J.get(e);t&&(clearTimeout(t),J.delete(e))}function ue(e,t,n){d.setState(s=>{const i=s.presentations.get(e)??{appId:e,desktop:t,state:"hidden",zOrder:s.zOrderSeed,transitionId:null,transitionKind:null},c={...i,...n,appId:e,desktop:n.desktop??i.desktop},o=new Map(s.presentations);return o.set(e,c),{...s,presentations:o}})}function ht(e){d.setState(t=>{const n=t.presentations.get(e),s=t.zOrderSeed+1,r=new Map(t.presentations);return n&&r.set(e,{...n,zOrder:s}),{...t,activeAppId:e,focusedAppId:e,presentations:r,zOrderSeed:s}})}function nr(e,t){const n=d.state.presentations.get(e);n&&(n.transitionKind!=="present"||n.transitionId!==t||ue(e,n.desktop,{state:"presented",transitionId:null,transitionKind:null}))}function sr(e,t){const n=d.state.presentations.get(e);n&&(n.transitionKind!=="dismiss"||n.transitionId!==t||j(e))}function pe(e){C(e),ft(e),U(e)}function B(e,t){R(e);const n=d.state.apps.get(e);n?.containerHandle&&n.containerHandle.destroy(),d.setState(s=>{const r=new Map(s.apps);r.delete(e);const i=new Map(s.presentations);return i.delete(e),{...s,apps:r,presentations:i,activeAppId:s.activeAppId===e?null:s.activeAppId,focusedAppId:s.focusedAppId===e?null:s.focusedAppId}}),_t.show({message:t,duration:2e3})}function rr(e,t){if(k(e,"launching"),ge(e),t){const n=setTimeout(()=>{const s=d.state.apps.get(e);if(!s||s.state!=="launching")return;k(e,"splash"),C(e);const r=Ws(s.manifest);r!==null&&J.set(e,setTimeout(()=>{const i=d.state.apps.get(e);i&&i.state==="splash"&&pe(e)},r))},Xs.launchToSplash);M.set(e,[n]);return}M.set(e,[])}function ir(e,t,n){R(e);const s={cancelled:!1,rafId:null};Y.set(e,s);const r=performance.now(),i=()=>{if(s.cancelled)return;const c=d.state.apps.get(e);if(!c||c.state!=="preparing"){R(e);return}const o=er(de(e)),u=!!lt(t,e),p=tr(c);if(o&&u&&p){R(e),rr(e,n);return}if(performance.now()-r>Qs){u?o?B(e,H("error:miniapp.launchFailed.containerNotReady")):B(e,H("error:miniapp.launchFailed.iconNotReady")):B(e,H("error:miniapp.launchFailed.stayOnDesktop"));return}s.rafId=requestAnimationFrame(i)};s.rafId=requestAnimationFrame(i)}function ge(e){const t=M.get(e);t&&(t.forEach(n=>clearTimeout(n)),M.delete(e))}function mt(e){const t=G.get(e);t&&(clearTimeout(t),G.delete(e))}function j(e){ge(e),mt(e),C(e),R(e),d.setState(t=>{const n=t.apps.get(e);if(!n)return t;n.containerHandle&&n.containerHandle.destroy();const s=new Map(t.apps);s.delete(e);const r=new Map(t.presentations);return r.delete(e),{...t,apps:s,presentations:r,activeAppId:t.activeAppId===e?null:t.activeAppId,focusedAppId:t.focusedAppId===e?null:t.focusedAppId}}),d.state.apps.size===0&&te().detach()}function wt(e){pe(e)}function At(e,t,n){const r=d.state.apps.get(e);if(r){ut(e);const l=r.manifest.targetDesktop??"stack";return ue(e,l,{state:"presented",transitionId:null,transitionKind:null}),ht(e),U(e),r}const i=!!t.splashScreen,c=t.runtime??"iframe",o={appId:e,manifest:t,state:"preparing",flow:"closed",ctx:{capsuleTheme:t.capsuleTheme??"auto"},processStatus:"loading",readiness:"notReady",launchedAt:Date.now(),lastActiveAt:Date.now(),containerType:c,containerHandle:null,iframeRef:null,iconRef:de(e)};Kt(c,{appId:e,url:t.url,mountTarget:document.body,contextParams:n,wujieConfig:t.wujieConfig,onLoad:()=>{Fs(e,"loaded"),t.splashScreen||ft(e)}}).then(l=>{o.containerHandle=l,l.type==="iframe"&&(o.iframeRef=l.element),Bs(e,l,t)});const u=t.targetDesktop??"stack",p=gt("present",e);return d.setState(l=>{const h=l.zOrderSeed+1,m=new Map(l.apps);m.set(e,o);const b=new Map(l.presentations);return b.set(e,{appId:e,desktop:u,state:"presenting",zOrder:h,transitionId:p.id,transitionKind:"present"}),{...l,apps:m,presentations:b,activeAppId:e,focusedAppId:e,zOrderSeed:h}}),y({type:"app:launch",appId:e,manifest:t}),ir(e,u,i),o}function ar(e,t,n){return At(e,t,n)}function U(e){const t=d.state,n=t.apps.get(e);n&&n.state!=="preparing"&&(t.activeAppId&&t.activeAppId!==e&&St(t.activeAppId),n.containerHandle&&n.state==="background"&&n.containerHandle.moveToForeground(),k(e,"active"),ut(e),d.setState(s=>{const r=new Map(s.apps),i=r.get(e);return i&&r.set(e,{...i,lastActiveAt:Date.now()}),{...s,apps:r,activeAppId:e,focusedAppId:e}}),y({type:"app:activate",appId:e}))}function St(e){const t=d.state,n=t.apps.get(e);n&&n.state!=="preparing"&&(n.containerHandle&&n.containerHandle.moveToBackground(),k(e,"background"),or(t.maxBackgroundApps),y({type:"app:deactivate",appId:e}))}function or(e){const t=d.state,n=Array.from(t.apps.values()).filter(s=>s.appId!==t.activeAppId&&s.state==="background").toSorted((s,r)=>s.lastActiveAt-r.lastActiveAt);for(;n.length>e;){const s=n.shift();s?.containerHandle&&(s.containerHandle.destroy(),s.containerHandle=null)}}function fe(e){const n=d.state.apps.get(e);if(!n)return;ge(e),mt(e),R(e),k(e,"closing"),C(e);const s=n.manifest.targetDesktop??"stack",r=gt("dismiss",e);ue(e,s,{state:"dismissing",transitionId:r.id,transitionKind:"dismiss"}),G.set(e,setTimeout(()=>{const i=d.state.presentations.get(e);i&&(i.transitionKind!=="dismiss"||i.transitionId!==r.id||j(e))},Zs)),y({type:"app:close",appId:e})}function cr(e){fe(e)}function dr(e,t){const s=d.state.apps.get(e);if(!s)return;const r={...s.ctx,...t};d.setState(i=>{const c=new Map(i.apps),o=c.get(e);return o&&c.set(e,{...o,ctx:r}),{...i,apps:c}}),y({type:"app:ctx-change",appId:e,ctx:r})}function lr(){d.state.apps.forEach((t,n)=>{fe(n),j(n)}),bt()}function ur(){d.setState(e=>({...e,isStackViewOpen:!0})),y({type:"stack-view:open"})}function pr(){d.setState(e=>({...e,isStackViewOpen:!1})),y({type:"stack-view:close"})}function gr(e){return F.add(e),()=>F.delete(e)}function fr(){return Array.from(d.state.apps.values())}function hr(){const e=d.state;return e.activeAppId?e.apps.get(e.activeAppId)??null:null}function mr(){return d.state.apps.size>0}const wr={getApps:e=>Array.from(e.apps.values()),getVisualConfig:e=>e.visualConfig,getActiveApp:e=>e.activeAppId?e.apps.get(e.activeAppId)??null:null,getFocusedAppId:e=>e.focusedAppId??e.activeAppId,getFocusedApp:e=>{const t=e.focusedAppId??e.activeAppId;return t?e.apps.get(t)??null:null},getPresentations:e=>Array.from(e.presentations.values()).sort((t,n)=>t.zOrder-n.zOrder),getPresentation:(e,t)=>e.presentations.get(t)??null,hasPresentations:e=>e.presentations.size>0,hasRunningApps:e=>e.apps.size>0,hasRunningStackApps:e=>Array.from(e.apps.values()).some(t=>(t.manifest.targetDesktop??"stack")==="stack"),isStackViewOpen:e=>e.isStackViewOpen,getBackgroundApps:e=>Array.from(e.apps.values()).filter(t=>t.state==="background"),isLaunchOverlayVisible:e=>{const t=e.focusedAppId??e.activeAppId?e.apps.get(e.focusedAppId??e.activeAppId):null;return t?.state==="launching"||t?.state==="splash"},isShowingSplash:e=>(e.focusedAppId??e.activeAppId?e.apps.get(e.focusedAppId??e.activeAppId):null)?.state==="splash",isAnimating:e=>{const t=e.focusedAppId??e.activeAppId?e.apps.get(e.focusedAppId??e.activeAppId):null;return t?.state==="launching"||t?.state==="splash"||t?.state==="closing"}},Ar=Object.freeze(Object.defineProperty({__proto__:null,activateApp:U,closeAllApps:lr,closeApp:fe,closeStackView:pr,deactivateApp:St,didDismiss:sr,didPresent:nr,dismissSplash:wt,finalizeCloseApp:j,getActiveApp:hr,getDesktopAppSlotRect:lt,getDesktopAppSlotRef:dt,getDesktopContainerRef:le,getDesktopGridHostRef:ks,getDesktopRect:ct,getIconInnerRef:ms,getIconRef:de,getRunningApps:fr,getSlotStatus:$,getSplashBgRef:Ss,getSplashIconRef:bs,getStackContainerRef:Cs,getStackRect:js,getWindowInnerRef:Is,getWindowRef:Rs,hasRunningApps:mr,launchApp:At,miniappRuntimeSelectors:wr,miniappRuntimeStore:d,openStackView:ur,registerDesktopAppSlotRef:vs,registerDesktopContainerRef:at,registerDesktopGridHostRef:Os,registerIconInnerRef:fs,registerIconRef:gs,registerSplashBgRef:ws,registerSplashIconRef:ys,registerStackContainerRef:Ps,registerWindowInnerRef:Ts,registerWindowRef:_s,requestDismiss:cr,requestDismissSplash:pe,requestFocus:ht,requestPresent:ar,resetMiniappVisualConfig:zs,setMiniappMotionTimeScale:qs,setMiniappVisualConfig:pt,settleFlow:Ys,subscribe:gr,subscribeSlotStatus:nt,unregisterDesktopAppSlotRef:Ns,unregisterDesktopContainerRef:ot,unregisterDesktopGridHostRef:Ds,unregisterIconRef:hs,unregisterSplashBgRef:As,unregisterSplashIconRef:Es,unregisterStackContainerRef:Ms,updateAppContext:dr,useMiniappVisibilityRestore:Ls,useSlotStatus:xs},Symbol.toStringTag,{value:"Module"}));export{Cr as $,pe as A,sr as B,Os as C,Pe as D,Ds as E,vs as F,Ns as G,Jt as H,xe as I,Br as J,os as K,cs as L,ps as M,te as N,jr as O,Ur as P,Lr as Q,xr as R,Hr as S,as as T,Kr as U,qr as V,zr as W,Wr as X,Vr as Y,$r as Z,Mr as _,Pr as a,wr as b,lr as c,d,f as e,at as f,Nr as g,ot as h,gs as i,fs as j,hs as k,At as l,xt as m,Ps as n,ur as o,Ms as p,xs as q,zs as r,qs as s,dt as t,Ls as u,nr as v,Ys as w,_s as x,Ts as y,cr as z};
