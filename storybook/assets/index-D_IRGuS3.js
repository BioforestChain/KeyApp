const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./web-BAZGP8WJ.js","./user-profile-Dk_kijuI.js","./preload-helper-PPVm8Dsz.js","./index-D0E7N0oa.js","./derivation-Dn_NLtka.js","./iframe-BWeqjITw.js","./iframe-vYdnEvhy.css","./schemas-CO8_C8zP.js","./avatar-codec-BCfJ87vB.js","./service-jBNg5IZq.js","./bioforest-tjr8Syby.js","./breakpoint-DQ_qwb34.js","./nacl-fast-B7-1Oaw0.js","./nacl-fast-Ctg5BoXZ.js","./ed2curve-BtXnrGuO.js"])))=>i.map(i=>d[i]);
import{W as En,I as bn,c as In}from"./wujie-container-XwQWXrEN.js";import{g as Ae,k as Rn,n as We}from"./index-qYIYDQQe.js";import{S as ft,v as R,r as gt}from"./iframe-BWeqjITw.js";import{b as Ee,i as _n,l as Tn,o as U,n as ce,s as h,c as $e,a as O}from"./schemas-CO8_C8zP.js";import{t as kn}from"./web-BAZGP8WJ.js";import{w as _}from"./window-stack-BPi_p-h9.js";import{D as Fe,j as Je,x as vn,B as On,E as Dn}from"./derivation-Dn_NLtka.js";import{_ as D}from"./preload-helper-PPVm8Dsz.js";import{w as ht,o as Pn,d as Mn}from"./user-profile-Dk_kijuI.js";import{A as Nn}from"./amount-BQsqQYGO.js";import{e as oe,f as Cn,b as jn}from"./service-jBNg5IZq.js";import"./index-D0E7N0oa.js";import{c as mt,p as wt,h as xn,b as W,s as Ln}from"./bioforest-tjr8Syby.js";import{p as Un,g as Hn,t as zn,E as Bn}from"./index-BkWKD4y7.js";const yt={motion:{timeScale:1,layoutDuration:.45,uiFastDuration:.15,layoutEase:[.4,0,.1,1],spring:{stiffness:220,damping:28,mass:.85}},css:{}};function be(e){return!Number.isFinite(e)||e<=0?1:e}function Y(e,t){const n=be(t);return e/n}function Ge(e,t,n){const s=be(t);return e*Math.pow(s,n)}function qn(e,t){return t?{motion:{...e.motion,...t.motion,spring:{...e.motion.spring,...t.motion?.spring}},css:{...e.css,...t.css}}:e}const Ye=new WeakMap,Ze=new WeakMap;function _i(e){const t=Ye.get(e);if(t)return t;const{motion:n}=e,s={type:"spring",stiffness:Ge(n.spring.stiffness,n.timeScale,2),damping:Ge(n.spring.damping,n.timeScale,1),mass:n.spring.mass},o={layout:{duration:Y(n.layoutDuration,n.timeScale),ease:n.layoutEase}},i={duration:Y(n.uiFastDuration,n.timeScale),ease:"easeOut"},a={motionConfig:s,sharedLayout:o,uiFast:i};return Ye.set(e,a),a}function Ti(e){const t=Ze.get(e);if(t)return t;const{motion:n}=e,s={"--miniapp-motion-time-scale":String(be(n.timeScale)),"--miniapp-motion-layout-duration":`${Y(n.layoutDuration,n.timeScale)}s`,"--miniapp-motion-ui-fast-duration":`${Y(n.uiFastDuration,n.timeScale)}s`,"--miniapp-motion-layout-ease":`cubic-bezier(${n.layoutEase.join(",")})`};return Ze.set(e,s),s}const Kn={iframe:new bn,wujie:new En};function St(e){return Kn[e]}async function Vn(e,t){return St(e).create(t)}function Wn(e,t){const n=St(e);if(!n.createSync)throw new Error(`Container type "${e}" does not support synchronous creation`);return n.createSync(t)}const ki={bio_requestAccounts:{risk:"low"},bio_selectAccount:{risk:"low"},bio_pickWallet:{risk:"low"},bio_createTransaction:{risk:"low"},bio_signMessage:{risk:"medium"},bio_signTypedData:{risk:"medium"},bio_signTransaction:{risk:"high"},bio_sendTransaction:{risk:"high"},bio_destroyAsset:{risk:"high"},bio_requestCryptoToken:{risk:"high"},bio_cryptoExecute:{risk:"low"},bio_getCryptoTokenInfo:{risk:"low"},bio_accounts:{risk:"low"},bio_chainId:{risk:"low"},bio_getBalance:{risk:"low"}},c={USER_REJECTED:4001,UNAUTHORIZED:4100,UNSUPPORTED_METHOD:4200,INTERNAL_ERROR:-32603,INVALID_PARAMS:-32602,METHOD_NOT_FOUND:-32601};function Xe(e,t,n,s){return{type:"bio_response",id:e,success:!1,error:{code:t,message:n,data:s}}}const At="ecosystem_my_apps",$n={teleport:"xin.dweb.teleport",forge:"xin.dweb.biobridge",biobridge:"xin.dweb.biobridge"};function L(e){return $n[e]??e}function Qe(){try{const e=localStorage.getItem(At),t=e?JSON.parse(e):[],n=t.map(s=>({...s,appId:L(s.appId)}));return JSON.stringify(t)!==JSON.stringify(n)&&Et(n),n}catch{return[]}}function Et(e){localStorage.setItem(At,JSON.stringify(e))}var et=[{name:"Open Market",url:"https://om-open.bf-meta.org/hub/source.json"}];const ue=["discover","mine"],bt="ecosystem_store",It=()=>R.t("ecosystem:sources.defaultName");function Fn(){if(!Array.isArray(et))return[];const e=new Date().toISOString();return et.filter(t=>!!(t?.url&&t?.name)).map(t=>({url:t.url,name:t.name,lastUpdated:e,enabled:!0,status:"idle",icon:t.icon}))}function Jn(e,t){return e.length===t.length&&e.every((n,s)=>n===t[s])}function Rt(){const t=[{url:"./miniapps/ecosystem.json",name:It(),lastUpdated:new Date().toISOString(),enabled:!0,status:"idle"}];for(const n of Fn())t.some(s=>s.url===n.url)||t.push(n);return t}function tt(e){const t=Rt(),n=[...e];for(const s of t)n.some(r=>r.url===s.url)||n.push(s);return n}function Gn(e){if(!Array.isArray(e))return[];const t=new Date().toISOString();return e.map(n=>{if(typeof n=="string")return{url:n,name:"Bio 官方生态",lastUpdated:t,enabled:!0,status:"idle"};if(!n||typeof n!="object")return null;const s=n;return typeof s.url!="string"||s.url.length===0?null:{url:s.url,name:typeof s.name=="string"&&s.name.length>0?s.name:It(),lastUpdated:typeof s.lastUpdated=="string"&&s.lastUpdated.length>0?s.lastUpdated:t,enabled:typeof s.enabled=="boolean"?s.enabled:!0,status:s.status??"idle",errorMessage:s.errorMessage,icon:s.icon}}).filter(n=>n!==null)}function Yn(){try{const e=localStorage.getItem(bt);if(e){const t=JSON.parse(e),n=Array.isArray(t.availableSubPages)&&t.availableSubPages.length>0?t.availableSubPages:ue,s=t.activeSubPage??"discover",r=n.includes(s)?n:[...n,s],o=Gn(t.sources),i=tt(o);return{permissions:t.permissions??[],sources:i.length>0?i:Rt(),myApps:Qe(),availableSubPages:r,activeSubPage:s,swiperProgress:0,syncSource:null}}}catch{}return{permissions:[],sources:tt([]),myApps:Qe(),availableSubPages:ue,activeSubPage:"discover",swiperProgress:0,syncSource:null}}function Zn(e){try{localStorage.setItem(bt,JSON.stringify({permissions:e.permissions,sources:e.sources,availableSubPages:e.availableSubPages,activeSubPage:e.activeSubPage})),Et(e.myApps)}catch{}}const m=new ft(Yn());m.subscribe(()=>{Zn(m.state)});const te={getGrantedPermissions:(e,t)=>e.permissions.find(n=>n.appId===t)?.granted??[],hasPermission:(e,t,n)=>te.getGrantedPermissions(e,t).includes(n),getEnabledSources:e=>e.sources.filter(t=>t.enabled),isAppInstalled:(e,t)=>{const n=L(t);return e.myApps.some(s=>s.appId===n)}},I={installApp:e=>{m.setState(t=>{const n=L(e);return t.myApps.some(s=>s.appId===n)?t:{...t,myApps:[{appId:n,installedAt:Date.now(),lastUsedAt:Date.now()},...t.myApps]}})},uninstallApp:e=>{m.setState(t=>{const n=L(e);return{...t,myApps:t.myApps.filter(s=>s.appId!==n)}})},updateAppLastUsed:e=>{m.setState(t=>{const n=L(e);return t.myApps.find(r=>r.appId===n)?{...t,myApps:t.myApps.map(r=>r.appId===n?{...r,lastUsedAt:Date.now()}:r)}:t})},grantPermissions:(e,t)=>{m.setState(n=>{const s=n.permissions.find(r=>r.appId===e);if(s){const r=[...new Set([...s.granted,...t])];return{...n,permissions:n.permissions.map(o=>o.appId===e?{...o,granted:r,grantedAt:Date.now()}:o)}}else return{...n,permissions:[...n.permissions,{appId:e,granted:t,grantedAt:Date.now()}]}})},revokePermissions:(e,t)=>{m.setState(n=>t?{...n,permissions:n.permissions.map(s=>s.appId===e?{...s,granted:s.granted.filter(r=>!t.includes(r))}:s)}:{...n,permissions:n.permissions.filter(s=>s.appId!==e)})},addSource:(e,t)=>{m.setState(n=>n.sources.some(s=>s.url===e)?n:{...n,sources:[...n.sources,{url:e,name:t,lastUpdated:new Date().toISOString(),enabled:!0,status:"idle"}]})},removeSource:e=>{m.setState(t=>({...t,sources:t.sources.filter(n=>n.url!==e)}))},toggleSource:e=>{m.setState(t=>({...t,sources:t.sources.map(n=>n.url===e?{...n,enabled:!n.enabled}:n)}))},updateSourceName:(e,t)=>{m.setState(n=>({...n,sources:n.sources.map(s=>s.url===e?{...s,name:t}:s)}))},updateSourceTimestamp:e=>{m.setState(t=>({...t,sources:t.sources.map(n=>n.url===e?{...n,lastUpdated:new Date().toISOString()}:n)}))},updateSourceStatus:(e,t,n)=>{m.setState(s=>({...s,sources:s.sources.map(r=>r.url===e?{...r,status:t,errorMessage:t==="error"?n:void 0,...t==="success"?{lastUpdated:new Date().toISOString()}:{}}:r)}))},setActiveSubPage:e=>{m.setState(t=>({...t,activeSubPage:e}))},setAvailableSubPages:e=>{m.setState(t=>{const n=e.length>0?e:ue;if(Jn(t.availableSubPages,n))return t;const s=n.includes(t.activeSubPage)?t.activeSubPage:n[0]??"mine";return{...t,availableSubPages:n,activeSubPage:s}})},setSwiperProgress:e=>{m.setState(t=>({...t,swiperProgress:e}))},setSyncSource:e=>{m.setState(t=>({...t,syncSource:e}))}},Xn=["bio_requestAccounts","bio_signMessage","bio_signTypedData","bio_signTransaction","bio_sendTransaction"];function Ie(e){return Xn.includes(e)}function Qn(e,t){return Ie(t)?te.hasPermission(m.state,e,t):!0}function es(e,t){I.grantPermissions(e,t)}function vi(e){const t=R.t.bind(R),s=["bio_requestAccounts","bio_accounts","bio_selectAccount","bio_pickWallet","bio_chainId","bio_getBalance","bio_createTransaction","bio_signMessage","bio_signTypedData","bio_signTransaction","bio_sendTransaction","bio_destroyAsset","bio_requestCryptoToken","bio_cryptoExecute","bio_getCryptoTokenInfo"].includes(e);return{label:s?t(`ecosystem:permissions.${e}.name`):e,description:t(s?`ecosystem:permissions.${e}.description`:"ecosystem:permissions.defaultDescription"),sensitive:Ie(e)}}class ts{handlers=new Map;iframe=null;appId="";appName="";origin="*";manifestPermissions=[];messageHandler=null;permissionRequestCallback=null;registerHandler(t,n){this.handlers.set(t,n)}setPermissionRequestCallback(t){this.permissionRequestCallback=t}attach(t,n,s,r=[]){this.detach(),this.iframe=t,this.appId=n,this.appName=s,this.manifestPermissions=r;try{const o=new URL(t.src,window.location.origin);this.origin=o.origin}catch{this.origin="*"}this.messageHandler=this.handleMessage.bind(this),window.addEventListener("message",this.messageHandler)}detach(){this.messageHandler&&(window.removeEventListener("message",this.messageHandler),this.messageHandler=null),this.iframe=null,this.appId="",this.appName="",this.manifestPermissions=[]}emit(t,...n){this.emitTo("bio",t,...n)}emitEth(t,...n){this.emitTo("eth",t,...n)}emitTron(t,...n){this.emitTo("tron",t,...n)}emitTo(t,n,...s){if(!this.iframe?.contentWindow)return;const r={type:`${t}_event`,event:n,args:s};this.iframe.contentWindow.postMessage(r,this.origin)}handleMessage(t){const n=t.data;if(!n||typeof n!="object"||!("type"in n)||!(n.type==="bio_request"||n.type==="eth_request"||n.type==="tron_request"))return;console.log("[BioBridge] Received bio message:",{origin:t.origin,expectedOrigin:this.origin,type:n.type,method:n.method});const r=this.origin.includes("localhost")&&t.origin.includes("localhost");if(!(this.origin==="*"||t.origin===this.origin||r)){console.warn("[BioBridge] Origin mismatch, ignoring message");return}if(!(t.source===this.iframe?.contentWindow||r&&t.source instanceof Window)){console.warn("[BioBridge] Source mismatch, ignoring message");return}console.log("[BioBridge] Processing message:",n.type),n.type==="bio_request"?this.processRequest(n,"bio"):n.type==="eth_request"?this.processRequest(n,"eth"):n.type==="tron_request"&&this.processRequest(n,"tron")}async processRequest(t,n){const{id:s,method:r,params:o}=t,i=this.handlers.get(r);if(!i){this.sendResponse(n,{type:`${n}_response`,id:s,success:!1,error:{code:c.METHOD_NOT_FOUND,message:`Method not found: ${r}`}});return}if(!(n!=="bio"||["bio_connect","bio_closeSplashScreen"].includes(r))){const d=["bio_accounts","bio_selectAccount","bio_pickWallet"].includes(r)&&this.manifestPermissions.includes("bio_requestAccounts"),l=d?"bio_requestAccounts":r;if(!(this.manifestPermissions.includes(r)||r==="bio_requestAccounts"||d)){this.sendResponse(n,Xe(s,c.UNAUTHORIZED,`Permission not declared in manifest: ${r}`));return}if(Ie(l)&&!Qn(this.appId,l)&&!await this.requestPermission([l])){this.sendResponse(n,Xe(s,c.USER_REJECTED,"Permission denied by user"));return}}try{const d=p.state.apps.get(this.appId)?.manifest;let l=d?.icon;if(l&&!l.startsWith("http")&&!l.startsWith("data:"))try{const y=new URL(d?.url??"",window.location.origin);l=new URL(l,y).href}catch{}const g={appId:this.appId,appName:this.appName,appIcon:l,origin:this.origin,permissions:this.manifestPermissions},f=await i(o?.[0],g);this.sendResponse(n,{type:`${n}_response`,id:s,success:!0,result:f})}catch(u){const d=u instanceof Error?u.message:"Unknown error",l=u.code??c.INTERNAL_ERROR;this.sendResponse(n,{type:`${n}_response`,id:s,success:!1,error:{code:l,message:d}})}}async requestPermission(t){if(!this.permissionRequestCallback)return!1;try{const n=await this.permissionRequestCallback(this.appId,this.appName,t);return n&&es(this.appId,t),n}catch{return!1}}sendResponse(t,n){this.iframe?.contentWindow&&this.iframe.contentWindow.postMessage(n,this.origin)}}const w=new ts;function B(e){const t=e.appIcon?.trim();return t?{name:e.appName,icon:t}:{name:e.appName}}const P=new Map,b={register(e,t){P.set(e,t)},unregister(e){P.delete(e)},get(e){return P.get(e)},has(e){return P.has(e)},getRegisteredApps(){return Array.from(P.keys())},clear(){P.clear()}},ns=async(e,t)=>{wn(t.appId)},$=new Map;function ss(e){return e.trim().toLowerCase()}function S(e,t){const n=ss(e),r=($.get(n)??Promise.resolve()).catch(()=>{}).then(t),o=r.then(()=>{},()=>{});return $.set(n,o),o.finally(()=>{$.get(n)===o&&$.delete(n)}),r}let _t=null,Tt=null;function Oi(e){_t=e}function Di(e){Tt=e}function Re(e){return b.get(e)?.showWalletPicker??_t}function rs(e){return b.get(e)?.getConnectedAccounts??Tt}const os=async(e,t)=>({connected:!0}),is=async(e,t)=>{const n=Re(t.appId);if(!n)throw Object.assign(new Error("Wallet picker not available"),{code:c.INTERNAL_ERROR});const s=e,r=await S(t.appId,()=>n({chain:s?.chain,app:{name:t.appName,icon:t.appIcon}}));if(!r)throw Object.assign(new Error("User rejected"),{code:c.USER_REJECTED});return[r]},as=async(e,t)=>{const n=rs(t.appId);return n?n():[]},cs=async(e,t)=>{const n=Re(t.appId);if(!n)throw Object.assign(new Error("Wallet picker not available"),{code:c.INTERNAL_ERROR});const s=e,r=await S(t.appId,()=>n({...s,app:{name:t.appName,icon:t.appIcon}}));if(!r)throw Object.assign(new Error("User rejected"),{code:c.USER_REJECTED});return r},us=async(e,t)=>{const n=Re(t.appId);if(!n)throw Object.assign(new Error("Wallet picker not available"),{code:c.INTERNAL_ERROR});const s=e,r=await S(t.appId,()=>n({...s,app:{name:t.appName,icon:t.appIcon}}));if(!r)throw Object.assign(new Error("User rejected"),{code:c.USER_REJECTED});return r},ds=async(e,t)=>ht.state.selectedChain,ls=async(e,t)=>{const n=e;if(!n?.address||!n?.chain)throw Object.assign(new Error("Missing address or chain"),{code:c.INVALID_PARAMS});const s=Ae(n.chain);try{return(await s.nativeBalance.fetch({address:n.address}))?.amount.toRawString()??"0"}catch{return"0"}};let kt=null;function Pi(e){kt=e}function vt(e){return b.get(e)?.showSigningDialog??kt}const ps=async(e,t)=>{const n=e;if(!n?.message||!n?.address||!n?.chainName)throw Object.assign(new Error("Missing message, address, or chainName"),{code:c.INVALID_PARAMS});const s=vt(t.appId);if(!s)throw Object.assign(new Error("Signing dialog not available"),{code:c.INTERNAL_ERROR});const r={message:n.message,address:n.address,chainName:n.chainName,app:B(t)},o=await S(t.appId,()=>s(r));if(!o)throw Object.assign(new Error("User rejected"),{code:c.USER_REJECTED});return o},fs=async(e,t)=>{const n=e;if(!n?.data||!n?.address||!n?.chainName)throw Object.assign(new Error("Missing data, address, or chainName"),{code:c.INVALID_PARAMS});const s=vt(t.appId);if(!s)throw Object.assign(new Error("Signing dialog not available"),{code:c.INTERNAL_ERROR});const o={message:JSON.stringify(n.data,null,2),address:n.address,chainName:n.chainName,app:B(t)},i=await S(t.appId,()=>s(o));if(!i)throw Object.assign(new Error("User rejected"),{code:c.USER_REJECTED});return i},Ot=/^\d+$/;function Dt(e){return Ot.test(e.trim())}function gs(e,t,n){const s=e.trim();if(!Ot.test(s))throw new Error("Invalid raw amount");return Nn.fromRaw(s,t,n)}let Pt=null;function Mi(e){Pt=e}function hs(e){return b.get(e)?.showTransferDialog??Pt}function ms(e){return typeof e=="object"&&e!==null}function ws(e){const t=e.txHash||e.txId,n=e.txId||e.txHash;if(!t||!n)throw Object.assign(new Error("Invalid transfer result: missing tx id"),{code:c.INTERNAL_ERROR});const s=ms(e.transaction)?e.transaction:{txId:n,txHash:t};return{txHash:t,txId:n,transaction:s}}const ys=async(e,t)=>{const n=e;if(!n?.from||!n?.to||!n?.amount||!n?.chain)throw Object.assign(new Error("Missing required parameters: from, to, amount, chain"),{code:c.INVALID_PARAMS});if(!Dt(n.amount))throw Object.assign(new Error("Invalid amount: expected raw integer string"),{code:c.INVALID_PARAMS});const s=hs(t.appId);if(!s)throw Object.assign(new Error("Transfer dialog not available"),{code:c.INTERNAL_ERROR});const r={from:n.from,to:n.to,amount:n.amount,chain:n.chain,app:B(t)};n.asset&&(r.asset=n.asset),n.tokenAddress&&(r.tokenAddress=n.tokenAddress),n.remark&&(r.remark=n.remark);const o=await S(t.appId,()=>s(r));if(!o)throw Object.assign(new Error("User rejected"),{code:c.USER_REJECTED});return ws(o)};let Mt=null;function Ni(e){Mt=e}function Ss(e){return b.get(e)?.showDestroyDialog??Mt}function As(e){return typeof e=="object"&&e!==null}function Es(e){const t=e.txHash||e.txId,n=e.txId||e.txHash;if(!t||!n)throw Object.assign(new Error("Invalid destroy result: missing tx id"),{code:c.INTERNAL_ERROR});const s=As(e.transaction)?e.transaction:{txId:n,txHash:t};return{txHash:t,txId:n,transaction:s}}const bs=async(e,t)=>{const n=e;if(!n?.from||!n?.amount||!n?.chain||!n?.asset)throw Object.assign(new Error("Missing required parameters: from, amount, chain, asset"),{code:c.INVALID_PARAMS});if(!Dt(n.amount))throw Object.assign(new Error("Invalid amount: expected raw integer string"),{code:c.INVALID_PARAMS});const s=Ss(t.appId);if(!s)throw Object.assign(new Error("Destroy dialog not available"),{code:c.INTERNAL_ERROR});const r={from:n.from,amount:n.amount,chain:n.chain,asset:n.asset,...n.remark?{remark:n.remark}:{},app:B(t)},o=await S(t.appId,()=>s(r));if(!o)throw Object.assign(new Error("User rejected"),{code:c.USER_REJECTED});return Es(o)};function Is(e,t){const n=ht.state.wallets,s=e.trim().toLowerCase(),r=t.startsWith("0x"),o=r?t.toLowerCase():t;for(const i of n)if(i.chainAddresses.find(u=>u.chain.toLowerCase()!==s?!1:r||u.address.startsWith("0x")?u.address.toLowerCase()===o:u.address===o))return i.id;return null}async function Nt(e){if(oe.state.snapshot||await Cn.initialize(),!oe.state.snapshot)throw Object.assign(new Error("Chain configs not initialized"),{code:c.INTERNAL_ERROR});const n=jn.getChainById(oe.state,e);if(!n)throw Object.assign(new Error(`Unsupported chain: ${e}`),{code:c.INVALID_PARAMS});return n}const Rs=async(e,t)=>{const n=e,s=n?.type??"transfer";if(!n?.from||!n?.amount||!n?.chain)throw Object.assign(new Error("Missing required parameters: from, amount, chain"),{code:c.INVALID_PARAMS});if(s==="transfer"&&!n?.to)throw Object.assign(new Error("Missing required parameters: to"),{code:c.INVALID_PARAMS});if(s==="destroy"&&!n?.recipientId&&!n?.to)throw Object.assign(new Error("Missing required parameters: recipientId"),{code:c.INVALID_PARAMS});if(!Is(n.chain,n.from))throw Object.assign(new Error("From address is not owned by current user"),{code:c.UNAUTHORIZED});const o=await Nt(n.chain),i=n.tokenAddress?.trim()||void 0,a=n.asset??o.symbol,u=i&&typeof n.assetDecimals=="number"?n.assetDecimals:o.decimals;let d;try{d=gs(n.amount,u,a)}catch{throw Object.assign(new Error("Invalid amount: expected raw integer string"),{code:c.INVALID_PARAMS})}const l=i&&o.chainKind==="tron"?Rn(o.id):Ae(o.id),g=l.buildTransaction;if(!l.supportsBuildTransaction||!g)throw Object.assign(new Error(`Chain ${o.id} does not support transaction building`),{code:c.UNSUPPORTED_METHOD});const f=await g(s==="destroy"?{type:"destroy",from:n.from,recipientId:n.recipientId??n.to,amount:d,bioAssetType:n.asset??o.symbol,...n.remark?{remark:n.remark}:{}}:{type:"transfer",from:n.from,to:n.to,amount:d,tokenAddress:i,...n.asset?{bioAssetType:n.asset}:{},...n.remark?{remark:n.remark}:{}});if(i&&o.chainKind==="tron"){const V=f.data;if(!V||typeof V!="object"||!("rawTx"in V))throw Object.assign(new Error("TRC20 transaction builder not available"),{code:c.UNSUPPORTED_METHOD})}return{chainId:f.chainId,intentType:f.intentType,data:f.data}};let Ct=null;function Ci(e){Ct=e}function _s(e){return b.get(e)?.showSignTransactionDialog??Ct}const Ts=async(e,t)=>{const n=e;if(!n?.from||!n?.chain||!n?.unsignedTx)throw Object.assign(new Error("Missing required parameters: from, chain, unsignedTx"),{code:c.INVALID_PARAMS});const s=_s(t.appId);if(!s)throw Object.assign(new Error("SignTransaction dialog not available"),{code:c.INTERNAL_ERROR});const{from:r,chain:o,unsignedTx:i}=n,a=await S(t.appId,()=>s({from:r,chain:o,unsignedTx:i,app:B(t)}));if(!a)throw Object.assign(new Error("User rejected"),{code:c.USER_REJECTED});return a};async function ji(e){const t=await Nt(e.chainId),n=Ae(t.id),s=n.signTransaction;if(!n.supportsSignTransaction||!s)throw Object.assign(new Error(`Chain ${t.id} does not support transaction signing`),{code:c.UNSUPPORTED_METHOD});const r=await(await D(async()=>{const{walletStorageService:a}=await import("./web-BAZGP8WJ.js").then(u=>u.i);return{walletStorageService:a}},__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11]),import.meta.url)).walletStorageService.getMnemonic(e.walletId,e.password);let o;if(t.chainKind==="evm"){const a=Fe(r,"ethereum",0,0);if(a.address.toLowerCase()!==e.from.toLowerCase())throw Object.assign(new Error("Signing address mismatch"),{code:c.INVALID_PARAMS});o=Je(a.privateKey)}else if(t.chainKind==="bioforest"){const a=mt(r);if(wt(a.publicKey,t.prefix??"b")!==e.from)throw Object.assign(new Error("Signing address mismatch"),{code:c.INVALID_PARAMS});o=a.secretKey}else if(t.chainKind==="tron"){const a=Fe(r,"tron",0,0),u=We(e.from),d=We(a.address);if(u!==d)throw Object.assign(new Error("Signing address mismatch"),{code:c.INVALID_PARAMS});o=Je(a.privateKey)}else throw Object.assign(new Error(`Unsupported chain kind: ${t.chainKind}`),{code:c.UNSUPPORTED_METHOD});const i=await s({chainId:e.unsignedTx.chainId,intentType:e.unsignedTx.intentType??"transfer",data:e.unsignedTx.data},t.chainKind==="bioforest"?{bioSecret:r,bioPaySecret:e.paySecret,privateKey:o}:{privateKey:o});return{chainId:i.chainId,data:i.data,signature:i.signature}}const jt=new Map,xt=new Map;let Lt=null,de=null,Ut=null,Ht=null;function xi(e){Lt=e}function Li(e){de=e}function Ui(e){Ut=e}function Hi(e){Ht=e}function ks(e){return b.get(e)?.showEvmWalletPicker??Lt}function zt(e){return b.get(e)?.showEvmSigningDialog??Ut}function vs(e){return b.get(e)?.showEvmTransactionDialog??Ht}function q(e){return jt.get(e)??zn(Bn.binance)}function Os(e,t){jt.set(e,t)}function Ds(e){return xt.get(e)??[]}function Ps(e,t){xt.set(e,t)}const Ms=async(e,t)=>q(t.appId),Ns=async(e,t)=>{const n=ks(t.appId);if(!n)throw Object.assign(new Error("Wallet picker not available"),{code:c.INTERNAL_ERROR});const s=q(t.appId),r=await S(t.appId,()=>n({chainId:s,app:{name:t.appName,icon:t.appIcon}}));if(!r)throw Object.assign(new Error("User rejected"),{code:c.USER_REJECTED});const o=[r.address];return Ps(t.appId,o),o},Cs=async(e,t)=>Ds(t.appId),js=async(e,t)=>{const n=e;if(!n?.chainId)throw Object.assign(new Error("Missing chainId"),{code:c.INVALID_PARAMS});const s=n.chainId;if(!Hn(s))throw Object.assign(new Error(`Chain ${s} not supported`),{code:4902});const o=q(t.appId);if(o===s)return null;if(de&&!await S(t.appId,()=>de({fromChainId:o,toChainId:s,appName:t.appName,appIcon:t.appIcon})))throw Object.assign(new Error("User rejected"),{code:c.USER_REJECTED});return Os(t.appId,s),null},xs=async(e,t)=>{throw Object.assign(new Error("Adding custom chains is not supported"),{code:c.UNSUPPORTED_METHOD})},Bt=async(e,t)=>{const[n,s]=e;if(!n||!s)throw Object.assign(new Error("Missing message or address"),{code:c.INVALID_PARAMS});const r=zt(t.appId);if(!r)throw Object.assign(new Error("Signing dialog not available"),{code:c.INTERNAL_ERROR});const o=await S(t.appId,()=>r({message:n,address:s,appName:t.appName}));if(!o)throw Object.assign(new Error("User rejected"),{code:c.USER_REJECTED});return o.signature},Ls=async(e,t)=>{const[n,s]=e;return Bt([s,n],t)},Us=async(e,t)=>{const[n,s]=e;if(!n||!s)throw Object.assign(new Error("Missing address or typedData"),{code:c.INVALID_PARAMS});const r=typeof s=="string"?JSON.parse(s):s,o=zt(t.appId);if(!o)throw Object.assign(new Error("Signing dialog not available"),{code:c.INTERNAL_ERROR});const i=JSON.stringify(r,null,2),a=await S(t.appId,()=>o({message:i,address:n,appName:t.appName}));if(!a)throw Object.assign(new Error("User rejected"),{code:c.USER_REJECTED});return a.signature},Hs=async(e,t)=>{const n=e;if(!n?.from)throw Object.assign(new Error("Missing transaction data"),{code:c.INVALID_PARAMS});const s=vs(t.appId);if(!s)throw Object.assign(new Error("Transaction dialog not available"),{code:c.INTERNAL_ERROR});n.chainId||(n.chainId=q(t.appId));const r=await S(t.appId,()=>s({tx:n,appName:t.appName}));if(!r)throw Object.assign(new Error("User rejected"),{code:c.USER_REJECTED});return r.txHash},zs=async(e,t)=>{throw e?.from?Object.assign(new Error("eth_signTransaction not yet supported, use eth_sendTransaction"),{code:c.UNSUPPORTED_METHOD}):Object.assign(new Error("Missing transaction data"),{code:c.INVALID_PARAMS})},Bs=async(e,t)=>{const[n]=e;if(!n)throw Object.assign(new Error("Missing address"),{code:c.INVALID_PARAMS});return"0x0"},qs=async(e,t)=>{const n=q(t.appId),s=Un(n);return String(s)},Ks=async(e,t)=>"0x0",Vs=async(e,t)=>"KeyApp/1.0.0",Ws={eth_chainId:Ms,eth_requestAccounts:Ns,eth_accounts:Cs,wallet_switchEthereumChain:js,wallet_addEthereumChain:xs,personal_sign:Bt,eth_sign:Ls,eth_signTypedData_v4:Us,eth_sendTransaction:Hs,eth_signTransaction:zs,eth_getBalance:Bs,net_version:qs,eth_blockNumber:Ks,web3_clientVersion:Vs};function $s(e){for(const[t,n]of Object.entries(Ws))e(t,n)}const qt=new Map;let Kt=null,Fs=null;function zi(e){Kt=e}function Js(e){return b.get(e)?.showTronWalletPicker??Kt}function Gs(e){return b.get(e)?.showTronSigningDialog??Fs}function Vt(e){return qt.get(e)??null}function Ys(e,t){qt.set(e,t)}function Zs(e){return{base58:e.address,hex:e.address}}const Xs=async(e,t)=>{const n=Js(t.appId);if(!n)throw Object.assign(new Error("Wallet picker not available"),{code:c.INTERNAL_ERROR});const s=await S(t.appId,()=>n({app:{name:t.appName,icon:t.appIcon}}));if(!s)throw Object.assign(new Error("User rejected"),{code:c.USER_REJECTED});const r=Zs(s);return Ys(t.appId,r),{code:200,message:"ok",data:r}},Qs=async(e,t)=>{const n=Vt(t.appId);return n?{code:200,message:"ok",data:n}:{code:4e3,message:"Not connected",data:null}},er=async(e,t)=>Vt(t.appId),tr=async(e,t)=>{const n=e;if(!n?.txID)throw Object.assign(new Error("Invalid transaction"),{code:c.INVALID_PARAMS});const s=Gs(t.appId);if(!s)throw Object.assign(new Error("Signing dialog not available"),{code:c.INTERNAL_ERROR});const r=await S(t.appId,()=>s({transaction:n,appName:t.appName}));if(!r)throw Object.assign(new Error("User rejected"),{code:c.USER_REJECTED});return r.signedTransaction},nr=async(e,t)=>{const n=e;if(!n?.txID||!n.signature)throw Object.assign(new Error("Invalid signed transaction"),{code:c.INVALID_PARAMS});return{result:!0,txid:n.txID}},sr=async(e,t)=>{if(!e)throw Object.assign(new Error("Missing address"),{code:c.INVALID_PARAMS});return 0},rr=async(e,t)=>{const n=e;if(!n)throw Object.assign(new Error("Missing address"),{code:c.INVALID_PARAMS});return{address:n,balance:0}},or={tron_requestAccounts:Xs,tron_accounts:Qs,tron_getDefaultAddress:er,tron_signTransaction:tr,tron_sendRawTransaction:nr,tron_getBalance:sr,tron_getAccount:rr};function ir(e){for(const[t,n]of Object.entries(or))e(t,n)}const ar="crypto-box-db",cr=2,k="tokens";class ur{db=null;initialized=!1;async initialize(){this.initialized||(this.db=await Pn(ar,cr,{upgrade(t,n){t.objectStoreNames.contains(k)&&t.deleteObjectStore(k);const s=t.createObjectStore(k,{keyPath:"tokenId"});s.createIndex("by-miniapp","miniappId"),s.createIndex("by-wallet","walletId"),s.createIndex("by-expires","expiresAt")}}),this.initialized=!0,await this.cleanupExpired())}ensureInitialized(){if(!this.initialized||!this.db)throw new Error("TokenStore not initialized")}generateTokenId(){return crypto.randomUUID()}async sha256(t){const s=new TextEncoder().encode(t),r=await crypto.subtle.digest("SHA-256",s);return Array.from(new Uint8Array(r)).map(i=>i.toString(16).padStart(2,"0")).join("")}async deriveSessionSecret(t,n,s,r){return this.sha256(`${t}:${n}:${s}:${r}`)}async createToken(t){this.ensureInitialized();const{TOKEN_DURATION_MS:n}=await D(async()=>{const{TOKEN_DURATION_MS:f}=await Promise.resolve().then(()=>le);return{TOKEN_DURATION_MS:f}},void 0,import.meta.url),s=Date.now(),r=this.generateTokenId(),o=s+n[t.duration],i=await this.deriveSessionSecret(t.walletId,t.patternKey,t.miniappId,r),a={patternKey:t.patternKey,miniappId:t.miniappId,walletId:t.walletId,address:t.address,actions:t.actions,expiresAt:o},u=JSON.stringify(await vn(JSON.stringify(a),i)),d={tokenId:r,miniappId:t.miniappId,walletId:t.walletId,address:t.address,actions:t.actions,expiresAt:o,createdAt:s,encryptedPayload:u};await this.db.put(k,d);const{encryptedPayload:l,...g}=d;return{token:g,sessionSecret:i}}async decryptPayload(t,n){try{const s=JSON.parse(t.encryptedPayload),r=await On(s,n);return JSON.parse(r)}catch{return null}}async getToken(t){return this.ensureInitialized(),await this.db.get(k,t)??null}async deleteToken(t){this.ensureInitialized(),await this.db.delete(k,t)}async validateToken(t,n,s,r){this.ensureInitialized();const o=await this.getToken(t);if(!o)return{valid:!1,error:"TOKEN_NOT_FOUND"};const i=await this.decryptPayload(o,n);return i?i.miniappId!==s?{valid:!1,error:"MINIAPP_MISMATCH"}:Date.now()>i.expiresAt?(await this.deleteToken(t),{valid:!1,error:"TOKEN_EXPIRED"}):i.actions.includes(r)?{valid:!0,token:o,payload:i}:{valid:!1,error:"ACTION_NOT_PERMITTED"}:{valid:!1,error:"INVALID_SESSION_SECRET"}}async getTokenInfo(t,n,s){this.ensureInitialized();const r=await this.getToken(t);if(!r)return{valid:!1,address:"",expiresAt:0,actions:[],invalidReason:"TOKEN_NOT_FOUND"};const o=await this.decryptPayload(r,n);return o?o.miniappId!==s?{valid:!1,address:"",expiresAt:0,actions:[],invalidReason:"MINIAPP_MISMATCH"}:Date.now()>o.expiresAt?(await this.deleteToken(t),{valid:!1,address:o.address,expiresAt:o.expiresAt,actions:o.actions,invalidReason:"TOKEN_EXPIRED"}):{valid:!0,address:o.address,expiresAt:o.expiresAt,actions:o.actions}:{valid:!1,address:"",expiresAt:0,actions:[],invalidReason:"INVALID_SESSION_SECRET"}}async cleanupExpired(){this.ensureInitialized();const t=Date.now(),n=this.db.transaction(k,"readwrite"),s=n.store.index("by-expires");let r=0,o=await s.openCursor(IDBKeyRange.upperBound(t));for(;o;)await o.delete(),r++,o=await o.continue();return await n.done,r}async getTokensByMiniapp(t){this.ensureInitialized();const n=Date.now();return(await this.db.getAllFromIndex(k,"by-miniapp",t)).filter(r=>r.expiresAt>n).map(({encryptedPayload:r,...o})=>o)}close(){this.db&&(this.db.close(),this.db=null,this.initialized=!1)}}const N=new ur;class dr{async execute(t,n){const s=await N.validateToken(t.tokenId,t.sessionSecret,n,t.action);if(!s.valid){const{CryptoBoxErrorCodes:a}=await D(async()=>{const{CryptoBoxErrorCodes:d}=await Promise.resolve().then(()=>le);return{CryptoBoxErrorCodes:d}},void 0,import.meta.url),u={TOKEN_NOT_FOUND:a.TOKEN_NOT_FOUND,MINIAPP_MISMATCH:a.MINIAPP_MISMATCH,TOKEN_EXPIRED:a.TOKEN_EXPIRED,ACTION_NOT_PERMITTED:a.ACTION_NOT_PERMITTED,INVALID_SESSION_SECRET:a.INVALID_SESSION_SECRET,ADDRESS_MISMATCH:a.ADDRESS_MISMATCH};throw Object.assign(new Error(`Token validation failed: ${s.error}`),{code:u[s.error]})}const{payload:r}=s;if(t.address&&t.address!==r.address){const{CryptoBoxErrorCodes:a}=await D(async()=>{const{CryptoBoxErrorCodes:u}=await Promise.resolve().then(()=>le);return{CryptoBoxErrorCodes:u}},void 0,import.meta.url);throw Object.assign(new Error(`Address mismatch: requested ${t.address} but token is for ${r.address}`),{code:a.ADDRESS_MISMATCH})}const o=await this.getKeypairForWallet(r.walletId,r.address,r.patternKey);let i;switch(t.action){case"asymmetricEncrypt":i=await this.executeAsymmetricEncrypt(t.params,o);break;case"sign":i=await this.executeSign(t.params,o);break;default:throw new Error(`Unknown action: ${t.action}`)}return{...i,address:r.address}}async getKeypairForWallet(t,n,s){try{const r=await Mn.getMnemonic(t,s),o=mt(r),i=n.charAt(0);if(wt(o.publicKey,i)!==n)throw new Error(`Address mismatch: token address ${n} does not match wallet`);return o}catch(r){throw r instanceof Error&&r.message.includes("Address mismatch")?r:new Error(`Failed to get keypair for wallet ${t}: invalid patternKey or wallet not found`)}}normalizePublicKey(t){if(typeof t=="string")return t;if(t&&typeof t=="object"&&"type"in t&&"data"in t){const n=t;if(n.type==="Buffer"&&Array.isArray(n.data))return n.data.map(s=>s.toString(16).padStart(2,"0")).join("")}if(Array.isArray(t)||t instanceof Uint8Array)return Array.from(t).map(n=>n.toString(16).padStart(2,"0")).join("");throw new Error(`Invalid publicKey format: ${typeof t}`)}async executeAsymmetricEncrypt(t,n){const s=xn(this.normalizePublicKey(t.recipientPublicKey)),r=new TextEncoder().encode(t.data),o=await D(()=>import("./nacl-fast-B7-1Oaw0.js").then(g=>g.n),__vite__mapDeps([12,5,2,6,13]),import.meta.url),i=await D(()=>import("./ed2curve-BtXnrGuO.js").then(g=>g.e),__vite__mapDeps([14,5,2,6,13]),import.meta.url),a=i.convertPublicKey(s),u=i.convertSecretKey(n.secretKey);if(!a||!u)throw new Error("Failed to convert Ed25519 keys to X25519");const d=new Uint8Array(24),l=o.box(r,d,a,u);return{result:W(l),publicKey:W(n.publicKey)}}async executeSign(t,n){const s=new TextEncoder().encode(t.data),r=Ln(s,n.secretKey);return{result:W(r),publicKey:W(n.publicKey)}}}const lr=new dr,pr={"5min":300*1e3,"30min":1800*1e3,"2hour":7200*1e3,"1day":1440*60*1e3},fr=["5min","30min","2hour","1day"],v={TOKEN_NOT_FOUND:4100,MINIAPP_MISMATCH:4101,TOKEN_EXPIRED:4102,ACTION_NOT_PERMITTED:4103,INVALID_SESSION_SECRET:4104,ADDRESS_MISMATCH:4105,USER_REJECTED:4001,INTERNAL_ERROR:-32603},gr={asymmetricEncrypt:{name:"非对称加密",description:"使用您的私钥进行非对称加密"},sign:{name:"数据签名",description:"使用您的私钥进行签名"}},hr={"5min":"5 分钟","30min":"30 分钟","2hour":"2 小时","1day":"1 天"},le=Object.freeze(Object.defineProperty({__proto__:null,CRYPTO_ACTION_LABELS:gr,CryptoBoxErrorCodes:v,TOKEN_DURATION_LABELS:hr,TOKEN_DURATION_MS:pr,TOKEN_DURATION_OPTIONS:fr},Symbol.toStringTag,{value:"Module"}));let pe=null;function Bi(e){pe=e}const mr=async(e,t)=>{const n=e;if(!n?.actions||!n?.duration||!n?.address)throw Object.assign(new Error("Missing required parameters: actions, duration, address"),{code:v.INTERNAL_ERROR});const s=["asymmetricEncrypt","sign"];for(const l of n.actions)if(!s.includes(l))throw Object.assign(new Error(`Invalid action: ${l}`),{code:v.INTERNAL_ERROR});if(!pe)throw Object.assign(new Error("Crypto authorize dialog not available"),{code:v.INTERNAL_ERROR});const r=pe(t.appId);if(!r)throw Object.assign(new Error("Crypto authorize dialog not available"),{code:v.INTERNAL_ERROR});const o=await r({actions:n.actions,duration:n.duration,address:n.address,chainId:n.chainId,app:{name:t.appName,icon:t.appIcon}});if(!o.approved||!o.patternKey||!o.walletId)throw Object.assign(new Error("User rejected"),{code:v.USER_REJECTED});const i=o.selectedDuration||n.duration;await N.initialize();const{token:a,sessionSecret:u}=await N.createToken({miniappId:t.appId,walletId:o.walletId,address:n.address,actions:n.actions,duration:i,patternKey:o.patternKey});return{tokenId:a.tokenId,sessionSecret:u,expiresAt:a.expiresAt,grantedActions:a.actions,address:a.address}},wr=async(e,t)=>{const n=e;if(!n?.tokenId||!n?.sessionSecret||!n?.action||!n?.params)throw Object.assign(new Error("Missing required parameters: tokenId, sessionSecret, action, params"),{code:v.INTERNAL_ERROR});return await N.initialize(),await lr.execute(n,t.appId)},yr=async(e,t)=>{const n=e;if(!n?.tokenId||!n?.sessionSecret)throw Object.assign(new Error("Missing required parameters: tokenId, sessionSecret"),{code:v.INTERNAL_ERROR});await N.initialize();const s=await N.getTokenInfo(n.tokenId,n.sessionSecret,t.appId);return{valid:s.valid,address:s.address,expiresAt:s.expiresAt,actions:s.actions,invalidReason:s.invalidReason}};let nt=!1;function Sr(){nt||(nt=!0,w.registerHandler("bio_connect",os),w.registerHandler("bio_closeSplashScreen",ns),w.registerHandler("bio_requestAccounts",is),w.registerHandler("bio_accounts",as),w.registerHandler("bio_selectAccount",cs),w.registerHandler("bio_pickWallet",us),w.registerHandler("bio_chainId",ds),w.registerHandler("bio_getBalance",ls),w.registerHandler("bio_signMessage",ps),w.registerHandler("bio_signTypedData",fs),w.registerHandler("bio_createTransaction",Rs),w.registerHandler("bio_signTransaction",Ts),w.registerHandler("bio_sendTransaction",ys),w.registerHandler("bio_destroyAsset",bs),w.registerHandler("bio_requestCryptoToken",mr),w.registerHandler("bio_cryptoExecute",wr),w.registerHandler("bio_getCryptoTokenInfo",yr),$s((e,t)=>w.registerHandler(e,t)),ir((e,t)=>w.registerHandler(e,t)))}Sr();function _e(){return w}const Wt=["accelerometer","ambient-light-sensor","aria-notify","attribution-reporting","autoplay","bluetooth","browsing-topics","camera","captured-surface-control","ch-ua-high-entropy-values","compute-pressure","cross-origin-isolated","deferred-fetch","deferred-fetch-minimal","display-capture","encrypted-media","fullscreen","gamepad","geolocation","gyroscope","hid","identity-credentials-get","idle-detection","language-detector","local-fonts","magnetometer","microphone","midi","on-device-speech-recognition","otp-credentials","payment","picture-in-picture","private-state-token-issuance","private-state-token-redemption","publickey-credentials-create","publickey-credentials-get","screen-wake-lock","serial","speaker-selection","storage-access","translator","summarizer","usb","web-share","window-management","xr-spatial-tracking","clipboard-read","clipboard-write"],Ar=new Set(Wt);function $t(e){return Ar.has(e)}function Z(e){if(!e||e.length===0)return[];const t=new Set;for(const n of e)$t(n)&&t.add(n);return t.size===0?[]:Wt.filter(n=>t.has(n))}function Er(e){if(!(!e||e.length===0))return e.join("; ")}const br=Ee(["defi","nft","tools","games","social","exchange","other"]),Ir=_n([Tn(!0),U({timeout:ce().int().positive().optional()}).passthrough()]),Rr=Ee(["auto","dark","light"]),_r=Ee(["stack","mine"]),Ft=U({id:h(),name:h(),description:h(),longDescription:h().optional(),icon:h(),url:h(),strictUrl:$e().optional(),version:h(),author:h().optional(),website:h().optional(),category:br.optional(),tags:O(h()).optional(),permissions:O(h()).optional(),permissionsPolicy:O(h()).optional(),chains:O(h()).optional(),screenshots:O(h()).optional(),minWalletVersion:h().optional(),publishedAt:h().optional(),updatedAt:h().optional(),beta:$e().optional(),officialScore:ce().min(0).max(100).optional(),communityScore:ce().min(0).max(100).optional(),splashScreen:Ir.optional(),capsuleTheme:Rr.optional(),targetDesktop:_r.optional(),themeColor:h().optional(),themeColorFrom:h().optional(),themeColorTo:h().optional()}).passthrough(),Tr=U({name:h(),version:h(),updated:h(),icon:h().optional(),search:U({urlTemplate:h()}).passthrough().optional(),apps:O(Ft)}).passthrough();U({version:h(),data:O(Ft)}).passthrough();function kr(e){const t=typeof document<"u"?document.baseURI:"file:///",n=new URL(e,t).toString();return s=>s.startsWith("http://")||s.startsWith("https://")||s.startsWith("data:")?s:new URL(s,n).toString()}const vr="ecosystem-sources",C="sources";async function Jt(){return new Promise((e,t)=>{const n=indexedDB.open(vr,1);n.onerror=()=>t(n.error),n.onsuccess=()=>e(n.result),n.onupgradeneeded=()=>{const s=n.result;s.objectStoreNames.contains(C)||s.createObjectStore(C,{keyPath:"url"})}})}async function Or(e){try{const t=await Jt();return new Promise((n,s)=>{const i=t.transaction(C,"readonly").objectStore(C).get(e);i.onerror=()=>s(i.error),i.onsuccess=()=>n(i.result??null)})}catch{return null}}async function Dr(e){try{const t=await Jt();await new Promise(n=>{const r=t.transaction(C,"readwrite").objectStore(C),o=e.url,i=r.keyPath?r.put(e):r.put(e,o);i.onerror=()=>n(),i.onsuccess=()=>n()})}catch{}}const F=300*1e3,H=new Map;function E(e,t){t?console.log(`[ecosystem] ${e}`,t):console.log(`[ecosystem] ${e}`)}function Pr(e){if(typeof window>"u")return e;const t=e.trim();if(t.length===0)return e;if(/^[a-zA-Z][a-zA-Z\d+.-]*:/.test(t))return t;if(t.startsWith("//"))return`${window.location.protocol}${t}`;try{const n=typeof document<"u"?document.baseURI:window.location.origin;return new URL(t,n).toString()}catch{return e}}function Mr(e){const t=H.get(e);return t?Date.now()>t.expiresAt?(H.delete(e),null):t.data:null}function J(e,t,n){H.set(e,{data:t,expiresAt:Date.now()+n})}function Gt(e){for(const t of H.keys())t.startsWith(e)&&H.delete(t)}async function Te(e){const t=Pr(e),n=t,s=Mr(`source:${n}`);if(s)return{payload:s};const r=await Or(n),o={};r?.etag&&(typeof window>"u"||new URL(t).origin===window.location.origin)&&(o["If-None-Match"]=r.etag);try{E("fetch source start",{url:e,fetchUrl:t});const i=await fetch(t,{headers:o});if(i.status===304&&r)return E("fetch source not modified",{url:e,fetchUrl:t}),J(`source:${n}`,r.data,F),{payload:r.data};if(!i.ok){const f=`HTTP ${i.status}`;return E("fetch source failed",{url:e,fetchUrl:t,status:i.status}),r?(J(`source:${n}`,r.data,F),{payload:r.data,errorMessage:f}):{payload:null,errorMessage:f}}const a=i.headers.get("content-type")??"";let u;try{u=await i.json()}catch(f){const y=f instanceof Error?f.message:String(f);return E("fetch source parse error",{url:e,fetchUrl:t,contentType:a,message:y}),r?{payload:r.data,errorMessage:y}:{payload:null,errorMessage:y}}const d=Tr.safeParse(u);if(!d.success){const f="Invalid source payload";return E("fetch source invalid payload",{url:e,fetchUrl:t,issues:d.error.issues.map(y=>y.path.join("."))}),r?{payload:r.data,errorMessage:f}:{payload:null,errorMessage:f}}const l=d.data,g=i.headers.get("etag")??void 0;return await Dr({url:n,data:l,etag:g,cachedAt:Date.now()}),J(`source:${n}`,l,F),E("fetch source success",{url:e,fetchUrl:t,apps:l.apps?.length??0}),{payload:l}}catch(i){const a=i instanceof Error?i.message:String(i);return E("fetch source error",{url:e,fetchUrl:t,message:a}),r?(J(`source:${n}`,r.data,F),{payload:r.data,errorMessage:a}):{payload:null,errorMessage:a}}}let j=[];const X=new Map,G=[];function Yt(){const e=[...j];G.forEach(t=>t(e))}function st(e){if(e.length===0)return 0;if(e.length===1)return e[0]??0;const t=e.reduce((u,d)=>u+d,0)/e.length,n=e.reduce((u,d)=>u+Math.pow(d-t,2),0)/Math.max(1,e.length-1),s=Math.sqrt(n),r=s>0?s:1,o=.05;let i=0,a=0;for(const u of e){const d=(u-t)/r,l=Math.exp(-.5*d*d),g=Math.max(o,l);i+=u*g,a+=g}return a===0?t:i/a}function Zt(e,t){const n=[],s=new Map,r=new Map,o=new Map;for(const i of e){const a=t.get(i.url);if(a)for(const u of a.apps??[]){const d=jr(u,i,a);if(!d)continue;const l=d.id,g=s.get(l);if(g===void 0?(s.set(l,n.length),n.push(d)):n[g]=d,typeof d.officialScore=="number"){const f=r.get(l)??[];f.push(d.officialScore),r.set(l,f)}if(typeof d.communityScore=="number"){const f=o.get(l)??[];f.push(d.communityScore),o.set(l,f)}}}for(const[i,a]of s){const u=n[a];if(!u)continue;const d=r.get(i);d&&d.length>0&&(u.officialScore=st(d));const l=o.get(i);l&&l.length>0&&(u.communityScore=st(l))}return E("merge apps",{sources:e.length,apps:n.length}),n}function Nr(e){return G.push(e),()=>{const t=G.indexOf(e);t>=0&&G.splice(t,1)}}function Cr(e){return/^[a-z0-9]+(?:\.[a-z0-9-]+)+$/i.test(e)}function jr(e,t,n){if(!Cr(e.id))return null;const s=kr(t.url),r=Z(e.permissionsPolicy??[]);if((e.permissionsPolicy?.length??0)>0){const o=(e.permissionsPolicy??[]).filter(i=>!$t(i));o.length>0&&E("unknown permissions policy directives",{appId:e.id,directives:o})}return{...e,permissionsPolicy:r,icon:s(e.icon),url:s(e.url),screenshots:e.screenshots?.map(s),splashScreen:e.splashScreen,sourceUrl:t.url,sourceName:t.name,sourceIcon:t.icon??(n.icon?s(n.icon):void 0)}}async function xr(e){return(await Te(e)).payload}async function Q(){const e=te.getEnabledSources(m.state);e.length===0&&E("no enabled sources"),await Promise.all(e.map(async t=>{const n=await xr(t.url);X.set(t.url,n),j=Zt(e,X),Yt()}))}function Lr(e){return e.map(t=>`${t.url}|${t.enabled?"1":"0"}`).sort().join(",")}let rt="";m.subscribe(()=>{const e=Lr(m.state.sources);e!==rt&&(rt=e,Q())});async function qi(e){await Q(),e?.refresh===!0&&Ur({force:!1})}async function Ur(e){const t=e?.force===!0,n=te.getEnabledSources(m.state);return n.length===0&&E("refresh skipped: no enabled sources"),t&&Gt("source:"),await Promise.all(n.map(async s=>{I.updateSourceStatus(s.url,"loading");const r=await Te(s.url);X.set(s.url,r.payload),r.errorMessage?I.updateSourceStatus(s.url,"error",r.errorMessage):r.payload?I.updateSourceStatus(s.url,"success"):I.updateSourceStatus(s.url,"error","Failed to fetch source"),j=Zt(n,X),Yt()})),[...j]}async function Ki(e){I.updateSourceStatus(e,"loading"),Gt(`source:${e}`);const t=await Te(e);if(t.errorMessage){I.updateSourceStatus(e,"error",t.errorMessage),await Q();return}if(t.payload){I.updateSourceStatus(e,"success"),await Q();return}I.updateSourceStatus(e,"error","Failed to fetch source")}function Vi(){return[...j]}function Wi(e){return j.find(t=>t.id===e)}const ke=new Map,fe=new Set;function ge(e,t){const n=`${e}:${t}`;return ke.get(n)??null}function Xt(e){return fe.add(e),()=>fe.delete(e)}function Qt(){fe.forEach(e=>e())}const ve=new Map,Oe=new Map,De=new Map,Pe=new Map;let en=null,tn=null;const Me=new Map,Ne=new Map,z=new Map;function Hr(e,t){ve.set(e,t)}function zr(e,t){Oe.set(e,t)}function Br(e){ve.delete(e),Oe.delete(e)}function Ce(e){return ve.get(e)??null}function qr(e){return Oe.get(e)??null}function Kr(e,t){De.set(e,t)}function Vr(e){De.delete(e)}function Wr(e){return De.get(e)??null}function $r(e,t){Pe.set(e,t)}function Fr(e){Pe.delete(e)}function Jr(e){return Pe.get(e)??null}function Gr(e){en=e}function Yr(){return en}function Zr(e){tn=e}function Xr(){return tn}function nn(e,t){Me.set(e,t)}function sn(e){Me.delete(e)}function je(e){return Me.get(e)??null}function rn(e){const t=je(e);if(!t)return null;const n=t.closest(".swiper-slide");if(n&&!n.classList.contains("swiper-slide-active"))return null;const s=t.getBoundingClientRect();return s.width<=0||s.height<=0?null:s}function Qr(e,t){Ne.set(e,t)}function eo(e){Ne.delete(e)}function to(e){return Ne.get(e)??null}function no(e,t,n){const s=z.get(e)??new Map;s.set(t,n),z.set(e,s);const r=`${e}:${t}`;ke.set(r,"ready"),Qt()}function so(e,t){const n=z.get(e);if(!n)return;n.delete(t),n.size===0&&z.delete(e);const s=`${e}:${t}`;ke.set(s,"lost"),Qt()}function on(e,t){return z.get(e)?.get(t)??null}function an(e,t){const n=on(e,t);if(!n)return null;const s=n.closest(".swiper-slide");if(s&&!s.classList.contains("swiper-slide-active"))return null;const r=n.getBoundingClientRect();return r.width<=0||r.height<=0?null:r}function ro(e){nn("stack",e)}function oo(){sn("stack")}function io(){return je("stack")}function ao(){return rn("stack")}function co(e,t){if(!e||e==="preparing"){if(t==="launching")return"opening";if(t==="splash")return"splash";if(t==="active")return"opened"}return e==="launching"&&t==="splash"?"splash":(e==="launching"||e==="splash")&&t==="active"?"opened":e==="active"&&t==="background"?"backgrounding":e==="background"&&t==="active"?"foregrounding":t==="closing"?"closing":t==="preparing"?"closed":t==="launching"?"opening":t==="splash"?"splash":t==="active"?"opened":t==="background"?"backgrounded":"closed"}function uo(e,t){const n=e.presentations.get(t),s=e.apps.get(t);return n?.desktop??s?.manifest.targetDesktop??"stack"}function lo(e,t,n){const s=e.apps.get(t);if(!s)return{nextState:e,changed:!1,domCommand:null};const r=co(s.state,n),o=new Map(e.apps);o.set(t,{...s,state:n,flow:r});const i={...e,apps:o},a={type:"slot:interactive",desktop:uo(e,t),appId:t,interactive:n==="active"};return{nextState:i,changed:!0,domCommand:a}}function po(e,t,n){const s=e.apps.get(t);if(!s||s.processStatus===n)return e;const r=new Map(e.apps);return r.set(t,{...s,processStatus:n}),{...e,apps:r}}function fo(e,t,n){const s=e.apps.get(t);if(!s||s.readiness===n)return e;const r=new Map(e.apps);return r.set(t,{...s,readiness:n}),{...e,apps:r}}function go(e,t){const n=new Set(t),s=[],r=[];return e.forEach(o=>{n.has(o)?s.push(o):r.push(o)}),{foregroundAppIds:s,backgroundAppIds:r}}function ho(e){if(e.type==="slot:interactive"){if(!_.isStackRegistered(e.desktop))return;_.setSlotInteractive(e.desktop,e.appId,e.interactive)}}function mo(e,t){const n=e.containerHandle;if(!n||n.type!=="iframe")return;const s=t?.desktop??e.manifest.targetDesktop??"stack";if(!_.isStackRegistered(s))return;const r=_.getSlot(s,e.appId)??_.getOrCreateSlot(s,e.appId);n.setMountTarget?.(r)}const ot="__rv";function wo(e){const t=e.version.trim();if(t.length>0)return`v:${t}`;const n=e.updatedAt?.trim();return n&&n.length>0?`u:${n}`:null}function yo(e,t){const n=t?{...t}:{};if(e.strictUrl===!0)return Object.keys(n).length===0?void 0:n;if(!(ot in n)){const s=wo(e);s&&(n[ot]=s)}if(Object.keys(n).length!==0)return n}async function So(){return D(()=>Promise.resolve().then(()=>ui),void 0,import.meta.url)}function Ao(){gt.useEffect(()=>{So().then(({miniappRuntimeStore:e,activateApp:t})=>{const{activeAppId:n}=e.state;n&&t(n)})})}function Eo(e,t){return gt.useSyncExternalStore(Xt,()=>ge(e,t),()=>ge(e,t))}const ie=R.t.bind(R),bo={apps:new Map,visualConfig:yt,activeAppId:null,focusedAppId:null,presentations:new Map,zOrderSeed:1,isStackViewOpen:!1,maxBackgroundApps:4};function xe(e){const t=p.state.apps.get(e);if(!t)return;const n=t.containerHandle?.getIframe()??t.iframeRef;n&&(Le(n,K(t.manifest)),_e().attach(n,e,t.manifest.name,t.manifest.permissions??[]))}function cn(e,t,n){const s=t.getIframe();s&&(Le(s,K(n)),_e().attach(s,e,n.name,n.permissions??[]),he(s))}function K(e){const t=Z(e.permissionsPolicy??[]);return Er(t)}function Le(e,t){t?e.setAttribute("allow",t):e.removeAttribute("allow")}function it(e,t){if(e.length!==t.length)return!1;for(let n=0;n<e.length;n+=1)if(e[n]!==t[n])return!1;return!0}function Io(e,t){if(e.version!==t.version||e.updatedAt!==t.updatedAt||e.url!==t.url||(e.runtime??"iframe")!==(t.runtime??"iframe")||JSON.stringify(e.wujieConfig??{})!==JSON.stringify(t.wujieConfig??{}))return!0;const n=e.permissions??[],s=t.permissions??[];if(!it(n,s))return!0;const r=Z(e.permissionsPolicy??[]),o=Z(t.permissionsPolicy??[]);return!it(r,o)}function Ro(e){if(e.length===0)return;const t=new Map(e.map(s=>[s.id,s])),n=[];p.setState(s=>{let r=!1;const o=new Map(s.apps);for(const[i,a]of o.entries()){const u=t.get(i);u&&Io(a.manifest,u)&&(r=!0,o.set(i,{...a,manifest:u}),n.push({appId:i,allow:K(u)}))}return r?{...s,apps:o}:s}),n.forEach(s=>{const r=p.state.apps.get(s.appId);if(!r)return;const o=r.containerHandle?.getIframe()??r.iframeRef;o&&Le(o,s.allow),xe(s.appId)})}const _o=1,To={top:0,right:0,bottom:0,left:0};function ko(){if(typeof document>"u"||!document.body)return{...To};const e=document.createElement("div");e.style.cssText="position:fixed;inset:0;padding:env(safe-area-inset-top,0px) env(safe-area-inset-right,0px) env(safe-area-inset-bottom,0px) env(safe-area-inset-left,0px);visibility:hidden;pointer-events:none;",document.body.appendChild(e);const t=getComputedStyle(e),n={top:Number.parseFloat(t.paddingTop)||0,right:Number.parseFloat(t.paddingRight)||0,bottom:Number.parseFloat(t.paddingBottom)||0,left:Number.parseFloat(t.paddingLeft)||0};return document.body.removeChild(e),n}function vo(){const e=ko(),t=Math.max(e.top,8);return{...e,top:t+32+8}}function un(){const e=document?.documentElement?.classList.contains("dark")?"dark":"light",t=R.language||document?.documentElement?.lang||(typeof navigator<"u"?navigator.language:"en"),n=typeof R.dir=="function"?R.dir(t):document?.documentElement?.dir||"ltr",s=Dn()?"dweb":"web";return{version:_o,env:{safeAreaInsets:vo(),platform:s,locale:t,direction:n},host:{name:"KeyApp",version:"1.0.2-021603"},updatedAt:new Date().toISOString(),theme:{colorMode:e}}}function he(e,t){const n={type:"keyapp:context-update",requestId:t,payload:un()};e.contentWindow?.postMessage(n,"*")}function Oo(e){if(!e)return null;for(const t of p.state.apps.values()){const n=t.containerHandle?.getIframe()??t.iframeRef;if(n?.contentWindow===e)return n}return null}function Do(e){const t=e.data;if(!t||t.type!=="keyapp:context-request"&&t.type!=="miniapp:context-request")return;const n=t.type==="miniapp:context-request"?t.requestId:void 0,s=Oo(e.source);if(s){he(s,n);return}const r=t.payload?.appId;if(!r)return;const o=p.state.apps.get(r),i=o?.containerHandle?.getIframe()??o?.iframeRef;i&&he(i,n)}let at=null;function Po(e){return JSON.stringify({env:e.env,host:e.host,theme:e.theme})}function Mo(){const e=un(),t=Po(e);t!==at&&(at=t,p.state.apps.forEach(n=>{const s=n.containerHandle?.getIframe()??n.iframeRef;s&&s.contentWindow?.postMessage({type:"keyapp:context-update",payload:e},"*")}))}let ct=!1;function No(){if(ct||typeof window>"u")return;ct=!0;const e=()=>{Mo()};window.addEventListener("resize",e),window.addEventListener("orientationchange",e),window.visualViewport?.addEventListener("resize",e),R.on("languageChanged",e),typeof document<"u"&&new MutationObserver(e).observe(document.documentElement,{attributes:!0,attributeFilter:["class","data-theme"]})}let ut=!1;function Co(){ut||(ut=!0,window.addEventListener("message",Do))}let dt=!1;function jo(){dt||(dt=!0,Nr(Ro))}const p=new ft(bo);Co();No();jo();function dn(e){p.setState(t=>({...t,visualConfig:qn(t.visualConfig,e)}))}function xo(e){dn({motion:{timeScale:e}})}function Lo(){p.setState(e=>({...e,visualConfig:yt}))}const me=new Set;function T(e){me.forEach(t=>t(e))}let lt=0;function ln(e,t){return lt+=1,{id:`${e}:${t}:${Date.now()}:${lt}`,kind:e,status:"requested",startedAt:Date.now()}}function Uo(e){const t=e.splashScreen;return t?typeof t=="object"&&typeof t.timeout=="number"?t.timeout:5e3:null}function x(e,t){let n=null;p.setState(s=>{const r=lo(s,e,t);return n=r.domCommand,r.nextState}),n&&ho(n),T({type:"app:state-change",appId:e,state:t})}function Ho(e,t){p.setState(n=>po(n,e,t))}function zo(e,t){p.setState(n=>fo(n,e,t))}function pn(e){zo(e,"ready");const t=p.state.apps.get(e);t&&!t.manifest.splashScreen&&(t.state==="launching"||t.state==="splash")&&re(e)}function Bo(e){switch(e){case"opening":return"opened";case"backgrounding":return"backgrounded";case"foregrounding":return"opened";default:return e}}function fn(e){p.setState(t=>{const n=t.apps.get(e);if(!n)return t;const s=Bo(n.flow);if(s===n.flow)return t;const r=new Map(t.apps);return r.set(e,{...n,flow:s}),{...t,apps:r}})}const qo={launchToSplash:100},ee=new Map,we=new Map,ye=new Map,Ko=3e4,Vo=2500,Se=new Map;function M(e){const t=Se.get(e);t&&(t.cancelled=!0,t.rafId!==null&&cancelAnimationFrame(t.rafId),Se.delete(e))}function Wo(e){if(!e)return!1;const t=e.getBoundingClientRect();return t.width>0&&t.height>0}function $o(e){return e.containerHandle?.isConnected()??!1}function ne(e){const t=we.get(e);t&&(clearTimeout(t),we.delete(e))}function Ue(e,t,n){p.setState(s=>{const o=s.presentations.get(e)??{appId:e,desktop:t,state:"hidden",zOrder:s.zOrderSeed,transitionId:null,transitionKind:null},i={...o,...n,appId:e,desktop:n.desktop??o.desktop},a=new Map(s.presentations);return a.set(e,i),{...s,presentations:a}})}function gn(e){p.setState(t=>{const n=t.presentations.get(e),s=t.zOrderSeed+1,r=new Map(t.presentations);return n&&r.set(e,{...n,zOrder:s}),{...t,activeAppId:e,focusedAppId:e,presentations:r,zOrderSeed:s}})}function Fo(e,t){const n=p.state.presentations.get(e);n&&(n.transitionKind!=="present"||n.transitionId!==t||Ue(e,n.desktop,{state:"presented",transitionId:null,transitionKind:null}))}function Jo(e,t){const n=p.state.presentations.get(e);if(!n||n.transitionKind!=="dismiss"||n.transitionId!==t)return;const s=p.state.apps.get(e);!s||s.state!=="closing"||se(e)}function He(e){ne(e),pn(e),re(e)}function ae(e,t){M(e);const n=p.state.apps.get(e);n?.containerHandle&&n.containerHandle.destroy(),p.setState(s=>{const r=new Map(s.apps);r.delete(e);const o=new Map(s.presentations);return o.delete(e),{...s,apps:r,presentations:o,activeAppId:s.activeAppId===e?null:s.activeAppId,focusedAppId:s.focusedAppId===e?null:s.focusedAppId}}),kn.show({message:t,duration:2e3})}function hn(e,t){if(x(e,"launching"),ze(e),t){const n=setTimeout(()=>{const s=p.state.apps.get(e);if(!s||s.state!=="launching")return;x(e,"splash"),ne(e);const r=Uo(s.manifest);r!==null&&we.set(e,setTimeout(()=>{const o=p.state.apps.get(e);o&&o.state==="splash"&&He(e)},r))},qo.launchToSplash);ee.set(e,[n]);return}ee.set(e,[])}function Go(e,t,n){M(e);const s={cancelled:!1,rafId:null};Se.set(e,s);const r=performance.now(),o=()=>{if(s.cancelled)return;const i=p.state.apps.get(e);if(!i||i.state!=="preparing"){M(e);return}const a=Wo(Ce(e)),u=!!an(t,e),d=$o(i);if(a&&u&&d){M(e),hn(e,n);return}if(performance.now()-r>Vo){u?a?ae(e,ie("error:miniapp.launchFailed.containerNotReady")):ae(e,ie("error:miniapp.launchFailed.iconNotReady")):ae(e,ie("error:miniapp.launchFailed.stayOnDesktop"));return}s.rafId=requestAnimationFrame(o)};s.rafId=requestAnimationFrame(o)}function ze(e){const t=ee.get(e);t&&(t.forEach(n=>clearTimeout(n)),ee.delete(e))}function mn(e){const t=ye.get(e);t&&(clearTimeout(t),ye.delete(e))}function Yo(e){const t=p.state,n=t.apps.get(e);n&&mo(n,t.presentations.get(e))}function se(e){ze(e),mn(e),ne(e),M(e);const t=p.state.apps.get(e);if(!t||t.state!=="closing")return;const s=p.state.presentations.get(e)?.desktop??t.manifest.targetDesktop??"stack";p.setState(r=>{const o=r.apps.get(e);if(!o)return r;o.containerHandle&&o.containerHandle.destroy();const i=new Map(r.apps);i.delete(e);const a=new Map(r.presentations);return a.delete(e),{...r,apps:i,presentations:a,activeAppId:r.activeAppId===e?null:r.activeAppId,focusedAppId:r.focusedAppId===e?null:r.focusedAppId}}),_.isStackRegistered(s)&&_.removeSlot(s,e),p.state.apps.size===0&&_e().detach()}function wn(e){He(e)}function yn(e,t,n){const r=p.state.apps.get(e);if(r){xe(e);const A=r.manifest.targetDesktop??"stack";return Ue(e,A,{state:"presented",transitionId:null,transitionKind:null}),gn(e),re(e),r}const o=!!t.splashScreen,i=t.runtime??"iframe",a=t.targetDesktop??"stack",u=K(t),d=yo(t,n),l={appId:e,manifest:t,state:"preparing",flow:"closed",ctx:{capsuleTheme:t.capsuleTheme??"auto"},processStatus:"loading",readiness:"notReady",launchedAt:Date.now(),lastActiveAt:Date.now(),containerType:i,containerHandle:null,iframeRef:null,iconRef:Ce(e)},g=()=>{Ho(e,"loaded"),t.splashScreen||pn(e)},f=_.isStackRegistered(a);let y;if(f?y=_.getOrCreateSlot(a,e):y=document.body,i==="iframe")try{const A=Wn(i,{appId:e,url:t.url,mountTarget:y,contextParams:d,wujieConfig:t.wujieConfig,permissionsPolicyAllow:u,onLoad:g});l.containerHandle=A,A.type==="iframe"&&(l.iframeRef=A.element),cn(e,A,t)}catch(A){globalThis.console.warn("[miniapp-runtime] Sync container creation failed, falling back to async:",A),pt(l,t,d,g,y)}else pt(l,t,d,g,y);const An=ln("present",e);return p.setState(A=>{const qe=A.zOrderSeed+1,Ke=new Map(A.apps);Ke.set(e,l);const Ve=new Map(A.presentations);return Ve.set(e,{appId:e,desktop:a,state:"presenting",zOrder:qe,transitionId:An.id,transitionKind:"present"}),{...A,apps:Ke,presentations:Ve,activeAppId:e,focusedAppId:e,zOrderSeed:qe}}),T({type:"app:launch",appId:e,manifest:t}),f&&l.containerHandle!==null?hn(e,o):Go(e,a,o),l}function pt(e,t,n,s,r){const o=K(t);Vn(e.containerType,{appId:e.appId,url:t.url,mountTarget:r,contextParams:n,wujieConfig:t.wujieConfig,permissionsPolicyAllow:o,onLoad:s}).then(i=>{e.containerHandle=i,i.type==="iframe"&&(e.iframeRef=i.element),cn(e.appId,i,t)})}function Zo(e,t,n){return yn(e,t,n)}function re(e){const t=p.state,n=t.apps.get(e);if(!n||n.state==="preparing")return;const s=Array.from(t.apps.values()).filter(a=>a.state!=="preparing"&&a.state!=="closing").map(a=>a.appId),{foregroundAppIds:r,backgroundAppIds:o}=go(s,[e]);if(!r.includes(e))return;o.forEach(a=>{const u=p.state.apps.get(a);u&&u.state==="active"&&(u.containerHandle?.moveToBackground(),x(a,"background"),T({type:"app:deactivate",appId:a}))});const i=p.state.apps.get(e);i&&(i.containerHandle&&i.state==="background"&&(Yo(e),i.containerHandle.moveToForeground()),x(e,"active"),xe(e),p.setState(a=>{const u=a.zOrderSeed+1,d=new Map(a.apps),l=d.get(e);l&&d.set(e,{...l,lastActiveAt:Date.now()});const g=new Map(a.presentations),f=g.get(e);return f&&g.set(e,{...f,zOrder:u}),{...a,apps:d,presentations:g,activeAppId:e,focusedAppId:e,zOrderSeed:f?u:a.zOrderSeed}}),T({type:"app:activate",appId:e}))}function Sn(e){const t=p.state.apps.get(e);t&&t.state!=="preparing"&&(t.containerHandle?.moveToBackground(),x(e,"background"),T({type:"app:deactivate",appId:e}))}function Be(e){const n=p.state.apps.get(e);if(!n)return;ze(e),mn(e),M(e),x(e,"closing"),ne(e);const s=n.manifest.targetDesktop??"stack",r=ln("dismiss",e);Ue(e,s,{state:"dismissing",transitionId:r.id,transitionKind:"dismiss"}),ye.set(e,setTimeout(()=>{const o=p.state.presentations.get(e);o&&(o.transitionKind!=="dismiss"||o.transitionId!==r.id||se(e))},Ko)),T({type:"app:close",appId:e})}function Xo(e){Be(e)}function Qo(e,t){const s=p.state.apps.get(e);if(!s)return;const r={...s.ctx,...t};p.setState(o=>{const i=new Map(o.apps),a=i.get(e);return a&&i.set(e,{...a,ctx:r}),{...o,apps:i}}),T({type:"app:ctx-change",appId:e,ctx:r})}function ei(){p.state.apps.forEach((t,n)=>{Be(n),se(n)}),In()}function ti(){const e=p.state,t=new Set;e.activeAppId&&t.add(e.activeAppId),e.focusedAppId&&t.add(e.focusedAppId),t.forEach(n=>{Sn(n),fn(n)}),p.setState(n=>!n.activeAppId&&!n.focusedAppId?n:{...n,activeAppId:null,focusedAppId:null})}function ni(){p.setState(e=>({...e,isStackViewOpen:!0})),T({type:"stack-view:open"})}function si(){p.setState(e=>({...e,isStackViewOpen:!1})),T({type:"stack-view:close"})}function ri(e){return me.add(e),()=>me.delete(e)}function oi(){return Array.from(p.state.apps.values())}function ii(){const e=p.state;return e.activeAppId?e.apps.get(e.activeAppId)??null:null}function ai(){return p.state.apps.size>0}const ci={getApps:e=>Array.from(e.apps.values()),getVisualConfig:e=>e.visualConfig,getActiveApp:e=>e.activeAppId?e.apps.get(e.activeAppId)??null:null,getFocusedAppId:e=>e.focusedAppId??e.activeAppId,getFocusedApp:e=>{const t=e.focusedAppId??e.activeAppId;return t?e.apps.get(t)??null:null},getPresentations:e=>Array.from(e.presentations.values()).sort((t,n)=>t.zOrder-n.zOrder),getPresentation:(e,t)=>e.presentations.get(t)??null,hasPresentations:e=>e.presentations.size>0,hasRunningApps:e=>e.apps.size>0,hasRunningStackApps:e=>Array.from(e.apps.values()).some(t=>(t.manifest.targetDesktop??"stack")==="stack"),isStackViewOpen:e=>e.isStackViewOpen,getBackgroundApps:e=>Array.from(e.apps.values()).filter(t=>t.state==="background"),isLaunchOverlayVisible:e=>{const t=e.focusedAppId??e.activeAppId?e.apps.get(e.focusedAppId??e.activeAppId):null;return t?.state==="launching"||t?.state==="splash"},isShowingSplash:e=>(e.focusedAppId??e.activeAppId?e.apps.get(e.focusedAppId??e.activeAppId):null)?.state==="splash",isAnimating:e=>{const t=e.focusedAppId??e.activeAppId?e.apps.get(e.focusedAppId??e.activeAppId):null;return t?.state==="launching"||t?.state==="splash"||t?.state==="closing"}},ui=Object.freeze(Object.defineProperty({__proto__:null,activateApp:re,closeAllApps:ei,closeApp:Be,closeStackView:si,deactivateApp:Sn,didDismiss:Jo,didPresent:Fo,dismissSplash:wn,finalizeCloseApp:se,getActiveApp:ii,getDesktopAppSlotRect:an,getDesktopAppSlotRef:on,getDesktopContainerRef:je,getDesktopGridHostRef:to,getDesktopRect:rn,getIconInnerRef:qr,getIconRef:Ce,getRunningApps:oi,getSlotStatus:ge,getSplashBgRef:Wr,getSplashIconRef:Jr,getStackContainerRef:io,getStackRect:ao,getWindowInnerRef:Xr,getWindowRef:Yr,hasRunningApps:ai,launchApp:yn,miniappRuntimeSelectors:ci,miniappRuntimeStore:p,minimizeAllApps:ti,openStackView:ni,registerDesktopAppSlotRef:no,registerDesktopContainerRef:nn,registerDesktopGridHostRef:Qr,registerIconInnerRef:zr,registerIconRef:Hr,registerSplashBgRef:Kr,registerSplashIconRef:$r,registerStackContainerRef:ro,registerWindowInnerRef:Zr,registerWindowRef:Gr,requestDismiss:Xo,requestDismissSplash:He,requestFocus:gn,requestPresent:Zo,resetMiniappVisualConfig:Lo,setMiniappMotionTimeScale:xo,setMiniappVisualConfig:dn,settleFlow:fn,subscribe:ri,subscribeSlotStatus:Xt,unregisterDesktopAppSlotRef:so,unregisterDesktopContainerRef:sn,unregisterDesktopGridHostRef:eo,unregisterIconRef:Br,unregisterSplashBgRef:Vr,unregisterSplashIconRef:Fr,unregisterStackContainerRef:oo,updateAppContext:Qo,useMiniappVisibilityRestore:Ao,useSlotStatus:Eo},Symbol.toStringTag,{value:"Module"}));export{Hi as $,Zr as A,Xo as B,He as C,yt as D,Jo as E,Qr as F,eo as G,no as H,so as I,I as J,Nr as K,qi as L,Vi as M,ji as N,gr as O,hr as P,Sr as Q,_e as R,Oi as S,fr as T,Di as U,Pi as V,Mi as W,Ni as X,Ci as Y,xi as Z,Ui as _,Ti as a,zi as a0,Li as a1,Bi as a2,Ur as a3,Ki as a4,te as a5,Wi as a6,ki as a7,vi as a8,ci as b,ei as c,p as d,m as e,ti as f,_i as g,si as h,nn as i,sn as j,Hr as k,yn as l,qn as m,zr as n,ni as o,Br as p,ro as q,Lo as r,xo as s,oo as t,Ao as u,Eo as v,on as w,Fo as x,fn as y,Gr as z};
