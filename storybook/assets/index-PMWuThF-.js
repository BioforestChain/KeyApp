const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./web-DnZPwNCZ.js","./chain-config-DqVXGLIz.js","./preload-helper-PPVm8Dsz.js","./index-D0E7N0oa.js","./bioforest-uXX5qE5N.js","./schemas-BX8BzOgD.js","./iframe-Cctxta_P.js","./iframe-BqSeQW3N.css","./address-format-DY2duW3A.js","./breakpoint-wIg8UP9C.js"])))=>i.map(i=>d[i]);
import{t as Xe}from"./web-DnZPwNCZ.js";import{_ as le}from"./preload-helper-PPVm8Dsz.js";import{S as ue,r as de}from"./iframe-Cctxta_P.js";import{A as et}from"./amount-BQsqQYGO.js";import{e as tt,f as k,c as nt,g as st,w as it}from"./chain-config-DqVXGLIz.js";import{g as pe}from"./index-Ar-6A-5n.js";import{h as rt,c as at,p as ot}from"./bioforest-uXX5qE5N.js";import"./index-D0E7N0oa.js";import{p as ct,g as lt,t as ut,E as dt}from"./index-Ddwf1R_9.js";const ge={motion:{timeScale:1,layoutDuration:.45,uiFastDuration:.15,layoutEase:[.4,0,.1,1],spring:{stiffness:220,damping:28,mass:.85}},css:{}};function B(e){return!Number.isFinite(e)||e<=0?1:e}function E(e,t){const n=B(t);return e/n}function ie(e,t,n){const s=B(t);return e*Math.pow(s,n)}function pt(e,t){return t?{motion:{...e.motion,...t.motion??{},spring:{...e.motion.spring,...t.motion?.spring??{}}},css:{...e.css,...t.css??{}}}:e}const re=new WeakMap,ae=new WeakMap;function Hs(e){const t=re.get(e);if(t)return t;const{motion:n}=e,s={type:"spring",stiffness:ie(n.spring.stiffness,n.timeScale,2),damping:ie(n.spring.damping,n.timeScale,1),mass:n.spring.mass},r={layout:{duration:E(n.layoutDuration,n.timeScale),ease:n.layoutEase}},o={duration:E(n.uiFastDuration,n.timeScale),ease:"easeOut"},l={motionConfig:s,sharedLayout:r,uiFast:o};return re.set(e,l),l}function Bs(e){const t=ae.get(e);if(t)return t;const{motion:n}=e,s={"--miniapp-motion-time-scale":String(B(n.timeScale)),"--miniapp-motion-layout-duration":`${E(n.layoutDuration,n.timeScale)}s`,"--miniapp-motion-ui-fast-duration":`${E(n.uiFastDuration,n.timeScale)}s`,"--miniapp-motion-layout-ease":`cubic-bezier(${n.layoutEase.join(",")})`};return ae.set(e,s),s}const gt=4,q="miniapp-iframe-container",fe="miniapp-hidden-container";function V(e,t){let n=document.getElementById(e);return n||(n=document.createElement("div"),n.id=e,t&&(n.style.cssText=`
        position: fixed;
        top: -9999px;
        left: -9999px;
        width: 1px;
        height: 1px;
        overflow: hidden;
        visibility: hidden;
        pointer-events: none;
      `),document.body.appendChild(n)),n}function ft(e,t,n){const s=document.createElement("iframe");s.id=`miniapp-iframe-${e}`,s.dataset.appId=e;const i=new URL(t,window.location.origin);return n&&Object.entries(n).forEach(([r,o])=>{i.searchParams.set(r,o)}),s.src=i.toString(),s.sandbox.add("allow-scripts","allow-forms","allow-same-origin"),s.style.cssText=`
    width: 100%;
    height: 100%;
    border: none;
    background: transparent;
  `,s}function ht(e){V(q,!1).appendChild(e)}function mt(e){V(fe,!0).appendChild(e)}function wt(e){V(q,!1).appendChild(e)}function W(e){e.src="about:blank",e.remove()}function At(e,t,n=gt){const s=[],i=Array.from(e.values()).filter(r=>r.appId!==t&&r.state==="background").sort((r,o)=>r.lastActiveAt-o.lastActiveAt);for(;i.length>n;){const r=i.shift();r?.iframeRef&&(W(r.iframeRef),r.iframeRef=null,s.push(r.appId))}return s}function St(){const e=document.getElementById(q),t=document.getElementById(fe);e&&(e.innerHTML="",e.remove()),t&&(t.innerHTML="",t.remove())}const qs={bio_requestAccounts:{id:"bio_requestAccounts",name:"请求账户",description:"获取您的钱包地址列表",risk:"low"},bio_selectAccount:{id:"bio_selectAccount",name:"选择账户",description:"让您选择一个账户",risk:"low"},bio_pickWallet:{id:"bio_pickWallet",name:"选择钱包",description:"让您选择一个钱包",risk:"low"},bio_createTransaction:{id:"bio_createTransaction",name:"创建交易",description:"构造未签名交易（不做签名/不做广播）",risk:"low"},bio_signMessage:{id:"bio_signMessage",name:"签名消息",description:"使用您的私钥签名消息（需要您确认）",risk:"medium"},bio_signTypedData:{id:"bio_signTypedData",name:"签名数据",description:"签名结构化数据（需要您确认）",risk:"medium"},bio_signTransaction:{id:"bio_signTransaction",name:"签名交易",description:"对未签名交易进行签名（需要您确认）",risk:"high"},bio_sendTransaction:{id:"bio_sendTransaction",name:"发送交易",description:"请求发送转账（需要您确认）",risk:"high"}},a={USER_REJECTED:4001,UNAUTHORIZED:4100,UNSUPPORTED_METHOD:4200,INTERNAL_ERROR:-32603,INVALID_PARAMS:-32602,METHOD_NOT_FOUND:-32601};function oe(e,t,n,s){return{type:"bio_response",id:e,success:!1,error:{code:t,message:n,data:s}}}const P=["discover","mine"],he="ecosystem_store";function bt(){try{const e=localStorage.getItem(he);if(e){const t=JSON.parse(e),n=Array.isArray(t.availableSubPages)&&t.availableSubPages.length>0?t.availableSubPages:P,s=t.activeSubPage??"discover",i=n.includes(s)?n:[...n,s];return{permissions:t.permissions??[],sources:t.sources??[{url:"./miniapps/ecosystem.json",name:"Bio 官方生态",lastUpdated:new Date().toISOString(),enabled:!0}],availableSubPages:i,activeSubPage:s,swiperProgress:0,syncSource:null}}}catch{}return{permissions:[],sources:[{url:"./miniapps/ecosystem.json",name:"Bio 官方生态",lastUpdated:new Date().toISOString(),enabled:!0}],availableSubPages:P,activeSubPage:"discover",swiperProgress:0,syncSource:null}}function Rt(e){try{localStorage.setItem(he,JSON.stringify(e))}catch{}}const p=new ue(bt());p.subscribe(()=>{Rt(p.state)});const me={getGrantedPermissions:(e,t)=>e.permissions.find(n=>n.appId===t)?.granted??[],hasPermission:(e,t,n)=>me.getGrantedPermissions(e,t).includes(n),getEnabledSources:e=>e.sources.filter(t=>t.enabled)},Et={grantPermissions:(e,t)=>{p.setState(n=>{const s=n.permissions.find(i=>i.appId===e);if(s){const i=[...new Set([...s.granted,...t])];return{...n,permissions:n.permissions.map(r=>r.appId===e?{...r,granted:i,grantedAt:Date.now()}:r)}}else return{...n,permissions:[...n.permissions,{appId:e,granted:t,grantedAt:Date.now()}]}})},revokePermissions:(e,t)=>{p.setState(n=>t?{...n,permissions:n.permissions.map(s=>s.appId===e?{...s,granted:s.granted.filter(i=>!t.includes(i))}:s)}:{...n,permissions:n.permissions.filter(s=>s.appId!==e)})},addSource:(e,t)=>{p.setState(n=>n.sources.some(s=>s.url===e)?n:{...n,sources:[...n.sources,{url:e,name:t,lastUpdated:new Date().toISOString(),enabled:!0}]})},removeSource:e=>{p.setState(t=>({...t,sources:t.sources.filter(n=>n.url!==e)}))},toggleSource:e=>{p.setState(t=>({...t,sources:t.sources.map(n=>n.url===e?{...n,enabled:!n.enabled}:n)}))},updateSourceTimestamp:e=>{p.setState(t=>({...t,sources:t.sources.map(n=>n.url===e?{...n,lastUpdated:new Date().toISOString()}:n)}))},setActiveSubPage:e=>{p.setState(t=>({...t,activeSubPage:e}))},setAvailableSubPages:e=>{p.setState(t=>{const n=e.length>0?e:P,s=n.includes(t.activeSubPage)?t.activeSubPage:n[0]??"mine";return{...t,availableSubPages:n,activeSubPage:s}})},setSwiperProgress:e=>{p.setState(t=>({...t,swiperProgress:e}))},setSyncSource:e=>{p.setState(t=>({...t,syncSource:e}))}},_t=["bio_requestAccounts","bio_signMessage","bio_signTypedData","bio_signTransaction","bio_sendTransaction"];function we(e){return _t.includes(e)}function Tt(e,t){return we(t)?me.hasPermission(p.state,e,t):!0}function yt(e,t){Et.grantPermissions(e,t)}class It{handlers=new Map;iframe=null;appId="";appName="";origin="*";manifestPermissions=[];messageHandler=null;permissionRequestCallback=null;registerHandler(t,n){this.handlers.set(t,n)}setPermissionRequestCallback(t){this.permissionRequestCallback=t}attach(t,n,s,i=[]){this.detach(),this.iframe=t,this.appId=n,this.appName=s,this.manifestPermissions=i;try{const r=new URL(t.src,window.location.origin);this.origin=r.origin}catch{this.origin="*"}this.messageHandler=this.handleMessage.bind(this),window.addEventListener("message",this.messageHandler),console.log("[BioProvider] Attached to iframe:",n)}detach(){this.messageHandler&&(window.removeEventListener("message",this.messageHandler),this.messageHandler=null),this.iframe=null,this.appId="",this.appName="",this.manifestPermissions=[]}emit(t,...n){this.emitTo("bio",t,...n)}emitEth(t,...n){this.emitTo("eth",t,...n)}emitTron(t,...n){this.emitTo("tron",t,...n)}emitTo(t,n,...s){if(!this.iframe?.contentWindow)return;const i={type:`${t}_event`,event:n,args:s};this.iframe.contentWindow.postMessage(i,this.origin)}handleMessage(t){if(this.origin!=="*"&&t.origin!==this.origin||t.source!==this.iframe?.contentWindow)return;const n=t.data;!n||typeof n!="object"||!("type"in n)||(n.type==="bio_request"?this.processRequest(n,"bio"):n.type==="eth_request"?this.processRequest(n,"eth"):n.type==="tron_request"&&this.processRequest(n,"tron"))}async processRequest(t,n){const{id:s,method:i,params:r}=t;console.log(`[BioProvider] ${n.toUpperCase()} Request:`,i,r);const o=this.handlers.get(i);if(!o){this.sendResponse(n,{type:`${n}_response`,id:s,success:!1,error:{code:a.METHOD_NOT_FOUND,message:`Method not found: ${i}`}});return}if(!(n!=="bio"||["bio_connect","bio_closeSplashScreen"].includes(i))){const d=["bio_accounts","bio_selectAccount","bio_pickWallet"].includes(i)&&this.manifestPermissions.includes("bio_requestAccounts"),f=d?"bio_requestAccounts":i;if(!(this.manifestPermissions.includes(i)||i==="bio_requestAccounts"||d)){this.sendResponse(n,oe(s,a.UNAUTHORIZED,`Permission not declared in manifest: ${i}`));return}if(we(f)&&!Tt(this.appId,f)&&!await this.requestPermission([f])){this.sendResponse(n,oe(s,a.USER_REJECTED,"Permission denied by user"));return}}try{const g=c.state.apps.get(this.appId)?.manifest.icon,d={appId:this.appId,appName:this.appName,appIcon:g,origin:this.origin,permissions:this.manifestPermissions},f=await o(r?.[0],d);this.sendResponse(n,{type:`${n}_response`,id:s,success:!0,result:f})}catch(g){const d=g instanceof Error?g.message:"Unknown error",f=g.code??a.INTERNAL_ERROR;this.sendResponse(n,{type:`${n}_response`,id:s,success:!1,error:{code:f,message:d}})}}async requestPermission(t){if(!this.permissionRequestCallback)return console.warn("[BioProvider] No permission request callback set"),!1;try{const n=await this.permissionRequestCallback(this.appId,this.appName,t);return n&&yt(this.appId,t),n}catch(n){return console.error("[BioProvider] Permission request failed:",n),!1}}sendResponse(t,n){this.iframe?.contentWindow&&(console.log(`[BioProvider] ${t.toUpperCase()} Response:`,n),this.iframe.contentWindow.postMessage(n,this.origin))}}const u=new It,w=new Map,h={register(e,t){w.set(e,t),console.log("[HandlerContext] Registered callbacks for:",e)},unregister(e){w.delete(e),console.log("[HandlerContext] Unregistered callbacks for:",e)},get(e){return w.get(e)},has(e){return w.has(e)},getRegisteredApps(){return Array.from(w.keys())},clear(){w.clear()}},vt=async(e,t)=>{Ze(t.appId)};let Ae=null,Se=null;function Vs(e){Ae=e}function Ws(e){Se=e}function x(e){return h.get(e)?.showWalletPicker??Ae}function Dt(e){return h.get(e)?.getConnectedAccounts??Se}const kt=async(e,t)=>({connected:!0}),Ot=async(e,t)=>{const n=x(t.appId);if(!n)throw Object.assign(new Error("Wallet picker not available"),{code:a.INTERNAL_ERROR});const s=await n();if(!s)throw Object.assign(new Error("User rejected"),{code:a.USER_REJECTED});return[s]},Pt=async(e,t)=>{const n=Dt(t.appId);return n?n():[]},Ct=async(e,t)=>{const n=x(t.appId);if(!n)throw Object.assign(new Error("Wallet picker not available"),{code:a.INTERNAL_ERROR});const i=await n(e);if(!i)throw Object.assign(new Error("User rejected"),{code:a.USER_REJECTED});return i},Mt=async(e,t)=>{const n=x(t.appId);if(!n)throw Object.assign(new Error("Wallet picker not available"),{code:a.INTERNAL_ERROR});const i=await n(e);if(!i)throw Object.assign(new Error("User rejected"),{code:a.USER_REJECTED});return i},Nt=async(e,t)=>"bfmeta",jt=async(e,t)=>{const n=e;if(!n?.address||!n?.chain)throw Object.assign(new Error("Missing address or chain"),{code:a.INVALID_PARAMS});return"0"};let be=null;function xs(e){be=e}function Re(e){return h.get(e)?.showSigningDialog??be}const Ut=async(e,t)=>{const n=e;if(!n?.message||!n?.address)throw Object.assign(new Error("Missing message or address"),{code:a.INVALID_PARAMS});const s=Re(t.appId);if(!s)throw Object.assign(new Error("Signing dialog not available"),{code:a.INTERNAL_ERROR});const i=await s({message:n.message,address:n.address,app:{name:t.appName}});if(!i)throw Object.assign(new Error("User rejected"),{code:a.USER_REJECTED});return i},Lt=async(e,t)=>{const n=e;if(!n?.data||!n?.address)throw Object.assign(new Error("Missing data or address"),{code:a.INVALID_PARAMS});const s=Re(t.appId);if(!s)throw Object.assign(new Error("Signing dialog not available"),{code:a.INTERNAL_ERROR});const i=JSON.stringify(n.data,null,2),r=await s({message:i,address:n.address,app:{name:t.appName}});if(!r)throw Object.assign(new Error("User rejected"),{code:a.USER_REJECTED});return r};let Ee=null;function $s(e){Ee=e}function Ht(e){return h.get(e)?.showTransferDialog??Ee}const Bt=async(e,t)=>{const n=e;if(!n?.from||!n?.to||!n?.amount||!n?.chain)throw Object.assign(new Error("Missing required parameters: from, to, amount, chain"),{code:a.INVALID_PARAMS});const s=Ht(t.appId);if(!s)throw Object.assign(new Error("Transfer dialog not available"),{code:a.INTERNAL_ERROR});const i={from:n.from,to:n.to,amount:n.amount,chain:n.chain,app:{name:t.appName}};n.asset&&(i.asset=n.asset);const r=await s(i);if(!r)throw Object.assign(new Error("User rejected"),{code:a.USER_REJECTED});return r};function qt(e,t){const n=it.state.wallets,s=t.startsWith("0x"),i=s?t.toLowerCase():t;for(const r of n)if(r.chainAddresses.find(l=>l.chain!==e?!1:s||l.address.startsWith("0x")?l.address.toLowerCase()===i:l.address===i))return r.id;return null}async function _e(e){if(k.state.snapshot||await nt.initialize(),!k.state.snapshot)throw Object.assign(new Error("Chain configs not initialized"),{code:a.INTERNAL_ERROR});const n=st.getChainById(k.state,e);if(!n)throw Object.assign(new Error(`Unsupported chain: ${e}`),{code:a.INVALID_PARAMS});return n}const Vt=async(e,t)=>{const n=e;if(!n?.from||!n?.to||!n?.amount||!n?.chain)throw Object.assign(new Error("Missing required parameters: from, to, amount, chain"),{code:a.INVALID_PARAMS});if(!qt(n.chain,n.from))throw Object.assign(new Error("From address is not owned by current user"),{code:a.UNAUTHORIZED});const i=await _e(n.chain),r=et.parse(n.amount,i.decimals,i.symbol),o=pe(i.id);if(!o.supportsBuildTransaction)throw Object.assign(new Error(`Chain ${i.id} does not support transaction building`),{code:a.UNSUPPORTED_METHOD});const l=await o.buildTransaction({from:n.from,to:n.to,amount:r});return{chainId:l.chainId,data:l.data}};let Te=null;function Fs(e){Te=e}function Wt(e){return h.get(e)?.showSignTransactionDialog??Te}const xt=async(e,t)=>{const n=e;if(!n?.from||!n?.chain||!n?.unsignedTx)throw Object.assign(new Error("Missing required parameters: from, chain, unsignedTx"),{code:a.INVALID_PARAMS});const s=Wt(t.appId);if(!s)throw Object.assign(new Error("SignTransaction dialog not available"),{code:a.INTERNAL_ERROR});const i=await s({from:n.from,chain:n.chain,unsignedTx:n.unsignedTx,app:{name:t.appName}});if(!i)throw Object.assign(new Error("User rejected"),{code:a.USER_REJECTED});return i};async function Ks(e){const t=await _e(e.chainId),n=pe(t.id);if(!n.supportsSignTransaction)throw Object.assign(new Error(`Chain ${t.id} does not support transaction signing`),{code:a.UNSUPPORTED_METHOD});const s=await(await le(async()=>{const{walletStorageService:o}=await import("./web-DnZPwNCZ.js").then(l=>l.i);return{walletStorageService:o}},__vite__mapDeps([0,1,2,3,4,5,6,7,8,9]),import.meta.url)).walletStorageService.getMnemonic(e.walletId,e.password);let i;if(t.chainKind==="evm"){const o=tt(s,"ethereum",0,0);if(o.address.toLowerCase()!==e.from.toLowerCase())throw Object.assign(new Error("Signing address mismatch"),{code:a.INVALID_PARAMS});i=rt(o.privateKey)}else if(t.chainKind==="bioforest"){const o=at(s);if(ot(o.publicKey,t.prefix??"b")!==e.from)throw Object.assign(new Error("Signing address mismatch"),{code:a.INVALID_PARAMS});i=o.secretKey}else throw Object.assign(new Error(`Unsupported chain kind: ${t.chainKind}`),{code:a.UNSUPPORTED_METHOD});const r=await n.signTransaction({chainId:e.unsignedTx.chainId,data:e.unsignedTx.data},i);return{chainId:r.chainId,data:r.data,signature:r.signature}}const ye=new Map,Ie=new Map;let ve=null,C=null,De=null,ke=null;function zs(e){ve=e}function Gs(e){C=e}function Js(e){De=e}function Zs(e){ke=e}function $t(e){return h.get(e)?.showEvmWalletPicker??ve}function Oe(e){return h.get(e)?.showEvmSigningDialog??De}function Ft(e){return h.get(e)?.showEvmTransactionDialog??ke}function R(e){return ye.get(e)??ut(dt.binance)}function Kt(e,t){ye.set(e,t)}function zt(e){return Ie.get(e)??[]}function Gt(e,t){Ie.set(e,t)}const Jt=async(e,t)=>R(t.appId),Zt=async(e,t)=>{const n=$t(t.appId);if(!n)throw Object.assign(new Error("Wallet picker not available"),{code:a.INTERNAL_ERROR});const s=R(t.appId),i=await n({chainId:s,app:{name:t.appName,icon:t.appIcon}});if(!i)throw Object.assign(new Error("User rejected"),{code:a.USER_REJECTED});const r=[i.address];return Gt(t.appId,r),r},Yt=async(e,t)=>zt(t.appId),Qt=async(e,t)=>{const n=e;if(!n?.chainId)throw Object.assign(new Error("Missing chainId"),{code:a.INVALID_PARAMS});const s=n.chainId;if(!lt(s))throw Object.assign(new Error(`Chain ${s} not supported`),{code:4902});const r=R(t.appId);if(r===s)return null;if(C&&!await C({fromChainId:r,toChainId:s,appName:t.appName,appIcon:t.appIcon}))throw Object.assign(new Error("User rejected"),{code:a.USER_REJECTED});return Kt(t.appId,s),null},Xt=async(e,t)=>{throw Object.assign(new Error("Adding custom chains is not supported"),{code:a.UNSUPPORTED_METHOD})},Pe=async(e,t)=>{const[n,s]=e;if(!n||!s)throw Object.assign(new Error("Missing message or address"),{code:a.INVALID_PARAMS});const i=Oe(t.appId);if(!i)throw Object.assign(new Error("Signing dialog not available"),{code:a.INTERNAL_ERROR});const r=await i({message:n,address:s,appName:t.appName});if(!r)throw Object.assign(new Error("User rejected"),{code:a.USER_REJECTED});return r.signature},en=async(e,t)=>{const[n,s]=e;return Pe([s,n],t)},tn=async(e,t)=>{const[n,s]=e;if(!n||!s)throw Object.assign(new Error("Missing address or typedData"),{code:a.INVALID_PARAMS});const i=typeof s=="string"?JSON.parse(s):s,r=Oe(t.appId);if(!r)throw Object.assign(new Error("Signing dialog not available"),{code:a.INTERNAL_ERROR});const o=JSON.stringify(i,null,2),l=await r({message:o,address:n,appName:t.appName});if(!l)throw Object.assign(new Error("User rejected"),{code:a.USER_REJECTED});return l.signature},nn=async(e,t)=>{const n=e;if(!n?.from)throw Object.assign(new Error("Missing transaction data"),{code:a.INVALID_PARAMS});const s=Ft(t.appId);if(!s)throw Object.assign(new Error("Transaction dialog not available"),{code:a.INTERNAL_ERROR});n.chainId||(n.chainId=R(t.appId));const i=await s({tx:n,appName:t.appName});if(!i)throw Object.assign(new Error("User rejected"),{code:a.USER_REJECTED});return i.txHash},sn=async(e,t)=>{throw e?.from?Object.assign(new Error("eth_signTransaction not yet supported, use eth_sendTransaction"),{code:a.UNSUPPORTED_METHOD}):Object.assign(new Error("Missing transaction data"),{code:a.INVALID_PARAMS})},rn=async(e,t)=>{const[n,s]=e;if(!n)throw Object.assign(new Error("Missing address"),{code:a.INVALID_PARAMS});return"0x0"},an=async(e,t)=>{const n=R(t.appId),s=ct(n);return String(s)},on=async(e,t)=>"0x0",cn=async(e,t)=>"KeyApp/1.0.0",ln={eth_chainId:Jt,eth_requestAccounts:Zt,eth_accounts:Yt,wallet_switchEthereumChain:Qt,wallet_addEthereumChain:Xt,personal_sign:Pe,eth_sign:en,eth_signTypedData_v4:tn,eth_sendTransaction:nn,eth_signTransaction:sn,eth_getBalance:rn,net_version:an,eth_blockNumber:on,web3_clientVersion:cn};function un(e){for(const[t,n]of Object.entries(ln))e(t,n)}const Ce=new Map;let Me=null,dn=null;function Ys(e){Me=e}function pn(e){return h.get(e)?.showTronWalletPicker??Me}function gn(e){return h.get(e)?.showTronSigningDialog??dn}function Ne(e){return Ce.get(e)??null}function fn(e,t){Ce.set(e,t)}function hn(e){return{base58:e.address,hex:e.address}}const mn=async(e,t)=>{const n=pn(t.appId);if(!n)throw Object.assign(new Error("Wallet picker not available"),{code:a.INTERNAL_ERROR});const s=await n({app:{name:t.appName,icon:t.appIcon}});if(!s)throw Object.assign(new Error("User rejected"),{code:a.USER_REJECTED});const i=hn(s);return fn(t.appId,i),{code:200,message:"ok",data:i}},wn=async(e,t)=>{const n=Ne(t.appId);return n?{code:200,message:"ok",data:n}:{code:4e3,message:"Not connected",data:null}},An=async(e,t)=>Ne(t.appId),Sn=async(e,t)=>{const n=e;if(!n?.txID)throw Object.assign(new Error("Invalid transaction"),{code:a.INVALID_PARAMS});const s=gn(t.appId);if(!s)throw Object.assign(new Error("Signing dialog not available"),{code:a.INTERNAL_ERROR});const i=await s({transaction:n,appName:t.appName});if(!i)throw Object.assign(new Error("User rejected"),{code:a.USER_REJECTED});return i.signedTransaction},bn=async(e,t)=>{const n=e;if(!n?.txID||!n.signature)throw Object.assign(new Error("Invalid signed transaction"),{code:a.INVALID_PARAMS});return{result:!0,txid:n.txID}},Rn=async(e,t)=>{if(!e)throw Object.assign(new Error("Missing address"),{code:a.INVALID_PARAMS});return 0},En=async(e,t)=>{const n=e;if(!n)throw Object.assign(new Error("Missing address"),{code:a.INVALID_PARAMS});return{address:n,balance:0}},_n={tron_requestAccounts:mn,tron_accounts:wn,tron_getDefaultAddress:An,tron_signTransaction:Sn,tron_sendRawTransaction:bn,tron_getBalance:Rn,tron_getAccount:En};function Tn(e){for(const[t,n]of Object.entries(_n))e(t,n)}function Qs(){u.registerHandler("bio_connect",kt),u.registerHandler("bio_closeSplashScreen",vt),u.registerHandler("bio_requestAccounts",Ot),u.registerHandler("bio_accounts",Pt),u.registerHandler("bio_selectAccount",Ct),u.registerHandler("bio_pickWallet",Mt),u.registerHandler("bio_chainId",Nt),u.registerHandler("bio_getBalance",jt),u.registerHandler("bio_signMessage",Ut),u.registerHandler("bio_signTypedData",Lt),u.registerHandler("bio_createTransaction",Vt),u.registerHandler("bio_signTransaction",xt),u.registerHandler("bio_sendTransaction",Bt),un((e,t)=>u.registerHandler(e,t)),Tn((e,t)=>u.registerHandler(e,t)),console.log("[BioProvider] Initialized with handlers:",{bio:["bio_connect","bio_closeSplashScreen","bio_requestAccounts","bio_accounts","bio_selectAccount","bio_pickWallet","bio_chainId","bio_getBalance","bio_signMessage","bio_signTypedData","bio_createTransaction","bio_signTransaction","bio_sendTransaction"],evm:["eth_chainId","eth_requestAccounts","eth_accounts","wallet_switchEthereumChain","personal_sign","eth_sendTransaction"],tron:["tron_requestAccounts","tron_accounts","tron_signTransaction"]})}function $(){return u}const F=new Map,M=new Set;function N(e,t){const n=`${e}:${t}`;return F.get(n)??null}function je(e){return M.add(e),()=>M.delete(e)}function Ue(){M.forEach(e=>e())}const K=new Map,z=new Map,G=new Map,J=new Map;let Le=null,He=null;const Z=new Map,Y=new Map,S=new Map;function yn(e,t){K.set(e,t)}function In(e,t){z.set(e,t)}function vn(e){K.delete(e),z.delete(e)}function Q(e){return K.get(e)??null}function Dn(e){return z.get(e)??null}function kn(e,t){G.set(e,t)}function On(e){G.delete(e)}function Pn(e){return G.get(e)??null}function Cn(e,t){J.set(e,t)}function Mn(e){J.delete(e)}function Nn(e){return J.get(e)??null}function jn(e){Le=e}function Un(){return Le}function Ln(e){He=e}function Hn(){return He}function Be(e,t){Z.set(e,t)}function qe(e){Z.delete(e)}function X(e){return Z.get(e)??null}function Ve(e){const t=X(e);if(!t)return null;const n=t.closest(".swiper-slide");if(n&&!n.classList.contains("swiper-slide-active"))return null;const s=t.getBoundingClientRect();return s.width<=0||s.height<=0?null:s}function Bn(e,t){Y.set(e,t)}function qn(e){Y.delete(e)}function Vn(e){return Y.get(e)??null}function Wn(e,t,n){const s=S.get(e)??new Map;s.set(t,n),S.set(e,s);const i=`${e}:${t}`;F.set(i,"ready"),Ue()}function xn(e,t){const n=S.get(e);if(!n)return;n.delete(t),n.size===0&&S.delete(e);const s=`${e}:${t}`;F.set(s,"lost"),Ue()}function We(e,t){return S.get(e)?.get(t)??null}function xe(e,t){const n=We(e,t);if(!n)return null;const s=n.closest(".swiper-slide");if(s&&!s.classList.contains("swiper-slide-active"))return null;const i=n.getBoundingClientRect();return i.width<=0||i.height<=0?null:i}function $n(e){Be("stack",e)}function Fn(){qe("stack")}function Kn(){return X("stack")}function zn(){return Ve("stack")}async function Gn(){return le(()=>Promise.resolve().then(()=>vs),void 0,import.meta.url)}function Jn(){de.useEffect(()=>{Gn().then(({miniappRuntimeStore:e,activateApp:t})=>{const{activeAppId:n}=e.state;n&&t(n)})})}function Zn(e,t){return de.useSyncExternalStore(je,()=>N(e,t),()=>N(e,t))}const Yn={apps:new Map,visualConfig:ge,activeAppId:null,focusedAppId:null,presentations:new Map,zOrderSeed:1,isStackViewOpen:!1,maxBackgroundApps:4};function $e(e){const t=c.state.apps.get(e),n=t?.iframeRef;!t||!n||$().attach(n,e,t.manifest.name,t.manifest.permissions??[])}function Qn(e,t,n){$().attach(t,e,n.name,n.permissions??[])}const c=new ue(Yn);function Fe(e){c.setState(t=>({...t,visualConfig:pt(t.visualConfig,e)}))}function Xn(e){Fe({motion:{timeScale:e}})}function es(){c.setState(e=>({...e,visualConfig:ge}))}const j=new Set;function m(e){j.forEach(t=>t(e))}let ce=0;function Ke(e,t){return ce+=1,{id:`${e}:${t}:${Date.now()}:${ce}`,kind:e,status:"requested",startedAt:Date.now()}}function ts(e){const t=e.splashScreen;return t?typeof t=="object"&&typeof t.timeout=="number"?t.timeout:5e3:null}function ns(e,t){if(!e||e==="preparing"){if(t==="launching")return"opening";if(t==="splash")return"splash";if(t==="active")return"opened"}return e==="launching"&&t==="splash"?"splash":(e==="launching"||e==="splash")&&t==="active"?"opened":e==="active"&&t==="background"?"backgrounding":e==="background"&&t==="active"?"foregrounding":t==="closing"?"closing":t==="preparing"?"closed":t==="launching"?"opening":t==="splash"?"splash":t==="active"?"opened":t==="background"?"backgrounded":"closed"}function b(e,t){c.setState(n=>{const s=n.apps.get(e);if(!s)return n;const i=ns(s.state,t),r=new Map(n.apps);return r.set(e,{...s,state:t,flow:i}),{...n,apps:r}}),m({type:"app:state-change",appId:e,state:t})}function ss(e,t){c.setState(n=>{const s=n.apps.get(e);if(!s||s.processStatus===t)return n;const i=new Map(n.apps);return i.set(e,{...s,processStatus:t}),{...n,apps:i}})}function is(e,t){c.setState(n=>{const s=n.apps.get(e);if(!s||s.readiness===t)return n;const i=new Map(n.apps);return i.set(e,{...s,readiness:t}),{...n,apps:i}})}function ze(e){is(e,"ready");const t=c.state.apps.get(e);t&&!t.manifest.splashScreen&&(t.state==="launching"||t.state==="splash")&&I(e)}function rs(e){switch(e){case"opening":return"opened";case"backgrounding":return"backgrounded";case"foregrounding":return"opened";default:return e}}function as(e){c.setState(t=>{const n=t.apps.get(e);if(!n)return t;const s=rs(n.flow);if(s===n.flow)return t;const i=new Map(t.apps);return i.set(e,{...n,flow:s}),{...t,apps:i}})}const os={launchToSplash:100},_=new Map,U=new Map,L=new Map,cs=3e4,ls=2500,H=new Map;function A(e){const t=H.get(e);t&&(t.cancelled=!0,t.rafId!==null&&cancelAnimationFrame(t.rafId),H.delete(e))}function us(e){if(!e)return!1;const t=e.getBoundingClientRect();return t.width>0&&t.height>0}function ds(e){return!!e&&e.isConnected}function T(e){const t=U.get(e);t&&(clearTimeout(t),U.delete(e))}function ee(e,t,n){c.setState(s=>{const r=s.presentations.get(e)??{appId:e,desktop:t,state:"hidden",zOrder:s.zOrderSeed,transitionId:null,transitionKind:null},o={...r,...n,appId:e,desktop:n.desktop??r.desktop},l=new Map(s.presentations);return l.set(e,o),{...s,presentations:l}})}function Ge(e){c.setState(t=>{const n=t.presentations.get(e),s=t.zOrderSeed+1,i=new Map(t.presentations);return n&&i.set(e,{...n,zOrder:s}),{...t,activeAppId:e,focusedAppId:e,presentations:i,zOrderSeed:s}})}function ps(e,t){const n=c.state.presentations.get(e);n&&(n.transitionKind!=="present"||n.transitionId!==t||ee(e,n.desktop,{state:"presented",transitionId:null,transitionKind:null}))}function gs(e,t){const n=c.state.presentations.get(e);n&&(n.transitionKind!=="dismiss"||n.transitionId!==t||y(e))}function te(e){T(e),ze(e),I(e)}function O(e,t){A(e);const n=c.state.apps.get(e);n?.iframeRef&&W(n.iframeRef),c.setState(s=>{const i=new Map(s.apps);i.delete(e);const r=new Map(s.presentations);return r.delete(e),{...s,apps:i,presentations:r,activeAppId:s.activeAppId===e?null:s.activeAppId,focusedAppId:s.focusedAppId===e?null:s.focusedAppId}}),Xe.show({message:t,duration:2e3})}function fs(e,t){if(b(e,"launching"),ne(e),t){const n=setTimeout(()=>{const s=c.state.apps.get(e);if(!s||s.state!=="launching")return;b(e,"splash"),T(e);const i=ts(s.manifest);i!==null&&U.set(e,setTimeout(()=>{const r=c.state.apps.get(e);r&&r.state==="splash"&&te(e)},i))},os.launchToSplash);_.set(e,[n]);return}_.set(e,[])}function hs(e,t,n){A(e);const s={cancelled:!1,rafId:null};H.set(e,s);const i=performance.now(),r=()=>{if(s.cancelled)return;const o=c.state.apps.get(e);if(!o||o.state!=="preparing"){A(e);return}const l=us(Q(e)),g=!!xe(t,e),d=ds(o.iframeRef);if(l&&g&&d){A(e),fs(e,n);return}if(performance.now()-i>ls){g?l?O(e,"启动失败：加载容器未就绪，请重试"):O(e,"启动失败：图标未就绪，请返回桌面重试"):O(e,"启动失败：请停留在目标桌面页后重试");return}s.rafId=requestAnimationFrame(r)};s.rafId=requestAnimationFrame(r)}function ne(e){const t=_.get(e);t&&(t.forEach(n=>clearTimeout(n)),_.delete(e))}function Je(e){const t=L.get(e);t&&(clearTimeout(t),L.delete(e))}function y(e){ne(e),Je(e),T(e),A(e),c.setState(t=>{const n=t.apps.get(e);if(!n)return t;n.iframeRef&&W(n.iframeRef);const s=new Map(t.apps);s.delete(e);const i=new Map(t.presentations);return i.delete(e),{...t,apps:s,presentations:i,activeAppId:t.activeAppId===e?null:t.activeAppId,focusedAppId:t.focusedAppId===e?null:t.focusedAppId}}),c.state.apps.size===0&&$().detach()}function Ze(e){te(e)}function Ye(e,t,n){const i=c.state.apps.get(e);if(i){$e(e);const d=i.manifest.targetDesktop??"stack";return ee(e,d,{state:"presented",transitionId:null,transitionKind:null}),Ge(e),I(e),i}const r=!!t.splashScreen,o={appId:e,manifest:t,state:"preparing",flow:"closed",ctx:{capsuleTheme:t.capsuleTheme??"auto"},processStatus:"loading",readiness:"notReady",launchedAt:Date.now(),lastActiveAt:Date.now(),iframeRef:null,iconRef:Q(e)};o.iframeRef=ft(e,t.url,n),Qn(e,o.iframeRef,t),o.iframeRef.addEventListener("load",()=>{ss(e,"loaded"),t.splashScreen||ze(e)}),ht(o.iframeRef);const l=t.targetDesktop??"stack",g=Ke("present",e);return c.setState(d=>{const f=d.zOrderSeed+1,v=new Map(d.apps);v.set(e,o);const D=new Map(d.presentations);return D.set(e,{appId:e,desktop:l,state:"presenting",zOrder:f,transitionId:g.id,transitionKind:"present"}),{...d,apps:v,presentations:D,activeAppId:e,focusedAppId:e,zOrderSeed:f}}),m({type:"app:launch",appId:e,manifest:t}),hs(e,l,r),o}function ms(e,t,n){return Ye(e,t,n)}function I(e){const t=c.state,n=t.apps.get(e);n&&n.state!=="preparing"&&(t.activeAppId&&t.activeAppId!==e&&Qe(t.activeAppId),n.iframeRef&&n.state==="background"&&wt(n.iframeRef),b(e,"active"),$e(e),c.setState(s=>{const i=new Map(s.apps),r=i.get(e);return r&&i.set(e,{...r,lastActiveAt:Date.now()}),{...s,apps:i,activeAppId:e,focusedAppId:e}}),m({type:"app:activate",appId:e}))}function Qe(e){const t=c.state,n=t.apps.get(e);n&&n.state!=="preparing"&&(n.iframeRef&&mt(n.iframeRef),b(e,"background"),At(c.state.apps,c.state.activeAppId,t.maxBackgroundApps),m({type:"app:deactivate",appId:e}))}function se(e){const n=c.state.apps.get(e);if(!n)return;ne(e),Je(e),A(e),b(e,"closing"),T(e);const s=n.manifest.targetDesktop??"stack",i=Ke("dismiss",e);ee(e,s,{state:"dismissing",transitionId:i.id,transitionKind:"dismiss"}),L.set(e,setTimeout(()=>{const r=c.state.presentations.get(e);r&&(r.transitionKind!=="dismiss"||r.transitionId!==i.id||y(e))},cs)),m({type:"app:close",appId:e})}function ws(e){se(e)}function As(e,t){const s=c.state.apps.get(e);if(!s)return;const i={...s.ctx,...t};c.setState(r=>{const o=new Map(r.apps),l=o.get(e);return l&&o.set(e,{...l,ctx:i}),{...r,apps:o}}),m({type:"app:ctx-change",appId:e,ctx:i})}function Ss(){c.state.apps.forEach((t,n)=>{se(n),y(n)}),St()}function bs(){c.setState(e=>({...e,isStackViewOpen:!0})),m({type:"stack-view:open"})}function Rs(){c.setState(e=>({...e,isStackViewOpen:!1})),m({type:"stack-view:close"})}function Es(e){return j.add(e),()=>j.delete(e)}function _s(){return Array.from(c.state.apps.values())}function Ts(){const e=c.state;return e.activeAppId?e.apps.get(e.activeAppId)??null:null}function ys(){return c.state.apps.size>0}const Is={getApps:e=>Array.from(e.apps.values()),getVisualConfig:e=>e.visualConfig,getActiveApp:e=>e.activeAppId?e.apps.get(e.activeAppId)??null:null,getFocusedAppId:e=>e.focusedAppId??e.activeAppId,getFocusedApp:e=>{const t=e.focusedAppId??e.activeAppId;return t?e.apps.get(t)??null:null},getPresentations:e=>Array.from(e.presentations.values()).sort((t,n)=>t.zOrder-n.zOrder),getPresentation:(e,t)=>e.presentations.get(t)??null,hasPresentations:e=>e.presentations.size>0,hasRunningApps:e=>e.apps.size>0,hasRunningStackApps:e=>Array.from(e.apps.values()).some(t=>(t.manifest.targetDesktop??"stack")==="stack"),isStackViewOpen:e=>e.isStackViewOpen,getBackgroundApps:e=>Array.from(e.apps.values()).filter(t=>t.state==="background"),isLaunchOverlayVisible:e=>{const t=e.focusedAppId??e.activeAppId?e.apps.get(e.focusedAppId??e.activeAppId):null;return t?.state==="launching"||t?.state==="splash"},isShowingSplash:e=>(e.focusedAppId??e.activeAppId?e.apps.get(e.focusedAppId??e.activeAppId):null)?.state==="splash",isAnimating:e=>{const t=e.focusedAppId??e.activeAppId?e.apps.get(e.focusedAppId??e.activeAppId):null;return t?.state==="launching"||t?.state==="splash"||t?.state==="closing"}},vs=Object.freeze(Object.defineProperty({__proto__:null,activateApp:I,closeAllApps:Ss,closeApp:se,closeStackView:Rs,deactivateApp:Qe,didDismiss:gs,didPresent:ps,dismissSplash:Ze,finalizeCloseApp:y,getActiveApp:Ts,getDesktopAppSlotRect:xe,getDesktopAppSlotRef:We,getDesktopContainerRef:X,getDesktopGridHostRef:Vn,getDesktopRect:Ve,getIconInnerRef:Dn,getIconRef:Q,getRunningApps:_s,getSlotStatus:N,getSplashBgRef:Pn,getSplashIconRef:Nn,getStackContainerRef:Kn,getStackRect:zn,getWindowInnerRef:Hn,getWindowRef:Un,hasRunningApps:ys,launchApp:Ye,miniappRuntimeSelectors:Is,miniappRuntimeStore:c,openStackView:bs,registerDesktopAppSlotRef:Wn,registerDesktopContainerRef:Be,registerDesktopGridHostRef:Bn,registerIconInnerRef:In,registerIconRef:yn,registerSplashBgRef:kn,registerSplashIconRef:Cn,registerStackContainerRef:$n,registerWindowInnerRef:Ln,registerWindowRef:jn,requestDismiss:ws,requestDismissSplash:te,requestFocus:Ge,requestPresent:ms,resetMiniappVisualConfig:es,setMiniappMotionTimeScale:Xn,setMiniappVisualConfig:Fe,settleFlow:as,subscribe:Es,subscribeSlotStatus:je,unregisterDesktopAppSlotRef:xn,unregisterDesktopContainerRef:qe,unregisterDesktopGridHostRef:qn,unregisterIconRef:vn,unregisterSplashBgRef:On,unregisterSplashIconRef:Mn,unregisterStackContainerRef:Fn,updateAppContext:As,useMiniappVisibilityRestore:Jn,useSlotStatus:Zn},Symbol.toStringTag,{value:"Module"}));export{te as A,gs as B,Bn as C,ge as D,qn as E,Wn as F,xn as G,Et as H,me as I,Ks as J,Qs as K,$ as L,Vs as M,Ws as N,xs as O,$s as P,Fs as Q,zs as R,Gs as S,Js as T,Zs as U,Ys as V,qs as W,Bs as a,Is as b,Ss as c,c as d,p as e,Be as f,Hs as g,qe as h,yn as i,In as j,vn as k,Ye as l,pt as m,$n as n,bs as o,Fn as p,Zn as q,es as r,Xn as s,We as t,Jn as u,ps as v,as as w,jn as x,Ln as y,ws as z};
