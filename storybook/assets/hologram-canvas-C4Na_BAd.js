import{r as k,j as Y}from"./iframe-BaLTYcLj.js";class te{pool=[];maxSize;constructor(e=4){this.maxSize=e}acquire(e){const a=this.pool.pop();return a?((a.width!==e||a.height!==e)&&(a.width=e,a.height=e),a):new OffscreenCanvas(e,e)}release(e){this.pool.length<this.maxSize&&this.pool.push(e)}clear(){this.pool=[]}get size(){return this.pool.length}}const B=new te,H=new Map,ae=50,L=new Map,F=new Set,ne=6e4;function re(t){let e=5381;for(let a=0;a<t.length;a++)e=(e<<5)+e^t.charCodeAt(a);return(e>>>0).toString(36)}function se(t){if(!t||t.length===0)return"";const e=JSON.stringify(t.map(a=>({code:a.code,args:a.args})));return re(e)}function ie(t,e,a,n,s,c,u){const i=se(s),r=c?":clip":"",o=u!==void 0?`:tb${u}`:"";return`${t}:${e}:${a}:${n}${i?`:${i}`:""}${r}${o}`}function oe(){if(H.size<ae)return;let t=null,e=1/0;for(const[a,n]of H)n.timestamp<e&&(e=n.timestamp,t=a);t&&H.delete(t)}function ce(t){return new Promise((e,a)=>{const n=new Image;n.crossOrigin="anonymous",n.onload=()=>e(n),n.onerror=()=>a(new Error(`Failed to load image: ${t}`)),n.src=t})}const X=t=>t.replace(/\s+/g," ").trim();function S(t,e,a){if(typeof t!="object"||t===null)return a;const n=Reflect.get(t,e);return typeof n=="number"&&Number.isFinite(n)?n:a}function le(t,e,a,n){const s=e.data,c=a/2,u=a/2,i=S(n,"opacity",1);for(let r=0;r<s.length;r+=4){const o=s[r+3];if(o<10)continue;const d=r/4%a,p=Math.floor(r/4/a),h=(Math.atan2(d-c,u-p)*180/Math.PI+180)%360/60,g=Math.floor(h)%6,m=h-Math.floor(h);let y=255,b=0,x=0;switch(g){case 0:y=255,b=Math.round(m*255),x=0;break;case 1:y=Math.round((1-m)*255),b=255,x=0;break;case 2:y=0,b=255,x=Math.round(m*255);break;case 3:y=0,b=Math.round((1-m)*255),x=255;break;case 4:y=Math.round(m*255),b=0,x=255;break;default:y=255,b=0,x=Math.round((1-m)*255);break}s[r]=y,s[r+1]=b,s[r+2]=x,s[r+3]=Math.round(o*i)}t.putImageData(e,0,0)}function ue(t,e,a,n){const s=e.data,c=S(n,"r",255),u=S(n,"g",255),i=S(n,"b",255),r=S(n,"opacity",1);for(let o=0;o<s.length;o+=4){const d=s[o+3];d<10||(s[o]=c,s[o+1]=u,s[o+2]=i,s[o+3]=Math.round(d*r))}t.putImageData(e,0,0)}const _=new Map;let A=!1;function de(){A||(_.set(X(U.code),le),_.set(X(we),ue),A=!0)}function fe(t){return de(),_.get(X(t))}function he(t){return new Function("ctx","imageData","size","args",t)}const j=new Map;function me(t){const e=fe(t);if(e)return e;let a=j.get(t);return a||(a=he(t),j.set(t,a)),a}function pe(t,e,a,n=10){let s=e,c=a,u=0,i=0,r=!1;for(let o=0;o<a;o++)for(let d=0;d<e;d++){const p=(o*e+d)*4;t[p+3]>=n&&(r=!0,s=Math.min(s,d),c=Math.min(c,o),u=Math.max(u,d),i=Math.max(i,o))}return r?{minX:s,minY:c,maxX:u,maxY:i}:null}function V(t,e,a){let n=1,s=0;for(let i=0;i<t.length;i+=4){if(t[i+3]<10)continue;const o=t[i],d=t[i+1],p=t[i+2],f=(.299*o+.587*d+.114*p)/255;n=Math.min(n,f),s=Math.max(s,f)}const c=s-n,u=c>.01;for(let i=0;i<t.length;i+=4){const r=t[i],o=t[i+1],d=t[i+2],p=t[i+3];let f=(.299*r+.587*o+.114*d)/255;u&&(f=(f-n)/c),f=(f-.5)*e+.5,f=Math.max(0,Math.min(1,f)),a&&(f=1-f),t[i]=255,t[i+1]=255,t[i+2]=255,t[i+3]=f*(p/255)*255}}function ge(t,e,a,n,s,c,u){const i=B.acquire(e),r=i.getContext("2d",{willReadFrequently:!0});if(!r)throw B.release(i),new Error("Failed to get 2d context");r.clearRect(0,0,e,e);const o=Math.min(e/t.width,e/t.height)*.85,d=t.width*o,p=t.height*o,f=(e-d)/2,h=(e-p)/2;r.drawImage(t,f,h,d,p);let g=r.getImageData(0,0,e,e),m=g.data;if(V(m,n,a),c){const w=pe(m,e,e,20);if(w){const v=Math.max(0,w.minX-1),l=Math.max(0,w.minY-1),M=Math.min(e-v,w.maxX-w.minX+1+2),R=Math.min(e-l,w.maxY-w.minY+1+2),q=(v-f)/o,W=(l-h)/o,J=M/o,Z=R/o,Q=Math.max(M,R),N=e/Q*.95,P=M*N,$=R*N,z=(e-P)/2,ee=(e-$)/2;r.clearRect(0,0,e,e),r.drawImage(t,q,W,J,Z,z,ee,P,$),g=r.getImageData(0,0,e,e),m=g.data,V(m,n,a)}}if(u!==void 0){let w=0,I=0;for(let v=0;v<m.length;v+=4){const l=m[v+3];l>=10&&(w+=l/255,I++)}if(I>0){const v=w/I;if(v>.01){const l=u/v;for(let M=0;M<m.length;M+=4){const R=m[M+3];R>=1&&(m[M+3]=Math.min(255,Math.max(0,R*l)))}}}}if(r.putImageData(g,0,0),s&&s.length>0)for(const w of s)try{const I=me(w.code);g=r.getImageData(0,0,e,e),I(r,g,e,w.args)}catch{}const y=document.createElement("canvas");y.width=e,y.height=e;const b=y.getContext("2d");b&&b.drawImage(i,0,0);const x=y.toDataURL("image/png");return B.release(i),x}async function Me(t,e={}){const{size:a=64,invert:n=!1,contrast:s=1.5,pipeline:c,clip:u=!0,targetBrightness:i}=e,r=ie(t,a,n,s,c,u,i),o=H.get(r);if(o)return o.timestamp=Date.now(),o.url;const d=L.get(r);if(d)return d;if(F.has(t))return null;const p=(async()=>{try{const f=await ce(t),h=ge(f,a,n,s,c,u,i);return oe(),H.set(r,{url:h,timestamp:Date.now()}),h}catch{return F.add(t),setTimeout(()=>F.delete(t),ne),null}finally{L.delete(r)}})();return L.set(r,p),p}const U={code:`
    var data = imageData.data;
    var cx = size / 2;
    var cy = size / 2;
    var opacity = (args && args.opacity) || 1;
    
    for (var i = 0; i < data.length; i += 4) {
      var a = data[i + 3];
      if (a < 10) continue;
      
      var px = (i / 4) % size;
      var py = Math.floor((i / 4) / size);
      
      // 计算角度 (0-360)，从顶部开始顺时针
      var angle = Math.atan2(px - cx, cy - py) * 180 / Math.PI + 180;
      
      // HSV to RGB (H = angle, S = 1, V = 1) - 纯正彩虹色
      var h = (angle % 360) / 60;
      var hi = Math.floor(h) % 6;
      var f = h - Math.floor(h);
      var r, g, b;
      
      // 纯彩虹色：S=1, V=1
      switch (hi) {
        case 0: r = 255; g = Math.round(f * 255); b = 0; break;
        case 1: r = Math.round((1 - f) * 255); g = 255; b = 0; break;
        case 2: r = 0; g = 255; b = Math.round(f * 255); break;
        case 3: r = 0; g = Math.round((1 - f) * 255); b = 255; break;
        case 4: r = Math.round(f * 255); g = 0; b = 255; break;
        default: r = 255; g = 0; b = Math.round((1 - f) * 255); break;
      }
      
      data[i] = r;
      data[i + 1] = g;
      data[i + 2] = b;
      data[i + 3] = Math.round(a * opacity);
    }
    
    ctx.putImageData(imageData, 0, 0);
  `,args:{opacity:1}};function Se(t=1){return{...U,args:{opacity:t}}}const we=`
  var data = imageData.data;
  var r = (args && args.r) || 255;
  var g = (args && args.g) || 255;
  var b = (args && args.b) || 255;
  var opacity = (args && args.opacity) || 1;
  
  for (var i = 0; i < data.length; i += 4) {
    var a = data[i + 3];
    if (a < 10) continue;
    
    data[i] = r;
    data[i + 1] = g;
    data[i + 2] = b;
    data[i + 3] = Math.round(a * opacity);
  }
  
  ctx.putImageData(imageData, 0, 0);
`;let E=null,O=null,ke=1;const T=new Map;function ye(){if(E)return E;if(O)return null;try{return E=new Worker(new URL(""+new URL("monochrome-mask.worker-Fme0-8kq.js",import.meta.url).href,import.meta.url),{type:"module"}),E.onmessage=t=>{const e=t.data;if(!e||e.type!=="create-mask-result")return;const a=T.get(e.id);a&&(T.delete(e.id),e.error?a.reject(new Error(e.error)):a.resolve(e.dataUrl))},E.onerror=()=>{O="worker error",E?.terminate(),E=null;for(const[t,e]of T)T.delete(t),e.reject(new Error("worker error"))},E}catch(t){return O=t instanceof Error?t.message:"worker init failed",null}}async function ve(t,e){const a=ye();if(!a)throw new Error(O??"worker is unavailable");const n=ke++,s={type:"create-mask",id:n,iconUrl:t,options:e};return await new Promise((c,u)=>{T.set(n,{resolve:c,reject:u}),a.postMessage(s)})}const C=globalThis,be=typeof C.requestIdleCallback=="function"?C.requestIdleCallback.bind(C):(t=>C.setTimeout(()=>{t({didTimeout:!1,timeRemaining:()=>0})},16)),xe=typeof C.cancelIdleCallback=="function"?C.cancelIdleCallback.bind(C):(t=>{C.clearTimeout(t)});function Te(t,e={}){const{size:a=64,invert:n=!1,contrast:s=1.5,pipeline:c,clip:u,targetBrightness:i}=e,[r,o]=k.useState(null),d=k.useMemo(()=>c?JSON.stringify(c):"",[c]);return k.useEffect(()=>{if(!t){o(null);return}let p=!1,f=0;const h=d?JSON.parse(d):void 0,g={size:a,invert:n,contrast:s};return h&&(g.pipeline=h),u!==void 0&&(g.clip=u),i!==void 0&&(g.targetBrightness=i),f=be(()=>{ve(t,g).catch(()=>Me(t,g)).then(m=>{p||o(m)})},{timeout:300}),()=>{p=!0,f!==0&&xe(f)}},[t,a,n,s,d,u,i]),r}class Ie{worker=null;ready=!1;pendingRegistrations=[];states=new Map;loadedWatermarks=new Set;rafId=null;triangleMaskBitmap=null;triangleMaskSent=!1;paused=!1;constructor(){typeof window<"u"&&(this.initWorker(),this.loadTriangleMask(),this.initVisibilityListener())}initVisibilityListener(){document.addEventListener("visibilitychange",()=>{document.hidden?this.pause():this.resume()})}pause(){this.paused=!0,this.rafId!==null&&(cancelAnimationFrame(this.rafId),this.rafId=null)}resume(){this.paused=!1,this.states.size>0&&this.scheduleFlush()}async loadTriangleMask(){try{const e=Math.min(3,window.devicePixelRatio||1),n=Math.round(24*e),s=document.createElement("canvas");s.width=n,s.height=n;const c=s.getContext("2d");if(!c)return;c.fillStyle="black",c.beginPath(),c.moveTo(0,n),c.lineTo(n,n),c.lineTo(n,0),c.closePath(),c.fill(),this.triangleMaskBitmap=await createImageBitmap(s),this.sendTriangleMaskIfReady()}catch{}}sendTriangleMaskIfReady(){this.ready&&this.worker&&this.triangleMaskBitmap&&!this.triangleMaskSent&&(this.triangleMaskSent=!0,this.worker.postMessage({type:"setTriangleMask",bitmap:this.triangleMaskBitmap},[this.triangleMaskBitmap]))}initWorker(){try{this.worker=new Worker(new URL(""+new URL("worker-B5CT9vNg.js",import.meta.url).href,import.meta.url),{type:"module"}),this.worker.onmessage=this.handleMessage,this.worker.onerror=e=>{}}catch{}}handleMessage=e=>{if(e.data.type==="ready"){this.ready=!0;for(const a of this.pendingRegistrations)this.worker.postMessage({type:"register",...a},[a.canvas]);this.pendingRegistrations=[],this.sendTriangleMaskIfReady(),this.scheduleFlush()}};register(e,a){if(!this.worker)return()=>{};const n=a.transferControlToOffscreen();return this.ready?this.worker.postMessage({type:"register",cardId:e,canvas:n},[n]):this.pendingRegistrations.push({cardId:e,canvas:n}),()=>this.unregister(e)}unregister(e){this.states.delete(e),this.worker?.postMessage({type:"unregister",cardId:e})}update(e){this.states.set(e.cardId,e),this.scheduleFlush()}loadWatermark(e,a){this.loadedWatermarks.has(e)||(this.loadedWatermarks.add(e),this.worker?.postMessage({type:"loadWatermark",key:e,url:a}))}scheduleFlush(){this.rafId!==null||this.paused||(this.rafId=requestAnimationFrame(()=>{this.rafId=null,this.flush()}))}flush(){!this.ready||this.states.size===0||!this.worker||this.worker.postMessage({type:"update",states:[...this.states.values()]})}}const D=new Ie,K=new Map;function Re(t){let e=K.get(t);if(!e){const a=document.createElement("canvas");e={key:t,cardId:t,canvas:a,registered:!1},K.set(t,e)}return e}const G=(t,e,a)=>Math.max(e,Math.min(a,t));function Ee({priority:t="high",enabledPattern:e,enabledWatermark:a,mode:n="dynamic",pointerX:s,pointerY:c,active:u,themeHue:i,watermarkMaskUrl:r,watermarkCellSize:o,watermarkIconSize:d,poolKey:p}){const f=k.useId(),h=k.useMemo(()=>!p||typeof document>"u"?null:Re(p),[p]),g=h?.cardId??f,m=k.useRef(null),y=k.useRef(null),b=k.useRef({width:0,height:0,dpr:1}),x=k.useRef(!1),w=k.useRef(!1),I=k.useRef({priority:t,mode:n,pointerX:s,pointerY:c,active:u,themeHue:i,enabledPattern:e,enabledWatermark:a,watermarkMaskUrl:r,watermarkCellSize:o,watermarkIconSize:d});I.current={priority:t,mode:n,pointerX:s,pointerY:c,active:u,themeHue:i,enabledPattern:e,enabledWatermark:a,watermarkMaskUrl:r,watermarkCellSize:o,watermarkIconSize:d};const v=k.useCallback(()=>{queueMicrotask(()=>{if(!w.current)return;const l=I.current,M=l.mode==="static"?{x:0,y:0}:{x:G(l.pointerX,-1,1),y:G(l.pointerY,-1,1)};D.update({cardId:g,priority:l.priority,mode:l.mode,...b.current,pointer:M,active:l.mode==="static"?!1:l.active,themeHue:l.themeHue,enabledPattern:l.enabledPattern,enabledWatermark:l.enabledWatermark,watermarkMaskUrl:l.watermarkMaskUrl,watermarkCellSize:l.watermarkCellSize,watermarkIconSize:l.watermarkIconSize})})},[g]);return k.useEffect(()=>{const l=h?.canvas??m.current;if(l){if(h){if(h.registered){w.current=!0;return}h.registered=!0,w.current=!0,D.register(g,l);return}x.current||(x.current=!0,w.current=!0,D.register(g,l))}},[g,h]),k.useEffect(()=>{if(!h)return;const l=y.current;if(!l)return;const M=h.canvas;return M.className="pointer-events-none absolute inset-0 size-full",M.parentElement!==l&&l.appendChild(M),()=>{M.parentElement===l&&l.removeChild(M)}},[h]),k.useEffect(()=>{const l=h?.canvas.parentElement??m.current?.parentElement;if(!l)return;const M=()=>{const q=l.getBoundingClientRect(),W=Math.min(3,window.devicePixelRatio||1);b.current={width:Math.max(1,Math.round(q.width)),height:Math.max(1,Math.round(q.height)),dpr:W}},R=new ResizeObserver(()=>{M(),v()});return R.observe(l),M(),v(),()=>R.disconnect()},[v]),k.useEffect(()=>{r&&D.loadWatermark(r,r)},[r]),k.useEffect(()=>{v()},[v,t,n,s,c,u,i,e,a,r,o,d]),h?Y.jsx("div",{ref:y,className:"pointer-events-none absolute inset-0 size-full","data-testid":"wallet-card-hologram-canvas","data-pattern-enabled":e?"true":"false","data-watermark-enabled":a?"true":"false","data-mode":n,"data-priority":t}):Y.jsx("canvas",{ref:m,className:"pointer-events-none absolute inset-0 size-full","data-testid":"wallet-card-hologram-canvas","data-pattern-enabled":e?"true":"false","data-watermark-enabled":a?"true":"false","data-mode":n,"data-priority":t})}Ee.__docgenInfo={description:"",methods:[],displayName:"HologramCanvas",props:{priority:{required:!1,tsType:{name:"union",raw:"'high' | 'medium' | 'low'",elements:[{name:"literal",value:"'high'"},{name:"literal",value:"'medium'"},{name:"literal",value:"'low'"}]},description:"",defaultValue:{value:"'high'",computed:!1}},enabledPattern:{required:!0,tsType:{name:"boolean"},description:""},enabledWatermark:{required:!0,tsType:{name:"boolean"},description:""},mode:{required:!1,tsType:{name:"union",raw:"'dynamic' | 'static'",elements:[{name:"literal",value:"'dynamic'"},{name:"literal",value:"'static'"}]},description:"",defaultValue:{value:"'dynamic'",computed:!1}},pointerX:{required:!0,tsType:{name:"number"},description:""},pointerY:{required:!0,tsType:{name:"number"},description:""},active:{required:!0,tsType:{name:"boolean"},description:""},themeHue:{required:!0,tsType:{name:"number"},description:""},watermarkMaskUrl:{required:!1,tsType:{name:"union",raw:"string | null",elements:[{name:"string"},{name:"null"}]},description:""},watermarkCellSize:{required:!1,tsType:{name:"number"},description:""},watermarkIconSize:{required:!1,tsType:{name:"number"},description:""},poolKey:{required:!1,tsType:{name:"string"},description:`Optional pool key to reuse a canvas between mounts.
Use a stable key (e.g. walletId or walletId:slot).`}}};export{Ee as H,Se as c,Te as u};
