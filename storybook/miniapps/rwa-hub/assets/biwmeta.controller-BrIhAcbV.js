import{a0 as h,B as f}from"./page-BL_iZuG4.js";import{_ as g,O as u}from"./index-15D1tlVU.js";import"./polyfills-BATEtbik.js";const m=r=>typeof r.default=="object"?r.default:JSON.parse(r.default),y=async()=>{const r=await g(()=>import("./biwmeta-genesisBlock.prod-DzycNmLE.js"),[]);return m(r)},k=await y(),o=58,d=(()=>{const r={timestamp:0,count:0};return e=>(e!==r.timestamp?(r.timestamp=e,r.count=0):r.count--,Number(BigInt(r.timestamp)+BigInt(r.count)))})();class I extends h{constructor(e,t,a,s,n){super(),this._bundleCore=e,this._isProd=t,this._i18n=a,this.walletUrl=s,this.browserUrl=n,this.#e=u(async()=>{const l=await this.#t();return{updateTime:Date.now(),blockInfo:l}}),this.getBlockInfo_task={hasRunning:!1,task:Promise.withResolvers()},this.broadcastTransaction=async l=>{try{return await this.SERVER_API.broadcastTransaction(l)}catch(i){if(typeof i=="string")throw i;const c=i;throw c.message?c.message:c.error?c.error.message||c.error:i}}}get genesitBlockAsset(){return k}get genesitBlockConfig(){return this.genesitBlockAsset.asset.genesisAsset}get signUtil(){return this._bundleCore.bioforestChainSignUtil}isAddress(e){return this._bundleCore.bioforestChainSignUtil.isAddress(e)}async checkSecondSecret(e,t,a){return await this._bundleCore.bioforestChainSignUtil.checkSecondSecretV2(e,t,a)||await this._bundleCore.bioforestChainSignUtil.checkSecondSecret(e,t,a)}createKeypair(e){return this._bundleCore.bioforestChainSignUtil.createKeypair(e)}async getAddressByMainSecret(e){const{publicKey:t}=await this.createKeypair(e);return this.getAddressByPublicKeyString(t.toString("hex"))}getAddressByPublicKeyString(e){return this._bundleCore.bioforestChainSignUtil.getAddressFromPublicKeyString(e)}getAddressByPrivateKeyString(e){const t=this._bundleCore.bioforestChainSignUtil.createKeypairBySecretKeyString(e);return this._bundleCore.bioforestChainSignUtil.getAddressFromPublicKey(t.publicKey)}async getTransactionInBlockById(e,t){t||(t=(await this.getBlockInfo()).height);const{trs:a}=await this.SERVER_API.getTransactionInBlockById(e,t);return a&&a[0]}#e;async getBlockInfo(){let e=await this.#e();return e.updateTime+this.genesitBlockConfig.forgeInterval*1e3<Date.now()&&(e=await this.#e.rerun()),e.blockInfo}async#t(e){if(e){const{blocks:t}=await this.SERVER_API.queryBlock(e);if(t.length===0)throw new Error(this._i18n.$chain$_failed_to_query_block_with_height_of_$height$({chain:f.BIWMeta,height:e}));return t[0]}try{if(this.getBlockInfo_task.hasRunning)return this.getBlockInfo_task.task.promise;this.getBlockInfo_task.hasRunning=!0,this.getBlockInfo_task.task=Promise.withResolvers();const t=await this.SERVER_API.getLastBlock();return this.getBlockInfo_task.task.resolve(t),t}catch(t){throw this.getBlockInfo_task.task.reject(t),t}finally{this.getBlockInfo_task.hasRunning=!1}}async getAddressAsset(e,t){const a=await this.SERVER_API.getAddressAsset(e,t);return a?(a.assets||{})[this.genesitBlockConfig.magic]||{}:{}}async getAddressSecondPublicKey(e){const t=await this.SERVER_API.getAddressInfo(e);if(t)return t.secondPublicKey||void 0}async getCreateTransactionBlockInfo(){const e=await this.getBlockInfo();return{applyBlockHeight:e.height,timestamp:d(e.timestamp)}}async createEntityTransaction(e,t){const{fee:a,applyBlockHeight:s,timestamp:n}=await this.getCreateEntityTransactionMinFee(e,t);return e.fee||(e.fee=a),this._bundleCore.bioforestChain.transactionController.createEntityTransferTransactionJSON({secrets:{mainSecret:e.mainSecret,paySecret:e.paySecret},transaction:{fee:e.fee,recipientId:e.receiveAddress,applyBlockHeight:s,timestamp:n,remark:e.remark??void 0,effectiveBlockHeight:s+o},assetInfo:{assetType:e.entityId,amount:"1",taxInformation:{taxCollector:e.entityFeeReceiveAddress,taxAssetPrealnum:e.entityFee}}})}async getCreateEntityTransactionMinFee(e,t){const{applyBlockHeight:a,timestamp:s}=t||await this.getCreateTransactionBlockInfo();return{fee:await this._bundleCore.bioforestChain.transactionController.createEntityTransferTransactionMinFee({applyBlockHeight:a,timestamp:s,remark:e.remark,effectiveBlockHeight:a+o},{assetType:e.entityId,amount:"1",taxInformation:{taxCollector:e.entityFeeReceiveAddress,taxAssetPrealnum:e.entityFee}}),applyBlockHeight:a,timestamp:s}}async getTransferTransaction(e,t){const{fee:a,applyBlockHeight:s,timestamp:n}=await this.getTransferTransactionMinFee(e,t);return e.fee||(e.fee=a),this._bundleCore.bioforestChain.transactionController.createTransferTransactionJSON({secrets:{mainSecret:e.mainSecret,paySecret:e.paySecret},transaction:{fee:e.fee,recipientId:e.receiveAddress,applyBlockHeight:s,timestamp:n,remark:e.remark??void 0,effectiveBlockHeight:s+o},assetInfo:{sourceChainName:this.genesitBlockConfig.chainName,sourceChainMagic:this.genesitBlockConfig.magic,assetType:e.assetType,amount:e.amount}})}async getTransferTransactionMinFee(e,t){const{applyBlockHeight:a,timestamp:s}=t||await this.getCreateTransactionBlockInfo();return{fee:await this._bundleCore.bioforestChain.transactionController.getTransferTransactionMinFee({transaction:{applyBlockHeight:a,timestamp:s},assetInfo:{sourceChainName:this.genesitBlockConfig.chainName,sourceChainMagic:this.genesitBlockConfig.magic,assetType:e.assetType,amount:e.amount}}),applyBlockHeight:a,timestamp:s}}async createDestoryAssetTransaction(e,t){const{fee:a,applyBlockHeight:s,timestamp:n}=await this.getDestoryAssetTransactionMinFee(e,t);return e.fee||(e.fee=a),this._bundleCore.bioforestChain.transactionController.createDestoryAssetTransactionJSON({secrets:{mainSecret:e.mainSecret,paySecret:e.paySecret},transaction:{fee:e.fee,recipientId:e.receiveAddress,applyBlockHeight:s,timestamp:n,remark:e.remark??void 0,effectiveBlockHeight:s+o},assetInfo:{sourceChainName:this.genesitBlockConfig.chainName,sourceChainMagic:this.genesitBlockConfig.magic,assetType:e.assetType,amount:e.amount}})}async getDestoryAssetTransactionMinFee(e,t){const{applyBlockHeight:a,timestamp:s}=t||await this.getCreateTransactionBlockInfo();return{fee:await this._bundleCore.bioforestChain.transactionController.getDestoryAssetTransactionMinFee({transaction:{applyBlockHeight:a,timestamp:s},assetInfo:{sourceChainName:this.genesitBlockConfig.chainName,sourceChainMagic:this.genesitBlockConfig.magic,assetType:e.assetType,amount:e.amount}}),applyBlockHeight:a,timestamp:s}}}export{I as BIWMetaController,k as PROD_GENESIS_BLOCK_ASSET};
