import{a0 as h,B as f}from"./page-BL_iZuG4.js";import{_ as g,O as u,d as y}from"./index-15D1tlVU.js";import"./polyfills-BATEtbik.js";const m=r=>typeof r.default=="object"?r.default:JSON.parse(r.default),d=async()=>{const r=await g(()=>import("./bfmeta-genesisBlock.prod-Dxhsv75S.js"),[]);return m(r)},k=await d(),l=38,C=(()=>{const r={timestamp:0,count:0};return e=>(e!==r.timestamp?(r.timestamp=e,r.count=0):r.count--,Number(BigInt(r.timestamp)+BigInt(r.count)))})();class T extends h{constructor(e,t,s,a,n){super(),this._bundleCore=e,this._isProd=t,this._i18n=s,this.walletUrl=a,this.browserUrl=n,this.#e=u(async()=>{let o=10,c;for(;o>0;)try{const i=await this.#t();return{updateTime:Date.now(),blockInfo:i}}catch(i){c=i,o--,await y(3e3),console.warn("retry after 3s",i)}throw c}),this.getBlockInfo_task={hasRunning:!1,task:Promise.withResolvers()},this.broadcastTransaction=async o=>{try{return await this.SERVER_API.broadcastTransaction(o)}catch(c){if(typeof c=="string")throw c;const i=c;throw i.message?i.message:i.error?i.error.message||i.error:c}}}get genesitBlockAsset(){return k}get genesitBlockConfig(){return this.genesitBlockAsset.asset.genesisAsset}get signUtil(){return this._bundleCore.bioforestChainSignUtil}isAddress(e){return this._bundleCore.bioforestChainSignUtil.isAddress(e)}async checkSecondSecret(e,t,s){return await this._bundleCore.bioforestChainSignUtil.checkSecondSecretV2(e,t,s)||await this._bundleCore.bioforestChainSignUtil.checkSecondSecret(e,t,s)}createKeypair(e){return this._bundleCore.bioforestChainSignUtil.createKeypair(e)}async getAddressByMainSecret(e){const{publicKey:t}=await this.createKeypair(e);return this.getAddressByPublicKeyString(t.toString("hex"))}getAddressByPublicKeyString(e){return this._bundleCore.bioforestChainSignUtil.getAddressFromPublicKeyString(e)}getAddressByPrivateKeyString(e){const t=this._bundleCore.bioforestChainSignUtil.createKeypairBySecretKeyString(e);return this._bundleCore.bioforestChainSignUtil.getAddressFromPublicKey(t.publicKey)}async getTransactionInBlockById(e,t){t||(t=(await this.getBlockInfo()).height);const{trs:s}=await this.SERVER_API.getTransactionInBlockById(e,t);return s&&s[0]}getAssetTypeInfo(e){return this.SERVER_API.getAssetTypeInfo(e)}#e;async getBlockInfo(){let e=await this.#e();return e.updateTime+this.genesitBlockConfig.forgeInterval*1e3<Date.now()&&(e=await this.#e.rerun()),e.blockInfo}async#t(e){if(e){const{blocks:t}=await this.SERVER_API.queryBlock(e);if(t.length===0)throw new Error(this._i18n.$chain$_failed_to_query_block_with_height_of_$height$({chain:f.BFMeta,height:e}));return t[0]}try{if(this.getBlockInfo_task.hasRunning)return this.getBlockInfo_task.task.promise;this.getBlockInfo_task.hasRunning=!0,this.getBlockInfo_task.task=Promise.withResolvers();const t=await this.SERVER_API.getLastBlock();return this.getBlockInfo_task.task.resolve(t),t}catch(t){throw this.getBlockInfo_task.task.reject(t),t}finally{this.getBlockInfo_task.hasRunning=!1}}async getAddressAsset(e,t){const s=await this.SERVER_API.getAddressAsset(e,t);return s?(s.assets||{})[this.genesitBlockConfig.magic]||{}:{}}async getAddressSecondPublicKey(e){const t=await this.SERVER_API.getAddressInfo(e);if(t)return t.secondPublicKey||void 0}async getCreateTransactionBlockInfo(){const e=await this.getBlockInfo();return{applyBlockHeight:e.height,timestamp:C(e.timestamp)}}async createEntityTransaction(e,t){const{fee:s,applyBlockHeight:a,timestamp:n}=await this.getCreateEntityTransactionMinFee(e,t);return e.fee||(e.fee=s),this._bundleCore.bioforestChain.transactionController.createEntityTransferTransactionJSON({secrets:{mainSecret:e.mainSecret,paySecret:e.paySecret},transaction:{fee:e.fee,recipientId:e.receiveAddress,applyBlockHeight:a,timestamp:n,remark:e.remark??void 0,effectiveBlockHeight:a+l},assetInfo:{assetType:e.entityId,amount:"1",taxInformation:{taxCollector:e.entityFeeReceiveAddress,taxAssetPrealnum:e.entityFee}}})}async getCreateEntityTransactionMinFee(e,t){const{applyBlockHeight:s,timestamp:a}=t||await this.getCreateTransactionBlockInfo();return{fee:await this._bundleCore.bioforestChain.transactionController.createEntityTransferTransactionMinFee({applyBlockHeight:s,timestamp:a,remark:e.remark,effectiveBlockHeight:s+l},{assetType:e.entityId,amount:"1",taxInformation:{taxCollector:e.entityFeeReceiveAddress,taxAssetPrealnum:e.entityFee}}),applyBlockHeight:s,timestamp:a}}async getTransferTransaction(e,t){const{fee:s,applyBlockHeight:a,timestamp:n}=await this.getTransferTransactionMinFee(e,t);return e.fee||(e.fee=s),this._bundleCore.bioforestChain.transactionController.createTransferTransactionJSON({secrets:{mainSecret:e.mainSecret,paySecret:e.paySecret},transaction:{fee:e.fee,recipientId:e.receiveAddress,applyBlockHeight:a,timestamp:n,remark:e.remark??void 0,effectiveBlockHeight:a+l},assetInfo:{sourceChainName:this.genesitBlockConfig.chainName,sourceChainMagic:this.genesitBlockConfig.magic,assetType:e.assetType,amount:e.amount}})}async getTransferTransactionMinFee(e,t){const{applyBlockHeight:s,timestamp:a}=t||await this.getCreateTransactionBlockInfo();return{fee:await this._bundleCore.bioforestChain.transactionController.getTransferTransactionMinFee({transaction:{applyBlockHeight:s,timestamp:a},assetInfo:{sourceChainName:this.genesitBlockConfig.chainName,sourceChainMagic:this.genesitBlockConfig.magic,assetType:e.assetType,amount:e.amount}}),applyBlockHeight:s,timestamp:a}}async createDestoryAssetTransaction(e,t){const{fee:s,applyBlockHeight:a,timestamp:n}=await this.getDestoryAssetTransactionMinFee(e,t);return e.fee||(e.fee=s),this._bundleCore.bioforestChain.transactionController.createDestoryAssetTransactionJSON({secrets:{mainSecret:e.mainSecret,paySecret:e.paySecret},transaction:{fee:e.fee,recipientId:e.receiveAddress,applyBlockHeight:a,timestamp:n,remark:e.remark??void 0,effectiveBlockHeight:a+l},assetInfo:{sourceChainName:this.genesitBlockConfig.chainName,sourceChainMagic:this.genesitBlockConfig.magic,assetType:e.assetType,amount:e.amount}})}async getDestoryAssetTransactionMinFee(e,t){const{applyBlockHeight:s,timestamp:a}=t||await this.getCreateTransactionBlockInfo();return{fee:await this._bundleCore.bioforestChain.transactionController.getDestoryAssetTransactionMinFee({transaction:{applyBlockHeight:s,timestamp:a},assetInfo:{sourceChainName:this.genesitBlockConfig.chainName,sourceChainMagic:this.genesitBlockConfig.magic,assetType:e.assetType,amount:e.amount}}),applyBlockHeight:s,timestamp:a}}}export{T as BFMetaController,k as PROD_GENESIS_BLOCK_ASSET};
