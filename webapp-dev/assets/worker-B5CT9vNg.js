(function(){"use strict";const w=(t,e,a)=>Math.max(e,Math.min(a,t));function T(t){const e=t%360;return e<0?e+360:e}function b(t){const e=w(t,0,1);return e<=.0031308?12.92*e:1.055*Math.pow(e,1/2.4)-.055}function C(t,e,a){const o=T(a)*Math.PI/180,r=e*Math.cos(o),n=e*Math.sin(o),s=t+.3963377774*r+.2158037573*n,l=t-.1055613458*r-.0638541728*n,i=t-.0894841775*r-1.291485548*n,c=s*s*s,d=l*l*l,h=i*i*i,g=4.0767416621*c-3.3077115913*d+.2309699292*h,m=-1.2684380046*c+2.6097574011*d-.3413193965*h,f=-.0041960863*c-.7034186147*d+1.707614701*h,p=w(Math.round(b(g)*255),0,255),S=w(Math.round(b(m)*255),0,255),P=w(Math.round(b(f)*255),0,255);return`rgb(${p}, ${S}, ${P})`}function G(t){return{themeHue:t,c0:C(.5,.2,t),c1:C(.4,.22,t+20),c2:C(.3,.18,t+40)}}function _(t,e,a,o){if(t.save(),t.globalCompositeOperation="source-over",t.globalAlpha=1,t.filter="none",o){const r=t.createLinearGradient(0,0,e,a);r.addColorStop(0,o.c0),r.addColorStop(.5,o.c1),r.addColorStop(1,o.c2),t.fillStyle=r}else t.fillStyle="rgb(0, 0, 0)";t.fillRect(0,0,e,a),t.restore()}const $=[{corner:"bottom-left",sizeMultiplier:5,translateX:{base:-.1,xFactor:.1,clamp:.1},translateY:{yFactor:-.1,mode:"max0"},scale:{base:.15,xFactor:.25}},{corner:"top-right",sizeMultiplier:5,translateX:{base:.1,xFactor:.1,clamp:.1},translateY:{yFactor:-.1,mode:"min0"},scale:{base:.15,xFactor:-.65}}];function z(){return[{stop:.1,color:"rgba(0,0,0,0)"},{stop:.1+.125*1,color:"rgb(255, 162, 153)"},{stop:.1+.125*2,color:"rgb(51, 255, 153)"},{stop:.1+.125*3,color:"rgb(110, 156, 247)"},{stop:.6,color:"rgba(0,0,0,0)"}]}function F(t,e,a,o,r){if(!(r>0))return;const n=a.w*e.sizeMultiplier,s=n*Math.SQRT2,l=Math.min(1,e.scale.base+o.x*e.scale.xFactor),i=w(e.translateX.base+o.x*e.translateX.xFactor,-e.translateX.clamp,e.translateX.clamp)*n,c=o.y*e.translateY.yFactor*n,d=e.translateY.mode==="max0"?Math.max(0,c):Math.min(0,c);let h=0,g=0,m=0,f=0;e.corner==="bottom-left"?(h=0,g=a.h,m=0,f=-n):(h=a.w,g=0,m=-n,f=0),t.save(),t.globalAlpha=r,t.translate(h,g),t.translate(i,d),t.scale(l,l),t.filter="saturate(2)";const p=t.createRadialGradient(0,0,0,0,0,s);for(const S of z())p.addColorStop(S.stop,S.color);t.fillStyle=p,t.fillRect(m,f,n,n),t.restore()}function H(t,e,a,o){if(e&&e.key===a)return e;const r=o.width,n=new OffscreenCanvas(r,r),s=n.getContext("2d");if(!s)return null;s.clearRect(0,0,n.width,n.height),s.drawImage(o,0,0);const l=t.createPattern(n,"repeat");return l?{key:a,pattern:l,logicalSpacing:1,tileSize:r}:null}function K(t,e,a,o,r,n){if(e&&e.key===a)return e;const s=r*2,l=new OffscreenCanvas(s,s),i=l.getContext("2d");if(!i)return null;i.clearRect(0,0,l.width,l.height);const c=(r-n)/2;i.drawImage(o,c,c,n,n),i.drawImage(o,r+c,r+c,n,n);const d=t.createPattern(l,"repeat");return d?{key:a,pattern:d,logicalSpacing:4,tileSize:s}:null}function I(t,e,a,o,r,n){t.save(),t.setTransform(1,0,0,1,0,0),t.clearRect(0,0,e.w,e.h),t.globalCompositeOperation="source-over",t.globalAlpha=1,t.filter="none",t.fillStyle=r,t.fillRect(0,0,e.w,e.h);for(const h of $)F(t,h,e,a,o);t.globalCompositeOperation="destination-in",t.globalAlpha=1,t.filter="none";const s=n.logicalSpacing/16*e.w,l=n.logicalSpacing/10*e.h,i=s/n.tileSize,c=l/n.tileSize,d=new DOMMatrix;d.scaleSelf(i,c),n.pattern.setTransform(d),t.fillStyle=n.pattern,t.fillRect(0,0,e.w,e.h),t.restore()}function v(t,e,a,o){if(!(o>0))return;const n=e.w*5*Math.SQRT2/2,s=e.w/2+a.x*e.w,l=e.h/2+a.y*e.w;t.save(),t.globalCompositeOperation="overlay",t.globalAlpha=o,t.filter="brightness(1.2) contrast(1.2)";const i=t.createRadialGradient(s,l,0,s,l,n);i.addColorStop(0,"rgba(255,255,255,0.4)"),i.addColorStop(.02,"rgba(255,255,255,0.4)"),i.addColorStop(.2,"rgba(26,26,26,0.2)"),i.addColorStop(1,"rgba(26,26,26,0.2)"),t.fillStyle=i,t.fillRect(0,0,e.w,e.h),t.restore()}function D(t,e,a){const o=Math.round(e.width*e.dpr),r=Math.round(e.height*e.dpr);if(o<=0||r<=0)return{patternMaskCache:a.patternMaskCache,watermarkMaskCache:a.watermarkMaskCache};t.setTransform(1,0,0,1,0,0),t.clearRect(0,0,o,r),_(t,o,r,a.bgStops);const n=e.active?1:0;let s=a.patternMaskCache,l=a.watermarkMaskCache;if(e.enabledPattern&&a.triangleMask){const i=a.patternLayer;i.width!==o&&(i.width=o),i.height!==r&&(i.height=r);const c=i.getContext("2d");if(c){const d=`triangle:${a.triangleMask.width}`,h=H(c,s,d,a.triangleMask);h&&(s=h,I(c,{w:o,h:r},e.pointer,n,"rgb(204, 204, 204)",{pattern:h.pattern,logicalSpacing:h.logicalSpacing,tileSize:h.tileSize}),t.save(),t.globalCompositeOperation="multiply",t.globalAlpha=.4,t.filter="saturate(0.8) contrast(1) brightness(1)",t.drawImage(i,0,0),t.restore())}}if(e.enabledWatermark&&a.watermarkMask){const i=e.watermarkCellSize??40,c=e.watermarkIconSize??24;if(i>0&&c>0){const d=a.watermarkLayer;d.width!==o&&(d.width=o),d.height!==r&&(d.height=r);const h=d.getContext("2d");if(h){const g=Math.max(1,Math.round(i*e.dpr)),m=Math.max(1,Math.round(c*e.dpr)),f=`watermark:${e.watermarkMaskUrl??"null"}:${g}:${m}`,p=K(h,l,f,a.watermarkMask,g,m);p&&(l=p,I(h,{w:o,h:r},e.pointer,n,"rgba(255, 255, 255, 0.2)",{pattern:p.pattern,logicalSpacing:p.logicalSpacing,tileSize:p.tileSize}),t.save(),t.globalCompositeOperation="hard-light",t.globalAlpha=1,t.filter="saturate(0.9) contrast(1.1) brightness(1.2)",t.drawImage(d,0,0),t.restore())}}}return v(t,{w:o,h:r},e.pointer,e.active?1:0),{patternMaskCache:s,watermarkMaskCache:l}}function E(t,e,a){return`${e}:${a}:${t.mode}:${t.pointer.x.toFixed(3)}:${t.pointer.y.toFixed(3)}:${t.active}:${t.themeHue}:${t.enabledPattern}:${t.enabledWatermark}:${t.watermarkMaskUrl}`}const k=new Map,A=new Map;let R=null,L=0;const X={high:1,medium:2,low:4},W={high:null,medium:1,low:.5};let u=[],y=null;self.onmessage=async t=>{switch(t.data.type){case"register":{const e=t.data.canvas.getContext("2d");e&&(k.set(t.data.cardId,{canvas:t.data.canvas,ctx:e,patternLayer:new OffscreenCanvas(1,1),watermarkLayer:new OffscreenCanvas(1,1),patternMaskCache:null,watermarkMaskCache:null,bgStops:null,lastThemeHue:-1,staticCache:null,staticCacheKey:null,lastStateKey:null}),u.length>0&&M());break}case"unregister":{const e=k.get(t.data.cardId);e&&(e.staticCache?.close(),k.delete(t.data.cardId));break}case"update":u=t.data.states,M();break;case"setTriangleMask":R=t.data.bitmap,u.length>0&&M();break;case"loadWatermark":{try{const a=await(await fetch(t.data.url)).blob(),o=await createImageBitmap(a);A.set(t.data.key,o),u.length>0&&M()}catch{}break}}};function M(){y===null&&(y=requestAnimationFrame(N))}function N(){y=null,L++;const t=u.slice().toSorted((e,a)=>O(e.priority)-O(a.priority));for(const e of t){if(L%X[e.priority]!==0)continue;const a=k.get(e.cardId);if(!a)continue;const r=W[e.priority]??e.dpr,n=Math.max(1,Math.round(e.width*r)),s=Math.max(1,Math.round(e.height*r)),l=E(e,n,s);if(a.lastStateKey===l)continue;if(a.canvas.width!==n&&(a.canvas.width=n),a.canvas.height!==s&&(a.canvas.height=s),e.mode==="static"&&a.staticCache&&a.staticCacheKey===l){a.ctx.drawImage(a.staticCache,0,0),a.lastStateKey=l;continue}a.lastThemeHue!==e.themeHue&&(a.bgStops=G(e.themeHue),a.lastThemeHue=e.themeHue);const i=D(a.ctx,{...e,dpr:r},{bgStops:a.bgStops,triangleMask:R,watermarkMask:e.watermarkMaskUrl?A.get(e.watermarkMaskUrl)??null:null,patternLayer:a.patternLayer,watermarkLayer:a.watermarkLayer,patternMaskCache:a.patternMaskCache,watermarkMaskCache:a.watermarkMaskCache});a.patternMaskCache=i.patternMaskCache,a.watermarkMaskCache=i.watermarkMaskCache,a.lastStateKey=l,e.mode==="static"&&(a.staticCache?.close(),a.staticCache=a.canvas.transferToImageBitmap(),a.staticCacheKey=l,a.ctx.drawImage(a.staticCache,0,0))}u.some(e=>e.active)&&M()}function O(t){return t==="high"?0:t==="medium"?1:2}self.postMessage({type:"ready"})})();
