# 小程序开发

## 项目结构

```
miniapps/my-app/
├── package.json
├── tsconfig.json
├── vite.config.ts
├── index.html
└── src/
    ├── main.tsx
    └── App.tsx
```

## 创建新小程序

### 1. 初始化项目

```bash
mkdir miniapps/my-app
cd miniapps/my-app
pnpm init
```

### 2. 安装依赖

```bash
pnpm add @biochain/bio-sdk react react-dom
pnpm add -D @vitejs/plugin-react typescript vite
```

### 3. 配置 Vite

```typescript
// vite.config.ts
import { defineConfig } from 'vite'
import react from '@vitejs/plugin-react'
import { resolve } from 'path'

export default defineConfig({
  plugins: [react()],
  base: '/miniapps/my-app/',  // 重要：设置正确的 base path
  build: {
    outDir: resolve(__dirname, '../../public/miniapps/my-app'),
    emptyOutDir: true,
  },
})
```

### 4. 入口文件

```tsx
// src/main.tsx
import '@biochain/bio-sdk'  // 注入 window.bio
import { createRoot } from 'react-dom/client'
import App from './App'

createRoot(document.getElementById('root')!).render(<App />)
```

### 5. 应用代码

```tsx
// src/App.tsx
import { useState } from 'react'
import type { BioAccount } from '@biochain/bio-sdk'

export default function App() {
  const [account, setAccount] = useState<BioAccount | null>(null)

  const connect = async () => {
    const accounts = await window.bio!.request<BioAccount[]>({
      method: 'bio_requestAccounts'
    })
    setAccount(accounts[0] ?? null)
  }

  return (
    <div>
      {account ? (
        <p>已连接: {account.address}</p>
      ) : (
        <button onClick={connect}>连接钱包</button>
      )}
    </div>
  )
}
```

## 构建与部署

```bash
# 开发
pnpm dev

# 构建到 public/miniapps/
pnpm build
```

## 注册小程序

### AppId 命名规范（必须）

`appId` 必须采用“**反向域名**”命名，以避免 appId 被盗取/覆盖：

- 若应用官网为 `my-app.domain.com`，则 `appId` 必须是 `com.domain.my-app`
- 示例：`https://teleport.dweb.xin` → `xin.dweb.teleport`

> 这是平台级安全约束：一旦应用发布，`appId` 不应随意变更。

### 注册表来源

KeyApp 通过 **Vite 插件**在开发/构建时自动生成并提供 `GET /ecosystem.json`：
- Dev：Vite middleware 动态生成（方便本地调试）
- Build：构建产物中生成静态 `ecosystem.json`（用于发布/离线）

因此内置小程序注册信息应写在 `miniapps/<app>/manifest.json` 中，而不是手动维护 `public/ecosystem.json`。

```json
{
  "apps": [
    {
      "id": "my-app",
      "name": "我的小程序",
      "description": "...",
      "icon": "/miniapps/my-app/icon.svg",
      "url": "/miniapps/my-app/",
      "version": "0.1.0",
      "permissions": ["bio_requestAccounts"],
      "chains": ["bfmeta"]
    }
  ]
}
```

## 最佳实践

### 1. 处理未初始化状态

```typescript
if (!window.bio) {
  // 显示错误或等待
  return <div>请在 KeyApp 中打开</div>
}
```

### 2. 错误处理

```typescript
try {
  await window.bio.request({ method: 'bio_signMessage', params: [...] })
} catch (error) {
  if (error.code === 4001) {
    // 用户拒绝
  }
}
```

### 3. 响应式设计

小程序运行在 iframe 中，需要适配移动端和 WebView：

```css
body {
  min-height: 100vh;
  touch-action: manipulation;
}
```

### 4. 最小权限原则

只请求必要的权限：

```json
{
  "permissions": ["bio_requestAccounts"]  // 只声明需要的
}
```

## 启动屏 (Splash Screen)

KeyApp 为小程序提供启动屏功能，在小程序加载时显示品牌 Logo 和加载动画。

### 配置

在 `manifest.json` 中启用：

```json
{
  "icon": "icon.svg",
  "themeColor": "from-blue-800 via-indigo-900 to-purple-950",
  "themeColorFrom": "#1e40af",
  "splashScreen": true
}
```

- **图标**：自动使用 `icon` 字段
- **背景色**：自动使用 `themeColorFrom` 字段（HEX 格式）
- **超时**：默认 5 秒后自动关闭

### 自定义超时

```json
{
  "splashScreen": { "timeout": 3000 }
}
```

### 关闭启动屏

小程序初始化完成后，调用 `bio_closeSplashScreen` 关闭启动屏：

```typescript
// 在小程序初始化完成后调用
useEffect(() => {
  window.bio?.request({ method: 'bio_closeSplashScreen' })
}, [])
```

> 如果未调用 `closeSplashScreen()`，启动屏会在超时后自动关闭。
