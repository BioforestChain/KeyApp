# 架构设计

## 系统架构

```
┌─────────────────────────────────────────────────────────────┐
│                      KeyApp (Host)                          │
│  ┌─────────────┐  ┌──────────────┐  ┌───────────────────┐  │
│  │ EcosystemTab│  │ BioProvider  │  │ MiniappRegistry   │  │
│  │ (生态 Tab)  │  │ (Server SDK) │  │ (订阅管理)        │  │
│  └──────┬──────┘  └──────┬───────┘  └─────────┬─────────┘  │
│         │                │                     │            │
│         ▼                ▼                     ▼            │
│  ┌─────────────────────────────────────────────────────────┐│
│  │              PostMessage Bridge                         ││
│  │   (双向通信: request/response + events)                 ││
│  └─────────────────────────────────────────────────────────┘│
└────────────────────────────────────────────────────────────┘
                             │ iframe sandbox
┌────────────────────────────┼────────────────────────────────┐
│                    MiniApp (Client)                         │
│  ┌─────────────────────────┴───────────────────────────────┐│
│  │              @aspect-aspect/bio-sdk                      ││
│  │   window.bio = { request, on, off, ... }                ││
│  └─────────────────────────────────────────────────────────┘│
└─────────────────────────────────────────────────────────────┘
```

## 通信协议

### 请求消息

```typescript
interface RequestMessage {
  type: 'bio_request'
  id: string              // 唯一请求 ID
  method: string          // 方法名 (bio_requestAccounts, bio_signMessage, ...)
  params?: unknown[]      // 参数
}
```

### 响应消息

```typescript
interface ResponseMessage {
  type: 'bio_response'
  id: string              // 对应请求 ID
  success: boolean        // 是否成功
  result?: unknown        // 成功时的结果
  error?: {               // 失败时的错误
    code: number
    message: string
    data?: unknown
  }
}
```

### 事件消息

```typescript
interface EventMessage {
  type: 'bio_event'
  event: string           // 事件名
  args: unknown[]         // 事件参数
}
```

## 安全模型

### iframe 沙箱

```html
<iframe
  sandbox="allow-scripts allow-forms allow-same-origin"
  src="/miniapps/xxx/"
/>
```

- `allow-scripts`: 允许执行脚本
- `allow-forms`: 允许提交表单
- `allow-same-origin`: 允许同源请求（必需，用于 postMessage）
- 不允许: `allow-top-navigation`, `allow-popups`

### 权限控制

小程序需要在 manifest 中声明所需权限：

```json
{
  "permissions": ["bio_requestAccounts", "bio_signMessage"]
}
```

用户首次使用时需要确认权限授予。

## 与 DWEB 的兼容

Bio Provider 设计为可插拔的，未来可以支持 DWEB 环境：

```typescript
interface ProviderTransport {
  send(message: unknown): void
  onMessage(handler: (message: unknown) => void): void
}

// iframe 实现
class IframeTransport implements ProviderTransport { ... }

// DWEB 实现 (未来)
class DwebTransport implements ProviderTransport { ... }
```
