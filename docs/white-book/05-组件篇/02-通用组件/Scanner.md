# Scanner äºŒç»´ç æ‰«æå™¨

> é«˜æ€§èƒ½ QR ç æ‰«æä¸è§£æ

---

## åŠŸèƒ½æè¿°

ä½¿ç”¨ Web Worker åå°è§£ç äºŒç»´ç ï¼Œæ”¯æŒåœ°å€æ‰«æã€æ”¯ä»˜è¯·æ±‚ã€æ·±åº¦é“¾æ¥å’Œè”ç³»äººåè®®ã€‚

---

## æ¶æ„è®¾è®¡

### æ ¸å¿ƒç±»

```typescript
// QRScanner - ä¸»æ‰«æå™¨ç±»
class QRScanner {
  constructor(options: QRScannerOptions)
  start(source: FrameSource): void
  stop(): void
  on(event: 'scan' | 'error', callback: Function): void
}

// FrameSource - å¸§æ¥æºæ¥å£
interface FrameSource {
  getFrame(): Promise<ImageData | null>
  dispose(): void
}
```

### Web Worker è§£ç 

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ä¸»çº¿ç¨‹        â”‚     â”‚   Web Worker    â”‚
â”‚   - è·å–å¸§      â”‚ --> â”‚   - jsQR è§£ç    â”‚
â”‚   - å›è°ƒå¤„ç†    â”‚ <-- â”‚   - è¿”å›ç»“æœ    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## è§£æç±»å‹

### ParsedQRContent ç±»å‹å®šä¹‰

```typescript
type ParsedQRContent = 
  | ParsedAddress    // çº¯åœ°å€
  | ParsedPayment    // æ”¯ä»˜è¯·æ±‚
  | ParsedDeepLink   // æ·±åº¦é“¾æ¥
  | ParsedContact    // è”ç³»äººåè®®
  | ParsedUnknown    // æœªçŸ¥å†…å®¹
```

### æ”¯æŒçš„æ ¼å¼

| ç±»å‹ | æ ¼å¼ç¤ºä¾‹ | è¯´æ˜ |
|-----|---------|------|
| address | `0x1234...` | çº¯åœ°å€ |
| payment | `ethereum:0x...?value=1000` | EIP-681 æ”¯ä»˜è¯·æ±‚ |
| deeplink | `keyapp://authorize?...` | åº”ç”¨æ·±åº¦é“¾æ¥ |
| contact | `{"type":"contact",...}` | è”ç³»äººåè®® |

---

## è”ç³»äººåè®® (Contact Protocol)

### JSON æ ¼å¼ (æ¨è)

```json
{
  "type": "contact",
  "name": "å¼ ä¸‰",
  "addresses": [
    { "chainType": "ethereum", "address": "0x742d35Cc..." },
    { "chainType": "bitcoin", "address": "bc1qar0..." }
  ],
  "memo": "å¥½å‹",
  "avatar": "ğŸ‘¨â€ğŸ’¼"
}
```

### URI æ ¼å¼

```
contact://å¼ ä¸‰?eth=0x742d35Cc...&btc=bc1qar0...&memo=å¥½å‹
```

| å‚æ•° | è¯´æ˜ |
|-----|------|
| eth | Ethereum åœ°å€ |
| btc | Bitcoin åœ°å€ |
| trx | Tron åœ°å€ |
| memo | å¤‡æ³¨ |

---

## ScannerJob ç»„ä»¶

### ç”¨é€”

Stackflow BottomSheet æ¨¡å¼çš„æ‰«ç å™¨ï¼Œç”¨äºåœ¨å‘é€é¡µé¢ç­‰åœºæ™¯æ‰«æåœ°å€ã€‚

### å±æ€§

| å±æ€§ | ç±»å‹ | è¯´æ˜ |
|-----|------|------|
| chainType | 'ethereum' \| 'bitcoin' \| 'tron' \| 'any' | é™åˆ¶æ‰«æçš„åœ°å€ç±»å‹ |

### ä½¿ç”¨ç¤ºä¾‹

```tsx
// åœ¨ SendPage ä¸­ä½¿ç”¨
const flow = useFlow()
const callbackRef = useRef<(addr: string) => void>()

// æ‰“å¼€æ‰«ç å™¨
callbackRef.current = (address) => {
  setRecipientAddress(address)
}
setScannerResultCallback(callbackRef)
flow.push('ScannerJob', { chainType: 'ethereum' })
```

---

## éªŒè¯å™¨è§„èŒƒ

### å†…ç½®éªŒè¯å™¨

| éªŒè¯å™¨ | é“¾ç±»å‹ | è§„åˆ™ |
|-------|-------|------|
| ethereumAddress | ethereum | `^0x[a-fA-F0-9]{40}$` |
| bitcoinAddress | bitcoin | legacy/segwit/bech32 |
| tronAddress | tron | `^T[a-zA-HJ-NP-Z1-9]{33}$` |
| anyAddress | any | 26-64 å­—ç¬¦ |

### è‡ªå®šä¹‰éªŒè¯å™¨

```typescript
type ScanValidator = (
  content: string, 
  parsed: ParsedQRContent
) => true | string  // true = é€šè¿‡, string = é”™è¯¯æ¶ˆæ¯ i18n key
```

---

## ç›¸å…³ Job ç»„ä»¶

### ContactAddConfirmJob

æ‰«ç è·å–è”ç³»äººåçš„ç¡®è®¤æ·»åŠ ç•Œé¢ã€‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           æ·»åŠ è”ç³»äºº             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ğŸ‘¤ å¼ ä¸‰                         â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”‚
â”‚  ETH: 0x742d...                 â”‚
â”‚  BTC: bc1qar...                 â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”‚
â”‚  å¤‡æ³¨: [è¾“å…¥æ¡†]                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  [å–æ¶ˆ]          [ä¿å­˜]          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ContactShareJob

å±•ç¤ºè”ç³»äººåç‰‡äºŒç»´ç ç”¨äºåˆ†äº«ã€‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           åˆ†äº«åç‰‡               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                 â”‚
â”‚        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚        â”‚   QR Code   â”‚         â”‚
â”‚        â”‚   (è”ç³»äºº)   â”‚         â”‚
â”‚        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚                                 â”‚
â”‚        å¼ ä¸‰ Â· ETH               â”‚
â”‚                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  [ä¸‹è½½å›¾ç‰‡]      [åˆ†äº«]          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## æµ‹è¯•è¦†ç›–

### å•å…ƒæµ‹è¯•

- `qr-parser.test.ts`: 38 ä¸ªæµ‹è¯•ç”¨ä¾‹
- `ScannerJob.test.ts`: 31 ä¸ªæµ‹è¯•ç”¨ä¾‹
- `qr-scanner.test.ts`: 10 ä¸ªæµ‹è¯•ç”¨ä¾‹

### Storybook Stories

- `ScannerJob.stories.tsx`: ValidatorDemo, AddressFormats, UIPreview
- `ContactJobs.stories.tsx`: ContactProtocolDemo, ContactAddConfirmPreview, ContactSharePreview, EdgeCases

### E2E æµ‹è¯•

- `scanner.spec.ts`: æ‰«æé¡µé¢åŸºç¡€æµ‹è¯•
- `contact-scanner.mock.spec.ts`: è”ç³»äººåè®®é›†æˆæµ‹è¯•

---

## æ€§èƒ½æŒ‡æ ‡

| æŒ‡æ ‡ | ç›®æ ‡ | è¯´æ˜ |
|-----|------|------|
| æ‰«æå¸§ç‡ | 6-7 FPS | 150ms é—´éš” |
| è§£ç å»¶è¿Ÿ | < 100ms | Web Worker åå°å¤„ç† |
| é¦–æ¬¡æ‰«æ | < 500ms | å†·å¯åŠ¨åˆ°é¦–æ¬¡æˆåŠŸ |
