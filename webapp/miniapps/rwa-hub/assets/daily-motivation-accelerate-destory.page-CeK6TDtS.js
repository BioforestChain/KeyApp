import{r as G,j as e,f}from"./index-Dk9SKzm0.js";import{g as H,a as q}from"./icon.component--OR8Byhv.js";import{L as O}from"./loading-page-data-_vUbOxZx.js";import{A as $}from"./nilai-dialog-DovDa2gq.js";import{$ as W,g as _,a as J}from"./signature-MTDex1F4.js";import{d as K,P as Y,g as z}from"./page-BOxexyJV.js";import{d as Q,f as V}from"./noop-ChEnm3CV.js";import{f as N,a as F}from"./asset-type-balance-BGw1Ilcq.js";import{u as a}from"./use_easy_state-DKYThI52.js";import{u as X}from"./use_flow-BWxEPw_J.js";import{B as Z}from"./dialog-DR_3qyGf.js";import{N as ee}from"./navbar-Dn_WDVgk.js";import{B as d}from"./big-Dt19vo1Q.js";import{t as m,b as te}from"./dex-api-CqlE9Hln.js";import{g as se}from"./setting.page-LIpBvLLC.js";import"./preloader-BGxTR-F-.js";import"./messages-SmdZefEg.js";import"./bridge-DyWekW1m.js";import"./pull-to-refresh-dnVFezrG.js";import"./list-item-CGegUNIB.js";import"./list-CIdLnKZP.js";import"./use_refresh-Bj36Twge.js";const Fe=K(({external_user_id:y,...T})=>{const v=a(!1);a(!1);const x=se(),u=a(""),L=a(""),D=a("0"),g=a([]),P=a("BFMeta"),[B]=X(te),I=z(),j=a(!0),n=a({assetType:"",amount:"0",chain:"BFMeta"}),S=a("0"),C=a(!1),E=a(""),M=a("0"),b=a(-1),k=async(t,r)=>{try{f.preloader.show();const l=await fetch("https://walletapi.bfmeta.info/wallet/bfm/address/asset",{headers:{accept:"application/json, text/plain, */*","content-type":"application/json;charset=UTF-8"},method:"POST",body:JSON.stringify({address:t})}).then(s=>s.json()).then(s=>{if(s.success!==!0)throw s;if("result"in s)return s.result;throw new Error("获取地址链资产失败")}).catch(s=>console.error),c={BFM:"0",[r]:"0"};if(l){const s=l.assets||{},A=Object.keys(s).find(p=>!!s[p]),o=A&&s[A];o&&[...new Set(["BFM",r]).values()].forEach(p=>{const h=o[p];h&&h.assetType&&(c[p]=h.assetNumber)})}return c}finally{f.preloader.hide()}},R=async()=>{try{j.value=!0;const t=await I.trpcClient.motivation.getMotivationAndUserAccelerateInfo.query({external_user_id:y});if(u.value=t.accelerateAssetType,g.value=t.accelerateGearPosition,P.value=t.accelerateChain,L.value=t.accelerateAddress,t.userDetroyInfo){const i=t.userDetroyInfo;if(i.status!=="fail"){D.value=i.destoryAmount;const c=t.accelerateGearPosition.map(s=>({ratio:s.ratio,needDestoryAmount:d(s.destoryRatio).mul(i.assetTypeAmount).round(0,d.roundDown).toString()})).filter(s=>BigInt(s.needDestoryAmount)<=BigInt(i.destoryAmount));c.length&&(M.value=c[c.length-1]?.ratio||"0",b.value=c.length-1)}i.status==="untreated"&&(C.value=!0)}const r=await k(B.address,t.accelerateAssetType);S.value=r.BFM||"0",E.value=r[t.accelerateAssetType]||"0",n.value={assetType:t.accelerateAssetType,amount:t.assetTypeAmount,chain:"BFMeta"},j.value=!1}catch(t){throw m(String(t)),v.value=!0,t}};G.useEffect(()=>{R()},[]);const U=async t=>{const r=g.value[t];if(!r)return;const i=d(r.destoryRatio).mul(n.value.amount).round(0,d.roundDown).toString();if(BigInt(i)<=BigInt(0)){m("地址快照数量过低，销毁数量必须大于0，无需加速");return}try{f.preloader.show();const l={type:W.destory,chainName:"BFMeta",senderAddress:B.address,assetType:u.value,destoryAmount:i,remark:{type:"daily motivation accelerate destory",nonce:String(Date.now()),external_user_id:y}},s=await(await _(Q.BFMPay().mmid,J.signature,[l])).getData();if(V(),!s){f.preloader.hide(),m("授权失败");return}let w="";if(s.find(o=>o?typeof o!="string"&&"error"in o&&o.error?(typeof o.message=="string"&&(w=o.message),!0):!1:!0)){m(w||"授权失败");return}await I.trpcClient.motivation.submitMotivationDestoryTrs.mutate({external_user_id:y,trs:s[0].transaction}),m("提交成功"),T.safeF7Navigater.dailyMotivationAccelerateDestoryList({reloadCurrent:!0,props:{assetType:u.value}})}catch(l){throw m(String(l)),l}finally{f.preloader.hide()}};return e.jsxs(Y,{name:"daily-motivation-accelerate-destory",children:[e.jsx(ee,{backLink:!0,title:"激励加速"}),e.jsxs("div",{className:"min-h-full w-full p-4",style:{background:"linear-gradient(180deg,#DBC3FF 0%,#DBC4FF 0%,#F6F4FF 40%)"},children:[j.value?e.jsx(O,{}):e.jsxs("div",{children:[e.jsxs("div",{className:"mb-2",children:[e.jsx("div",{className:"mb-1 flex items-center justify-between",children:e.jsx("div",{className:"text-lg font-bold",children:"用户签到销毁资产快照"})}),e.jsx("div",{className:"rounded-3 bg-white p-2",children:n.value.assetType?e.jsx("div",{className:"bg-gary rounded-3 px-2",children:e.jsxs("div",{className:"flex w-full items-center justify-between p-1",children:[e.jsxs("div",{className:"flex items-center text-sm",children:[e.jsxs("div",{className:"relative",children:[e.jsx("img",{src:H(n.value.assetType,n.value.chain),alt:"",className:"h-6 w-6"}),e.jsx("img",{src:q(n.value.chain),alt:"",className:"absolute -bottom-1 -right-0.5 h-4 w-4"})]}),e.jsx("div",{className:"ml-2",children:e.jsx("div",{children:n.value.assetType})})]}),e.jsx("div",{children:N(F(n.value.amount,8,x))})]})}):e.jsx("div",{children:"暂未获取到签到销毁资产快照"})})]}),e.jsx("div",{className:"mb-3 text-xs text-red",children:"销毁事件存在一定上链时间，请等待确认上链后，查看加速奖励信息"}),e.jsxs("div",{className:"mb-4",children:[e.jsx("div",{className:"mb-1 flex items-center justify-between",children:e.jsx("div",{className:"text-lg font-bold",children:"我的加速信息"})}),e.jsx("div",{className:"mb-3 rounded-3 bg-white px-4 py-2",children:C.value?e.jsxs("div",{className:"py-2 text-center font-bold",children:[e.jsx("img",{src:"./images/exchange_untreated.webp",className:"mx-auto mb-3",alt:""}),"销毁事件确认中"]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex w-full items-center justify-between",children:[e.jsx("div",{children:"我已销毁数量"}),e.jsxs("div",{className:"text-red",children:[N(F(D.value||"0",8,x))," ",u.value]})]}),e.jsxs("div",{className:"flex w-full items-center justify-between",children:[e.jsx("div",{children:"我的加速"}),e.jsxs("div",{className:"text-orange-500",children:[d(M.value||"0").mul(100).toString(),"%"]})]})]})})]}),e.jsxs("div",{className:"mb-4",children:[e.jsx("div",{className:"mb-1 flex items-center justify-between",children:e.jsx("div",{className:"text-lg font-bold",children:"激励加速档位"})}),e.jsx("div",{}),g.value.map((t,r)=>e.jsxs("div",{className:`mb-3 rounded-3 px-4 py-2 ${r===b.value?"bg-green-300":"bg-white"}`,children:[e.jsxs("div",{className:"mb-3 flex items-center justify-between",children:[e.jsxs("div",{className:"text-text",children:["档位",r+1]}),b.value<0&&e.jsx(Z,{className:"bg-primary text-white",onClick:()=>U(r),children:"选择该档位"})]}),e.jsxs("div",{className:"mb-2 flex w-full items-center justify-between",children:[e.jsx("div",{children:"销毁数量"}),e.jsxs("div",{children:[N(F(d(t.destoryRatio).mul(n.value.amount).round(0,d.roundDown).toString(),8,x)),u.value]})]}),e.jsxs("div",{className:"flex w-full items-center justify-between",children:[e.jsx("div",{children:"获得加速"}),e.jsxs("div",{children:[d(t.ratio).mul(100).toString(),"%"]})]})]},r))]})]}),e.jsx($,{open:v.value,title:"警告",confirmText:"确认",onRequireClose:()=>{v.value=!1},onConfirmCallback:()=>{T.f7router.back(),v.value=!1},children:"获取信息错误"})]})]})});export{Fe as default};
