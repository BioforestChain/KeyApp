name: CI - PR Checks

on:
  pull_request:
  workflow_dispatch:

env:
  NODE_VERSION: '24'

jobs:
  # ==================== å˜æ›´æ£€æµ‹ ====================
  changes:
    runs-on: ubuntu-latest
    outputs:
      code: ${{ steps.filter.outputs.code }}
      docs: ${{ steps.filter.outputs.docs }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 1
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            code:
              - 'src/**'
              - 'e2e/**'
              - 'package.json'
              - 'pnpm-lock.yaml'
              - 'vite.config.ts'
              - 'vitest.config.ts'
              - 'playwright.config.ts'
              - 'tsconfig*.json'
            docs:
              - 'docs/**'
              - '*.md'
              - '.github/**'

  # ==================== æ£€æµ‹ self-hosted runner å¯ç”¨æ€§ ====================
  check-runner:
    runs-on: self-hosted
    timeout-minutes: 1
    continue-on-error: true
    outputs:
      available: ${{ steps.check.outputs.available }}
    steps:
      - id: check
        run: echo "available=true" >> $GITHUB_OUTPUT

  # ==================== å¿«é€Ÿæ£€æŸ¥ (åˆå¹¶ typecheck + build + i18n) ====================
  quick-checks:
    needs: check-runner
    runs-on: ${{ needs.check-runner.outputs.available == 'true' && 'self-hosted' || 'ubuntu-latest' }}
    timeout-minutes: 10
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
      # GitHub-hosted: éœ€è¦å®‰è£…ç¯å¢ƒ
      - name: Setup Bun
        if: needs.check-runner.outputs.available != 'true'
        uses: oven-sh/setup-bun@v2
      - name: Setup pnpm
        if: needs.check-runner.outputs.available != 'true'
        uses: pnpm/action-setup@v4
      - name: Setup Node.js
        if: needs.check-runner.outputs.available != 'true'
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: pnpm
      # é€šç”¨æ­¥éª¤
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      - name: Type check
        run: pnpm typecheck
      - name: Build
        run: pnpm build
      - name: Check i18n keys
        run: pnpm i18n:check

  # ==================== å•å…ƒæµ‹è¯• (ç‹¬ç«‹è¿è¡Œï¼Œè€—æ—¶é•¿) ====================
  test:
    needs: check-runner
    runs-on: ${{ needs.check-runner.outputs.available == 'true' && 'self-hosted' || 'ubuntu-latest' }}
    timeout-minutes: 10
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
      - name: Setup pnpm
        if: needs.check-runner.outputs.available != 'true'
        uses: pnpm/action-setup@v4
      - name: Setup Node.js
        if: needs.check-runner.outputs.available != 'true'
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: pnpm
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      - name: Unit tests
        run: pnpm test

  # ==================== E2E æµ‹è¯•ï¼ˆä»…ä»£ç å˜æ›´æ—¶è¿è¡Œï¼‰ ====================
  e2e:
    needs: [changes, check-runner]
    if: needs.changes.outputs.code == 'true'
    runs-on: ${{ needs.check-runner.outputs.available == 'true' && 'self-hosted' || 'ubuntu-latest' }}
    timeout-minutes: 15
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
      - name: Setup Bun
        if: needs.check-runner.outputs.available != 'true'
        uses: oven-sh/setup-bun@v2
      - name: Setup pnpm
        if: needs.check-runner.outputs.available != 'true'
        uses: pnpm/action-setup@v4
      - name: Setup Node.js
        if: needs.check-runner.outputs.available != 'true'
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: pnpm
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      # GitHub-hosted: éœ€è¦å®‰è£… Playwright
      - name: Cache Playwright browsers
        if: needs.check-runner.outputs.available != 'true'
        id: playwright-cache
        uses: actions/cache@v4
        with:
          path: ~/.cache/ms-playwright
          key: playwright-${{ runner.os }}-${{ hashFiles('pnpm-lock.yaml') }}
      - name: Install Playwright browsers
        if: needs.check-runner.outputs.available != 'true' && steps.playwright-cache.outputs.cache-hit != 'true'
        run: pnpm exec playwright install --with-deps chromium
      - name: Install Playwright deps (if cached)
        if: needs.check-runner.outputs.available != 'true' && steps.playwright-cache.outputs.cache-hit == 'true'
        run: pnpm exec playwright install-deps chromium
      # E2E æµ‹è¯•
      - name: E2E smoke (Mobile Chrome)
        run: pnpm e2e bioforest-chains --project "Mobile Chrome"

  # ==================== æœ€ç»ˆçŠ¶æ€æ£€æŸ¥ ====================
  checks:
    runs-on: ubuntu-latest
    needs: [check-runner, quick-checks, test, e2e]
    if: always()
    steps:
      - name: Report runner status
        run: |
          if [[ "${{ needs.check-runner.outputs.available }}" == "true" ]]; then
            echo "ğŸš€ Using self-hosted runner (M1 Mac) - fast mode"
          else
            echo "â˜ï¸ Using GitHub-hosted runner (ubuntu-latest)"
          fi
      - name: Check results
        run: |
          if [[ "${{ needs.quick-checks.result }}" == "failure" ]]; then
            echo "Quick checks (typecheck/build/i18n) failed"
            exit 1
          fi
          if [[ "${{ needs.test.result }}" == "failure" ]]; then
            echo "Tests failed"
            exit 1
          fi
          if [[ "${{ needs.e2e.result }}" == "failure" ]]; then
            echo "E2E failed"
            exit 1
          fi
          echo "All checks passed!"
